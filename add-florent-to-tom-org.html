<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajouter Florent √† Tom et Flo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: system-ui; max-width: 800px; margin: 50px auto; padding: 20px; background: #1a1a2e; color: #eee; }
        h1 { color: #667eea; }
        .log { background: #16213e; padding: 15px; border-radius: 8px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        button { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        button:hover { transform: translateY(-2px); }
    </style>
</head>
<body>
    <h1>Ajouter Florent comme owner de "Tom et Flo"</h1>
    <p>Ce script va ajouter florent.media2@gmail.com comme propri√©taire de l'organisation "Tom et Flo".</p>

    <button onclick="addFlorentToTomOrg()">Ex√©cuter</button>

    <div class="log" id="log"></div>

    <script>
        const SUPABASE_URL = 'https://vjsovnhmjgehqawjmqxn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqc292bmhtamdlaHFhd2ptcXhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjQ4OTgsImV4cCI6MjA3NjAwMDg5OH0.uLqNP1Xb6uhrVBH_ESW7eemMdJ08cTrYZ9C0QHvAsDk';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${type}">[${time}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function addFlorentToTomOrg() {
            try {
                log('üîç Recherche de l\'organisation "Tom et Flo"...', 'info');

                // Trouver l'organisation Tom et Flo
                const { data: orgs, error: orgError } = await supabase
                    .from('organizations')
                    .select('*')
                    .ilike('name', '%tom%');

                if (orgError) throw orgError;

                log('Organisations trouv√©es: ' + JSON.stringify(orgs, null, 2), 'info');

                if (!orgs || orgs.length === 0) {
                    log('‚ùå Aucune organisation "Tom" trouv√©e!', 'error');
                    return;
                }

                const tomOrg = orgs[0];
                log(`‚úÖ Organisation trouv√©e: ${tomOrg.name} (ID: ${tomOrg.id})`, 'success');

                // Trouver l'ID de florent.media2@gmail.com via user_organizations de l'autre org
                log('üîç Recherche de l\'ID de florent.media2@gmail.com via ses organisations existantes...', 'info');

                // D'abord, trouver l'organisation "Agence Flo" ou similaire o√π Florent est owner
                const { data: floOrgs, error: floOrgError } = await supabase
                    .from('organizations')
                    .select('*')
                    .ilike('name', '%flo%')
                    .not('name', 'ilike', '%tom%');

                if (floOrgError) throw floOrgError;
                log('Organisations Flo trouv√©es: ' + JSON.stringify(floOrgs, null, 2), 'info');

                if (!floOrgs || floOrgs.length === 0) {
                    log('‚ùå Aucune organisation "Flo" trouv√©e pour r√©cup√©rer l\'ID de Florent!', 'error');
                    return;
                }

                // L'owner_id de l'organisation Agence Flo est l'ID de Florent
                const florentUserId = floOrgs[0].owner_id;
                log(`‚úÖ ID de Florent trouv√© via owner de "${floOrgs[0].name}": ${florentUserId}`, 'success');

                // V√©rifier si la relation existe d√©j√†
                log('üîç V√©rification si la relation existe d√©j√†...', 'info');

                const { data: existingRelation, error: relError } = await supabase
                    .from('organization_members')
                    .select('*')
                    .eq('user_id', florentUserId)
                    .eq('organization_id', tomOrg.id);

                if (relError) throw relError;

                if (existingRelation && existingRelation.length > 0) {
                    log('‚ö†Ô∏è La relation existe d√©j√†: ' + JSON.stringify(existingRelation[0], null, 2), 'info');

                    // Mettre √† jour le r√¥le en owner si ce n'est pas d√©j√† le cas
                    if (existingRelation[0].role !== 'owner') {
                        const { error: updateError } = await supabase
                            .from('organization_members')
                            .update({ role: 'owner' })
                            .eq('id', existingRelation[0].id);

                        if (updateError) throw updateError;
                        log('‚úÖ R√¥le mis √† jour en "owner"!', 'success');
                    } else {
                        log('‚úÖ Florent est d√©j√† owner de cette organisation!', 'success');
                    }
                } else {
                    // Cr√©er la relation
                    log('üìù Cr√©ation de la relation organization_members...', 'info');

                    const { data: newRelation, error: insertError } = await supabase
                        .from('organization_members')
                        .insert({
                            user_id: florentUserId,
                            organization_id: tomOrg.id,
                            role: 'owner'
                        })
                        .select();

                    if (insertError) throw insertError;

                    log('‚úÖ Relation cr√©√©e: ' + JSON.stringify(newRelation, null, 2), 'success');
                }

                log('üéâ Termin√©! Florent peut maintenant acc√©der √† l\'organisation "Tom et Flo"!', 'success');

            } catch (error) {
                log('‚ùå Erreur: ' + error.message, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
