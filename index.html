<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VA Manager Pro - Application</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.min.js"></script>

    <!-- Configuration (must load before supabase-client.js) -->
    <script src="config.js?v=3"></script>

    <!-- Supabase Helper Functions -->
    <script src="supabase-client.js?v=3"></script>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <!-- Chart.js Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

    <!-- iPhone 14 Pro Responsiveness Fixes -->
    <link rel="stylesheet" href="iphone-14-pro-fixes.css">
    <link rel="stylesheet" href="dashboard-pro.css">

    <style>
        /* ============================================
           VA MANAGER PRO - DESIGN SYSTEM 2024
           Modern, Clean & Professional
           ============================================ */

        :root {
            /* Primary Colors */
            --primary-50: #eef2ff;
            --primary-100: #e0e7ff;
            --primary-200: #c7d2fe;
            --primary-300: #a5b4fc;
            --primary-400: #818cf8;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --primary-700: #4338ca;

            /* Accent Colors */
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;

            /* Success/Warning/Error */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;

            /* Neutrals */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.15);

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }

        @keyframes shimmer {
            0% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.9), inset 0 0 15px rgba(255, 255, 255, 0.7);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.5);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1);
                opacity: 0.3;
            }
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
        }

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            background-attachment: fixed;
            color: var(--gray-800);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============================================
           HEADER - Modern Glassmorphism Design
           ============================================ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6366f1 100%);
            background-size: 200% 200%;
            animation: gradient-shift 15s ease infinite;
            color: white;
            padding: var(--space-xl);
            position: relative;
            overflow: visible;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        /* Dark mode - Modern design */
        body.dark-mode {
            background: #0a0b0d;
            color: #e1e8ef;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%) !important;
            box-shadow: 0 4px 30px rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .nav {
            background: #13151a;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.4);
        }
        
        body.dark-mode .nav-btn {
            color: #9ca3af;
            border: 1px solid transparent;
        }
        
        body.dark-mode .nav-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            color: #e1e8ef;
            border-color: rgba(99, 102, 241, 0.2);
        }
        
        body.dark-mode .nav-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode .card {
            background: #16181d;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .modal-content {
            background: #1a1d23;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        
        body.dark-mode .form-control {
            background: #0d0f13;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e1e8ef;
        }
        
        body.dark-mode .form-control:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .subs-table {
            background: #16181d;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .subs-table th {
            background: #1e2028;
            color: #9ca3af;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode .subs-table td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #e1e8ef;
        }
        
        body.dark-mode .subs-table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        
        body.dark-mode .leaderboard-item {
            background: linear-gradient(135deg, #1a1d23 0%, #1e2128 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode .period-tab {
            background: #1a1d23;
            color: #9ca3af;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .period-tab:hover {
            background: rgba(99, 102, 241, 0.1);
            color: #e1e8ef;
            border-color: rgba(99, 102, 241, 0.2);
        }
        
        body.dark-mode .period-tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        body.dark-mode .modal {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
        }
        
        body.dark-mode .competition-header {
            background: linear-gradient(135deg, #92400e 0%, #b45309 100%) !important;
        }
        
        body.dark-mode .submit-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode .submit-btn:hover {
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }
        
        body.dark-mode .cancel-btn {
            background: #374151;
            color: #e1e8ef;
        }
        
        body.dark-mode .cancel-btn:hover {
            background: #4b5563;
        }
        
        body.dark-mode .btn-icon {
            background: rgba(99, 102, 241, 0.1);
            color: #9ca3af;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        body.dark-mode .btn-icon:hover {
            background: rgba(99, 102, 241, 0.2);
            color: #e1e8ef;
            border-color: rgba(99, 102, 241, 0.4);
        }
        
        body.dark-mode .stat-box {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .stat-value {
            color: #e1e8ef;
        }

        body.dark-mode .stat-label {
            color: #9ca3af;
        }

        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 {
            color: #f3f4f6;
        }

        /* Admin Page Dark Mode */
        body.dark-mode .admin-hero-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }

        body.dark-mode .admin-hero-title {
            color: white !important;
        }

        body.dark-mode .admin-hero-subtitle {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        body.dark-mode .admin-stat-card {
            background: #1a1d23 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .admin-stat-label {
            color: #9ca3af !important;
        }

        body.dark-mode .admin-stat-value {
            color: #f3f4f6 !important;
        }

        body.dark-mode .admin-stat-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.dark-mode .admin-members-section {
            background: #1a1d23 !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .admin-members-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.dark-mode .admin-section-title {
            color: #f3f4f6 !important;
        }

        body.dark-mode .admin-section-subtitle {
            color: #9ca3af !important;
        }

        body.dark-mode .admin-action-card {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .admin-action-settings {
            background: linear-gradient(135deg, #1e1515 0%, #2d1a1a 100%) !important;
        }

        body.dark-mode .admin-action-data {
            background: linear-gradient(135deg, #1a1625 0%, #231d2e 100%) !important;
        }

        body.dark-mode .admin-action-links {
            background: linear-gradient(135deg, #0d1f1c 0%, #16291f 100%) !important;
        }

        body.dark-mode .admin-action-title {
            color: #f3f4f6 !important;
        }

        body.dark-mode .admin-action-subtitle {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        body.dark-mode .admin-action-btn {
            background: #16181d !important;
            color: #e1e8ef !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }

        body.dark-mode .admin-action-btn:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
        }

        /* Dashboard Dark Mode */
        body.dark-mode .dashboard-stat-card {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4) !important;
        }

        /* Carte Comptes Actifs - Mode Sombre */
        body.dark-mode .dashboard-stat-card[style*="linear-gradient(135deg, #31C950"] {
            background: linear-gradient(135deg, #1e5128, #2d6a3e) !important;
            box-shadow: 0 8px 32px rgba(49, 201, 80, 0.2) !important;
            border: 2px solid rgba(49, 201, 80, 0.3) !important;
        }

        body.dark-mode .dashboard-section-title {
            color: #f3f4f6 !important;
        }

        body.dark-mode .dashboard-action-btn {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .dashboard-action-btn:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            transform: translateY(-2px);
        }

        body.dark-mode .va-grid .card {
            background: #1a1d23 !important;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .form-container {
            background: #1a1d23 !important;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .form-title {
            color: #f3f4f6 !important;
        }

        body.dark-mode .form-control {
            background: #0d0f13 !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #e1e8ef !important;
        }

        body.dark-mode .form-control:focus {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
        }

        body.dark-mode .submit-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        body.dark-mode .submit-btn:hover {
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
        }

        body.dark-mode .creator-card {
            background: #1a1d23 !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }

        body.dark-mode .creator-card:hover {
            border-color: rgba(139, 92, 246, 0.3) !important;
        }

        body.dark-mode .creator-card h4 {
            color: #f3f4f6 !important;
        }

        body.dark-mode .creator-card p {
            color: #9ca3af !important;
        }

        body.dark-mode select {
            background: #0d0f13 !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #e1e8ef !important;
        }

        body.dark-mode select:focus {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1) !important;
        }

        body.dark-mode label {
            color: #9ca3af !important;
        }

        body.dark-mode .va-card {
            background: #1a1d23 !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }

        body.dark-mode .va-card:hover {
            border-color: rgba(102, 126, 234, 0.3) !important;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4) !important;
        }

        body.dark-mode .va-card h3 {
            color: #f3f4f6 !important;
        }

        body.dark-mode .va-card .va-stat {
            background: rgba(99, 102, 241, 0.1) !important;
            border: 1px solid rgba(99, 102, 241, 0.2) !important;
        }

        body.dark-mode .va-card .va-stat-label {
            color: #9ca3af !important;
        }

        body.dark-mode .va-card .va-stat-value {
            color: #f3f4f6 !important;
        }
        
        body.dark-mode .rank-badge {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .rank-1 { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
            color: #1a1d23;
        }
        
        body.dark-mode .rank-2 { 
            background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); 
            color: #1a1d23;
        }
        
        body.dark-mode .rank-3 { 
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); 
            color: white;
        }
        
        body.dark-mode .activity-item {
            background: rgba(99, 102, 241, 0.05);
            border-left: 3px solid #6366f1;
        }
        
        body.dark-mode select option {
            background: #1a1d23;
            color: #e1e8ef;
        }
        
        body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator,
        body.dark-mode input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        body.dark-mode .badge {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        body.dark-mode ::-webkit-scrollbar-track {
            background: #0d0f13;
        }
        
        body.dark-mode ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 6px;
        }
        
        body.dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        
        /* Dark mode - Specific color adjustments */
        body.dark-mode .text-green-500,
        body.dark-mode [style*="color: #22c55e"] {
            color: #4ade80 !important;
        }
        
        body.dark-mode .text-red-500,
        body.dark-mode [style*="color: #ef4444"] {
            color: #f87171 !important;
        }
        
        body.dark-mode .text-blue-500,
        body.dark-mode [style*="color: #3b82f6"] {
            color: #60a5fa !important;
        }
        
        body.dark-mode .text-orange-500,
        body.dark-mode [style*="color: #f59e0b"] {
            color: #fbbf24 !important;
        }
        
        body.dark-mode [style*="background: #f8fafc"] {
            background: #1a1d23 !important;
        }
        
        body.dark-mode [style*="background: white"] {
            background: #16181d !important;
        }
        
        body.dark-mode [style*="background: #fff"],
        body.dark-mode [style*="background:white"],
        body.dark-mode [style*="background:#fff"],
        body.dark-mode [style*="background:#ffffff"] {
            background: #16181d !important;
        }
        
        body.dark-mode [style*="border-left: 4px solid #f59e0b"] {
            border-left-color: #fbbf24 !important;
        }
        
        body.dark-mode [style*="background: #fef3c7"] {
            background: rgba(251, 191, 36, 0.1) !important;
            color: #fbbf24 !important;
        }
        
        body.dark-mode [style*="color: #64748b"] {
            color: #94a3b8 !important;
        }
        
        body.dark-mode [style*="color: #94a3b8"] {
            color: #cbd5e1 !important;
        }
        
        body.dark-mode [style*="background: #e2e8f0"] {
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        body.dark-mode .va-card,
        body.dark-mode .creator-card {
            background: linear-gradient(135deg, #16181d 0%, #1a1d23 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .creators-stats-overview {
            background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 100%) !important;
        }
        
        body.dark-mode .creatrice-item {
            background: rgba(30, 41, 59, 0.5) !important;
            color: #e2e8f0 !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }
        
        body.dark-mode .creatrice-item:hover {
            background: rgba(30, 41, 59, 0.8) !important;
            border-color: rgba(99, 102, 241, 0.2) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }
        
        body.dark-mode .twitter-accounts {
            background: rgba(29, 161, 242, 0.03) !important;
            border-color: rgba(29, 161, 242, 0.1) !important;
        }
        
        body.dark-mode .twitter-badge {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
            color: #f1f5f9 !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
            border: 1.5px solid rgba(71, 85, 105, 0.6) !important;
        }

        body.dark-mode .twitter-badge:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4) !important;
            border-color: rgba(100, 116, 139, 0.8) !important;
            background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
        }

        body.dark-mode .twitter-badge i.fab {
            color: #1DA1F2 !important;
        }

        body.dark-mode .instagram-accounts {
            background: rgba(30, 41, 59, 0.3) !important;
            border-color: rgba(71, 85, 105, 0.4) !important;
        }

        body.dark-mode .instagram-badge {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
            color: #f1f5f9 !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
            border: 1.5px solid rgba(71, 85, 105, 0.6) !important;
        }

        body.dark-mode .instagram-badge:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4) !important;
            border-color: rgba(100, 116, 139, 0.8) !important;
            background: linear-gradient(135deg, #334155 0%, #475569 100%) !important;
        }
        
        body.dark-mode .creatrice-name {
            color: #f1f5f9 !important;
        }
        
        body.dark-mode .progress-bar {
            background: rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .progress-fill {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }
        
        body.dark-mode .performance-card {
            background: #1a1d23;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Dark mode - SVG and chart adjustments */
        body.dark-mode svg circle[stroke="#e2e8f0"] {
            stroke: rgba(255, 255, 255, 0.1) !important;
        }
        
        body.dark-mode .fa-check-circle {
            color: #4ade80 !important;
        }
        
        body.dark-mode .fa-clock {
            color: #fbbf24 !important;
        }
        
        body.dark-mode .fa-trash {
            color: #f87171 !important;
        }
        
        /* Ensure no black on black or white on white */
        body.dark-mode p,
        body.dark-mode span,
        body.dark-mode div {
            color: inherit;
        }
        
        /* Dark mode - Form labels and text */
        body.dark-mode label,
        body.dark-mode .form-group label {
            color: #94a3b8 !important;
            font-weight: 500;
        }
        
        body.dark-mode h2 {
            color: #e1e8ef !important;
        }
        
        body.dark-mode small {
            color: #64748b !important;
        }
        
        body.dark-mode .modal h2 {
            color: #f3f4f6 !important;
        }
        
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: #4b5563 !important;
        }
        
        body.dark-mode .form-label {
            color: #94a3b8 !important;
        }
        
        /* Dark mode - Specific form sections */
        body.dark-mode .form-section {
            background: rgba(99, 102, 241, 0.03);
            border: 1px solid rgba(99, 102, 241, 0.1);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        body.dark-mode .form-section h3 {
            color: #a5b4fc !important;
            margin-bottom: 1rem;
        }
        
        /* Special adjustments for specific inline styles */
        body.dark-mode [style*="color: #dc2626"] {
            color: #ef4444 !important;
        }
        
        body.dark-mode [style*="color: #059669"] {
            color: #10b981 !important;
        }
        
        body.dark-mode [style*="color: #0891b2"] {
            color: #06b6d4 !important;
        }
        
        /* Period selector specific */
        body.dark-mode .period-selector {
            background: #13151a;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Dark mode - Additional adjustments for better readability */
        body.dark-mode .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        
        body.dark-mode .modal-actions {
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-top: 1.5rem;
            margin-top: 2rem;
        }
        
        body.dark-mode select {
            background-color: #0d0f13;
            color: #e1e8ef;
        }
        
        body.dark-mode textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        body.dark-mode .help-text {
            color: #64748b !important;
            font-size: 0.875rem;
        }
        
        /* Focus states in dark mode */
        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Dark mode info boxes */
        body.dark-mode .info-box {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        
        /* Force all white backgrounds to be dark */
        body.dark-mode .page > div[style*="background"],
        body.dark-mode .leaderboard,
        body.dark-mode .performance-charts,
        body.dark-mode .activity-feed,
        body.dark-mode .commission-summary,
        body.dark-mode .payment-history {
            background: #16181d !important;
            color: #e1e8ef !important;
        }
        
        /* Specific page sections */
        body.dark-mode div[style*="border-radius: 1rem"][style*="padding: 2rem"] {
            background: #16181d !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
        }
        
        body.dark-mode .leaderboard-content,
        body.dark-mode .chart-grid,
        body.dark-mode .activity-content {
            background: transparent !important;
        }
        
        /* Remove any remaining white from stats pages */
        body.dark-mode .revenue-stats,
        body.dark-mode .subs-stats,
        body.dark-mode .financial-stats {
            background: #16181d !important;
        }
        
        /* Dark scrollbar for all elements */
        body.dark-mode * {
            scrollbar-color: #374151 #0d0f13;
        }
        
        /* ULTIMATE FORCE - Convert ALL white backgrounds */
        body.dark-mode div[style*="background: white"],
        body.dark-mode div[style*="background:#fff"],
        body.dark-mode div[style*="background: #fff"],
        body.dark-mode div[style*="background:white"] {
            background: #16181d !important;
        }
        
        /* Ensure text remains visible on dark backgrounds */
        body.dark-mode div[style*="background: white"] *,
        body.dark-mode div[style*="background:#fff"] *,
        body.dark-mode div[style*="background: #fff"] * {
            color: #e1e8ef !important;
        }
        
        /* Competition pages specific dark styling */
        body.dark-mode .leaderboard[style*="background: white"] {
            background: linear-gradient(135deg, #16181d 0%, #1a1d23 100%) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }
        
        /* Charts and graphs containers */
        body.dark-mode .chart-container[style*="background"],
        body.dark-mode .graph-container[style*="background"] {
            background: rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Activity items in dark mode */
        body.dark-mode .activity-item[style*="background"] {
            background: rgba(99, 102, 241, 0.05) !important;
            border-left: 3px solid #6366f1 !important;
        }
        
        /* Specific sections with classes */
        body.dark-mode .stats-section,
        body.dark-mode .charts-section {
            background: #16181d !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
        }
        
        /* Clean approach - Target specific white backgrounds */
        body.dark-mode .page > div[style*="background: white"],
        body.dark-mode .page > div[style*="background:#fff"] {
            background: #16181d !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }
        
        /* All main content divs */
        body.dark-mode .leaderboard[style*="background"],
        body.dark-mode div[style*="border-radius: 1rem"][style*="background: white"] {
            background: #16181d !important;
        }
        
        /* Ensure readability */
        body.dark-mode .page div[style*="background"] h2,
        body.dark-mode .page div[style*="background"] h3,
        body.dark-mode .page div[style*="background"] p,
        body.dark-mode .page div[style*="background"] span {
            color: #e1e8ef !important;
        }
        
        /* FINAL SOLUTION - Override with specificity */
        body.dark-mode .dark-background,
        body.dark-mode [style*="background: white"],
        body.dark-mode [style*="background:#ffffff"],
        body.dark-mode [style*="background: #ffffff"],
        body.dark-mode [style*="background:white"],
        body.dark-mode [style*="background :white"],
        body.dark-mode [style*="background : white"],
        body.dark-mode [style*="background: #f8fafc"] {
            background: #1e293b !important;
            background-color: #1e293b !important;
        }
        
        /* Last resort - target by structure */
        body.dark-mode .page > div > div {
            background-color: inherit !important;
        }
        
        /* Specific styles for unassigned Gmail accounts */
        body.dark-mode .unassigned-section {
            background: rgba(239, 68, 68, 0.05) !important;
            border-color: #ef4444 !important;
        }
        
        body.dark-mode .existing-creators-list div {
            background: rgba(0,0,0,0.2) !important;
            border-color: rgba(255,255,255,0.1) !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .existing-creators-list small {
            color: #94a3b8 !important;
        }
        
        body.dark-mode .unassigned-account-item {
            background: rgba(239, 68, 68, 0.1) !important;
            color: #e1e8ef !important;
        }
        
        body.dark-mode .unassigned-account-item strong {
            color: #f3f4f6 !important;
        }
        
        body.dark-mode .unassigned-account-item p {
            color: #94a3b8 !important;
        }
        
        body.dark-mode #assign-gmail-modal .modal-content {
            background: #1a1d23 !important;
            color: #e1e8ef !important;
        }
        
        body.dark-mode #assign-gmail-modal div[style*="background: #f8fafc"] {
            background: rgba(99, 102, 241, 0.1) !important;
            color: #e1e8ef !important;
        }
        
        /* Twitter unassigned page dark mode */
        body.dark-mode #twitter-unassigned-page div[style*="background: #fef3c7"] {
            background: rgba(249, 158, 11, 0.1) !important;
            color: #fbbf24 !important;
        }
        
        body.dark-mode #twitter-unassigned-page p[style*="color: #92400e"] {
            color: #fbbf24 !important;
        }
        
        body.dark-mode #assign-gmail-twitter-modal .modal-content {
            background: #1a1d23 !important;
            color: #e1e8ef !important;
        }
        
        body.dark-mode #assign-gmail-twitter-modal div[style*="background: #e0f2fe"] {
            background: rgba(14, 165, 233, 0.1) !important;
            color: #38bdf8 !important;
        }
        
        body.dark-mode .page > div {
            background: #16181d !important;
        }
        
        /* Commission summary card */
        .commission-summary-card {
            background: #f8fafc;
        }
        
        body.dark-mode .commission-summary-card {
            background: #16181d !important;
            color: #e1e8ef !important;
        }
        
        /* Stats and charts sections */
        .stats-section, .charts-section, .leaderboard {
            background: white;
        }
        
        body.dark-mode .stats-section,
        body.dark-mode .charts-section {
            background: #16181d !important;
        }
        
        .theme-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            font-size: 0.875rem;
            backdrop-filter: blur(10px);
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode .theme-toggle {
            background: rgba(147, 51, 234, 0.2);
            border-color: rgba(147, 51, 234, 0.3);
        }
        
        body.dark-mode .theme-toggle:hover {
            background: rgba(147, 51, 234, 0.3);
            border-color: rgba(147, 51, 234, 0.4);
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.3);
        }
        
        /* Backup button specific dark mode */
        body.dark-mode .theme-toggle[onclick*="showBackupModal"] {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        body.dark-mode .theme-toggle[onclick*="showBackupModal"]:hover {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.4);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .stats-header {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* ============================================
           NAVIGATION - Modern Floating Nav
           ============================================ */
        .nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg), 0 1px 0 rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-lg);
            flex-wrap: nowrap;
            min-height: auto;
        }

        @media (min-width: 768px) {
            .nav-content {
                padding: var(--space-md) var(--space-xl);
                flex-wrap: wrap;
            }
        }

        .nav-btn {
            padding: 0.625rem 1.25rem;
            background: transparent;
            border: 1px solid transparent;
            color: var(--gray-500);
            font-weight: 500;
            cursor: pointer;
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-500), var(--accent-purple));
            opacity: 0;
            transition: opacity var(--transition-base);
            z-index: -1;
        }

        @media (min-width: 768px) {
            .nav-btn {
                padding: 0.75rem 1.5rem;
                font-size: 0.9375rem;
            }
        }

        .nav-btn:hover {
            background: var(--gray-100);
            color: var(--gray-800);
            border-color: var(--gray-200);
            transform: translateY(-1px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-purple) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.35);
            font-weight: 600;
        }

        .nav-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .nav-btn i {
            font-size: 1rem;
            transition: transform var(--transition-base);
        }

        .nav-btn:hover i {
            transform: scale(1.1);
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main-container {
            max-width: 1400px;
            margin: var(--space-xl) auto;
            padding: 0 var(--space-xl);
        }

        /* Cards */
        .page {
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        .page.active {
            display: block;
        }

        /* ============================================
           VA CARDS GRID - Modern Card Design
           ============================================ */
        .va-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 320px), 1fr));
            gap: var(--space-xl);
            margin-top: var(--space-xl);
            padding: 0 var(--space-md);
        }

        @media (min-width: 600px) {
            .va-grid {
                grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
                padding: 0;
            }
        }

        /* ============================================
           CARD COMPONENT - Modern Design
           ============================================ */
        .card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            transition: all var(--transition-slow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            overflow: hidden;
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-500), var(--accent-purple));
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl), var(--shadow-glow);
        }

        .card:hover::before {
            opacity: 1;
        }

        /* ============================================
           VA CARD - Modern Premium Design
           ============================================ */
        .va-card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all var(--transition-slow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .va-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: var(--radius-xl);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            pointer-events: none;
        }

        .va-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: var(--shadow-xl), 0 0 40px rgba(99, 102, 241, 0.12);
        }

        .va-header {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-purple) 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            overflow: hidden;
        }

        .va-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        }

        .va-actions {
            display: flex;
            gap: var(--space-sm);
            position: relative;
            z-index: 1;
        }

        .delete-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
            backdrop-filter: blur(10px);
        }

        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.8);
            border-color: rgba(239, 68, 68, 0.9);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .va-name {
            font-size: 1.375rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.02em;
            position: relative;
            z-index: 1;
        }

        .va-stats {
            font-size: 0.875rem;
            opacity: 0.9;
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-xs);
            position: relative;
            z-index: 1;
        }

        .creatrice-section {
            padding: var(--space-lg);
        }

        /* ============================================
           CREATRICE ITEM - Modern List Design
           ============================================ */
        .creatrice-item {
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            border: 1px solid var(--gray-100);
            border-left: 4px solid var(--primary-500);
            transition: all var(--transition-base);
            position: relative;
        }

        .creatrice-item:hover {
            background: white;
            border-color: var(--primary-200);
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .creatrice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .creatrice-name {
            font-weight: 700;
            color: var(--gray-800);
            font-size: 1.0625rem;
            letter-spacing: -0.01em;
        }

        /* ============================================
           TWITTER ACCOUNTS - Modern Badge Design
           ============================================ */
        .twitter-accounts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.625rem;
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(29, 161, 242, 0.04) 0%, rgba(29, 161, 242, 0.02) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(29, 161, 242, 0.1);
            margin-top: var(--space-sm);
        }

        .twitter-badge {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #1e293b;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.05);
            text-decoration: none;
            cursor: pointer;
            overflow: visible;
            white-space: nowrap;
        }

        .twitter-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        a.twitter-badge {
            color: #1e293b;
            text-decoration: none;
        }

        a.twitter-badge:visited {
            color: #1e293b;
        }

        .twitter-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
            border-color: rgba(203, 213, 225, 1);
            background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
        }

        .twitter-badge:hover::before {
            opacity: 0;
        }

        .twitter-badge i.fab {
            font-size: 1rem;
            color: #1DA1F2;
        }

        .twitter-badge button {
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
            border-radius: 8px !important;
            background: rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            color: #64748b !important;
            transition: all 0.2s ease !important;
        }

        .twitter-badge button:hover {
            background: rgba(0, 0, 0, 0.1) !important;
            transform: scale(1.08) !important;
            border-color: rgba(0, 0, 0, 0.15) !important;
        }

        /* Instagram accounts container - ULTRA MODERNE */
        .instagram-accounts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.625rem;
            padding: 1rem;
            background: rgba(248, 250, 252, 0.5);
            border-radius: 12px;
            border: 1.5px solid rgba(226, 232, 240, 0.6);
            margin-top: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .instagram-badge {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #1e293b;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            text-decoration: none;
            letter-spacing: 0.01em;
        }

        .instagram-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        a.instagram-badge {
            color: #1e293b;
            text-decoration: none;
        }

        a.instagram-badge:visited {
            color: #1e293b;
        }

        .instagram-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.08);
            border-color: rgba(203, 213, 225, 1);
            background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
        }

        .instagram-badge:hover::before {
            opacity: 0;
        }

        .instagram-badge i.fab {
            font-size: 1rem;
            background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .instagram-badge button {
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
            border-radius: 8px !important;
            background: rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            color: #64748b !important;
            transition: all 0.2s ease !important;
        }

        .instagram-badge button:hover {
            background: rgba(0, 0, 0, 0.1) !important;
            transform: scale(1.08) !important;
            border-color: rgba(0, 0, 0, 0.15) !important;
        }
        
        /* Adjust creatrice-item spacing */
        .creatrice-item {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(229, 231, 235, 0.5);
            transition: all 0.2s ease;
        }
        
        .creatrice-item:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(229, 231, 235, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        

        /* ============================================
           FORMS - Modern Premium Design
           ============================================ */
        .form-container {
            background: white;
            padding: var(--space-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        @media (min-width: 600px) {
            .form-container {
                padding: var(--space-2xl);
            }
        }

        .form-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: var(--space-xl);
            text-align: center;
            color: var(--gray-800);
            letter-spacing: -0.02em;
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.9375rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 16px;
            box-sizing: border-box;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all var(--transition-base);
            background: var(--gray-50);
        }

        .form-group input:hover, .form-group select:hover {
            border-color: var(--gray-300);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-500);
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* ============================================
           BUTTONS - Modern Design System
           ============================================ */
        .submit-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-purple) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.35);
        }

        .submit-btn:hover::before {
            left: 100%;
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .cancel-btn {
            padding: 1rem 1.5rem;
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .cancel-btn:hover {
            background: var(--gray-200);
            border-color: var(--gray-300);
        }

        /* ============================================
           IMPORT AREA - Drag & Drop
           ============================================ */
        .import-area {
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            text-align: center;
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .import-area:hover {
            border-color: var(--primary-400);
            background: linear-gradient(135deg, var(--primary-50) 0%, white 100%);
        }

        .import-area.dragover {
            border-color: var(--primary-500);
            background: var(--primary-50);
            border-style: solid;
            transform: scale(1.01);
        }

        /* ============================================
           SUCCESS/ERROR MESSAGES
           ============================================ */
        .success-message {
            position: fixed;
            top: var(--space-xl);
            right: var(--space-xl);
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-lg);
            display: none;
            align-items: center;
            gap: var(--space-md);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.35);
            font-weight: 600;
            max-width: 500px;
            z-index: 10000;
            animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .success-message.show {
            display: flex;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Error Message */
        .error-message {
            position: fixed;
            top: var(--space-xl);
            right: var(--space-xl);
            padding: var(--space-md) var(--space-lg);
            background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
            color: white;
            border-radius: var(--radius-lg);
            display: none;
            align-items: center;
            gap: var(--space-sm);
            z-index: 10000;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.35);
            font-weight: 600;
            animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .error-message.show {
            display: flex;
        }

        /* ============================================
           MODAL - Modern Glassmorphism Design
           ============================================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: var(--space-xl);
            border-radius: var(--radius-2xl);
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), var(--shadow-glow);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-400);
            transition: all var(--transition-base);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
        }

        .close-modal:hover {
            color: var(--gray-600);
            background: var(--gray-100);
        }

        /* ============================================
           ACTION BUTTONS
           ============================================ */
        .actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .action-btn {
            padding: 0.375rem 0.875rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .view-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .view-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        .action-btn.delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .action-btn.delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-1px);
        }

        /* ============================================
           SEARCH - Modern Design
           ============================================ */
        .search-container {
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-xl);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .search-input {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all var(--transition-base);
            background: var(--gray-50);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-results {
            margin-top: var(--space-xl);
        }

        .no-creator {
            color: var(--gray-400);
            font-style: italic;
            text-align: center;
            padding: var(--space-xl);
        }

        /* ============================================
           COMPETITION HEADER - Premium Design
           ============================================ */
        .competition-header {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--accent-purple) 50%, var(--primary-600) 100%);
            background-size: 200% 200%;
            animation: gradient-shift 10s ease infinite;
            color: white;
            padding: var(--space-2xl);
            border-radius: var(--radius-2xl);
            margin-bottom: var(--space-xl);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.3);
        }

        .competition-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes pulse-warning {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(255, 8, 68, 0.4);
            }
            50% {
                box-shadow: 0 4px 16px rgba(255, 8, 68, 0.7);
            }
        }

        @keyframes pulse-glow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.5);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 25px rgba(16, 185, 129, 0.8);
            }
        }

        .competition-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .competition-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            position: relative;
            z-index: 1;
        }

        .stat-box {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Leaderboard */
        .leaderboard-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .leaderboard {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .leaderboard-header {
            background: #1a1a1a;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .leaderboard-item {
            padding: 1.5rem;
            border-bottom: 1px solid #f0f2f5;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
            position: relative;
        }

        .leaderboard-item:hover {
            background: #f8fafc;
            transform: translateX(5px);
        }

        .rank-badge {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.25rem;
            border-radius: 50%;
        }

        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #808080); color: white; }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; }
        .rank-other { background: #e2e8f0; color: #64748b; }

        .va-info {
            flex: 1;
        }

        .va-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .va-stats-mini {
            font-size: 0.875rem;
            color: #64748b;
            display: flex;
            gap: 1rem;
        }

        .va-score {
            text-align: right;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
            color: #10b981;
        }

        .score-label {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .action-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .quick-action-btn {
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .add-subs-quick {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .add-subs-quick:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .view-details-btn {
            background: #f1f5f9;
            color: #1a1a1a;
        }

        .view-details-btn:hover {
            background: #e2e8f0;
        }

        /* Performance Charts */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Period Tabs */
        .period-tabs {
            display: flex;
            gap: 0.5rem;
            background: #f1f5f9;
            padding: 0.25rem;
            border-radius: 0.5rem;
        }

        .period-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s;
        }

        .period-tab.active {
            background: white;
            color: #1a1a1a;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Progress Bars */
        .progress-container {
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Recent Activity */
        .activity-feed {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f2f5;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: #f1f5f9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        /* ========== MOBILE RESPONSIVE DESIGN ========== */
        
        /* Menu burger pour mobile */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }
        
        body.dark-mode .mobile-menu-toggle {
            background: #8b5cf6;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        }
        
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .mobile-nav-overlay.active {
            display: block;
            opacity: 1;
        }
        
        /* Responsive - voir iphone-14-pro-fixes.css pour le dtail */
        @media (max-width: 1024px) {
            .va-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Mobile/Responsive styles - voir iphone-14-pro-fixes.css */

        /* Ultra Table Styles */
        .ultra-table tr {
            transition: all 0.15s ease;
        }
        
        .ultra-table tbody tr {
            border-bottom: 1px solid #f8fafc;
        }
        
        .dark-mode .ultra-table tbody tr {
            border-bottom: 1px solid #1e293b;
        }
        
        .ultra-table tbody tr:hover {
            background: #f8fafc;
        }
        
        .dark-mode .ultra-table tbody tr:hover {
            background: #1e293b;
        }
        
        .ultra-table td {
            padding: 1rem;
            font-size: 0.875rem;
            color: #334155;
        }
        
        .dark-mode .ultra-table td {
            color: #e2e8f0;
        }
        
        .twitter-handle {
            font-weight: 600;
            color: #1DA1F2;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .model-name {
            font-weight: 500;
            color: #6366f1;
        }
        
        .dark-mode .model-name {
            color: #a78bfa;
        }
        
        .va-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: #e0e7ff;
            color: #4338ca;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .dark-mode .va-badge {
            background: #4338ca;
            color: #e0e7ff;
        }
        
        .gmail-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        .gmail-status.active {
            background: #d1fae5;
            color: #059669;
        }
        
        .dark-mode .gmail-status.active {
            background: #059669;
            color: #d1fae5;
        }
        
        .gmail-status.inactive {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .dark-mode .gmail-status.inactive {
            background: #dc2626;
            color: #fee2e2;
        }
        
        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .score-badge.high {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }
        
        .dark-mode .score-badge.high {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .score-badge.medium {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
        }
        
        .dark-mode .score-badge.medium {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .score-badge.low {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            color: white;
        }
        
        .dark-mode .score-badge.low {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .rank-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.875rem;
        }
        
        .rank-number.gold {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }
        
        .rank-number.silver {
            background: linear-gradient(135deg, #cbd5e1, #94a3b8);
            color: white;
        }
        
        .rank-number.bronze {
            background: linear-gradient(135deg, #f87171, #dc2626);
            color: white;
        }
        
        .rank-number.default {
            background: #f1f5f9;
            color: #64748b;
        }
        
        @media (max-width: 768px) {
            .ultra-table {
                font-size: 0.75rem;
            }
            
            .ultra-table td, .ultra-table th {
                padding: 0.5rem;
            }
        }
        
        /* Ultra Table Container Styles */
        .ultra-table-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .dark-mode .ultra-table-container {
            background: #0f172a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .ultra-table-title {
            margin: 0 0 1.5rem 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .dark-mode .ultra-table-title {
            color: #f1f5f9;
        }
        
        .ultra-table thead tr {
            border-bottom: 1px solid #f1f5f9;
        }
        
        .dark-mode .ultra-table thead tr {
            border-bottom: 1px solid #334155;
        }
        
        .ultra-table th {
            color: #64748b;
        }
        
        .dark-mode .ultra-table th {
            color: #94a3b8;
        }
        
        /* VA Warning Styles */
        .va-warning {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 0.5rem;
            color: #92400e;
            font-size: 0.875rem;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .dark-mode .va-warning {
            background: #451a03;
            border-color: #f59e0b;
            color: #fbbf24;
        }

        /* Warm-up Styles */
        .warmup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr));
            gap: 1rem;
            padding: 1rem;
        }

        @media (min-width: 600px) {
            .warmup-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }

        .warmup-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .dark-mode .warmup-card {
            background: #1f2937;
            border-color: #374151;
        }

        .warmup-card.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #059669;
            color: white;
        }

        .warmup-progress {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .warmup-day {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .warmup-day.done {
            background: #10b981;
            color: white;
            transform: scale(1.1);
        }

        .warmup-day.current {
            background: #3b82f6;
            color: white;
            animation: pulse 2s infinite;
            transform: scale(1.15);
        }

        .warmup-day.pending {
            background: #f3f4f6;
            color: #9ca3af;
            border: 2px solid #e5e7eb;
        }

        .dark-mode .warmup-day.pending {
            background: #374151;
            color: #6b7280;
            border-color: #4b5563;
        }

        .warmup-tasks {
            background: #f9fafb;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .warmup-tasks.show {
            max-height: 300px;
        }

        .dark-mode .warmup-tasks {
            background: #111827;
        }

        /* Team Management Styles */
        .team-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .team-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        body.dark-mode .stat-card {
            background: #1e293b;
            border-color: #334155;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.15);
            border-color: #6366f1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .member-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        body.dark-mode .member-card {
            background: #1e293b;
            border-color: #334155;
        }

        .member-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .member-card:hover::before {
            transform: scaleX(1);
        }

        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
        }

        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .role-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-badge.owner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .role-badge.admin {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }

        .role-badge.member {
            background: #e0e7ff;
            color: #4f46e5;
        }

        body.dark-mode .role-badge.member {
            background: #312e81;
            color: #c7d2fe;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(100, 116, 139, 0.3);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeInUp 0.5s ease-out;
        }

        .grid-span-4 { grid-column: span 4; }
        .grid-span-6 { grid-column: span 6; }
        .grid-span-8 { grid-column: span 8; }
        .grid-span-12 { grid-column: span 12; }

        @media (max-width: 1024px) {
            .grid-span-4, .grid-span-6, .grid-span-8 { grid-column: span 12; }
        }

        .btn-secondary {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-danger-small {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-danger-small:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: #64748b;
            font-size: 1.1rem;
        }

        body.dark-mode .page-header p {
            color: #9ca3af;
        }

        body.dark-mode #invitation-code-display {
            background: #0d0f13;
            color: #e1e8ef;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* ============================================
           ACCOUNT STATUS SYSTEM STYLES
           ============================================ */

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.375rem;
            border: 1.5px solid;
            transition: all 0.2s ease;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .status-banned {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status-suspended {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
            border-color: rgba(249, 115, 22, 0.3);
        }

        .status-warning {
            background: rgba(234, 179, 8, 0.15);
            color: #eab308;
            border-color: rgba(234, 179, 8, 0.3);
        }

        .status-paused {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
            border-color: rgba(107, 114, 128, 0.3);
        }

        .status-edit-btn {
            background: rgba(59, 130, 246, 0.1);
            border: none;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.7rem;
            color: #3b82f6;
            margin-left: 0.375rem;
            transition: all 0.2s ease;
        }

        .status-edit-btn:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        /* Status Modal */
        .status-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .status-modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: calc(100% - 2rem);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideUp 0.3s ease;
        }

        body.dark-mode .status-modal-content {
            background: #1e293b;
            color: #e1e8ef;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .status-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .status-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        body.dark-mode .status-modal-title {
            color: #e1e8ef;
        }

        .status-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s;
        }

        .status-modal-close:hover {
            color: #ef4444;
        }

        .status-form-group {
            margin-bottom: 1.25rem;
        }

        .status-form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
        }

        body.dark-mode .status-form-label {
            color: #94a3b8;
        }

        .status-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        body.dark-mode .status-select {
            background: #0d0f13;
            border-color: rgba(255, 255, 255, 0.1);
            color: #e1e8ef;
        }

        .status-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .status-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.9375rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all 0.2s;
            background: white;
        }

        body.dark-mode .status-textarea {
            background: #0d0f13;
            border-color: rgba(255, 255, 255, 0.1);
            color: #e1e8ef;
        }

        .status-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .status-modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .status-btn {
            flex: 1;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .status-btn-save {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .status-btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .status-btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        body.dark-mode .status-btn-cancel {
            background: #334155;
            color: #94a3b8;
        }

        .status-btn-cancel:hover {
            background: #e5e7eb;
        }

        body.dark-mode .status-btn-cancel:hover {
            background: #475569;
        }
    </style>

    <!-- Account Status System -->
    <script src="account-status-system.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 1.5rem;">
                <div>
                    <h1> VA Manager Pro</h1>
                    <p>Gestion des Virtual Assistants et Cratrices</p>
                    <div style="margin-top: 0.5rem;">
                        <span id="user-email" style="font-size: 0.875rem; opacity: 0.9;"></span>
                    </div>
                </div>

            </div>
            <div class="stats-header">
                <div class="stat-item">
                    <div class="stat-number" id="total-vas">0</div>
                    <div class="stat-label">VAs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-creators">0</div>
                    <div class="stat-label">Cratrices</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-accounts">0</div>
                    <div class="stat-label">Comptes</div>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <div id="save-status" style="font-size: 0.75rem; padding: 0.25rem 0.75rem; 
                                                 background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); 
                                                 border-radius: 9999px; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-shield-alt" style="color: #22c55e;"></i>
                        <span id="save-status-text" style="color: #22c55e;">Protg</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleDarkMode()">
                        <i class="fas fa-moon" id="theme-icon"></i>
                        <span id="theme-text">Mode Nuit</span>
                    </button>
                    <button class="theme-toggle" onclick="showBackupModal()"
                            style="background: linear-gradient(135deg, #22c55e, #16a34a);
                                   color: white; font-weight: 600; position: relative; overflow: hidden;">
                        <i class="fas fa-save"></i>
                        <span>Sauvegarder</span>
                        <div id="save-pulse" style="position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
                                                   background: rgba(255,255,255,0.3); border-radius: 50%;
                                                   transform: translate(-50%, -50%) scale(0); opacity: 0;"></div>
                    </button>
                    <button class="theme-toggle" onclick="handleLogout()"
                            style="background: rgba(239, 68, 68, 0.2);
                                   border-color: rgba(239, 68, 68, 0.3);
                                   color: #fecaca;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Dconnexion</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Nav Toggle Button (3 points) -->
    <button class="mobile-nav-toggle" id="mobile-nav-toggle" onclick="toggleMobileNav()" style="display: none;">
        <i class="fas fa-ellipsis-v"></i>
    </button>

    <!-- Navigation -->
    <nav class="nav" id="mobile-nav-dropdown">
        <div class="nav-content">
            <button class="nav-btn active" data-page="dashboard">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button class="nav-btn" data-page="team-management">
                <i class="fas fa-users-cog"></i> quipe
            </button>
            <button class="nav-btn" data-page="add-va">
                <i class="fas fa-user-plus"></i> Ajouter VA
            </button>
            <button class="nav-btn" data-page="add-creator">
                <i class="fas fa-user-friends"></i> Cratrices
            </button>
            <button class="nav-btn" data-page="gmail-accounts">
                <i class="fas fa-envelope"></i> Gmail
            </button>
            <button class="nav-btn" data-page="add-account">
                <i class="fab fa-twitter"></i> Comptes
            </button>
            <button class="nav-btn" data-page="subs-tracking">
                <i class="fas fa-euro-sign"></i> Subs
            </button>
            <button class="nav-btn" data-page="revenue-tracking">
                <i class="fas fa-chart-line"></i> Revenus
            </button>
            <button class="nav-btn" data-page="financial-overview">
                <i class="fas fa-coins"></i> Finance
            </button>
            <button class="nav-btn" data-page="followers-tracking" style="background: linear-gradient(135deg, #1da1f2 0%, #0d8bd9 100%); color: white; font-weight: 600; border: 2px solid rgba(29, 161, 242, 0.3); box-shadow: 0 4px 15px rgba(29, 161, 242, 0.2);">
                <i class="fas fa-users"></i> Suivi Followers
            </button>
            <button class="nav-btn" data-page="instagram-warmup" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600; border: 2px solid rgba(245, 158, 11, 0.3); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);">
                <i class="fas fa-fire"></i> Warm-up
            </button>
            <button class="nav-btn" data-page="search">
                <i class="fas fa-search"></i> Rechercher
            </button>
            <button class="nav-btn" data-page="import">
                <i class="fas fa-file-import"></i> Import
            </button>
            <!-- Admin Button - Only visible for organization owners -->
            <button class="nav-btn" data-page="admin" id="admin-nav-btn" style="display: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-weight: 600; border: 2px solid rgba(239, 68, 68, 0.3); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">
                <i class="fas fa-shield-alt"></i> Admin
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Security Warning -->
        <div id="security-warning" style="background: #fef3c7; border: 2px solid #f59e0b; padding: 1rem; margin: 1rem; border-radius: 0.5rem; display: none;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 1.5rem;"></i>
                <div>
                    <strong style="color: #92400e;">Avertissement de scurit</strong>
                    <p style="margin: 0.5rem 0 0 0; color: #92400e; font-size: 0.875rem;">
                        Les mots de passe sont stocks localement avec une protection basique. 
                        Pour une scurit optimale, utilisez des mots de passe uniques et considrez l'utilisation d'un gestionnaire de mots de passe professionnel.
                    </p>
                    <button onclick="document.getElementById('security-warning').style.display='none'; localStorage.setItem('securityWarningDismissed', 'true')" 
                            style="margin-top: 0.5rem; padding: 0.25rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                        J'ai compris
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page active">

            <!-- Welcome Header - Bandeau de bienvenue -->
            <div class="dash-welcome-header">
                <div class="dash-welcome-content">
                    <div class="dash-welcome-text">
                        <h1>
                            <i class="fas fa-chart-line"></i>
                            Tableau de bord
                        </h1>
                        <p>Bienvenue ! Voici un apercu de votre activite.</p>
                    </div>
                    <div class="dash-welcome-date">
                        <div class="date" id="current-date-display"></div>
                        <div id="current-time-display"></div>
                    </div>
                </div>
            </div>

            <!-- Alerte Rappel Mise  jour Followers -->
            <div id="followers-update-reminder" class="dash-reminder-alert" style="display: none;">
                <div class="dash-reminder-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="dash-reminder-content">
                    <div class="dash-reminder-title">Mise  jour des followers requise</div>
                    <div class="dash-reminder-text">Les followers n'ont pas encore t mis  jour aujourd'hui. Pensez  les mettre  jour pour un suivi prcis.</div>
                </div>
                <button onclick="navigateToPage('followers-tracking')" class="dash-reminder-btn">
                    <i class="fas fa-edit"></i> Mettre  jour
                </button>
                <button onclick="dismissFollowersReminder()" class="dash-reminder-close" title="Fermer">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Stats Header - Mtriques principales -->
            <div class="dash-stats-header">
                <div class="dash-stat-card" style="--accent-color: #8b5cf6;">
                    <div class="dash-stat-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="dash-stat-content">
                        <div class="dash-stat-label">Creatrices</div>
                        <div class="dash-stat-value" id="dash-creators-count">0</div>
                        <div class="dash-stat-trend">
                            <span class="dash-stat-change positive" id="creators-change" style="display: none;">
                                <i class="fas fa-arrow-up"></i> <span></span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="dash-stat-card" style="--accent-color: #10b981;">
                    <div class="dash-stat-icon success">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="dash-stat-content">
                        <div class="dash-stat-label">VAs Actifs</div>
                        <div class="dash-stat-value" id="dash-vas-count">0</div>
                        <div class="dash-stat-trend">
                            <span class="dash-stat-change positive" id="vas-change" style="display: none;">
                                <i class="fas fa-arrow-up"></i> <span></span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="dash-stat-card" style="--accent-color: #1da1f2;">
                    <div class="dash-stat-icon twitter">
                        <i class="fab fa-twitter"></i>
                    </div>
                    <div class="dash-stat-content">
                        <div class="dash-stat-label">Comptes Twitter</div>
                        <div class="dash-stat-value" id="dash-twitter-count">0</div>
                        <div class="dash-stat-trend">
                            <span class="dash-stat-change positive" id="twitter-change" style="display: none;">
                                <i class="fas fa-arrow-up"></i> <span></span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="dash-stat-card" style="--accent-color: #e1306c;">
                    <div class="dash-stat-icon instagram">
                        <i class="fab fa-instagram"></i>
                    </div>
                    <div class="dash-stat-content">
                        <div class="dash-stat-label">Comptes Instagram</div>
                        <div class="dash-stat-value" id="dash-instagram-count">0</div>
                        <div class="dash-stat-trend">
                            <span class="dash-stat-change positive" id="instagram-change" style="display: none;">
                                <i class="fas fa-arrow-up"></i> <span></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Banned Accounts Alert -->
            <div id="banned-accounts-alert" class="dash-alert danger" style="display: none;">
                <div class="dash-alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="dash-alert-content">
                    <div class="dash-alert-title">Comptes Problmatiques Dtects</div>
                    <div class="dash-alert-text" id="banned-accounts-message"></div>
                </div>
                <button class="dash-alert-action" onclick="filterBannedAccounts()">
                    <i class="fas fa-eye"></i> Voir
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="dash-quick-actions">
                <button onclick="exportData()" class="dash-action-btn">
                    <i class="fas fa-download"></i> Exporter
                </button>
                <button onclick="createAutoBackup()" class="dash-action-btn">
                    <i class="fas fa-save"></i> Sauvegarde
                </button>
            </div>

            <!-- Section Suivi Followers - Design Pro 2.0 -->
            <div class="dash-section dash-followers-section" id="followers-dashboard-section">
                <div class="dash-section-header">
                    <h3 class="dash-section-title">
                        <i class="fab fa-twitter"></i>
                        Croissance Followers
                    </h3>
                    <button onclick="navigateToPage('followers-tracking')" class="dash-action-btn primary">
                        <i class="fas fa-edit"></i> Mettre a jour
                    </button>
                </div>

                <!-- Stats Cards Followers -->
                <div class="dash-followers-stats">
                    <div class="dash-followers-stat-card twitter">
                        <div class="dash-followers-stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="dash-followers-stat-content">
                            <div class="dash-followers-stat-label">Total Followers</div>
                            <div class="dash-followers-stat-value" id="followers-total-value">0</div>
                        </div>
                    </div>
                    <div class="dash-followers-stat-card success">
                        <div class="dash-followers-stat-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div class="dash-followers-stat-content">
                            <div class="dash-followers-stat-label">Aujourd'hui</div>
                            <div class="dash-followers-stat-value" id="followers-today-value">+0</div>
                        </div>
                    </div>
                    <div class="dash-followers-stat-card purple">
                        <div class="dash-followers-stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="dash-followers-stat-content">
                            <div class="dash-followers-stat-label">Cette Semaine</div>
                            <div class="dash-followers-stat-value" id="followers-week-value">+0</div>
                        </div>
                    </div>
                </div>

                <!-- Graphique Principal -->
                <div class="dash-chart-container">
                    <div class="dash-chart-header">
                        <span id="followers-chart-label" class="dash-chart-title">Evolution sur 7 jours</span>
                        <div class="dash-chart-period-btns">
                            <button onclick="updateFollowersDashboardChart(7)" id="chart-period-7" class="dash-period-btn active">7j</button>
                            <button onclick="updateFollowersDashboardChart(14)" id="chart-period-14" class="dash-period-btn">14j</button>
                            <button onclick="updateFollowersDashboardChart(30)" id="chart-period-30" class="dash-period-btn">30j</button>
                        </div>
                    </div>
                    <div id="followers-chart-container" class="dash-chart-canvas-wrapper">
                        <canvas id="followers-main-chart"></canvas>
                    </div>
                    <div id="followers-chart-empty" class="dash-chart-empty">
                        <i class="fas fa-chart-line"></i>
                        <p>Enregistrez des followers pour voir le graphique</p>
                    </div>
                </div>

                <!-- Top Performers -->
                <div class="dash-top-performers">
                    <div class="dash-top-performers-header">
                        <i class="fas fa-trophy"></i>
                        <span>Top Performers</span>
                    </div>
                    <div id="followers-top-performers" class="dash-top-performers-list">
                        <div class="dash-top-performers-loading">
                            <i class="fas fa-spinner fa-spin"></i> Chargement...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rcapitulatif Cratrices -->
            <div class="dash-section">
                <div class="dash-section-header">
                    <h3 class="dash-section-title">
                        <i class="fas fa-users" style="color: #8b5cf6;"></i>
                        Cratrices
                    </h3>
                    <span id="creators-count-badge" class="dash-section-badge">
                        <i class="fas fa-circle" style="font-size: 0.5rem; color: #8b5cf6;"></i>
                        0 cratrice
                    </span>
                </div>
                <div id="creators-cards-grid" class="dash-accounts-grid">
                    <!-- Les cartes seront gnres dynamiquement -->
                </div>
            </div>

            <!-- Twitter Accounts - Pro Dashboard -->
            <div class="dash-section dash-twitter-pro-section">
                <div class="dash-section-header">
                    <h3 class="dash-section-title">
                        <i class="fab fa-twitter"></i>
                        Suivi Twitter Pro
                    </h3>
                    <div class="dash-twitter-header-actions">
                        <span id="twitter-count-badge" class="dash-section-badge">
                            <i class="fas fa-circle" style="font-size: 0.5rem; color: #1da1f2;"></i>
                            0 comptes
                        </span>
                        <button onclick="navigateToPage('followers-tracking')" class="dash-action-btn primary" style="padding: 0.5rem 1rem; font-size: 0.8125rem;">
                            <i class="fas fa-plus"></i> Ajouter stats
                        </button>
                    </div>
                </div>

                <!-- KPIs Twitter Globaux -->
                <div class="dash-twitter-kpis" id="twitter-global-kpis">
                    <div class="dash-twitter-kpi">
                        <div class="dash-twitter-kpi-icon twitter">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="dash-twitter-kpi-content">
                            <div class="dash-twitter-kpi-value" id="twitter-kpi-total">0</div>
                            <div class="dash-twitter-kpi-label">Total Followers</div>
                        </div>
                    </div>
                    <div class="dash-twitter-kpi">
                        <div class="dash-twitter-kpi-icon success">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="dash-twitter-kpi-content">
                            <div class="dash-twitter-kpi-value" id="twitter-kpi-today">+0</div>
                            <div class="dash-twitter-kpi-label">Aujourd'hui</div>
                        </div>
                    </div>
                    <div class="dash-twitter-kpi">
                        <div class="dash-twitter-kpi-icon purple">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="dash-twitter-kpi-content">
                            <div class="dash-twitter-kpi-value" id="twitter-kpi-week">+0</div>
                            <div class="dash-twitter-kpi-label">Cette semaine</div>
                        </div>
                    </div>
                    <div class="dash-twitter-kpi">
                        <div class="dash-twitter-kpi-icon warning">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="dash-twitter-kpi-content">
                            <div class="dash-twitter-kpi-value" id="twitter-kpi-avg">0%</div>
                            <div class="dash-twitter-kpi-label">Croissance moy.</div>
                        </div>
                    </div>
                </div>

                <!-- Filtres par cratrice -->
                <div id="twitter-creator-tabs" class="dash-tabs">
                    <!-- Tabs will be generated here -->
                </div>

                <!-- Tableau de classement Pro -->
                <div class="dash-twitter-leaderboard" id="twitter-leaderboard">
                    <div class="dash-twitter-leaderboard-header">
                        <div class="dash-twitter-col-rank">#</div>
                        <div class="dash-twitter-col-account">Compte</div>
                        <div class="dash-twitter-col-followers">Followers</div>
                        <div class="dash-twitter-col-growth">Croissance</div>
                        <div class="dash-twitter-col-trend">Tendance 7j</div>
                        <div class="dash-twitter-col-va">VA</div>
                    </div>
                    <div class="dash-twitter-leaderboard-body" id="twitter-leaderboard-body">
                        <!-- Rows will be generated here -->
                    </div>
                </div>

                <!-- Vue grille (cache par dfaut) -->
                <div id="twitter-top-accounts" class="dash-accounts-grid" style="display: none;">
                    <!-- Les cartes seront gnres ici -->
                </div>

                <!-- Toggle vue -->
                <div class="dash-twitter-view-toggle">
                    <button class="dash-view-btn active" onclick="setTwitterView('table')" id="twitter-view-table">
                        <i class="fas fa-list"></i> Tableau
                    </button>
                    <button class="dash-view-btn" onclick="setTwitterView('grid')" id="twitter-view-grid">
                        <i class="fas fa-th-large"></i> Grille
                    </button>
                </div>
            </div>

            <!-- Top Instagram Accounts -->
            <div class="dash-section">
                <div class="dash-section-header">
                    <h3 class="dash-section-title">
                        <i class="fab fa-instagram" style="color: #e1306c;"></i>
                        Comptes Instagram
                    </h3>
                    <span id="instagram-count-badge" class="dash-section-badge">
                        <i class="fas fa-circle" style="font-size: 0.5rem; color: #e1306c;"></i>
                        0 comptes
                    </span>
                </div>

                <div id="instagram-creator-tabs" class="dash-tabs">
                    <!-- Tabs will be generated here -->
                </div>

                <div id="instagram-top-accounts" class="dash-accounts-grid">
                    <!-- Les cartes seront gnres ici -->
                </div>
            </div>

            <!-- VAs Section - Pro Dashboard -->
            <div class="dash-section dash-va-pro-section">
                <div class="dash-section-header">
                    <h3 class="dash-section-title">
                        <i class="fas fa-user-tie"></i>
                        Equipe VAs
                    </h3>
                    <div class="dash-va-header-actions">
                        <span id="va-grid-count-badge" class="dash-section-badge">
                            <i class="fas fa-circle" style="font-size: 0.5rem; color: #10b981;"></i>
                            0 VAs
                        </span>
                        <button onclick="navigateToPage('add-va-page')" class="dash-action-btn success" style="padding: 0.5rem 1rem; font-size: 0.8125rem;">
                            <i class="fas fa-plus"></i> Ajouter VA
                        </button>
                    </div>
                </div>

                <!-- KPIs VAs Globaux -->
                <div class="dash-va-kpis" id="va-global-kpis">
                    <div class="dash-va-kpi">
                        <div class="dash-va-kpi-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="dash-va-kpi-content">
                            <div class="dash-va-kpi-value" id="va-kpi-total">0</div>
                            <div class="dash-va-kpi-label">VAs Actifs</div>
                        </div>
                    </div>
                    <div class="dash-va-kpi">
                        <div class="dash-va-kpi-icon twitter">
                            <i class="fab fa-twitter"></i>
                        </div>
                        <div class="dash-va-kpi-content">
                            <div class="dash-va-kpi-value" id="va-kpi-twitter">0</div>
                            <div class="dash-va-kpi-label">Comptes Twitter</div>
                        </div>
                    </div>
                    <div class="dash-va-kpi">
                        <div class="dash-va-kpi-icon instagram">
                            <i class="fab fa-instagram"></i>
                        </div>
                        <div class="dash-va-kpi-content">
                            <div class="dash-va-kpi-value" id="va-kpi-instagram">0</div>
                            <div class="dash-va-kpi-label">Comptes Instagram</div>
                        </div>
                    </div>
                    <div class="dash-va-kpi">
                        <div class="dash-va-kpi-icon warning">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="dash-va-kpi-content">
                            <div class="dash-va-kpi-value" id="va-kpi-avg">0</div>
                            <div class="dash-va-kpi-label">Comptes/VA moy.</div>
                        </div>
                    </div>
                </div>

                <!-- Tableau de classement VAs Pro -->
                <div class="dash-va-leaderboard" id="va-leaderboard">
                    <div class="dash-va-leaderboard-header">
                        <div class="dash-va-col-rank">#</div>
                        <div class="dash-va-col-name">Virtual Assistant</div>
                        <div class="dash-va-col-accounts">Comptes Twitter</div>
                        <div class="dash-va-col-total">Total</div>
                        <div class="dash-va-col-actions">Actions</div>
                    </div>
                    <div class="dash-va-leaderboard-body" id="va-leaderboard-body">
                        <!-- Rows will be generated here -->
                    </div>
                </div>

                <!-- Vue grille (cache par dfaut) -->
                <div class="dash-va-grid" id="va-grid" style="display: none;">
                    <!-- VA cards will be dynamically inserted here -->
                </div>

                <!-- Toggle vue -->
                <div class="dash-va-view-toggle">
                    <button class="dash-view-btn active" onclick="setVAView('table')" id="va-view-table">
                        <i class="fas fa-list"></i> Tableau
                    </button>
                    <button class="dash-view-btn" onclick="setVAView('grid')" id="va-view-grid">
                        <i class="fas fa-th-large"></i> Grille
                    </button>
                </div>
            </div>

            <!-- Hidden: Comptes Actifs par Cratrice (pour compatibilit) -->
            <div id="active-accounts-by-creator" style="display: none;"></div>

        </div>

        <!-- Add VA Page -->
        <div id="add-va-page" class="page">
            <div class="form-container">
                <h2 class="form-title">Ajouter un Virtual Assistant</h2>
                <form id="add-va-form">
                    <div class="form-group">
                        <label for="va-name">Nom du VA</label>
                        <input type="text" id="va-name" required placeholder="Ex: Hugo">
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-plus"></i> Ajouter VA
                    </button>
                </form>
            </div>

            <!-- Liste des VAs existants -->
            <div style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
                <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-color);">
                        <i class="fas fa-users" style="color: #667eea; margin-right: 0.5rem;"></i>
                        Virtual Assistants
                    </h2>
                    <span id="va-list-count" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 600; font-size: 0.875rem;">
                        0 VA
                    </span>
                </div>
                <div id="va-list-display" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 1.5rem;">
                    <!-- VAs will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Gmail Accounts Page -->
        <div id="gmail-accounts-page" class="page">
            <div style="display: flex; gap: 2rem; max-width: 1200px; margin: 0 auto;">
                <!-- Formulaire simplifi  gauche -->
                <div class="form-container" style="flex: 0.8;">
                    <h2 class="form-title">Ajouter un Compte Gmail</h2>
                    <div style="margin-bottom: 1rem;">
                        <button type="button" onclick="showAllGmailPasswords()" class="btn" style="background: #f59e0b; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-key"></i> Voir tous les mots de passe
                        </button>
                    </div>
                    <form id="add-gmail-form">
                        <div class="form-group">
                            <label for="gmail-email">Email Gmail</label>
                            <input type="email" id="gmail-email" required placeholder="exemple@gmail.com" autofocus>
                        </div>
                        <div class="form-group">
                            <label for="gmail-password">Mot de passe</label>
                            <div style="position: relative;">
                                <input type="password" id="gmail-password" required placeholder="" style="padding-right: 40px;">
                                <button type="button" onclick="togglePasswordVisibility('gmail-password')" 
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                               background: none; border: none; cursor: pointer; color: #667eea;"
                                        title="Afficher/Masquer le mot de passe">
                                    <i class="fas fa-eye" id="gmail-password-toggle"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Ajouter Gmail
                        </button>
                    </form>
                </div>
                
                <!-- Liste des comptes Gmail  droite -->
                <div class="form-container" style="flex: 1.5; max-height: 600px; overflow-y: auto;">
                    <h2 class="form-title">
                        <i class="fas fa-envelope" style="color: #ea4335;"></i> Comptes Gmail
                    </h2>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.875rem; flex-wrap: wrap; align-items: center;">
                        <div id="gmail-stats" style="display: flex; gap: 1rem;">
                            <!-- Stats will be displayed here -->
                        </div>
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="show-banned-gmail" checked onchange="updateGmailAccountsDisplay()" style="cursor: pointer;">
                            <span>Afficher les bannis</span>
                        </label>
                        <button type="button" onclick="showAllGmailPasswords()" style="background: #f59e0b; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-key"></i> Voir tous les mots de passe
                        </button>
                    </div>
                    <div id="gmail-accounts-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Gmail accounts will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Twitter Unassigned Page -->
        <div id="twitter-unassigned-page" class="page">
            <div class="form-container" style="margin-bottom: 2rem;">
                <h2 class="form-title">Comptes Twitter sans Gmail</h2>
                <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; color: #92400e;">
                        <i class="fas fa-info-circle"></i> Ces comptes Twitter n'ont pas de Gmail assign. 
                        Assignez un Gmail pour faciliter la gestion.
                    </p>
                </div>
            </div>
            
            <div id="twitter-unassigned-list" style="display: grid; gap: 1rem;">
                <!-- Twitter accounts without Gmail will be displayed here -->
            </div>
        </div>
        
        <!-- Add Creator Page -->
        <div id="add-creator-page" class="page">
            <!-- Hero Header with Gradient -->
            <div style="padding: 2rem; border-radius: 1.5rem; margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50%; right: -10%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 70%); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 1.25rem;">
                        <div style="width: 64px; height: 64px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);">
                            <i class="fas fa-user-friends" style="font-size: 2rem; color: white;"></i>
                        </div>
                        <div>
                            <h2 style="font-size: 2rem; margin: 0; font-weight: 700; color: white;">Gestion des Cratrices</h2>
                            <p style="font-size: 1rem; margin: 0.5rem 0 0 0; color: rgba(255, 255, 255, 0.9);">Ajouter et grer vos cratrices de contenu</p>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 2rem; max-width: 1400px; margin: 0 auto;">
                <!-- Formulaire  gauche avec glassmorphism -->
                <div style="flex: 1; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);">
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-plus" style="color: white; font-size: 1rem;"></i>
                            </div>
                            Ajouter une Cratrice
                        </h3>
                    </div>
                    <form id="add-creator-form">
                        <div class="form-group">
                            <label for="creator-name" style="font-weight: 600; margin-bottom: 0.75rem; display: block; color: #334155;">Nom de la cratrice</label>
                            <input type="text" id="creator-name" required placeholder="Ex: Justine" autofocus style="width: 100%; padding: 1rem; border: 2px solid #e2e8f0; border-radius: 0.75rem; font-size: 1rem; transition: all 0.3s; background: white;" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102, 126, 234, 0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                        </div>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label style="font-weight: 600; margin-bottom: 0.75rem; display: block; color: #334155;">Photo de profil</label>
                            <div id="creator-photo-preview" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 3px solid #667eea; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);">
                                <i class="fas fa-camera" style="font-size: 2rem; color: #94a3b8;"></i>
                            </div>
                            <input type="file" id="creator-photo" accept="image/*" style="display: none;" onchange="previewCreatorPhoto(this)">
                            <button type="button" onclick="document.getElementById('creator-photo').click()" style="width: 100%; padding: 0.75rem; background: white; border: 2px dashed #667eea; border-radius: 0.75rem; color: #667eea; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.1)'" onmouseout="this.style.background='white'">
                                <i class="fas fa-upload" style="margin-right: 0.5rem;"></i> Choisir une photo
                            </button>
                        </div>
                        <button type="submit" style="width: 100%; margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.75rem; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); display: flex; align-items: center; justify-content: center; gap: 0.625rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                            <i class="fas fa-plus-circle"></i> Ajouter Cratrice
                        </button>
                    </form>
                </div>

                <!-- Liste des cratrices  droite avec design moderne -->
                <div style="flex: 2; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 1.5rem; padding: 2rem; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); max-height: 700px; overflow-y: auto;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-users" style="color: #667eea;"></i>
                            Toutes les Cratrices
                        </h3>
                        <span id="total-creators-count" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1.25rem; border-radius: 1.25rem; font-weight: 600; font-size: 0.875rem; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                            <!-- Total sera affich ici -->
                        </span>
                    </div>
                    <div id="all-creators-table">
                        <!-- Le tableau sera gnr ici -->
                    </div>
                </div>
            </div>

            <style>
                /* Dark mode support for creator page */
                body.dark-mode #add-creator-page > div:first-child {
                    background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 100%);
                }

                body.dark-mode #add-creator-page .form-group input {
                    background: rgba(30, 41, 59, 0.8);
                    border-color: rgba(148, 163, 184, 0.3);
                    color: #e2e8f0;
                }

                body.dark-mode #add-creator-page .form-group label {
                    color: #cbd5e1;
                }
            </style>
        </div>

        <!-- Add Account Page -->
        <div id="add-account-page" class="page">
            <div style="display: flex; gap: 2rem; max-width: 1200px; margin: 0 auto;">
                <!-- Formulaire  gauche -->
                <div class="form-container" style="flex: 1;">
                    <h2 class="form-title">Ajouter un Compte Social</h2>

                    <!-- Slecteur de type de compte -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                        <button type="button" class="platform-btn active" data-platform="twitter" onclick="switchPlatform('twitter')" style="flex: 1; padding: 0.75rem; background: #1DA1F2; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            <i class="fab fa-twitter"></i> Twitter
                        </button>
                        <button type="button" class="platform-btn" data-platform="instagram" onclick="switchPlatform('instagram')" style="flex: 1; padding: 0.75rem; background: #E4E7EB; color: #4B5563; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            <i class="fab fa-instagram"></i> Instagram
                        </button>
                    </div>

                    <form id="add-account-form">
                        <!-- Twitter Fields -->
                        <div id="twitter-fields" class="platform-fields">
                            <div class="form-group">
                                <label for="twitter-username">Username Twitter</label>
                                <input type="text" id="twitter-username" placeholder="@username" autofocus>
                            </div>
                            <div class="form-group">
                                <label for="twitter-password">Mot de passe Twitter</label>
                                <div style="position: relative;">
                                    <input type="password" id="twitter-password" placeholder="" style="padding-right: 40px;">
                                    <button type="button" onclick="togglePasswordVisibility('twitter-password')"
                                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                                                   background: none; border: none; cursor: pointer; color: #667eea;"
                                            title="Afficher/Masquer le mot de passe">
                                        <i class="fas fa-eye" id="twitter-password-toggle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Instagram Fields -->
                        <div id="instagram-fields" class="platform-fields" style="display: none;">
                            <div class="form-group">
                                <label for="instagram-username">Username Instagram</label>
                                <input type="text" id="instagram-username" placeholder="@username">
                            </div>
                            <div class="form-group">
                                <label for="instagram-password">Mot de passe Instagram</label>
                                <div style="position: relative;">
                                    <input type="password" id="instagram-password" placeholder="" style="padding-right: 40px;">
                                    <button type="button" onclick="togglePasswordVisibility('instagram-password')"
                                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                                                   background: none; border: none; cursor: pointer; color: #667eea;"
                                            title="Afficher/Masquer le mot de passe">
                                        <i class="fas fa-eye" id="instagram-password-toggle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Common Fields -->
                        <div class="form-group">
                            <label for="account-creator">Cratrice</label>
                            <select id="account-creator" class="form-control" required onchange="onCreatorChange()">
                                <option value="">Slectionner une cratrice</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-gmail">Compte Gmail</label>
                            <select id="account-gmail" class="form-control" required>
                                <option value="">Slectionner un compte Gmail</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-va">Virtual Assistant</label>
                            <select id="account-va" class="form-control" required>
                                <option value="">Slectionner un VA</option>
                            </select>
                            <div id="va-warning" class="va-warning" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>ATTENTION:</strong> Cette cratrice est sur plusieurs VAs. Vous DEVEZ choisir le VA pour ce compte.
                            </div>
                        </div>
                        <button type="submit" class="submit-btn" id="add-account-btn">
                            <i class="fas fa-plus"></i> Ajouter Compte Twitter
                        </button>
                    </form>
                </div>
                
                <!-- Liste des comptes sociaux  droite -->
                <div class="form-container" style="flex: 1.5; max-height: 600px; overflow-y: auto;">
                    <h2 class="form-title" id="accounts-list-title">
                        <i class="fab fa-twitter" style="color: #1da1f2;"></i> Comptes Twitter Existants
                    </h2>
                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" id="show-twitter-passwords-btn" onclick="showAllTwitterPasswords()" style="background: #1da1f2; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-key"></i> Voir tous les mots de passe Twitter
                        </button>
                        <button type="button" id="show-instagram-passwords-btn" onclick="showAllInstagramPasswords()" style="display: none; background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-key"></i> Voir tous les mots de passe Instagram
                        </button>
                    </div>
                    <div id="twitter-accounts-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- La liste Twitter sera gnre dynamiquement ici -->
                    </div>
                    <div id="instagram-accounts-list" style="display: none; flex-direction: column; gap: 0.75rem;">
                        <!-- La liste Instagram sera gnre dynamiquement ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Page -->
        <div id="import-page" class="page">
            <div class="form-container">
                <h2 class="form-title">Import CSV</h2>
                <div class="import-area" id="import-area">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                    <p>Glissez votre fichier CSV ici ou</p>
                    <input type="file" id="csv-file" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('csv-file').click()" class="submit-btn" style="width: auto; padding: 0.75rem 2rem;">
                        <i class="fas fa-folder-open"></i> Choisir un fichier
                    </button>
                </div>
                <div style="margin-top: 2rem;">
                    <h3>Format requis :</h3>
                    <code style="background: #f1f5f9; padding: 1rem; display: block; border-radius: 0.5rem; margin-top: 0.5rem;">
                        Prnom VA, Cratrice, @Twitter, Email, Mot de passe
                    </code>
                    <p style="margin-top: 1rem; color: #64748b;">Exemple :</p>
                    <code style="background: #f1f5f9; padding: 1rem; display: block; border-radius: 0.5rem; margin-top: 0.5rem;">
                        Hugo, Justine, @justine_pro, justine@email.com, pass123<br>
                        Hugo, Justine, @justine_backup, justine2@email.com, pass456<br>
                        Hugo, Laura, @laura_main, laura@email.com, pass789
                    </code>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div class="page" id="admin-page" style="display: none;">
            <!-- Hero Header with Glassmorphism -->
            <div class="admin-hero-header" style="padding: 3rem; border-radius: 2rem; margin-bottom: 2rem; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50%; right: -10%; width: 500px; height: 500px; background: radial-gradient(circle, rgba(239, 68, 68, 0.15) 0%, transparent 70%); border-radius: 50%;"></div>
                <div style="position: absolute; bottom: -30%; left: -5%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1rem;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);">
                            <i class="fas fa-shield-alt" style="font-size: 2.5rem; color: white;"></i>
                        </div>
                        <div>
                            <h2 class="admin-hero-title" style="font-size: 2.5rem; margin: 0; font-weight: 800;">Panneau Admin</h2>
                            <p class="admin-hero-subtitle" style="font-size: 1.1rem; margin: 0.5rem 0 0 0;">Contrle total de votre organisation</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards with Modern Design -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Members Card -->
                <div class="admin-stat-card" style="border-radius: 1.5rem; padding: 2rem; position: relative; overflow: hidden; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div style="position: absolute; top: -20px; right: -20px; width: 120px; height: 120px; background: linear-gradient(135deg, #3b82f6, #2563eb); opacity: 0.1; border-radius: 50%;"></div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);">
                            <i class="fas fa-users" style="font-size: 1.5rem; color: white;"></i>
                        </div>
                    </div>
                    <div class="admin-stat-label" style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600;">Membres</div>
                    <div class="admin-stat-value" style="font-size: 2.75rem; font-weight: 800; line-height: 1;" id="admin-total-members">0</div>
                    <div class="admin-stat-footer" style="margin-top: 1rem; padding-top: 1rem; color: #3b82f6; font-size: 0.875rem; font-weight: 600;">
                        <i class="fas fa-arrow-up"></i> quipe active
                    </div>
                </div>

                <!-- VAs Card -->
                <div class="admin-stat-card" style="border-radius: 1.5rem; padding: 2rem; position: relative; overflow: hidden; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div style="position: absolute; top: -20px; right: -20px; width: 120px; height: 120px; background: linear-gradient(135deg, #10b981, #059669); opacity: 0.1; border-radius: 50%;"></div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);">
                            <i class="fas fa-user-tie" style="font-size: 1.5rem; color: white;"></i>
                        </div>
                    </div>
                    <div class="admin-stat-label" style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600;">VAs</div>
                    <div class="admin-stat-value" style="font-size: 2.75rem; font-weight: 800; line-height: 1;" id="admin-vas-count">0</div>
                    <div class="admin-stat-footer" style="margin-top: 1rem; padding-top: 1rem; color: #10b981; font-size: 0.875rem; font-weight: 600;">
                        <i class="fas fa-check-circle"></i> Actives
                    </div>
                </div>

                <!-- Creators Card -->
                <div class="admin-stat-card" style="border-radius: 1.5rem; padding: 2rem; position: relative; overflow: hidden; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div style="position: absolute; top: -20px; right: -20px; width: 120px; height: 120px; background: linear-gradient(135deg, #f59e0b, #d97706); opacity: 0.1; border-radius: 50%;"></div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(245, 158, 11, 0.3);">
                            <i class="fas fa-star" style="font-size: 1.5rem; color: white;"></i>
                        </div>
                    </div>
                    <div class="admin-stat-label" style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600;">Cratrices</div>
                    <div class="admin-stat-value" style="font-size: 2.75rem; font-weight: 800; line-height: 1;" id="admin-creators-count">0</div>
                    <div class="admin-stat-footer" style="margin-top: 1rem; padding-top: 1rem; color: #f59e0b; font-size: 0.875rem; font-weight: 600;">
                        <i class="fas fa-fire"></i> En ligne
                    </div>
                </div>

                <!-- Social Accounts Card -->
                <div class="admin-stat-card" style="border-radius: 1.5rem; padding: 2rem; position: relative; overflow: hidden; transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div style="position: absolute; top: -20px; right: -20px; width: 120px; height: 120px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); opacity: 0.1; border-radius: 50%;"></div>
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 1rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(139, 92, 246, 0.3);">
                            <i class="fab fa-twitter" style="font-size: 1.5rem; color: white;"></i>
                        </div>
                    </div>
                    <div class="admin-stat-label" style="font-size: 0.875rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; font-weight: 600;">Comptes</div>
                    <div class="admin-stat-value" style="font-size: 2.75rem; font-weight: 800; line-height: 1;" id="admin-social-accounts">0</div>
                    <div class="admin-stat-footer" style="margin-top: 1rem; padding-top: 1rem; color: #8b5cf6; font-size: 0.875rem; font-weight: 600;">
                        <i class="fas fa-link"></i> Connects
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid rgba(148, 163, 184, 0.2);">
                <button id="admin-tab-team" onclick="switchAdminTab('team')" style="padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.75rem 0.75rem 0 0; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s; box-shadow: 0 -2px 10px rgba(102, 126, 234, 0.3);">
                    <i class="fas fa-users"></i> Mon quipe
                </button>
                <button id="admin-tab-all" onclick="switchAdminTab('all')" style="padding: 1rem 2rem; background: rgba(148, 163, 184, 0.1); color: #64748b; border: none; border-radius: 0.75rem 0.75rem 0 0; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.3s;">
                    <i class="fas fa-globe"></i> Tous les Utilisateurs
                </button>
            </div>

            <!-- Team Members Section -->
            <div id="admin-team-section" class="admin-tab-content">
                <div class="admin-members-section" style="border-radius: 1.5rem; padding: 2rem; margin-bottom: 2rem;">
                    <div class="admin-members-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1.5rem;">
                        <div>
                            <h3 class="admin-section-title" style="margin: 0; font-size: 1.75rem; font-weight: 700;">Membres de l'quipe</h3>
                            <p class="admin-section-subtitle" style="margin: 0.5rem 0 0 0; font-size: 0.95rem;" id="admin-member-count-header">Chargement...</p>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button onclick="showAllMemberEmails()" style="padding: 0.875rem 1.75rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(59, 130, 246, 0.3)'">
                                <i class="fas fa-envelope"></i> Voir emails
                            </button>
                            <button onclick="showAddMemberModal()" style="padding: 0.875rem 1.75rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s; box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(16, 185, 129, 0.3)'">
                                <i class="fas fa-user-plus"></i> Inviter
                            </button>
                        </div>
                    </div>
                    <div id="admin-members-table" style="overflow-x: auto;">
                        <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2.5rem; margin-bottom: 1rem;"></i>
                            <p>Chargement des membres...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Platform Users Section -->
            <div id="admin-all-section" class="admin-tab-content" style="display: none;">
                <div class="admin-all-users-section" style="border-radius: 1.5rem; padding: 2rem; margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid rgba(148, 163, 184, 0.2);">
                        <div>
                            <h3 style="margin: 0; font-size: 1.75rem; font-weight: 700;">
                                <i class="fas fa-globe" style="color: #667eea;"></i> Tous les Utilisateurs de la Plateforme
                            </h3>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem; color: #64748b;" id="admin-all-users-count-header">Chargement...</p>
                        </div>
                        <button onclick="loadAllPlatformUsers()" style="padding: 0.875rem 1.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s; box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                    </div>
                    <div id="admin-all-users-table" style="overflow-x: auto;">
                        <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2.5rem; margin-bottom: 1rem;"></i>
                            <p>Chargement de tous les utilisateurs...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions with Pills Design -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
                <!-- Settings Actions -->
                <div class="admin-action-card admin-action-settings" style="border-radius: 1.5rem; padding: 2rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <h4 class="admin-action-title" style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700;">
                            <i class="fas fa-cog"></i> Paramtres
                        </h4>
                        <p class="admin-action-subtitle" style="margin: 0; font-size: 0.875rem; opacity: 0.8;">Configuration et scurit</p>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="showEditOrgModal()" class="admin-action-btn" style="width: 100%; padding: 1rem 1.25rem; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <i class="fas fa-edit" style="color: #ef4444;"></i>
                            Renommer l'organisation
                        </button>
                        <button onclick="showMemberActivityLog()" class="admin-action-btn" style="width: 100%; padding: 1rem 1.25rem; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <i class="fas fa-history" style="color: #3b82f6;"></i>
                            Journal d'activit
                        </button>
                        <button onclick="showDangerZone()" style="width: 100%; padding: 1rem 1.25rem; background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);" onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 6px 16px rgba(220, 38, 38, 0.4)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 12px rgba(220, 38, 38, 0.3)'">
                            <i class="fas fa-exclamation-triangle"></i>
                            Zone dangereuse
                        </button>
                    </div>
                </div>

                <!-- Data Actions -->
                <div class="admin-action-card admin-action-data" style="border-radius: 1.5rem; padding: 2rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <h4 class="admin-action-title" style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700;">
                            <i class="fas fa-database"></i> Donnes
                        </h4>
                        <p class="admin-action-subtitle" style="margin: 0; font-size: 0.875rem; opacity: 0.8;">Export et statistiques</p>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="exportAllData()" class="admin-action-btn" style="width: 100%; padding: 1rem 1.25rem; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <i class="fas fa-download" style="color: #8b5cf6;"></i>
                            Exporter toutes les donnes
                        </button>
                        <button onclick="showDataStats()" class="admin-action-btn" style="width: 100%; padding: 1rem 1.25rem; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <i class="fas fa-chart-pie" style="color: #8b5cf6;"></i>
                            Statistiques dtailles
                        </button>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="admin-action-card admin-action-links" style="border-radius: 1.5rem; padding: 2rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <h4 class="admin-action-title" style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700;">
                            <i class="fas fa-bolt"></i> Accs Rapide
                        </h4>
                        <p class="admin-action-subtitle" style="margin: 0; font-size: 0.875rem; opacity: 0.8;">Navigation rapide</p>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button onclick="navigateToPage('team-management')" class="admin-action-btn" style="width: 100%; padding: 1rem 1.25rem; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <i class="fas fa-users" style="color: #10b981;"></i>
                            Page quipe
                        </button>
                        <button onclick="navigateToPage('dashboard')" class="admin-action-btn" style="width: 100%; padding: 1rem 1.25rem; border: none; border-radius: 0.75rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.75rem; font-weight: 600;" onmouseover="this.style.transform='translateX(5px)'" onmouseout="this.style.transform='translateX(0)'">
                            <i class="fas fa-chart-line" style="color: #10b981;"></i>
                            Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instagram Warm-up Page -->
        <div id="instagram-warmup-page" class="page" style="display: none;">
            <div style="max-width: 1400px; margin: 0 auto; padding: 1.5rem;">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h1 style="font-size: 2rem; margin: 0; display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-fire"></i>
                                Instagram Warm-up Tracker
                            </h1>
                            <p style="margin: 0.5rem 0 0 0; opacity: 0.95;">Suivez la progression du warm-up de vos comptes Instagram (6 jours)</p>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <select id="warmup-va-filter" onchange="filterWarmupByVA()"
                                    style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem 1rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 0.5rem; cursor: pointer; font-weight: 600; min-width: 200px;">
                                <option value="all"> Tous les VAs</option>
                            </select>
                            <button onclick="resetAllWarmups()" style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem 1.5rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-redo"></i> Rinitialiser
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Summary -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="background: #10b981; color: white;">
                        <div style="font-size: 2rem; font-weight: 700;" id="warmup-completed">0</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">Termins</div>
                    </div>
                    <div class="stat-card" style="background: #3b82f6; color: white;">
                        <div style="font-size: 2rem; font-weight: 700;" id="warmup-in-progress">0</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">En cours</div>
                    </div>
                    <div class="stat-card" style="background: #6b7280; color: white;">
                        <div style="font-size: 2rem; font-weight: 700;" id="warmup-not-started">0</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">Non dmarrs</div>
                    </div>
                    <div class="stat-card" style="background: #8b5cf6; color: white;">
                        <div style="font-size: 2rem; font-weight: 700;" id="warmup-total">0</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">Total comptes</div>
                    </div>
                </div>

                <!-- Warmup Cards Grid -->
                <div class="warmup-grid" id="warmup-accounts-list">
                    <!-- Cards will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="search-page" class="page">
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Rechercher par nom, cratrice, @username...">
            </div>
            <div id="search-results" class="search-results"></div>
        </div>

        <!-- Subs Tracking Page -->
        <div id="subs-tracking-page" class="page">
            <!-- Competition Header -->
            <div class="competition-header">
                <h1 class="competition-title"> Comptition des VAs</h1>
                <div class="competition-stats">
                    <div class="stat-box">
                        <span class="stat-value" id="total-subs-today">0</span>
                        <span class="stat-label">Subs Aujourd'hui</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-payment">0</span>
                        <span class="stat-label">Total Gnr</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-paid" style="color: #22c55e;">0</span>
                        <span class="stat-label">Dj Pay</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-remaining" style="color: #ef4444;">0</span>
                        <span class="stat-label">Reste  Payer</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="best-va-name">-</span>
                        <span class="stat-label">Meilleur VA</span>
                    </div>
                </div>
            </div>

            <!-- Period Tabs -->
            <div class="period-tabs" style="margin-bottom: 2rem;">
                <button class="period-tab active" data-period="today">Aujourd'hui</button>
                <button class="period-tab" data-period="week">Cette semaine</button>
                <button class="period-tab" data-period="month">Ce mois</button>
                <button class="period-tab" data-period="all">Tout</button>
            </div>

            <!-- Leaderboard and Quick Actions -->
            <div class="leaderboard-container">
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        <div class="leaderboard-title">
                            <i class="fas fa-trophy"></i>
                            Classement des VAs
                        </div>
                        <div class="period-display" id="period-display">Cette semaine</div>
                    </div>
                    <div id="leaderboard-content">
                        <!-- Leaderboard items will be inserted here -->
                    </div>
                </div>

                <div class="quick-actions">
                    <h3 style="margin-bottom: 1rem;">Actions rapides</h3>
                    <div class="action-grid">
                        <button onclick="openAddSubsModal()" class="quick-action-btn add-subs-quick">
                            <i class="fas fa-plus-circle"></i>
                            Ajouter des subs
                        </button>
                        <button onclick="showDetailedView()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-chart-line"></i>
                            Vue dtaille
                        </button>
                        <button onclick="exportSubsData()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-download"></i>
                            Exporter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Performance par VA</h3>
                    </div>
                    <div id="va-performance-chart">
                        <!-- Chart will be inserted here -->
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">volution des subs</h3>
                    </div>
                    <div id="subs-evolution-chart">
                        <!-- Chart will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-feed">
                <h3 style="margin-bottom: 1.5rem;">Activit rcente</h3>
                <div id="activity-list">
                    <!-- Activity items will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Revenue Tracking Page -->
        <div id="revenue-tracking-page" class="page">
            <!-- Revenue Competition Header -->
            <div class="competition-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h1 class="competition-title"> Battle des Revenus</h1>
                <div class="competition-stats">
                    <div class="stat-box">
                        <span class="stat-value" id="total-revenue-generated">0</span>
                        <span class="stat-label">Revenus Gnrs</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-commissions-due">0</span>
                        <span class="stat-label">Commissions Dues</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-commissions-paid">0</span>
                        <span class="stat-label">Dj Pay</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="commissions-to-pay">0</span>
                        <span class="stat-label">Reste  Payer</span>
                    </div>
                </div>
            </div>

            <!-- Revenue Tabs -->
            <div class="period-tabs" style="margin-bottom: 2rem;">
                <button class="period-tab active" data-revenue-period="current-week">Cette semaine</button>
                <button class="period-tab" data-revenue-period="last-week">Semaine dernire</button>
                <button class="period-tab" data-revenue-period="current-month">Ce mois</button>
                <button class="period-tab" data-revenue-period="all-time">Tout</button>
            </div>

            <!-- Revenue Leaderboard -->
            <div class="leaderboard-container">
                <div class="leaderboard">
                    <div class="leaderboard-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div class="leaderboard-title">
                            <i class="fas fa-money-bill-wave"></i>
                            TOP Gnrateurs de Revenus
                        </div>
                        <div id="revenue-period-display">Cette semaine</div>
                    </div>
                    <div id="revenue-leaderboard-content">
                        <!-- Revenue leaderboard items will be inserted here -->
                    </div>
                </div>

                <div class="quick-actions">
                    <h3 style="margin-bottom: 1rem;">Gestion des Commissions</h3>
                    <div class="action-grid">
                        <button onclick="openAddRevenueModal()" class="quick-action-btn" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                            <i class="fas fa-plus-circle"></i>
                            Ajouter Revenus
                        </button>
                        <button onclick="openPayCommissionModal()" class="quick-action-btn" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                            <i class="fas fa-hand-holding-usd"></i>
                            Payer Commission
                        </button>
                        <button onclick="viewAllRevenues()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-list"></i>
                            Tous les revenus
                        </button>
                        <button onclick="viewPaymentHistory()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-history"></i>
                            Historique paiements
                        </button>
                        <button onclick="exportFinancialData()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-file-excel"></i>
                            Export Excel
                        </button>
                    </div>

                    <!-- Commission Summary -->
                    <div class="commission-summary-card" style="margin-top: 2rem; padding: 1.5rem; border-radius: 0.5rem;">
                        <h4 style="margin-bottom: 1rem;">Rsum par VA</h4>
                        <div id="commission-summary">
                            <!-- Commission summary will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">volution des Revenus</h3>
                    </div>
                    <div id="revenue-evolution-chart">
                        <!-- Revenue chart will be inserted here -->
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Commissions par VA</h3>
                    </div>
                    <div id="commission-distribution-chart">
                        <!-- Commission chart will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div class="activity-feed" id="payment-history-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Historique des Paiements</h3>
                    <button onclick="hidePaymentHistory()" class="action-btn view-btn">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
                <div id="payment-history-list">
                    <!-- Payment history will be inserted here -->
                </div>
            </div>

            <!-- Revenue Management Section -->
            <div class="activity-feed" id="revenue-management-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 id="revenue-management-title">Gestion des Revenus</h3>
                    <button onclick="hideRevenueManagement()" class="action-btn view-btn">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
                <div class="table-wrapper" style="overflow-x: auto;">
                    <table class="subs-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Montant USD</th>
                                <th>Taux</th>
                                <th>Montant EUR</th>
                                <th>Commission</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="revenue-management-tbody">
                            <!-- Revenue entries will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Financial Overview Page -->
        <div id="financial-overview-page" class="page">
            <!-- Nouveau header minimaliste -->
            <div style="text-align: center; padding: 3rem 0 2rem;">
                <h1 style="font-size: 2.5rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Vue Financire Globale
                </h1>
                <p style="margin-top: 0.5rem; color: #64748b; font-size: 1.1rem;" id="financial-period-description">Aperu de vos finances cette semaine</p>
            </div>
            
            <!-- Quick Financial Snapshot - Plus visuel -->
            <div id="financial-snapshot" style="margin-bottom: 3rem;">
                <!-- Will be dynamically generated -->
            </div>

            <!-- Financial Period Selector -->
            <div class="period-tabs" style="margin-bottom: 2rem;">
                <button class="period-tab active" data-financial-period="current-week">Cette semaine</button>
                <button class="period-tab" data-financial-period="current-month">Ce mois</button>
                <button class="period-tab" data-financial-period="last-month">Mois dernier</button>
                <button class="period-tab" data-financial-period="all">Tout</button>
            </div>

            <!-- VA Performance Overview -->
            <div class="stats-section" style="border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 2rem;">
                <h2 style="margin-bottom: 2rem; font-size: 1.5rem; font-weight: 700;"> Performance Financire par VA</h2>
                <div id="va-financial-grid" style="display: grid; gap: 1.5rem;">
                    <!-- VA financial cards will be inserted here -->
                </div>
            </div>

            <!-- Revenue Breakdown Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Rpartition des Revenus</h3>
                    </div>
                    <div id="revenue-breakdown-chart" style="text-align: center; padding: 2rem;">
                        <!-- Pie chart representation will be here -->
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">volution Globale</h3>
                    </div>
                    <div id="global-evolution-chart">
                        <!-- Evolution chart will be here -->
                    </div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="charts-section" style="border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                <h3 style="margin-bottom: 1.5rem;"> Rsum Dtaill</h3>
                <div id="financial-summary-table">
                    <!-- Summary table will be inserted here -->
                </div>
                
                <h3 style="margin: 2rem 0 1.5rem;"> Historique des Paiements</h3>
                <div id="payment-history-table">
                    <!-- Payment history will be inserted here -->
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                    <button onclick="showPaymentModal()" class="submit-btn" style="width: auto; background: #22c55e;">
                        <i class="fas fa-money-check-alt"></i> Enregistrer un Paiement
                    </button>
                    <button onclick="exportCompleteFinancialReport()" class="submit-btn" style="width: auto;">
                        <i class="fas fa-file-excel"></i> Exporter Rapport Financier
                    </button>
                    <button onclick="migrateToFileSystem()" class="submit-btn" style="width: auto; background: #7c3aed;">
                        <i class="fas fa-database"></i> Migrer vers Fichiers
                    </button>
                </div>
            </div>
        </div>
        <!-- Followers Tracking Page -->
        <div id="followers-tracking-page" class="page">
            <!-- Hero Header -->
            <div class="ft-hero">
                <div class="ft-hero-bg"></div>
                <div class="ft-hero-content">
                    <div class="ft-hero-main">
                        <div class="ft-hero-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="ft-hero-text">
                            <h2>Suivi Followers</h2>
                            <p>Suivez la croissance de vos comptes Twitter</p>
                        </div>
                    </div>
                    <div class="ft-hero-actions">
                        <input type="date" id="followers-tracking-date" class="ft-date-input">
                        <button onclick="saveAllFollowersStats(event)" class="ft-save-btn">
                            <i class="fas fa-save"></i> <span>Enregistrer</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Summary Cards -->
            <div id="followers-summary-cards" class="ft-summary-cards">
                <!-- Will be populated by JS -->
            </div>

            <!-- Bulk Entry Form by Creator -->
            <div class="ft-bulk-section">
                <h3 class="ft-section-title">
                    <i class="fab fa-twitter"></i> Saisie rapide par cratrice
                </h3>
                <div id="followers-bulk-form" class="ft-bulk-form">
                    <!-- Will be populated by JS with creator groups -->
                    <div class="ft-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Chargement des comptes...</p>
                    </div>
                </div>

                <!-- Bouton Enregistrer tout -->
                <button onclick="saveAllFollowersStats(event)" id="save-followers-btn" class="ft-save-all-btn">
                    <i class="fas fa-save"></i>
                    Enregistrer tous les followers
                </button>
            </div>

            <!-- Growth Dashboard -->
            <div class="ft-dashboard-grid">
                <!-- Growth Chart -->
                <div class="ft-card">
                    <div class="ft-card-header">
                        <h3 class="ft-card-title">
                            <i class="fas fa-chart-line"></i> Croissance
                        </h3>
                        <div class="ft-period-btns">
                            <button onclick="updateFollowersChart(7)" class="followers-period-btn active" data-period="7">7j</button>
                            <button onclick="updateFollowersChart(30)" class="followers-period-btn" data-period="30">30j</button>
                            <button onclick="updateFollowersChart(90)" class="followers-period-btn" data-period="90">90j</button>
                        </div>
                    </div>
                    <div class="ft-chart-container">
                        <canvas id="followers-growth-chart"></canvas>
                    </div>
                </div>

                <!-- Top Performers -->
                <div class="ft-card">
                    <h3 class="ft-card-title">
                        <i class="fas fa-trophy"></i> Top Performers (hier)
                    </h3>
                    <div id="followers-top-performers" class="ft-top-performers">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Daily History Table -->
            <div class="ft-card ft-history-card">
                <h3 class="ft-card-title">
                    <i class="fas fa-history"></i> Historique par cratrice
                </h3>
                <div id="followers-history-table" class="ft-history-table">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>

        <!-- Twitter Account Detail Page -->
        <div class="page" id="twitter-account-detail-page" style="display: none;">
            <!-- Hero Header - will be updated by JS -->
            <div id="twitter-detail-header" style="background: linear-gradient(135deg, #1da1f2 0%, #0d8bd9 100%); border-radius: 1.5rem; padding: 2.5rem 2rem; margin-bottom: 2rem; position: relative; overflow: hidden;">
                <div style="position: absolute; top: -50px; right: -50px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <button onclick="navigateToPage('dashboard')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 0.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div style="flex: 1;">
                            <h2 id="twitter-detail-username" style="font-size: 2rem; margin: 0; color: white; font-weight: 800;">@compte</h2>
                            <p id="twitter-detail-creator" style="font-size: 1rem; margin: 0.25rem 0 0 0; color: rgba(255,255,255,0.9);">Cratrice</p>
                        </div>
                        <a id="twitter-detail-link" href="#" target="_blank" style="background: white; color: #1da1f2; border: none; padding: 0.75rem 1.25rem; border-radius: 0.75rem; font-weight: 700; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; text-decoration: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                            <i class="fab fa-twitter"></i> Voir sur Twitter
                        </a>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div id="twitter-detail-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <!-- Will be populated by JS -->
            </div>

            <!-- Main Chart -->
            <div style="background: var(--card-bg, white); border-radius: 1.5rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <h3 style="margin: 0; font-size: 1.25rem; display: flex; align-items: center; gap: 0.75rem; color: var(--text-color);">
                        <i class="fas fa-chart-area" style="color: #1da1f2;"></i> volution des Followers
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="updateTwitterDetailChart(7)" class="twitter-detail-period-btn active" data-period="7" style="padding: 0.625rem 1.25rem; border-radius: 0.75rem; border: none; background: #1da1f2; color: white; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">7 jours</button>
                        <button onclick="updateTwitterDetailChart(14)" class="twitter-detail-period-btn" data-period="14" style="padding: 0.625rem 1.25rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; background: var(--card-bg, white); color: var(--text-color); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">14 jours</button>
                        <button onclick="updateTwitterDetailChart(30)" class="twitter-detail-period-btn" data-period="30" style="padding: 0.625rem 1.25rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; background: var(--card-bg, white); color: var(--text-color); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">30 jours</button>
                        <button onclick="updateTwitterDetailChart(90)" class="twitter-detail-period-btn" data-period="90" style="padding: 0.625rem 1.25rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; background: var(--card-bg, white); color: var(--text-color); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">90 jours</button>
                        <button onclick="updateTwitterDetailChart(0)" class="twitter-detail-period-btn" data-period="0" style="padding: 0.625rem 1.25rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; background: var(--card-bg, white); color: var(--text-color); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Tout</button>
                    </div>
                </div>
                <div style="height: 400px; position: relative;">
                    <canvas id="twitter-detail-chart"></canvas>
                </div>
            </div>

            <!-- Growth Stats & History -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <!-- Daily Growth -->
                <div style="background: var(--card-bg, white); border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; font-size: 1.125rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-color);">
                        <i class="fas fa-calendar-day" style="color: #10b981;"></i> Croissance journalire
                    </h3>
                    <div id="twitter-detail-daily-growth" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 350px; overflow-y: auto;">
                        <!-- Will be populated by JS -->
                    </div>
                </div>

                <!-- Summary -->
                <div style="background: var(--card-bg, white); border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; font-size: 1.125rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-color);">
                        <i class="fas fa-chart-pie" style="color: #8b5cf6;"></i> Rsum
                    </h3>
                    <div id="twitter-detail-summary" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Management Page -->
        <div class="page" id="team-management-page" style="display: none;">
            <!-- Modern Hero Header -->
            <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 1.5rem; padding: 3rem 2.5rem; margin-bottom: 2rem; position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; right: 0; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); border-radius: 50%;"></div>
                <div style="position: relative; z-index: 1;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="width: 64px; height: 64px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-users-cog" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <h2 style="font-size: 2.5rem; margin: 0; color: white; font-weight: 700;">Gestion d'quipe</h2>
                            <p style="font-size: 1.125rem; margin: 0; color: rgba(255,255,255,0.9);">Collaborez avec votre quipe en temps rel</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="team-stats-grid animate-in" id="team-stats">
                <!-- Stats will be populated by JS -->
            </div>

            <div class="team-container">
                <!-- Organization Info Card - Span 6 columns -->
                <div class="card glass-card grid-span-6 animate-in" style="border-radius: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);">
                            <i class="fas fa-building" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-color);">Mon Organisation</h3>
                            <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Informations de l'quipe</p>
                        </div>
                    </div>
                    <div id="org-info" style="display: grid; gap: 1.25rem;">
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--hover-bg); border-radius: 0.75rem; border: 1px solid var(--border-color);">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-tag" style="color: white; font-size: 1rem;"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Nom de l'organisation</div>
                                <div style="font-size: 1.125rem; font-weight: 600; color: var(--text-color); overflow: hidden; text-overflow: ellipsis;" id="org-name"></div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--hover-bg); border-radius: 0.75rem; border: 1px solid var(--border-color);">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-crown" style="color: white; font-size: 1rem;"></i>
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">Propritaire</div>
                                <div style="font-size: 1.125rem; font-weight: 600; color: var(--text-color); overflow: hidden; text-overflow: ellipsis;" id="org-owner"></div>
                            </div>
                        </div>
                        <button onclick="showEditOrgModal()" style="width: 100%; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; padding: 1rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.625rem; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.2)'">
                            <i class="fas fa-edit"></i> Renommer l'organisation
                        </button>

                        <!-- Create New Agency Button (Owner only) -->
                        <button id="create-agency-btn" onclick="showCreateOrganizationModal()" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 1rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: none; align-items: center; justify-content: center; gap: 0.625rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.2)'">
                            <i class="fas fa-plus-circle"></i> Crer une nouvelle agence
                        </button>
                    </div>
                </div>

                <!-- Invite Member Card - Span 6 columns -->
                <div class="card grid-span-6 animate-in" style="border-radius: 1.5rem; animation-delay: 0.1s;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);">
                            <i class="fas fa-user-plus" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-color);">Inviter un membre</h3>
                            <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Partagez ce code d'invitation</p>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); padding: 1.5rem; border-radius: 1rem; margin-bottom: 1.5rem; border: 2px dashed #6366f1;">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #6366f1; font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-key"></i> CODE D'INVITATION
                            </div>
                            <div id="invitation-code-display" style="background: white; padding: 1.25rem; border-radius: 0.75rem; font-family: 'Courier New', monospace; font-size: 1rem; font-weight: 600; color: #6366f1; word-break: break-all; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1); border: 1px solid #e0e7ff;">
                                Chargement...
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.625rem; align-items: center; padding: 0.875rem; background: rgba(99, 102, 241, 0.08); border-radius: 0.625rem;">
                            <i class="fas fa-info-circle" style="color: #6366f1; flex-shrink: 0;"></i>
                            <span style="font-size: 0.8125rem; color: #475569; line-height: 1.5;">Ce code permet  vos collaborateurs de rejoindre votre organisation</span>
                        </div>
                    </div>
                    <button onclick="copyInvitationCode()" style="width: 100%; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; padding: 1rem; border-radius: 0.75rem; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); display: flex; align-items: center; justify-content: center; gap: 0.625rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(99, 102, 241, 0.2)'">
                        <i class="fas fa-copy"></i> Copier le code d'invitation
                    </button>
                </div>

                <!-- Accept Invitation Card - Span 12 columns -->
                <div class="card grid-span-12 animate-in" style="border-radius: 1.5rem; animation-delay: 0.2s;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                            <i class="fas fa-ticket-alt" style="font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-color);">Rejoindre une quipe</h3>
                            <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Utilisez un code d'invitation pour rejoindre une organisation</p>
                        </div>
                    </div>
                    <form onsubmit="acceptInvitationCode(event)" style="display: grid; grid-template-columns: 1fr auto; gap: 1rem;">
                        <input type="text" id="invitation-code-input" placeholder="Collez le code d'invitation ici..." required style="width: 100%; padding: 1rem 1.25rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem; transition: all 0.3s; font-family: 'Courier New', monospace; background: var(--hover-bg);" onfocus="this.style.borderColor='#8b5cf6'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                        <button type="submit" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2); display: flex; align-items: center; justify-content: center; gap: 0.625rem; white-space: nowrap;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.2)'">
                            <i class="fas fa-check-circle"></i> Rejoindre
                        </button>
                    </form>
                </div>

                <!-- Team Members List - Span 12 columns -->
                <div class="card grid-span-12 animate-in" style="border-radius: 1.5rem; animation-delay: 0.3s;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                <i class="fas fa-users" style="font-size: 1.5rem;"></i>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-color);">Membres de l'quipe</h3>
                                <p style="margin: 0; color: #64748b; font-size: 0.875rem;">Grez les accs de votre organisation</p>
                            </div>
                        </div>
                        <div id="team-member-count" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem;">
                            0 membres
                        </div>
                    </div>
                    <div id="members-list" style="display: grid; gap: 1rem;">
                        <!-- Will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit Twitter Account Modal -->
    <div id="edit-account-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le compte Twitter</h2>
                <button class="close-btn" onclick="closeEditModal()"></button>
            </div>
            <form id="edit-account-form" onsubmit="updateAccount(event)">
                <input type="hidden" id="edit-account-va-id">
                <input type="hidden" id="edit-account-creator-id">
                <input type="hidden" id="edit-account-index">
                
                <div class="form-group">
                    <label for="edit-gmail-select">Compte Gmail associ (optionnel)</label>
                    <select id="edit-gmail-select">
                        <option value="">-- Aucun compte Gmail --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-username">Username Twitter</label>
                    <input type="text" id="edit-username" class="form-control" required placeholder="@username">
                </div>
                
                <div class="form-group" id="edit-manual-email-group" style="display: none;">
                    <label for="edit-email">Email (si pas de Gmail slectionn)</label>
                    <input type="email" id="edit-email" class="form-control" placeholder="email@example.com">
                </div>
                
                <div class="form-group">
                    <label for="edit-password">Mot de passe</label>
                    <div style="position: relative;">
                        <input type="password" id="edit-password" class="form-control" placeholder="" style="padding-right: 40px;">
                        <button type="button" onclick="togglePasswordVisibility('edit-password')" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; cursor: pointer; color: #667eea;"
                                title="Afficher/Masquer le mot de passe">
                            <i class="fas fa-eye" id="edit-password-toggle"></i>
                        </button>
                    </div>
                    <small style="color: #718096;">Laissez vide pour conserver le mot de passe actuel</small>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="success-message">
        <i class="fas fa-check-circle"></i>
        <span id="success-text"></span>
    </div>
    
    <!-- Error Message -->
    <div id="error-message" class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        <span id="error-text"></span>
    </div>
    
    <!-- Assign Gmail Modal -->
    <div id="assign-gmail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assigner le compte Gmail</h2>
                <button class="close-btn" onclick="closeAssignGmailModal()"></button>
            </div>
            <form id="assign-gmail-form" onsubmit="assignGmailToVA(event)">
                <input type="hidden" id="assign-gmail-id">
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                    <p style="margin: 0;">Compte Gmail : <strong id="assign-gmail-email"></strong></p>
                </div>
                <div class="form-group">
                    <label for="assign-gmail-va-select">Choisir le VA</label>
                    <select id="assign-gmail-va-select" class="form-control" required>
                        <option value="">-- Choisir un VA --</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-check"></i> Assigner
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeAssignGmailModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Assign Gmail to Twitter Modal -->
    <div id="assign-gmail-twitter-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assigner un Gmail au compte Twitter</h2>
                <button class="close-btn" onclick="closeAssignGmailTwitterModal()"></button>
            </div>
            <form id="assign-gmail-twitter-form" onsubmit="assignGmailToTwitter(event)">
                <input type="hidden" id="assign-twitter-va-id">
                <input type="hidden" id="assign-twitter-creator-id">
                <input type="hidden" id="assign-twitter-username">
                <div style="margin-bottom: 1rem; padding: 1rem; background: #e0f2fe; border-radius: 0.5rem;">
                    <p style="margin: 0;">Compte Twitter : <strong id="assign-twitter-display"></strong></p>
                </div>
                <div class="form-group">
                    <label for="assign-twitter-gmail-select">Choisir un compte Gmail disponible</label>
                    <select id="assign-twitter-gmail-select" class="form-control" required>
                        <option value="">-- Choisir un Gmail --</option>
                    </select>
                    <small style="color: #718096; display: block; margin-top: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Le Gmail sera automatiquement assign au mme VA que le compte Twitter.
                    </small>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-check"></i> Assigner
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeAssignGmailTwitterModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Update Followers Modal -->
    <div id="update-followers-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mettre  jour les Followers</h2>
                <button class="close-btn" onclick="closeUpdateFollowersModal()"></button>
            </div>
            <form id="update-followers-form" onsubmit="saveFollowersUpdate(event)">
                <input type="hidden" id="followers-username">
                
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <h3 id="followers-account-display" style="color: #1DA1F2; margin: 0;">
                        <i class="fab fa-twitter"></i> @username
                    </h3>
                    <div id="followers-history" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                        <!-- L'historique sera affich ici -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="followers-count">Nombre de Followers</label>
                    <input type="number" id="followers-count" class="form-control" required 
                           placeholder="Ex: 25000" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label for="followers-date">Date de la mise  jour</label>
                    <input type="date" id="followers-date" class="form-control" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn cancel-btn" onclick="closeUpdateFollowersModal()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn submit-btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
            
            <!-- Graphique d'volution -->
            <div id="followers-chart-container" style="margin-top: 2rem; display: none;">
                <h4 style="margin-bottom: 1rem;">volution des Followers</h4>
                <canvas id="followers-chart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Edit Gmail Account Modal -->
    <div id="edit-gmail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le compte Gmail</h2>
                <button class="close-btn" onclick="closeEditGmailModal()"></button>
            </div>
            <form id="edit-gmail-form" onsubmit="saveEditedGmail(event)">
                <input type="hidden" id="edit-gmail-id">
                
                <div class="form-group">
                    <label for="edit-gmail-email">Email Gmail</label>
                    <input type="email" id="edit-gmail-email" class="form-control" required placeholder="example@gmail.com">
                </div>
                
                <div class="form-group">
                    <label for="edit-gmail-password">Mot de passe</label>
                    <div style="position: relative;">
                        <input type="password" id="edit-gmail-password" class="form-control" required style="padding-right: 2.5rem;">
                        <button type="button" onclick="toggleEditPasswordVisibility()" 
                                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; cursor: pointer; color: #6b7280; 
                                       padding: 0.5rem; font-size: 1rem; transition: color 0.2s ease;"
                                onmouseover="this.style.color='#3b82f6'"
                                onmouseout="this.style.color='#6b7280'">
                            <i id="edit-password-toggle-icon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn cancel-btn" onclick="closeEditGmailModal()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn submit-btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reassign Twitter Account Modal -->
    <div id="reassign-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Rassigner le compte Twitter</h2>
                <button class="close-btn" onclick="closeModal()"></button>
            </div>
            <form id="reassign-form" onsubmit="reassignTwitterAccount(event)">
                <input type="hidden" id="reassign-account-id">
                
                <div class="form-group">
                    <label>Compte Twitter</label>
                    <input type="text" id="reassign-username" class="form-control" readonly style="background: #f3f4f6;">
                </div>
                
                <div class="form-group">
                    <label for="reassign-creator">Cratrice</label>
                    <select id="reassign-creator" class="form-control" required>
                        <option value="">Slectionner une cratrice</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reassign-gmail">Compte Gmail</label>
                    <select id="reassign-gmail" class="form-control" required>
                        <option value="">Slectionner un compte Gmail</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reassign-va">Virtual Assistant</label>
                    <select id="reassign-va" class="form-control" required>
                        <option value="">Slectionner un VA</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-btn">
                    <i class="fas fa-check"></i> Rassigner
                </button>
            </form>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h3>Dtails du compte</h3>
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- Add Subs Modal -->
    <div id="add-subs-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddSubsModal()">&times;</span>
            <h3>Ajouter des subs</h3>
            <form id="add-subs-form">
                <div class="form-group">
                    <label for="subs-va-select">Slectionner le VA</label>
                    <select id="subs-va-select" required>
                        <option value="">-- Choisir un VA --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subs-date">Date</label>
                    <input type="date" id="subs-date" required value="">
                </div>
                <div class="form-group">
                    <label for="subs-count">Nombre de subs</label>
                    <input type="number" id="subs-count" min="1" required placeholder="Ex: 10">
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </form>
        </div>
    </div>

    <!-- Add Revenue Modal -->
    <div id="add-revenue-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddRevenueModal()">&times;</span>
            <h3>Ajouter des Revenus</h3>
            <form id="add-revenue-form">
                <div class="form-group">
                    <label for="revenue-va-select">Slectionner le VA</label>
                    <select id="revenue-va-select" required>
                        <option value="">-- Choisir un VA --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="revenue-date">Date</label>
                    <input type="date" id="revenue-date" required>
                </div>
                <div class="form-group">
                    <label for="revenue-amount">Montant des ventes ($)</label>
                    <input type="number" id="revenue-amount" min="0" step="0.01" required placeholder="Ex: 150.00">
                </div>
                <div class="form-group">
                    <label>Taux de change en temps rel</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="exchange-rate-display" style="font-size: 1.25rem; font-weight: 600; color: #667eea;">1$ = 0.92</span>
                        <button type="button" onclick="updateExchangeRate()" class="action-btn view-btn" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-sync"></i> Actualiser
                        </button>
                    </div>
                    <small id="rate-update-time" style="color: #64748b;">Chargement...</small>
                    <input type="hidden" id="exchange-rate" value="0.92">
                </div>
                <div class="form-group">
                    <label for="tracking-link">Lien de tracking (optionnel)</label>
                    <input type="text" id="tracking-link" placeholder="Ex: track123">
                </div>
                <div class="form-group">
                    <label for="revenue-description">Description</label>
                    <input type="text" id="revenue-description" placeholder="Ex: Ventes OnlyFans semaine 1">
                </div>
                <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                    <p><strong>Montant en EUR:</strong> <span id="amount-in-eur">0.00</span></p>
                    <p><strong>Commission calcule:</strong> <span id="calculated-commission">0.00</span> (5%)</p>
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </form>
        </div>
    </div>

    <!-- Pay Commission Modal -->
    <div id="pay-commission-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePayCommissionModal()">&times;</span>
            <h3>Payer une Commission</h3>
            <form id="pay-commission-form">
                <div class="form-group">
                    <label for="payment-va-select">Slectionner le VA</label>
                    <select id="payment-va-select" required>
                        <option value="">-- Choisir un VA --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-date">Date du paiement</label>
                    <input type="date" id="payment-date" required>
                </div>
                <div class="form-group">
                    <label for="payment-amount">Montant pay ()</label>
                    <input type="number" id="payment-amount" min="0" step="0.01" required placeholder="Ex: 50.00">
                </div>
                <div class="form-group">
                    <label for="payment-period">Priode couverte</label>
                    <input type="text" id="payment-period" required placeholder="Ex: Semaine 1-7 Janvier">
                </div>
                <div id="va-outstanding-info" style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; display: none;">
                    <p><strong>Commissions dues pour ce VA:</strong> <span id="outstanding-amount">0.00</span></p>
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-check-circle"></i> Confirmer le paiement
                </button>
            </form>
        </div>
    </div>

    <!-- Create Organization Modal -->
    <div id="create-organization-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-building"></i> Crer une nouvelle agence</h2>
                <button class="close-btn" onclick="closeCreateOrganizationModal()"></button>
            </div>
            <form id="create-organization-form" onsubmit="handleCreateOrganization(event)">
                <div class="form-group">
                    <label for="new-org-name">Nom de l'agence *</label>
                    <input type="text" id="new-org-name" class="form-control" placeholder="Ex: Agence Paris" required>
                    <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                        Choisissez un nom unique pour identifier votre agence
                    </small>
                </div>

                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #3b82f6; border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem;">
                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                        <i class="fas fa-info-circle" style="color: #3b82f6; font-size: 1.25rem; margin-top: 0.125rem;"></i>
                        <div>
                            <h4 style="margin: 0 0 0.5rem 0; font-weight: 700; color: #1e40af;">Qu'est-ce qu'une agence ?</h4>
                            <p style="margin: 0; color: #1e3a8a; font-size: 0.875rem; line-height: 1.6;">
                                Une agence est un <strong>espace isol</strong> avec ses propres VAs, cratrices et comptes. Idal pour grer plusieurs business sparment.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer" style="margin-top: 1.5rem;">
                    <button type="button" class="btn" onclick="closeCreateOrganizationModal()" style="background: #e5e7eb; color: #374151;">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn submit-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-plus-circle"></i> Crer l'agence
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Twitter Account Modal -->
    <div id="edit-twitter-account-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fab fa-twitter" style="color: #1da1f2;"></i> Modifier le compte Twitter</h2>
                <button class="close-btn" onclick="closeEditTwitterAccountModal()"></button>
            </div>
            <form id="edit-twitter-account-form" onsubmit="handleEditTwitterAccount(event)">
                <input type="hidden" id="edit-twitter-account-id">
                <input type="hidden" id="edit-twitter-creator-id">
                <input type="hidden" id="edit-twitter-old-username">

                <div class="form-group">
                    <label for="edit-twitter-username">Nom d'utilisateur Twitter *</label>
                    <div style="position: relative;">
                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #1da1f2; font-weight: 600;">@</span>
                        <input type="text" id="edit-twitter-username" class="form-control" style="padding-left: 30px;" placeholder="username" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="edit-twitter-password">Mot de passe</label>
                    <div style="position: relative;">
                        <input type="password" id="edit-twitter-password" class="form-control" placeholder="Nouveau mot de passe (laisser vide pour garder l'ancien)">
                        <button type="button" onclick="toggleEditTwitterPassword()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #6b7280;">
                            <i class="fas fa-eye" id="edit-twitter-password-icon"></i>
                        </button>
                    </div>
                </div>

                <div class="modal-footer" style="margin-top: 1.5rem;">
                    <button type="button" class="btn" onclick="closeEditTwitterAccountModal()" style="background: #e5e7eb; color: #374151;">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn submit-btn" style="background: linear-gradient(135deg, #1da1f2 0%, #0d8bd9 100%);">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================================================
        // SUPABASE INITIALIZATION & AUTHENTICATION
        // ============================================================================

        let currentUser = null;
        let data = {
            vas: [],
            creators: [],
            twitterAccounts: [],
            instagramAccounts: [],
            gmailAccounts: [],
            subs: [],
            revenues: [],
            vaPayments: [],
            twitterStats: []
        };

        // Initialize Supabase on page load
        async function initializeApp() {
            try {
                // Initialize Supabase client
                initSupabase();

                // Load dark mode preference BEFORE loading data (so updateDisplay() sees correct isDarkMode)
                loadDarkModePreference();

                // Check authentication
                const authenticated = await isAuthenticated();
                if (!authenticated) {
                    console.log(' User not authenticated, showing login form...');
                    hideLoadingOverlay();
                    showLoginForm();
                    return;
                }

                // Get current user
                currentUser = await getCurrentUser();
                if (currentUser) {
                    console.log(' User authenticated:', currentUser.email);

                    // OPTIMIZED: Check VA and Manager status in parallel
                    const [vaResult, managerResult] = await Promise.all([
                        supabase
                            .from('vas')
                            .select('id, name, organization_id')
                            .eq('user_id', currentUser.id)
                            .maybeSingle(),
                        supabase
                            .from('managers')
                            .select('id, name, organization_id')
                            .eq('user_id', currentUser.id)
                            .maybeSingle()
                    ]);

                    if (vaResult.data) {
                        console.log(' User is a VA, redirecting to VA dashboard...');
                        window.location.href = 'va-dashboard.html';
                        return;
                    }

                    if (managerResult.data) {
                        console.log(' User is a manager of organization:', managerResult.data.organization_id);
                        currentOrganization = {
                            id: managerResult.data.organization_id,
                            role: 'manager'
                        };
                    }

                    document.getElementById('user-email').textContent = currentUser.email;

                    // Set organization before loading data
                    const orgs = await getUserOwnedOrganizations();
                    if (orgs.length > 0 && !localStorage.getItem('active_organization_id')) {
                        localStorage.setItem('active_organization_id', orgs[0].id);
                    }

                    // STEP 2: Now load data with the correct organization set
                    const [_, organization] = await Promise.all([
                        loadAllData(),
                        getUserOrganization()
                    ]);

                    // Check if user is organization owner and show admin button
                    if (organization && organization.owner_id === currentUser.id) {
                        document.getElementById('admin-nav-btn').style.display = 'flex';
                        console.log(' Admin button enabled for organization owner');
                    }

                    // Initialize UI
                    initializeUI();

                    // Create automatic backup (runs in background - don't await)
                    createAutomaticBackup().then(backup => {
                        if (backup) {
                            console.log(' Automatic backup created');
                        }
                    }).catch(e => console.warn(' Backup creation failed:', e));
                } else {
                    showLoginForm();
                }
            } catch (error) {
                console.error(' Failed to initialize app:', error);
                showError('Erreur d\'initialisation. Vrifiez votre connexion.');
                showLoginForm();
            }
        }

        // Show login form
        function showLoginForm() {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector('.header')?.style.setProperty('display', 'none');
            document.querySelector('.nav-bar')?.style.setProperty('display', 'none');

            // Create login overlay
            let loginOverlay = document.getElementById('login-overlay');
            if (!loginOverlay) {
                loginOverlay = document.createElement('div');
                loginOverlay.id = 'login-overlay';
                loginOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                loginOverlay.innerHTML = `
                    <div style="background: white; padding: 3rem; border-radius: 1.5rem; box-shadow: 0 25px 50px rgba(0,0,0,0.25); max-width: 400px; width: 90%;">
                        <h1 style="text-align: center; margin-bottom: 0.5rem; font-size: 1.75rem; color: #1a1a1a;">
                            <i class="fas fa-users-cog" style="color: #667eea;"></i> VA Manager Pro
                        </h1>
                        <p style="text-align: center; color: #64748b; margin-bottom: 2rem;">Connectez-vous pour continuer</p>
                        <form id="login-form" onsubmit="handleLogin(event)">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Email</label>
                                <input type="email" id="login-email" required placeholder="votre@email.com"
                                    style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem; transition: border-color 0.2s;"
                                    onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">Mot de passe</label>
                                <input type="password" id="login-password" required placeholder=""
                                    style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 1rem; transition: border-color 0.2s;"
                                    onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                            </div>
                            <div id="login-error" style="display: none; background: #fef2f2; color: #dc2626; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem;"></div>
                            <button type="submit" style="width: 100%; padding: 0.875rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.75rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 20px rgba(102,126,234,0.3)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i class="fas fa-sign-in-alt"></i> Se connecter
                            </button>
                        </form>
                    </div>
                `;
                document.body.appendChild(loginOverlay);
            }
            loginOverlay.style.display = 'flex';
        }

        // Handle login form submission
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            try {
                errorDiv.style.display = 'none';

                // S'assurer que Supabase est initialis
                const supabaseClient = await ensureSupabaseInit();
                if (!supabaseClient) {
                    throw new Error('Supabase non disponible. Veuillez rafrachir la page.');
                }

                const { data: authData, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // Hide login overlay and reinitialize app
                document.getElementById('login-overlay').style.display = 'none';
                document.querySelector('.header')?.style.setProperty('display', 'block');
                document.querySelector('.nav-bar')?.style.setProperty('display', 'flex');
                await initializeApp();
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message || 'Email ou mot de passe incorrect';
                errorDiv.style.display = 'block';
            }
        }

        // Show admin welcome message
        function showAdminWelcome(name) {
            const modal = document.createElement('div');
            modal.id = 'admin-welcome-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.3s ease;';
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 3rem; border-radius: 1.5rem; box-shadow: 0 25px 80px rgba(0,0,0,0.5); max-width: 500px; width: 90%; text-align: center; border: 2px solid rgba(102, 126, 234, 0.3); animation: modalSlideUp 0.4s ease;">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);">
                        <i class="fas fa-crown" style="font-size: 2.5rem; color: #ffd700;"></i>
                    </div>
                    <h1 style="color: white; font-size: 1.75rem; margin-bottom: 0.5rem; font-weight: 700;">
                        Bienvenue ${name} !
                    </h1>
                    <p style="color: #a0aec0; font-size: 1.1rem; margin-bottom: 1.5rem;">
                        Vous etes connecte en tant qu'<span style="color: #ffd700; font-weight: 600;">Administrateur</span>
                    </p>
                    <div style="background: rgba(102, 126, 234, 0.1); border-radius: 1rem; padding: 1.25rem; margin-bottom: 1.5rem; border: 1px solid rgba(102, 126, 234, 0.2);">
                        <p style="color: #e2e8f0; font-size: 0.95rem; margin: 0;">
                            <i class="fas fa-shield-alt" style="color: #667eea; margin-right: 0.5rem;"></i>
                            Vous avez <strong style="color: #10b981;">tous les droits</strong> sur cette plateforme
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 0.75rem; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <i class="fas fa-users" style="color: #10b981; font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                            <span style="color: #a0aec0; font-size: 0.8rem;">Gestion VAs</span>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 0.75rem; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <i class="fas fa-cog" style="color: #f59e0b; font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                            <span style="color: #a0aec0; font-size: 0.8rem;">Parametres</span>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 0.75rem; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <i class="fas fa-trash-alt" style="color: #ef4444; font-size: 1.5rem; margin-bottom: 0.5rem; display: block;"></i>
                            <span style="color: #a0aec0; font-size: 0.8rem;">Suppression</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('admin-welcome-modal').remove()"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1rem 2.5rem; border-radius: 0.75rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(102,126,234,0.5)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 5px 20px rgba(102,126,234,0.4)'">
                        <i class="fas fa-rocket" style="margin-right: 0.5rem;"></i> C'est parti !
                    </button>
                </div>
            `;
            document.body.appendChild(modal);

            // Auto close after 10 seconds
            setTimeout(() => {
                const m = document.getElementById('admin-welcome-modal');
                if (m) {
                    m.style.opacity = '0';
                    m.style.transition = 'opacity 0.3s';
                    setTimeout(() => m.remove(), 300);
                }
            }, 10000);
        }

        // Show loading overlay
        function showLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            overlay.innerHTML = '<div style="text-align: center; color: white;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i><p style="font-size: 1.2rem; font-weight: 600;">Chargement des donnes...</p></div>';
            document.body.appendChild(overlay);
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        // Load all data from Supabase
        async function loadAllData() {
            try {
                // Load ONLY essential data (VAs, creators, accounts) - NO financials, NO stats
                const allData = await getAllUserData({ loadStats: false, loadFinancials: false });

                // Map Supabase data to local data structure
                // Load VA credentials from localStorage if not in Supabase
                const vaCredentials = JSON.parse(localStorage.getItem('vaCredentials') || '{}');

                data.vas = allData.vas.map(va => ({
                    id: va.id,
                    name: va.name,
                    email: va.email || (vaCredentials[va.id] ? vaCredentials[va.id].email : null),
                    password: va.password || (vaCredentials[va.id] ? vaCredentials[va.id].password : null),
                    created: va.created_at
                }));

                data.creators = allData.creators.map(creator => ({
                    id: creator.id,
                    name: creator.name,
                    photo_url: creator.photo_url || null,
                    created: creator.created_at,
                    vaIds: [], // Will be populated below
                    accounts: [] // Legacy structure, keeping for compatibility
                }));

                // Populate vaIds for creators based on va_creator relationships - OPTIMIZED with Map lookup
                const creatorMap = new Map(data.creators.map(c => [c.id, c]));
                allData.vaCreatorRelations.forEach(relation => {
                    const creator = creatorMap.get(relation.creator_id);
                    if (creator && !creator.vaIds.includes(relation.va_id)) {
                        creator.vaIds.push(relation.va_id);
                    }
                });

                data.twitterAccounts = allData.twitterAccounts.map(account => ({
                    id: account.id,
                    username: account.username,
                    password: account.password,
                    creatorId: account.creator_id,
                    vaId: account.va_id,
                    gmailId: account.gmail_id,
                    status: account.status || 'active',
                    notes: account.notes || '',
                    created: account.created_at
                }));

                data.instagramAccounts = allData.instagramAccounts.map(account => ({
                    id: account.id,
                    username: account.username,
                    password: account.password,
                    creatorId: account.creator_id,
                    vaId: account.va_id,
                    gmailId: account.gmail_id,
                    status: account.status || 'active',
                    notes: account.notes || '',
                    created: account.created_at
                }));

                // Rcuprer les statuts bannis depuis localStorage
                const bannedGmails = JSON.parse(localStorage.getItem('bannedGmailAccounts') || '{}');

                data.gmailAccounts = allData.gmailAccounts.map(account => ({
                    id: account.id,
                    email: account.email,
                    password: account.password,
                    vaId: account.va_id,
                    notes: account.notes,
                    created: account.created_at,
                    // Utiliser le statut de la DB s'il existe, sinon vrifier localStorage
                    status: account.status || (bannedGmails[account.id] ? 'banned' : 'active')
                }));

                // Initialize empty arrays for non-essential data (loaded on demand later)
                data.subs = [];
                data.revenues = [];
                data.vaPayments = [];
                data.twitterStats = [];
                data.warmupProgress = {};

                // Populate Twitter accounts into creators' accounts arrays - OPTIMIZED with grouping
                const twitterByCreator = new Map();
                data.twitterAccounts.forEach(account => {
                    if (!twitterByCreator.has(account.creatorId)) {
                        twitterByCreator.set(account.creatorId, []);
                    }
                    twitterByCreator.get(account.creatorId).push(account);
                });

                data.creators.forEach(creator => {
                    const filteredTwitter = twitterByCreator.get(creator.id) || [];
                    creator.accounts = filteredTwitter.map(account => ({
                        id: account.id,
                        username: account.username,
                        password: account.password,
                        gmailId: account.gmailId,
                        assignedVaId: account.vaId || (creator.vaIds?.length === 1 ? creator.vaIds[0] : null),
                        status: account.status,
                        notes: account.notes
                    }));
                });

                // Populate Instagram accounts into creators' instagramAccounts arrays - OPTIMIZED with grouping
                const instagramByCreator = new Map();
                data.instagramAccounts.forEach(account => {
                    if (!instagramByCreator.has(account.creatorId)) {
                        instagramByCreator.set(account.creatorId, []);
                    }
                    instagramByCreator.get(account.creatorId).push(account);
                });

                data.creators.forEach(creator => {
                    const filteredInstagram = instagramByCreator.get(creator.id) || [];
                    creator.instagramAccounts = filteredInstagram.map(account => ({
                        id: account.id,
                        username: account.username,
                        password: account.password,
                        gmailId: account.gmailId,
                        assignedVaId: account.vaId || (creator.vaIds?.length === 1 ? creator.vaIds[0] : null),
                        status: account.status,
                        notes: account.notes
                    }));
                });

                // Auto-fix: Si creator.vaIds est vide, dduire depuis les comptes
                data.creators.forEach(creator => {
                    if (!creator.vaIds || creator.vaIds.length === 0) {
                        const vaIdsFromAccounts = new Set();
                        const twitterForCreator = twitterByCreator.get(creator.id) || [];
                        const instagramForCreator = instagramByCreator.get(creator.id) || [];
                        twitterForCreator.forEach(acc => { if (acc.vaId) vaIdsFromAccounts.add(acc.vaId); });
                        instagramForCreator.forEach(acc => { if (acc.vaId) vaIdsFromAccounts.add(acc.vaId); });
                        if (vaIdsFromAccounts.size > 0) {
                            creator.vaIds = Array.from(vaIdsFromAccounts);
                        }
                    }
                });

                // Update display after data is loaded
                updateDisplay();

            } catch (error) {
                console.error(' Error loading data:', error);
                showError('Erreur lors du chargement des donnes');
                throw error;
            }
        }

        // Handle logout
        async function handleLogout() {
            if (confirm('tes-vous sr de vouloir vous dconnecter ?')) {
                try {
                    await signOut();
                    console.log(' User logged out');
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error(' Logout error:', error);
                    showError('Erreur lors de la dconnexion');
                }
            }
        }

        // Save data wrapper (calls Supabase instead of localStorage)
        async function saveData() {
            syncToVADashboard();
            return true;
        }

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error(' JavaScript Error:', e.error);
            console.error('At:', e.filename, 'Line:', e.lineno, 'Column:', e.colno);
        });
        
        // Dark mode management (defined early to be available for onclick)
        function toggleDarkMode() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            
            // Update data-theme attribute
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            
            if (icon && text) {
                if (isDarkMode) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    text.textContent = 'Mode Jour';
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    text.textContent = 'Mode Nuit';
                }
            }
            
            // Save preference
            localStorage.setItem('darkMode', isDarkMode);
            
            // Update the financial overview if it's the current page
            const currentPage = document.querySelector('.page.active')?.id;
            if (currentPage === 'financial-page') {
                updateFinancialOverview();
            }

            // Force update all dark mode-sensitive elements
            setTimeout(() => {
                updateDisplay();
                // Only force dark backgrounds if we're in dark mode
                if (isDarkMode) {
                    forceAllDarkBackgrounds();
                }
                // Reload admin panel if it's the active page
                if (currentPage === 'admin-page') {
                    loadAdminStats();
                }
            }, 50);
        }
        
        // Test navigation function
        window.testNav = function(page) {
            console.log(` Testing navigation to: ${page}`);
            try {
                if (typeof navigateToPage === 'function') {
                    navigateToPage(page);
                    console.log(' Navigation successful');
                } else {
                    console.error(' navigateToPage function not found');
                }
            } catch (error) {
                console.error(' Navigation error:', error);
            }
        };
        
        // Fix navigation function
        window.fixNav = function() {
            console.log(' Fixing navigation...');
            
            // Remove all existing click handlers
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });
            
            // Re-attach event listeners
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    console.log(`Navigating to: ${page}`);
                    if (page) {
                        navigateToPage(page);
                    }
                });
            });
            
            console.log(' Navigation fixed!');
        };

        // Note: data structure is defined at the top with Supabase initialization

        // Utility function to generate unique IDs
        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Simple obfuscation for passwords (NOT secure encryption, just basic protection)
        function obfuscatePassword(password) {
            // Avertissement: Ceci n'est PAS une vraie scurit!
            // Pour une vraie scurit, utilisez un serveur backend
            return btoa(password).split('').reverse().join('');
        }
        
        function deobfuscatePassword(obfuscated) {
            // Pour la compatibilit avec les anciennes donnes
            try {
                return atob(obfuscated.split('').reverse().join(''));
            } catch {
                // Si a choue, c'est probablement un ancien mot de passe non obfusqu
                return obfuscated;
            }
        }
        
        // Force all white backgrounds to be dark
        function forceAllDarkBackgrounds() {
            setTimeout(() => {
                // Find all elements with white backgrounds
                const elements = document.querySelectorAll('[style*="background"]');
                elements.forEach(el => {
                    const style = el.getAttribute('style');
                    if (style && (style.includes('white') || style.includes('fff') || style.includes('ffffff'))) {
                        el.style.backgroundColor = '#16181d';
                        el.style.color = '#e1e8ef';
                    }
                });
            }, 100);
        }
        
        // Load dark mode preference on page load
        function loadDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                const icon = document.getElementById('theme-icon');
                const text = document.getElementById('theme-text');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                text.textContent = 'Mode Jour';
                // Force dark backgrounds after page loads
                forceAllDarkBackgrounds();
            }
        }

        // Example structure:
        // {
        //     vas: [
        //         {
        //             id: "va_123",
        //             name: "Hugo",
        //             creators: [
        //                 {
        //                     id: "creator_456",
        //                     name: "Justine",
        //                     accounts: [
        //                         {
        //                             username: "@justine_pro",
        //                             email: "justine@email.com",
        //                             password: "pass123"
        //                         }
        //                     ]
        //                 }
        //             ]
        //         }
        //     ],
        //     subs: [
        //         {
        //             id: "sub_123",
        //             vaId: "va_123",
        //             date: "2025-01-09",
        //             count: 10,
        //             amount: 5.00
        //         }
        //     ],
        //     revenues: [
        //         {
        //             id: "rev_123",
        //             vaId: "va_123",
        //             date: "2025-01-09",
        //             amount: 150.00,
        //             commission: 7.50,
        //             description: "Ventes mdias",
        //             trackingLink: "track123"
        //         }
        //     ],
        //     payments: [
        //         {
        //             id: "pay_123",
        //             vaId: "va_123",
        //             date: "2025-01-09",
        //             amount: 50.00,
        //             type: "commission",
        //             period: "Semaine 1-7 Jan"
        //         }
        //     ]
        // }

        // Systme de sauvegarde automatique
        let autoSaveInterval = null;
        let lastSaveTime = Date.now();
        
        // Marquer que les donnes ont t modifies
        function markDataModified() {
            lastSaveTime = Date.now();
        }

        // BroadcastChannel pour notifier le dashboard VA
        let appSyncChannel = null;

        // Initialiser le BroadcastChannel une seule fois
        try {
            if (!appSyncChannel) {
                appSyncChannel = new BroadcastChannel('va_dashboard_sync');
                console.log(' BroadcastChannel initialis dans app.html');

                // couter les notifications du dashboard VA
                appSyncChannel.onmessage = (event) => {
                    console.log(' Message reu du dashboard VA:', event.data);

                    if (event.data.type === 'account_deleted') {
                        handleAccountDeleted(event.data);
                    } else if (event.data.type === 'warmup_updated') {
                        handleWarmupUpdated(event.data);
                    }
                };
            }
        } catch (e) {
            console.warn(' BroadcastChannel non support');
        }

        // Handle account deletion from VA dashboard
        async function handleAccountDeleted(deleteData) {
            const { platform, username, creatorId } = deleteData;
            console.log(` Suppression reue: ${platform} ${username}`);

            try {
                // Find creator
                const creator = data.creators.find(c => c.id === creatorId);
                if (!creator) {
                    console.error(' Cratrice non trouve:', creatorId);
                    return;
                }

                if (platform === 'instagram') {
                    // Remove from creator.instagramAccounts
                    if (creator.instagramAccounts) {
                        creator.instagramAccounts = creator.instagramAccounts.filter(acc =>
                            acc.username !== username
                        );
                        console.log(` Supprim de creator.instagramAccounts: ${username}`);
                    }

                    // Remove from data.instagramAccounts
                    const accountToDelete = data.instagramAccounts.find(acc => acc.username === username);
                    if (accountToDelete) {
                        data.instagramAccounts = data.instagramAccounts.filter(acc =>
                            acc.username !== username
                        );
                        console.log(` Supprim de data.instagramAccounts: ${username}`);

                        // Delete from Supabase if account has an ID
                        if (accountToDelete.id) {
                            await window.deleteInstagramAccount(accountToDelete.id);
                            console.log(` Supprim de Supabase: ${username}`);
                        }
                    }
                } else if (platform === 'twitter') {
                    // Remove from creator.accounts
                    if (creator.accounts) {
                        creator.accounts = creator.accounts.filter(acc =>
                            acc.username !== username
                        );
                        console.log(` Supprim de creator.accounts: ${username}`);
                    }

                    // Remove from data.twitterAccounts
                    const accountToDelete = data.twitterAccounts.find(acc => acc.username === username);
                    if (accountToDelete) {
                        data.twitterAccounts = data.twitterAccounts.filter(acc =>
                            acc.username !== username
                        );
                        console.log(` Supprim de data.twitterAccounts: ${username}`);

                        // Delete from Supabase if account has an ID
                        if (accountToDelete.id) {
                            await window.deleteTwitterAccount(accountToDelete.id);
                            console.log(` Supprim de Supabase: ${username}`);
                        }
                    }
                }

                // Refresh display
                updateDisplay();
                console.log(` Dashboard app.html mis  jour aprs suppression de ${username}`);
            } catch (error) {
                console.error(' Erreur lors de la suppression:', error);
            }
        }

        // Handle warmup update from VA dashboard
        async function handleWarmupUpdated(updateData) {
            const { username, currentDay, completed, timestamp } = updateData;
            console.log(` Mise  jour warmup reue: ${username} - Jour ${currentDay}${completed ? ' (Termin)' : ''}`);

            try {
                // Load warmup progress from localStorage
                let warmupProgress = {};
                const warmupDataStr = localStorage.getItem('warmupProgress');
                if (warmupDataStr) {
                    warmupProgress = JSON.parse(warmupDataStr);
                }

                // Update the specific account's progress
                const accountKey = username.replace('@', '');
                if (warmupProgress[accountKey]) {
                    warmupProgress[accountKey].currentDay = currentDay;
                    warmupProgress[accountKey].lastUpdate = timestamp;
                    if (completed) {
                        warmupProgress[accountKey].completed = true;
                        warmupProgress[accountKey].completedDate = timestamp;
                    }

                    // Save back to localStorage
                    localStorage.setItem('warmupProgress', JSON.stringify(warmupProgress));
                    console.log(` Warmup mis  jour dans localStorage: ${username} - Jour ${currentDay}/21`);

                    // Refresh display if warmup management is visible
                    if (typeof updateWarmupDisplay === 'function') {
                        updateWarmupDisplay();
                    }
                } else {
                    console.warn(` Compte warmup non trouv: ${accountKey}`);
                }
            } catch (error) {
                console.error(' Erreur lors de la mise  jour du warmup:', error);
            }
        }

        // Auto-sync to VA Dashboard localStorage
        function syncToVADashboard() {
            try {
                const vaManagerData = {
                    vas: data.vas,
                    creators: data.creators,
                    revenues: data.revenues,
                    subs: data.subs,
                    instagramAccounts: data.instagramAccounts,
                    twitterAccounts: data.twitterAccounts,
                    _timestamp: Date.now() // Force le hash  changer
                };

                const jsonData = JSON.stringify(vaManagerData);
                localStorage.setItem('vaManagerData', jsonData);
                console.log(' VA Dashboard synchronized');
                console.log('    Instagram accounts synced:', data.instagramAccounts.length);
                console.log('    Creators synced:', data.creators.length);
                console.log('    Data size:', jsonData.length, 'characters');

                // Notifier les autres onglets via BroadcastChannel
                if (appSyncChannel) {
                    appSyncChannel.postMessage({
                        type: 'data_updated',
                        timestamp: new Date().toISOString()
                    });
                    console.log(' Notification envoye aux dashboards ouverts');
                }
            } catch (error) {
                console.error(' Error syncing to VA Dashboard:', error);
            }
        }
        
        function startAutoSave() {
            // Sauvegarder toutes les 5 minutes
            autoSaveInterval = setInterval(async () => {
                const timeSinceLastSave = Date.now() - lastSaveTime;
                
                // Ne sauvegarder que si des changements ont t faits
                if (timeSinceLastSave < 60000) { // Moins d'1 minute depuis la dernire sauvegarde
                    return;
                }
                
                console.log(' Sauvegarde automatique...');
                await saveData();
                lastSaveTime = Date.now();
            }, 5 * 60 * 1000); // 5 minutes
            
            // Tracker les modifications pour la sauvegarde automatique
            window.addEventListener('beforeunload', (e) => {
                // Si des donnes n'ont pas t sauvegardes
                if (Date.now() - lastSaveTime > 30000) { // Plus de 30 secondes
                    e.preventDefault();
                    e.returnValue = 'Des modifications non sauvegardes seront perdues. tes-vous sr de vouloir quitter ?';
                }
            });
        }
        
        // Vrification et rcupration des donnes
        async function checkAndRecoverData() {
            try {
                // Vrifier s'il y a des donnes corrompues
                const mainData = localStorage.getItem('vaManagerProData');
                const backupData = localStorage.getItem('vaManagerProData_backup');
                const history = localStorage.getItem('vaManagerProBackupHistory');
                
                if (!mainData && backupData) {
                    console.log(' Rcupration depuis la sauvegarde...');
                    try {
                        const backup = JSON.parse(backupData);
                        if (backup && backup.data) {
                            localStorage.setItem('vaManagerProData', JSON.stringify(backup.data));
                            showSuccess('Donnes rcupres depuis la sauvegarde automatique');
                        }
                    } catch (e) {
                        console.error(' Error parsing backup data:', e);
                    }
                } else if (!mainData && !backupData && history) {
                    console.log(' Rcupration depuis l\'historique...');
                    try {
                        const historyData = JSON.parse(history);
                        if (historyData && historyData.length > 0) {
                            localStorage.setItem('vaManagerProData', JSON.stringify(historyData[0].data));
                            showSuccess('Donnes rcupres depuis l\'historique des sauvegardes');
                        }
                    } catch (e) {
                        console.error(' Error parsing history data:', e);
                    }
                }

                // Vrifier l'intgrit des donnes
                try {
                    if (mainData) {
                        JSON.parse(mainData);
                    }
                } catch (e) {
                    console.error(' Donnes corrompues dtectes');
                    if (backupData) {
                        try {
                            const backup = JSON.parse(backupData);
                            if (backup && backup.data) {
                                localStorage.setItem('vaManagerProData', JSON.stringify(backup.data));
                                showError('Donnes corrompues dtectes - Restauration depuis la sauvegarde');
                            }
                        } catch (parseError) {
                            console.error(' Error parsing backup during recovery:', parseError);
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la vrification des donnes:', error);
            }
        }
        
        // Fonction pour rcuprer une sauvegarde spcifique
        function restoreFromBackup(index) {
            try {
                const history = JSON.parse(localStorage.getItem('vaManagerProBackupHistory') || '[]');
                if (history[index]) {
                    data = history[index].data;
                    saveData();
                    showSuccess(`Donnes restaures depuis la sauvegarde du ${new Date(history[index].timestamp).toLocaleString()}`);
                    closeBackupModal();
                    window.location.reload();
                }
            } catch (error) {
                console.error('Erreur lors de la restauration:', error);
                showError('Erreur lors de la restauration des donnes');
            }
        }

        // Toggle mobile navigation dropdown
        function toggleMobileNav() {
            const nav = document.getElementById('mobile-nav-dropdown');
            const btn = document.getElementById('mobile-nav-toggle');

            nav.classList.toggle('open');

            // Change icon
            const icon = btn.querySelector('i');
            if (nav.classList.contains('open')) {
                icon.className = 'fas fa-times';
            } else {
                icon.className = 'fas fa-ellipsis-v';
            }
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', function(event) {
            const nav = document.getElementById('mobile-nav-dropdown');
            const btn = document.getElementById('mobile-nav-toggle');

            if (nav && btn && nav.classList.contains('open')) {
                if (!nav.contains(event.target) && !btn.contains(event.target)) {
                    nav.classList.remove('open');
                    btn.querySelector('i').className = 'fas fa-ellipsis-v';
                }
            }
        });

        // Close mobile nav when clicking a nav button
        document.addEventListener('DOMContentLoaded', function() {
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const nav = document.getElementById('mobile-nav-dropdown');
                    const toggle = document.getElementById('mobile-nav-toggle');
                    if (nav && nav.classList.contains('open')) {
                        nav.classList.remove('open');
                        if (toggle) {
                            toggle.querySelector('i').className = 'fas fa-ellipsis-v';
                        }
                    }
                });
            });

            // Show mobile nav toggle on mobile
            if (window.innerWidth <= 390) {
                const toggleBtn = document.getElementById('mobile-nav-toggle');
                if (toggleBtn) {
                    toggleBtn.style.display = 'flex';
                }
            }

            // Handle window resize
            window.addEventListener('resize', function() {
                const toggleBtn = document.getElementById('mobile-nav-toggle');
                if (toggleBtn) {
                    if (window.innerWidth <= 390) {
                        toggleBtn.style.display = 'flex';
                    } else {
                        toggleBtn.style.display = 'none';
                        const nav = document.getElementById('mobile-nav-dropdown');
                        if (nav && nav.classList.contains('open')) {
                            nav.classList.remove('open');
                        }
                    }
                }
            });
        });

        // Initialize UI (called after data is loaded from Supabase)
        function initializeUI() {
            setupEventListeners();

            // Initialize dashboard welcome header date/time
            initDashboardDateTime();

            // Activer le dashboard par dfaut
            const pages = document.querySelectorAll('.page');
            const dashboardPage = document.getElementById('dashboard-page');
            const navBtns = document.querySelectorAll('.nav-btn');

            pages.forEach(p => p.classList.remove('active'));
            if (dashboardPage) dashboardPage.classList.add('active');
            navBtns.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === 'dashboard-page') btn.classList.add('active');
            });

            // Forcer la mise  jour du dashboard
            updateDisplay();

            // Vrifier si les followers ont t mis  jour aujourd'hui
            checkFollowersUpdateStatus();

            // Initialiser le popup urgent de rappel followers (23h)
            initUrgentFollowersReminder();

            setupDragAndDrop();
            setupSubsTracking();
            setupRevenueTracking();
            startAutoSave();

            // Set today's date as default for forms
            const today = new Date().toISOString().split('T')[0];
            const subsDate = document.getElementById('subs-date');
            const revenueDate = document.getElementById('revenue-date');
            const paymentDate = document.getElementById('payment-date');
            if (subsDate) subsDate.value = today;
            if (revenueDate) revenueDate.value = today;
            if (paymentDate) paymentDate.value = today;

            // Message de bienvenue admin pour Tom
            if (currentUser?.email === 'tom@vamanager.pro') {
                setTimeout(() => showAdminWelcome('Tom'), 500);
            }

            // Fix missing assignedVaId inline (no extra function call)
            if (data.creators) {
                let needsUpdate = false;
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.vaIds?.length === 1) {
                        const vaId = creator.vaIds[0];
                        creator.accounts.forEach(account => {
                            if (!account.assignedVaId) {
                                account.assignedVaId = vaId;
                                needsUpdate = true;
                            }
                        });
                    }
                });
                if (needsUpdate) {
                    saveData();
                    updateDisplay();
                }
            }
            
            // Fonction de diagnostic pour comprendre le problme des comptes multi-VA
            window.diagnoseLauraBptss = function() {
                console.log('\n DIAGNOSTIC COMPLET POUR LAURABPTSS');
                console.log('=====================================\n');
                
                // 1. Chercher toutes les cratrices avec "laura" dans le nom
                console.log('1 TOUTES LES CRATRICES "LAURA":');
                data.creators.forEach(creator => {
                    if (creator.name.toLowerCase().includes('laura')) {
                        console.log(`\n Cratrice: ${creator.name} (ID: ${creator.id})`);
                        console.log(`   - vaIds: ${JSON.stringify(creator.vaIds)}`);
                        
                        // Afficher les noms des VAs
                        if (creator.vaIds && creator.vaIds.length > 0) {
                            const vaNames = creator.vaIds.map(vaId => {
                                const va = data.vas.find(v => v.id === vaId);
                                return va ? va.name : 'VA supprim';
                            });
                            console.log(`   - VAs: ${vaNames.join(', ')}`);
                        }
                        
                        // Afficher tous les comptes
                        if (creator.accounts && creator.accounts.length > 0) {
                            console.log(`   - Comptes (${creator.accounts.length}):`);
                            creator.accounts.forEach(account => {
                                console.log(`      ${account.username}`);
                                console.log(`       - assignedVaId: ${account.assignedVaId || 'NON DFINI'}`);
                                if (account.assignedVaId) {
                                    const va = data.vas.find(v => v.id === account.assignedVaId);
                                    console.log(`       - VA assign: ${va ? va.name : 'VA supprim'}`);
                                }
                            });
                        }
                    }
                });
                
                // 2. Chercher spcifiquement laurabptss
                console.log('\n2 RECHERCHE SPCIFIQUE DE @laurabptss:');
                let foundLaurabptss = false;
                
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        creator.accounts.forEach(account => {
                            if (account.username.toLowerCase().includes('laurabptss')) {
                                foundLaurabptss = true;
                                console.log(`\n TROUV dans cratrice: ${creator.name}`);
                                console.log(`   - Username exact: "${account.username}"`);
                                console.log(`   - assignedVaId: ${account.assignedVaId || 'NON DFINI'}`);
                                console.log(`   - Cratrice vaIds: ${JSON.stringify(creator.vaIds)}`);
                                
                                if (creator.vaIds && creator.vaIds.length > 1) {
                                    console.log(`    PROBLME: Cette cratrice est sur ${creator.vaIds.length} VAs !`);
                                }
                            }
                        });
                    }
                });
                
                if (!foundLaurabptss) {
                    console.log(' @laurabptss non trouv dans les comptes');
                }
                
                // 3. Vrifier aussi dans data.twitterAccounts
                console.log('\n3 VRIFICATION DANS data.twitterAccounts:');
                if (data.twitterAccounts) {
                    const twitterAccount = data.twitterAccounts.find(ta => 
                        ta.username && ta.username.toLowerCase().includes('laurabptss')
                    );
                    if (twitterAccount) {
                        console.log(' Trouv dans twitterAccounts:');
                        console.log(`   - Username: ${twitterAccount.username}`);
                        console.log(`   - vaId: ${twitterAccount.vaId || 'NON DFINI'}`);
                        console.log(`   - creatorId: ${twitterAccount.creatorId || 'NON DFINI'}`);
                    }
                }
                
                // 4. Afficher tous les VAs
                console.log('\n4 LISTE DES VAs:');
                data.vas.forEach(va => {
                    console.log(`   - ${va.name} (ID: ${va.id})`);
                });
                
                console.log('\n=====================================');
                console.log('FIN DU DIAGNOSTIC');
            };
            
            // Fonction de nettoyage pour supprimer les doublons avec "s"
            window.removeDuplicatesWithS = function() {
                console.log(' Recherche de comptes dupliqus avec "s"...');
                let removed = 0;
                
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.accounts.length > 0) {
                        const toRemove = [];
                        
                        creator.accounts.forEach((account, index) => {
                            // Vrifier si c'est un compte avec "s" ajout
                            const baseUsername = account.username.replace(/s$/, '');
                            
                            // Chercher s'il existe un compte sans le "s"
                            const baseExists = creator.accounts.some((acc, i) => 
                                i !== index && acc.username === baseUsername
                            );
                            
                            if (baseExists && account.username.endsWith('s') && account.username !== baseUsername) {
                                console.log(` Suppression du doublon: ${account.username} (base: ${baseUsername})`);
                                toRemove.push(index);
                                removed++;
                            }
                        });
                        
                        // Supprimer en ordre inverse pour ne pas dcaler les indices
                        toRemove.reverse().forEach(index => {
                            creator.accounts.splice(index, 1);
                        });
                    }
                });
                
                if (removed > 0) {
                    saveData();
                    updateDisplay();
                    showSuccess(`${removed} doublon(s) supprim(s)!`);
                } else {
                    console.log(' Aucun doublon trouv');
                }
            };
            
            // Fonction pour sparer une cratrice multi-VA en cratrices distinctes
            window.splitCreatorByVA = function(creatorName) {
                const creator = data.creators.find(c => c.name === creatorName);
                if (!creator || !creator.vaIds || creator.vaIds.length <= 1) {
                    console.error('Cratrice non trouve ou n\'a qu\'un seul VA');
                    return;
                }
                
                console.log(` Sparation de ${creatorName} en ${creator.vaIds.length} cratrices distinctes...`);
                
                // Pour chaque VA, crer une nouvelle cratrice avec ses comptes
                const newCreators = [];
                creator.vaIds.forEach((vaId, index) => {
                    const va = data.vas.find(v => v.id === vaId);
                    if (va) {
                        const newCreator = {
                            id: index === 0 ? creator.id : 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: creator.name,
                            vaIds: [vaId],
                            accounts: []
                        };
                        
                        // Demander quels comptes assigner  ce VA
                        console.log(`\n Pour ${va.name}, quels comptes assigner ?`);
                        if (creator.accounts) {
                            creator.accounts.forEach((acc, i) => {
                                console.log(`   ${i}: ${acc.username}`);
                            });
                        }
                        
                        newCreators.push({ creator: newCreator, va: va });
                    }
                });
                
                // Stocker pour utilisation ultrieure
                window.tempSplit = {
                    original: creator,
                    newCreators: newCreators
                };
                
                console.log('\n Utilisez assignAccountsToSplit() pour assigner les comptes:');
                console.log('Exemple: assignAccountsToSplit("hugo", [0]) pour assigner le compte 0  Hugo');
                console.log('         assignAccountsToSplit("fifi", [1]) pour assigner le compte 1  Fifi');
                
                return newCreators;
            };
            
            // Fonction pour assigner les comptes aprs split
            window.assignAccountsToSplit = function(vaName, accountIndices) {
                if (!window.tempSplit) {
                    console.error('Aucune sparation en cours. Utilisez d\'abord splitCreatorByVA()');
                    return;
                }
                
                const targetCreator = window.tempSplit.newCreators.find(nc => 
                    nc.va.name.toLowerCase() === vaName.toLowerCase()
                );
                
                if (!targetCreator) {
                    console.error(`VA ${vaName} non trouv dans la sparation`);
                    return;
                }
                
                // Assigner les comptes slectionns
                accountIndices.forEach(index => {
                    if (window.tempSplit.original.accounts[index]) {
                        targetCreator.creator.accounts.push(window.tempSplit.original.accounts[index]);
                        console.log(` ${window.tempSplit.original.accounts[index].username} assign  ${vaName}`);
                    }
                });
            };
            
            // Fonction pour finaliser la sparation
            window.finalizeSplit = function() {
                if (!window.tempSplit) {
                    console.error('Aucune sparation en cours');
                    return;
                }
                
                // Remplacer l'ancienne cratrice par les nouvelles
                const originalIndex = data.creators.findIndex(c => c.id === window.tempSplit.original.id);
                if (originalIndex > -1) {
                    // Supprimer l'originale
                    data.creators.splice(originalIndex, 1);
                    
                    // Ajouter les nouvelles
                    window.tempSplit.newCreators.forEach(nc => {
                        data.creators.push(nc.creator);
                    });
                    
                    console.log(' Sparation termine !');
                    saveData();
                    updateDisplay();
                    updateAllCreatorsTable();
                    
                    delete window.tempSplit;
                } else {
                    console.error('Cratrice originale non trouve');
                }
            };
            
            // Fonction de diagnostic pour analyser les cratrices et leurs comptes
            window.analyzeCreators = function() {
                console.log(' Analyse des cratrices et leurs comptes:');
                console.log('='.repeat(50));
                
                data.creators.forEach(creator => {
                    console.log(`\n Cratrice: ${creator.name}`);
                    console.log(`   ID: ${creator.id}`);
                    console.log(`   VAs associs: ${creator.vaIds ? creator.vaIds.map(id => data.vas.find(v => v.id === id)?.name).join(', ') : 'Aucun'}`);
                    console.log(`   Nombre de comptes: ${creator.accounts ? creator.accounts.length : 0}`);
                    
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(account => {
                            console.log(`     - ${account.username}`);
                        });
                    }
                });
                
                console.log('\n Vue par VA:');
                console.log('='.repeat(50));
                
                data.vas.forEach(va => {
                    console.log(`\n VA: ${va.name}`);
                    const vaCreators = data.creators.filter(c => c.vaIds && c.vaIds.includes(va.id));
                    
                    vaCreators.forEach(creator => {
                        console.log(`    ${creator.name}: ${creator.accounts ? creator.accounts.length : 0} comptes`);
                        if (creator.accounts) {
                            creator.accounts.forEach(acc => {
                                console.log(`      - ${acc.username}`);
                            });
                        }
                    });
                });
            };
            
            // Exposer la fonction de rcupration dans la console
            window.recoverTwitterAccounts = function() {
                console.log(' Rcupration manuelle des comptes Twitter...');
                const result = recoverLostTwitterAccounts();
                if (result) {
                    updateDisplay();
                    updateTwitterAccountsList();
                    updateTwitterUnassignedDisplay();
                    saveData(); // Sauvegarder aprs rcupration
                }
                return result;
            };
            
            // Fonction pour transfrer un compte Twitter d'un VA  un autre
            window.transferTwitterAccount = function(username, fromVAName, toVAName) {
                console.log(` Transfert de ${username} de ${fromVAName} vers ${toVAName}...`);
                
                // Trouver les VAs
                const fromVA = data.vas.find(v => v.name.toLowerCase() === fromVAName.toLowerCase());
                const toVA = data.vas.find(v => v.name.toLowerCase() === toVAName.toLowerCase());
                
                if (!fromVA || !toVA) {
                    console.error(' VA source ou destination non trouv');
                    return false;
                }
                
                // Chercher la cratrice qui possde ce compte
                let targetCreator = null;
                let targetAccount = null;
                
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        const account = creator.accounts.find(a => 
                            a.username.toLowerCase() === username.toLowerCase() ||
                            a.username.toLowerCase() === '@' + username.toLowerCase().replace('@', '')
                        );
                        if (account && creator.vaIds && creator.vaIds.includes(fromVA.id)) {
                            targetCreator = creator;
                            targetAccount = account;
                        }
                    }
                });
                
                if (!targetCreator || !targetAccount) {
                    console.error(` Compte ${username} non trouv pour ${fromVAName}`);
                    return false;
                }
                
                // Transfrer le VA
                console.log(` Compte trouv: ${targetAccount.username} (cratrice: ${targetCreator.name})`);
                
                // Retirer l'ancien VA
                const fromIndex = targetCreator.vaIds.indexOf(fromVA.id);
                if (fromIndex > -1) {
                    targetCreator.vaIds.splice(fromIndex, 1);
                }
                
                // Ajouter le nouveau VA
                if (!targetCreator.vaIds.includes(toVA.id)) {
                    targetCreator.vaIds.push(toVA.id);
                }
                
                console.log(` Transfert effectu !`);
                console.log(`   Cratrice ${targetCreator.name} est maintenant associe : ${targetCreator.vaIds.map(id => data.vas.find(v => v.id === id)?.name).join(', ')}`);
                
                // Sauvegarder et mettre  jour
                saveData();
                updateDisplay();
                updateTwitterAccountsList();
                
                return true;
            };
            
            // Fonction pour fusionner les cratrices dupliques
            window.mergeDuplicateCreators = function() {
                console.log(' Recherche de cratrices dupliques...');
                
                const creatorsByName = {};
                const toRemove = [];
                
                // Grouper les cratrices par nom
                data.creators.forEach((creator, index) => {
                    if (!creatorsByName[creator.name]) {
                        creatorsByName[creator.name] = [];
                    }
                    creatorsByName[creator.name].push({ creator, index });
                });
                
                // Fusionner les doublons
                Object.keys(creatorsByName).forEach(name => {
                    if (creatorsByName[name].length > 1) {
                        console.log(` Trouv ${creatorsByName[name].length} instances de "${name}"`);
                        
                        // Garder la premire et fusionner les autres
                        const main = creatorsByName[name][0].creator;
                        
                        for (let i = 1; i < creatorsByName[name].length; i++) {
                            const duplicate = creatorsByName[name][i].creator;
                            
                            // Fusionner les vaIds
                            if (duplicate.vaIds) {
                                duplicate.vaIds.forEach(vaId => {
                                    if (!main.vaIds) main.vaIds = [];
                                    if (!main.vaIds.includes(vaId)) {
                                        main.vaIds.push(vaId);
                                    }
                                });
                            }
                            
                            // Fusionner les comptes
                            if (duplicate.accounts) {
                                duplicate.accounts.forEach(account => {
                                    if (!main.accounts) main.accounts = [];
                                    // Vrifier si le compte n'existe pas dj
                                    const exists = main.accounts.some(a => a.username === account.username);
                                    if (!exists) {
                                        main.accounts.push(account);
                                    }
                                });
                            }
                            
                            // Marquer pour suppression
                            toRemove.push(creatorsByName[name][i].index);
                        }
                        
                        console.log(` Fusionn dans une seule instance avec VAs: [${main.vaIds.join(', ')}]`);
                    }
                });
                
                // Supprimer les doublons (en partant de la fin pour ne pas dcaler les indices)
                toRemove.sort((a, b) => b - a).forEach(index => {
                    data.creators.splice(index, 1);
                });
                
                if (toRemove.length > 0) {
                    console.log(` ${toRemove.length} doublons supprims`);
                    saveData();
                    updateDisplay();
                    updateAllCreatorsTable();
                } else {
                    console.log(' Aucun doublon trouv');
                }
                
                return toRemove.length;
            };
            
            // Fonction de diagnostic pour voir ce qu'il y a dans localStorage
            window.debugStorage = function() {
                console.log(' Contenu de localStorage:');
                const keys = Object.keys(localStorage);
                console.log(`Total: ${keys.length} cls`);
                
                keys.forEach(key => {
                    if (key.includes('vaManager')) {
                        const value = localStorage.getItem(key);
                        console.log(`\n ${key}:`);
                        try {
                            const data = JSON.parse(value);
                            let twitterCount = 0;
                            if (data.vas) {
                                data.vas.forEach(va => {
                                    if (va.creators) {
                                        va.creators.forEach(creator => {
                                            twitterCount += (creator.accounts ? creator.accounts.length : 0);
                                        });
                                    }
                                });
                            }
                            console.log(`  - VAs: ${data.vas?.length || 0}`);
                            console.log(`  - Cratrices (nouvelle): ${data.creators?.length || 0}`);
                            console.log(`  - Comptes Twitter (ancienne structure): ${twitterCount}`);
                        } catch (e) {
                            console.log(`  - Taille: ${value.length} caractres`);
                        }
                    }
                });
                
                return keys.filter(k => k.includes('vaManager'));
            };
            
            // Auto-fix navigation aprs le chargement
            setTimeout(() => {
                console.log(' Auto-fixing navigation...');
                window.fixNav();
            }, 500);
            
            // Afficher l'avertissement de scurit si pas encore vu
            if (!localStorage.getItem('securityWarningDismissed')) {
                document.getElementById('security-warning').style.display = 'block';
            }
        }

        // ============================================================================
        // START APPLICATION
        // ============================================================================

        // Start the application when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();

            // Add modal close handlers
            setupModalHandlers();
        });

        // Setup modal close handlers (outside click + ESC key)
        function setupModalHandlers() {
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('show');
                }
            });

            // Close modal with ESC key
            window.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        modal.classList.remove('show');
                    });
                }
            });
        }

        // ========== DATABASE SYSTEM ==========
        
        class FileSystemDB {
            constructor() {
                this.basePath = 'D:\\claude\\va_manager\\database';
                this.supportsFileSystem = false; // DSACTIV pour viter les tlchargements
                this.directoryHandle = null;
                this.isInitialized = false;
            }
            
            async init() {
                if (this.isInitialized) return;
                
                try {
                    // File System API dsactiv - utiliser uniquement localStorage
                    console.log(' Systme de fichiers dsactiv - utilisation de localStorage uniquement');
                    this.fallbackToLocalStorage();
                    this.isInitialized = true;
                } catch (error) {
                    console.warn('Erreur initialisation:', error);
                    this.fallbackToLocalStorage();
                }
            }
            
            async migrateFromLocalStorage() {
                const savedData = localStorage.getItem('vaManagerProData');
                
                // Only migrate if user hasn't already migrated (check for migration flag)
                const migrationDone = localStorage.getItem('migrationToFileSystemDone');
                if (savedData && !migrationDone) {
                    console.log(' Migration disponible mais pas automatique - utilisez le bouton "Migrer vers Fichiers"');
                } else if (migrationDone) {
                    console.log(' Migration dj effectue');
                } else {
                    console.log(' Aucune donne  migrer');
                }
            }
            
            fallbackToLocalStorage() {
                this.supportsFileSystem = false;
                console.log('Using localStorage fallback');
            }
            
            async saveVAs(vasData) {
                // For normal saves, always use localStorage only
                const currentData = this.loadFromLocalStorage();
                currentData.vas = vasData;
                localStorage.setItem('vaManagerProData', JSON.stringify(currentData));
            }
            
            async saveSubs(subsData) {
                // For normal saves, always use localStorage only
                const currentData = this.loadFromLocalStorage();
                currentData.subs = subsData;
                localStorage.setItem('vaManagerProData', JSON.stringify(currentData));
            }
            
            async saveRevenues(revenuesData) {
                // For normal saves, always use localStorage only
                const currentData = this.loadFromLocalStorage();
                currentData.revenues = revenuesData;
                localStorage.setItem('vaManagerProData', JSON.stringify(currentData));
            }
            
            async savePayments(paymentsData) {
                // For normal saves, always use localStorage only
                const currentData = this.loadFromLocalStorage();
                currentData.vaPayments = paymentsData;
                localStorage.setItem('vaManagerProData', JSON.stringify(currentData));
            }
            
            async saveAllData() {
                // Always use localStorage for normal saves
                localStorage.setItem('vaManagerProData', JSON.stringify(data));
                
                // File system downloads only on manual migration
                return Promise.resolve();
            }
            
            downloadJSON(filename, jsonData) {
                // DSACTIV - Ne pas tlcharger automatiquement
                console.log(` Tlchargement dsactiv pour: ${filename}`);
                return Promise.resolve();
            }
            
            // Mthode pour tlchargement manuel uniquement
            manualDownloadJSON(filename, jsonData) {
                const dataStr = JSON.stringify(jsonData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                
                URL.revokeObjectURL(url);
                return Promise.resolve();
            }
            
            showFileInstructions(filename) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center;
                    justify-content: center; z-index: 10000;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; text-align: center;">
                        <h3 style="color: #16a34a; margin-bottom: 1rem;">
                            <i class="fas fa-download"></i> Fichier tlcharg
                        </h3>
                        <p style="margin-bottom: 1.5rem;">
                            Le fichier <strong>${filename}</strong> a t tlcharg.<br>
                            Veuillez le dplacer vers :<br>
                            <code style="background: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; display: block; margin: 1rem 0;">
                                D:\\claude\\va_manager\\database\\
                            </code>
                        </p>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: #16a34a; color: white; border: none; padding: 0.75rem 1.5rem;
                            border-radius: 0.5rem; cursor: pointer; font-weight: 600;
                        ">
                            Compris !
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (document.body.contains(modal)) {
                        modal.remove();
                    }
                }, 10000);
            }
            
            loadFromLocalStorage() {
                const savedData = localStorage.getItem('vaManagerProData');
                return savedData ? JSON.parse(savedData) : {
                    vas: [],
                    subs: [],
                    revenues: [],
                    payments: [],
                    vaPayments: [],
                    gmailAccounts: [],
                    creators: [],
                    twitterAccounts: [],
                    instagramAccounts: [],
                    twitterStats: []
                };
            }
        }
        
        // Initialize database system
        const fileDB = new FileSystemDB();
        
        // Rebuild VA creators for compatibility with old code
        function rebuildVACreators() {
            console.log('     RebuildVACreators - Dbut...');
            data.vas.forEach(va => {
                console.log(`      - VA "${va.name}" (ID: ${va.id})`);
                va.creators = [];
                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.vaIds && creator.vaIds.includes(va.id)) {
                            va.creators.push(creator);
                            console.log(`         Ajout cratrice "${creator.name}" avec ${creator.accounts?.length || 0} comptes`);
                        }
                    });
                }
                console.log(`        Total cratrices pour ${va.name}: ${va.creators.length}`);
            });
            console.log('     RebuildVACreators - Termin');
        }
        
        // Fonction de rcupration d'urgence pour les comptes Twitter perdus
        function recoverLostTwitterAccounts() {
            console.log(' Tentative de rcupration des comptes Twitter perdus...');
            
            try {
                // Essayer d'abord avec les donnes actuelles
                let rawData = localStorage.getItem('vaManagerData');
                
                // Si pas de donnes, essayer les backups
                if (!rawData) {
                    console.log(' Recherche dans les sauvegardes...');
                    const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('vaManager_backup_'));
                    
                    if (backupKeys.length > 0) {
                        // Trier par date (le plus rcent en premier)
                        backupKeys.sort().reverse();
                        console.log(` ${backupKeys.length} sauvegardes trouves`);
                        
                        // Essayer avec la sauvegarde la plus rcente
                        rawData = localStorage.getItem(backupKeys[0]);
                        console.log(` Utilisation de la sauvegarde: ${backupKeys[0]}`);
                    }
                }
                
                if (!rawData) {
                    console.log(' Aucune donne trouve dans localStorage ni dans les sauvegardes');
                    showError('Aucune donne de sauvegarde trouve. Les comptes Twitter semblent dfinitivement perdus.');
                    return false;
                }

                let storedData;
                try {
                    storedData = JSON.parse(rawData);
                    if (!storedData) {
                        throw new Error('Invalid stored data');
                    }
                } catch (e) {
                    console.error(' Error parsing stored data:', e);
                    showError('Les donnes de sauvegarde sont corrompues');
                    return false;
                }
                let recoveredAccounts = 0;
                
                // Parcourir les VAs dans localStorage
                storedData.vas?.forEach(storedVa => {
                    if (storedVa.creators && storedVa.creators.length > 0) {
                        storedVa.creators.forEach(storedCreator => {
                            if (storedCreator.accounts && storedCreator.accounts.length > 0) {
                                // Trouver ou crer la cratrice dans la nouvelle structure
                                let creator = data.creators.find(c => c.name === storedCreator.name);
                                
                                if (!creator) {
                                    // Crer la cratrice si elle n'existe pas
                                    creator = {
                                        id: storedCreator.id || 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                        name: storedCreator.name,
                                        vaIds: [storedVa.id],
                                        accounts: []
                                    };
                                    data.creators.push(creator);
                                    console.log(` Cratrice "${creator.name}" recre`);
                                }
                                
                                // Rcuprer les comptes
                                if (!creator.accounts) creator.accounts = [];
                                
                                storedCreator.accounts.forEach(account => {
                                    // Vrifier si le compte n'existe pas dj
                                    const exists = creator.accounts.some(a => a.username === account.username);
                                    if (!exists) {
                                        creator.accounts.push(account);
                                        recoveredAccounts++;
                                        console.log(`   Compte rcupr: ${account.username}`);
                                    }
                                });
                                
                                // S'assurer que le VA est dans la liste
                                if (!creator.vaIds) creator.vaIds = [];
                                if (!creator.vaIds.includes(storedVa.id)) {
                                    creator.vaIds.push(storedVa.id);
                                }
                            }
                        });
                    }
                });
                
                if (recoveredAccounts > 0) {
                    console.log(` ${recoveredAccounts} comptes Twitter rcuprs !`);
                    return true;
                } else {
                    console.log(' Aucun compte Twitter trouv  rcuprer');
                    return false;
                }
                
            } catch (error) {
                console.error(' Erreur lors de la rcupration:', error);
                return false;
            }
        }

        // Load data (now handled by loadAllData from Supabase)
        async function loadData() {
            // This function is kept for compatibility but data loading now happens in loadAllData()
            console.log(' loadData() called - data already loaded from Supabase');
            return;

            // OLD LOCAL STORAGE CODE - DISABLED
            /*
            await fileDB.init();

            // Load from localStorage (which may have been migrated)
            const loadedData = fileDB.loadFromLocalStorage();
            
            data.vas = loadedData.vas || [];
            data.subs = loadedData.subs || [];
            data.revenues = loadedData.revenues || [];
            data.payments = loadedData.payments || [];
            data.vaPayments = loadedData.vaPayments || [];
            data.gmailAccounts = loadedData.gmailAccounts || [];
            data.creators = loadedData.creators || [];
            data.twitterAccounts = loadedData.twitterAccounts || [];
            data.instagramAccounts = loadedData.instagramAccounts || [];
            data.twitterStats = loadedData.twitterStats || [];
            
            // Migration complte des cratrices vers la nouvelle structure
            if (!loadedData.creators || loadedData.creators.length === 0) {
                console.log(' Migration des cratrices vers la nouvelle structure...');
                data.creators = [];
                const creatorMapping = {}; // Pour garder la correspondance des IDs
                
                data.vas.forEach(va => {
                    if (va.creators && va.creators.length > 0) {
                        const newCreatorIds = [];
                        
                        va.creators.forEach(oldCreator => {
                            // Ne pas migrer les "Twitter Accounts"
                            if (oldCreator.name !== 'Twitter Accounts') {
                                // Vrifier si la cratrice existe dj dans la nouvelle structure
                                let existingCreator = data.creators.find(c => c.name === oldCreator.name);
                                
                                if (!existingCreator) {
                                    // Crer la nouvelle cratrice
                                    existingCreator = {
                                        id: oldCreator.id || 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                        name: oldCreator.name,
                                        vaIds: [va.id], // Array pour supporter plusieurs VAs
                                        accounts: oldCreator.accounts || []
                                    };
                                    data.creators.push(existingCreator);
                                } else {
                                    // Ajouter ce VA  la liste des VAs de cette cratrice
                                    if (!existingCreator.vaIds) existingCreator.vaIds = [];
                                    if (!existingCreator.vaIds.includes(va.id)) {
                                        existingCreator.vaIds.push(va.id);
                                    }
                                    // Fusionner les comptes
                                    if (oldCreator.accounts && oldCreator.accounts.length > 0) {
                                        if (!existingCreator.accounts) existingCreator.accounts = [];
                                        existingCreator.accounts = existingCreator.accounts.concat(oldCreator.accounts);
                                    }
                                }
                                
                                creatorMapping[oldCreator.id] = existingCreator.id;
                                newCreatorIds.push(existingCreator.id);
                            }
                        });
                        
                        // Remplacer l'ancienne structure par des rfrences
                        va.creatorIds = newCreatorIds;
                        delete va.creators; // Supprimer l'ancienne structure
                    }
                });
                
                console.log(` Migration termine: ${data.creators.length} cratrices migres`);
                saveData(); // Sauvegarder immdiatement aprs migration
            }
            
            // Reconstruire la proprit creators sur chaque VA pour la compatibilit
            rebuildVACreators();
            
            // Compter le nombre total de cratrices
            let totalCreators = data.creators ? data.creators.length : 0;
            
            // Diagnostic temporaire pour dboguer
            console.log(' Diagnostic des donnes:');
            console.log('Total cratrices:', totalCreators);
            let totalAccounts = 0;
            let accountsWithoutGmail = 0;
            
            // Vrifier la nouvelle structure
            console.log(' Nouvelle structure (data.creators):');
            data.creators?.forEach(creator => {
                const accounts = creator.accounts ? creator.accounts.length : 0;
                totalAccounts += accounts;
                creator.accounts?.forEach(acc => {
                    if (!acc.gmailId) accountsWithoutGmail++;
                });
                console.log(`  - ${creator.name}: ${accounts} comptes, VAs: [${creator.vaIds?.join(', ') || 'aucun'}]`);
                if (accounts > 0) {
                    creator.accounts.forEach(acc => {
                        console.log(`     ${acc.username}`);
                    });
                }
            });
            
            // Vrifier l'ancienne structure
            console.log(' Ancienne structure (va.creators):');
            let oldStructureAccounts = 0;
            data.vas?.forEach(va => {
                if (va.creators && va.creators.length > 0) {
                    console.log(`  VA: ${va.name}`);
                    va.creators.forEach(creator => {
                        const accounts = creator.accounts ? creator.accounts.length : 0;
                        oldStructureAccounts += accounts;
                        console.log(`    - ${creator.name}: ${accounts} comptes`);
                        if (accounts > 0) {
                            creator.accounts.forEach(acc => {
                                console.log(`       ${acc.username}`);
                            });
                        }
                    });
                }
            });
            
            console.log(` Total comptes dans nouvelle structure: ${totalAccounts}`);
            console.log(` Total comptes dans ancienne structure: ${oldStructureAccounts}`);
            
            // Vrifier directement dans localStorage
            console.log(' Vrification localStorage brut:');
            try {
                const rawData = localStorage.getItem('vaManagerData');
                if (rawData) {
                    const storedData = JSON.parse(rawData);
                    let localStorageAccounts = 0;
                    storedData.vas?.forEach(va => {
                        if (va.creators) {
                            va.creators.forEach(creator => {
                                localStorageAccounts += (creator.accounts ? creator.accounts.length : 0);
                            });
                        }
                    });
                    console.log(`  - Comptes dans localStorage (ancienne structure): ${localStorageAccounts}`);
                }
            } catch (e) {
                console.error('Erreur lors de la lecture de localStorage:', e);
            }
            
            console.log(' Donnes charges:', {
                vas: data.vas.length,
                creators: totalCreators,
                subs: data.subs.length,
                revenues: data.revenues.length,
                vaPayments: data.vaPayments.length,
                gmailAccounts: data.gmailAccounts.length
            });
            
            // Tenter de rcuprer les comptes Twitter perdus
            if (totalAccounts === 0 && oldStructureAccounts === 0) {
                console.log(' Aucun compte Twitter dtect - lancement de la rcupration...');
                if (recoverLostTwitterAccounts()) {
                    console.log(' Rechargement de l\'interface...');
                    updateDisplay();
                }
            }
            */
        }

        // Save data (now auto-saved to Supabase on each operation)
        // REMOVED DUPLICATE - saveData() is now defined earlier in the file (line ~5423)

        // OLD LOCALSTORAGE CODE - DISABLED
        /*
        console.log(' SAVE DATA - Dbut de la sauvegarde...');
        try {
            // Reconstruire les creators des VAs avant de sauvegarder
            console.log('   Reconstruction des creators des VAs...');
            rebuildVACreators();

            // Marquer que les donnes ont t modifies
            console.log('   Marquage des donnes comme modifies...');
            markDataModified();

            // Animation de sauvegarde
            animateSaveButton();
            updateSaveStatus('saving');

            // Sauvegarde principale
            await fileDB.saveAllData();

            // Sauvegarde de scurit dans localStorage
            const backupData = {
                timestamp: new Date().toISOString(),
                data: data
            };
            localStorage.setItem('vaManagerProData', JSON.stringify(data));
            localStorage.setItem('vaManagerProData_backup', JSON.stringify(backupData));

            // Historique des sauvegardes (garder les 10 dernires)
            updateBackupHistory(backupData);

            console.log('   Sauvegarde complte');
            console.log('   Mise  jour de l\'affichage...');
            updateDisplay();
            updateSaveStatus('saved');
            console.log(' SAVE DATA - Termin');

            // Auto backup toutes les heures
            const lastBackup = localStorage.getItem('lastAutoBackup');
            const now = Date.now();
            const oneHourMs = 60 * 60 * 1000;

            if (!lastBackup || (now - parseInt(lastBackup)) > oneHourMs) {
                await createAutoBackup();
                localStorage.setItem('lastAutoBackup', now.toString());
            }
        } catch (error) {
            console.error('Erreur sauvegarde:', error);
            updateSaveStatus('error');
            // Fallback to localStorage only
            localStorage.setItem('vaManagerProData', JSON.stringify(data));
            updateDisplay();
        }
        */

        // Animation du bouton de sauvegarde
        function animateSaveButton() {
            const pulse = document.getElementById('save-pulse');
            if (pulse) {
                pulse.style.transition = 'transform 0.6s ease-out, opacity 0.6s ease-out';
                pulse.style.transform = 'translate(-50%, -50%) scale(0)';
                pulse.style.opacity = '0';
                
                setTimeout(() => {
                    pulse.style.transform = 'translate(-50%, -50%) scale(2)';
                    pulse.style.opacity = '1';
                }, 10);
                
                setTimeout(() => {
                    pulse.style.opacity = '0';
                }, 300);
            }
        }
        
        // Mise  jour du statut de sauvegarde
        function updateSaveStatus(status) {
            const statusDiv = document.getElementById('save-status');
            const statusText = document.getElementById('save-status-text');
            const statusIcon = statusDiv.querySelector('i');
            
            switch(status) {
                case 'saving':
                    statusIcon.className = 'fas fa-spinner fa-spin';
                    statusIcon.style.color = '#f59e0b';
                    statusText.textContent = 'Sauvegarde...';
                    statusText.style.color = '#f59e0b';
                    statusDiv.style.background = 'rgba(245, 158, 11, 0.1)';
                    statusDiv.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                    break;
                case 'saved':
                    statusIcon.className = 'fas fa-shield-alt';
                    statusIcon.style.color = '#22c55e';
                    statusText.textContent = 'Protg';
                    statusText.style.color = '#22c55e';
                    statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                    statusDiv.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                    
                    // Afficher l'heure de la dernire sauvegarde aprs 2 secondes
                    setTimeout(() => {
                        const now = new Date();
                        statusText.textContent = `Sauv  ${now.toLocaleTimeString()}`;
                    }, 2000);
                    break;
                case 'error':
                    statusIcon.className = 'fas fa-exclamation-triangle';
                    statusIcon.style.color = '#ef4444';
                    statusText.textContent = 'Erreur';
                    statusText.style.color = '#ef4444';
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                    statusDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                    break;
            }
        }
        
        // Historique des sauvegardes
        function updateBackupHistory(backupData) {
            let history = [];
            try {
                const stored = localStorage.getItem('vaManagerProBackupHistory');
                if (stored) {
                    history = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Erreur lecture historique:', e);
            }
            
            // Ajouter la nouvelle sauvegarde
            history.unshift(backupData);
            
            // Garder seulement les 10 dernires
            history = history.slice(0, 10);
            
            // Sauvegarder l'historique
            localStorage.setItem('vaManagerProBackupHistory', JSON.stringify(history));
        }
        
        async function createAutoBackup() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const backupData = {
                ...data,
                backup_info: {
                    created: new Date().toISOString(),
                    type: 'auto',
                    version: '2.0.0'
                }
            };
            
            try {
                // Sauvegarder dans localStorage au lieu de tlcharger
                localStorage.setItem(`vaManagerProBackup_${timestamp}`, JSON.stringify(backupData));
                console.log(' Sauvegarde automatique cre dans localStorage');
                
                // Nettoyer les vieilles sauvegardes (garder seulement les 5 dernires)
                const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('vaManagerProBackup_')).sort();
                if (backupKeys.length > 5) {
                    const toRemove = backupKeys.slice(0, backupKeys.length - 5);
                    toRemove.forEach(key => localStorage.removeItem(key));
                }
            } catch (error) {
                console.warn(' chec sauvegarde auto:', error);
            }
        }
        
        async function migrateToFileSystem() {
            if (!confirm('Voulez-vous migrer vos donnes vers le systme de fichiers structur ?\n\nCela va tlcharger plusieurs fichiers JSON organiss par type de donnes.')) {
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            try {
                // Create organized files
                if (data.vas && data.vas.length > 0) {
                    await fileDB.downloadJSON('vas.json', {
                        vas: data.vas,
                        last_updated: new Date().toISOString(),
                        version: '2.0.0'
                    });
                }
                
                if (data.subs && data.subs.length > 0) {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    await fileDB.downloadJSON(`subs_${currentMonth}.json`, {
                        subs: data.subs,
                        month: currentMonth,
                        total_subs: data.subs.reduce((sum, s) => sum + s.count, 0),
                        total_amount: data.subs.reduce((sum, s) => sum + s.amount, 0),
                        last_updated: new Date().toISOString()
                    });
                }
                
                if (data.revenues && data.revenues.length > 0) {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    await fileDB.downloadJSON(`revenues_${currentMonth}.json`, {
                        revenues: data.revenues,
                        month: currentMonth,
                        total_amount: data.revenues.reduce((sum, r) => sum + r.amount, 0),
                        total_commissions: data.revenues.reduce((sum, r) => sum + r.commission, 0),
                        last_updated: new Date().toISOString()
                    });
                }
                
                if (data.vaPayments && data.vaPayments.length > 0) {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    await fileDB.downloadJSON(`payments_${currentMonth}.json`, {
                        vaPayments: data.vaPayments,
                        month: currentMonth,
                        total_paid: data.vaPayments.reduce((sum, p) => sum + p.amount, 0),
                        last_updated: new Date().toISOString()
                    });
                }
                
                // Create complete backup
                await fileDB.downloadJSON(`complete_backup_${timestamp}.json`, {
                    ...data,
                    migration_info: {
                        created: new Date().toISOString(),
                        type: 'migration',
                        version: '2.0.0',
                        source: 'localStorage'
                    }
                });
                
                // Mark migration as done
                localStorage.setItem('migrationToFileSystemDone', 'true');
                
                // Show success message
                alert(' Migration termine !\n\nTous vos fichiers ont t tlchargs.\nDplacez-les dans : D:\\claude\\va_manager\\database\\');
                
            } catch (error) {
                alert(' Erreur lors de la migration : ' + error.message);
            }
        }

        // Initialize Dashboard Date/Time Display
        function initDashboardDateTime() {
            const dateEl = document.getElementById('current-date-display');
            const timeEl = document.getElementById('current-time-display');

            if (!dateEl || !timeEl) return;

            const updateDateTime = () => {
                const now = new Date();

                // Format date: "Lundi 23 Dcembre 2024"
                const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const months = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin',
                               'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'];

                const dayName = days[now.getDay()];
                const day = now.getDate();
                const month = months[now.getMonth()];
                const year = now.getFullYear();

                dateEl.textContent = `${dayName} ${day} ${month} ${year}`;

                // Format time: "14:30"
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeEl.textContent = `${hours}:${minutes}`;
            };

            updateDateTime();
            // Update every minute
            setInterval(updateDateTime, 60000);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.dataset.page;
                    navigateToPage(page);
                });
            });

            // Forms
            document.getElementById('add-va-form').addEventListener('submit', addVA);
            document.getElementById('add-creator-form').addEventListener('submit', addCreator);
            document.getElementById('add-account-form').addEventListener('submit', addAccount);
            document.getElementById('add-gmail-form').addEventListener('submit', addGmailAccount);
            document.getElementById('search-input').addEventListener('input', performSearch);

            // VA selection change for account form
            // Supprim car plus besoin de slectionner la cratrice
            
            // Supprim car plus besoin de ces listeners
        }

        // Navigation
        async function navigateToPage(pageName) {
            console.log(' [NAV DEBUG] Navigating to page:', pageName);

            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const navBtn = document.querySelector(`[data-page="${pageName}"]`);
            if (navBtn) {
                navBtn.classList.add('active');
            }

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none'; // Force hide all pages
            });

            const targetPage = document.getElementById(`${pageName}-page`);
            console.log(' [NAV DEBUG] Target page element:', targetPage);

            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block'; // Force show target page
                console.log(' [NAV DEBUG] Page shown:', pageName);
            } else {
                console.error(' [NAV DEBUG] Page element not found:', `${pageName}-page`);
            }

            // Update subs display when navigating to subs tracking page
            if (pageName === 'subs-tracking') {
                updateCompetitionDisplay();
            }

            // Update revenue display when navigating to revenue tracking page
            if (pageName === 'revenue-tracking') {
                updateRevenueDisplay();
            }

            // Update financial overview when navigating to that page
            if (pageName === 'financial-overview') {
                updateFinancialOverview();
            }

            // Update warmup display when navigating to warmup page
            if (pageName === 'instagram-warmup') {
                await loadWarmupDataIfNeeded();
                updateWarmupDisplay();
            }

            // Update existing creators list when navigating to add-creator page
            if (pageName === 'add-creator') {
                updateAllCreatorsTable();
            }

            // Load Instagram stats when navigating to instagram-stats page
            if (pageName === 'instagram-stats') {
                populateInstagramAccountsSelect();
                loadInstagramStatsHistory();
                // Set today's date as default
                const dateInput = document.getElementById('instagram-stat-date');
                if (dateInput && !dateInput.value) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            }

            // Load Instagram Analytics when navigating to analytics page
            if (pageName === 'instagram-analytics') {
                loadInstagramAnalytics();
            }

            // Load Followers Tracking when navigating to followers-tracking page
            if (pageName === 'followers-tracking') {
                loadFollowersTrackingPage();
            }

            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }

            // Update VA selects when navigating to add-account page
            if (pageName === 'add-account') {
                updateVASelects();
                updateTwitterAccountsList();
                // Reset the form
                document.getElementById('add-account-form').reset();
            }

            // Update Gmail accounts when navigating to gmail-accounts page
            if (pageName === 'gmail-accounts') {
                updateGmailAccountsList();
                // Reset the form
                document.getElementById('add-gmail-form').reset();
            }

            // Load team management when navigating to team page
            if (pageName === 'team-management') {
                loadTeamManagement();
            }

            // Load admin stats when navigating to admin page
            if (pageName === 'admin') {
                loadAdminStats();
            }

            // Force dark backgrounds if dark mode is active
            if (document.body.classList.contains('dark-mode')) {
                forceAllDarkBackgrounds();
            }
        }

        // ========== ORPHAN DATA CLEANUP SYSTEM ==========
        // Find and clean orphan data
        function findOrphanData() {
            const orphans = {
                creators: {
                    withoutVA: [],
                    withDeletedVA: []
                },
                accounts: {
                    withInvalidGmail: [],
                    withDeletedCreator: []
                },
                gmail: {
                    withDeletedVA: [],
                    withInvalidTwitterRef: []
                },
                financial: {
                    subsWithDeletedVA: [],
                    revenuesWithDeletedVA: [],
                    paymentsWithDeletedVA: []
                }
            };
            
            // Find orphan creators
            if (data.creators) {
                data.creators.forEach(creator => {
                    // Creators without VA
                    if (!creator.vaIds || creator.vaIds.length === 0) {
                        orphans.creators.withoutVA.push(creator);
                    } else {
                        // Creators with deleted VAs
                        const hasValidVA = creator.vaIds.some(vaId => 
                            data.vas.find(v => v.id === vaId)
                        );
                        if (!hasValidVA) {
                            orphans.creators.withDeletedVA.push(creator);
                        }
                    }
                });
            }
            
            // Find orphan Twitter accounts
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        // Accounts with invalid Gmail reference
                        if (account.gmailId) {
                            const gmailExists = data.gmailAccounts.find(g => g.id === account.gmailId);
                            if (!gmailExists) {
                                orphans.accounts.withInvalidGmail.push({
                                    account,
                                    creator: creator.name
                                });
                            }
                        }
                    });
                }
            });
            
            // Find orphan Gmail accounts
            data.gmailAccounts.forEach(gmail => {
                // Gmail with deleted VA
                if (gmail.vaId) {
                    const vaExists = data.vas.find(v => v.id === gmail.vaId);
                    if (!vaExists) {
                        orphans.gmail.withDeletedVA.push(gmail);
                    }
                }
                
                // Gmail with invalid Twitter reference
                if (gmail.assignedTwitterUsername) {
                    let twitterExists = false;
                    data.creators.forEach(creator => {
                        if (creator.accounts) {
                            if (creator.accounts.find(a => a.username === gmail.assignedTwitterUsername)) {
                                twitterExists = true;
                            }
                        }
                    });
                    if (!twitterExists) {
                        orphans.gmail.withInvalidTwitterRef.push(gmail);
                    }
                }
            });
            
            // Find orphan financial data
            if (data.subs) {
                data.subs.forEach(sub => {
                    if (sub.vaId && !data.vas.find(v => v.id === sub.vaId)) {
                        orphans.financial.subsWithDeletedVA.push(sub);
                    }
                });
            }
            
            if (data.revenues) {
                data.revenues.forEach(revenue => {
                    if (revenue.vaId && !data.vas.find(v => v.id === revenue.vaId)) {
                        orphans.financial.revenuesWithDeletedVA.push(revenue);
                    }
                });
            }
            
            if (data.vaPayments) {
                data.vaPayments.forEach(payment => {
                    if (payment.vaId && !data.vas.find(v => v.id === payment.vaId)) {
                        orphans.financial.paymentsWithDeletedVA.push(payment);
                    }
                });
            }
            
            return orphans;
        }
        
        // Clean specific orphan data
        function cleanOrphanData(type, subtype) {
            const orphans = findOrphanData();
            let cleaned = 0;
            
            switch(type) {
                case 'creators':
                    if (subtype === 'withoutVA') {
                        orphans.creators.withoutVA.forEach(creator => {
                            const index = data.creators.findIndex(c => c.id === creator.id);
                            if (index !== -1) {
                                data.creators.splice(index, 1);
                                cleaned++;
                            }
                        });
                    } else if (subtype === 'withDeletedVA') {
                        orphans.creators.withDeletedVA.forEach(creator => {
                            creator.vaIds = [];
                            cleaned++;
                        });
                    }
                    break;
                    
                case 'accounts':
                    if (subtype === 'withInvalidGmail') {
                        orphans.accounts.withInvalidGmail.forEach(orphan => {
                            delete orphan.account.gmailId;
                            delete orphan.account.email;
                            cleaned++;
                        });
                    }
                    break;
                    
                case 'gmail':
                    if (subtype === 'withDeletedVA') {
                        orphans.gmail.withDeletedVA.forEach(gmail => {
                            delete gmail.vaId;
                            cleaned++;
                        });
                    } else if (subtype === 'withInvalidTwitterRef') {
                        orphans.gmail.withInvalidTwitterRef.forEach(gmail => {
                            delete gmail.assignedTwitter;
                            delete gmail.assignedTwitterUsername;
                            delete gmail.assignedCreatorId;
                            cleaned++;
                        });
                    }
                    break;
                    
                case 'financial':
                    if (subtype === 'subsWithDeletedVA') {
                        data.subs = data.subs.filter(sub => 
                            !orphans.financial.subsWithDeletedVA.includes(sub)
                        );
                        cleaned = orphans.financial.subsWithDeletedVA.length;
                    } else if (subtype === 'revenuesWithDeletedVA') {
                        data.revenues = data.revenues.filter(revenue => 
                            !orphans.financial.revenuesWithDeletedVA.includes(revenue)
                        );
                        cleaned = orphans.financial.revenuesWithDeletedVA.length;
                    } else if (subtype === 'paymentsWithDeletedVA') {
                        data.vaPayments = data.vaPayments.filter(payment => 
                            !orphans.financial.paymentsWithDeletedVA.includes(payment)
                        );
                        cleaned = orphans.financial.paymentsWithDeletedVA.length;
                    }
                    break;
            }
            
            if (cleaned > 0) {
                saveData();
                showSuccess(`${cleaned} donnes orphelines nettoyes`);
                updateDisplay();
            }
            
            return cleaned;
        }
        
        // Show orphan data report
        function showOrphanDataReport() {
            const orphans = findOrphanData();
            let totalOrphans = 0;
            let reportHtml = '<h3>Rapport des donnes orphelines</h3>';
            
            // Count creators
            if (orphans.creators.withoutVA.length > 0) {
                totalOrphans += orphans.creators.withoutVA.length;
                reportHtml += `<p><strong>Cratrices sans VA:</strong> ${orphans.creators.withoutVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('creators', 'withoutVA')" class="btn-danger btn-small">Supprimer</button></p>`;
            }
            
            if (orphans.creators.withDeletedVA.length > 0) {
                totalOrphans += orphans.creators.withDeletedVA.length;
                reportHtml += `<p><strong>Cratrices avec VAs supprims:</strong> ${orphans.creators.withDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('creators', 'withDeletedVA')" class="btn-warning btn-small">Nettoyer rfrences</button></p>`;
            }
            
            // Count accounts
            if (orphans.accounts.withInvalidGmail.length > 0) {
                totalOrphans += orphans.accounts.withInvalidGmail.length;
                reportHtml += `<p><strong>Comptes Twitter avec Gmail invalide:</strong> ${orphans.accounts.withInvalidGmail.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('accounts', 'withInvalidGmail')" class="btn-warning btn-small">Nettoyer rfrences</button></p>`;
            }
            
            // Count Gmail
            if (orphans.gmail.withDeletedVA.length > 0) {
                totalOrphans += orphans.gmail.withDeletedVA.length;
                reportHtml += `<p><strong>Gmail avec VA supprim:</strong> ${orphans.gmail.withDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('gmail', 'withDeletedVA')" class="btn-warning btn-small">Nettoyer rfrences</button></p>`;
            }
            
            if (orphans.gmail.withInvalidTwitterRef.length > 0) {
                totalOrphans += orphans.gmail.withInvalidTwitterRef.length;
                reportHtml += `<p><strong>Gmail avec Twitter invalide:</strong> ${orphans.gmail.withInvalidTwitterRef.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('gmail', 'withInvalidTwitterRef')" class="btn-warning btn-small">Nettoyer rfrences</button></p>`;
            }
            
            // Count financial
            if (orphans.financial.subsWithDeletedVA.length > 0) {
                totalOrphans += orphans.financial.subsWithDeletedVA.length;
                reportHtml += `<p><strong>Subs avec VA supprim:</strong> ${orphans.financial.subsWithDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('financial', 'subsWithDeletedVA')" class="btn-danger btn-small">Supprimer</button></p>`;
            }
            
            if (orphans.financial.revenuesWithDeletedVA.length > 0) {
                totalOrphans += orphans.financial.revenuesWithDeletedVA.length;
                reportHtml += `<p><strong>Revenus avec VA supprim:</strong> ${orphans.financial.revenuesWithDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('financial', 'revenuesWithDeletedVA')" class="btn-danger btn-small">Supprimer</button></p>`;
            }
            
            if (orphans.financial.paymentsWithDeletedVA.length > 0) {
                totalOrphans += orphans.financial.paymentsWithDeletedVA.length;
                reportHtml += `<p><strong>Paiements avec VA supprim:</strong> ${orphans.financial.paymentsWithDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('financial', 'paymentsWithDeletedVA')" class="btn-danger btn-small">Supprimer</button></p>`;
            }
            
            if (totalOrphans === 0) {
                reportHtml += '<p style="color: #10b981;"> Aucune donne orpheline dtecte!</p>';
            } else {
                reportHtml += `<hr><p><strong>Total:</strong> ${totalOrphans} donnes orphelines`;
                reportHtml += ` <button onclick="cleanAllOrphanData()" class="btn-danger">Tout nettoyer</button></p>`;
            }
            
            // Show in modal
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Nettoyage des donnes</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="modal-body">
                        ${reportHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Clean all orphan data
        function cleanAllOrphanData() {
            if (confirm('tes-vous sr de vouloir nettoyer toutes les donnes orphelines?')) {
                let totalCleaned = 0;
                totalCleaned += cleanOrphanData('creators', 'withoutVA');
                totalCleaned += cleanOrphanData('creators', 'withDeletedVA');
                totalCleaned += cleanOrphanData('accounts', 'withInvalidGmail');
                totalCleaned += cleanOrphanData('gmail', 'withDeletedVA');
                totalCleaned += cleanOrphanData('gmail', 'withInvalidTwitterRef');
                totalCleaned += cleanOrphanData('financial', 'subsWithDeletedVA');
                totalCleaned += cleanOrphanData('financial', 'revenuesWithDeletedVA');
                totalCleaned += cleanOrphanData('financial', 'paymentsWithDeletedVA');
                
                showSuccess(`Total nettoy: ${totalCleaned} donnes orphelines`);
                document.querySelector('.modal.show').remove();
            }
        }
        
        // ========== UNIFIED VIEW SYSTEM ==========
        // Central entity renderer
        function renderEntity(type, data, viewMode = 'card', options = {}) {
            const renderers = {
                'va': renderVAEntity,
                'creator': renderCreatorEntity
            };
            
            return renderers[type] ? renderers[type](data, viewMode, options) : '';
        }
        
        // Render VA entity
        function renderVAEntity(va, viewMode, options) {
            const creators = data.creators.filter(c => c.vaIds && c.vaIds.includes(va.id));
            const totalAccounts = creators.reduce((sum, c) => sum + (c.accounts ? c.accounts.length : 0), 0);
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            switch(viewMode) {
                case 'card':
                    return `
                        <div class="va-card" data-va-id="${va.id}">
                            <div class="va-header">
                                <h3><i class="fas fa-user-tie"></i> ${va.name}</h3>
                                <div class="va-stats">
                                    <span>${creators.length} cratrices</span>
                                    <span>${totalAccounts} comptes</span>
                                </div>
                            </div>
                            <div class="va-content">
                                ${creators.length === 0 ? 
                                    '<p class="no-data">Aucune cratrice assigne</p>' :
                                    creators.map(c => renderEntity('creator', c, 'compact', {vaId: va.id})).join('')
                                }
                            </div>
                            ${options.showActions ? `
                                <div class="va-actions">
                                    <button onclick="deleteVA('${va.id}')" class="btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                case 'option':
                    return `<option value="${va.id}">${va.name} (${creators.length} cratrices)</option>`;
                default:
                    return '';
            }
        }
        
        // Render Creator entity
        function renderCreatorEntity(creator, viewMode, options) {
            const accountCount = creator.accounts ? creator.accounts.length : 0;
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            switch(viewMode) {
                case 'compact':
                    return `
                        <div class="creator-compact" onclick="viewCreator('${options.vaId || ''}', '${creator.id}')">
                            <span class="creator-name">${creator.name}</span>
                            <span class="creator-count">${accountCount}</span>
                        </div>
                    `;
                default:
                    return '';
            }
        }
        
        // Calculate all statistics in one pass
        function calculateGlobalStatistics() {
            console.log('     CalculateGlobalStatistics - Dbut...');
            console.log('     DEBUG - tat des donnes:');
            console.log('      - data.twitterAccounts:', data.twitterAccounts);
            console.log('      - data.instagramAccounts:', data.instagramAccounts);
            console.log('      - data.creators:', data.creators);

            // Debug each creator's nested arrays
            console.log('     DEBUG - Dtail des creators:');
            if (data.creators) {
                data.creators.forEach((creator, index) => {
                    console.log(`      Creator #${index}: "${creator.name}"`);
                    console.log(`        - creator.accounts:`, creator.accounts);
                    console.log(`        - creator.instagramAccounts:`, creator.instagramAccounts);
                    console.log(`        - Twitter count: ${creator.accounts?.length || 0}`);
                    console.log(`        - Instagram count: ${creator.instagramAccounts?.length || 0}`);
                });
            }

            const stats = {
                vas: data.vas.length,
                creators: data.creators ? data.creators.length : 0,
                twitterTotal: 0,
                instagramTotal: 0,
                gmailTotal: data.gmailAccounts.length,
                monthlyRevenue: 0
            };

            // Count Twitter accounts from data.twitterAccounts
            if (data.twitterAccounts) {
                stats.twitterTotal = data.twitterAccounts.length;
                console.log('       Twitter compt depuis data.twitterAccounts:', stats.twitterTotal, 'comptes');
            } else {
                console.log('       data.twitterAccounts est undefined ou null');
            }

            // Count Instagram accounts from data.instagramAccounts
            if (data.instagramAccounts) {
                stats.instagramTotal = data.instagramAccounts.length;
                console.log('       Instagram compt depuis data.instagramAccounts:', stats.instagramTotal, 'comptes');
            } else {
                console.log('       data.instagramAccounts est undefined ou null');
            }

            // Count from nested structure (for comparison)
            let twitterFromCreators = 0;
            let instagramFromCreators = 0;
            if (data.creators) {
                data.creators.forEach(creator => {
                    twitterFromCreators += creator.accounts?.length || 0;
                    instagramFromCreators += creator.instagramAccounts?.length || 0;
                });
            }
            console.log('     Comparaison comptes (plat vs imbriqu):');
            console.log('      - Twitter: plat=' + stats.twitterTotal + ', imbriqu=' + twitterFromCreators);
            console.log('      - Instagram: plat=' + stats.instagramTotal + ', imbriqu=' + instagramFromCreators);

            console.log('     Comptes compts:', {
                twitter: stats.twitterTotal,
                instagram: stats.instagramTotal,
                total: stats.twitterTotal + stats.instagramTotal
            });

            // Calculate monthly revenue
            const savedPeriod = currentFinancialPeriod;
            currentFinancialPeriod = 'current-month';
            const filteredSubs = getFilteredSubsForFinancial();
            const filteredRevenues = getFilteredRevenuesForFinancial();
            stats.monthlyRevenue = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0) +
                                  filteredRevenues.reduce((sum, rev) => sum + rev.amount, 0);
            currentFinancialPeriod = savedPeriod;

            return stats;
        }
        
        // Update display with unified system
        function updateDisplay() {
            const stats = calculateGlobalStatistics();
            const totalAccounts = stats.twitterTotal + stats.instagramTotal;

            // Update global stats - batch DOM updates (legacy elements)
            const vasElement = document.getElementById('total-vas');
            const creatorsElement = document.getElementById('total-creators');
            const accountsElement = document.getElementById('total-accounts');

            if (vasElement) vasElement.textContent = stats.vas;
            if (creatorsElement) creatorsElement.textContent = stats.creators;
            if (accountsElement) accountsElement.textContent = totalAccounts;

            // Update NEW dashboard pro elements
            const dashCreators = document.getElementById('dash-creators-count');
            const dashVas = document.getElementById('dash-vas-count');
            const dashTwitter = document.getElementById('dash-twitter-count');
            const dashInstagram = document.getElementById('dash-instagram-count');

            if (dashCreators) dashCreators.textContent = stats.creators;
            if (dashVas) dashVas.textContent = stats.vas;
            if (dashTwitter) dashTwitter.textContent = stats.twitterTotal;
            if (dashInstagram) dashInstagram.textContent = stats.instagramTotal;

            // Update section badges
            const creatorsCountBadge = document.getElementById('creators-count-badge');
            const twitterCountBadge = document.getElementById('twitter-count-badge');
            const instagramCountBadge = document.getElementById('instagram-count-badge');
            const vaGridCountBadge = document.getElementById('va-grid-count-badge');

            if (creatorsCountBadge) {
                creatorsCountBadge.innerHTML = `<i class="fas fa-circle" style="font-size: 0.5rem; color: #8b5cf6;"></i> ${stats.creators} cratrice${stats.creators > 1 ? 's' : ''}`;
            }
            if (twitterCountBadge) {
                twitterCountBadge.innerHTML = `<i class="fas fa-circle" style="font-size: 0.5rem; color: #1da1f2;"></i> ${stats.twitterTotal} compte${stats.twitterTotal > 1 ? 's' : ''}`;
            }
            if (instagramCountBadge) {
                instagramCountBadge.innerHTML = `<i class="fas fa-circle" style="font-size: 0.5rem; color: #e1306c;"></i> ${stats.instagramTotal} compte${stats.instagramTotal > 1 ? 's' : ''}`;
            }
            if (vaGridCountBadge) {
                vaGridCountBadge.innerHTML = `<i class="fas fa-circle" style="font-size: 0.5rem; color: #10b981;"></i> ${stats.vas} VA${stats.vas > 1 ? 's' : ''}`;
            }

            // Update banned accounts alert
            updateBannedAccountsAlert();

            // Update active accounts by creator
            const activeAccountsContainer = document.getElementById('active-accounts-by-creator');
            if (activeAccountsContainer) {
                const creatorStats = {};

                // Compter les comptes actifs par cratrice et stocker les comptes
                data.creators.forEach(creator => {
                    if (creator.instagramAccounts) {
                        const activeAccounts = creator.instagramAccounts.filter(acc => acc.status !== 'banned');
                        const bannedAccounts = creator.instagramAccounts.filter(acc => acc.status === 'banned');
                        creatorStats[creator.name] = {
                            active: activeAccounts.length,
                            total: creator.instagramAccounts.length,
                            activeAccounts: activeAccounts,
                            bannedAccounts: bannedAccounts
                        };
                    }
                });

                // Gnrer le HTML avec design ultra moderne adapt au mode sombre
                const isDarkMode = document.body.classList.contains('dark-mode');

                const statsHTML = Object.entries(creatorStats)
                    .sort((a, b) => b[1].active - a[1].active)
                    .map(([name, counts]) => {
                        // Trouver la cratrice pour rcuprer sa photo
                        const creatorObj = data.creators.find(c => c.name === name);
                        const percentage = counts.total > 0 ? (counts.active / counts.total * 100) : 0;

                        // Fond neutre pour un meilleur contraste avec les bordures colores
                        const cardBg = isDarkMode
                            ? 'linear-gradient(135deg, rgba(26, 29, 35, 0.6), rgba(30, 32, 40, 0.8))'
                            : 'linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.95))';

                        const borderColor = percentage >= 80
                            ? '#31C950'
                            : percentage >= 50
                            ? '#31C950'
                            : '#ef4444';

                        const iconBg = percentage >= 80
                            ? 'linear-gradient(135deg, #31C950, #22a03d)'
                            : percentage >= 50
                            ? 'linear-gradient(135deg, #31C950, #22a03d)'
                            : 'linear-gradient(135deg, #fb7185, #f43f5e)';

                        const barGradient = percentage >= 80
                            ? 'linear-gradient(90deg, #31C950, #22a03d)'
                            : percentage >= 50
                            ? 'linear-gradient(90deg, #31C950, #22a03d)'
                            : 'linear-gradient(90deg, #fb7185, #f43f5e)';

                        // Couleurs de texte adaptes au mode
                        const nameColor = isDarkMode ? '#e1e8ef' : '#0f172a';
                        const subtitleColor = isDarkMode ? '#9ca3af' : '#64748b';
                        const labelColor = isDarkMode ? '#9ca3af' : '#64748b';
                        const countColor = isDarkMode ? '#cbd5e1' : '#94a3b8';

                        // Effet brillant adapt au mode
                        const shineEffect = isDarkMode
                            ? 'radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%)'
                            : 'radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%)';

                        // Ombres adaptes
                        const cardShadow = isDarkMode
                            ? '0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05) inset'
                            : '0 8px 32px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.5) inset';

                        const hoverShadow = isDarkMode
                            ? `0 20px 40px rgba(0, 0, 0, 0.5), 0 0 0 3px ${borderColor}33`
                            : `0 20px 40px rgba(0, 0, 0, 0.15), 0 0 0 3px ${borderColor}33`;

                        const avatarShadow = isDarkMode
                            ? `0 8px 24px ${borderColor}40, 0 0 0 3px rgba(255, 255, 255, 0.1)`
                            : `0 8px 24px ${borderColor}40, 0 0 0 3px rgba(255, 255, 255, 0.9)`;

                        const progressBg = isDarkMode
                            ? 'rgba(148, 163, 184, 0.1)'
                            : 'rgba(148, 163, 184, 0.15)';

                        return `
                        <div style="
                            position: relative;
                            background: ${cardBg};
                            backdrop-filter: blur(10px);
                            border-radius: 1.5rem;
                            padding: 1.5rem;
                            border: 2px solid ${borderColor};
                            box-shadow: ${cardShadow};
                            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                            cursor: pointer;
                            overflow: hidden;
                        " onmouseover="
                            this.style.transform='translateY(-8px) scale(1.02)';
                            this.style.boxShadow='${hoverShadow}';
                        " onmouseout="
                            this.style.transform='translateY(0) scale(1)';
                            this.style.boxShadow='${cardShadow}';
                        ">
                            <!-- Effet brillant d'arrire-plan -->
                            <div style="position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: ${shineEffect}; pointer-events: none;"></div>

                            <!-- Header avec avatar et nom -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; position: relative;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="
                                        width: 56px;
                                        height: 56px;
                                        background: ${creatorObj && creatorObj.photo_url ? 'transparent' : iconBg};
                                        border-radius: 18px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 1.75rem;
                                        box-shadow: ${avatarShadow};
                                        transform: rotate(-5deg);
                                        transition: transform 0.3s ease;
                                        overflow: hidden;
                                    " onmouseover="this.style.transform='rotate(0deg) scale(1.1)'" onmouseout="this.style.transform='rotate(-5deg) scale(1)'">
                                        ${creatorObj && creatorObj.photo_url
                                            ? `<img src="${creatorObj.photo_url}" style="width: 100%; height: 100%; object-fit: cover;">`
                                            : ''
                                        }
                                    </div>
                                    <div>
                                        <div style="font-weight: 800; font-size: 1.15rem; color: ${nameColor}; letter-spacing: -0.5px;">${name}</div>
                                        <div style="font-size: 0.75rem; color: ${subtitleColor}; font-weight: 500; margin-top: 2px;">Cratrice de contenu</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="
                                        font-weight: 900;
                                        font-size: 2rem;
                                        line-height: 1;
                                        background: ${barGradient};
                                        -webkit-background-clip: text;
                                        -webkit-text-fill-color: transparent;
                                        background-clip: text;
                                    ">
                                        ${counts.active}
                                    </div>
                                    <div style="font-size: 0.7rem; color: ${countColor}; font-weight: 600; margin-top: 4px;">
                                        / ${counts.total} comptes
                                    </div>
                                </div>
                            </div>

                            <!-- Barre de progression moderne -->
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.7rem; font-weight: 700; color: ${labelColor}; text-transform: uppercase; letter-spacing: 0.5px;">Progression</span>
                                    <span style="font-size: 0.85rem; font-weight: 800; color: ${borderColor};">${percentage.toFixed(0)}%</span>
                                </div>
                                <div style="
                                    position: relative;
                                    background: ${progressBg};
                                    height: 14px;
                                    border-radius: 20px;
                                    overflow: hidden;
                                    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
                                ">
                                    <div style="
                                        background: ${barGradient};
                                        height: 100%;
                                        width: ${percentage}%;
                                        border-radius: 20px;
                                        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
                                        box-shadow: 0 0 12px ${borderColor}60;
                                        position: relative;
                                        overflow: hidden;
                                    ">
                                        <div style="
                                            position: absolute;
                                            top: 0;
                                            left: 0;
                                            right: 0;
                                            bottom: 0;
                                            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
                                            animation: shimmer 2s infinite;
                                        "></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats badges -->
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <div onclick="showAccountsModal('${name}', 'active')" style="
                                    flex: 1;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                    background: linear-gradient(135deg, #31C950, #22a03d);
                                    color: white;
                                    padding: 0.65rem 1rem;
                                    border-radius: 12px;
                                    font-size: 0.8rem;
                                    font-weight: 700;
                                    box-shadow: 0 4px 12px rgba(49, 201, 80, 0.3);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(49, 201, 80, 0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(49, 201, 80, 0.3)';">
                                    <div style="
                                        width: 24px;
                                        height: 24px;
                                        background: rgba(255, 255, 255, 0.25);
                                        border-radius: 8px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 0.7rem;
                                    "></div>
                                    <span>${counts.active} Actifs</span>
                                </div>
                                <div onclick="showAccountsModal('${name}', 'banned')" style="
                                    flex: 1;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                    background: linear-gradient(135deg, #ef4444, #dc2626);
                                    color: white;
                                    padding: 0.65rem 1rem;
                                    border-radius: 12px;
                                    font-size: 0.8rem;
                                    font-weight: 700;
                                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                                    border: 1px solid rgba(255, 255, 255, 0.3);
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)';">
                                    <div style="
                                        width: 24px;
                                        height: 24px;
                                        background: rgba(255, 255, 255, 0.25);
                                        border-radius: 8px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 0.7rem;
                                    "></div>
                                    <span>${counts.total - counts.active} Bannis</span>
                                </div>
                            </div>
                        </div>
                        <style>
                            @keyframes shimmer {
                                0% { transform: translateX(-100%); }
                                100% { transform: translateX(100%); }
                            }
                        </style>
                    `;
                    }).join('');

                activeAccountsContainer.innerHTML = statsHTML || '<span style="opacity: 0.7;">Aucun compte</span>';

                // Fonction pour afficher la modale des comptes
                window.showAccountsModal = function(creatorName, type) {
                    const stats = creatorStats[creatorName];
                    if (!stats) return;

                    const accounts = type === 'active' ? stats.activeAccounts : stats.bannedAccounts;
                    const title = type === 'active'
                        ? ` Comptes Actifs - ${creatorName}`
                        : ` Comptes Bannis - ${creatorName}`;
                    const color = type === 'active' ? '#31C950' : '#ef4444';

                    const isDark = document.body.classList.contains('dark-mode');
                    const bgColor = isDark ? '#1a1d23' : '#ffffff';
                    const textColor = isDark ? '#e1e8ef' : '#1a1a1a';
                    const borderColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                    const accountsList = accounts.map(acc => `
                        <div style="
                            background: ${isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.02)'};
                            padding: 1rem;
                            border-radius: 0.75rem;
                            border: 1px solid ${borderColor};
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='${isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.04)'}'" onmouseout="this.style.background='${isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.02)'}'">
                            <div style="
                                width: 40px;
                                height: 40px;
                                background: linear-gradient(135deg, ${color}, ${color}dd);
                                border-radius: 12px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-weight: 700;
                            ">
                                ${type === 'active' ? '' : ''}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1rem; color: ${textColor};">@${acc.username}</div>
                                ${acc.email ? `<div style="font-size: 0.875rem; color: ${isDark ? '#9ca3af' : '#64748b'}; margin-top: 0.25rem;">${acc.email}</div>` : ''}
                            </div>
                        </div>
                    `).join('');

                    const modalHTML = `
                        <div id="accounts-modal" style="
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.75);
                            backdrop-filter: blur(8px);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10000;
                            padding: 1rem;
                        " onclick="if(event.target.id === 'accounts-modal') this.remove()">
                            <div style="
                                background: ${bgColor};
                                border-radius: 1.5rem;
                                max-width: 600px;
                                width: 100%;
                                max-height: 80vh;
                                overflow: hidden;
                                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                                border: 2px solid ${color};
                            " onclick="event.stopPropagation()">
                                <!-- Header -->
                                <div style="
                                    background: linear-gradient(135deg, ${color}, ${color}dd);
                                    color: white;
                                    padding: 1.5rem;
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                ">
                                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 800;">${title}</h3>
                                    <button onclick="document.getElementById('accounts-modal').remove()" style="
                                        background: rgba(255, 255, 255, 0.2);
                                        border: none;
                                        color: white;
                                        width: 32px;
                                        height: 32px;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 1.25rem;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        transition: background 0.2s ease;
                                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'"></button>
                                </div>

                                <!-- Content -->
                                <div style="
                                    padding: 1.5rem;
                                    max-height: calc(80vh - 100px);
                                    overflow-y: auto;
                                ">
                                    ${accounts.length > 0 ? `
                                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                            ${accountsList}
                                        </div>
                                    ` : `
                                        <div style="text-align: center; padding: 2rem; color: ${isDark ? '#9ca3af' : '#64748b'};">
                                            Aucun compte ${type === 'active' ? 'actif' : 'banni'}
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;

                    // Supprimer l'ancienne modale si elle existe
                    const existingModal = document.getElementById('accounts-modal');
                    if (existingModal) existingModal.remove();

                    // Ajouter la nouvelle modale
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                };
            }

            // Update other displays - batched for performance
            updateCreatorsStats();
            updateVAGrid();
            updateVAListDisplay();
            updateVASelects();
            updateGmailAccountsList();
            updateTwitterUnassignedDisplay();
            updateTwitterFormSelects();
            updateTwitterRankingTable();
            updateTwitterAnalytics();
            updateTwitterTopAccounts();
            updateFollowersDashboardSection();
            updateInstagramTopAccounts();
            updateCreatorsCardsGrid();
        }

        // Update banned accounts alert on dashboard
        function updateBannedAccountsAlert() {
            const alertEl = document.getElementById('banned-accounts-alert');
            const messageEl = document.getElementById('banned-accounts-message');

            if (!alertEl || !messageEl) return;

            // Count banned accounts
            let bannedTwitter = 0;
            let bannedInstagram = 0;

            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        bannedTwitter += creator.accounts.filter(a => a.status === 'banned').length;
                    }
                    if (creator.instagramAccounts) {
                        bannedInstagram += creator.instagramAccounts.filter(a => a.status === 'banned').length;
                    }
                });
            }

            const totalBanned = bannedTwitter + bannedInstagram;

            if (totalBanned > 0) {
                alertEl.style.display = 'flex';
                const parts = [];
                if (bannedTwitter > 0) parts.push(`${bannedTwitter} Twitter`);
                if (bannedInstagram > 0) parts.push(`${bannedInstagram} Instagram`);
                messageEl.textContent = `${totalBanned} compte${totalBanned > 1 ? 's' : ''} banni${totalBanned > 1 ? 's' : ''}: ${parts.join(', ')}`;
            } else {
                alertEl.style.display = 'none';
            }
        }

        // Update creators cards grid on dashboard
        function updateCreatorsCardsGrid() {
            const container = document.getElementById('creators-cards-grid');
            if (!container || !data.creators) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            if (data.creators.length === 0) {
                container.innerHTML = `
                    <div class="dash-empty-state">
                        <i class="fas fa-users"></i>
                        <p>Aucune cratrice ajoute</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.creators.map(creator => {
                const twitterCount = creator.accounts ? creator.accounts.length : 0;
                const instagramCount = creator.instagramAccounts ? creator.instagramAccounts.length : 0;
                const activeTw = creator.accounts ? creator.accounts.filter(a => a.status !== 'banned').length : 0;
                const activeIg = creator.instagramAccounts ? creator.instagramAccounts.filter(a => a.status !== 'banned').length : 0;

                return `
                    <div class="dash-creator-card" onclick="navigateToPage('creators')">
                        <div class="dash-creator-avatar">
                            ${creator.photo_url
                                ? `<img src="${creator.photo_url}" alt="${creator.name}">`
                                : `<i class="fas fa-user"></i>`
                            }
                        </div>
                        <div class="dash-creator-info">
                            <div class="dash-creator-name">${creator.name}</div>
                            <div class="dash-creator-stats">
                                <span class="twitter"><i class="fab fa-twitter"></i> ${activeTw}/${twitterCount}</span>
                                <span class="instagram"><i class="fab fa-instagram"></i> ${activeIg}/${instagramCount}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update monthly revenue on dashboard

        // Update stats (now uses unified statistics)
        function updateStats() {
            // This is now handled by updateDisplay()
            // Kept for backward compatibility
        }

        // Update VA list display in Add VA page
        function updateVAListDisplay() {
            const container = document.getElementById('va-list-display');
            const countEl = document.getElementById('va-list-count');

            if (!container || !countEl) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            // Update count
            countEl.textContent = `${data.vas.length} VA${data.vas.length > 1 ? 's' : ''}`;

            if (data.vas.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                        <i class="fas fa-user-slash" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.125rem;">Aucun VA ajout pour le moment</p>
                        <p style="font-size: 0.875rem; opacity: 0.7;">Utilisez le formulaire ci-dessus pour ajouter votre premier VA</p>
                    </div>
                `;
                return;
            }

            // Generate VA cards
            container.innerHTML = data.vas.map(va => {
                // Count creators and accounts for this VA
                let creatorsCount = 0;
                let twitterCount = 0;
                let instagramCount = 0;

                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.vaIds && creator.vaIds.includes(va.id)) {
                            creatorsCount++;
                            // Count Twitter accounts
                            if (creator.accounts) {
                                const filteredTwitter = creator.accounts.filter(account => {
                                    if (creator.vaIds.length === 1) return true;
                                    return account.assignedVaId === va.id;
                                });
                                twitterCount += filteredTwitter.length;
                            }
                            // Count Instagram accounts
                            if (creator.instagramAccounts) {
                                const filteredInstagram = creator.instagramAccounts.filter(account => {
                                    if (creator.vaIds.length === 1) return true;
                                    return account.assignedVaId === va.id;
                                });
                                instagramCount += filteredInstagram.length;
                            }
                        }
                    });
                }

                const totalAccounts = twitterCount + instagramCount;

                return `
                    <div style="
                        background: ${isDarkMode ? 'linear-gradient(135deg, #16181d 0%, #1a1d23 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)'};
                        border: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};
                        border-radius: 1.25rem;
                        padding: 1.75rem;
                        box-shadow: ${isDarkMode ? '0 4px 20px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.05)'};
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        cursor: pointer;
                        position: relative;
                        overflow: hidden;
                    "
                    onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='${isDarkMode ? '0 12px 35px rgba(0, 0, 0, 0.4)' : '0 8px 25px rgba(102, 126, 234, 0.15)'}'; this.style.borderColor='${isDarkMode ? 'rgba(102, 126, 234, 0.3)' : 'rgba(102, 126, 234, 0.2)'}'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='${isDarkMode ? '0 4px 20px rgba(0, 0, 0, 0.3)' : '0 2px 10px rgba(0, 0, 0, 0.05)'}'; this.style.borderColor='${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'}'"
                    onclick="navigateToPage('dashboard')">

                        <!-- Decorative background circle -->
                        <div style="
                            position: absolute;
                            top: -30px;
                            right: -30px;
                            width: 140px;
                            height: 140px;
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            opacity: 0.05;
                            border-radius: 50%;
                            pointer-events: none;
                        "></div>

                        <!-- VA Header -->
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; position: relative;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <!-- Avatar with icon container -->
                                <div style="
                                    width: 64px;
                                    height: 64px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border-radius: 1rem;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 1.75rem;
                                    font-weight: 700;
                                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
                                    letter-spacing: -0.02em;
                                    position: relative;
                                    transition: all 0.3s ease;
                                ">
                                    ${va.name.charAt(0).toUpperCase()}
                                    <!-- Active status indicator -->
                                    <div style="
                                        position: absolute;
                                        bottom: -2px;
                                        right: -2px;
                                        width: 18px;
                                        height: 18px;
                                        background: #10b981;
                                        border: 3px solid ${isDarkMode ? '#1a1d23' : '#ffffff'};
                                        border-radius: 50%;
                                        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
                                    "></div>
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.375rem; font-weight: 700; color: ${isDarkMode ? '#f3f4f6' : '#1e293b'}; letter-spacing: -0.01em; line-height: 1.3;">
                                        ${va.name}
                                    </h3>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: ${isDarkMode ? '#9ca3af' : '#64748b'}; font-weight: 500;">
                                        <i class="fas fa-user-tie" style="font-size: 0.75rem; margin-right: 0.375rem;"></i>Virtual Assistant
                                    </p>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteVA('${va.id}')"
                                    style="background: ${isDarkMode ? 'rgba(239, 68, 68, 0.15)' : 'rgba(239, 68, 68, 0.1)'};
                                           border: 1px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.25)' : 'rgba(239, 68, 68, 0.2)'};
                                           border-radius: 0.625rem;
                                           width: 40px;
                                           height: 40px;
                                           display: flex;
                                           align-items: center;
                                           justify-content: center;
                                           cursor: pointer;
                                           transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                                           color: #ef4444;
                                           font-size: 0.875rem;
                                           position: relative;
                                           overflow: hidden;"
                                    onmouseover="this.style.background='rgba(239, 68, 68, 0.25)'; this.style.transform='scale(1.05)'; this.style.borderColor='rgba(239, 68, 68, 0.4)'"
                                    onmouseout="this.style.background='${isDarkMode ? 'rgba(239, 68, 68, 0.15)' : 'rgba(239, 68, 68, 0.1)'}'; this.style.transform='scale(1)'; this.style.borderColor='${isDarkMode ? 'rgba(239, 68, 68, 0.25)' : 'rgba(239, 68, 68, 0.2)'}'"
                                    title="Supprimer ce VA">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <!-- Stats Grid with Icons -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.625rem; margin-bottom: 1.25rem;">
                            <!-- Creators Stat -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(139, 92, 246, 0.08)' : 'rgba(139, 92, 246, 0.04)'};
                                padding: 0.75rem 0.5rem;
                                border-radius: 0.875rem;
                                border: 1px solid ${isDarkMode ? 'rgba(139, 92, 246, 0.15)' : 'rgba(139, 92, 246, 0.12)'};
                                text-align: center;
                                transition: all 0.2s ease;
                            "
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.background='${isDarkMode ? 'rgba(139, 92, 246, 0.12)' : 'rgba(139, 92, 246, 0.08)'}'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.background='${isDarkMode ? 'rgba(139, 92, 246, 0.08)' : 'rgba(139, 92, 246, 0.04)'}'">
                                <i class="fas fa-user-friends" style="font-size: 1.125rem; color: #8b5cf6; margin-bottom: 0.5rem; display: block;"></i>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.25rem; line-height: 1;">
                                    ${creatorsCount}
                                </div>
                                <div style="font-size: 0.6875rem; color: ${isDarkMode ? '#a78bfa' : '#7c3aed'}; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Cratrice${creatorsCount > 1 ? 's' : ''}
                                </div>
                            </div>

                            <!-- Twitter Stat -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(29, 161, 242, 0.08)' : 'rgba(29, 161, 242, 0.04)'};
                                padding: 0.75rem 0.5rem;
                                border-radius: 0.875rem;
                                border: 1px solid ${isDarkMode ? 'rgba(29, 161, 242, 0.15)' : 'rgba(29, 161, 242, 0.12)'};
                                text-align: center;
                                transition: all 0.2s ease;
                            "
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.background='${isDarkMode ? 'rgba(29, 161, 242, 0.12)' : 'rgba(29, 161, 242, 0.08)'}'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.background='${isDarkMode ? 'rgba(29, 161, 242, 0.08)' : 'rgba(29, 161, 242, 0.04)'}'">
                                <i class="fab fa-twitter" style="font-size: 1.125rem; color: #1da1f2; margin-bottom: 0.5rem; display: block;"></i>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #1da1f2; margin-bottom: 0.25rem; line-height: 1;">
                                    ${twitterCount}
                                </div>
                                <div style="font-size: 0.6875rem; color: ${isDarkMode ? '#60a5fa' : '#0c85d0'}; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Twitter
                                </div>
                            </div>

                            <!-- Instagram Stat -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(193, 53, 132, 0.08)' : 'rgba(193, 53, 132, 0.04)'};
                                padding: 0.75rem 0.5rem;
                                border-radius: 0.875rem;
                                border: 1px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.15)' : 'rgba(193, 53, 132, 0.12)'};
                                text-align: center;
                                transition: all 0.2s ease;
                            "
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.background='${isDarkMode ? 'rgba(193, 53, 132, 0.12)' : 'rgba(193, 53, 132, 0.08)'}'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.background='${isDarkMode ? 'rgba(193, 53, 132, 0.08)' : 'rgba(193, 53, 132, 0.04)'}'">
                                <i class="fab fa-instagram" style="font-size: 1.125rem; color: #c13584; margin-bottom: 0.5rem; display: block;"></i>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #c13584; margin-bottom: 0.25rem; line-height: 1;">
                                    ${instagramCount}
                                </div>
                                <div style="font-size: 0.6875rem; color: ${isDarkMode ? '#f472b6' : '#c13584'}; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Instagram
                                </div>
                            </div>
                        </div>

                        <!-- Total Badge -->
                        <div style="text-align: center; padding-top: 1.25rem; border-top: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.06)' : 'rgba(0, 0, 0, 0.06)'}; position: relative;">
                            <span style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 0.625rem 1.25rem;
                                border-radius: 9999px;
                                font-size: 0.8125rem;
                                font-weight: 700;
                                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
                                display: inline-flex;
                                align-items: center;
                                gap: 0.5rem;
                                letter-spacing: 0.02em;
                                transition: all 0.2s ease;
                            "
                            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.35)'"
                            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.25)'">
                                <i class="fas fa-chart-bar" style="font-size: 0.875rem;"></i>
                                ${totalAccounts} Compte${totalAccounts > 1 ? 's' : ''} Total
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update Twitter Ranking Table - Rcapitulatif des cratrices
        function updateTwitterRankingTable() {
            const cardsGrid = document.getElementById('creators-cards-grid');
            const countBadge = document.getElementById('creators-count-badge');
            if (!cardsGrid) return;

            const isDarkMode = document.body.classList.contains('dark-mode');
            console.log(' updateTwitterRankingTable - isDarkMode:', isDarkMode);
            
            // Collecter les donnes par cratrice
            const creatorsData = [];
            
            if (data.creators) {
                data.creators.forEach(creator => {
                    const creatorInfo = {
                        name: creator.name,
                        photo_url: creator.photo_url || null,
                        twitterCount: creator.accounts ? creator.accounts.length : 0,
                        instagramCount: creator.instagramAccounts ? creator.instagramAccounts.length : 0,
                        twitterAccounts: [],
                        instagramAccounts: [],
                        vas: new Set(),
                        gmailOkCount: 0
                    };
                    
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(account => {
                            creatorInfo.twitterAccounts.push(account.username);
                            
                            // Trouver le VA
                            if (account.assignedVaId) {
                                const va = data.vas.find(v => v.id === account.assignedVaId);
                                if (va) creatorInfo.vas.add(va.name);
                            } else if (creator.vaIds && creator.vaIds.length > 0) {
                                creator.vaIds.forEach(vaId => {
                                    const va = data.vas.find(v => v.id === vaId);
                                    if (va) creatorInfo.vas.add(va.name);
                                });
                            }
                            
                            // Vrifier Gmail
                            let hasGmail = false;
                            
                            // Check dans l'ancien systme
                            if (data.twitterAccounts) {
                                const oldAccount = data.twitterAccounts.find(ta => 
                                    ta.username && ta.username.toLowerCase() === account.username.toLowerCase()
                                );
                                if (oldAccount && oldAccount.gmailId) hasGmail = true;
                            }
                            
                            // Check si le compte a un gmailId directement
                            if (account.gmailId) hasGmail = true;
                            
                            // Check dans les comptes Gmail
                            if (data.gmailAccounts) {
                                const gmail = data.gmailAccounts.find(g => 
                                    g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                                );
                                if (gmail) hasGmail = true;
                            }
                            
                            if (hasGmail) creatorInfo.gmailOkCount++;
                        });
                    }

                    // Ajouter les comptes Instagram
                    if (creator.instagramAccounts && creator.instagramAccounts.length > 0) {
                        creator.instagramAccounts.forEach(account => {
                            creatorInfo.instagramAccounts.push(account.username);

                            // Trouver le VA
                            if (account.assignedVaId) {
                                const va = data.vas.find(v => v.id === account.assignedVaId);
                                if (va) creatorInfo.vas.add(va.name);
                            } else if (creator.vaIds && creator.vaIds.length > 0) {
                                creator.vaIds.forEach(vaId => {
                                    const va = data.vas.find(v => v.id === vaId);
                                    if (va) creatorInfo.vas.add(va.name);
                                });
                            }
                        });
                    }

                    creatorsData.push(creatorInfo);
                });
            }
            
            // Trier par nombre de comptes Twitter dcroissant
            creatorsData.sort((a, b) => b.twitterCount - a.twitterCount);

            // Update count badge
            if (countBadge) {
                countBadge.textContent = `${creatorsData.length} cratrice${creatorsData.length > 1 ? 's' : ''}`;
            }

            // Si aucune cratrice
            if (creatorsData.length === 0) {
                cardsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                        <i class="fas fa-user-slash" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.125rem;">Aucune cratrice ajoute</p>
                    </div>
                `;
                return;
            }

            // Gnrer les cartes modernes
            cardsGrid.innerHTML = creatorsData.map((creator, index) => {
                const rank = index + 1;
                let rankBadge = '';

                if (rank === 1) {
                    rankBadge = `<div style="position: absolute; top: -8px; right: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); z-index: 10;">
                        <i class="fas fa-crown" style="color: white; font-size: 1rem;"></i>
                    </div>`;
                } else if (rank === 2) {
                    rankBadge = `<div style="position: absolute; top: -8px; right: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(156, 163, 175, 0.4); z-index: 10;">
                        <i class="fas fa-medal" style="color: white; font-size: 1rem;"></i>
                    </div>`;
                } else if (rank === 3) {
                    rankBadge = `<div style="position: absolute; top: -8px; right: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4); z-index: 10;">
                        <i class="fas fa-award" style="color: white; font-size: 1rem;"></i>
                    </div>`;
                }

                const vasArray = Array.from(creator.vas);
                const vasDisplay = vasArray.length > 0 ?
                    vasArray.map(va => `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.625rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: 500;">${va}</span>`).join(' ') :
                    `<span style="color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; font-size: 0.75rem;">Aucun VA</span>`;

                const gmailPercentage = creator.twitterCount > 0 ? Math.round((creator.gmailOkCount / creator.twitterCount) * 100) : 0;
                const gmailColor = gmailPercentage === 100 ? '#10b981' : gmailPercentage >= 50 ? '#f59e0b' : '#ef4444';

                const cardId = `creator-card-${index}`;

                return `
                    <div style="
                        position: relative;
                        background: ${isDarkMode ? 'linear-gradient(135deg, #16181d 0%, #1a1d23 100%)' : 'white'};
                        border: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};
                        border-radius: 1rem;
                        padding: 1.5rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(139, 92, 246, 0.15)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)'">

                        ${rankBadge}

                        <!-- Header avec avatar -->
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.25rem; padding-bottom: 1rem; border-bottom: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};">
                            <div style="
                                width: 56px;
                                height: 56px;
                                background: ${creator.photo_url ? 'transparent' : 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)'};
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 1.5rem;
                                font-weight: 700;
                                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
                                flex-shrink: 0;
                                overflow: hidden;
                            ">
                                ${creator.photo_url
                                    ? `<img src="${creator.photo_url}" style="width: 100%; height: 100%; object-fit: cover;">`
                                    : creator.name.charAt(0).toUpperCase()
                                }
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h4 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${creator.name}
                                </h4>
                                <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    ${vasDisplay}
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                            <!-- Twitter -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.75rem;
                                border: 1px solid ${isDarkMode ? 'rgba(29, 161, 242, 0.2)' : 'rgba(29, 161, 242, 0.15)'};
                                text-align: center;
                            ">
                                <i class="fab fa-twitter" style="color: #1da1f2; font-size: 1.25rem; margin-bottom: 0.375rem;"></i>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1da1f2; margin-bottom: 0.125rem;">
                                    ${creator.twitterCount}
                                </div>
                                <div style="font-size: 0.7rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Twitter
                                </div>
                            </div>

                            <!-- Instagram -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.75rem;
                                border: 1px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.2)' : 'rgba(193, 53, 132, 0.15)'};
                                text-align: center;
                            ">
                                <i class="fab fa-instagram" style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.25rem; margin-bottom: 0.375rem;"></i>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #c13584; margin-bottom: 0.125rem;">
                                    ${creator.instagramCount}
                                </div>
                                <div style="font-size: 0.7rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Instagram
                                </div>
                            </div>

                            <!-- Gmail -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(234, 67, 53, 0.1)' : 'rgba(234, 67, 53, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.75rem;
                                border: 1px solid ${isDarkMode ? `rgba(234, 67, 53, 0.2)` : `rgba(234, 67, 53, 0.15)`};
                                text-align: center;
                            ">
                                <i class="fas fa-envelope" style="color: ${gmailColor}; font-size: 1.25rem; margin-bottom: 0.375rem;"></i>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${gmailColor}; margin-bottom: 0.125rem;">
                                    ${gmailPercentage}%
                                </div>
                                <div style="font-size: 0.7rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Gmail OK
                                </div>
                            </div>
                        </div>

                        <!-- Details Button -->
                        <button onclick="toggleCreatorDetails('${cardId}')" style="
                            width: 100%;
                            padding: 0.625rem;
                            background: ${isDarkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.05)'};
                            border: 1px solid ${isDarkMode ? 'rgba(139, 92, 246, 0.2)' : 'rgba(139, 92, 246, 0.15)'};
                            border-radius: 0.5rem;
                            color: #8b5cf6;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                        "
                        onmouseover="this.style.background='${isDarkMode ? 'rgba(139, 92, 246, 0.15)' : 'rgba(139, 92, 246, 0.1)'}'"
                        onmouseout="this.style.background='${isDarkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.05)'}'">
                            <span id="${cardId}-toggle-text">Voir les comptes</span>
                            <i id="${cardId}-toggle-icon" class="fas fa-chevron-down" style="font-size: 0.75rem; transition: transform 0.3s ease;"></i>
                        </button>

                        <!-- Expandable Details -->
                        <div id="${cardId}-details" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};">
                            ${creator.twitterAccounts.length > 0 ? `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                                        <i class="fab fa-twitter" style="color: #1da1f2;"></i> Comptes Twitter
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                        ${creator.twitterAccounts.map(username => {
                                            const twitterUrl = `https://twitter.com/${username.replace('@', '')}`;
                                            return `<a href="${twitterUrl}" target="_blank" style="
                                                background: ${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'};
                                                color: #1da1f2;
                                                padding: 0.375rem 0.625rem;
                                                border-radius: 0.5rem;
                                                font-size: 0.75rem;
                                                text-decoration: none;
                                                border: 1px solid ${isDarkMode ? 'rgba(29, 161, 242, 0.2)' : 'rgba(29, 161, 242, 0.15)'};
                                                transition: all 0.2s ease;
                                                display: inline-flex;
                                                align-items: center;
                                                gap: 0.25rem;
                                            "
                                            onmouseover="this.style.background='rgba(29, 161, 242, 0.15)'"
                                            onmouseout="this.style.background='${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'}'">
                                                <i class="fab fa-twitter"></i> ${username}
                                            </a>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${creator.instagramAccounts.length > 0 ? `
                                <div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                                        <i class="fab fa-instagram" style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i> Comptes Instagram
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                        ${creator.instagramAccounts.map(username => {
                                            const instagramUrl = `https://instagram.com/${username.replace('@', '')}`;
                                            return `<a href="${instagramUrl}" target="_blank" style="
                                                background: ${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'};
                                                color: #c13584;
                                                padding: 0.375rem 0.625rem;
                                                border-radius: 0.5rem;
                                                font-size: 0.75rem;
                                                text-decoration: none;
                                                border: 1px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.2)' : 'rgba(193, 53, 132, 0.15)'};
                                                transition: all 0.2s ease;
                                                display: inline-flex;
                                                align-items: center;
                                                gap: 0.25rem;
                                            "
                                            onmouseover="this.style.background='rgba(193, 53, 132, 0.15)'"
                                            onmouseout="this.style.background='${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'}'">
                                                <i class="fab fa-instagram"></i> ${username}
                                            </a>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle creator details expand/collapse
        function toggleCreatorDetails(cardId) {
            const detailsDiv = document.getElementById(`${cardId}-details`);
            const toggleIcon = document.getElementById(`${cardId}-toggle-icon`);
            const toggleText = document.getElementById(`${cardId}-toggle-text`);

            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                toggleIcon.style.transform = 'rotate(180deg)';
                toggleText.textContent = 'Masquer les comptes';
            } else {
                detailsDiv.style.display = 'none';
                toggleIcon.style.transform = 'rotate(0deg)';
                toggleText.textContent = 'Voir les comptes';
            }
        }

        // Update Twitter Top Accounts on Dashboard - PRO VERSION
        let currentTwitterFilter = 'all';
        let currentTwitterView = 'table';

        // Toggle between table and grid view
        function setTwitterView(view) {
            currentTwitterView = view;
            const tableBtn = document.getElementById('twitter-view-table');
            const gridBtn = document.getElementById('twitter-view-grid');
            const leaderboard = document.getElementById('twitter-leaderboard');
            const gridContainer = document.getElementById('twitter-top-accounts');

            if (view === 'table') {
                tableBtn.classList.add('active');
                gridBtn.classList.remove('active');
                leaderboard.style.display = 'block';
                gridContainer.style.display = 'none';
            } else {
                tableBtn.classList.remove('active');
                gridBtn.classList.add('active');
                leaderboard.style.display = 'none';
                gridContainer.style.display = 'grid';
            }
        }

        async function updateTwitterTopAccounts(filterCreator = 'all') {
            const container = document.getElementById('twitter-top-accounts');
            const leaderboardBody = document.getElementById('twitter-leaderboard-body');
            const tabsContainer = document.getElementById('twitter-creator-tabs');
            const badge = document.getElementById('twitter-count-badge');
            const isDarkMode = document.body.classList.contains('dark-mode');

            currentTwitterFilter = filterCreator;

            try {
                // Rcuprer tous les comptes Twitter
                const allTwitterAccounts = data.twitterAccounts || [];

                if (!allTwitterAccounts || allTwitterAccounts.length === 0) {
                    leaderboardBody.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: var(--dash-text-muted);">
                            <i class="fab fa-twitter" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            <p style="font-size: 1.125rem;">Aucun compte Twitter disponible</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem; opacity: 0.7;">Ajoutez des comptes Twitter pour voir le classement</p>
                        </div>
                    `;
                    badge.textContent = '0 comptes';
                    if (tabsContainer) tabsContainer.innerHTML = '';
                    // Reset KPIs
                    document.getElementById('twitter-kpi-total').textContent = '0';
                    document.getElementById('twitter-kpi-today').textContent = '+0';
                    document.getElementById('twitter-kpi-week').textContent = '+0';
                    document.getElementById('twitter-kpi-avg').textContent = '0%';
                    return;
                }

                // Grouper par cratrice
                const accountsByCreator = new Map();
                allTwitterAccounts.forEach(account => {
                    const creator = data.creators.find(c => c.id === account.creatorId);
                    const creatorName = creator ? creator.name : 'Sans cratrice';

                    if (!accountsByCreator.has(creatorName)) {
                        accountsByCreator.set(creatorName, []);
                    }
                    accountsByCreator.get(creatorName).push(account);
                });

                // Gnrer les tabs de filtres avec classes CSS
                let tabsHtml = `
                    <button class="dash-tab twitter ${filterCreator === 'all' ? 'active' : ''}" onclick="updateTwitterTopAccounts('all')">
                        Tous (${allTwitterAccounts.length})
                    </button>
                `;

                accountsByCreator.forEach((accounts, creatorName) => {
                    tabsHtml += `
                        <button class="dash-tab twitter ${filterCreator === creatorName ? 'active' : ''}" onclick="updateTwitterTopAccounts('${creatorName.replace(/'/g, "\\'")}')">
                            ${creatorName} (${accounts.length})
                        </button>
                    `;
                });

                if (tabsContainer) tabsContainer.innerHTML = tabsHtml;

                // Filtrer les comptes selon le filtre actif
                const filteredAccounts = filterCreator === 'all'
                    ? allTwitterAccounts
                    : allTwitterAccounts.filter(account => {
                        const creator = data.creators.find(c => c.id === account.creatorId);
                        const creatorName = creator ? creator.name : 'Sans cratrice';
                        return creatorName === filterCreator;
                    });

                badge.textContent = `${filteredAccounts.length} compte${filteredAccounts.length > 1 ? 's' : ''}`;

                // Charger les stats de followers pour chaque compte
                const accountsWithStats = await Promise.all(filteredAccounts.slice(0, 20).map(async (account) => {
                    let followerStats = [];
                    let latestFollowers = null;
                    let todayGrowth = null;
                    let weekGrowth = null;

                    try {
                        if (typeof getTwitterStatsByUsername === 'function') {
                            const cleanUsername = account.username.replace('@', '');
                            followerStats = await getTwitterStatsByUsername(cleanUsername);

                            if (followerStats && followerStats.length > 0) {
                                latestFollowers = followerStats[0].followers;

                                if (followerStats.length > 1) {
                                    todayGrowth = followerStats[0].followers - followerStats[1].followers;
                                }

                                // Calcul croissance semaine (7 jours)
                                if (followerStats.length >= 7) {
                                    weekGrowth = followerStats[0].followers - followerStats[6].followers;
                                } else if (followerStats.length > 1) {
                                    weekGrowth = followerStats[0].followers - followerStats[followerStats.length - 1].followers;
                                }
                            }
                        }
                    } catch (e) {
                        console.log('Erreur chargement stats followers dashboard:', e);
                    }

                    return { ...account, followerStats, latestFollowers, todayGrowth, weekGrowth };
                }));

                // Trier par nombre de followers (dcroissant)
                accountsWithStats.sort((a, b) => (b.latestFollowers || 0) - (a.latestFollowers || 0));

                // === CALCUL DES KPIs GLOBAUX ===
                let totalFollowers = 0;
                let totalTodayGrowth = 0;
                let totalWeekGrowth = 0;
                let accountsWithData = 0;

                accountsWithStats.forEach(account => {
                    if (account.latestFollowers) {
                        totalFollowers += account.latestFollowers;
                        accountsWithData++;
                    }
                    if (account.todayGrowth) totalTodayGrowth += account.todayGrowth;
                    if (account.weekGrowth) totalWeekGrowth += account.weekGrowth;
                });

                // Calcul croissance moyenne en %
                let avgGrowthPercent = 0;
                if (totalFollowers > 0 && totalWeekGrowth !== 0) {
                    avgGrowthPercent = ((totalWeekGrowth / (totalFollowers - totalWeekGrowth)) * 100).toFixed(1);
                }

                // Mise  jour des KPIs
                document.getElementById('twitter-kpi-total').textContent = totalFollowers.toLocaleString();
                document.getElementById('twitter-kpi-today').textContent = (totalTodayGrowth >= 0 ? '+' : '') + totalTodayGrowth.toLocaleString();
                document.getElementById('twitter-kpi-week').textContent = (totalWeekGrowth >= 0 ? '+' : '') + totalWeekGrowth.toLocaleString();
                document.getElementById('twitter-kpi-avg').textContent = avgGrowthPercent + '%';

                // === GNRATION DU TABLEAU LEADERBOARD ===
                let tableHtml = '';
                accountsWithStats.forEach((account, index) => {
                    const rank = index + 1;
                    const creator = data.creators.find(c => c.id === account.creatorId);
                    const creatorName = creator ? creator.name : 'Sans creatrice';
                    const creatorPhoto = creator ? creator.photo_url : null;

                    const vaId = account.vaId || account.assignedVaId;
                    const va = vaId ? data.vas.find(v => v.id === vaId) : null;
                    const vaName = va ? va.name : 'Non assigne';

                    // Classe de rang
                    let rankClass = 'default';
                    let rankContent = rank;
                    if (rank === 1) { rankClass = 'gold'; rankContent = '<i class="fas fa-crown"></i>'; }
                    else if (rank === 2) { rankClass = 'silver'; }
                    else if (rank === 3) { rankClass = 'bronze'; }

                    // Classe de croissance
                    const growthClass = (account.todayGrowth || 0) > 0 ? 'positive' : (account.todayGrowth || 0) < 0 ? 'negative' : 'neutral';
                    const growthIcon = (account.todayGrowth || 0) > 0 ? 'arrow-up' : (account.todayGrowth || 0) < 0 ? 'arrow-down' : 'minus';

                    tableHtml += `
                        <div class="dash-twitter-row" onclick="openTwitterAccountDetail('${account.username.replace('@', '').replace(/'/g, "\\'")}')">
                            <div class="dash-twitter-col-rank">
                                <div class="dash-twitter-rank ${rankClass}">${rankContent}</div>
                            </div>
                            <div class="dash-twitter-account">
                                <div class="dash-twitter-avatar">
                                    ${creatorPhoto
                                        ? `<img src="${creatorPhoto}" alt="${creatorName}">`
                                        : `<i class="fab fa-twitter"></i>`
                                    }
                                </div>
                                <div class="dash-twitter-account-info">
                                    <a href="https://x.com/${account.username}" target="_blank" class="dash-twitter-username" onclick="event.stopPropagation()">
                                        @${account.username}
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    <div class="dash-twitter-creator">${creatorName}</div>
                                </div>
                            </div>
                            <div class="dash-twitter-followers">${account.latestFollowers ? account.latestFollowers.toLocaleString() : '-'}</div>
                            <div class="dash-twitter-growth ${growthClass}">
                                <i class="fas fa-${growthIcon}"></i>
                                <span>${account.todayGrowth !== null ? ((account.todayGrowth >= 0 ? '+' : '') + account.todayGrowth) : '-'}</span>
                            </div>
                            <div class="dash-twitter-trend">
                                <canvas id="table-sparkline-${account.username.replace('@', '').replace(/[^a-zA-Z0-9]/g, '_')}"></canvas>
                            </div>
                            <div class="dash-twitter-va">
                                <span class="dash-twitter-va-badge">${vaName}</span>
                            </div>
                        </div>
                    `;
                });

                if (tableHtml === '') {
                    tableHtml = `
                        <div style="text-align: center; padding: 3rem; color: var(--dash-text-muted);">
                            <i class="fab fa-twitter" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            <p style="font-size: 1.125rem;">Aucun compte pour cette creatrice</p>
                        </div>
                    `;
                }

                leaderboardBody.innerHTML = tableHtml;

                // === GNRATION DES CARTES (pour vue grille) ===
                let gridHtml = '';
                accountsWithStats.forEach((account, index) => {
                    const rank = index + 1;
                    const creator = data.creators.find(c => c.id === account.creatorId);
                    const creatorName = creator ? creator.name : 'Sans creatrice';
                    const creatorPhoto = creator ? creator.photo_url : null;

                    const vaId = account.vaId || account.assignedVaId;
                    const va = vaId ? data.vas.find(v => v.id === vaId) : null;
                    const vaName = va ? va.name : 'Non assigne';

                    let rankBadge = '';
                    if (rank === 1) {
                        rankBadge = `<div class="dash-rank-badge gold"><i class="fas fa-crown"></i></div>`;
                    } else if (rank === 2) {
                        rankBadge = `<div class="dash-rank-badge silver">2</div>`;
                    } else if (rank === 3) {
                        rankBadge = `<div class="dash-rank-badge bronze">3</div>`;
                    }

                    gridHtml += `
                        <div class="dash-account-card twitter" onclick="openTwitterAccountDetail('${account.username.replace('@', '').replace(/'/g, "\\'")}')">
                            ${rankBadge}
                            <div class="dash-account-header">
                                <div class="dash-account-avatar twitter">
                                    ${creatorPhoto
                                        ? `<img src="${creatorPhoto}" alt="${creatorName}">`
                                        : `<i class="fab fa-twitter"></i>`
                                    }
                                </div>
                                <div class="dash-account-info">
                                    <a href="https://x.com/${account.username}" target="_blank" class="dash-account-username" onclick="event.stopPropagation()">
                                        @${account.username}
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    <div class="dash-account-creator">${creatorName}</div>
                                </div>
                            </div>
                            <div class="dash-account-meta">
                                <span class="dash-account-meta-label"><i class="fas fa-users"></i> Followers</span>
                                <span class="dash-account-meta-value">${account.latestFollowers ? account.latestFollowers.toLocaleString() : '-'}</span>
                            </div>
                            <div class="dash-account-meta" style="margin-top: 0.5rem;">
                                <span class="dash-account-meta-label"><i class="fas fa-chart-line"></i> Aujourd'hui</span>
                                <span class="dash-account-meta-value" style="color: ${(account.todayGrowth || 0) >= 0 ? '#10b981' : '#ef4444'}">
                                    ${account.todayGrowth !== null ? ((account.todayGrowth >= 0 ? '+' : '') + account.todayGrowth) : '-'}
                                </span>
                            </div>
                            <div class="dash-account-meta" style="margin-top: 0.5rem;">
                                <span class="dash-account-meta-label"><i class="fas fa-user-tie"></i> VA</span>
                                <span class="dash-account-meta-value">${vaName}</span>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = gridHtml;

                // Initialiser les mini-sparklines du tableau
                setTimeout(() => {
                    accountsWithStats.forEach(account => {
                        if (account.followerStats && account.followerStats.length > 1) {
                            const canvasId = `table-sparkline-${account.username.replace('@', '').replace(/[^a-zA-Z0-9]/g, '_')}`;
                            createMiniSparkline(canvasId, account.followerStats, isDarkMode);
                        }
                    });
                }, 100);

            } catch (error) {
                console.error('Error updating Twitter top accounts:', error);
                leaderboardBody.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        <p>Erreur lors du chargement des comptes Twitter</p>
                    </div>
                `;
            }
        }

        // Update Instagram Top Accounts on Dashboard
        let currentInstagramFilter = 'all'; // Global filter state

        async function updateInstagramTopAccounts(filterCreator = 'all') {
            const container = document.getElementById('instagram-top-accounts');
            const tabsContainer = document.getElementById('instagram-creator-tabs');
            const badge = document.getElementById('instagram-count-badge');
            const isDarkMode = document.body.classList.contains('dark-mode');

            currentInstagramFilter = filterCreator;

            try {
                // Rcuprer les stats Instagram depuis Supabase
                const instagramStats = await getAllInstagramStats();

                if (!instagramStats || instagramStats.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                            <i class="fab fa-instagram" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p style="font-size: 1.125rem;">Aucune donne Instagram disponible</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem; opacity: 0.7;">Ajoutez des statistiques pour vos comptes Instagram pour voir le classement</p>
                        </div>
                    `;
                    badge.textContent = '0 comptes';
                    return;
                }

                // Grouper par compte et prendre la dernire stat pour chaque compte
                const accountsMap = new Map();
                instagramStats.forEach(stat => {
                    const existing = accountsMap.get(stat.username);
                    if (!existing || new Date(stat.date) > new Date(existing.date)) {
                        accountsMap.set(stat.username, stat);
                    }
                });

                // Convertir en array et trier par followers_count
                const allAccounts = Array.from(accountsMap.values())
                    .sort((a, b) => b.followers_count - a.followers_count);

                // Grouper par cratrice
                const accountsByCreator = new Map();
                allAccounts.forEach(stat => {
                    const instagramAccount = data.instagramAccounts.find(acc =>
                        acc.username.toLowerCase() === stat.username.toLowerCase()
                    );
                    const creator = instagramAccount ? data.creators.find(c => c.id === instagramAccount.creatorId) : null;
                    const creatorName = creator ? creator.name : 'Sans cratrice';

                    if (!accountsByCreator.has(creatorName)) {
                        accountsByCreator.set(creatorName, []);
                    }
                    accountsByCreator.get(creatorName).push({ stat, instagramAccount });
                });

                // Gnrer les tabs de filtres avec classes CSS
                let tabsHtml = `
                    <button class="dash-tab instagram ${filterCreator === 'all' ? 'active' : ''}" onclick="updateInstagramTopAccounts('all')">
                        Tous (${allAccounts.length})
                    </button>
                `;

                accountsByCreator.forEach((accounts, creatorName) => {
                    tabsHtml += `
                        <button class="dash-tab instagram ${filterCreator === creatorName ? 'active' : ''}" onclick="updateInstagramTopAccounts('${creatorName.replace(/'/g, "\\'")}')">
                            ${creatorName} (${accounts.length})
                        </button>
                    `;
                });

                tabsContainer.innerHTML = tabsHtml;

                // Filtrer les comptes selon le filtre actif
                const filteredAccounts = filterCreator === 'all'
                    ? allAccounts
                    : allAccounts.filter(stat => {
                        const instagramAccount = data.instagramAccounts.find(acc =>
                            acc.username.toLowerCase() === stat.username.toLowerCase()
                        );
                        const creator = instagramAccount ? data.creators.find(c => c.id === instagramAccount.creatorId) : null;
                        const creatorName = creator ? creator.name : 'Sans cratrice';
                        return creatorName === filterCreator;
                    });

                badge.textContent = `${filteredAccounts.length} compte${filteredAccounts.length > 1 ? 's' : ''}`;

                // Gnrer les cartes
                let html = '';
                filteredAccounts.slice(0, 20).forEach((stat, index) => {
                    const rank = index + 1;
                    const instagramAccount = data.instagramAccounts.find(acc =>
                        acc.username.toLowerCase() === stat.username.toLowerCase()
                    );
                    html += generateInstagramCard(stat, instagramAccount, rank, isDarkMode);
                });

                if (html === '') {
                    html = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                            <i class="fab fa-instagram" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                            <p style="font-size: 1.125rem;">Aucun compte pour cette cratrice</p>
                        </div>
                    `;
                }

                container.innerHTML = html;
            } catch (error) {
                console.error(' Error updating Instagram top accounts:', error);
                container.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #ef4444;">Erreur lors du chargement des comptes Instagram</div>`;
            }
        }

        function generateInstagramCard(stat, instagramAccount, rank, isDarkMode) {
            const instagramUrl = `https://instagram.com/${stat.username.replace('@', '')}`;
            const creator = instagramAccount ? data.creators.find(c => c.id === instagramAccount.creatorId) : null;
            const va = instagramAccount && instagramAccount.vaId ? data.vas.find(v => v.id === instagramAccount.vaId) : null;

            // Badge de classement
            let rankBadge = '';
            if (rank === 1) {
                rankBadge = `<div style="position: absolute; top: -8px; left: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); z-index: 10;">
                    <i class="fas fa-crown" style="color: white; font-size: 1rem;"></i>
                </div>`;
            } else if (rank === 2) {
                rankBadge = `<div style="position: absolute; top: -8px; left: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(156, 163, 175, 0.4); z-index: 10;">
                    <i class="fas fa-medal" style="color: white; font-size: 1rem;"></i>
                </div>`;
            } else if (rank === 3) {
                rankBadge = `<div style="position: absolute; top: -8px; left: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4); z-index: 10;">
                    <i class="fas fa-award" style="color: white; font-size: 1rem;"></i>
                </div>`;
            }

            return `
                        <div style="
                            position: relative;
                            background: ${isDarkMode ? 'linear-gradient(135deg, #16181d 0%, #1a1d23 100%)' : 'white'};
                            border: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};
                            border-radius: 1rem;
                            padding: 1.5rem;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                            transition: all 0.3s ease;
                        "
                        onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(193, 53, 132, 0.15)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)'">

                            ${rankBadge}

                            <!-- Header -->
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="
                                    width: 48px;
                                    height: 48px;
                                    background: linear-gradient(135deg, #833ab4, #c13584);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 1.5rem;
                                    font-weight: 700;
                                    flex-shrink: 0;
                                ">
                                    #${rank}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <a href="${instagramUrl}" target="_blank" style="
                                        font-size: 1.125rem;
                                        font-weight: 600;
                                        color: ${isDarkMode ? '#f1f5f9' : '#1f2937'};
                                        text-decoration: none;
                                        display: block;
                                        white-space: nowrap;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                    " onmouseover="this.style.color='#c13584'" onmouseout="this.style.color='${isDarkMode ? '#f1f5f9' : '#1f2937'}'">
                                        <i class="fab fa-instagram"></i> ${stat.username}
                                    </a>
                                    ${creator ? `
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; margin-top: 0.25rem;">
                                            ${creator.name}${va ? `  ${va.name}` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Stats -->
                            <div style="display: grid; grid-template-columns: ${stat.engagement_rate ? 'repeat(2, 1fr)' : '1fr'}; gap: 0.75rem;">
                                <div style="
                                    background: ${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'};
                                    padding: 0.75rem;
                                    border-radius: 0.75rem;
                                    text-align: center;
                                ">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #c13584;">
                                        ${stat.followers_count.toLocaleString()}
                                    </div>
                                    <div style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase;">
                                        Followers
                                    </div>
                                </div>
                                ${stat.engagement_rate ? `
                                    <div style="
                                        background: ${isDarkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.05)'};
                                        padding: 0.75rem;
                                        border-radius: 0.75rem;
                                        text-align: center;
                                    ">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">
                                            ${stat.engagement_rate}%
                                        </div>
                                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase;">
                                            Engagement
                                        </div>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Date -->
                            <div style="margin-top: 0.75rem; text-align: center; font-size: 0.75rem; color: ${isDarkMode ? '#64748b' : '#94a3b8'};">
                                <i class="fas fa-calendar"></i> ${new Date(stat.date).toLocaleDateString('fr-FR')}
                            </div>
                        </div>
                    `;
        }

        // Populate Instagram accounts dropdown in stats form
        function populateInstagramAccountsSelect() {
            const select = document.getElementById('instagram-stat-account');
            if (!select) return;

            select.innerHTML = '<option value="">Slectionner un compte...</option>';

            if (data.instagramAccounts && data.instagramAccounts.length > 0) {
                data.instagramAccounts.forEach(account => {
                    const creator = data.creators.find(c => c.id === account.creatorId);
                    const va = account.vaId ? data.vas.find(v => v.id === account.vaId) : null;

                    const label = `${account.username}${creator ? ` - ${creator.name}` : ''}${va ? ` (${va.name})` : ''}`;

                    const option = document.createElement('option');
                    option.value = JSON.stringify({
                        username: account.username,
                        creator_id: account.creatorId,
                        va_id: account.vaId
                    });
                    option.textContent = label;
                    select.appendChild(option);
                });
            }
        }

        // Handle add Instagram stat form submission
        async function handleAddInstagramStat(event) {
            event.preventDefault();

            let accountData;
            try {
                accountData = JSON.parse(document.getElementById('instagram-stat-account').value);
                if (!accountData || !accountData.username) {
                    throw new Error('Invalid account data');
                }
            } catch (error) {
                console.error(' Error parsing account data:', error);
                showError('Donnes de compte invalides');
                return;
            }

            const date = document.getElementById('instagram-stat-date').value;
            const followersCount = parseInt(document.getElementById('instagram-stat-followers').value);
            const engagementRate = document.getElementById('instagram-stat-engagement').value;
            const followingCount = document.getElementById('instagram-stat-following').value;
            const postsCount = document.getElementById('instagram-stat-posts').value;

            try {
                await createInstagramStat({
                    username: accountData.username,
                    date: date,
                    followers_count: followersCount,
                    engagement_rate: engagementRate ? parseFloat(engagementRate) : null,
                    following_count: followingCount ? parseInt(followingCount) : null,
                    posts_count: postsCount ? parseInt(postsCount) : null,
                    creator_id: accountData.creator_id,
                    va_id: accountData.va_id
                });

                showSuccess(' Statistiques Instagram enregistres avec succs !');

                // Reset form
                document.getElementById('add-instagram-stat-form').reset();

                // Reload stats history and dashboard
                await loadInstagramStatsHistory();
                await updateInstagramTopAccounts();

            } catch (error) {
                console.error(' Error adding Instagram stat:', error);
                showError('Erreur lors de l\'enregistrement des statistiques');
            }
        }

        // Load Instagram stats history
        async function loadInstagramStatsHistory() {
            const container = document.getElementById('instagram-stats-history');
            if (!container) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            try {
                const instagramStats = await getAllInstagramStats();

                // Populate filter dropdown
                const filterSelect = document.getElementById('stats-filter-account');
                if (filterSelect && instagramStats.length > 0) {
                    const uniqueAccounts = [...new Set(instagramStats.map(s => s.username))].sort();
                    const currentValue = filterSelect.value;
                    filterSelect.innerHTML = `
                        <option value="">Tous les comptes (${uniqueAccounts.length})</option>
                        ${uniqueAccounts.map(username =>
                            `<option value="${username}" ${currentValue === username ? 'selected' : ''}>${username}</option>`
                        ).join('')}
                    `;
                }

                if (!instagramStats || instagramStats.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: ${isDarkMode ? 'rgba(255,255,255,0.05)' : '#f9fafb'}; border-radius: 0.75rem;">
                            <i class="fab fa-instagram" style="font-size: 3rem; color: ${isDarkMode ? '#4b5563' : '#d1d5db'}; margin-bottom: 1rem;"></i>
                            <p style="color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; font-size: 1.125rem;">Aucune statistique enregistre</p>
                            <p style="color: ${isDarkMode ? '#6b7280' : '#9ca3af'}; font-size: 0.875rem; margin-top: 0.5rem;">Utilisez le formulaire ci-dessus pour ajouter des statistiques</p>
                        </div>
                    `;
                    return;
                }

                // Apply filter if set
                const filterValue = filterSelect ? filterSelect.value : '';
                const filteredStats = filterValue ?
                    instagramStats.filter(s => s.username === filterValue) :
                    instagramStats;

                // Group by account
                const statsByAccount = {};
                filteredStats.forEach(stat => {
                    if (!statsByAccount[stat.username]) {
                        statsByAccount[stat.username] = [];
                    }
                    statsByAccount[stat.username].push(stat);
                });

                // Sort each account's stats by date (most recent first)
                Object.keys(statsByAccount).forEach(username => {
                    statsByAccount[username].sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                // Generate HTML with improved design
                container.innerHTML = Object.entries(statsByAccount).map(([username, stats]) => {
                    const latestStat = stats[0];
                    const oldestStat = stats[stats.length - 1];
                    const totalGrowth = latestStat.followers_count - oldestStat.followers_count;
                    const totalGrowthPercent = oldestStat.followers_count > 0 ?
                        ((totalGrowth / oldestStat.followers_count) * 100).toFixed(1) : 0;

                    const account = data.instagramAccounts.find(acc => acc.username.toLowerCase() === username.toLowerCase());
                    const creator = account ? data.creators.find(c => c.id === account.creatorId) : null;
                    const va = account && account.vaId ? data.vas.find(v => v.id === account.vaId) : null;

                    return `
                        <div class="stats-account-card" style="
                            background: ${isDarkMode ? 'linear-gradient(135deg, #16181d 0%, #1a1d23 100%)' : 'linear-gradient(135deg, #ffffff 0%, #fafafa 100%)'};
                            border: 2px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.2)' : 'rgba(193, 53, 132, 0.15)'};
                            border-radius: 1.25rem;
                            padding: 2rem;
                            margin-bottom: 1.5rem;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.borderColor='#c13584'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(193, 53, 132, 0.2)'" onmouseout="this.style.borderColor='${isDarkMode ? 'rgba(193, 53, 132, 0.2)' : 'rgba(193, 53, 132, 0.15)'}'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">

                            <!-- Header avec gradient icon -->
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem; gap: 1rem;">
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #833ab4 0%, #fd1d1d 50%, #fcb045 100%); border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(131, 58, 180, 0.3);">
                                        <i class="fab fa-instagram" style="color: white; font-size: 2rem;"></i>
                                    </div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: ${isDarkMode ? '#f1f5f9' : '#1f2937'}; display: flex; align-items: center; gap: 0.625rem;">
                                            ${username}
                                            <a href="https://instagram.com/${username.replace('@', '')}" target="_blank" style="color: #c13584; text-decoration: none; font-size: 1rem; opacity: 0.6; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </h3>
                                        <div style="margin-top: 0.5rem; display: flex; gap: 0.625rem; flex-wrap: wrap; align-items: center;">
                                            ${creator ? `<span style="padding: 0.375rem 0.75rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 0.625rem; font-size: 0.8125rem; font-weight: 600;">${creator.name}</span>` : ''}
                                            ${va ? `<span style="padding: 0.375rem 0.75rem; background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border-radius: 0.625rem; font-size: 0.8125rem; font-weight: 600;">VA: ${va.name}</span>` : ''}
                                            <span style="padding: 0.375rem 0.75rem; background: ${isDarkMode ? 'rgba(100, 116, 139, 0.2)' : '#e2e8f0'}; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; border-radius: 0.625rem; font-size: 0.8125rem; font-weight: 500;">
                                                <i class="fas fa-chart-line"></i> ${stats.length} mesure${stats.length > 1 ? 's' : ''}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, #833ab4, #fd1d1d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                                        ${latestStat.followers_count.toLocaleString()}
                                    </div>
                                    <div style="font-size: 0.8125rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; font-weight: 500; margin-top: 0.25rem;">
                                        followers actuels
                                    </div>
                                    ${stats.length > 1 ? `
                                        <div style="margin-top: 0.625rem; padding: 0.5rem 0.875rem; background: ${totalGrowth >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 0.625rem; display: inline-flex; align-items: center; gap: 0.375rem;">
                                            <i class="fas fa-arrow-${totalGrowth >= 0 ? 'up' : 'down'}" style="color: ${totalGrowth >= 0 ? '#10b981' : '#ef4444'}; font-size: 0.75rem;"></i>
                                            <span style="font-weight: 700; font-size: 0.875rem; color: ${totalGrowth >= 0 ? '#10b981' : '#ef4444'};">
                                                ${totalGrowth >= 0 ? '+' : ''}${totalGrowth.toLocaleString()} (${totalGrowthPercent}%)
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Timeline moderne -->
                            <div style="max-height: 350px; overflow-y: auto; padding-right: 0.5rem;">
                                ${stats.map((stat, index) => {
                                    const prevStat = stats[index + 1];
                                    const growth = prevStat ? stat.followers_count - prevStat.followers_count : 0;
                                    const growthPercent = prevStat ? ((growth / prevStat.followers_count) * 100).toFixed(1) : 0;

                                    return `
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 110px 1fr auto auto;
                                            align-items: center;
                                            gap: 1rem;
                                            padding: 1rem 1.25rem;
                                            background: ${isDarkMode ? 'rgba(255,255,255,0.04)' : '#fafafa'};
                                            border: 1px solid ${isDarkMode ? 'rgba(255,255,255,0.06)' : '#e5e7eb'};
                                            border-radius: 0.875rem;
                                            margin-bottom: 0.75rem;
                                            transition: all 0.2s;
                                        " onmouseover="this.style.background='${isDarkMode ? 'rgba(255,255,255,0.06)' : '#f3f4f6'}'; this.style.borderColor='${isDarkMode ? 'rgba(255,255,255,0.1)' : '#d1d5db'}'" onmouseout="this.style.background='${isDarkMode ? 'rgba(255,255,255,0.04)' : '#fafafa'}'; this.style.borderColor='${isDarkMode ? 'rgba(255,255,255,0.06)' : '#e5e7eb'}'">

                                            <!-- Date -->
                                            <div style="font-size: 0.875rem; font-weight: 600; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                                                <i class="far fa-calendar" style="margin-right: 0.375rem; opacity: 0.5;"></i>
                                                ${new Date(stat.date).toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' })}
                                            </div>

                                            <!-- Followers + Engagement -->
                                            <div>
                                                <div style="font-weight: 700; font-size: 1rem; color: ${isDarkMode ? '#f1f5f9' : '#1f2937'}; margin-bottom: 0.25rem;">
                                                    <i class="fas fa-users" style="color: #c13584; margin-right: 0.375rem; font-size: 0.875rem;"></i>
                                                    ${stat.followers_count.toLocaleString()} followers
                                                </div>
                                                ${stat.engagement_rate ? `
                                                    <div style="font-size: 0.8125rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                                                        <i class="fas fa-heart" style="color: #ec4899; margin-right: 0.375rem; font-size: 0.75rem;"></i>
                                                        ${stat.engagement_rate}% engagement
                                                    </div>
                                                ` : ''}
                                            </div>

                                            <!-- Growth badge -->
                                            ${growth !== 0 ? `
                                                <div style="
                                                    padding: 0.5rem 0.875rem;
                                                    background: ${growth > 0 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'};
                                                    color: white;
                                                    border-radius: 0.75rem;
                                                    font-size: 0.8125rem;
                                                    font-weight: 700;
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 0.375rem;
                                                    white-space: nowrap;
                                                    box-shadow: 0 2px 8px ${growth > 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
                                                ">
                                                    <i class="fas fa-arrow-${growth > 0 ? 'up' : 'down'}"></i>
                                                    ${growth > 0 ? '+' : ''}${growth.toLocaleString()} (${growthPercent}%)
                                                </div>
                                            ` : '<div></div>'}

                                            <!-- Delete button -->
                                            <button onclick="deleteInstagramStatById('${stat.id}')"
                                                    title="Supprimer cette mesure"
                                                    style="
                                                        width: 36px;
                                                        height: 36px;
                                                        background: ${isDarkMode ? 'rgba(239, 68, 68, 0.15)' : '#fee2e2'};
                                                        color: #ef4444;
                                                        border: none;
                                                        border-radius: 0.625rem;
                                                        cursor: pointer;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        transition: all 0.2s;
                                                    "
                                                    onmouseover="this.style.background='#ef4444'; this.style.color='white'; this.style.transform='scale(1.1)'"
                                                    onmouseout="this.style.background='${isDarkMode ? 'rgba(239, 68, 68, 0.15)' : '#fee2e2'}'; this.style.color='#ef4444'; this.style.transform='scale(1)'">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error(' Error loading Instagram stats history:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.125rem;">Erreur lors du chargement de l'historique</p>
                    </div>
                `;
            }
        }

        // Filter stats history by account
        function filterStatsHistory() {
            loadInstagramStatsHistory();
        }

        // ============================================================================
        // INSTAGRAM ANALYTICS DASHBOARD
        // ============================================================================

        let growthChart = null;
        let comparisonChart = null;
        let engagementChart = null;

        async function loadInstagramAnalytics() {
            try {
                showInfo('Chargement des analytics...');

                // Fetch all Instagram stats
                const allStats = await getAllInstagramStats();
                const instagramAccounts = data.instagramAccounts || [];

                // Group stats by username
                const statsByAccount = {};
                allStats.forEach(stat => {
                    if (!statsByAccount[stat.username]) {
                        statsByAccount[stat.username] = [];
                    }
                    statsByAccount[stat.username].push(stat);
                });

                // Sort stats by date for each account
                Object.keys(statsByAccount).forEach(username => {
                    statsByAccount[username].sort((a, b) => new Date(a.date) - new Date(b.date));
                });

                // Calculate KPIs
                await updateAnalyticsKPIs(statsByAccount, instagramAccounts);

                // Create charts
                await createGrowthChart(statsByAccount);
                await createComparisonChart(statsByAccount);
                await createEngagementChart(statsByAccount);

                // Update top performers
                await updateTopPerformers(statsByAccount);

                // Generate insights
                await generateInsights(statsByAccount);

                showSuccess('Analytics charges !');
            } catch (error) {
                console.error(' Error loading analytics:', error);
                showError('Erreur lors du chargement des analytics');
            }
        }

        async function updateAnalyticsKPIs(statsByAccount, instagramAccounts) {
            const container = document.getElementById('analytics-kpi-cards');
            if (!container) return;

            // Calculate total followers
            let totalFollowers = 0;
            let totalGrowth = 0;
            let accountsWithGrowth = 0;
            let totalEngagement = 0;
            let accountsWithEngagement = 0;

            Object.keys(statsByAccount).forEach(username => {
                const stats = statsByAccount[username];
                if (stats.length === 0) return;

                const latest = stats[stats.length - 1];
                totalFollowers += latest.followers_count || 0;

                if (latest.engagement_rate) {
                    totalEngagement += latest.engagement_rate;
                    accountsWithEngagement++;
                }

                if (stats.length > 1) {
                    const oldest = stats[0];
                    const growth = ((latest.followers_count - oldest.followers_count) / oldest.followers_count) * 100;
                    totalGrowth += growth;
                    accountsWithGrowth++;
                }
            });

            const avgGrowth = accountsWithGrowth > 0 ? (totalGrowth / accountsWithGrowth).toFixed(1) : 0;
            const avgEngagement = accountsWithEngagement > 0 ? (totalEngagement / accountsWithEngagement).toFixed(1) : 0;
            const activeAccounts = Object.keys(statsByAccount).length;

            container.innerHTML = `
                <div class="stat-card animate-in">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-users" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="stat-value">${totalFollowers.toLocaleString()}</div>
                            <div class="stat-label">Followers Total</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card animate-in" style="animation-delay: 0.1s;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-chart-line" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="stat-value">${avgGrowth > 0 ? '+' : ''}${avgGrowth}%</div>
                            <div class="stat-label">Croissance Moyenne</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card animate-in" style="animation-delay: 0.2s;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-heart" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="stat-value">${avgEngagement}%</div>
                            <div class="stat-label">Engagement Moyen</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card animate-in" style="animation-delay: 0.3s;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #ec4899, #db2777); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fab fa-instagram" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="stat-value">${activeAccounts}</div>
                            <div class="stat-label">Comptes Actifs</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function createGrowthChart(statsByAccount) {
            const canvas = document.getElementById('growth-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destroy existing chart
            if (growthChart) {
                growthChart.destroy();
            }

            // Get period filter
            const period = parseInt(document.getElementById('analytics-period').value) || 30;

            // Prepare datasets for each account
            const datasets = [];
            const colors = [
                {border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)'},
                {border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)'},
                {border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)'},
                {border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)'},
                {border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)'},
                {border: '#06b6d4', bg: 'rgba(6, 182, 212, 0.1)'},
            ];

            let colorIndex = 0;
            Object.keys(statsByAccount).forEach(username => {
                const stats = statsByAccount[username];
                if (stats.length === 0) return;

                // Filter by period
                const cutoffDate = new Date();
                if (period !== 'all') {
                    cutoffDate.setDate(cutoffDate.getDate() - period);
                }

                const filteredStats = period === 'all' ? stats : stats.filter(s => new Date(s.date) >= cutoffDate);

                if (filteredStats.length === 0) return;

                const color = colors[colorIndex % colors.length];
                colorIndex++;

                datasets.push({
                    label: username,
                    data: filteredStats.map(s => ({
                        x: s.date,
                        y: s.followers_count
                    })),
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: color.border,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                });
            });

            // Create chart
            growthChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12, weight: '600' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: '600' },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' followers';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: period <= 30 ? 'day' : 'week',
                                displayFormats: {
                                    day: 'dd MMM',
                                    week: 'dd MMM'
                                }
                            },
                            grid: { display: false },
                            ticks: { font: { size: 11 } }
                        },
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        async function createComparisonChart(statsByAccount) {
            const canvas = document.getElementById('comparison-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            if (comparisonChart) {
                comparisonChart.destroy();
            }

            // Get latest followers for each account
            const accountData = [];
            Object.keys(statsByAccount).forEach(username => {
                const stats = statsByAccount[username];
                if (stats.length > 0) {
                    const latest = stats[stats.length - 1];
                    accountData.push({
                        username,
                        followers: latest.followers_count
                    });
                }
            });

            // Sort by followers
            accountData.sort((a, b) => b.followers - a.followers);

            // Take top 10
            const topAccounts = accountData.slice(0, 10);

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topAccounts.map(a => a.username),
                    datasets: [{
                        label: 'Followers',
                        data: topAccounts.map(a => a.followers),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 40,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString() + ' followers';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 11, weight: '600' } }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: {
                                font: { size: 11 },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        async function createEngagementChart(statsByAccount) {
            const canvas = document.getElementById('engagement-chart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            if (engagementChart) {
                engagementChart.destroy();
            }

            // Get latest engagement for each account
            const accountData = [];
            Object.keys(statsByAccount).forEach(username => {
                const stats = statsByAccount[username];
                if (stats.length > 0) {
                    const latest = stats[stats.length - 1];
                    if (latest.engagement_rate) {
                        accountData.push({
                            username,
                            engagement: latest.engagement_rate
                        });
                    }
                }
            });

            // Sort by engagement
            accountData.sort((a, b) => b.engagement - a.engagement);

            if (accountData.length === 0) {
                ctx.font = '14px Inter';
                ctx.fillStyle = '#64748b';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune donne d\'engagement disponible', canvas.width / 2, canvas.height / 2);
                return;
            }

            engagementChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: accountData.map(a => a.username),
                    datasets: [{
                        data: accountData.map(a => a.engagement),
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                        ],
                        borderWidth: 3,
                        borderColor: '#fff',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 12,
                                font: { size: 11, weight: '600' }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        async function updateTopPerformers(statsByAccount) {
            const container = document.getElementById('top-performers-list');
            if (!container) return;

            // Calculate growth for each account
            const performers = [];
            Object.keys(statsByAccount).forEach(username => {
                const stats = statsByAccount[username];
                if (stats.length < 2) return;

                const latest = stats[stats.length - 1];
                const oldest = stats[0];
                const growth = latest.followers_count - oldest.followers_count;
                const growthPercent = ((growth / oldest.followers_count) * 100).toFixed(1);

                performers.push({
                    username,
                    growth,
                    growthPercent,
                    followers: latest.followers_count
                });
            });

            // Sort by growth
            performers.sort((a, b) => b.growth - a.growth);

            // Take top 5
            const top5 = performers.slice(0, 5);

            if (top5.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">Pas assez de donnes</p>';
                return;
            }

            const medals = ['', '', '', '4', '5'];

            container.innerHTML = top5.map((p, i) => `
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: var(--hover-bg); border-radius: 0.75rem; border: 1px solid var(--border-color); transition: all 0.2s;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                    <div style="font-size: 1.5rem; flex-shrink: 0;">${medals[i]}</div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: var(--text-color); font-size: 0.9375rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.username}</div>
                        <div style="font-size: 0.8125rem; color: #64748b;">${p.followers.toLocaleString()} followers</div>
                    </div>
                    <div style="text-align: right; flex-shrink: 0;">
                        <div style="font-weight: 700; color: #10b981; font-size: 0.9375rem;">+${p.growth.toLocaleString()}</div>
                        <div style="font-size: 0.75rem; color: #64748b;">+${p.growthPercent}%</div>
                    </div>
                </div>
            `).join('');
        }

        async function generateInsights(statsByAccount) {
            const container = document.getElementById('analytics-insights');
            if (!container) return;

            const insights = [];

            // Check for declining accounts
            Object.keys(statsByAccount).forEach(username => {
                const stats = statsByAccount[username];
                if (stats.length < 2) return;

                const latest = stats[stats.length - 1];
                const previous = stats[stats.length - 2];

                if (latest.followers_count < previous.followers_count) {
                    const loss = previous.followers_count - latest.followers_count;
                    insights.push({
                        type: 'warning',
                        icon: 'fa-exclamation-triangle',
                        color: '#ef4444',
                        bg: '#fef2f2',
                        title: 'Baisse dtecte',
                        message: `${username} a perdu ${loss.toLocaleString()} followers rcemment`
                    });
                }

                // Check for strong growth
                if (stats.length >= 2) {
                    const growth = ((latest.followers_count - stats[0].followers_count) / stats[0].followers_count) * 100;
                    if (growth > 20) {
                        insights.push({
                            type: 'success',
                            icon: 'fa-rocket',
                            color: '#10b981',
                            bg: '#f0fdf4',
                            title: 'Forte croissance',
                            message: `${username} est en excellente forme avec +${growth.toFixed(1)}% de croissance !`
                        });
                    }
                }
            });

            // Check for low engagement
            Object.keys(statsByAccount).forEach(username => {
                const stats = statsByAccount[username];
                if (stats.length === 0) return;

                const latest = stats[stats.length - 1];
                if (latest.engagement_rate && latest.engagement_rate < 2) {
                    insights.push({
                        type: 'info',
                        icon: 'fa-lightbulb',
                        color: '#3b82f6',
                        bg: '#eff6ff',
                        title: 'Engagement faible',
                        message: `${username} a un taux d'engagement de ${latest.engagement_rate}%. Suggrer plus de Reels ?`
                    });
                }
            });

            if (insights.length === 0) {
                insights.push({
                    type: 'info',
                    icon: 'fa-chart-line',
                    color: '#6366f1',
                    bg: '#eef2ff',
                    title: 'Tout va bien !',
                    message: 'Aucune alerte dtecte. Continuez comme a ! '
                });
            }

            container.innerHTML = insights.map(insight => `
                <div style="display: flex; align-items: start; gap: 1rem; padding: 1rem; background: ${insight.bg}; border-radius: 0.75rem; border: 2px solid ${insight.color};">
                    <div style="width: 40px; height: 40px; background: ${insight.color}; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <i class="fas ${insight.icon}" style="color: white; font-size: 1.125rem;"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: ${insight.color}; margin-bottom: 0.25rem;">${insight.title}</div>
                        <div style="color: #475569; font-size: 0.9375rem; line-height: 1.5;">${insight.message}</div>
                    </div>
                </div>
            `).join('');
        }

        function refreshAnalytics() {
            loadInstagramAnalytics();
        }

        // Delete Instagram stat by ID
        async function deleteInstagramStatById(statId) {
            if (!confirm('tes-vous sr de vouloir supprimer cette statistique ?')) return;

            try {
                await deleteInstagramStat(statId);
                showSuccess(' Statistique supprime');
                await loadInstagramStatsHistory();
                await updateInstagramTopAccounts();
            } catch (error) {
                console.error(' Error deleting Instagram stat:', error);
                showError('Erreur lors de la suppression');
            }
        }

        // ============================================================================
        // FOLLOWERS TRACKING - Suivi quotidien des followers par cratrice
        // ============================================================================

        let followersGrowthChart = null;
        let followersReminderDismissed = false;

        // Vrifier si les followers ont t mis  jour aujourd'hui
        async function checkFollowersUpdateStatus() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const reminderEl = document.getElementById('followers-update-reminder');

                if (!reminderEl) return;

                // Vrifier si l'utilisateur a ferm le rappel aujourd'hui
                const dismissedDate = localStorage.getItem('followers_reminder_dismissed');
                if (dismissedDate === today) {
                    reminderEl.style.display = 'none';
                    return;
                }

                // Rcuprer les stats de followers d'aujourd'hui
                const { data: todayStats, error } = await supabaseClient
                    .from('twitter_followers_history')
                    .select('id')
                    .eq('date', today)
                    .limit(1);

                if (error) {
                    console.error('Erreur vrification followers:', error);
                    return;
                }

                // Si aucune entre aujourd'hui, afficher le rappel
                if (!todayStats || todayStats.length === 0) {
                    reminderEl.style.display = 'flex';
                    console.log(' Rappel: Les followers n\'ont pas t mis  jour aujourd\'hui');
                } else {
                    reminderEl.style.display = 'none';
                    console.log(' Les followers ont t mis  jour aujourd\'hui');
                }
            } catch (err) {
                console.error('Erreur checkFollowersUpdateStatus:', err);
            }
        }

        // Fermer le rappel pour aujourd'hui
        function dismissFollowersReminder() {
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('followers_reminder_dismissed', today);

            const reminderEl = document.getElementById('followers-update-reminder');
            if (reminderEl) {
                reminderEl.style.animation = 'slideUp 0.3s ease-out reverse';
                setTimeout(() => {
                    reminderEl.style.display = 'none';
                }, 300);
            }
        }

        // ============================================================================
        // POPUP URGENT 23H - RAPPEL FOLLOWERS
        // ============================================================================

        let urgentPopupInterval = null;
        let midnightCountdownInterval = null;

        // Vrifier si on doit afficher le popup urgent (aprs 23h)
        async function checkUrgentFollowersReminder() {
            try {
                const now = new Date();
                const currentHour = now.getHours();
                const today = now.toISOString().split('T')[0];

                // Vrifier si dj ferm aujourd'hui
                const dismissedDate = localStorage.getItem('followers_urgent_popup_dismissed');
                if (dismissedDate === today) {
                    return;
                }

                // Seulement aprs 23h (ou pour test: changer la condition)
                if (currentHour < 23) {
                    return;
                }

                // Vrifier si les followers ont t mis  jour aujourd'hui
                const { data: todayStats, error } = await supabaseClient
                    .from('twitter_followers_history')
                    .select('twitter_account_id')
                    .eq('date', today);

                if (error) {
                    console.error('Erreur vrification urgent followers:', error);
                    return;
                }

                // Rcuprer tous les comptes Twitter actifs
                const { data: allAccounts, error: accountsError } = await supabaseClient
                    .from('twitter_accounts')
                    .select('id, username')
                    .eq('status', 'active');

                if (accountsError || !allAccounts) {
                    console.error('Erreur rcupration comptes:', accountsError);
                    return;
                }

                // Trouver les comptes non mis  jour
                const updatedAccountIds = new Set((todayStats || []).map(s => s.twitter_account_id));
                const missingAccounts = allAccounts.filter(acc => !updatedAccountIds.has(acc.id));

                // Si tous les comptes sont  jour, ne pas afficher
                if (missingAccounts.length === 0) {
                    console.log(' Tous les comptes Twitter sont  jour');
                    return;
                }

                // Afficher le popup
                showUrgentFollowersPopup(missingAccounts);

            } catch (err) {
                console.error('Erreur checkUrgentFollowersReminder:', err);
            }
        }

        // Afficher le popup urgent
        function showUrgentFollowersPopup(missingAccounts) {
            const popup = document.getElementById('followers-urgent-popup');
            const accountsContainer = document.getElementById('followers-missing-accounts');

            if (!popup || !accountsContainer) return;

            // Remplir la liste des comptes manquants
            if (missingAccounts.length > 0) {
                accountsContainer.innerHTML = missingAccounts.map(acc => `
                    <div class="followers-urgent-account-item">
                        <i class="fab fa-twitter"></i>
                        <span>@${acc.username}</span>
                    </div>
                `).join('');
                accountsContainer.style.display = 'block';
            } else {
                accountsContainer.style.display = 'none';
            }

            // Afficher le popup
            popup.style.display = 'flex';

            // Dmarrer le compte  rebours jusqu' minuit
            updateMidnightCountdown();
            midnightCountdownInterval = setInterval(updateMidnightCountdown, 1000);

            console.log(' Popup urgent affich - ' + missingAccounts.length + ' comptes non mis  jour');
        }

        // Mettre  jour le compte  rebours jusqu' minuit
        function updateMidnightCountdown() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0);

            const diff = midnight - now;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);

            const timerEl = document.getElementById('time-until-midnight');
            if (timerEl) {
                timerEl.textContent = `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
            }
        }

        // Aller  la page de suivi des followers
        function goToFollowersTracking() {
            dismissUrgentFollowersPopup();
            navigateToPage('followers-tracking');
        }

        // Fermer le popup urgent
        function dismissUrgentFollowersPopup() {
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('followers_urgent_popup_dismissed', today);

            const popup = document.getElementById('followers-urgent-popup');
            if (popup) {
                popup.style.animation = 'popupFadeIn 0.3s ease-out reverse';
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 300);
            }

            // Arrter le compte  rebours
            if (midnightCountdownInterval) {
                clearInterval(midnightCountdownInterval);
                midnightCountdownInterval = null;
            }
        }

        // Initialiser le systme de rappel urgent
        function initUrgentFollowersReminder() {
            // Vrifier immdiatement
            checkUrgentFollowersReminder();

            // Revrifier toutes les 5 minutes
            urgentPopupInterval = setInterval(checkUrgentFollowersReminder, 5 * 60 * 1000);
        }

        // Load the followers tracking page
        // Ouvrir Twitter et focus sur le champ de saisie
        function openTwitterAndFocus(username, inputId) {
            // Ouvrir Twitter dans un nouvel onglet
            window.open(`https://x.com/${username}`, '_blank');

            // Mettre le focus sur le champ aprs un court dlai (quand l'utilisateur revient)
            const input = document.getElementById(inputId);
            if (input) {
                // Highlight le champ pour indiquer o coller
                input.style.borderColor = '#1da1f2';
                input.style.boxShadow = '0 0 0 3px rgba(29, 161, 242, 0.3)';
                input.focus();
                input.select();

                // couter quand la fentre regagne le focus
                const handleFocus = () => {
                    input.focus();
                    input.select();
                    // Reset le style aprs quelques secondes
                    setTimeout(() => {
                        input.style.borderColor = '';
                        input.style.boxShadow = '';
                    }, 3000);
                    window.removeEventListener('focus', handleFocus);
                };
                window.addEventListener('focus', handleFocus);
            }
        }

        async function loadFollowersTrackingPage() {
            console.log(' Loading Followers Tracking Page...');

            // Set default date to today
            const dateInput = document.getElementById('followers-tracking-date');
            if (dateInput && !dateInput.value) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }

            // Load all data
            await loadFollowersTrackingData();
            await updateFollowersChart(7);
            await updateFollowersTopPerformers();
            await updateFollowersHistory();
        }

        // Navigation vers le prochain champ avec Entre
        function goToNextInput(currentIndex) {
            const allInputs = document.querySelectorAll('.ft-followers-input');
            const nextIndex = currentIndex + 1;
            if (nextIndex < allInputs.length) {
                allInputs[nextIndex].focus();
                allInputs[nextIndex].select();
            } else {
                // Dernier input, on sauvegarde
                const saveBtn = document.getElementById('save-followers-btn');
                if (saveBtn) {
                    saveBtn.focus();
                    saveBtn.click();
                }
            }
        }

        // Load followers tracking data and populate the bulk form
        async function loadFollowersTrackingData() {
            const formContainer = document.getElementById('followers-bulk-form');
            const summaryContainer = document.getElementById('followers-summary-cards');
            if (!formContainer) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            try {
                // Get all Twitter accounts grouped by creator
                const accountsByCreator = {};
                let totalFollowers = 0;
                let totalGrowth = 0;

                // Get all Twitter stats
                const allStats = await getTwitterStats() || [];
                const statsByUsername = {};
                allStats.forEach(stat => {
                    if (!statsByUsername[stat.username]) {
                        statsByUsername[stat.username] = [];
                    }
                    statsByUsername[stat.username].push(stat);
                });

                // Sort stats by date for each username
                Object.keys(statsByUsername).forEach(username => {
                    statsByUsername[username].sort((a, b) => new Date(a.date) - new Date(b.date));
                });

                // Group Twitter accounts by creator
                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.accounts && creator.accounts.length > 0) {
                            accountsByCreator[creator.id] = {
                                name: creator.name,
                                photo: creator.photo_url,
                                accounts: creator.accounts.map(acc => {
                                    const username = acc.username;
                                    const stats = statsByUsername[username] || statsByUsername[username.replace('@', '')] || [];
                                    const latestStat = stats.length > 0 ? stats[stats.length - 1] : null;
                                    const yesterdayStat = stats.length > 1 ? stats[stats.length - 2] : null;

                                    const currentFollowers = latestStat ? latestStat.followers_count : 0;
                                    const yesterdayFollowers = yesterdayStat ? yesterdayStat.followers_count : currentFollowers;
                                    const dailyGrowth = currentFollowers - yesterdayFollowers;

                                    totalFollowers += currentFollowers;
                                    totalGrowth += dailyGrowth;

                                    return {
                                        username: username,
                                        currentFollowers,
                                        yesterdayFollowers,
                                        dailyGrowth,
                                        lastDate: latestStat ? latestStat.date : null
                                    };
                                })
                            };
                        }
                    });
                }

                // Update summary cards
                summaryContainer.innerHTML = `
                    <div style="background: linear-gradient(135deg, #1da1f2 0%, #0d8bd9 100%); border-radius: 1rem; padding: 1.25rem; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Followers</div>
                        <div style="font-size: 2rem; font-weight: 800;">${totalFollowers.toLocaleString()}</div>
                    </div>
                    <div style="background: ${totalGrowth >= 0 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; border-radius: 1rem; padding: 1.25rem; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Croissance (hier)</div>
                        <div style="font-size: 2rem; font-weight: 800;">${totalGrowth >= 0 ? '+' : ''}${totalGrowth.toLocaleString()}</div>
                    </div>
                    <div style="background: ${isDarkMode ? '#374151' : '#f1f5f9'}; border-radius: 1rem; padding: 1.25rem;">
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; margin-bottom: 0.5rem;">Cratrices</div>
                        <div style="font-size: 2rem; font-weight: 800; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">${Object.keys(accountsByCreator).length}</div>
                    </div>
                    <div style="background: ${isDarkMode ? '#374151' : '#f1f5f9'}; border-radius: 1rem; padding: 1.25rem;">
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; margin-bottom: 0.5rem;">Comptes Twitter</div>
                        <div style="font-size: 2rem; font-weight: 800; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">${data.twitterAccounts ? data.twitterAccounts.length : 0}</div>
                    </div>
                `;

                // Build the bulk entry form grouped by creator
                if (Object.keys(accountsByCreator).length === 0) {
                    formContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                            <i class="fab fa-twitter" style="font-size: 3rem; opacity: 0.3;"></i>
                            <p style="margin-top: 1rem;">Aucun compte Twitter trouv</p>
                            <p style="font-size: 0.875rem;">Ajoutez des comptes Twitter  vos cratrices pour commencer le suivi</p>
                        </div>
                    `;
                    return;
                }

                // Crer une liste plate de tous les comptes pour un affichage simplifi
                const allAccounts = [];
                Object.entries(accountsByCreator).forEach(([creatorId, creatorData]) => {
                    creatorData.accounts.forEach(acc => {
                        allAccounts.push({
                            ...acc,
                            creatorId,
                            creatorName: creatorData.name,
                            creatorPhoto: creatorData.photo
                        });
                    });
                });

                // Trier par nom de cratrice puis par username
                allAccounts.sort((a, b) => {
                    if (a.creatorName !== b.creatorName) {
                        return a.creatorName.localeCompare(b.creatorName);
                    }
                    return a.username.localeCompare(b.username);
                });

                formContainer.innerHTML = `
                    <div class="ft-intuitive-grid">
                        ${allAccounts.map((acc, index) => {
                            const today = new Date().toISOString().split('T')[0];
                            const isUpdatedToday = acc.lastDate === today;
                            const inputId = `followers-input-${acc.username.replace(/[^a-zA-Z0-9]/g, '_')}`;

                            return `
                                <div class="ft-account-card ${isUpdatedToday ? 'ft-card-updated' : 'ft-card-pending'}" data-index="${index}">
                                    <!-- Status Badge -->
                                    <div class="ft-status-badge ${isUpdatedToday ? 'ft-status-done' : 'ft-status-todo'}">
                                        ${isUpdatedToday ? '<i class="fas fa-check"></i>' : '<i class="fas fa-clock"></i>'}
                                    </div>

                                    <!-- Header: Creator + Twitter -->
                                    <div class="ft-card-header-info">
                                        <div class="ft-creator-mini">
                                            <div class="ft-creator-avatar">
                                                ${acc.creatorPhoto
                                                    ? `<img src="${acc.creatorPhoto}" alt="${acc.creatorName}">`
                                                    : `<i class="fas fa-user"></i>`
                                                }
                                            </div>
                                            <span class="ft-creator-name">${acc.creatorName}</span>
                                        </div>
                                        <a href="https://twitter.com/${acc.username.replace('@', '')}" target="_blank" class="ft-twitter-link" onclick="setTimeout(() => document.getElementById('${inputId}').focus(), 100)">
                                            <i class="fab fa-twitter"></i>
                                            <span>${acc.username}</span>
                                            <i class="fas fa-external-link-alt ft-external-icon"></i>
                                        </a>
                                    </div>

                                    <!-- Big Input Area -->
                                    <div class="ft-input-area">
                                        <label class="ft-input-label">Nombre de followers</label>
                                        <div class="ft-input-wrapper">
                                            <i class="fas fa-users ft-input-icon"></i>
                                            <input type="number"
                                                   id="${inputId}"
                                                   data-username="${acc.username}"
                                                   data-creator-id="${acc.creatorId}"
                                                   value="${acc.currentFollowers || ''}"
                                                   placeholder="Ex: 12500"
                                                   class="ft-followers-input"
                                                   onfocus="this.select(); this.parentElement.classList.add('focused')"
                                                   onblur="this.parentElement.classList.remove('focused')"
                                                   onkeydown="if(event.key === 'Enter') { event.preventDefault(); goToNextInput(${index}); }">
                                        </div>
                                        ${acc.currentFollowers > 0 ? `
                                            <div class="ft-last-value">
                                                Dernier: <strong>${acc.currentFollowers.toLocaleString()}</strong>
                                                ${acc.dailyGrowth !== 0 ? `
                                                    <span class="ft-growth ${acc.dailyGrowth > 0 ? 'positive' : 'negative'}">
                                                        ${acc.dailyGrowth > 0 ? '+' : ''}${acc.dailyGrowth}
                                                    </span>
                                                ` : ''}
                                            </div>
                                        ` : `
                                            <div class="ft-last-value ft-new">
                                                <i class="fas fa-star"></i> Premier enregistrement
                                            </div>
                                        `}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                // Ajouter les styles pour le nouveau design
                if (!document.getElementById('ft-intuitive-styles')) {
                    const styleEl = document.createElement('style');
                    styleEl.id = 'ft-intuitive-styles';
                    styleEl.textContent = `
                        .ft-intuitive-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                            gap: 1rem;
                        }

                        .ft-account-card {
                            background: var(--dash-card-bg, white);
                            border: 2px solid var(--dash-border, #e2e8f0);
                            border-radius: 1rem;
                            padding: 1.25rem;
                            position: relative;
                            transition: all 0.3s ease;
                        }

                        .ft-account-card:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
                        }

                        .ft-card-pending {
                            border-color: #f59e0b;
                            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, transparent 100%);
                        }

                        .ft-card-updated {
                            border-color: #10b981;
                            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
                        }

                        .ft-status-badge {
                            position: absolute;
                            top: -8px;
                            right: -8px;
                            width: 28px;
                            height: 28px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.75rem;
                            color: white;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        }

                        .ft-status-todo {
                            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        }

                        .ft-status-done {
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        }

                        .ft-card-header-info {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                            margin-bottom: 1rem;
                        }

                        .ft-creator-mini {
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        }

                        .ft-creator-avatar {
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            overflow: hidden;
                        }

                        .ft-creator-avatar img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        }

                        .ft-creator-avatar i {
                            font-size: 0.625rem;
                            color: white;
                        }

                        .ft-creator-name {
                            font-size: 0.75rem;
                            color: var(--dash-text-muted, #64748b);
                            font-weight: 500;
                        }

                        .ft-twitter-link {
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                            color: #1da1f2;
                            font-weight: 700;
                            font-size: 1.1rem;
                            text-decoration: none;
                            transition: all 0.2s;
                        }

                        .ft-twitter-link:hover {
                            color: #0d8bd9;
                        }

                        .ft-twitter-link .fa-twitter {
                            font-size: 1.25rem;
                        }

                        .ft-external-icon {
                            font-size: 0.7rem;
                            opacity: 0.5;
                            margin-left: auto;
                        }

                        .ft-input-area {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                        }

                        .ft-input-label {
                            font-size: 0.75rem;
                            color: var(--dash-text-muted, #64748b);
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.05em;
                        }

                        .ft-input-wrapper {
                            position: relative;
                            display: flex;
                            align-items: center;
                        }

                        .ft-input-icon {
                            position: absolute;
                            left: 1rem;
                            color: var(--dash-text-muted, #94a3b8);
                            font-size: 1rem;
                            pointer-events: none;
                            transition: color 0.2s;
                        }

                        .ft-input-wrapper.focused .ft-input-icon {
                            color: #1da1f2;
                        }

                        .ft-followers-input {
                            width: 100%;
                            padding: 1rem 1rem 1rem 2.75rem;
                            font-size: 1.5rem;
                            font-weight: 700;
                            border: 2px solid var(--dash-border, #e2e8f0);
                            border-radius: 0.75rem;
                            background: var(--dash-bg, #f8fafc);
                            color: var(--dash-text, #1f2937);
                            text-align: center;
                            transition: all 0.2s;
                        }

                        .ft-followers-input:focus {
                            outline: none;
                            border-color: #1da1f2;
                            background: white;
                            box-shadow: 0 0 0 4px rgba(29, 161, 242, 0.15);
                        }

                        .ft-followers-input::placeholder {
                            color: var(--dash-text-muted, #94a3b8);
                            font-weight: 400;
                            font-size: 1rem;
                        }

                        .ft-last-value {
                            font-size: 0.8125rem;
                            color: var(--dash-text-muted, #64748b);
                            text-align: center;
                        }

                        .ft-last-value strong {
                            color: var(--dash-text, #1f2937);
                        }

                        .ft-last-value.ft-new {
                            color: #8b5cf6;
                        }

                        .ft-last-value.ft-new i {
                            margin-right: 0.25rem;
                        }

                        .ft-growth {
                            display: inline-block;
                            padding: 0.125rem 0.5rem;
                            border-radius: 1rem;
                            font-weight: 600;
                            font-size: 0.75rem;
                            margin-left: 0.5rem;
                        }

                        .ft-growth.positive {
                            background: rgba(16, 185, 129, 0.1);
                            color: #10b981;
                        }

                        .ft-growth.negative {
                            background: rgba(239, 68, 68, 0.1);
                            color: #ef4444;
                        }

                        /* Dark mode */
                        body.dark-mode .ft-account-card {
                            background: var(--dash-card-bg, #1f2937);
                            border-color: var(--dash-border, #374151);
                        }

                        body.dark-mode .ft-card-pending {
                            border-color: #f59e0b;
                            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, transparent 100%);
                        }

                        body.dark-mode .ft-card-updated {
                            border-color: #10b981;
                            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
                        }

                        body.dark-mode .ft-followers-input {
                            background: #111827;
                            border-color: #374151;
                            color: #e2e8f0;
                        }

                        body.dark-mode .ft-followers-input:focus {
                            background: #1f2937;
                        }

                        /* Responsive */
                        @media (max-width: 640px) {
                            .ft-intuitive-grid {
                                grid-template-columns: 1fr;
                            }

                            .ft-followers-input {
                                font-size: 1.25rem;
                                padding: 0.875rem 0.875rem 0.875rem 2.5rem;
                            }
                        }
                    `;
                    document.head.appendChild(styleEl);
                }

            } catch (error) {
                console.error(' Error loading followers tracking data:', error);
                formContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem;"></i>
                        <p style="margin-top: 1rem;">Erreur lors du chargement des donnes</p>
                    </div>
                `;
            }
        }

        // Save all followers stats at once
        async function saveAllFollowersStats(event) {
            // Get the button that was clicked
            const button = event?.target?.closest('button') || document.getElementById('save-followers-btn');
            const originalText = button ? button.innerHTML : null;

            const dateInput = document.getElementById('followers-tracking-date');
            const date = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];

            // Get all input values
            const inputs = document.querySelectorAll('[id^="followers-input-"]');
            const entries = [];

            inputs.forEach(input => {
                const value = parseInt(input.value);
                if (value && value > 0) {
                    entries.push({
                        username: input.dataset.username,
                        followers: value,
                        followers_count: value,
                        date: date,
                        creator_id: input.dataset.creatorId
                    });
                }
            });

            if (entries.length === 0) {
                showError('Aucune donne  enregistrer');
                return;
            }

            try {
                // Set loading state
                setButtonLoading(button, true);

                let savedCount = 0;
                for (const entry of entries) {
                    // Check if stat already exists for this date
                    const existingStats = await getTwitterStatsByUsername(entry.username);
                    const existingForDate = existingStats.find(s => s.date === entry.date);

                    if (existingForDate) {
                        // Update existing
                        await updateTwitterStat(existingForDate.id, { followers: entry.followers });
                    } else {
                        // Create new
                        await createTwitterStat(entry);
                    }
                    savedCount++;
                }

                showSuccess(` ${savedCount} entre(s) enregistre(s) !`);

                // Refresh displays
                await loadFollowersTrackingData();
                await updateFollowersChart(7);
                await updateFollowersTopPerformers();
                await updateFollowersHistory();

                // Refresh dashboard section
                await updateFollowersDashboardSection();
                await updateTwitterTopAccounts();

            } catch (error) {
                console.error(' Error saving followers stats:', error);
                showError('Erreur lors de l\'enregistrement: ' + error.message);
            } finally {
                // Restore button state
                setButtonLoading(button, false, originalText);
            }
        }

        // Update followers growth chart
        async function updateFollowersChart(days = 7) {
            const canvas = document.getElementById('followers-growth-chart');
            if (!canvas) return;

            // Update period buttons
            document.querySelectorAll('.followers-period-btn').forEach(btn => {
                if (parseInt(btn.dataset.period) === days) {
                    btn.style.background = '#1da1f2';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#64748b';
                }
            });

            const ctx = canvas.getContext('2d');

            if (followersGrowthChart) {
                followersGrowthChart.destroy();
            }

            try {
                const allStats = await getTwitterStats() || [];

                // Filter by date range
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);

                const filteredStats = allStats.filter(s => new Date(s.date) >= cutoffDate);

                // Group by username
                const statsByUsername = {};
                filteredStats.forEach(stat => {
                    if (!statsByUsername[stat.username]) {
                        statsByUsername[stat.username] = [];
                    }
                    statsByUsername[stat.username].push(stat);
                });

                // Sort each username's stats by date
                Object.keys(statsByUsername).forEach(username => {
                    statsByUsername[username].sort((a, b) => new Date(a.date) - new Date(b.date));
                });

                // Create datasets
                const colors = ['#1da1f2', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];
                const datasets = Object.keys(statsByUsername).map((username, i) => ({
                    label: username,
                    data: statsByUsername[username].map(s => ({
                        x: s.date,
                        y: s.followers_count
                    })),
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '20',
                    tension: 0.3,
                    fill: false,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }));

                if (datasets.length === 0) {
                    ctx.font = '14px Inter';
                    ctx.fillStyle = '#64748b';
                    ctx.textAlign = 'center';
                    ctx.fillText('Aucune donne disponible', canvas.width / 2, canvas.height / 2);
                    return;
                }

                followersGrowthChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: days <= 14 ? 'day' : 'week',
                                    displayFormats: { day: 'dd/MM', week: 'dd/MM' }
                                },
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { usePointStyle: true, padding: 15 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' followers';
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error(' Error updating followers chart:', error);
            }
        }

        // Update top performers list
        async function updateFollowersTopPerformers() {
            const container = document.getElementById('followers-top-performers');
            if (!container) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            try {
                const allStats = await getTwitterStats() || [];

                // Group by username and calculate daily growth
                const growthByUsername = {};
                const statsByUsername = {};

                allStats.forEach(stat => {
                    if (!statsByUsername[stat.username]) {
                        statsByUsername[stat.username] = [];
                    }
                    statsByUsername[stat.username].push(stat);
                });

                Object.keys(statsByUsername).forEach(username => {
                    const stats = statsByUsername[username].sort((a, b) => new Date(a.date) - new Date(b.date));
                    if (stats.length >= 2) {
                        const latest = stats[stats.length - 1];
                        const previous = stats[stats.length - 2];
                        const latestFollowers = latest.followers_count || latest.followers || 0;
                        const previousFollowers = previous.followers_count || previous.followers || 0;
                        growthByUsername[username] = {
                            growth: latestFollowers - previousFollowers,
                            current: latestFollowers
                        };
                    } else if (stats.length === 1) {
                        const currentFollowers = stats[0].followers_count || stats[0].followers || 0;
                        growthByUsername[username] = {
                            growth: 0,
                            current: currentFollowers
                        };
                    }
                });

                // Sort by growth
                const sorted = Object.entries(growthByUsername)
                    .sort((a, b) => b[1].growth - a[1].growth)
                    .slice(0, 5);

                if (sorted.length === 0) {
                    container.innerHTML = `<p style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; text-align: center;">Pas encore de donnes</p>`;
                    return;
                }

                const medals = ['', '', '', '4', '5'];

                container.innerHTML = sorted.map(([username, data], i) => `
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: ${isDarkMode ? 'rgba(255,255,255,0.05)' : '#f8fafc'}; border-radius: 0.75rem;">
                        <span style="font-size: 1.25rem;">${medals[i]}</span>
                        <div style="flex: 1;">
                            <a href="https://twitter.com/${username.replace('@', '')}" target="_blank" style="color: #1da1f2; font-weight: 600; text-decoration: none;">
                                ${username}
                            </a>
                            <div style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">${data.current.toLocaleString()} followers</div>
                        </div>
                        <div style="font-weight: 700; color: ${data.growth >= 0 ? '#10b981' : '#ef4444'};">
                            ${data.growth >= 0 ? '+' : ''}${data.growth}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error(' Error updating top performers:', error);
            }
        }

        // Update followers history table
        async function updateFollowersHistory() {
            const container = document.getElementById('followers-history-table');
            if (!container) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            try {
                const allStats = await getTwitterStats() || [];

                if (allStats.length === 0) {
                    container.innerHTML = `<p style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; text-align: center; padding: 2rem;">Aucun historique disponible</p>`;
                    return;
                }

                // Get last 7 days
                const dates = [...new Set(allStats.map(s => s.date))].sort().reverse().slice(0, 7);
                const usernames = [...new Set(allStats.map(s => s.username))].sort();

                // Build stats lookup
                const statsLookup = {};
                allStats.forEach(s => {
                    statsLookup[`${s.username}_${s.date}`] = s.followers_count;
                });

                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: ${isDarkMode ? 'rgba(255,255,255,0.05)' : '#f8fafc'};">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; border-bottom: 2px solid ${isDarkMode ? '#374151' : '#e2e8f0'};">Compte</th>
                                ${dates.map(date => `<th style="padding: 0.75rem; text-align: center; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; border-bottom: 2px solid ${isDarkMode ? '#374151' : '#e2e8f0'};">${new Date(date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' })}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${usernames.map(username => `
                                <tr style="border-bottom: 1px solid ${isDarkMode ? '#374151' : '#e2e8f0'};">
                                    <td style="padding: 0.75rem; color: #1da1f2; font-weight: 600;">${username}</td>
                                    ${dates.map(date => {
                                        const value = statsLookup[`${username}_${date}`];
                                        return `<td style="padding: 0.75rem; text-align: center; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">${value ? value.toLocaleString() : '-'}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error(' Error updating followers history:', error);
            }
        }

        // ============================================================================
        // END FOLLOWERS TRACKING
        // ============================================================================

        // Update Twitter Analytics (page supprime - fonction dsactive)
        function updateTwitterAnalytics() {
            // La page Twitter Analytics a t supprime, cette fonction ne fait plus rien
            return;
            
            // Calculer les stats globales
            let totalFollowers = 0;
            let totalGrowth = 0;
            let bestAccount = { username: '-', followers: 0 };
            let lastUpdateDate = null;
            
            // Obtenir les dernires stats pour chaque compte
            const latestStats = new Map();
            const previousWeekStats = new Map();
            
            data.twitterStats.forEach(stat => {
                const username = stat.username.toLowerCase();
                const statDate = new Date(stat.date);
                
                if (!latestStats.has(username) || statDate > new Date(latestStats.get(username).date)) {
                    latestStats.set(username, stat);
                }
                
                // Chercher les stats de la semaine prcdente
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                
                if (statDate >= twoWeeksAgo && statDate <= weekAgo) {
                    if (!previousWeekStats.has(username) || statDate > new Date(previousWeekStats.get(username).date)) {
                        previousWeekStats.set(username, stat);
                    }
                }
                
                if (!lastUpdateDate || statDate > lastUpdateDate) {
                    lastUpdateDate = statDate;
                }
            });
            
            // Calculer le total et trouver le meilleur compte
            latestStats.forEach((stat, username) => {
                totalFollowers += stat.followers;
                
                if (stat.followers > bestAccount.followers) {
                    bestAccount = { username: stat.username, followers: stat.followers };
                }
                
                // Calculer la croissance
                if (previousWeekStats.has(username)) {
                    const prevStat = previousWeekStats.get(username);
                    totalGrowth += (stat.followers - prevStat.followers);
                }
            });
            
            // Mettre  jour les stats globales
            document.getElementById('total-followers').textContent = formatNumber(totalFollowers);
            document.getElementById('weekly-growth').textContent = totalGrowth >= 0 ? `+${formatNumber(totalGrowth)}` : formatNumber(totalGrowth);
            document.getElementById('best-account').textContent = bestAccount.username !== '-' ? `${bestAccount.username} (${formatNumber(bestAccount.followers)})` : '-';
            document.getElementById('last-update').textContent = lastUpdateDate ? lastUpdateDate.toLocaleDateString('fr-FR') : '-';
            
            // Analyser par VA
            const vaAnalytics = new Map();
            
            // Pour chaque compte Twitter avec des stats
            latestStats.forEach((stat, username) => {
                // Trouver  quel VA appartient ce compte
                let foundVa = null;
                
                // Chercher dans data.creators
                if (data.creators) {
                    for (const creator of data.creators) {
                        if (creator.accounts) {
                            const account = creator.accounts.find(acc => 
                                acc.username.toLowerCase() === username
                            );
                            
                            if (account) {
                                // Trouver le VA assign
                                if (account.assignedVaId) {
                                    foundVa = data.vas.find(v => v.id === account.assignedVaId);
                                } else if (creator.vaIds && creator.vaIds.length > 0) {
                                    // Si pas d'assignation spcifique, prendre le premier VA
                                    foundVa = data.vas.find(v => v.id === creator.vaIds[0]);
                                }
                                break;
                            }
                        }
                    }
                }
                
                // Si pas trouv dans la nouvelle structure, chercher dans l'ancienne
                if (!foundVa && data.twitterAccounts) {
                    const oldAccount = data.twitterAccounts.find(ta => 
                        ta.username && ta.username.toLowerCase() === username
                    );
                    if (oldAccount && oldAccount.vaId) {
                        foundVa = data.vas.find(v => v.id === oldAccount.vaId);
                    }
                }
                
                const vaName = foundVa ? foundVa.name : 'Non assign';
                
                if (!vaAnalytics.has(vaName)) {
                    vaAnalytics.set(vaName, {
                        accounts: [],
                        totalFollowers: 0,
                        totalGrowth: 0
                    });
                }
                
                const vaData = vaAnalytics.get(vaName);
                vaData.totalFollowers += stat.followers;
                
                // Calculer la croissance
                let growth = 0;
                if (previousWeekStats.has(username)) {
                    const prevStat = previousWeekStats.get(username);
                    growth = stat.followers - prevStat.followers;
                    vaData.totalGrowth += growth;
                }
                
                vaData.accounts.push({
                    username: stat.username,
                    followers: stat.followers,
                    growth: growth,
                    lastUpdate: stat.date
                });
            });
            
            // Gnrer le HTML par VA
            const vaAnalyticsHtml = Array.from(vaAnalytics.entries()).map(([vaName, vaData]) => {
                // Trier les comptes par followers dcroissant
                vaData.accounts.sort((a, b) => b.followers - a.followers);
                
                const growthColor = vaData.totalGrowth >= 0 ? '#10b981' : '#ef4444';
                const growthSign = vaData.totalGrowth >= 0 ? '+' : '';
                
                return `
                    <div class="stat-card" style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">${vaName}</h3>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1DA1F2;">
                                    ${formatNumber(vaData.totalFollowers)}
                                </div>
                                <div style="font-size: 0.875rem; color: ${growthColor}; font-weight: 600;">
                                    ${growthSign}${formatNumber(vaData.totalGrowth)} cette semaine
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            ${vaData.accounts.map(account => {
                                const accountGrowthColor = account.growth >= 0 ? '#10b981' : '#ef4444';
                                const accountGrowthSign = account.growth >= 0 ? '+' : '';
                                
                                return `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: rgba(29, 161, 242, 0.05); border-radius: 0.5rem; border: 1px solid rgba(29, 161, 242, 0.1);">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <a href="https://twitter.com/${account.username.replace('@', '')}" 
                                               target="_blank" 
                                               class="twitter-badge" 
                                               style="padding: 0.25rem 0.75rem; font-size: 0.875rem; text-decoration: none;">
                                                <i class="fab fa-twitter"></i> ${account.username}
                                            </a>
                                            <button class="btn-icon" onclick="showUpdateFollowersModal('${account.username}')" 
                                                    style="background: #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 600; color: #1f2937;">
                                                ${formatNumber(account.followers)}
                                            </div>
                                            <div style="font-size: 0.75rem; color: ${accountGrowthColor};">
                                                ${accountGrowthSign}${formatNumber(account.growth)}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('twitter-analytics-by-va').innerHTML = vaAnalyticsHtml || `
                <div style="text-align: center; padding: 3rem; background: rgba(148, 163, 184, 0.1); border-radius: 0.75rem;">
                    <i class="fas fa-chart-line" style="font-size: 3rem; color: #94a3b8; margin-bottom: 1rem;"></i>
                    <p style="color: #64748b; font-size: 1.1rem;">Aucune donne disponible</p>
                    <p style="color: #94a3b8; font-size: 0.875rem; margin-top: 0.5rem;">Commencez  suivre vos comptes Twitter pour voir les statistiques</p>
                </div>
            `;
        }

        // ============================================================================
        // TEAM MANAGEMENT FUNCTIONS
        // ============================================================================

        let currentOrganization = null;
        let invitationCode = null;
        let user = null;

        async function loadTeamManagement() {
            console.log(' [DEBUG] Starting loadTeamManagement...');
            try {
                // Use the global currentUser variable (already loaded)
                if (!currentUser) {
                    console.error(' [DEBUG] No currentUser found');
                    showError('Utilisateur non connect');
                    return;
                }

                console.log(' [DEBUG] Current user:', currentUser.email, 'ID:', currentUser.id);

                // Get organization ID directly - simpler approach
                const userId = currentUser.id;
                let usedFallback = false;

                console.log(' [DEBUG] Querying organizations table for owner_id:', userId);

                // Try direct query without RLS complications
                const { data: orgData, error: orgError } = await supabase
                    .from('organizations')
                    .select('*')
                    .eq('owner_id', userId)
                    .limit(1);

                console.log(' [DEBUG] Organizations query result:', { orgData, orgError });

                // WORKAROUND: If organizations table fails (500 error), use hardcoded fallback
                if (orgError || !orgData || orgData.length === 0) {
                    console.warn(' [DEBUG] Organizations table error or no data, using fallback organization');
                    console.error(' [DEBUG] Original error:', orgError);

                    // Hardcoded fallback for known user (florent.media2@gmail.com)
                    const FALLBACK_ORG_ID = 'e78e20c1-9c57-41bc-9744-ed6b8f0f1908';
                    const FALLBACK_ORG_NAME = 'Mon Organisation';

                    console.log(' [DEBUG] Using fallback org:', FALLBACK_ORG_ID);

                    // Create fallback organization object
                    // Use the real owner ID from the database, not the current user
                    currentOrganization = {
                        id: FALLBACK_ORG_ID,
                        name: FALLBACK_ORG_NAME,
                        owner_id: 'f007237d-207b-4cfe-8aa2-679e46396277', // florent.media2 is the real owner
                        created_at: new Date().toISOString()
                    };

                    usedFallback = true;

                    // Show warning banner that we're using fallback mode
                    const orgNameElement = document.getElementById('org-name');
                    const orgOwnerElement = document.getElementById('org-owner');

                    orgNameElement.textContent = FALLBACK_ORG_NAME;
                    orgNameElement.style.color = '#f59e0b'; // Orange color for warning
                    orgOwnerElement.textContent = currentUser.email;

                    // Add warning message to the org info section
                    const orgInfoDiv = document.getElementById('org-info');
                    if (orgInfoDiv && !document.getElementById('fallback-warning')) {
                        const warningDiv = document.createElement('div');
                        warningDiv.id = 'fallback-warning';
                        warningDiv.style.cssText = 'background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 0.75rem; margin-top: 1rem; color: #92400e;';
                        warningDiv.innerHTML = '<strong> Mode dgrad:</strong> Connexion  la base de donnes limite. Certaines fonctionnalits peuvent tre indisponibles.';
                        orgInfoDiv.appendChild(warningDiv);
                    }

                    console.log(' Fallback organization loaded:', currentOrganization);
                } else {
                    // Normal mode: organization loaded successfully
                    console.log(' [DEBUG] Normal mode: organization loaded from DB');
                    currentOrganization = orgData[0];
                    console.log(' [DEBUG] Organization data:', currentOrganization);
                    document.getElementById('org-name').textContent = currentOrganization.name;
                    document.getElementById('org-owner').textContent = currentUser.email;

                    // Show "Create New Agency" button only for organization owner
                    if (currentOrganization.owner_id === currentUser.id) {
                        const createAgencyBtn = document.getElementById('create-agency-btn');
                        if (createAgencyBtn) {
                            createAgencyBtn.style.display = 'flex';
                            console.log(' Create agency button enabled for owner');
                        }
                    }
                }

                // Generate invitation code (works with both normal and fallback mode)
                invitationCode = `${currentOrganization.id}:member`;
                console.log(' [DEBUG] Generated invitation code:', invitationCode);
                document.getElementById('invitation-code-display').textContent = invitationCode;

                // Try to load members list, but don't fail if it doesn't work
                console.log(' [DEBUG] Loading members list...');
                try {
                    await loadMembersList();
                    console.log(' [DEBUG] Members list loaded successfully');
                } catch (memberError) {
                    console.warn(' [DEBUG] Could not load members list:', memberError);
                    const container = document.getElementById('members-list');
                    if (container) {
                        container.innerHTML = '<div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; color: #92400e;"><p><strong> Impossible de charger la liste des membres</strong></p><p>La base de donnes rencontre des difficults. Le code d\'invitation ci-dessus reste valide.</p></div>';
                    }
                }

                // Show success message with appropriate context
                if (usedFallback) {
                    console.log(' Team management loaded in fallback mode');
                } else {
                    console.log(' Team management loaded successfully');
                }

            } catch (error) {
                console.error(' Critical error loading team management:', error);

                // Last resort fallback: show minimal UI even on complete failure
                const FALLBACK_ORG_ID = 'e78e20c1-9c57-41bc-9744-ed6b8f0f1908';
                const FALLBACK_ORG_NAME = 'Mon Organisation';

                document.getElementById('org-name').textContent = FALLBACK_ORG_NAME;
                document.getElementById('org-name').style.color = '#ef4444'; // Red color for error
                document.getElementById('org-owner').textContent = currentUser ? currentUser.email : 'Utilisateur';

                // Still generate invitation code even in error state
                invitationCode = `${FALLBACK_ORG_ID}:member`;
                document.getElementById('invitation-code-display').textContent = invitationCode;

                // Show error in org info
                const orgInfoDiv = document.getElementById('org-info');
                if (orgInfoDiv && !document.getElementById('fallback-warning')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'fallback-warning';
                    errorDiv.style.cssText = 'background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 0.75rem; margin-top: 1rem; color: #991b1b;';
                    errorDiv.innerHTML = '<strong> Erreur de connexion:</strong> Impossible de se connecter  la base de donnes. Le code d\'invitation reste disponible ci-dessous.';
                    orgInfoDiv.appendChild(errorDiv);
                }

                // Show error in members list
                const container = document.getElementById('members-list');
                if (container) {
                    container.innerHTML = '<div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 1rem; color: #991b1b;"><p><strong> Erreur</strong></p><p>Impossible de charger les donnes. Veuillez ressayer plus tard.</p></div>';
                }
            }
        }

        async function updateTeamStats(members) {
            const statsContainer = document.getElementById('team-stats');
            if (!statsContainer || !members) return;

            const totalMembers = members.length;
            const admins = members.filter(m => m.role === 'admin').length;
            const regularMembers = members.filter(m => m.role === 'member').length;
            const owner = members.find(m => m.user_id === currentOrganization?.owner_id);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-users" style="color: white; font-size: 1.125rem;"></i>
                        </div>
                        <div>
                            <div class="stat-value">${totalMembers}</div>
                            <div class="stat-label">Membres Total</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-crown" style="color: white; font-size: 1.125rem;"></i>
                        </div>
                        <div>
                            <div class="stat-value">1</div>
                            <div class="stat-label">Propritaire</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user-shield" style="color: white; font-size: 1.125rem;"></i>
                        </div>
                        <div>
                            <div class="stat-value">${admins}</div>
                            <div class="stat-label">Administrateurs</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user" style="color: white; font-size: 1.125rem;"></i>
                        </div>
                        <div>
                            <div class="stat-value">${regularMembers}</div>
                            <div class="stat-label">Membres</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadMembersList() {
            console.log(' [DEBUG] loadMembersList() called');
            try {
                console.log(' [DEBUG] Fetching organization members...');
                const members = await getOrganizationMembers();
                console.log(' [DEBUG] Members received:', members);
                const container = document.getElementById('members-list');
                const countBadge = document.getElementById('team-member-count');

                if (countBadge) {
                    countBadge.textContent = `${members.length} membre${members.length > 1 ? 's' : ''}`;
                }

                // Update team stats
                await updateTeamStats(members);

                if (members.length === 0) {
                    console.log(' [DEBUG] No members found');
                    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #64748b;"><i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i><p style="font-size: 1.125rem; font-weight: 500;">Aucun membre pour le moment</p><p style="font-size: 0.875rem;">Invitez des collaborateurs avec le code ci-dessus</p></div>';
                    return;
                }

                console.log(' [DEBUG] Getting current userId...');
                const userId = await getUserId();
                console.log(' [DEBUG] Current userId:', userId);
                console.log(' [DEBUG] Rendering members list HTML...');

                // Determine role badge class
                const isOwner = (member) => currentOrganization?.owner_id === member.user_id;
                const getRoleBadge = (member) => {
                    if (isOwner(member)) return 'owner';
                    return member.role === 'admin' ? 'admin' : 'member';
                };
                const getRoleLabel = (member) => {
                    if (isOwner(member)) return 'Propritaire';
                    if (member.role === 'admin') return 'Admin';
                    return 'Membre';
                };

                // Le fondateur ne peut JAMAIS tre supprim
                const FOUNDER_EMAIL = 'florent.media2@gmail.com';
                const isFounder = (member) => member.email === FOUNDER_EMAIL;
                const canDeleteMember = (member) => {
                    // Ne jamais pouvoir supprimer le fondateur
                    if (isFounder(member)) return false;
                    // Ne peut supprimer que si on est owner et que ce n'est pas soi-mme
                    return currentOrganization.owner_id === userId && member.user_id !== userId;
                };

                container.innerHTML = members.map((member, index) => `
                    <div class="member-card" style="animation-delay: ${index * 0.05}s;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0;">
                                <div class="member-avatar">
                                    ${member.pseudo ? member.pseudo.charAt(0).toUpperCase() : 'U'}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; color: var(--text-color); font-size: 1.0625rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis;">
                                        ${member.pseudo || 'Utilisateur'}
                                        ${isFounder(member) ? '<i class="fas fa-crown" style="color: #f59e0b; margin-left: 0.5rem;" title="Fondateur"></i>' : ''}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                        <span class="role-badge ${getRoleBadge(member)}">
                                            ${isFounder(member) ? 'Fondateur' : getRoleLabel(member)}
                                        </span>
                                        ${member.email ? `<span style="font-size: 0.8125rem; color: #64748b;">${member.email}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${canDeleteMember(member) ? `
                                <button onclick="removeMember('${member.id}')" style="width: 36px; height: 36px; background: #fef2f2; color: #ef4444; border: 1px solid #fecaca; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.background='#fee2e2'; this.style.borderColor='#fca5a5'" onmouseout="this.style.background='#fef2f2'; this.style.borderColor='#fecaca'">
                                    <i class="fas fa-trash" style="font-size: 0.875rem;"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        function copyInvitationCode() {
            const code = invitationCode;
            navigator.clipboard.writeText(code);
            showSuccess('Code copi dans le presse-papier !');
        }

        async function acceptInvitationCode(e) {
            e.preventDefault();
            const code = document.getElementById('invitation-code-input').value.trim();

            try {
                await acceptInvitation(code);
                showSuccess('Vous avez rejoint l\'quipe avec succs ! Rechargement...');
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                console.error('Error accepting invitation:', error);
                showError('Code d\'invitation invalide');
            }
        }

        async function removeMember(memberId) {
            // Protection: vrifier que ce n'est pas le fondateur
            const members = await getOrganizationMembers();
            const memberToRemove = members.find(m => m.id === memberId);

            if (memberToRemove && memberToRemove.email === 'florent.media2@gmail.com') {
                showError('Le fondateur ne peut pas tre supprim');
                return;
            }

            if (!confirm('tes-vous sr de vouloir retirer ce membre ?')) return;

            try {
                await removeMemberFromOrganization(memberId);
                showSuccess('Membre retir');
                await loadMembersList();
            } catch (error) {
                console.error('Error removing member:', error);
                showError('Erreur lors de la suppression');
            }
        }

        // ============================================================================
        // ADMIN PANEL FUNCTIONS
        // ============================================================================

        async function loadAdminStats() {
            console.log(' Loading admin statistics...');
            try {
                // Load organization members
                const members = await getOrganizationMembers();
                const memberCount = members.length;

                // Update all member count displays
                document.getElementById('admin-member-count-header').textContent = `${memberCount} membre${memberCount > 1 ? 's' : ''} dans votre organisation`;
                document.getElementById('admin-total-members').textContent = memberCount;

                // Load VAs count
                const vasCount = data.vas.length;
                document.getElementById('admin-vas-count').textContent = vasCount;

                // Load creators count
                const creatorsCount = data.creators.length;
                document.getElementById('admin-creators-count').textContent = creatorsCount;

                // Load social accounts count
                const socialAccountsCount = data.twitterAccounts.length + data.instagramAccounts.length;
                document.getElementById('admin-social-accounts').textContent = socialAccountsCount;

                // Load members table
                await loadAdminMembersTable(members);

                console.log(' Admin stats loaded:', { members: memberCount, vas: vasCount, creators: creatorsCount, socialAccounts: socialAccountsCount });
            } catch (error) {
                console.error(' Error loading admin stats:', error);
                showError('Erreur lors du chargement des statistiques');
            }
        }

        async function loadAdminMembersTable(members) {
            const container = document.getElementById('admin-members-table');
            const currentUserId = currentUser.id;
            const organization = await getUserOrganization();
            const isOwner = organization && organization.owner_id === currentUserId;
            const isDarkMode = document.body.classList.contains('dark-mode');

            if (!members || members.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #94a3b8;"><p>Aucun membre pour le moment</p></div>';
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#f8fafc'}; border-bottom: 2px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.1)' : '#e2e8f0'};">
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#475569'};">Membre</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#475569'};">Rle</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#475569'};">Date d'ajout</th>
                            <th style="padding: 1rem; text-align: center; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#475569'};">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const member of members) {
                const isCurrentUser = member.user_id === currentUserId;
                const isMemberOwner = member.role === 'owner';
                const joinDate = member.created_at ? new Date(member.created_at).toLocaleDateString('fr-FR') : 'N/A';

                // Get role badge color
                let roleBadgeStyle = '';
                let roleIcon = '';
                let roleText = '';

                if (member.role === 'owner') {
                    roleBadgeStyle = 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;';
                    roleIcon = 'fa-crown';
                    roleText = 'OWNER';
                } else if (member.role === 'admin') {
                    // Style jaune pour admin
                    roleBadgeStyle = 'background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; font-weight: 700; box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);';
                    roleIcon = 'fa-shield-alt';  // Bouclier
                    roleText = 'ADMIN';
                } else {
                    roleBadgeStyle = 'background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;';
                    roleIcon = 'fa-user';
                    roleText = 'MEMBER';
                }

                tableHtml += `
                    <tr style="border-bottom: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.1)' : '#e2e8f0'}; transition: all 0.2s; background: ${isDarkMode ? 'transparent' : 'white'};" onmouseover="this.style.background='${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#f8fafc'}'" onmouseout="this.style.background='${isDarkMode ? 'transparent' : 'white'}'">
                        <td style="padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);">
                                    ${member.pseudo ? member.pseudo.charAt(0).toUpperCase() : 'U'}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1a1a1a'}; font-size: 1rem;">
                                        ${member.pseudo || 'Utilisateur'}
                                        ${isCurrentUser ? '<span style="font-size: 0.75rem; color: #10b981; margin-left: 0.5rem;">(Vous)</span>' : ''}
                                    </div>
                                    <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">ID: ${member.user_id.substring(0, 8)}...</div>
                                </div>
                            </div>
                        </td>
                        <td style="padding: 1rem;">
                            <span style="padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; ${roleBadgeStyle} display: inline-block; position: relative;">
                                <i class="fas ${roleIcon}"></i>
                                ${roleText}
                            </span>
                        </td>
                        <td style="padding: 1rem; color: #64748b; font-size: 0.95rem;">
                            <i class="fas fa-calendar" style="margin-right: 0.5rem; color: #94a3b8;"></i>
                            ${joinDate}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            ${isOwner && !isMemberOwner && !isCurrentUser ? `
                                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="changeMemberRole('${member.user_id}', '${member.role}')"
                                            style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;"
                                            onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                        <i class="fas fa-user-edit"></i> Rle
                                    </button>
                                    <button onclick="adminRemoveMember('${member.user_id}', '${member.pseudo || 'Utilisateur'}')"
                                            style="padding: 0.5rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;"
                                            onmouseover="this.style.background='#d97706'" onmouseout="this.style.background='#f59e0b'">
                                        <i class="fas fa-user-times"></i> Retirer
                                    </button>
                                    <button onclick="deleteUserAccount('${member.user_id}', '${member.pseudo || 'Utilisateur'}', '${member.email || 'N/A'}')"
                                            style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;"
                                            onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'"
                                            title="Supprime DFINITIVEMENT le compte">
                                        <i class="fas fa-trash-alt"></i> Supprimer
                                    </button>
                                </div>
                            ` : isMemberOwner ? `
                                <span style="color: #94a3b8; font-size: 0.875rem; font-style: italic;">
                                    <i class="fas fa-lock"></i> Propritaire
                                </span>
                            ` : isCurrentUser ? `
                                <span style="color: #94a3b8; font-size: 0.875rem; font-style: italic;">
                                    <i class="fas fa-user"></i> Vous
                                </span>
                            ` : `
                                <span style="color: #94a3b8; font-size: 0.875rem; font-style: italic;">-</span>
                            `}
                        </td>
                    </tr>
                `;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml;
        }

        // Switch between admin tabs
        function switchAdminTab(tabName) {
            const isDarkMode = document.body.classList.contains('dark-mode');

            // Update tab buttons
            const teamTab = document.getElementById('admin-tab-team');
            const allTab = document.getElementById('admin-tab-all');

            if (tabName === 'team') {
                teamTab.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                teamTab.style.color = 'white';
                teamTab.style.boxShadow = '0 -2px 10px rgba(102, 126, 234, 0.3)';
                allTab.style.background = 'rgba(148, 163, 184, 0.1)';
                allTab.style.color = '#64748b';
                allTab.style.boxShadow = 'none';

                document.getElementById('admin-team-section').style.display = 'block';
                document.getElementById('admin-all-section').style.display = 'none';
            } else if (tabName === 'all') {
                allTab.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                allTab.style.color = 'white';
                allTab.style.boxShadow = '0 -2px 10px rgba(102, 126, 234, 0.3)';
                teamTab.style.background = 'rgba(148, 163, 184, 0.1)';
                teamTab.style.color = '#64748b';
                teamTab.style.boxShadow = 'none';

                document.getElementById('admin-team-section').style.display = 'none';
                document.getElementById('admin-all-section').style.display = 'block';

                // Load all users when switching to this tab
                loadAllPlatformUsers();
            }
        }

        // Load all platform users
        async function loadAllPlatformUsers() {
            console.log(' Loading all platform users...');
            const container = document.getElementById('admin-all-users-table');
            const countHeader = document.getElementById('admin-all-users-count-header');
            const isDarkMode = document.body.classList.contains('dark-mode');

            try {
                // Show loading
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2.5rem; margin-bottom: 1rem;"></i>
                        <p>Chargement de tous les utilisateurs...</p>
                    </div>
                `;

                // Get all users from the platform
                const allUsers = await getAllPlatformUsers();

                if (!allUsers || allUsers.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #94a3b8;"><p>Aucun utilisateur trouv</p></div>';
                    countHeader.textContent = '0 utilisateur';
                    return;
                }

                countHeader.textContent = `${allUsers.length} utilisateur${allUsers.length > 1 ? 's' : ''} sur la plateforme`;

                // Build ultra-detailed table
                let tableHtml = `
                    <table style="width: 100%; border-collapse: collapse; min-width: 1200px;">
                        <thead>
                            <tr style="background: ${isDarkMode ? 'rgba(102, 126, 234, 0.15)' : 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))'}; border-bottom: 2px solid ${isDarkMode ? 'rgba(102, 126, 234, 0.3)' : 'rgba(102, 126, 234, 0.3)'};">
                                <th style="padding: 1.25rem 1rem; text-align: left; font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'}; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-user" style="margin-right: 0.5rem; color: #667eea;"></i>Utilisateur
                                </th>
                                <th style="padding: 1.25rem 1rem; text-align: left; font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'}; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-envelope" style="margin-right: 0.5rem; color: #667eea;"></i>Email
                                </th>
                                <th style="padding: 1.25rem 1rem; text-align: center; font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'}; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-building" style="margin-right: 0.5rem; color: #667eea;"></i>Organisations
                                </th>
                                <th style="padding: 1.25rem 1rem; text-align: left; font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'}; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-shield-alt" style="margin-right: 0.5rem; color: #667eea;"></i>Rles
                                </th>
                                <th style="padding: 1.25rem 1rem; text-align: left; font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'}; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-calendar" style="margin-right: 0.5rem; color: #667eea;"></i>Inscrit le
                                </th>
                                <th style="padding: 1.25rem 1rem; text-align: left; font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'}; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-clock" style="margin-right: 0.5rem; color: #667eea;"></i>Dernire Connexion
                                </th>
                                <th style="padding: 1.25rem 1rem; text-align: center; font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'}; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-cog" style="margin-right: 0.5rem; color: #667eea;"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const user of allUsers) {
                    const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString('fr-FR') : 'N/A';
                    const lastSignIn = user.last_sign_in ? new Date(user.last_sign_in).toLocaleDateString('fr-FR') + ' ' + new Date(user.last_sign_in).toLocaleTimeString('fr-FR') : 'Jamais';

                    tableHtml += `
                        <tr style="border-bottom: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.1)' : '#e2e8f0'}; transition: all 0.2s; background: ${isDarkMode ? 'transparent' : 'white'};" onmouseover="this.style.background='${isDarkMode ? 'rgba(102, 126, 234, 0.1)' : 'rgba(102, 126, 234, 0.05)'}'" onmouseout="this.style.background='${isDarkMode ? 'transparent' : 'white'}'">
                            <td style="padding: 1.25rem 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); flex-shrink: 0;">
                                        ${user.pseudo ? user.pseudo.charAt(0).toUpperCase() : 'U'}
                                    </div>
                                    <div style="min-width: 0;">
                                        <div style="font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'}; font-size: 1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${user.pseudo || 'Utilisateur'}
                                            ${user.is_owner_of.length > 0 ? '<i class="fas fa-crown" style="color: #f59e0b; margin-left: 0.5rem;" title="Propritaire d\'organisation"></i>' : ''}
                                        </div>
                                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-family: monospace; margin-top: 0.25rem;">
                                            ID: ${user.user_id.substring(0, 8)}...
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 1.25rem 1rem;">
                                <div style="font-size: 0.9rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'}; font-family: monospace;">
                                    ${user.email !== 'N/A' ? user.email : '<span style="color: #94a3b8; font-style: italic;">Non disponible</span>'}
                                </div>
                            </td>
                            <td style="padding: 1.25rem 1rem; text-align: center;">
                                <span style="display: inline-block; padding: 0.375rem 0.875rem; background: ${isDarkMode ? 'rgba(102, 126, 234, 0.2)' : 'rgba(102, 126, 234, 0.1)'}; color: #667eea; border-radius: 1rem; font-weight: 600; font-size: 1.125rem; border: 1px solid rgba(102, 126, 234, 0.3);">
                                    ${user.total_organizations}
                                </span>
                            </td>
                            <td style="padding: 1.25rem 1rem;">
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    ${user.organizations.map(org => {
                                        let roleColor = org.role === 'owner' ? '#ef4444' : org.role === 'admin' ? '#f59e0b' : '#3b82f6';
                                        let roleIcon = org.role === 'owner' ? 'fa-crown' : org.role === 'admin' ? 'fa-shield-alt' : 'fa-user';
                                        return `
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="padding: 0.25rem 0.625rem; background: ${roleColor}; color: white; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: inline-flex; align-items: center; gap: 0.25rem;">
                                                    <i class="fas ${roleIcon}" style="font-size: 0.625rem;"></i>
                                                    ${org.role}
                                                </span>
                                                <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'}; font-weight: 500;">
                                                    ${org.org_name}
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </td>
                            <td style="padding: 1.25rem 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-calendar-plus" style="color: #10b981; font-size: 0.875rem;"></i>
                                    <span style="font-size: 0.9rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">${createdDate}</span>
                                </div>
                            </td>
                            <td style="padding: 1.25rem 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-sign-in-alt" style="color: ${user.last_sign_in ? '#8b5cf6' : '#94a3b8'}; font-size: 0.875rem;"></i>
                                    <span style="font-size: 0.9rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">${lastSignIn}</span>
                                </div>
                            </td>
                            <td style="padding: 1.25rem 1rem; text-align: center;">
                                ${user.email === 'florent.media2@gmail.com' ? `
                                    <span style="color: #f59e0b; font-size: 0.875rem; font-weight: 600;">
                                        <i class="fas fa-crown"></i> Fondateur
                                    </span>
                                ` : user.user_id !== currentUser.id ? `
                                    <button onclick="deletePlatformUserConfirm('${user.user_id}', '${user.pseudo}', '${user.email}')"
                                            style="padding: 0.625rem 1rem; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                            title="Supprimer dfinitivement cet utilisateur du site">
                                        <i class="fas fa-trash-alt"></i> Supprimer
                                    </button>
                                ` : `
                                    <span style="color: #94a3b8; font-size: 0.875rem; font-style: italic;">
                                        <i class="fas fa-user"></i> Vous
                                    </span>
                                `}
                            </td>
                        </tr>
                    `;
                }

                tableHtml += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHtml;
                console.log(` Loaded ${allUsers.length} platform users`);
            } catch (error) {
                console.error(' Error loading all platform users:', error);
                console.error('Full error object:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;">Erreur lors du chargement des utilisateurs</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem; color: #94a3b8;">${error.message || 'Erreur inconnue'}</p>
                        <details style="margin-top: 1rem; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                            <summary style="cursor: pointer; color: #667eea; font-weight: 600;">Dtails techniques</summary>
                            <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; font-size: 0.75rem; overflow-x: auto;">${JSON.stringify(error, null, 2)}</pre>
                        </details>
                        <button onclick="loadAllPlatformUsers()" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-sync-alt"></i> Ressayer
                        </button>
                    </div>
                `;
                countHeader.textContent = 'Erreur de chargement';
            }
        }

        // Delete platform user with confirmation
        async function deletePlatformUserConfirm(userId, pseudo, email) {
            // Protection: le fondateur ne peut JAMAIS tre supprim
            if (email === 'florent.media2@gmail.com') {
                showError('Le fondateur ne peut pas tre supprim');
                return;
            }

            const confirmMessage = ` ATTENTION CRITIQUE 

Vous tes sur le point de SUPPRIMER DFINITIVEMENT cet utilisateur :

 Pseudo : ${pseudo}
 Email : ${email}
 ID : ${userId}

Cette action va SUPPRIMER :
 Le compte utilisateur
 Son profil
 Toutes ses appartenances aux organisations
 TOUTES ses donnes associes

 CETTE ACTION EST IRRVERSIBLE 

Tapez "SUPPRIMER" pour confirmer :`;

            const userInput = prompt(confirmMessage);

            if (userInput !== 'SUPPRIMER') {
                if (userInput !== null) {
                    showError('Suppression annule : vous devez taper exactement "SUPPRIMER"');
                }
                return;
            }

            try {
                showLoadingOverlay();
                console.log(` Deleting user ${userId}...`);

                // Call the delete function
                await deletePlatformUser(userId);

                showSuccess(` Utilisateur "${pseudo}" supprim dfinitivement du site`);

                // Reload the users list
                await loadAllPlatformUsers();

                hideLoadingOverlay();
            } catch (error) {
                console.error(' Error deleting platform user:', error);
                hideLoadingOverlay();
                showError(`Erreur lors de la suppression : ${error.message}`);
            }
        }

        // Helper function to require owner permission
        async function requireOwnerPermission() {
            const orgId = await getOrganizationId();
            const { data: org } = await supabase
                .from('organizations')
                .select('owner_id')
                .eq('id', orgId)
                .single();

            if (!org || org.owner_id !== currentUser.id) {
                throw new Error('Permission refuse : action rserve au propritaire');
            }
        }

        async function changeMemberRole(userId, currentRole) {
            // Check owner permission
            try {
                await requireOwnerPermission();
            } catch (error) {
                showError(error.message);
                return;
            }
            const newRole = currentRole === 'admin' ? 'member' : 'admin';
            const confirmMsg = `Voulez-vous changer le rle de ce membre en "${newRole}" ?`;

            if (!confirm(confirmMsg)) return;

            try {
                await supabase
                    .from('organization_members')
                    .update({ role: newRole })
                    .eq('user_id', userId)
                    .eq('organization_id', await getOrganizationId());

                showSuccess(`Rle modifi en "${newRole}" avec succs`);
                await loadAdminStats(); // Reload the table
            } catch (error) {
                console.error('Error changing member role:', error);
                showError('Erreur lors du changement de rle');
            }
        }

        async function adminRemoveMember(userId, pseudo) {
            // Check owner permission if removing an admin
            const { data: member } = await supabase
                .from('organization_members')
                .select('role')
                .eq('user_id', userId)
                .eq('organization_id', await getOrganizationId())
                .single();

            if (member && member.role === 'admin') {
                try {
                    await requireOwnerPermission();
                } catch (error) {
                    showError(error.message);
                    return;
                }
            }

            const confirmMsg = ` ATTENTION \n\ntes-vous sr de vouloir retirer "${pseudo}" de votre organisation ?\n\nCette action est irrversible.`;

            if (!confirm(confirmMsg)) return;

            try {
                await supabase
                    .from('organization_members')
                    .delete()
                    .eq('user_id', userId)
                    .eq('organization_id', await getOrganizationId());

                showSuccess(`${pseudo} a t retir de l'organisation`);
                await loadAdminStats(); // Reload the table
            } catch (error) {
                console.error('Error removing member:', error);
                showError('Erreur lors de la suppression du membre');
            }
        }

        async function deleteUserAccount(userId, pseudo, email) {
            // Check owner permission
            try {
                await requireOwnerPermission();
            } catch (error) {
                showError(error.message);
                return;
            }

            const confirmMsg = ` SUPPRESSION TOTALE DU COMPTE \n\ntes-vous ABSOLUMENT sr de vouloir SUPPRIMER DFINITIVEMENT le compte de "${pseudo}" (${email}) ?\n\nCette action va :\n Supprimer le profil utilisateur\n Retirer de l'organisation\n Supprimer le compte d'authentification\n\n CETTE ACTION EST IRRVERSIBLE \n\nTapez "SUPPRIMER" pour confirmer :`;

            const confirmation = prompt(confirmMsg);

            if (confirmation !== 'SUPPRIMER') {
                showError('Suppression annule');
                return;
            }

            try {
                // 1. Delete from organization_members
                const { error: orgError } = await supabase
                    .from('organization_members')
                    .delete()
                    .eq('user_id', userId);

                if (orgError) throw orgError;

                // 2. Delete from user_profiles
                const { error: profileError } = await supabase
                    .from('user_profiles')
                    .delete()
                    .eq('user_id', userId);

                if (profileError) throw profileError;

                // 3. Call Edge Function to delete from Auth (requires admin privileges)
                try {
                    const { data, error: authError } = await supabase.functions.invoke('delete-user', {
                        body: { userId: userId }
                    });

                    if (authError) {
                        console.warn(' Could not delete auth user (may require manual deletion):', authError);
                        showSuccess(`Compte de ${pseudo} supprim de l'app.\n\n Pour supprimer compltement le compte Auth, allez sur Supabase Dashboard > Authentication > Users et supprimez ${email} manuellement.`);
                    } else {
                        showSuccess(` Compte de ${pseudo} compltement supprim !`);
                    }
                } catch (fnError) {
                    console.warn(' Edge function not available:', fnError);
                    showSuccess(`Profil et donnes de ${pseudo} supprims.\n\n Pour supprimer le compte Auth, allez sur Supabase Dashboard > Authentication > Users et supprimez ${email} manuellement.`);
                }

                await loadAdminStats(); // Reload the table
            } catch (error) {
                console.error('Error deleting user account:', error);
                showError('Erreur lors de la suppression du compte');
            }
        }

        function showAddMemberModal() {
            showInfo('Pour ajouter un membre, partagez le code d\'invitation depuis la page "quipe"');
            navigateToPage('team-management');
        }

        function showMemberActivityLog() {
            showInfo('Journal d\'activit - Fonctionnalit en dveloppement');
        }

        function showDangerZone() {
            const confirmed = confirm(' ZONE DANGEREUSE \n\nVoulez-vous vraiment supprimer TOUTES les donnes de votre organisation ?\n\nCette action est IRRVERSIBLE et supprimera :\n- Toutes les VAs\n- Toutes les cratrices\n- Tous les comptes sociaux\n- Toutes les statistiques\n- Tous les revenus\n\nTapez "SUPPRIMER" pour confirmer');

            if (confirmed) {
                const confirmation = prompt('Tapez "SUPPRIMER" en majuscules pour confirmer la suppression totale :');
                if (confirmation === 'SUPPRIMER') {
                    deleteAllOrganizationData();
                } else {
                    showInfo('Suppression annule');
                }
            }
        }

        async function deleteAllOrganizationData() {
            // Check owner permission
            try {
                await requireOwnerPermission();
            } catch (error) {
                showError(error.message);
                return;
            }

            try {
                const orgId = await getOrganizationId();

                showInfo('Suppression en cours...');

                // Delete all data in order
                await supabase.from('twitter_stats').delete().eq('organization_id', orgId);
                await supabase.from('payments').delete().eq('organization_id', orgId);
                await supabase.from('revenues').delete().eq('organization_id', orgId);
                await supabase.from('subscriptions').delete().eq('organization_id', orgId);
                await supabase.from('twitter_accounts').delete().eq('organization_id', orgId);
                await supabase.from('instagram_accounts').delete().eq('organization_id', orgId);
                await supabase.from('gmail_accounts').delete().eq('organization_id', orgId);
                await supabase.from('va_creator').delete().eq('organization_id', orgId);
                await supabase.from('creators').delete().eq('organization_id', orgId);
                await supabase.from('vas').delete().eq('organization_id', orgId);

                showSuccess('Toutes les donnes ont t supprimes. Rechargement...');
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                console.error('Error deleting all data:', error);
                showError('Erreur lors de la suppression des donnes');
            }
        }

        async function exportAllData() {
            try {
                showInfo('Export en cours...');

                const exportData = {
                    organization: await getUserOrganization(),
                    members: await getOrganizationMembers(),
                    vas: data.vas,
                    creators: data.creators,
                    twitterAccounts: data.twitterAccounts,
                    instagramAccounts: data.instagramAccounts,
                    gmailAccounts: data.gmailAccounts,
                    subscriptions: data.subs,
                    revenues: data.revenues,
                    payments: data.payments,
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `va-manager-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showSuccess('Donnes exportes avec succs !');
            } catch (error) {
                console.error('Error exporting data:', error);
                showError('Erreur lors de l\'export des donnes');
            }
        }

        function showDataStats() {
            const totalTwitter = data.twitterAccounts.length;
            const totalInstagram = data.instagramAccounts.length;
            const totalGmail = data.gmailAccounts.length;
            const totalSubs = data.subs.reduce((sum, sub) => sum + (sub.count || 0), 0);
            const totalRevenue = data.revenues.reduce((sum, rev) => sum + (rev.amount || 0), 0);
            const totalPayments = data.payments.reduce((sum, pay) => sum + (pay.amount || 0), 0);

            const statsMessage = `
 STATISTIQUES DTAILLES

 Membres: ${data.vas.length} VAs, ${data.creators.length} Cratrices

 Comptes:
- Twitter: ${totalTwitter}
- Instagram: ${totalInstagram}
- Gmail: ${totalGmail}

 Performance:
- Total Abonns: ${formatNumber(totalSubs)}
- Revenus Totaux: ${formatNumber(totalRevenue)}
- Paiements: ${formatNumber(totalPayments)}
- Profit Net: ${formatNumber(totalRevenue - totalPayments)}
            `;

            alert(statsMessage);
        }

        function showEditOrgModal() {
            const newName = prompt('Nouveau nom de l\'organisation:', currentOrganization.name);
            if (newName && newName.trim() !== '') {
                updateOrganizationName(newName.trim());
            }
        }

        async function updateOrganizationName(newName) {
            try {
                await updateOrganization({ name: newName });
                showSuccess('Organisation renomme avec succs');
                currentOrganization.name = newName;
                document.getElementById('org-name').textContent = newName;
            } catch (error) {
                console.error('Error updating organization:', error);
                showError('Erreur lors de la mise  jour');
            }
        }

        async function showAllMemberEmails() {
            try {
                const members = await getOrganizationMembers();

                if (members.length === 0) {
                    alert('Aucun membre dans l\'organisation');
                    return;
                }

                let emailList = 'EMAILS DES MEMBRES\n' + '='.repeat(50) + '\n\n';

                members.forEach(member => {
                    emailList += `Pseudo: ${member.pseudo}\n`;
                    emailList += `Email: ${member.email || 'Non disponible'}\n`;
                    emailList += `Rle: ${member.role}\n`;
                    emailList += `Date d'ajout: ${member.created_at ? new Date(member.created_at).toLocaleDateString('fr-FR') : 'N/A'}\n`;
                    emailList += '-'.repeat(50) + '\n\n';
                });

                // Create modal to display emails
                const isDarkMode = document.body.classList.contains('dark-mode');
                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px; ${isDarkMode ? 'background: #1f2937; color: #f3f4f6;' : ''}">
                        <div class="modal-header" style="${isDarkMode ? 'border-bottom-color: #374151;' : ''}">
                            <h2 style="${isDarkMode ? 'color: #f9fafb;' : ''}">Emails des Membres (${members.length})</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()" style="${isDarkMode ? 'color: #9ca3af;' : ''}"></button>
                        </div>
                        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                            <pre style="background: ${isDarkMode ? '#111827' : '#f3f4f6'}; color: ${isDarkMode ? '#e5e7eb' : '#1f2937'}; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'};">${emailList}</pre>
                        </div>
                        <div style="padding: 1rem; text-align: center; ${isDarkMode ? 'border-top: 1px solid #374151;' : ''}">
                            <button onclick="copyToClipboard(\`${emailList.replace(/`/g, '\\`')}\`); showSuccess('Emails copis dans le presse-papier')" class="btn" style="background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-copy"></i> Copier tous les emails
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error showing member emails:', error);
                showError('Erreur lors du chargement des emails');
            }
        }

        // Update creators statistics
        function updateCreatorsStats() {
            const container = document.getElementById('creators-comparison');
            if (!container) return;
            
            // Utiliser directement la nouvelle structure data.creators
            const creatorsMap = new Map();
            
            if (data.creators) {
                data.creators.forEach(creator => {
                    // Trouver les VAs associs  cette cratrice
                    const associatedVAs = [];
                    if (creator.vaIds) {
                        creator.vaIds.forEach(vaId => {
                            const va = data.vas.find(v => v.id === vaId);
                            if (va) {
                                associatedVAs.push(va.name);
                            }
                        });
                    }
                    
                    creatorsMap.set(creator.name, {
                        name: creator.name,
                        accountsCount: creator.accounts ? creator.accounts.length : 0,
                        vas: associatedVAs
                    });
                });
            }
            
            // Convertir en tableau et trier par nombre de comptes (dcroissant)
            const allCreators = Array.from(creatorsMap.values());
            allCreators.sort((a, b) => b.accountsCount - a.accountsCount);
            
            if (allCreators.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.8;">Aucune cratrice ajoute</p>';
                return;
            }
            
            // Crer les barres de progression
            const maxAccounts = Math.max(...allCreators.map(c => c.accountsCount));
            
            container.innerHTML = allCreators.map(creator => {
                const percentage = maxAccounts > 0 ? (creator.accountsCount / maxAccounts) * 100 : 0;
                
                let barColor = '#22c55e';
                if (creator.accountsCount === 0) barColor = '#ef4444';
                else if (creator.accountsCount >= 10) barColor = '#dc2626';
                else if (creator.accountsCount >= 5) barColor = '#f59e0b';
                
                // Position du nombre (centr si la barre est assez large, sinon  droite)
                const numberPosition = percentage > 30 ? 'left: 8px;' : 'left: calc(' + percentage + '% + 8px);';
                const textColor = percentage > 30 ? 'white' : 'black';
                
                return `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.25rem;">
                        <div style="flex: 0 0 120px; text-align: right;">
                            <strong style="font-size: 0.9rem;">${creator.name}</strong>
                        </div>
                        <div style="flex: 1; background: rgba(255,255,255,0.2); border-radius: 8px; height: 28px; position: relative; overflow: visible;">
                            <div style="background: ${barColor}; height: 100%; width: ${percentage}%; transition: width 0.5s ease; border-radius: 8px;">
                            </div>
                            <span style="position: absolute; ${numberPosition} top: 50%; transform: translateY(-50%); font-size: 0.8rem; font-weight: 700; color: ${textColor}; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                ${creator.accountsCount} compte${creator.accountsCount > 1 ? 's' : ''}
                            </span>
                        </div>
                        <div style="flex: 0 0 auto; font-size: 0.7rem; opacity: 0.8; text-align: right; min-width: 80px;">
                            ${creator.vas.length > 1 ? `${creator.vas.length} VAs` : creator.vas[0]}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================================
        // BANNED ACCOUNTS MANAGEMENT FUNCTIONS
        // ============================================================================

        // Count banned/suspended accounts for a specific VA
        function countProblematicAccounts(vaId) {
            let count = 0;

            if (!data.creators) return 0;

            data.creators.forEach(creator => {
                // Count problematic Twitter accounts assigned to this VA
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        // Check if account is assigned to this VA AND is banned/suspended
                        if (account.assignedVaId === vaId &&
                            (account.status === 'banned' || account.status === 'suspended')) {
                            count++;
                        }
                    });
                }

                // Count problematic Instagram accounts assigned to this VA
                if (creator.instagramAccounts) {
                    creator.instagramAccounts.forEach(account => {
                        // Check if account is assigned to this VA AND is banned/suspended
                        if (account.assignedVaId === vaId &&
                            (account.status === 'banned' || account.status === 'suspended')) {
                            count++;
                        }
                    });
                }
            });

            return count;
        }

        // Get all banned/suspended accounts across all VAs
        function getAllProblematicAccounts() {
            const problematic = [];

            if (!data.creators) return problematic;

            data.creators.forEach(creator => {
                // Twitter accounts
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        if (account.status === 'banned' || account.status === 'suspended') {
                            problematic.push({
                                type: 'twitter',
                                username: account.username,
                                status: account.status,
                                creator: creator.name,
                                vaIds: creator.vaIds || [],
                                notes: account.notes
                            });
                        }
                    });
                }

                // Instagram accounts
                if (creator.instagramAccounts) {
                    creator.instagramAccounts.forEach(account => {
                        if (account.status === 'banned' || account.status === 'suspended') {
                            problematic.push({
                                type: 'instagram',
                                username: account.username,
                                status: account.status,
                                creator: creator.name,
                                vaIds: creator.vaIds || [],
                                notes: account.notes
                            });
                        }
                    });
                }
            });

            return problematic;
        }

        // Update the banned accounts alert banner
        function updateBannedAccountsAlert() {
            const alert = document.getElementById('banned-accounts-alert');
            const message = document.getElementById('banned-accounts-message');

            if (!alert || !message) return;

            const problematicAccounts = getAllProblematicAccounts();
            const totalCount = problematicAccounts.length;

            if (totalCount === 0) {
                alert.style.display = 'none';
            } else {
                alert.style.display = 'block';

                const bannedCount = problematicAccounts.filter(a => a.status === 'banned').length;
                const suspendedCount = problematicAccounts.filter(a => a.status === 'suspended').length;

                let msg = `<strong>${totalCount} compte${totalCount > 1 ? 's' : ''} ncessite${totalCount > 1 ? 'nt' : ''} un remplacement</strong>`;

                const details = [];
                if (bannedCount > 0) details.push(`${bannedCount} banni${bannedCount > 1 ? 's' : ''}`);
                if (suspendedCount > 0) details.push(`${suspendedCount} suspendu${suspendedCount > 1 ? 's' : ''}`);

                if (details.length > 0) {
                    msg += ` (${details.join(', ')})`;
                }

                message.innerHTML = msg;
            }
        }

        // Filter and show only banned accounts
        function filterBannedAccounts() {
            const problematicAccounts = getAllProblematicAccounts();

            if (problematicAccounts.length === 0) {
                alert('Aucun compte banni ou suspendu trouv ! ');
                return;
            }

            // Create modal content
            let modalContent = `
                <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                        <h2 style="margin: 0; color: #1e293b; font-size: 1.5rem; font-weight: 700;">
                            <i class="fas fa-exclamation-triangle" style="color: #dc2626; margin-right: 0.5rem;"></i>
                            Comptes Problmatiques (${problematicAccounts.length})
                        </h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 2rem; color: #64748b; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'; this.style.color='#1e293b'" onmouseout="this.style.background='none'; this.style.color='#64748b'"></button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
            `;

            problematicAccounts.forEach(account => {
                const statusColor = account.status === 'banned' ? '#dc2626' : '#f59e0b';
                const statusEmoji = account.status === 'banned' ? '' : '';
                const statusText = account.status === 'banned' ? 'BANNI' : 'SUSPENDU';
                const icon = account.type === 'twitter' ? 'fab fa-twitter' : 'fab fa-instagram';
                const iconColor = account.type === 'twitter' ? '#1da1f2' : '#c13584';

                const vaNames = account.vaIds.map(vaId => {
                    const va = data.vas.find(v => v.id === vaId);
                    return va ? va.name : 'Inconnu';
                }).join(', ');

                modalContent += `
                    <div style="background: #f8fafc; border: 2px solid ${statusColor}; border-radius: 0.75rem; padding: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="${icon}" style="color: ${iconColor}; font-size: 1.25rem;"></i>
                                <strong style="font-size: 1.125rem; color: #1e293b;">${account.username}</strong>
                            </div>
                            <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 700;">
                                ${statusEmoji} ${statusText}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.875rem; color: #64748b;">
                            <div><strong style="color: #475569;">Cratrice:</strong> ${account.creator}</div>
                            <div><strong style="color: #475569;">VA:</strong> ${vaNames || 'Non assign'}</div>
                        </div>
                        ${account.notes ? `
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: white; border-radius: 0.5rem; font-size: 0.875rem; color: #475569;">
                                <strong style="color: #1e293b;">Note:</strong> ${account.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            modalContent += `
                    </div>
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb; text-align: right;">
                        <button onclick="this.closest('.modal').remove()" style="background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                            <i class="fas fa-check"></i> Fermer
                        </button>
                    </div>
                </div>
            `;

            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
        }

        // VA View Toggle
        let currentVAView = 'table';

        function setVAView(view) {
            currentVAView = view;
            const tableBtn = document.getElementById('va-view-table');
            const gridBtn = document.getElementById('va-view-grid');
            const leaderboard = document.getElementById('va-leaderboard');
            const gridContainer = document.getElementById('va-grid');

            if (view === 'table') {
                tableBtn.classList.add('active');
                gridBtn.classList.remove('active');
                leaderboard.style.display = 'block';
                gridContainer.style.display = 'none';
            } else {
                tableBtn.classList.remove('active');
                gridBtn.classList.add('active');
                leaderboard.style.display = 'none';
                gridContainer.style.display = 'grid';
            }
        }

        // Update VA grid - PRO VERSION
        function updateVAGrid() {
            const grid = document.getElementById('va-grid');
            const leaderboardBody = document.getElementById('va-leaderboard-body');

            grid.innerHTML = '';

            // Calculer les stats pour chaque VA
            const vasWithStats = data.vas.map(va => {
                const vaCreators = [];
                let twitterCount = 0;
                let instagramCount = 0;
                let twitterAccounts = []; // Liste des comptes Twitter

                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.vaIds && creator.vaIds.includes(va.id)) {
                            vaCreators.push(creator);

                            // Compter et collecter les comptes Twitter
                            if (creator.accounts) {
                                const filteredTwitter = creator.accounts.filter(account => {
                                    if (creator.vaIds && creator.vaIds.length === 1) return true;
                                    return account.assignedVaId === va.id;
                                });
                                twitterCount += filteredTwitter.length;
                                // Ajouter les comptes avec le nom de la cratrice
                                filteredTwitter.forEach(acc => {
                                    twitterAccounts.push({
                                        ...acc,
                                        creatorName: creator.name
                                    });
                                });
                            }

                            // Compter les comptes Instagram
                            if (creator.instagramAccounts) {
                                const filteredInsta = creator.instagramAccounts.filter(account => {
                                    if (creator.vaIds && creator.vaIds.length === 1) return true;
                                    return account.assignedVaId === va.id;
                                });
                                instagramCount += filteredInsta.length;
                            }
                        }
                    });
                }

                return {
                    ...va,
                    creators: vaCreators,
                    twitterCount,
                    instagramCount,
                    twitterAccounts,
                    totalAccounts: twitterCount + instagramCount
                };
            });

            // Trier par nombre total de comptes (dcroissant)
            vasWithStats.sort((a, b) => b.totalAccounts - a.totalAccounts);

            // === CALCUL DES KPIs GLOBAUX ===
            let totalVAs = vasWithStats.length;
            let totalTwitter = 0;
            let totalInstagram = 0;

            vasWithStats.forEach(va => {
                totalTwitter += va.twitterCount;
                totalInstagram += va.instagramCount;
            });

            const avgAccounts = totalVAs > 0 ? ((totalTwitter + totalInstagram) / totalVAs).toFixed(1) : 0;

            // Mise  jour des KPIs
            document.getElementById('va-kpi-total').textContent = totalVAs;
            document.getElementById('va-kpi-twitter').textContent = totalTwitter;
            document.getElementById('va-kpi-instagram').textContent = totalInstagram;
            document.getElementById('va-kpi-avg').textContent = avgAccounts;

            // === GNRATION DU TABLEAU LEADERBOARD ===
            let tableHtml = '';

            if (vasWithStats.length === 0) {
                tableHtml = `
                    <div style="text-align: center; padding: 3rem; color: var(--dash-text-muted);">
                        <i class="fas fa-user-tie" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                        <p style="font-size: 1.125rem;">Aucun VA ajoute</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem; opacity: 0.7;">Commencez par ajouter un Virtual Assistant</p>
                    </div>
                `;
            } else {
                vasWithStats.forEach((va, index) => {
                    const rank = index + 1;

                    // Classe de rang
                    let rankClass = 'default';
                    let rankContent = rank;
                    if (rank === 1) { rankClass = 'gold'; rankContent = '<i class="fas fa-crown"></i>'; }
                    else if (rank === 2) { rankClass = 'silver'; }
                    else if (rank === 3) { rankClass = 'bronze'; }

                    // Initiale du VA
                    const initial = va.name.charAt(0).toUpperCase();

                    // Gnrer les liens Twitter cliquables
                    let twitterLinksHtml = '';
                    if (va.twitterAccounts.length > 0) {
                        twitterLinksHtml = '<div class="dash-va-twitter-list">';
                        va.twitterAccounts.forEach(acc => {
                            const username = acc.username.replace('@', '');
                            twitterLinksHtml += `
                                <a href="https://x.com/${username}" target="_blank" class="dash-va-twitter-link" onclick="event.stopPropagation()">
                                    <i class="fab fa-twitter"></i>
                                    @${username}
                                </a>
                            `;
                        });
                        twitterLinksHtml += '</div>';
                    } else {
                        twitterLinksHtml = '<span style="color: var(--dash-text-muted); font-size: 0.8125rem;">Aucun compte</span>';
                    }

                    tableHtml += `
                        <div class="dash-va-row" data-rank="${index + 1}">
                            <div class="dash-va-col-rank">
                                <div class="dash-va-rank ${rankClass}">${rankContent}</div>
                            </div>
                            <div class="dash-va-name-cell">
                                <div class="dash-va-avatar">${initial}</div>
                                <div class="dash-va-name-info">
                                    <div class="dash-va-name">${va.name}</div>
                                    <div class="dash-va-subtitle">${va.creators.length} cratrice${va.creators.length > 1 ? 's' : ''}</div>
                                </div>
                            </div>
                            <div class="dash-va-accounts-cell">${twitterLinksHtml}</div>
                            <div class="dash-va-stat total">${va.totalAccounts}</div>
                            <div class="dash-va-actions">
                                <button class="dash-va-action-btn" onclick="event.stopPropagation(); editVA('${va.id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="dash-va-action-btn danger" onclick="event.stopPropagation(); deleteVA('${va.id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }

            leaderboardBody.innerHTML = tableHtml;

            // === GNRATION DES CARTES (pour vue grille - ancien style) ===
            data.vas.forEach(va => {
                const card = createVACard(va);
                grid.appendChild(card);
            });

            if (data.vas.length === 0) {
                grid.innerHTML = '<div class="no-creator">Aucun VA ajoute. Commencez par ajouter un VA!</div>';
            }

            // Update banned accounts alert
            updateBannedAccountsAlert();
        }

        // Create VA card
        function createVACard(va) {
            console.log(` createVACard - Cration carte pour VA "${va.name}" (id: ${va.id})`);
            const card = document.createElement('div');
            card.className = 'va-card';

            // Trouver les cratrices associes  ce VA
            const vaCreators = [];
            let totalAccounts = 0;
            let totalInstagramAccounts = 0;

            console.log(`   Recherche des creators pour VA "${va.name}"`);
            console.log(`   Total creators disponibles: ${data.creators?.length || 0}`);

            if (data.creators) {
                data.creators.forEach(creator => {
                    console.log(`    - Creator "${creator.name}": vaIds = [${creator.vaIds?.join(', ') || 'EMPTY'}]`);
                    if (creator.vaIds && creator.vaIds.includes(va.id)) {
                        console.log(`       MATCH! Creator "${creator.name}" appartient  VA "${va.name}"`);
                        console.log(`         - creator.accounts:`, creator.accounts);
                        console.log(`         - creator.instagramAccounts:`, creator.instagramAccounts);
                        vaCreators.push(creator);
                        // Compter seulement les comptes Twitter assigns  CE VA
                        if (creator.accounts) {
                            const filteredForThisVA = creator.accounts.filter(account => {
                                // Si la cratrice n'a qu'un seul VA, on compte tous ses comptes
                                if (creator.vaIds && creator.vaIds.length === 1) {
                                    return true;
                                }
                                // Si la cratrice a plusieurs VAs, on ne compte que les comptes
                                // explicitement assigns  CE VA
                                return account.assignedVaId === va.id;
                            });
                            totalAccounts += filteredForThisVA.length;
                        }
                        // Compter seulement les comptes Instagram assigns  CE VA
                        if (creator.instagramAccounts) {
                            const filteredInstagramForThisVA = creator.instagramAccounts.filter(account => {
                                // Si la cratrice n'a qu'un seul VA, on compte tous ses comptes
                                if (creator.vaIds && creator.vaIds.length === 1) {
                                    return true;
                                }
                                // Si la cratrice a plusieurs VAs, on ne compte que les comptes
                                // explicitement assigns  CE VA
                                return account.assignedVaId === va.id;
                            });
                            totalInstagramAccounts += filteredInstagramForThisVA.length;
                        }
                    }
                });
            }

            let creatorsHtml = '';
            vaCreators.forEach(creator => {
                // FILTRER les comptes pour ce VA spcifique
                // IMPORTANT: Si la cratrice a plusieurs VAs, on n'affiche QUE les comptes
                // qui ont un assignedVaId correspondant  ce VA
                const filteredAccounts = creator.accounts ? creator.accounts.filter(account => {
                    // Si la cratrice n'a qu'un seul VA, on affiche tous ses comptes
                    if (creator.vaIds && creator.vaIds.length === 1) {
                        return true;
                    }
                    // Si la cratrice a plusieurs VAs, on n'affiche que les comptes
                    // explicitement assigns  CE VA
                    return account.assignedVaId === va.id;
                }) : [];

                // Filtrer les comptes Instagram pour ce VA
                const filteredInstagramAccounts = creator.instagramAccounts ? creator.instagramAccounts.filter(account => {
                    // Si la cratrice n'a qu'un seul VA, on affiche tous ses comptes
                    if (creator.vaIds && creator.vaIds.length === 1) {
                        return true;
                    }
                    // Si la cratrice a plusieurs VAs, on n'affiche que les comptes
                    // explicitement assigns  CE VA
                    return account.assignedVaId === va.id;
                }) : [];

                const accountsCount = filteredAccounts.length;
                const instagramCount = filteredInstagramAccounts.length;
                const totalCount = accountsCount + instagramCount;

                // Compter les comptes actifs vs bannis
                const activeAccounts = filteredInstagramAccounts.filter(acc => acc.status !== 'banned').length;
                const bannedAccounts = filteredInstagramAccounts.filter(acc => acc.status === 'banned').length;

                let badgeColor = '#22c55e'; // Vert par dfaut
                if (totalCount === 0) badgeColor = '#ef4444'; // Rouge si 0
                else if (totalCount >= 10) badgeColor = '#dc2626'; // Rouge fonc si 10+
                else if (totalCount >= 5) badgeColor = '#f59e0b'; // Orange si 5+
                
                const accountsHtml = filteredAccounts.length > 0 ? filteredAccounts.map((account, index) => {
                    // Trouver l'index rel dans la liste complte des comptes
                    const realIndex = creator.accounts.findIndex(acc => acc.id === account.id);
                    
                    // Chercher le Gmail associ
                    let gmail = null;
                    if (account.gmailId) {
                        gmail = data.gmailAccounts?.find(g => g.id === account.gmailId);
                    }
                    if (!gmail) {
                        // Chercher par assignedTwitterUsername
                        gmail = data.gmailAccounts?.find(g => 
                            g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                        );
                    }
                    
                    const hasGmail = gmail !== null && gmail !== undefined;
                    
                    // Obtenir les dernires stats de followers
                    const latestStats = getLatestTwitterStats(account.username);
                    const followersDisplay = latestStats ? 
                        `<span style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6; padding: 0.125rem 0.375rem; 
                                     border-radius: 0.75rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.25rem;
                                     border: 1px solid rgba(139, 92, 246, 0.2);">
                            <i class="fas fa-users" style="font-size: 0.625rem;"></i> ${formatNumber(latestStats.followers)}
                        </span>` : '';
                    
                    const paddingRight = hasGmail ? '7.5rem' : '10rem';

                    // Crer l'URL Twitter - enlever le @ du username
                    const twitterUrl = `https://twitter.com/${account.username.replace('@', '')}`;

                    // Gnrer le badge de statut
                    console.log('Twitter account for badge:', account.id, account.username, account.status);
                    const statusBadgeHTML = typeof generateStatusBadgeHTML !== 'undefined'
                        ? generateStatusBadgeHTML(account.id, 'twitter', account.username, account.status, account.notes)
                        : '';

                    return `<a href="${twitterUrl}" target="_blank" class="twitter-badge" style="position: relative; text-decoration: none; display: inline-flex; align-items: center; padding: 0.5rem 1rem; padding-right: 3.5rem;">
                        <i class="fab fa-twitter"></i>
                        <span style="margin-left: 0.25rem;">${account.username}${followersDisplay}</span>
                        ${statusBadgeHTML}
                        ${!hasGmail ? `
                            <i class="fas fa-exclamation-triangle"
                               style="color: #f59e0b; margin-left: 0.5rem; font-size: 0.75rem;"
                               title="Pas de Gmail associ"></i>
                        ` : ''}
                        <button onclick="event.preventDefault(); event.stopPropagation(); unassignTwitterAccount('${creator.id}', ${realIndex})"
                                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
                                       background: rgba(239, 68, 68, 0.2); border: none; border-radius: 8px;
                                       width: 32px; height: 32px; display: inline-flex; align-items: center;
                                       justify-content: center; cursor: pointer; font-size: 0.75rem;
                                       transition: all 0.2s ease;"
                                onmouseover="this.style.background='rgba(239, 68, 68, 0.4)'"
                                onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                                title="Retirer ce compte">
                            <i class="fas fa-times"></i>
                        </button>
                    </a>`;
                }).join('') : '';

                // Gnrer le HTML pour les comptes Instagram
                const instagramHtml = filteredInstagramAccounts.length > 0 ? filteredInstagramAccounts.map((account, index) => {
                    // Crer l'URL Instagram - enlever le @ du username
                    const instagramUrl = `https://instagram.com/${account.username.replace('@', '')}`;

                    // Gnrer le badge de statut
                    console.log('Instagram account for badge:', account.id, account.username, account.status);
                    const statusBadgeHTML = typeof generateStatusBadgeHTML !== 'undefined'
                        ? generateStatusBadgeHTML(account.id, 'instagram', account.username, account.status, account.notes)
                        : '';

                    return `<a href="${instagramUrl}" target="_blank" class="instagram-badge" style="position: relative; text-decoration: none; display: inline-flex; align-items: center; padding: 0.5rem 1rem; padding-right: 3.5rem;">
                        <i class="fab fa-instagram"></i>
                        <span style="margin-left: 0.25rem;">${account.username}</span>
                        ${statusBadgeHTML}
                        <button onclick="event.preventDefault(); event.stopPropagation(); deleteInstagramFromCreator('${creator.id}', '${account.username}')"
                                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
                                       background: rgba(239, 68, 68, 0.2); border: none; border-radius: 8px;
                                       width: 32px; height: 32px; display: inline-flex; align-items: center;
                                       justify-content: center; cursor: pointer; font-size: 0.75rem;
                                       transition: all 0.2s ease;"
                                onmouseover="this.style.background='rgba(239, 68, 68, 0.4)'"
                                onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                                title="Retirer ce compte">
                            <i class="fas fa-times"></i>
                        </button>
                    </a>`;
                }).join('') : '';

                creatorsHtml += `
                    <div class="creatrice-item">
                        <div class="creatrice-header">
                            <span class="creatrice-name">
                                 ${creator.name} 
                                <span style="background: ${badgeColor};
                                            color: white;
                                            padding: 2px 8px;
                                            border-radius: 12px;
                                            font-size: 0.75rem;
                                            font-weight: 600;
                                            margin-left: 8px;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    ${totalCount} compte${totalCount > 1 ? 's' : ''}
                                    ${accountsCount > 0 ? `(${accountsCount} <i class="fab fa-twitter"></i>)` : ''}
                                    ${instagramCount > 0 ? `(${instagramCount} <i class="fab fa-instagram"></i>)` : ''}
                                </span>
                                ${instagramCount > 0 ? `
                                    <span style="background: #10b981;
                                                color: white;
                                                padding: 2px 8px;
                                                border-radius: 12px;
                                                font-size: 0.75rem;
                                                font-weight: 600;
                                                margin-left: 4px;
                                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <i class="fas fa-check-circle"></i> ${activeAccounts}
                                    </span>
                                    <span style="background: #ef4444;
                                                color: white;
                                                padding: 2px 8px;
                                                border-radius: 12px;
                                                font-size: 0.75rem;
                                                font-weight: 600;
                                                margin-left: 4px;
                                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <i class="fas fa-ban"></i> ${bannedAccounts}
                                    </span>
                                ` : ''}
                            </span>
                            <div class="actions">
                                <button class="action-btn view-btn" onclick="viewCreator('${va.id}', '${creator.id}')">
                                    <i class="fas fa-eye"></i> Voir
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteCreator('${va.id}', '${creator.id}')" title="Supprimer cette cratrice">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="twitter-accounts">
                            ${accountsHtml || ''}
                            ${instagramHtml || ''}
                            ${(!accountsHtml && !instagramHtml) ? '<span style="color: #94a3b8;">Aucun compte</span>' : ''}
                        </div>
                    </div>
                `;
            });

            const isDarkMode = document.body.classList.contains('dark-mode');

            card.innerHTML = `
                <div class="va-header" style="position: relative;">
                    <!-- Decorative background circle -->
                    <div style="
                        position: absolute;
                        top: -40px;
                        right: -40px;
                        width: 180px;
                        height: 180px;
                        background: rgba(255, 255, 255, 0.08);
                        border-radius: 50%;
                        pointer-events: none;
                    "></div>

                    <div style="display: flex; align-items: center; gap: 1rem; position: relative; z-index: 1;">
                        <!-- Avatar -->
                        <div style="
                            width: 72px;
                            height: 72px;
                            background: rgba(255, 255, 255, 0.15);
                            backdrop-filter: blur(10px);
                            border-radius: 1.25rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 2rem;
                            font-weight: 700;
                            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
                            letter-spacing: -0.02em;
                            border: 2px solid rgba(255, 255, 255, 0.2);
                        ">
                            ${va.name.charAt(0).toUpperCase()}
                        </div>

                        <div style="flex: 1;">
                            <h3 class="va-name" style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: white; letter-spacing: -0.01em;">
                                ${va.name}
                            </h3>
                            <div class="va-stats" style="display: flex; gap: 1.25rem; flex-wrap: wrap; align-items: center;">
                                <span style="display: inline-flex; align-items: center; gap: 0.375rem; font-size: 0.875rem; font-weight: 600; color: rgba(255, 255, 255, 0.9);">
                                    <i class="fas fa-user-friends"></i> ${vaCreators.length} cratrice${vaCreators.length > 1 ? 's' : ''}
                                </span>
                                <span style="display: inline-flex; align-items: center; gap: 0.375rem; font-size: 0.875rem; font-weight: 600; color: rgba(255, 255, 255, 0.9);">
                                    <i class="fas fa-hashtag"></i> ${totalAccounts + totalInstagramAccounts} compte${(totalAccounts + totalInstagramAccounts) > 1 ? 's' : ''}
                                </span>
                                ${totalAccounts > 0 ? `
                                    <span style="display: inline-flex; align-items: center; gap: 0.375rem; background: rgba(29, 161, 242, 0.2); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; color: #60a5fa; border: 1px solid rgba(29, 161, 242, 0.3);">
                                        <i class="fab fa-twitter"></i> ${totalAccounts}
                                    </span>
                                ` : ''}
                                ${totalInstagramAccounts > 0 ? `
                                    <span style="display: inline-flex; align-items: center; gap: 0.375rem; background: rgba(193, 53, 132, 0.2); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600; color: #f472b6; border: 1px solid rgba(193, 53, 132, 0.3);">
                                        <i class="fab fa-instagram"></i> ${totalInstagramAccounts}
                                    </span>
                                ` : ''}
                                ${(() => {
                                    const problematicCount = countProblematicAccounts(va.id);
                                    return problematicCount > 0 ? `
                                        <span style="display: inline-flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, #ff0844 0%, #f7022a 100%); padding: 0.375rem 0.875rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 700; color: white; border: 1.5px solid rgba(255, 255, 255, 0.3); box-shadow: 0 2px 8px rgba(255, 8, 68, 0.4); animation: pulse-warning 2s infinite;">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span>${problematicCount}  remplacer</span>
                                        </span>
                                    ` : '';
                                })()}
                            </div>
                        </div>
                    </div>

                    <div class="va-actions" style="position: absolute; top: 1.25rem; right: 1.5rem; z-index: 2;">
                        <button class="action-btn delete-btn" onclick="deleteVA('${va.id}')" title="Supprimer ce VA" style="
                            background: rgba(239, 68, 68, 0.2);
                            border: 1px solid rgba(239, 68, 68, 0.3);
                            color: #fecaca;
                            width: 44px;
                            height: 44px;
                            border-radius: 0.75rem;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            cursor: pointer;
                            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                        "
                        onmouseover="this.style.background='rgba(239, 68, 68, 0.35)'; this.style.transform='scale(1.05)'; this.style.color='white'"
                        onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'; this.style.transform='scale(1)'; this.style.color='#fecaca'">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="creatrice-section">
                    ${creatorsHtml || '<div class="no-creator">Aucune cratrice assigne</div>'}
                </div>
            `;

            return card;
        }

        // Update Gmail accounts list
        function updateGmailAccountsList() {
            const container = document.getElementById('gmail-accounts-list');
            const statsContainer = document.getElementById('gmail-stats');
            if (!container) return;
            
            if (!data.gmailAccounts) data.gmailAccounts = [];
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Afficher les statistiques avec statuts
            if (statsContainer && data.gmailAccounts) {
                const totalAccounts = data.gmailAccounts.length;
                const bannedAccounts = data.gmailAccounts.filter(g => g.status === 'banned').length;
                const activeAccounts = totalAccounts - bannedAccounts;

                statsContainer.innerHTML = `
                    <span style="padding: 0.25rem 0.75rem; background: #10b981; color: white; border-radius: 1rem; font-weight: 600;">
                        <i class="fas fa-check-circle"></i> ${activeAccounts} actifs
                    </span>
                    ${bannedAccounts > 0 ? `
                        <span style="padding: 0.25rem 0.75rem; background: #ef4444; color: white; border-radius: 1rem; font-weight: 600;">
                            <i class="fas fa-ban"></i> ${bannedAccounts} bannis
                        </span>
                    ` : ''}
                    <span style="padding: 0.25rem 0.75rem; background: #6b7280; color: white; border-radius: 1rem; font-weight: 600;">
                        <i class="fas fa-envelope"></i> ${totalAccounts} total
                    </span>
                `;
            }
            
            // Afficher les comptes Gmail simplement
            if (data.gmailAccounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                        <i class="fas fa-envelope" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Aucun compte Gmail ajout</p>
                    </div>
                `;
                return;
            }
            
            console.log(' Mise  jour de la liste des comptes Gmail...');

            // Filtrer les comptes selon le statut
            const showBanned = document.getElementById('show-banned-gmail')?.checked !== false;
            const filteredAccounts = data.gmailAccounts.filter(gmail => {
                if (!showBanned && gmail.status === 'banned') return false;
                return true;
            });

            // Afficher les comptes Gmail avec leurs associations
            container.innerHTML = filteredAccounts.map(gmail => {
                // Vrifier les assignations Twitter et Instagram sparment
                let twitterAssigned = null;
                let instagramAssigned = null;

                // 1. Vrifier les assignations directes
                if (gmail.assignedTwitterUsername) {
                    twitterAssigned = gmail.assignedTwitterUsername;
                }
                if (gmail.assignedInstagramUsername) {
                    instagramAssigned = gmail.assignedInstagramUsername;
                }

                // 2. Vrifier dans les comptes des cratrices pour Twitter
                if (!twitterAssigned && data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.accounts) {
                            creator.accounts.forEach(account => {
                                if (account.gmailId === gmail.id) {
                                    twitterAssigned = account.username;
                                }
                            });
                        }
                    });
                }

                // 3. Vrifier dans les comptes des cratrices pour Instagram
                if (!instagramAssigned && data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.instagramAccounts) {
                            creator.instagramAccounts.forEach(account => {
                                if (account.gmailId === gmail.id) {
                                    instagramAssigned = account.username;
                                }
                            });
                        }
                    });
                }

                // 4. Vrifier dans data.twitterAccounts
                if (!twitterAssigned && data.twitterAccounts) {
                    const twitterAccount = data.twitterAccounts.find(ta => ta.gmailId === gmail.id);
                    if (twitterAccount) {
                        twitterAssigned = twitterAccount.username;
                    }
                }

                // 5. Vrifier dans data.instagramAccounts
                if (!instagramAssigned && data.instagramAccounts) {
                    const instagramAccount = data.instagramAccounts.find(ia => ia.gmailId === gmail.id);
                    if (instagramAccount) {
                        instagramAssigned = instagramAccount.username;
                    }
                }

                // Dterminer le statut global
                const hasTwitter = twitterAssigned !== null;
                const hasInstagram = instagramAssigned !== null;
                const isFullyAssigned = hasTwitter && hasInstagram;
                const isPartiallyAssigned = hasTwitter || hasInstagram;
                const isCompletelyFree = !hasTwitter && !hasInstagram;
                const isBanned = gmail.status === 'banned';

                const va = gmail.vaId ? data.vas.find(v => v.id === gmail.vaId) : null;

                // Dterminer la couleur de bordure
                let borderColor = '#ef4444'; // Rouge par dfaut (compltement libre)
                if (isBanned) borderColor = '#dc2626'; // Rouge fonc si banni
                else if (isFullyAssigned) borderColor = '#10b981'; // Vert si tout est assign
                else if (isPartiallyAssigned) borderColor = '#f59e0b'; // Orange si partiellement assign

                return `
                <div style="
                    padding: 1rem;
                    background: ${isFullyAssigned ?
                        (isDarkMode ? 'rgba(16, 185, 129, 0.1)' : 'rgba(16, 185, 129, 0.05)') :
                        isPartiallyAssigned ?
                        (isDarkMode ? 'rgba(245, 158, 11, 0.1)' : 'rgba(245, 158, 11, 0.05)') :
                        (isDarkMode ? 'rgba(234, 67, 53, 0.1)' : 'rgba(234, 67, 53, 0.05)')};
                    border: 2px solid ${borderColor};
                    border-radius: 0.5rem;
                    margin-bottom: 0.75rem;
                    transition: all 0.2s ease;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <i class="fas fa-envelope" style="color: ${borderColor};"></i>
                                <span style="${isBanned ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${gmail.email}</span>
                                ${isBanned ? `
                                    <span style="
                                        background: #dc2626;
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 0.75rem;
                                        font-weight: 600;
                                    ">
                                        <i class="fas fa-ban"></i> BANNI
                                    </span>
                                ` : isFullyAssigned ? `
                                    <span style="
                                        background: #10b981;
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 0.75rem;
                                        font-weight: 500;
                                    ">
                                        <i class="fas fa-check-circle"></i> Complet
                                    </span>
                                ` : isPartiallyAssigned ? `
                                    <span style="
                                        background: #f59e0b;
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 0.75rem;
                                        font-weight: 500;
                                    ">
                                        <i class="fas fa-exclamation-circle"></i> Partiel
                                    </span>
                                ` : `
                                    <span style="
                                        background: #ef4444;
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 0.75rem;
                                        font-weight: 500;
                                    ">
                                        <i class="fas fa-times-circle"></i> Disponible
                                    </span>
                                `}
                            </div>

                            <div style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'}; margin-top: 0.75rem; display: grid; gap: 0.5rem;">
                                <!-- Twitter Assignment -->
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${hasTwitter ? 'rgba(29, 161, 242, 0.1)' : 'rgba(148, 163, 184, 0.1)'}; border-radius: 0.375rem; border: 1px solid ${hasTwitter ? 'rgba(29, 161, 242, 0.2)' : 'rgba(148, 163, 184, 0.2)'};">
                                    <i class="fab fa-twitter" style="width: 20px; color: ${hasTwitter ? '#1da1f2' : '#94a3b8'};"></i>
                                    ${hasTwitter ? `
                                        <span><strong>Twitter:</strong> ${twitterAssigned}</span>
                                        <span style="margin-left: auto; background: #1da1f2; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem;">Assign</span>
                                    ` : `
                                        <span style="color: #94a3b8;">Twitter: Non assign</span>
                                        <span style="margin-left: auto; background: #10b981; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem;">Disponible</span>
                                    `}
                                </div>

                                <!-- Instagram Assignment -->
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${hasInstagram ? 'rgba(193, 53, 132, 0.1)' : 'rgba(148, 163, 184, 0.1)'}; border-radius: 0.375rem; border: 1px solid ${hasInstagram ? 'rgba(193, 53, 132, 0.2)' : 'rgba(148, 163, 184, 0.2)'};">
                                    <i class="fab fa-instagram" style="width: 20px; background: ${hasInstagram ? 'linear-gradient(45deg, #833AB4, #FD1D1D, #FCB045)' : '#94a3b8'}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                                    ${hasInstagram ? `
                                        <span><strong>Instagram:</strong> ${instagramAssigned}</span>
                                        <span style="margin-left: auto; background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem;">Assign</span>
                                    ` : `
                                        <span style="color: #94a3b8;">Instagram: Non assign</span>
                                        <span style="margin-left: auto; background: #10b981; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem;">Disponible</span>
                                    `}
                                </div>

                                ${va ? `
                                    <div style="margin-top: 0.25rem;">
                                        <i class="fas fa-user-tie" style="width: 20px; color: #667eea;"></i>
                                        VA: <strong>${va.name}</strong>
                                    </div>
                                ` : ''}

                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                                    Ajout le ${new Date(gmail.created).toLocaleDateString('fr-FR')}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-direction: column;">
                            <button class="action-btn" onclick="showGmailPassword('${gmail.id}')"
                                    style="background: #ea4335;" title="Voir le mot de passe">
                                <i class="fas fa-key"></i>
                            </button>
                            ${hasTwitter ? `
                                <button class="action-btn" onclick="unassignGmail('${gmail.id}', 'twitter')"
                                        style="background: #1da1f2;" title="Dsassigner Twitter">
                                    <i class="fab fa-twitter"></i> <i class="fas fa-unlink" style="font-size: 0.7rem;"></i>
                                </button>
                            ` : ''}
                            ${hasInstagram ? `
                                <button class="action-btn" onclick="unassignGmail('${gmail.id}', 'instagram')"
                                        style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045);" title="Dsassigner Instagram">
                                    <i class="fab fa-instagram"></i> <i class="fas fa-unlink" style="font-size: 0.7rem;"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn" onclick="toggleGmailBanStatus('${gmail.id}', '${gmail.status || 'active'}')"
                                    style="background: ${isBanned ? '#10b981' : '#ef4444'};"
                                    title="${isBanned ? 'Dbannir' : 'Bannir'}">
                                <i class="fas fa-${isBanned ? 'check-circle' : 'ban'}"></i>
                            </button>
                            <button class="action-btn" onclick="editGmailAccount('${gmail.id}')"
                                    style="background: #3b82f6;" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="handleDeleteGmailAccount('${gmail.id}')"
                                    style="background: #ef4444;" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Update Twitter form selects
        function updateTwitterFormSelects() {
            const creatorSelect = document.getElementById('account-creator');
            const gmailSelect = document.getElementById('account-gmail');
            const vaSelect = document.getElementById('account-va');
            
            if (creatorSelect) {
                const currentValue = creatorSelect.value;
                creatorSelect.innerHTML = '<option value="">Slectionner une cratrice</option>';
                data.creators.forEach(creator => {
                    const option = document.createElement('option');
                    option.value = creator.id;
                    option.textContent = creator.name;
                    creatorSelect.appendChild(option);
                });
                creatorSelect.value = currentValue;
            }
            
            if (gmailSelect) {
                const currentValue = gmailSelect.value;
                gmailSelect.innerHTML = '<option value="">Slectionner un compte Gmail</option>';

                // Dterminer la plateforme actuelle
                const platform = window.currentPlatform || 'twitter';

                // Afficher TOUS les comptes Gmail avec leurs statuts
                data.gmailAccounts.forEach(gmail => {
                    const option = document.createElement('option');
                    option.value = gmail.id;

                    let statusText = '';
                    const hasTwitter = gmail.assignedTwitterUsername ? true : false;
                    const hasInstagram = gmail.assignedInstagramUsername ? true : false;

                    if (hasTwitter && hasInstagram) {
                        // Gmail complet - ne peut plus tre utilis
                        statusText = '  COMPLET (Twitter + Instagram)';
                        if (platform === 'twitter') {
                            option.disabled = gmail.assignedTwitterUsername !== null;
                        } else {
                            option.disabled = gmail.assignedInstagramUsername !== null;
                        }
                    } else if (hasTwitter && !hasInstagram) {
                        // Gmail a Twitter mais Instagram disponible
                        if (platform === 'twitter') {
                            statusText = `  (Dj Twitter: ${gmail.assignedTwitterUsername})`;
                            option.disabled = true;
                        } else {
                            statusText = '  Instagram disponible';
                        }
                    } else if (!hasTwitter && hasInstagram) {
                        // Gmail a Instagram mais Twitter disponible
                        if (platform === 'instagram') {
                            statusText = `  (Dj Instagram: ${gmail.assignedInstagramUsername})`;
                            option.disabled = true;
                        } else {
                            statusText = '  Twitter disponible';
                        }
                    } else {
                        // Gmail compltement libre
                        statusText = '  Disponible';
                    }

                    option.textContent = gmail.email + statusText;
                    gmailSelect.appendChild(option);
                });
                gmailSelect.value = currentValue;
            }
            
            if (vaSelect) {
                const currentValue = vaSelect.value;
                vaSelect.innerHTML = '<option value="">Slectionner un VA</option>';
                data.vas.forEach(va => {
                    const option = document.createElement('option');
                    option.value = va.id;
                    option.textContent = va.name;
                    vaSelect.appendChild(option);
                });
                vaSelect.value = currentValue;
            }
        }

        // Copy text to clipboard with feedback
        function copyText(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess(`${label} copi !`);
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess(`${label} copi !`);
            });
        }

        // Objet pour stocker les instances de sparklines
        const twitterSparklines = {};
        const miniSparklines = {};

        // Crer un mini sparkline pour le tableau (version compacte)
        function createMiniSparkline(canvasId, stats, isDarkMode) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !stats || stats.length < 2) return null;

            // Dtruire l'ancien graphique si existant
            if (miniSparklines[canvasId]) {
                miniSparklines[canvasId].destroy();
            }

            const ctx = canvas.getContext('2d');

            // Prendre les 7 derniers jours et inverser
            const recentStats = stats.slice(0, 7).reverse();
            const dataPoints = recentStats.map(s => s.followers);

            // Calculer la tendance
            const firstValue = dataPoints[0] || 0;
            const lastValue = dataPoints[dataPoints.length - 1] || 0;
            const trend = lastValue - firstValue;

            const trendColor = trend >= 0 ? '#10b981' : '#ef4444';

            miniSparklines[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataPoints.map((_, i) => i),
                    datasets: [{
                        data: dataPoints,
                        borderColor: trendColor,
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: 2 },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        line: { borderCapStyle: 'round' }
                    }
                }
            });

            return miniSparklines[canvasId];
        }

        // Crer un sparkline pour un compte Twitter - Courbe visible
        function createTwitterSparkline(canvasId, stats, isDarkMode) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !stats || stats.length === 0) return null;

            // Dtruire l'ancien graphique si existant
            if (twitterSparklines[canvasId]) {
                twitterSparklines[canvasId].destroy();
            }

            const ctx = canvas.getContext('2d');

            // Prendre les 7 derniers jours et inverser pour l'ordre chronologique
            const recentStats = stats.slice(0, 7).reverse();

            const labels = recentStats.map(s => {
                const date = new Date(s.date);
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
            });

            const dataPoints = recentStats.map(s => s.followers);

            // Calculer la couleur base sur la tendance
            const firstValue = dataPoints[0] || 0;
            const lastValue = dataPoints[dataPoints.length - 1] || 0;
            const trend = lastValue - firstValue;

            // Couleurs selon la tendance - Plus vives
            const trendColor = trend >= 0 ? '#10b981' : '#ef4444';
            const trendColorBright = trend >= 0 ? '#34d399' : '#f87171';

            // Crer un dgrad pour le fill - Plus visible
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            if (trend >= 0) {
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.6)');
                gradient.addColorStop(0.4, 'rgba(16, 185, 129, 0.3)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.05)');
            } else {
                gradient.addColorStop(0, 'rgba(239, 68, 68, 0.6)');
                gradient.addColorStop(0.4, 'rgba(239, 68, 68, 0.3)');
                gradient.addColorStop(1, 'rgba(239, 68, 68, 0.05)');
            }

            twitterSparklines[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataPoints,
                        borderColor: trendColor,
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: trendColorBright,
                        pointBorderColor: isDarkMode ? '#0f1115' : 'white',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: trendColorBright,
                        pointHoverBorderColor: 'white',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 8,
                            bottom: 8,
                            left: 4,
                            right: 4
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDarkMode ? '#1f2937' : 'white',
                            titleColor: isDarkMode ? '#e2e8f0' : '#1f2937',
                            bodyColor: trendColor,
                            borderColor: trendColor,
                            borderWidth: 2,
                            padding: 12,
                            cornerRadius: 10,
                            displayColors: false,
                            titleFont: { weight: 'bold', size: 12 },
                            bodyFont: { weight: 'bold', size: 14 },
                            callbacks: {
                                title: (context) => context[0].label,
                                label: (context) => `${context.raw.toLocaleString()} followers`
                            }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: {
                            display: false,
                            beginAtZero: false
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    }
                }
            });

            return twitterSparklines[canvasId];
        }

        // ==========================================
        // TWITTER ACCOUNT DETAIL PAGE
        // ==========================================
        let twitterDetailChart = null;
        let currentTwitterDetailAccount = null;
        let currentTwitterDetailStats = [];

        // Ouvrir la page dtaille d'un compte Twitter
        window.openTwitterAccountDetail = async function(username) {
            const cleanUsername = username.replace('@', '');
            console.log(' Opening Twitter account detail for:', cleanUsername);

            // Naviguer vers la page
            navigateToPage('twitter-account-detail');

            // Charger les donnes du compte
            await loadTwitterAccountDetail(cleanUsername);
        }

        // Charger les donnes dtailles
        async function loadTwitterAccountDetail(username) {
            const isDarkMode = document.body.classList.contains('dark-mode');

            try {
                // Trouver le compte
                const allTwitterAccounts = data.twitterAccounts || [];
                const account = allTwitterAccounts.find(a =>
                    a.username.replace('@', '').toLowerCase() === username.toLowerCase()
                );

                if (!account) {
                    showError('Compte Twitter non trouv');
                    return;
                }

                currentTwitterDetailAccount = account;

                // Charger les stats
                let stats = [];
                if (typeof getTwitterStatsByUsername === 'function') {
                    stats = await getTwitterStatsByUsername(username);
                }
                currentTwitterDetailStats = stats || [];

                // Mettre  jour le header
                document.getElementById('twitter-detail-username').textContent = '@' + username;
                document.getElementById('twitter-detail-link').href = 'https://x.com/' + username;

                // Trouver la cratrice
                const creator = data.creators?.find(c => c.id === account.creator_id);
                document.getElementById('twitter-detail-creator').textContent = creator ? creator.name : 'Non assign';

                // Mettre  jour les stats cards
                updateTwitterDetailStats(stats, isDarkMode);

                // Crer le graphique
                updateTwitterDetailChart(30);

                // Mettre  jour la croissance journalire
                updateTwitterDetailDailyGrowth(stats, isDarkMode);

                // Mettre  jour le rsum
                updateTwitterDetailSummary(stats, isDarkMode);

            } catch (error) {
                console.error('Error loading Twitter account detail:', error);
                showError('Erreur lors du chargement des donnes');
            }
        }

        // Mettre  jour les stats cards
        function updateTwitterDetailStats(stats, isDarkMode) {
            const container = document.getElementById('twitter-detail-stats');
            if (!container) return;

            const latestFollowers = stats.length > 0 ? stats[0].followers : 0;

            // Calcul croissance aujourd'hui
            let todayGrowth = 0;
            if (stats.length >= 2) {
                todayGrowth = stats[0].followers - stats[1].followers;
            }

            // Calcul croissance 7 jours
            let weekGrowth = 0;
            const weekStats = stats.slice(0, 7);
            if (weekStats.length >= 2) {
                weekGrowth = weekStats[0].followers - weekStats[weekStats.length - 1].followers;
            }

            // Calcul croissance 30 jours
            let monthGrowth = 0;
            const monthStats = stats.slice(0, 30);
            if (monthStats.length >= 2) {
                monthGrowth = monthStats[0].followers - monthStats[monthStats.length - 1].followers;
            }

            // Calcul moyenne journalire
            let avgDaily = 0;
            if (stats.length >= 2) {
                const totalDays = Math.min(30, stats.length - 1);
                avgDaily = totalDays > 0 ? Math.round((stats[0].followers - stats[Math.min(30, stats.length - 1)].followers) / totalDays) : 0;
            }

            container.innerHTML = `
                <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1a1d23 0%, #0f1115 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)'}; border-radius: 1rem; padding: 1.5rem; border: 1px solid ${isDarkMode ? 'rgba(29, 161, 242, 0.2)' : 'rgba(29, 161, 242, 0.1)'}; box-shadow: 0 4px 15px ${isDarkMode ? 'rgba(0,0,0,0.3)' : 'rgba(29, 161, 242, 0.08)'};">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #1da1f2, #0d8bd9); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-users" style="color: white; font-size: 1rem;"></i>
                        </div>
                        <span style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.5px;">Total Followers</span>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">${latestFollowers.toLocaleString()}</div>
                </div>

                <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1a1d23 0%, #0f1115 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)'}; border-radius: 1rem; padding: 1.5rem; border: 1px solid ${todayGrowth >= 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; box-shadow: 0 4px 15px ${isDarkMode ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.05)'};">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: ${todayGrowth >= 0 ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'}; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-${todayGrowth >= 0 ? 'arrow-up' : 'arrow-down'}" style="color: white; font-size: 1rem;"></i>
                        </div>
                        <span style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.5px;">Aujourd'hui</span>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${todayGrowth >= 0 ? '#10b981' : '#ef4444'};">${todayGrowth >= 0 ? '+' : ''}${todayGrowth.toLocaleString()}</div>
                </div>

                <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1a1d23 0%, #0f1115 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)'}; border-radius: 1rem; padding: 1.5rem; border: 1px solid ${weekGrowth >= 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; box-shadow: 0 4px 15px ${isDarkMode ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.05)'};">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: ${weekGrowth >= 0 ? 'linear-gradient(135deg, #8b5cf6, #7c3aed)' : 'linear-gradient(135deg, #ef4444, #dc2626)'}; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-calendar-week" style="color: white; font-size: 1rem;"></i>
                        </div>
                        <span style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.5px;">7 jours</span>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${weekGrowth >= 0 ? '#8b5cf6' : '#ef4444'};">${weekGrowth >= 0 ? '+' : ''}${weekGrowth.toLocaleString()}</div>
                </div>

                <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1a1d23 0%, #0f1115 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)'}; border-radius: 1rem; padding: 1.5rem; border: 1px solid ${monthGrowth >= 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; box-shadow: 0 4px 15px ${isDarkMode ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.05)'};">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: ${monthGrowth >= 0 ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 'linear-gradient(135deg, #ef4444, #dc2626)'}; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-calendar-alt" style="color: white; font-size: 1rem;"></i>
                        </div>
                        <span style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.5px;">30 jours</span>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${monthGrowth >= 0 ? '#f59e0b' : '#ef4444'};">${monthGrowth >= 0 ? '+' : ''}${monthGrowth.toLocaleString()}</div>
                </div>

                <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1a1d23 0%, #0f1115 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)'}; border-radius: 1rem; padding: 1.5rem; border: 1px solid ${isDarkMode ? 'rgba(99, 102, 241, 0.2)' : 'rgba(99, 102, 241, 0.1)'}; box-shadow: 0 4px 15px ${isDarkMode ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.05)'};">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-chart-line" style="color: white; font-size: 1rem;"></i>
                        </div>
                        <span style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.5px;">Moy/jour</span>
                    </div>
                    <div style="font-size: 2rem; font-weight: 800; color: ${isDarkMode ? '#a5b4fc' : '#6366f1'};">${avgDaily >= 0 ? '+' : ''}${avgDaily.toLocaleString()}</div>
                </div>
            `;
        }

        // Mettre  jour le graphique principal
        function updateTwitterDetailChart(days) {
            const canvas = document.getElementById('twitter-detail-chart');
            if (!canvas) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            // Update button states
            document.querySelectorAll('.twitter-detail-period-btn').forEach(btn => {
                const period = parseInt(btn.dataset.period);
                if (period === days) {
                    btn.style.background = '#1da1f2';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                    btn.classList.add('active');
                } else {
                    btn.style.background = isDarkMode ? '#1f2937' : 'white';
                    btn.style.color = isDarkMode ? '#e2e8f0' : '#64748b';
                    btn.style.border = '1px solid ' + (isDarkMode ? '#374151' : '#e5e7eb');
                    btn.classList.remove('active');
                }
            });

            // Filtrer les stats par priode
            let filteredStats = [...currentTwitterDetailStats];
            if (days > 0 && filteredStats.length > days) {
                filteredStats = filteredStats.slice(0, days);
            }

            // Inverser pour l'ordre chronologique
            filteredStats = filteredStats.reverse();

            if (filteredStats.length === 0) {
                if (twitterDetailChart) {
                    twitterDetailChart.destroy();
                    twitterDetailChart = null;
                }
                return;
            }

            const labels = filteredStats.map(s => {
                const date = new Date(s.date);
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
            });

            const dataPoints = filteredStats.map(s => s.followers);

            // Calcul tendance
            const firstValue = dataPoints[0] || 0;
            const lastValue = dataPoints[dataPoints.length - 1] || 0;
            const trend = lastValue - firstValue;
            const trendColor = trend >= 0 ? '#10b981' : '#ef4444';

            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            if (trend >= 0) {
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
                gradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.15)');
                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.02)');
            } else {
                gradient.addColorStop(0, 'rgba(239, 68, 68, 0.4)');
                gradient.addColorStop(0.5, 'rgba(239, 68, 68, 0.15)');
                gradient.addColorStop(1, 'rgba(239, 68, 68, 0.02)');
            }

            if (twitterDetailChart) {
                twitterDetailChart.destroy();
            }

            twitterDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Followers',
                        data: dataPoints,
                        borderColor: trendColor,
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: days <= 14 ? 5 : (days <= 30 ? 3 : 0),
                        pointBackgroundColor: trendColor,
                        pointBorderColor: isDarkMode ? '#1f2937' : 'white',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: trendColor,
                        pointHoverBorderColor: 'white',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false,
                            backgroundColor: isDarkMode ? '#1f2937' : 'white',
                            titleColor: isDarkMode ? '#e2e8f0' : '#1f2937',
                            bodyColor: trendColor,
                            borderColor: trendColor,
                            borderWidth: 2,
                            padding: 14,
                            cornerRadius: 12,
                            displayColors: false,
                            titleFont: { weight: 'bold', size: 13 },
                            bodyFont: { weight: 'bold', size: 16 },
                            callbacks: {
                                title: (context) => context[0].label,
                                label: (context) => `${context.raw.toLocaleString()} followers`
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: isDarkMode ? '#6b7280' : '#9ca3af',
                                maxRotation: 45,
                                font: { size: 11 }
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: isDarkMode ? 'rgba(107, 114, 128, 0.1)' : 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                color: isDarkMode ? '#6b7280' : '#9ca3af',
                                font: { size: 11 },
                                callback: value => value.toLocaleString()
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    animation: {
                        duration: 600,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // Mettre  jour la croissance journalire
        function updateTwitterDetailDailyGrowth(stats, isDarkMode) {
            const container = document.getElementById('twitter-detail-daily-growth');
            if (!container || stats.length < 2) {
                if (container) {
                    container.innerHTML = `<div style="text-align: center; padding: 2rem; color: ${isDarkMode ? '#6b7280' : '#9ca3af'};">Pas assez de donnes</div>`;
                }
                return;
            }

            let html = '';
            const recentStats = stats.slice(0, 14); // 14 derniers jours

            for (let i = 0; i < recentStats.length - 1; i++) {
                const current = recentStats[i];
                const previous = recentStats[i + 1];
                const growth = current.followers - previous.followers;
                const date = new Date(current.date);
                const dateStr = date.toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' });

                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: ${isDarkMode ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.02)'}; border-radius: 0.75rem; border-left: 3px solid ${growth >= 0 ? '#10b981' : '#ef4444'};">
                        <div>
                            <div style="font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; font-size: 0.875rem;">${dateStr}</div>
                            <div style="font-size: 0.75rem; color: ${isDarkMode ? '#6b7280' : '#9ca3af'};">${current.followers.toLocaleString()} followers</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: ${growth >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border-radius: 0.5rem;">
                            <i class="fas fa-${growth > 0 ? 'arrow-up' : growth < 0 ? 'arrow-down' : 'minus'}" style="color: ${growth >= 0 ? '#10b981' : '#ef4444'}; font-size: 0.75rem;"></i>
                            <span style="font-weight: 700; color: ${growth >= 0 ? '#10b981' : '#ef4444'}; font-size: 0.875rem;">${growth >= 0 ? '+' : ''}${growth.toLocaleString()}</span>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Mettre  jour le rsum
        function updateTwitterDetailSummary(stats, isDarkMode) {
            const container = document.getElementById('twitter-detail-summary');
            if (!container) return;

            const totalEntries = stats.length;
            const firstEntry = stats.length > 0 ? stats[stats.length - 1] : null;
            const lastEntry = stats.length > 0 ? stats[0] : null;

            const totalGrowth = firstEntry && lastEntry ? lastEntry.followers - firstEntry.followers : 0;

            // Calcul meilleur et pire jour
            let bestDay = { growth: -Infinity, date: null };
            let worstDay = { growth: Infinity, date: null };

            for (let i = 0; i < stats.length - 1; i++) {
                const growth = stats[i].followers - stats[i + 1].followers;
                if (growth > bestDay.growth) {
                    bestDay = { growth, date: stats[i].date };
                }
                if (growth < worstDay.growth) {
                    worstDay = { growth, date: stats[i].date };
                }
            }

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
            };

            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: ${isDarkMode ? 'rgba(99, 102, 241, 0.1)' : 'rgba(99, 102, 241, 0.05)'}; border-radius: 0.75rem;">
                    <span style="color: ${isDarkMode ? '#a5b4fc' : '#6366f1'}; font-weight: 500;">Jours de donnes</span>
                    <span style="font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">${totalEntries}</span>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: ${isDarkMode ? 'rgba(16, 185, 129, 0.1)' : 'rgba(16, 185, 129, 0.05)'}; border-radius: 0.75rem;">
                    <span style="color: ${isDarkMode ? '#6ee7b7' : '#10b981'}; font-weight: 500;">Croissance totale</span>
                    <span style="font-weight: 700; color: ${totalGrowth >= 0 ? '#10b981' : '#ef4444'};">${totalGrowth >= 0 ? '+' : ''}${totalGrowth.toLocaleString()}</span>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: ${isDarkMode ? 'rgba(16, 185, 129, 0.1)' : 'rgba(16, 185, 129, 0.05)'}; border-radius: 0.75rem;">
                    <div>
                        <div style="color: ${isDarkMode ? '#6ee7b7' : '#10b981'}; font-weight: 500;">Meilleur jour</div>
                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#6b7280' : '#9ca3af'};">${formatDate(bestDay.date)}</div>
                    </div>
                    <span style="font-weight: 700; color: #10b981; font-size: 1.125rem;">+${bestDay.growth !== -Infinity ? bestDay.growth.toLocaleString() : '0'}</span>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)'}; border-radius: 0.75rem;">
                    <div>
                        <div style="color: ${isDarkMode ? '#fca5a5' : '#ef4444'}; font-weight: 500;">Pire jour</div>
                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#6b7280' : '#9ca3af'};">${formatDate(worstDay.date)}</div>
                    </div>
                    <span style="font-weight: 700; color: #ef4444; font-size: 1.125rem;">${worstDay.growth !== Infinity ? worstDay.growth.toLocaleString() : '0'}</span>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: ${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'}; border-radius: 0.75rem;">
                    <div>
                        <div style="color: ${isDarkMode ? '#7dd3fc' : '#1da1f2'}; font-weight: 500;">Premier enregistrement</div>
                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#6b7280' : '#9ca3af'};">${formatDate(firstEntry?.date)}</div>
                    </div>
                    <span style="font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">${firstEntry ? firstEntry.followers.toLocaleString() : '0'}</span>
                </div>
            `;
        }

        // ==========================================
        // SECTION FOLLOWERS DASHBOARD - NOUVEAU
        // ==========================================
        let followersDashboardChart = null;
        let allFollowersData = [];

        async function updateFollowersDashboardSection() {
            const totalEl = document.getElementById('followers-total-value');
            const todayEl = document.getElementById('followers-today-value');
            const weekEl = document.getElementById('followers-week-value');
            const performersEl = document.getElementById('followers-top-performers');
            const isDarkMode = document.body.classList.contains('dark-mode');

            try {
                // Rcuprer tous les comptes Twitter
                const allTwitterAccounts = data.twitterAccounts || [];
                if (allTwitterAccounts.length === 0) {
                    if (performersEl) {
                        performersEl.innerHTML = `
                            <div style="text-align: center; padding: 1rem; color: var(--text-muted);">
                                Aucun compte Twitter configur
                            </div>
                        `;
                    }
                    return;
                }

                // Charger les stats pour tous les comptes
                allFollowersData = await Promise.all(allTwitterAccounts.map(async (account) => {
                    let stats = [];
                    try {
                        if (typeof getTwitterStatsByUsername === 'function') {
                            const cleanUsername = account.username.replace('@', '');
                            stats = await getTwitterStatsByUsername(cleanUsername);
                        }
                    } catch (e) {
                        console.log('Erreur chargement stats:', e);
                    }
                    return { ...account, stats };
                }));

                // Calculer les totaux
                let totalFollowers = 0;
                let todayGrowth = 0;
                let weekGrowth = 0;
                const performers = [];

                allFollowersData.forEach(account => {
                    if (account.stats && account.stats.length > 0) {
                        const latest = account.stats[0].followers || 0;
                        totalFollowers += latest;

                        // Croissance aujourd'hui (vs hier)
                        if (account.stats.length > 1) {
                            const yesterday = account.stats[1].followers || 0;
                            const growth = latest - yesterday;
                            todayGrowth += growth;
                            performers.push({
                                username: account.username,
                                growth: growth,
                                followers: latest
                            });
                        }

                        // Croissance semaine (vs il y a 7 jours)
                        if (account.stats.length >= 7) {
                            const weekAgo = account.stats[6].followers || account.stats[account.stats.length - 1].followers || 0;
                            weekGrowth += latest - weekAgo;
                        } else if (account.stats.length > 1) {
                            const oldest = account.stats[account.stats.length - 1].followers || 0;
                            weekGrowth += latest - oldest;
                        }
                    }
                });

                // Mettre  jour les cartes de stats
                if (totalEl) totalEl.textContent = totalFollowers.toLocaleString();
                if (todayEl) {
                    todayEl.textContent = (todayGrowth >= 0 ? '+' : '') + todayGrowth.toLocaleString();
                    const todayCard = document.getElementById('followers-today-card');
                    if (todayCard) {
                        todayCard.style.background = todayGrowth >= 0
                            ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)'
                            : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    }
                }
                if (weekEl) {
                    weekEl.textContent = (weekGrowth >= 0 ? '+' : '') + weekGrowth.toLocaleString();
                    const weekCard = document.getElementById('followers-week-card');
                    if (weekCard) {
                        weekCard.style.background = weekGrowth >= 0
                            ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)'
                            : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    }
                }

                // Trier et afficher les top performers
                performers.sort((a, b) => b.growth - a.growth);
                const top3 = performers.slice(0, 3);

                if (performersEl) {
                    if (top3.length === 0) {
                        performersEl.innerHTML = `
                            <div style="text-align: center; padding: 1rem; color: var(--text-muted);">
                                <i class="fas fa-info-circle"></i> Pas assez de donnes pour afficher les performers
                            </div>
                        `;
                    } else {
                        performersEl.innerHTML = top3.map((p, i) => {
                            const medals = ['', '', ''];
                            const bgColors = ['rgba(251, 191, 36, 0.1)', 'rgba(156, 163, 175, 0.1)', 'rgba(249, 115, 22, 0.1)'];
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; background: ${bgColors[i]}; border-radius: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.25rem;">${medals[i]}</span>
                                        <a href="https://x.com/${p.username.replace('@', '')}" target="_blank" style="color: #1da1f2; font-weight: 600; text-decoration: none;">
                                            @${p.username.replace('@', '')}
                                        </a>
                                    </div>
                                    <span style="font-weight: 700; color: ${p.growth >= 0 ? '#10b981' : '#ef4444'};">
                                        ${p.growth >= 0 ? '+' : ''}${p.growth}
                                    </span>
                                </div>
                            `;
                        }).join('');
                    }
                }

                // Mettre  jour le graphique
                updateFollowersDashboardChart(7);

            } catch (error) {
                console.error('Erreur updateFollowersDashboardSection:', error);
            }
        }

        function updateFollowersDashboardChart(days = 7) {
            const canvas = document.getElementById('followers-main-chart');
            const chartContainer = document.getElementById('followers-chart-container');
            const chartEmpty = document.getElementById('followers-chart-empty');
            const chartLabel = document.getElementById('followers-chart-label');
            if (!canvas) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            // Mettre  jour les boutons de priode
            document.querySelectorAll('.followers-period-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = 'var(--text-color)';
                btn.style.borderColor = 'var(--border-color)';
            });
            const activeBtn = document.getElementById(`chart-period-${days}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#1da1f2';
                activeBtn.style.color = 'white';
                activeBtn.style.borderColor = '#1da1f2';
            }

            // Mettre  jour le label
            if (chartLabel) {
                chartLabel.textContent = `volution sur ${days} jours`;
            }

            // Prparer les donnes par jour
            const dateMap = new Map();
            const today = new Date();

            // Initialiser les jours
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dateMap.set(dateStr, 0);
            }

            // Agrger les followers par jour
            allFollowersData.forEach(account => {
                if (account.stats && account.stats.length > 0) {
                    account.stats.forEach(stat => {
                        const dateStr = stat.date.split('T')[0];
                        if (dateMap.has(dateStr)) {
                            dateMap.set(dateStr, dateMap.get(dateStr) + (stat.followers || 0));
                        }
                    });
                }
            });

            // Convertir en arrays pour Chart.js
            const labels = [];
            const dataPoints = [];
            dateMap.forEach((value, key) => {
                const date = new Date(key);
                labels.push(date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }));
                dataPoints.push(value);
            });

            // Vrifier si on a des donnes
            const hasData = dataPoints.some(v => v > 0);

            if (chartContainer && chartEmpty) {
                if (hasData) {
                    chartContainer.style.display = 'block';
                    chartEmpty.style.display = 'none';
                } else {
                    chartContainer.style.display = 'none';
                    chartEmpty.style.display = 'flex';
                    return;
                }
            }

            // Dtruire l'ancien graphique si existe
            if (followersDashboardChart) {
                followersDashboardChart.destroy();
            }

            const ctx = canvas.getContext('2d');

            // Calculer la tendance
            const firstNonZero = dataPoints.find(v => v > 0) || 0;
            const lastValue = dataPoints[dataPoints.length - 1] || 0;
            const trend = lastValue - firstNonZero;
            const trendColor = trend >= 0 ? '#10b981' : '#ef4444';

            followersDashboardChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Followers',
                        data: dataPoints,
                        borderColor: '#1da1f2',
                        backgroundColor: 'rgba(29, 161, 242, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#1da1f2',
                        pointBorderColor: 'white',
                        pointBorderWidth: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: isDarkMode ? '#1f2937' : 'white',
                            titleColor: isDarkMode ? '#e2e8f0' : '#1f2937',
                            bodyColor: isDarkMode ? '#94a3b8' : '#64748b',
                            borderColor: isDarkMode ? '#374151' : '#e2e8f0',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: (ctx) => `${ctx.raw.toLocaleString()} followers`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: isDarkMode ? '#9ca3af' : '#6b7280',
                                font: { size: 10 }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                color: isDarkMode ? '#9ca3af' : '#6b7280',
                                font: { size: 10 },
                                callback: (value) => value.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        // Update Twitter accounts list - VERSION SIMPLE
        async function updateTwitterAccountsList() {
            const container = document.getElementById('twitter-accounts-list');
            if (!container) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            console.log(' updateTwitterAccountsList appel');

            // Collecter TOUS les comptes Twitter de toutes les sources
            const allTwitterAccounts = [];

            // 1. Comptes de data.twitterAccounts
            if (data.twitterAccounts) {
                data.twitterAccounts.forEach(account => {
                    allTwitterAccounts.push({
                        ...account,
                        source: 'simple'
                    });
                });
            }

            // 2. Comptes des cratrices
            if (data.creators) {
                console.log(' Parcours des cratrices pour les comptes Twitter:');
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        console.log(`  Cratrice ${creator.name}: ${creator.accounts.length} comptes`);
                        creator.accounts.forEach(account => {
                            console.log(`    - ${account.username} (gmailId: ${account.gmailId})`);
                            // Vrifier si ce compte n'est pas dj dans la liste
                            const exists = allTwitterAccounts.some(ta =>
                                ta.username.toLowerCase() === account.username.toLowerCase()
                            );
                            if (!exists) {
                                allTwitterAccounts.push({
                                    username: account.username,
                                    password: account.password,
                                    creatorId: creator.id,
                                    creatorName: creator.name,
                                    vaIds: creator.vaIds,
                                    gmailId: account.gmailId, // Ajouter le gmailId
                                    assignedVaId: account.assignedVaId, // Ajouter l'ID du VA assign
                                    source: 'creator',
                                    created: account.created || new Date().toISOString()
                                });
                            }
                        });
                    }
                });
            }
            
            console.log(` Total comptes Twitter trouvs: ${allTwitterAccounts.length}`);
            
            if (allTwitterAccounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                        <i class="fab fa-twitter" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Aucun compte Twitter ajout</p>
                    </div>
                `;
                return;
            }
            
            // Dchiffrer tous les mots de passe et charger les stats de followers
            const accountsWithPasswords = await Promise.all(allTwitterAccounts.map(async (account) => {
                let decryptedPassword = '';
                let followerStats = [];
                let latestFollowers = null;
                let todayGrowth = null;

                try {
                    if (account.password && typeof decryptPassword === 'function') {
                        decryptedPassword = await decryptPassword(account.password);
                    } else {
                        decryptedPassword = account.password || '';
                    }
                } catch (e) {
                    console.log('Erreur dchiffrement:', e);
                    decryptedPassword = account.password || '';
                }

                // Charger les stats de followers
                try {
                    if (typeof getTwitterStatsByUsername === 'function') {
                        const cleanUsername = account.username.replace('@', '');
                        followerStats = await getTwitterStatsByUsername(cleanUsername);

                        if (followerStats && followerStats.length > 0) {
                            latestFollowers = followerStats[0].followers;

                            // Calculer la croissance d'aujourd'hui
                            if (followerStats.length > 1) {
                                const today = new Date().toISOString().split('T')[0];
                                const todayStat = followerStats.find(s => s.date === today);
                                const yesterdayStat = followerStats.find(s => s.date !== today);

                                if (todayStat && yesterdayStat) {
                                    todayGrowth = todayStat.followers - yesterdayStat.followers;
                                } else if (followerStats.length >= 2) {
                                    todayGrowth = followerStats[0].followers - followerStats[1].followers;
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.log('Erreur chargement stats followers:', e);
                }

                return { ...account, decryptedPassword, followerStats, latestFollowers, todayGrowth };
            }));

            // Afficher TOUS les comptes Twitter avec leurs associations
            container.innerHTML = accountsWithPasswords.map(account => {
                // Pour les comptes venant des cratrices
                let creator = null;
                let gmail = null;
                let va = null;

                // Debug pour Laurabptss
                if (account.username.toLowerCase().includes('laurabptss')) {
                    console.log(' Debug Laurabptss dans updateTwitterAccountsList:');
                    console.log('Account:', account);
                    console.log('Source:', account.source);
                    console.log('GmailId dans account:', account.gmailId);
                }

                if (account.source === 'creator') {
                    creator = data.creators.find(c => c.id === account.creatorId);

                    // Pour rcuprer le compte rel depuis creator.accounts
                    let realAccount = null;
                    if (creator && creator.accounts) {
                        realAccount = creator.accounts.find(a =>
                            a.username.toLowerCase() === account.username.toLowerCase()
                        );

                        if (account.username.toLowerCase().includes('laurabptss') && realAccount) {
                            console.log('Real account trouv:', realAccount);
                            console.log('GmailId dans realAccount:', realAccount.gmailId);
                        }
                    }

                    // Trouver le Gmail associ via gmailId ou via assignedTwitterUsername
                    if (realAccount && realAccount.gmailId) {
                        gmail = data.gmailAccounts.find(g => g.id === realAccount.gmailId);
                    } else if (account.gmailId) {
                        gmail = data.gmailAccounts.find(g => g.id === account.gmailId);
                    } else {
                        gmail = data.gmailAccounts.find(g => 
                            g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                        );
                    }
                    
                    if (account.username.toLowerCase().includes('laurabptss')) {
                        console.log('Gmail trouv:', gmail);
                        console.log('Recherche du Gmail avec ID:', realAccount?.gmailId || account.gmailId);
                        console.log('Tous les gmailAccounts:', data.gmailAccounts);
                        if (data.gmailAccounts) {
                            const gmailById = data.gmailAccounts.find(g => g.id === (realAccount?.gmailId || account.gmailId));
                            console.log('Gmail trouv par ID direct:', gmailById);
                            const gmailByUsername = data.gmailAccounts.find(g => 
                                g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                            );
                            console.log('Gmail trouv par username:', gmailByUsername);
                        }
                    }
                    
                    // Trouver le VA via les vaIds de la cratrice ou assignedVaId
                    if (realAccount && realAccount.assignedVaId) {
                        va = data.vas.find(v => v.id === realAccount.assignedVaId);
                    } else if (account.assignedVaId) {
                        va = data.vas.find(v => v.id === account.assignedVaId);
                    } else if (account.vaIds && account.vaIds.length > 0) {
                        va = data.vas.find(v => account.vaIds.includes(v.id));
                    }
                } else {
                    // Pour les comptes simples
                    creator = account.creatorId ? data.creators.find(c => c.id === account.creatorId) : null;
                    
                    // Chercher le Gmail par gmailId ou assignedTwitterUsername
                    if (account.gmailId) {
                        gmail = data.gmailAccounts.find(g => g.id === account.gmailId);
                    }
                    if (!gmail) {
                        gmail = data.gmailAccounts.find(g => 
                            g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                        );
                    }
                    
                    va = account.vaId ? data.vas.find(v => v.id === account.vaId) : null;
                }
                
                // Debug final pour Laurabptss
                if (account.username.toLowerCase().includes('laurabptss')) {
                    console.log(' RENDU HTML pour Laurabptss:');
                    console.log('  - creator:', creator);
                    console.log('  - gmail:', gmail);
                    console.log('  - va:', va);
                    console.log('  - Condition !gmail:', !gmail);
                    console.log('  - Triangle sera affich:', !gmail);
                }
                
                return `
                <div style="
                    padding: 1rem;
                    background: ${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'};
                    border: 1px solid #1da1f2;
                    border-radius: 0.5rem;
                    transition: all 0.2s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <!-- Username avec bouton copier -->
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <i class="fab fa-twitter" style="color: #1da1f2; font-size: 1.25rem;"></i>
                                <strong style="font-size: 1.1rem; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">
                                    ${account.username}
                                </strong>
                                <button onclick="copyText('${account.username.replace('@', '')}', 'Username')"
                                        style="background: #1da1f2; border: none; border-radius: 0.375rem; cursor: pointer; color: white; padding: 0.375rem 0.75rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;"
                                        title="Copier le username">
                                    <i class="fas fa-copy"></i> Copier
                                </button>
                                ${!gmail ? `
                                    <i class="fas fa-exclamation-triangle"
                                       style="color: #fbbf24; font-size: 0.9rem;"
                                       title="Pas de Gmail associ"></i>
                                ` : ''}
                            </div>

                            <!-- Mot de passe avec bouton copier -->
                            <div style="background: ${isDarkMode ? 'rgba(29, 161, 242, 0.15)' : 'rgba(29, 161, 242, 0.08)'}; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-key" style="color: #1da1f2;"></i>
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Mot de passe:</span>
                                        <code style="font-family: 'Courier New', monospace; font-size: 0.9rem; background: ${isDarkMode ? 'rgba(0,0,0,0.3)' : 'white'}; padding: 0.25rem 0.5rem; border-radius: 0.25rem; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; border: 1px solid ${isDarkMode ? '#374151' : '#e2e8f0'};">
                                            ${account.decryptedPassword || '(non dfini)'}
                                        </code>
                                    </div>
                                    <button onclick="copyText('${(account.decryptedPassword || '').replace(/'/g, "\\'")}', 'Mot de passe')"
                                            style="background: #10b981; border: none; border-radius: 0.375rem; cursor: pointer; color: white; padding: 0.375rem 0.75rem; font-size: 0.75rem; display: flex; align-items: center; gap: 0.25rem;"
                                            title="Copier le mot de passe">
                                        <i class="fas fa-copy"></i> Copier MDP
                                    </button>
                                </div>
                            </div>

                            <!-- Infos associes -->
                            <div style="font-size: 0.8125rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                ${creator ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-user" style="width: 18px; color: #8b5cf6;"></i> Cratrice: <strong>${creator.name}</strong></div>` : ''}
                                ${gmail ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-envelope" style="width: 18px; color: #ea4335;"></i> Gmail: <strong>${gmail.email}</strong></div>` :
                                  creator ? `<div style="margin-bottom: 0.25rem; color: #ef4444;"><i class="fas fa-envelope" style="width: 18px; opacity: 0.5;"></i> <em>Aucun Gmail associ</em></div>` : ''}
                                ${va ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-user-tie" style="width: 18px; color: #667eea;"></i> VA: <strong>${va.name}</strong></div>` : ''}
                                ${!creator && !gmail && !va ? '<div style="color: #ef4444; font-style: italic;">Aucune association</div>' : ''}
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                                    ${account.source === 'creator' ? '<span style="color: #8b5cf6;">Depuis cratrice</span>  ' : ''}
                                    Ajout le ${new Date(account.created).toLocaleDateString('fr-FR')}
                                </div>
                            </div>

                            <!-- Sparkline Followers -->
                            ${account.followerStats && account.followerStats.length > 0 ? `
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: ${isDarkMode ? 'rgba(0,0,0,0.2)' : 'rgba(255,255,255,0.8)'}; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? '#374151' : '#e2e8f0'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-chart-line" style="color: #1da1f2;"></i>
                                        <span style="font-size: 0.8125rem; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">
                                            ${account.latestFollowers ? account.latestFollowers.toLocaleString() : '0'} followers
                                        </span>
                                    </div>
                                    ${account.todayGrowth !== null ? `
                                        <span style="font-size: 0.75rem; font-weight: 600; padding: 0.25rem 0.5rem; border-radius: 9999px; background: ${account.todayGrowth >= 0 ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; color: ${account.todayGrowth >= 0 ? '#10b981' : '#ef4444'};">
                                            ${account.todayGrowth >= 0 ? '+' : ''}${account.todayGrowth} aujourd'hui
                                        </span>
                                    ` : ''}
                                </div>
                                <div style="height: 40px; width: 100%;">
                                    <canvas id="sparkline-${account.username.replace('@', '').replace(/[^a-zA-Z0-9]/g, '_')}" style="width: 100%; height: 100%;"></canvas>
                                </div>
                            </div>
                            ` : `
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: ${isDarkMode ? 'rgba(0,0,0,0.2)' : 'rgba(255,255,255,0.5)'}; border-radius: 0.5rem; border: 1px dashed ${isDarkMode ? '#374151' : '#e2e8f0'}; text-align: center;">
                                <span style="font-size: 0.75rem; color: ${isDarkMode ? '#6b7280' : '#9ca3af'};">
                                    <i class="fas fa-chart-line" style="opacity: 0.5;"></i> Pas de donnes followers
                                </span>
                            </div>
                            `}
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${!gmail && creator ? `
                                <button class="action-btn" onclick="showAssignGmailModal('${account.creatorId}', '${account.username}')"
                                        style="background: #ea4335;" title="Assigner un Gmail">
                                    <i class="fas fa-envelope"></i> Gmail
                                </button>
                            ` : ''}
                            ${!creator && !gmail && !va && account.id ? `
                                <button class="action-btn" onclick="showReassignModal('${account.id}')"
                                        style="background: #10b981;" title="Rassigner ce compte">
                                    <i class="fas fa-user-plus"></i> Assigner
                                </button>
                            ` : ''}
                            <button class="action-btn" onclick="showEditTwitterAccountModal('${account.id || ''}', '${account.username}', '${(account.decryptedPassword || '').replace(/'/g, "\\'")}', '${account.creatorId || ''}')"
                                    style="background: #667eea;" title="Modifier ce compte">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="handleDeleteTwitterAccount('${account.id || account.username}')"
                                    style="background: #ef4444;" title="Supprimer dfinitivement">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');

            // Initialiser les sparklines aprs le rendu
            setTimeout(() => {
                accountsWithPasswords.forEach(account => {
                    if (account.followerStats && account.followerStats.length > 0) {
                        const canvasId = `sparkline-${account.username.replace('@', '').replace(/[^a-zA-Z0-9]/g, '_')}`;
                        createTwitterSparkline(canvasId, account.followerStats, isDarkMode);
                    }
                });
            }, 100);
        }

        // Show edit Twitter account modal
        function showEditTwitterAccountModal(accountId, username, password, creatorId) {
            document.getElementById('edit-twitter-account-id').value = accountId || '';
            document.getElementById('edit-twitter-creator-id').value = creatorId || '';
            document.getElementById('edit-twitter-old-username').value = username;
            document.getElementById('edit-twitter-username').value = username.replace('@', '');
            document.getElementById('edit-twitter-password').value = '';
            document.getElementById('edit-twitter-password').placeholder = password ? 'Laisser vide pour garder l\'ancien' : 'Entrer un mot de passe';
            document.getElementById('edit-twitter-account-modal').classList.add('show');
        }

        // Close edit Twitter account modal
        function closeEditTwitterAccountModal() {
            document.getElementById('edit-twitter-account-modal').classList.remove('show');
            document.getElementById('edit-twitter-account-form').reset();
        }

        // Toggle password visibility in edit modal
        function toggleEditTwitterPassword() {
            const input = document.getElementById('edit-twitter-password');
            const icon = document.getElementById('edit-twitter-password-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Handle edit Twitter account form submission
        async function handleEditTwitterAccount(event) {
            event.preventDefault();

            const accountId = document.getElementById('edit-twitter-account-id').value;
            const creatorId = document.getElementById('edit-twitter-creator-id').value;
            const oldUsername = document.getElementById('edit-twitter-old-username').value;
            const newUsername = document.getElementById('edit-twitter-username').value.trim().replace('@', '');
            const newPassword = document.getElementById('edit-twitter-password').value;

            if (!newUsername) {
                showError('Le nom d\'utilisateur est requis');
                return;
            }

            try {
                // Si on a un accountId, mettre  jour dans twitter_accounts
                if (accountId) {
                    const updateData = { username: newUsername };
                    if (newPassword) updateData.password = newPassword;

                    const { error } = await supabase
                        .from('twitter_accounts')
                        .update(updateData)
                        .eq('id', accountId);

                    if (error) throw error;

                    // Mettre  jour les donnes locales
                    const localAccount = data.twitterAccounts.find(a => a.id === accountId);
                    if (localAccount) {
                        localAccount.username = newUsername;
                        if (newPassword) localAccount.password = newPassword;
                    }
                }

                // Si on a un creatorId, mettre  jour aussi dans creator.accounts
                if (creatorId) {
                    const creator = data.creators.find(c => c.id === creatorId);
                    if (creator && creator.accounts) {
                        const creatorAccount = creator.accounts.find(a =>
                            a.username.toLowerCase() === oldUsername.toLowerCase()
                        );
                        if (creatorAccount) {
                            creatorAccount.username = newUsername;
                            if (newPassword) creatorAccount.password = newPassword;
                        }
                    }

                    // Aussi mettre  jour dans twitter_accounts par creatorId et oldUsername
                    const { error: updateError } = await supabase
                        .from('twitter_accounts')
                        .update({
                            username: newUsername,
                            ...(newPassword ? { password: newPassword } : {})
                        })
                        .eq('creator_id', creatorId)
                        .ilike('username', oldUsername);

                    if (updateError) {
                        console.warn('Update via creator_id failed:', updateError);
                    }
                }

                // Fermer la modale
                closeEditTwitterAccountModal();

                // Actualiser tous les affichages
                updateTwitterAccountsList();
                updateDisplay(); // Actualise le dashboard et toutes les vues

                showSuccess(`Compte @${newUsername} modifi avec succs`);

            } catch (error) {
                console.error('Error updating Twitter account:', error);
                showError('Erreur lors de la modification du compte');
            }
        }

        // Update all creators table
        function updateAllCreatorsTable() {
            const container = document.getElementById('all-creators-table');
            const countContainer = document.getElementById('total-creators-count');
            if (!container) return;

            // Utiliser la nouvelle structure creators
            const allCreators = data.creators || [];

            // Afficher le total
            if (countContainer) {
                countContainer.innerHTML = `<i class="fas fa-users"></i> ${allCreators.length} cratrice${allCreators.length > 1 ? 's' : ''}`;
            }

            if (allCreators.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #94a3b8;">
                        <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 1.25rem; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user-friends" style="font-size: 2.5rem; opacity: 0.3; color: #667eea;"></i>
                        </div>
                        <p style="margin-top: 1rem; font-weight: 500;">Aucune cratrice ajoute</p>
                        <p style="font-size: 0.875rem; color: #cbd5e1; margin-top: 0.5rem;">Utilisez le formulaire pour ajouter votre premire cratrice</p>
                    </div>
                `;
                return;
            }

            const isDarkMode = document.body.classList.contains('dark-mode');

            // Crer des cartes modernes avec glassmorphism
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1rem;">
                    ${allCreators.map(creator => {
                        const creatorData = data.creators.find(c => c.name === creator.name);
                        const hasVA = creatorData && creatorData.vaIds && creatorData.vaIds.length > 0;
                        const vaNames = [];
                        if (hasVA && creatorData.vaIds) {
                            creatorData.vaIds.forEach(vaId => {
                                const va = data.vas.find(v => v.id === vaId);
                                if (va) vaNames.push(va.name);
                            });
                        }

                        // Compter les comptes Twitter et Instagram
                        const twitterAccounts = data.twitterAccounts ? data.twitterAccounts.filter(acc => acc.creatorId === creatorData?.id).length : 0;
                        const instagramAccounts = data.instagramAccounts ? data.instagramAccounts.filter(acc => acc.creatorId === creatorData?.id).length : 0;

                        return `
                            <div style="
                                background: ${isDarkMode ? 'rgba(30, 41, 59, 0.6)' : 'rgba(255, 255, 255, 0.9)'};
                                backdrop-filter: blur(10px);
                                border: 1px solid ${isDarkMode ? 'rgba(148, 163, 184, 0.2)' : 'rgba(226, 232, 240, 0.8)'};
                                border-radius: 1rem;
                                padding: 1.5rem;
                                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                cursor: pointer;
                                position: relative;
                                overflow: hidden;
                            "
                            onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(102, 126, 234, 0.15)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">

                                <!-- Gradient accent top -->
                                <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>

                                <!-- Header with avatar and name -->
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="
                                        width: 56px;
                                        height: 56px;
                                        background: ${creator.photo_url ? 'transparent' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
                                        border-radius: 1rem;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                                        flex-shrink: 0;
                                        overflow: hidden;
                                    ">
                                        ${creator.photo_url
                                            ? `<img src="${creator.photo_url}" style="width: 100%; height: 100%; object-fit: cover;">`
                                            : `<i class="fas fa-star" style="font-size: 1.5rem; color: white;"></i>`
                                        }
                                    </div>
                                    <div style="flex: 1; min-width: 0;">
                                        <h4 style="margin: 0; font-size: 1.125rem; font-weight: 700; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${creator.name}
                                        </h4>
                                        ${vaNames.length > 0 ? `
                                            <div style="margin-top: 0.25rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                                ${vaNames.map(vaName => `
                                                    <span style="
                                                        font-size: 0.75rem;
                                                        padding: 0.25rem 0.625rem;
                                                        background: ${isDarkMode ? 'rgba(102, 126, 234, 0.2)' : 'rgba(102, 126, 234, 0.1)'};
                                                        color: #667eea;
                                                        border-radius: 0.5rem;
                                                        font-weight: 600;
                                                        border: 1px solid rgba(102, 126, 234, 0.3);
                                                    ">
                                                        <i class="fas fa-user-tie" style="font-size: 0.625rem;"></i> ${vaName}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <span style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-style: italic;">
                                                Aucun VA assign
                                            </span>
                                        `}
                                    </div>
                                </div>

                                <!-- Stats -->
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem; padding: 0.75rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.03)'}; border-radius: 0.75rem;">
                                    <div style="flex: 1; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #1da1f2;">
                                            ${twitterAccounts}
                                        </div>
                                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; margin-top: 0.25rem;">
                                            <i class="fab fa-twitter"></i> Twitter
                                        </div>
                                    </div>
                                    <div style="width: 1px; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'}; margin: 0.5rem 0;"></div>
                                    <div style="flex: 1; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #c13584;">
                                            ${instagramAccounts}
                                        </div>
                                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; margin-top: 0.25rem;">
                                            <i class="fab fa-instagram"></i> Instagram
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div style="display: flex; gap: 0.5rem;">
                                    ${creatorData ? `
                                        <button onclick="event.stopPropagation(); assignVAToCreator('${creatorData.id}')"
                                                style="
                                                    flex: 1;
                                                    padding: 0.625rem;
                                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                    color: white;
                                                    border: none;
                                                    border-radius: 0.5rem;
                                                    font-size: 0.875rem;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.2s;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                    gap: 0.375rem;
                                                "
                                                onmouseover="this.style.opacity='0.9'"
                                                onmouseout="this.style.opacity='1'"
                                                title="${hasVA ? 'Modifier les VA assigns' : 'Assigner  un VA'}">
                                            <i class="fas fa-link"></i>
                                            ${hasVA ? 'Modifier VA' : 'Assigner VA'}
                                        </button>
                                    ` : ''}
                                    ${creatorData && vaNames.length > 1 ? `
                                        <button onclick="event.stopPropagation(); showSplitCreatorModal('${creatorData.id}')"
                                                style="
                                                    padding: 0.625rem 1rem;
                                                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                                                    color: white;
                                                    border: none;
                                                    border-radius: 0.5rem;
                                                    font-size: 0.875rem;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.2s;
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 0.375rem;
                                                "
                                                onmouseover="this.style.opacity='0.9'"
                                                onmouseout="this.style.opacity='1'"
                                                title="Sparer en cratrices distinctes par VA">
                                            <i class="fas fa-cut"></i>
                                        </button>
                                    ` : ''}
                                    ${creatorData ? `
                                        <button onclick="event.stopPropagation(); openCreatorPhotoModal('${creatorData.id}')"
                                                style="
                                                    padding: 0.625rem 1rem;
                                                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                                    color: white;
                                                    border: none;
                                                    border-radius: 0.5rem;
                                                    font-size: 0.875rem;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.2s;
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 0.375rem;
                                                "
                                                onmouseover="this.style.opacity='0.9'"
                                                onmouseout="this.style.opacity='1'"
                                                title="Modifier la photo">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                    ` : ''}
                                    ${creatorData ? `
                                        <button onclick="event.stopPropagation(); handleDeleteCreator('${creatorData.id}')"
                                                style="
                                                    padding: 0.625rem 1rem;
                                                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                                                    color: white;
                                                    border: none;
                                                    border-radius: 0.5rem;
                                                    font-size: 0.875rem;
                                                    font-weight: 600;
                                                    cursor: pointer;
                                                    transition: all 0.2s;
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 0.375rem;
                                                "
                                                onmouseover="this.style.opacity='0.9'"
                                                onmouseout="this.style.opacity='1'"
                                                title="Supprimer cette cratrice">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Update VA selects
        function updateVASelects() {
            const vaOptions = data.vas.map(va => 
                `<option value="${va.id}">${va.name}</option>`
            ).join('');

            const selectVaAccount = document.getElementById('select-va-account');
            if (selectVaAccount) {
                selectVaAccount.innerHTML = '<option value="">-- Sans VA pour le moment --</option>' + vaOptions;
            }
            
            // Mettre  jour aussi les selects de cratrices et Gmail
            updateCreatorSelect();
            updateGmailSelectForTwitter();
        }
        
        // Update creator select
        function updateCreatorSelect() {
            const creatorOptions = data.creators
                .filter(c => c.name !== 'Compte Orphelin') // Ne pas montrer les comptes orphelins
                .map(c => `<option value="${c.id}">${c.name}</option>`)
                .join('');
            
            const selectCreator = document.getElementById('select-creator-account');
            if (selectCreator) {
                selectCreator.innerHTML = '<option value="">-- Sans cratrice pour le moment --</option>' + creatorOptions;
            }
        }
        
        // Update Gmail select for Twitter account
        function updateGmailSelectForTwitter() {
            const gmailSelect = document.getElementById('select-gmail-account');
            if (!gmailSelect) return;
            
            // Obtenir tous les comptes Gmail non utiliss
            const gmailAccounts = data.gmailAccounts || [];
            
            // Trouver les Gmail dj utiliss
            const usedGmailIds = new Set();
            data.creators.forEach(creator => {
                (creator.accounts || []).forEach(account => {
                    if (account.gmailId) {
                        usedGmailIds.add(account.gmailId);
                    }
                });
            });
            
            // Filtrer pour n'afficher que les Gmail disponibles
            const availableGmails = gmailAccounts.filter(gmail => !usedGmailIds.has(gmail.id));
            
            const options = availableGmails.map(gmail => 
                `<option value="${gmail.id}">${gmail.email}</option>`
            ).join('');
            
            gmailSelect.innerHTML = '<option value="">-- Sans Gmail pour le moment --</option>' + options;
        }

        // Update creator select based on VA
        
        // Update Gmail select based on VA selection
        function updateGmailSelect() {
            const vaId = document.getElementById('select-va-account').value;
            const gmailSelect = document.getElementById('select-gmail-account');
            
            if (!vaId) {
                gmailSelect.innerHTML = '<option value="">-- D\'abord choisir un VA --</option>';
                gmailSelect.disabled = true;
                return;
            }
            
            // Get ALL Gmail accounts (assigned to this VA OR unassigned)
            const allGmailAccounts = data.gmailAccounts?.filter(acc => 
                acc.vaId === vaId || acc.vaId === null || acc.vaId === ''
            ) || [];
            
            // Get already used Gmail accounts (linked to Twitter accounts)
            const usedGmailIds = [];
            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        if (account.gmailId) {
                            usedGmailIds.push(account.gmailId);
                        }
                    });
                });
            });
            
            // Filter to get only unused Gmail accounts
            const availableGmailAccounts = allGmailAccounts.filter(acc => !usedGmailIds.includes(acc.id));
            
            if (availableGmailAccounts.length === 0) {
                gmailSelect.innerHTML = '<option value="">-- Aucun compte Gmail disponible --</option>';
                gmailSelect.disabled = true;
                return;
            }
            
            const options = availableGmailAccounts.map(acc => {
                const label = acc.vaId ? acc.email : `${acc.email}  (non assign)`;
                return `<option value="${acc.id}">${label}</option>`;
            }).join('');
            
            gmailSelect.innerHTML = '<option value="">-- Choisir un compte Gmail --</option>' + options;
            gmailSelect.disabled = false;
        }

        // Supabase Helper: Create VA
        async function createVA(vaData) {
            const orgId = await getActiveOrganizationId();
            if (!orgId) {
                throw new Error('No active organization');
            }

            // Try to insert with email/password columns
            try {
                const { data, error } = await supabase
                    .from('vas')
                    .insert([{
                        organization_id: orgId,
                        user_id: vaData.user_id || null,
                        name: vaData.name,
                        email: vaData.email || null,
                        password: vaData.password || null,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (error) throw error;
                return data;
            } catch (error) {
                // If columns don't exist, insert without email/password
                console.warn(' Email/Password columns not found in Supabase, inserting without them');

                const { data, error: fallbackError } = await supabase
                    .from('vas')
                    .insert([{
                        organization_id: orgId,
                        user_id: vaData.user_id || null,
                        name: vaData.name,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (fallbackError) throw fallbackError;

                // Store email/password in localStorage for this VA
                const vaCredentials = JSON.parse(localStorage.getItem('vaCredentials') || '{}');
                vaCredentials[data.id] = {
                    email: vaData.email,
                    password: vaData.password
                };
                localStorage.setItem('vaCredentials', JSON.stringify(vaCredentials));

                return {
                    ...data,
                    email: vaData.email,
                    password: vaData.password
                };
            }
        }

        // Supabase Helper: Create Creator
        async function createCreator(creatorData) {
            const orgId = await getActiveOrganizationId();
            if (!orgId) {
                throw new Error('No active organization');
            }

            const { data, error } = await supabase
                .from('creators')
                .insert([{
                    organization_id: orgId,
                    name: creatorData.name,
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();

            if (error) throw error;
            return data;
        }

        // Add VA - SUPABASE VERSION (simplified - name only)
        async function addVA(e) {
            e.preventDefault();

            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.innerHTML : null;

            const name = document.getElementById('va-name').value.trim();

            // Check if VA with same name already exists
            if (data.vas.some(v => v.name.toLowerCase() === name.toLowerCase())) {
                showError('Un VA avec ce nom existe dj');
                return;
            }

            try {
                // Set loading state
                setButtonLoading(submitBtn, true);

                // Create VA in Supabase (name only)
                const newVA = await createVA({ name });

                console.log(' VA created in database:', newVA.id);

                // Add to local data
                data.vas.push({
                    id: newVA.id,
                    name: newVA.name,
                    created: newVA.created_at
                });

                form.reset();
                showSuccess(`VA "${name}" ajout avec succs!`);
                updateDisplay();
            } catch (error) {
                console.error(' Error adding VA:', error);
                showError(error.message || 'Erreur lors de l\'ajout du VA');
            } finally {
                setButtonLoading(submitBtn, false, originalText);
            }
        }

        // Open modal to change creator photo
        function openCreatorPhotoModal(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;

            const modal = document.createElement('div');
            modal.id = 'creator-photo-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 10001;';
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 25px 50px rgba(0,0,0,0.25); max-width: 400px; width: 90%; text-align: center;">
                    <h2 style="margin: 0 0 1.5rem; font-size: 1.25rem; color: #1a1a1a;">
                        <i class="fas fa-camera" style="color: #667eea; margin-right: 0.5rem;"></i>
                        Photo de ${creator.name}
                    </h2>

                    <div id="edit-photo-preview" style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 4px solid #667eea; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);">
                        ${creator.photo_url
                            ? `<img src="${creator.photo_url}" style="width: 100%; height: 100%; object-fit: cover;">`
                            : `<i class="fas fa-user" style="font-size: 3rem; color: #94a3b8;"></i>`
                        }
                    </div>

                    <input type="file" id="edit-creator-photo" accept="image/*" style="display: none;" onchange="previewEditCreatorPhoto(this)">

                    <button type="button" onclick="document.getElementById('edit-creator-photo').click()"
                        style="width: 100%; padding: 0.875rem; background: white; border: 2px dashed #667eea; border-radius: 0.75rem; color: #667eea; font-weight: 600; cursor: pointer; margin-bottom: 1rem; transition: all 0.3s;"
                        onmouseover="this.style.background='rgba(102, 126, 234, 0.1)'"
                        onmouseout="this.style.background='white'">
                        <i class="fas fa-upload" style="margin-right: 0.5rem;"></i> Choisir une nouvelle photo
                    </button>

                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="document.getElementById('creator-photo-modal').remove()"
                            style="flex: 1; padding: 0.875rem; background: #f1f5f9; border: none; border-radius: 0.75rem; color: #64748b; font-weight: 600; cursor: pointer;">
                            Annuler
                        </button>
                        <button onclick="saveCreatorPhoto('${creatorId}')"
                            style="flex: 1; padding: 0.875rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 0.75rem; color: white; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-save" style="margin-right: 0.5rem;"></i> Enregistrer
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Preview photo in edit modal
        function previewEditCreatorPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('edit-photo-preview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Compress image before upload
        async function compressImage(file, maxWidth = 400, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Resize if too large
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to compressed base64
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        console.log(' Image compresse: ' + Math.round(compressedBase64.length / 1024) + ' KB');
                        resolve(compressedBase64);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Save creator photo
        async function saveCreatorPhoto(creatorId) {
            const photoInput = document.getElementById('edit-creator-photo');

            if (!photoInput.files || !photoInput.files[0]) {
                showError('Veuillez slectionner une photo');
                return;
            }

            try {
                showSuccess('Compression de l\'image en cours...');

                // Compress image to max 400px width
                const photoUrl = await compressImage(photoInput.files[0], 400, 0.8);

                console.log(' Upload photo pour creator:', creatorId);
                console.log(' Taille base64:', Math.round(photoUrl.length / 1024), 'KB');

                // Update in Supabase
                const { data: updateData, error } = await supabase
                    .from('creators')
                    .update({ photo_url: photoUrl })
                    .eq('id', creatorId)
                    .select();

                if (error) {
                    console.error(' Supabase error:', error);
                    throw new Error(error.message || 'Erreur Supabase');
                }

                console.log(' Update result:', updateData);

                if (!updateData || updateData.length === 0) {
                    throw new Error('Aucune ligne mise  jour - vrifiez les permissions');
                }

                // Update local data
                const creator = data.creators.find(c => c.id === creatorId);
                if (creator) {
                    creator.photo_url = photoUrl;
                }

                // Close modal and refresh
                document.getElementById('creator-photo-modal').remove();
                updateAllCreatorsTable();
                updateDisplay(); // Actualiser le dashboard aussi
                showSuccess('Photo mise  jour !');
            } catch (error) {
                console.error(' Error updating photo:', error);
                showError('Erreur: ' + error.message);
            }
        }

        // Preview creator photo before upload
        function previewCreatorPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('creator-photo-preview');
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Add Creator - SUPABASE VERSION
        async function addCreator(e) {
            e.preventDefault();

            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.innerHTML : null;

            const creatorName = document.getElementById('creator-name').value.trim();
            const photoInput = document.getElementById('creator-photo');
            let photoUrl = null;

            // Vrifier si la cratrice existe dj
            if (data.creators && data.creators.some(c => c.name.toLowerCase() === creatorName.toLowerCase())) {
                showError(`La cratrice "${creatorName}" existe dj!`);
                return;
            }

            try {
                // Set loading state
                setButtonLoading(submitBtn, true);

                // Si une photo est slectionne, la convertir en base64
                if (photoInput.files && photoInput.files[0]) {
                    photoUrl = await fileToBase64(photoInput.files[0]);
                }

                // Create creator in Supabase with photo
                const newCreator = await createCreator({
                    name: creatorName,
                    photo_url: photoUrl
                });

                // Add to local data
                data.creators.push({
                    id: newCreator.id,
                    name: newCreator.name,
                    photo_url: photoUrl,
                    vaIds: [],
                    accounts: [],
                    created: newCreator.created_at
                });

                form.reset();
                // Reset photo preview
                document.getElementById('creator-photo-preview').innerHTML = '<i class="fas fa-camera" style="font-size: 2rem; color: #94a3b8;"></i>';

                updateAllCreatorsTable();
                updateDisplay(); // Met  jour le dashboard
                showSuccess(`Cratrice "${creatorName}" ajoute!`);
            } catch (error) {
                console.error(' Error adding creator:', error);
                showError('Erreur lors de l\'ajout de la cratrice');
            } finally {
                setButtonLoading(submitBtn, false, originalText);
            }
        }
        
        // Delete VA - SUPABASE VERSION
        async function deleteVA(vaId) {
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;

            const totalCreators = va.creators ? va.creators.length : 0;
            const totalAccounts = va.creators ? va.creators.reduce((sum, creator) => sum + creator.accounts.length, 0) : 0;

            // Count associated data
            const associatedSubs = data.subs ? data.subs.filter(s => s.vaId === vaId).length : 0;
            const associatedRevenues = data.revenues ? data.revenues.filter(r => r.vaId === vaId).length : 0;
            const associatedPayments = data.vaPayments ? data.vaPayments.filter(p => p.vaId === vaId).length : 0;

            // Build details list
            const details = [];
            if (totalCreators > 0) details.push(`${totalCreators} cratrice(s)`);
            if (totalAccounts > 0) details.push(`${totalAccounts} compte(s) Twitter`);
            if (associatedSubs > 0) details.push(`${associatedSubs} entre(s) de subs`);
            if (associatedRevenues > 0) details.push(`${associatedRevenues} revenus enregistr(s)`);
            if (associatedPayments > 0) details.push(`${associatedPayments} paiement(s)`);

            // Show confirmation modal
            const confirmed = await showConfirmModal({
                title: `Supprimer "${va.name}" ?`,
                message: 'Cette action est irrversible. Toutes les donnes associes seront dfinitivement supprimes.',
                details: details,
                confirmText: 'Supprimer dfinitivement',
                cancelText: 'Annuler'
            });

            if (!confirmed) return;

            try {
                // Delete from Supabase (CASCADE will delete associated records)
                await window.deleteVA(vaId);

                // Remove from local data
                data.vas = data.vas.filter(v => v.id !== vaId);

                // Remove associated subs
                if (data.subs) {
                    data.subs = data.subs.filter(s => s.vaId !== vaId);
                }

                // Remove associated revenues
                if (data.revenues) {
                    data.revenues = data.revenues.filter(r => r.vaId !== vaId);
                }

                // Remove associated payments
                if (data.vaPayments) {
                    data.vaPayments = data.vaPayments.filter(p => p.vaId !== vaId);
                }

                // Remove old payments if they exist
                if (data.payments) {
                    data.payments = data.payments.filter(p => p.vaId !== vaId);
                }

                showSuccess(`VA "${va.name}" et toutes ses donnes ont t supprims.`);

                // Update all displays that might show VA data
                updateVAGrid();
                updateDisplay();

            } catch (error) {
                showError(`Erreur lors de la suppression : ${error.message}`);
                console.error('Erreur suppression VA:', error);
            }
        }

        // Handle Delete Creator - New simplified version for creator page
        async function handleDeleteCreator(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;

            // Count associated data
            const twitterAccounts = data.twitterAccounts ? data.twitterAccounts.filter(acc => acc.creator_id === creatorId).length : 0;
            const instagramAccounts = data.instagramAccounts ? data.instagramAccounts.filter(acc => acc.creator_id === creatorId).length : 0;
            const associatedSubs = data.subs ? data.subs.filter(s => s.creatorId === creatorId).length : 0;
            const associatedRevenues = data.revenues ? data.revenues.filter(r => r.creatorId === creatorId).length : 0;

            // Build details list
            const details = [];
            if (twitterAccounts > 0) details.push(`${twitterAccounts} compte(s) Twitter`);
            if (instagramAccounts > 0) details.push(`${instagramAccounts} compte(s) Instagram`);
            if (associatedSubs > 0) details.push(`${associatedSubs} entre(s) de subs`);
            if (associatedRevenues > 0) details.push(`${associatedRevenues} revenus enregistr(s)`);

            // Show confirmation modal
            const confirmed = await showConfirmModal({
                title: `Supprimer "${creator.name}" ?`,
                message: 'Cette action est irrversible. Tous les comptes et donnes associs seront dfinitivement supprims.',
                details: details,
                confirmText: 'Supprimer dfinitivement',
                cancelText: 'Annuler'
            });

            if (!confirmed) return;

            try {
                // Delete from Supabase (CASCADE will delete associated accounts)
                await window.deleteCreator(creatorId);

                // Remove from local data
                data.creators = data.creators.filter(c => c.id !== creatorId);

                // Remove from all VAs
                data.vas.forEach(va => {
                    if (va.creatorIds) {
                        va.creatorIds = va.creatorIds.filter(id => id !== creatorId);
                    }
                });

                // Remove associated subs and revenues
                if (data.subs) {
                    data.subs = data.subs.filter(s => s.creatorId !== creatorId);
                }
                if (data.revenues) {
                    data.revenues = data.revenues.filter(r => r.creatorId !== creatorId);
                }

                showSuccess(`Cratrice "${creator.name}" et ses donnes ont t supprimes.`);

                // Update displays
                updateAllCreatorsTable();
                updateDisplay();

            } catch (error) {
                showError(`Erreur lors de la suppression : ${error.message}`);
                console.error(' Erreur suppression cratrice:', error);
            }
        }

        // Delete Creator - SUPABASE VERSION (legacy - for VA page)
        async function deleteCreator(vaId, creatorId) {
            // Utiliser la nouvelle structure
            const creatorIndex = data.creators.findIndex(c => c.id === creatorId);
            if (creatorIndex === -1) return;

            const creator = data.creators[creatorIndex];
            const totalAccounts = creator.accounts ? creator.accounts.length : 0;

            // Count associated data
            const associatedSubs = data.subs ? data.subs.filter(s => s.creatorId === creatorId).length : 0;
            const associatedRevenues = data.revenues ? data.revenues.filter(r => r.creatorId === creatorId).length : 0;

            let confirmMessage = ` ATTENTION : Supprimer la cratrice "${creator.name}" ?\n\n`;
            confirmMessage += `Cela supprimera DFINITIVEMENT :\n`;
            confirmMessage += ` ${totalAccounts} compte(s) Twitter\n`;

            if (associatedSubs > 0) {
                confirmMessage += ` ${associatedSubs} entre(s) de subs\n`;
            }
            if (associatedRevenues > 0) {
                confirmMessage += ` ${associatedRevenues} revenus enregistr(s)\n`;
            }

            confirmMessage += `\n Cette action est IRRVERSIBLE !`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Delete from Supabase (CASCADE will delete associated accounts)
                await window.deleteCreator(creatorId);

                // Supprimer la cratrice de la structure globale
                data.creators.splice(creatorIndex, 1);

                // Retirer la rfrence du VA si elle existe
                if (vaId) {
                    const va = data.vas.find(v => v.id === vaId);
                    if (va && va.creatorIds) {
                        va.creatorIds = va.creatorIds.filter(id => id !== creatorId);
                    }
                }

                // Remove associated subs
                if (data.subs) {
                    data.subs = data.subs.filter(s => !(s.vaId === vaId && s.creatorId === creatorId));
                }

                // Remove associated revenues
                if (data.revenues) {
                    data.revenues = data.revenues.filter(r => !(r.vaId === vaId && r.creatorId === creatorId));
                }

                showSuccess(`Cratrice "${creator.name}" et ses donnes ont t supprimes.`);

                // Update displays
                updateVAGrid();
                updateDisplay();

            } catch (error) {
                showError(`Erreur lors de la suppression : ${error.message}`);
                console.error('Erreur suppression cratrice:', error);
            }
        }

        // On creator change - Check if multi-VA
        function onCreatorChange() {
            const creatorId = document.getElementById('account-creator').value;
            const vaSelect = document.getElementById('account-va');
            const vaWarning = document.getElementById('va-warning');

            if (!creatorId) {
                vaWarning.style.display = 'none';
                vaSelect.style.border = '';
                // Rafficher tous les VAs
                vaSelect.innerHTML = '<option value="">Slectionner un VA</option>';
                data.vas.forEach(va => {
                    const option = document.createElement('option');
                    option.value = va.id;
                    option.textContent = va.name;
                    vaSelect.appendChild(option);
                });
                return;
            }

            const creator = data.creators.find(c => c.id === creatorId);

            // Toujours afficher TOUS les VAs disponibles
            vaSelect.innerHTML = '<option value="">Slectionner un VA</option>';
            data.vas.forEach(va => {
                const option = document.createElement('option');
                option.value = va.id;

                // Indiquer si c'est un VA dj associ  cette cratrice
                if (creator && creator.vaIds && creator.vaIds.includes(va.id)) {
                    option.textContent = `${va.name}  (Dj associ)`;
                    option.style.fontWeight = 'bold';
                } else {
                    option.textContent = va.name;
                }

                vaSelect.appendChild(option);
            });

            if (creator && creator.vaIds && creator.vaIds.length > 1) {
                // Cratrice multi-VA : afficher l'avertissement mais garder tous les VAs
                vaWarning.style.display = 'block';
                vaSelect.style.border = '2px solid #f59e0b';
            } else {
                // Cratrice mono-VA : masquer l'avertissement
                vaWarning.style.display = 'none';
                vaSelect.style.border = '';

                // Si elle n'a qu'un VA, le prslectionner (mais laisser le choix)
                if (creator && creator.vaIds && creator.vaIds.length === 1) {
                    vaSelect.value = creator.vaIds[0];
                }
            }
        }
        
        // Add Account - SUPABASE VERSION
        async function addAccount(e) {
            e.preventDefault();

            // Dterminer la plateforme actuelle
            const platform = window.currentPlatform || 'twitter';

            let username, password;
            if (platform === 'twitter') {
                username = document.getElementById('twitter-username').value.trim();
                password = document.getElementById('twitter-password').value.trim();
            } else {
                username = document.getElementById('instagram-username').value.trim();
                password = document.getElementById('instagram-password').value.trim();
            }

            const creatorId = document.getElementById('account-creator').value;
            const gmailId = document.getElementById('account-gmail').value;
            const vaId = document.getElementById('account-va').value;

            // VALIDATION ULTRATHINK : Vrifier qu'un VA est slectionn pour les cratrices multi-VA
            const creator = data.creators.find(c => c.id === creatorId);
            if (creator && creator.vaIds && creator.vaIds.length > 1 && !vaId) {
                showError(' ATTENTION : Cette cratrice est sur plusieurs VAs. Vous DEVEZ choisir le VA pour ce compte !');
                document.getElementById('account-va').focus();
                document.getElementById('account-va').style.borderColor = '#ef4444';
                return;
            }

            // Normaliser le username
            const finalUsername = username.startsWith('@') ? username : '@' + username;

            try {
                if (platform === 'twitter') {
                    // Initialiser le tableau des comptes Twitter s'il n'existe pas
                    if (!data.twitterAccounts) {
                        data.twitterAccounts = [];
                    }

                    // Vrifier si le compte existe dj
                    const accountExists = data.twitterAccounts.some(acc =>
                        acc.username.toLowerCase() === finalUsername.toLowerCase()
                    );

                    if (accountExists) {
                        showError(`Le compte Twitter "${finalUsername}" existe dj`);
                        return;
                    }

                    // Create Twitter account in Supabase
                    const newTwitterAccount = await window.createTwitterAccount({
                        username: finalUsername,
                        password: password,
                        creator_id: creatorId || null,
                        va_id: vaId || null,
                        gmail_id: gmailId || null
                    });

                    // Si une cratrice est slectionne, ajouter le compte  la cratrice
                    if (creatorId) {
                        const creator = data.creators.find(c => c.id === creatorId);
                        if (creator) {
                            if (!creator.accounts) creator.accounts = [];

                            // Crer le nouveau compte avec assignedVaId si un VA est slectionn
                            const newAccount = {
                                username: finalUsername,
                                password: password
                            };

                            // IMPORTANT: Assigner le compte spcifiquement  CE VA
                            if (vaId) {
                                newAccount.assignedVaId = vaId;
                            }

                            creator.accounts.push(newAccount);

                            // Assigner le VA  la cratrice si slectionn
                            if (vaId && !creator.vaIds) {
                                creator.vaIds = [vaId];
                            } else if (vaId && !creator.vaIds.includes(vaId)) {
                                creator.vaIds.push(vaId);
                            }
                        }
                    }

                    // Si un Gmail est slectionn, l'assigner
                    if (gmailId) {
                        const gmail = data.gmailAccounts.find(g => g.id === gmailId);
                        if (gmail) {
                            gmail.assignedTwitterUsername = finalUsername;
                            if (vaId) gmail.vaId = vaId;
                        }
                    }

                    // Ajouter le compte  la liste locale
                    data.twitterAccounts.push({
                        id: newTwitterAccount.id,
                        username: newTwitterAccount.username,
                        password: password, // Keep decrypted for display
                        creatorId: newTwitterAccount.creator_id,
                        gmailId: newTwitterAccount.gmail_id,
                        vaId: newTwitterAccount.va_id,
                        created: newTwitterAccount.created_at
                    });

                    console.log(' DEBUG - Compte Twitter ajout:');
                    console.log('  - Username:', finalUsername);
                    console.log('  - data.twitterAccounts.length:', data.twitterAccounts.length);
                    console.log('  - Tous les comptes Twitter:', data.twitterAccounts);

                    e.target.reset();
                    updateTwitterAccountsList();
                    updateDisplay(); // Met  jour le dashboard
                    showSuccess(`Compte Twitter ${finalUsername} ajout!`);

                } else { // Instagram
                    // Initialiser le tableau des comptes Instagram s'il n'existe pas
                    if (!data.instagramAccounts) {
                        data.instagramAccounts = [];
                    }

                    // Vrifier si le compte existe dj
                    const accountExists = data.instagramAccounts.some(acc =>
                        acc.username.toLowerCase() === finalUsername.toLowerCase()
                    );

                    if (accountExists) {
                        showError(`Le compte Instagram "${finalUsername}" existe dj`);
                        return;
                    }

                    // Create Instagram account in Supabase
                    const newInstagramAccount = await window.createInstagramAccount({
                        username: finalUsername,
                        password: password,
                        creator_id: creatorId || null,
                        va_id: vaId || null,
                        gmail_id: gmailId || null
                    });

                    // Si une cratrice est slectionne, ajouter le compte  la cratrice
                    console.log(' DEBUG - Ajout  creator.instagramAccounts:');
                    console.log('   creatorId:', creatorId);
                    if (creatorId) {
                        const creator = data.creators.find(c => c.id === creatorId);
                        console.log('   creator trouv:', creator ? creator.name : 'null');
                        if (creator) {
                            if (!creator.instagramAccounts) creator.instagramAccounts = [];
                            console.log('   creator.instagramAccounts.length AVANT:', creator.instagramAccounts.length);

                            // Crer le nouveau compte avec assignedVaId si un VA est slectionn
                            const newAccount = {
                                username: finalUsername,
                                password: password
                            };

                            // IMPORTANT: Assigner le compte spcifiquement  CE VA
                            if (vaId) {
                                newAccount.assignedVaId = vaId;
                            }

                            if (gmailId) {
                                newAccount.gmailId = gmailId;
                            }

                            creator.instagramAccounts.push(newAccount);
                            console.log('   creator.instagramAccounts.length APRS:', creator.instagramAccounts.length);
                            console.log('    Compte ajout  creator.instagramAccounts');

                            // Assigner le VA  la cratrice si slectionn
                            if (vaId && !creator.vaIds) {
                                creator.vaIds = [vaId];
                            } else if (vaId && !creator.vaIds.includes(vaId)) {
                                creator.vaIds.push(vaId);
                            }
                        }
                    }

                    // Si un Gmail est slectionn, l'assigner
                    if (gmailId) {
                        const gmail = data.gmailAccounts.find(g => g.id === gmailId);
                        if (gmail) {
                            gmail.assignedInstagramUsername = finalUsername;
                            if (vaId) gmail.vaId = vaId;
                        }
                    }

                    // Ajouter le compte  la liste locale
                    data.instagramAccounts.push({
                        id: newInstagramAccount.id,
                        username: newInstagramAccount.username,
                        password: password, // Keep decrypted for display
                        creatorId: newInstagramAccount.creator_id,
                        gmailId: newInstagramAccount.gmail_id,
                        vaId: newInstagramAccount.va_id,
                        assignedVaId: vaId || null, // IMPORTANT: Ajouter assignedVaId pour le dashboard VA
                        created: newInstagramAccount.created_at
                    });

                    console.log(' Compte Instagram ajout:', finalUsername);

                    e.target.reset();
                    updateInstagramAccountsList();
                    updateDisplay(); // Met  jour le dashboard
                    saveData(); // Sync to VA Dashboard
                    showSuccess(`Compte Instagram ${finalUsername} ajout!`);
                }
            } catch (error) {
                console.error('Error adding account:', error);
                showError(`Erreur lors de l'ajout du compte ${platform}`);
            }
        }

        // Confirm add Twitter account
        function confirmAddTwitterAccount(vaId, username, password) {
            // IMPORTANT: Ne jamais modifier le username pass en paramtre
            console.log(` Ajout du compte Twitter: ${username}`);
            
            // DEBUG: Afficher l'tat avant ajout
            console.log(' tat AVANT ajout:');
            console.log('Toutes les cratrices "Laura":');
            data.creators.forEach(creator => {
                if (creator.name.toLowerCase().includes('laura')) {
                    console.log(`  - Cratrice "${creator.name}" (ID: ${creator.id})`);
                    console.log(`    VAs associs: ${creator.vaIds?.map(id => data.vas.find(v => v.id === id)?.name).join(', ')}`);
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(acc => {
                            console.log(`    Compte: ${acc.username}`);
                        });
                    }
                }
            });
            
            const existingCreatorId = document.getElementById('select-existing-creator').value;
            const newCreatorName = document.getElementById('new-creator-name').value.trim();
            
            if (!existingCreatorId && !newCreatorName) {
                showError('Veuillez slectionner une cratrice existante ou en crer une nouvelle');
                return;
            }
            
            let selectedCreator;
            
            if (existingCreatorId) {
                // Utiliser cratrice existante
                selectedCreator = data.creators.find(c => c.id === existingCreatorId);
                console.log(` Slection de la cratrice existante: "${selectedCreator?.name}" (ID: ${existingCreatorId})`);
            } else {
                // Crer nouvelle cratrice
                selectedCreator = {
                    id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: newCreatorName,
                    vaIds: [vaId],
                    accounts: []
                };
                data.creators.push(selectedCreator);
                
                // Ajouter la rfrence au VA
                const va = data.vas.find(v => v.id === vaId);
                if (va) {
                    if (!va.creatorIds) va.creatorIds = [];
                    va.creatorIds.push(selectedCreator.id);
                }
            }
            
            // S'assurer que le VA est dans la liste de la cratrice
            if (!selectedCreator.vaIds) selectedCreator.vaIds = [];
            if (!selectedCreator.vaIds.includes(vaId)) {
                selectedCreator.vaIds.push(vaId);
            }
            
            // Crer le compte Twitter - S'ASSURER qu'on utilise le username exact sans modification
            const finalUsername = username.startsWith('@') ? username : '@' + username;
            
            // Vrification finale pour viter les doublons
            const accountAlreadyExists = selectedCreator.accounts && 
                selectedCreator.accounts.some(acc => acc.username.toLowerCase() === finalUsername.toLowerCase());
            
            if (accountAlreadyExists) {
                showError(`Le compte ${finalUsername} existe dj pour cette cratrice`);
                closeModal();
                return;
            }
            
            const newAccount = {
                id: 'tw_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                username: finalUsername, // Utiliser le username exact
                password: obfuscatePassword(password),
                gmailId: null,
                assignedVaId: vaId, // IMPORTANT: Assigner spcifiquement  CE VA
                created: new Date().toISOString().split('T')[0]
            };
            
            if (!selectedCreator.accounts) selectedCreator.accounts = [];
            selectedCreator.accounts.push(newAccount);
            
            saveData();
            closeModal();
            document.getElementById('add-account-form').reset();
            
            // DEBUG: Afficher l'tat aprs ajout
            console.log(' tat APRS ajout:');
            console.log('Toutes les cratrices "Laura" aprs ajout:');
            data.creators.forEach(creator => {
                if (creator.name.toLowerCase().includes('laura')) {
                    console.log(`  - Cratrice "${creator.name}" (ID: ${creator.id})`);
                    console.log(`    VAs associs: ${creator.vaIds?.map(id => data.vas.find(v => v.id === id)?.name).join(', ')}`);
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(acc => {
                            console.log(`    Compte: ${acc.username} (ID: ${acc.id})`);
                        });
                    }
                }
            });
            
            updateTwitterAccountsList();
            updateDisplay();
            
            showSuccess(`Compte Twitter "${newAccount.username}" ajout  "${selectedCreator.name}"!`);
            console.log(` Compte ajout avec succs: ${newAccount.username} pour ${selectedCreator.name}`);
        }
        
        // Add Gmail account
        // Add Gmail Account - SUPABASE VERSION
        async function addGmailAccount(e) {
            e.preventDefault();

            const email = document.getElementById('gmail-email').value.trim().toLowerCase();
            const password = document.getElementById('gmail-password').value.trim();

            // Vrifier si l'email existe dj
            if (!data.gmailAccounts) data.gmailAccounts = [];

            const emailExists = data.gmailAccounts.some(account =>
                account.email.toLowerCase() === email
            );

            if (emailExists) {
                showError(`Cette adresse email "${email}" existe dj !`);
                return;
            }

            try {
                // Create Gmail account in Supabase (password will be encrypted)
                const newAccount = await window.createGmailAccount({
                    email: email,
                    password: password,
                    va_id: null,
                    notes: ''
                });

                // Add to local data
                data.gmailAccounts.push({
                    id: newAccount.id,
                    vaId: newAccount.va_id,
                    email: newAccount.email,
                    password: password, // Keep decrypted in local for display
                    notes: newAccount.notes || '',
                    created: newAccount.created_at
                });

                e.target.reset();
                showSuccess(`Compte Gmail "${email}" ajout!`);
                updateGmailAccountsList();
                updateDisplay(); // Met  jour le dashboard
            } catch (error) {
                console.error('Error adding Gmail account:', error);
                showError('Erreur lors de l\'ajout du compte Gmail');
            }
        }
        
        // Update Gmail accounts display
        function updateGmailAccountsDisplay() {
            const container = document.getElementById('gmail-accounts-container');
            const statsContainer = document.getElementById('gmail-stats');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!data.gmailAccounts || data.gmailAccounts.length === 0) {
                container.innerHTML = '<div class="no-creator">Aucun compte Gmail ajout</div>';
                if (statsContainer) statsContainer.innerHTML = '';
                return;
            }
            
            // Group Gmail accounts by VA (including unassigned)
            const accountsByVA = {
                'unassigned': {
                    name: 'Non assigns',
                    accounts: []
                }
            };
            
            data.vas.forEach(va => {
                accountsByVA[va.id] = {
                    name: va.name,
                    accounts: []
                };
            });
            
            data.gmailAccounts.forEach(account => {
                if (account.vaId && accountsByVA[account.vaId]) {
                    accountsByVA[account.vaId].accounts.push(account);
                } else {
                    accountsByVA['unassigned'].accounts.push(account);
                }
            });
            
            // Get used Gmail IDs from bidirectional assignment
            const usedGmailIds = [];
            const gmailToTwitter = {};
            
            // Check from Twitter accounts (old method)
            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        if (account.gmailId) {
                            usedGmailIds.push(account.gmailId);
                            gmailToTwitter[account.gmailId] = {
                                twitter: account.username,
                                creator: creator.name,
                                va: va.name
                            };
                        }
                    });
                });
            });
            
            // Check from new creator structure
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        if (account.gmailId) {
                            usedGmailIds.push(account.gmailId);
                            gmailToTwitter[account.gmailId] = {
                                twitter: account.username,
                                creator: creator.name,
                                va: creator.assignedVAs && creator.assignedVAs.length > 0 ? 
                                    data.vas.find(v => v.id === creator.assignedVAs[0])?.name : 'Non assign'
                            };
                        }
                    });
                }
            });
            
            // Update statistics
            const totalGmail = data.gmailAccounts.length;
            const usedGmail = usedGmailIds.length;
            const availableGmail = totalGmail - usedGmail;
            const unassignedGmail = accountsByVA['unassigned'].accounts.length;
            
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <span style="color: #059669;"><i class="fas fa-check-circle"></i> ${usedGmail} utiliss</span>
                    <span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${availableGmail} disponibles</span>
                    <span style="color: #f59e0b;"><i class="fas fa-exclamation-triangle"></i> ${unassignedGmail} non assigns</span>
                    <span style="color: #6366f1;"><i class="fas fa-envelope"></i> ${totalGmail} total</span>
                `;
            }
            
            // Display unassigned accounts first
            if (accountsByVA['unassigned'].accounts.length > 0) {
                const unassignedSection = document.createElement('div');
                unassignedSection.className = 'va-section unassigned-section';
                unassignedSection.style.marginBottom = '2rem';
                unassignedSection.style.border = '2px solid #ef4444';
                unassignedSection.style.borderRadius = '0.5rem';
                unassignedSection.style.padding = '1rem';
                
                // Dtecter le mode sombre dynamiquement  chaque affichage
                const isDarkMode = document.body.classList.contains('dark-mode');
                
                unassignedSection.innerHTML = `
                    <h4 style="color: #ef4444; margin-bottom: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i> Comptes Non Assigns (${accountsByVA['unassigned'].accounts.length})
                    </h4>
                    <p style="margin: 0 0 1rem 0; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">
                        <i class="fas fa-info-circle"></i> Pour utiliser ces comptes, allez dans "Twitter sans Gmail" et assignez-les  un compte Twitter.
                    </p>
                    <div class="gmail-list">
                        ${accountsByVA['unassigned'].accounts.map(account => {
                            const isUsed = usedGmailIds.includes(account.id);
                            return `
                            <div class="account-item unassigned-account-item" style="background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : '#fef2f2'}; color: ${isDarkMode ? '#e1e8ef' : 'inherit'}; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; border-left: 4px solid #ef4444;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <strong style="color: ${isDarkMode ? '#f3f4f6' : '#1e293b'};">${account.email}</strong>
                                        <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; background: ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : '#fee2e2'}; color: ${isDarkMode ? '#f87171' : '#991b1b'};">
                                            Non assign ${isUsed ? '(mais utilis!)' : ''}
                                        </span>
                                    </div>
                                    ${account.notes ? `<p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#94a3b8' : '#718096'}; font-size: 0.875rem;">${account.notes}</p>` : ''}
                                    <p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#64748b' : '#a0aec0'}; font-size: 0.75rem;">Ajout le ${new Date(account.created).toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button class="action-btn" onclick="showGmailPassword('${account.id}')" title="Voir le mot de passe">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="handleDeleteGmailAccount('${account.id}')" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(unassignedSection);
            }
            
            // Display accounts grouped by VA
            Object.entries(accountsByVA).forEach(([vaId, vaData]) => {
                if (vaId !== 'unassigned' && vaData.accounts.length > 0) {
                    const vaSection = document.createElement('div');
                    vaSection.className = 'va-section';
                    vaSection.style.marginBottom = '2rem';
                    
                    // Dtecter le mode sombre pour chaque section
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    
                    vaSection.innerHTML = `
                        <h4 style="color: #667eea; margin-bottom: 1rem;">
                            <i class="fas fa-user"></i> ${vaData.name} (${vaData.accounts.length} comptes Gmail)
                        </h4>
                        <div class="gmail-list">
                            ${vaData.accounts.map(account => {
                                const isUsed = usedGmailIds.includes(account.id);
                                const twitterInfo = gmailToTwitter[account.id];
                                return `
                                <div class="account-item" style="background: ${isDarkMode ? (isUsed ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)') : (isUsed ? '#e6fffa' : '#fef2f2')}; color: ${isDarkMode ? '#e1e8ef' : 'inherit'}; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; border-left: 4px solid ${isUsed ? '#10b981' : '#ef4444'};">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <strong style="color: ${isDarkMode ? '#f3f4f6' : '#1e293b'};">${account.email}</strong>
                                            <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; background: ${isDarkMode ? (isUsed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)') : (isUsed ? '#d1fae5' : '#fee2e2')}; color: ${isDarkMode ? (isUsed ? '#4ade80' : '#f87171') : (isUsed ? '#065f46' : '#991b1b')};">
                                                ${isUsed ? 'Utilis' : 'Disponible'}
                                            </span>
                                        </div>
                                        ${isUsed && twitterInfo ? `
                                            <p style="margin: 0.5rem 0 0 0; color: ${isDarkMode ? '#4ade80' : '#059669'}; font-size: 0.875rem;">
                                                <i class="fab fa-twitter"></i> ${twitterInfo.twitter} (Cratrice: ${twitterInfo.creator})
                                            </p>
                                        ` : ''}
                                        ${account.notes ? `<p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#94a3b8' : '#718096'}; font-size: 0.875rem;">${account.notes}</p>` : ''}
                                        <p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#64748b' : '#a0aec0'}; font-size: 0.75rem;">Ajout le ${new Date(account.created).toLocaleDateString('fr-FR')}</p>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <button class="action-btn" onclick="showGmailPassword('${account.id}')" title="Voir le mot de passe">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        ${!isUsed ? `
                                            <button class="action-btn delete" onclick="handleDeleteGmailAccount('${account.id}')" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;}).join('')}
                        </div>
                    `;
                    
                    container.appendChild(vaSection);
                }
            });
        }
        
        // Unassign Gmail from Twitter or Instagram account
        function unassignGmail(gmailId, platform = 'twitter') {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;

            const platformName = platform === 'twitter' ? 'Twitter' : 'Instagram';
            const assignedAccount = platform === 'twitter' ? gmail.assignedTwitterUsername : gmail.assignedInstagramUsername;

            if (confirm(`Voulez-vous dsassigner ${platformName} de ${gmail.email} ?\n\n${platformName}: ${assignedAccount}\n\nCe compte ${platformName} sera disponible pour tre rassign.`)) {
                if (platform === 'twitter') {
                    gmail.assignedTwitterUsername = null;
                } else {
                    gmail.assignedInstagramUsername = null;
                }

                // Ne supprimer vaId que si les deux sont dsassigns
                if (!gmail.assignedTwitterUsername && !gmail.assignedInstagramUsername) {
                    gmail.vaId = null;
                }
                
                saveData();
                updateGmailAccountsList();
                updateTwitterAccountsList();
                showSuccess(`Email ${gmail.email} dsassign et disponible`);
            }
        }
        
        // Toggle Gmail ban status
        async function toggleGmailBanStatus(gmailId, currentStatus) {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;

            const newStatus = currentStatus === 'banned' ? 'active' : 'banned';
            const action = newStatus === 'banned' ? 'bannir' : 'dbannir';

            if (confirm(`tes-vous sr de vouloir ${action} le compte Gmail ${gmail.email} ?`)) {
                try {
                    console.log(`Changement du statut de ${gmail.email} vers ${newStatus}`);

                    // Vrifier si la fonction existe
                    let updateSuccess = false;

                    if (typeof updateGmailAccountStatus !== 'function') {
                        console.error('La fonction updateGmailAccountStatus n\'est pas disponible');
                        // Fallback: mettre  jour directement via Supabase
                        try {
                            const organizationId = await getOrganizationId();
                            const { error } = await supabase
                                .from('gmail_accounts')
                                .update({
                                    status: newStatus,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', gmailId)
                                .eq('organization_id', organizationId);

                            if (error) {
                                // Si la colonne status n'existe pas, on aura une erreur
                                if (error.message.includes('column') || error.code === '42703') {
                                    console.warn(' La colonne status n\'existe pas dans la base de donnes');
                                    console.log(' Stockage local du statut uniquement');
                                    // On continue sans erreur pour stocker localement
                                    updateSuccess = true;
                                } else {
                                    throw error;
                                }
                            } else {
                                console.log(' Statut mis  jour dans Supabase');
                                updateSuccess = true;
                            }
                        } catch (dbError) {
                            console.warn(' Impossible de mettre  jour dans Supabase:', dbError);
                            // On continue pour stocker localement
                            updateSuccess = true;
                        }
                    } else {
                        // Utiliser la fonction Supabase
                        try {
                            await updateGmailAccountStatus(gmailId, newStatus);
                            updateSuccess = true;
                        } catch (fnError) {
                            console.warn(' Erreur avec updateGmailAccountStatus:', fnError);
                            // On continue pour stocker localement
                            updateSuccess = true;
                        }
                    }

                    if (!updateSuccess) {
                        throw new Error('Impossible de mettre  jour le statut');
                    }

                    // Mettre  jour localement
                    gmail.status = newStatus;

                    // Sauvegarder aussi dans localStorage comme backup
                    const bannedGmails = JSON.parse(localStorage.getItem('bannedGmailAccounts') || '{}');
                    if (newStatus === 'banned') {
                        bannedGmails[gmailId] = true;
                    } else {
                        delete bannedGmails[gmailId];
                    }
                    localStorage.setItem('bannedGmailAccounts', JSON.stringify(bannedGmails));

                    // Recharger depuis Supabase si la fonction existe
                    if (typeof loadGmailAccounts === 'function') {
                        try {
                            await loadGmailAccounts();
                        } catch (e) {
                            console.log('Impossible de recharger les comptes Gmail:', e);
                        }
                    }

                    updateDisplay();
                    showSuccess(`Compte Gmail ${gmail.email} ${newStatus === 'banned' ? 'banni' : 'ractiv'} avec succs`);
                } catch (error) {
                    console.error('Error updating Gmail account status:', error);
                    showError(`Erreur lors de la mise  jour du statut du compte Gmail`);
                }
            }
        }

        // Delete Gmail account - SUPABASE VERSION
        async function handleDeleteGmailAccount(gmailId) {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;

            // Vrifier si le compte est assign
            let warningMessage = ` ATTENTION: Voulez-vous vraiment supprimer le compte Gmail ${gmail.email} ?`;

            if (gmail.assignedTwitterUsername) {
                warningMessage += `\n\nCe compte est actuellement assign  ${gmail.assignedTwitterUsername}.`;
                warningMessage += `\nLa suppression cassera cette association !`;
            }

            // Vrifier aussi dans les comptes des cratrices
            let associatedAccounts = [];
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        creator.accounts.forEach(account => {
                            if (account.gmailId === gmailId) {
                                associatedAccounts.push({
                                    creator: creator.name,
                                    twitter: account.username
                                });
                            }
                        });
                    }
                });
            }

            if (associatedAccounts.length > 0) {
                warningMessage += `\n\n Ce Gmail est utilis par :`;
                associatedAccounts.forEach(assoc => {
                    warningMessage += `\n- ${assoc.twitter} (${assoc.creator})`;
                });
                warningMessage += `\n\nCes associations seront perdues !`;
            }

            warningMessage += `\n\nCette action est irrversible !`;

            if (confirm(warningMessage)) {
                try {
                    // Vrifier si la fonction existe
                    console.log('Tentative de suppression du compte Gmail:', gmailId);
                    console.log('Fonction deleteGmailAccount disponible?', typeof deleteGmailAccount);

                    if (typeof deleteGmailAccount !== 'function') {
                        console.error('La fonction deleteGmailAccount n\'est pas disponible');
                        // Fallback: supprimer directement via Supabase
                        const organizationId = await getOrganizationId();
                        const { error } = await supabase
                            .from('gmail_accounts')
                            .delete()
                            .eq('id', gmailId)
                            .eq('organization_id', organizationId);

                        if (error) throw error;
                        console.log(' Gmail account deleted directly via Supabase');
                    } else {
                        // Delete from Supabase via la fonction
                        await deleteGmailAccount(gmailId);
                    }

                    // Supprimer toutes les rfrences  ce Gmail
                    if (data.creators) {
                        data.creators.forEach(creator => {
                            if (creator.accounts) {
                                creator.accounts.forEach(account => {
                                    if (account.gmailId === gmailId) {
                                        account.gmailId = null;
                                    }
                                });
                            }
                        });
                    }

                    // Supprimer dans data.twitterAccounts
                    if (data.twitterAccounts) {
                        data.twitterAccounts.forEach(ta => {
                            if (ta.gmailId === gmailId) {
                                ta.gmailId = null;
                            }
                        });
                    }

                    // Supprimer le compte Gmail de la liste locale
                    const index = data.gmailAccounts.findIndex(g => g.id === gmailId);
                    if (index > -1) {
                        data.gmailAccounts.splice(index, 1);
                    }

                    // Recharger depuis Supabase si la fonction existe
                    if (typeof loadGmailAccounts === 'function') {
                        try {
                            await loadGmailAccounts();
                        } catch (e) {
                            console.log('Impossible de recharger les comptes Gmail:', e);
                        }
                    }

                    updateDisplay();
                    showSuccess(`Compte Gmail ${gmail.email} supprim dfinitivement`);
                } catch (error) {
                    console.error('Error deleting Gmail account:', error);
                    showError('Erreur lors de la suppression du compte Gmail');
                }
            }
        }
        
        // Edit Gmail account
        function editGmailAccount(gmailId) {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;
            
            // Pr-remplir le formulaire
            document.getElementById('edit-gmail-id').value = gmail.id;
            document.getElementById('edit-gmail-email').value = gmail.email;
            
            // Dcoder le mot de passe pour l'dition
            const decodedPassword = deobfuscatePassword(gmail.password);
            document.getElementById('edit-gmail-password').value = decodedPassword;
            
            // Afficher la modal
            document.getElementById('edit-gmail-modal').classList.add('show');
        }
        
        // Toggle password visibility in edit modal
        function toggleEditPasswordVisibility() {
            const passwordInput = document.getElementById('edit-gmail-password');
            const toggleIcon = document.getElementById('edit-password-toggle-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }
        
        // Close edit Gmail modal
        function closeEditGmailModal() {
            document.getElementById('edit-gmail-modal').classList.remove('show');
            document.getElementById('edit-gmail-form').reset();
            // Remettre le champ mot de passe en mode masqu
            const passwordInput = document.getElementById('edit-gmail-password');
            const toggleIcon = document.getElementById('edit-password-toggle-icon');
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
        
        // Save edited Gmail
        function saveEditedGmail(e) {
            e.preventDefault();
            
            const gmailId = document.getElementById('edit-gmail-id').value;
            const newEmail = document.getElementById('edit-gmail-email').value.trim().toLowerCase();
            const newPassword = document.getElementById('edit-gmail-password').value;
            
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;
            
            // Vrifier si le nouvel email existe dj (sauf si c'est le mme compte)
            const emailExists = data.gmailAccounts.some(g => 
                g.id !== gmailId && g.email.toLowerCase() === newEmail
            );
            
            if (emailExists) {
                alert(`L'email ${newEmail} existe dj !`);
                return;
            }
            
            // Mettre  jour les donnes
            const oldEmail = gmail.email;
            gmail.email = newEmail;
            gmail.password = obfuscatePassword(newPassword);
            
            // Log la modification
            console.log(` Modification du compte Gmail:`);
            console.log(`  - Ancien email: ${oldEmail}`);
            console.log(`  - Nouvel email: ${newEmail}`);
            if (gmail.assignedTwitterUsername) {
                console.log(`  - Assign : ${gmail.assignedTwitterUsername}`);
            }
            
            // Sauvegarder et mettre  jour l'affichage
            saveData();
            updateGmailAccountsList();
            closeEditGmailModal();
            showSuccess(`Compte Gmail ${oldEmail} modifi avec succs`);
        }
        
        // Get latest Twitter stats
        function getLatestTwitterStats(username) {
            if (!data.twitterStats) return null;
            
            const accountStats = data.twitterStats.filter(stat => 
                stat.username.toLowerCase() === username.toLowerCase()
            );
            
            if (accountStats.length === 0) return null;
            
            // Retourner la stat la plus rcente
            return accountStats.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        }
        
        // Format number with K/M notation
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // Show update followers modal
        function showUpdateFollowersModal(username) {
            document.getElementById('followers-username').value = username;
            document.getElementById('followers-account-display').innerHTML = `
                <i class="fab fa-twitter"></i> ${username}
            `;
            
            // Dfinir la date du jour par dfaut
            document.getElementById('followers-date').value = new Date().toISOString().split('T')[0];
            
            // Afficher l'historique
            const history = data.twitterStats ? 
                data.twitterStats.filter(stat => stat.username.toLowerCase() === username.toLowerCase())
                    .sort((a, b) => new Date(b.date) - new Date(a.date)) : [];
                    
            let historyHtml = '';
            if (history.length > 0) {
                const latest = history[0];
                const previous = history[1];
                
                historyHtml = `
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; color: #1f2937;">
                            Actuellement: ${formatNumber(latest.followers)} followers
                        </div>
                        <div style="font-size: 0.75rem; color: #6b7280;">
                            Dernire MAJ: ${new Date(latest.date).toLocaleDateString('fr-FR')}
                        </div>
                    `;
                
                if (previous) {
                    const diff = latest.followers - previous.followers;
                    const growth = ((diff / previous.followers) * 100).toFixed(1);
                    const color = diff >= 0 ? '#10b981' : '#ef4444';
                    const sign = diff >= 0 ? '+' : '';
                    
                    historyHtml += `
                        <div style="margin-top: 0.5rem; color: ${color}; font-weight: 600;">
                            ${sign}${formatNumber(Math.abs(diff))} (${sign}${growth}%) cette semaine
                        </div>
                    `;
                }
                
                historyHtml += '</div>';
                
                // Pr-remplir avec la dernire valeur
                document.getElementById('followers-count').value = latest.followers;
            }
            
            document.getElementById('followers-history').innerHTML = historyHtml || 
                '<div style="color: #94a3b8;">Aucun historique disponible</div>';
            
            document.getElementById('update-followers-modal').classList.add('show');
        }
        
        // Close update followers modal
        function closeUpdateFollowersModal() {
            document.getElementById('update-followers-modal').classList.remove('show');
            document.getElementById('update-followers-form').reset();
        }
        
        // Save followers update
        function saveFollowersUpdate(e) {
            e.preventDefault();
            
            const username = document.getElementById('followers-username').value;
            const followers = parseInt(document.getElementById('followers-count').value);
            const date = document.getElementById('followers-date').value;
            
            if (!data.twitterStats) data.twitterStats = [];
            
            // Ajouter la nouvelle statistique
            data.twitterStats.push({
                id: generateId(),
                username: username,
                followers: followers,
                date: date,
                created: new Date().toISOString()
            });
            
            saveData();
            updateDisplay();
            closeUpdateFollowersModal();
            showSuccess(`Followers mis  jour pour ${username}: ${formatNumber(followers)}`);
        }
        
        // Show Gmail password
        function showGmailPassword(emailOrId, password) {
            // Si password est fourni, c'est la version simple (email + password)
            if (password) {
                // Le password est dj dchiffr depuis Supabase
                alert(`Email: ${emailOrId}\nMot de passe: ${password}`);
            } else {
                // Sinon, emailOrId est un ID (version complexe)
                const account = data.gmailAccounts.find(a => a.id === emailOrId);
                if (account) {
                    let pwd = '';

                    console.log('Tentative de dcryptage pour:', account.email,
                               'encrypted_password length:', account.encrypted_password ? account.encrypted_password.length : 'null');

                    // Les mots de passe de 52 caractres sont obfusqus (base64)
                    if (account.encrypted_password) {
                        // Essayer d'abord la dsobfuscation (pour les mots de passe base64)
                        try {
                            pwd = deobfuscatePassword(account.encrypted_password);
                            if (pwd && pwd !== '') {
                                console.log(' Mot de passe dsobfusqu avec succs');
                            }
                        } catch (e) {
                            console.log(' chec de dsobfuscation, tentative de dcryptage AES...');
                            // Si la dsobfuscation choue, essayer le dcryptage AES
                            try {
                                pwd = decryptPassword(account.encrypted_password);
                                if (pwd && pwd !== '') {
                                    console.log(' Mot de passe dcrypt avec AES-GCM');
                                }
                            } catch (e2) {
                                console.log(' chec de dcryptage AES aussi');
                            }
                        }
                    }

                    // Fallback sur d'autres champs possibles
                    if (!pwd || pwd === '') {
                        pwd = account.password || account.password_plain ||
                              account.plain_password || account.decrypted_password || '';
                        if (pwd) {
                            console.log(' Mot de passe trouv dans un champ alternatif');
                        }
                    }

                    // Message final
                    if (!pwd || pwd === '') {
                        pwd = 'Non disponible';
                        console.error(' Aucune mthode n\'a fonctionn pour:', account);
                    }

                    alert(`Email: ${account.email}\nMot de passe: ${pwd}`);
                }
            }
        }
        
        // Debug function to show encrypted passwords
        function debugShowEncryptedPasswords() {
            if (data.gmailAccounts.length === 0) {
                alert('Aucun compte Gmail enregistr');
                return;
            }

            let debugInfo = 'DEBUG: MOTS DE PASSE CHIFFRS\n' + '='.repeat(50) + '\n\n';

            data.gmailAccounts.forEach((account, index) => {
                debugInfo += `[${index + 1}] Email: ${account.email}\n`;
                debugInfo += `encrypted_password: ${account.encrypted_password || 'NULL'}\n`;
                debugInfo += `Longueur: ${account.encrypted_password ? account.encrypted_password.length : 0} caractres\n`;
                debugInfo += `password (dcrypt): ${account.password || 'NULL'}\n`;
                debugInfo += '-'.repeat(50) + '\n\n';
            });

            // Crer une modal pour afficher les infos de debug
            const isDarkMode = document.body.classList.contains('dark-mode');
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; ${isDarkMode ? 'background: #1f2937; color: #f3f4f6;' : ''}">
                    <div class="modal-header" style="${isDarkMode ? 'border-bottom-color: #374151;' : ''}">
                        <h2 style="${isDarkMode ? 'color: #f9fafb;' : ''}">Debug: Mots de passe chiffrs</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="${isDarkMode ? 'color: #9ca3af;' : ''}"></button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <pre style="background: ${isDarkMode ? '#111827' : '#f3f4f6'}; color: ${isDarkMode ? '#e5e7eb' : '#1f2937'}; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'}; font-size: 0.875rem;">${debugInfo}</pre>
                    </div>
                    <div style="padding: 1rem; ${isDarkMode ? 'border-top: 1px solid #374151;' : ''}">
                        <p style="font-size: 0.875rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; margin-bottom: 1rem;">
                            Copiez un encrypted_password et collez-le dans la page test-decrypt.html pour tester le dcryptage.
                        </p>
                        <button onclick="window.open('test-decrypt.html', '_blank')" class="btn" style="background: #3b82f6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; margin-right: 0.5rem;">
                            <i class="fas fa-flask"></i> Ouvrir Test Decrypt
                        </button>
                        <button onclick="copyToClipboard(\`${debugInfo.replace(/`/g, '\\`')}\`)" class="btn" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-copy"></i> Copier les infos
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Log dans la console aussi
            console.log('=== DEBUG GMAIL ACCOUNTS ===');
            data.gmailAccounts.forEach(account => {
                console.log('Account:', account);
            });
        }

        // Show all Gmail passwords
        function showAllGmailPasswords() {
            if (data.gmailAccounts.length === 0) {
                alert('Aucun compte Gmail enregistr');
                return;
            }
            
            let passwordList = 'LISTE DES MOTS DE PASSE GMAIL\n' + '='.repeat(40) + '\n\n';
            
            data.gmailAccounts.forEach(account => {
                // Le password est dj dchiffr par getGmailAccounts
                const password = account.password || account.encrypted_password || 'Non disponible';
                passwordList += `Email: ${account.email}\n`;
                passwordList += `Mot de passe: ${password}\n`;
                passwordList += `VA: ${account.vaId ? data.vas.find(v => v.id === account.vaId)?.name || 'VA supprim' : 'Non assign'}\n`;
                passwordList += `Twitter associ: ${account.assignedTwitterUsername || 'Aucun'}\n`;
                passwordList += '-'.repeat(40) + '\n\n';
            });
            
            // Crer une modal pour afficher les mots de passe
            const isDarkMode = document.body.classList.contains('dark-mode');
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; ${isDarkMode ? 'background: #1f2937; color: #f3f4f6;' : ''}">
                    <div class="modal-header" style="${isDarkMode ? 'border-bottom-color: #374151;' : ''}">
                        <h2 style="${isDarkMode ? 'color: #f9fafb;' : ''}">Tous les mots de passe Gmail</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="${isDarkMode ? 'color: #9ca3af;' : ''}"></button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <pre style="background: ${isDarkMode ? '#111827' : '#f3f4f6'}; color: ${isDarkMode ? '#e5e7eb' : '#1f2937'}; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'};">${passwordList}</pre>
                    </div>
                    <div style="padding: 1rem; text-align: center; ${isDarkMode ? 'border-top: 1px solid #374151;' : ''}">
                        <button onclick="copyToClipboard(\`${passwordList.replace(/`/g, '\\`')}\`)" class="btn" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-copy"></i> Copier tout
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('Copi dans le presse-papiers!');
            }).catch(() => {
                alert('Impossible de copier dans le presse-papiers');
            });
        }
        
        // Show all Twitter passwords
        function showAllTwitterPasswords() {
            const allAccounts = [];
            
            // Collecter depuis la nouvelle structure
            if (data.creators && data.creators.length > 0) {
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(account => {
                            allAccounts.push({
                                username: account.username,
                                password: account.password,
                                creatorName: creator.name,
                                gmail: account.gmailId ? data.gmailAccounts.find(g => g.id === account.gmailId)?.email : account.email || 'Aucun',
                                vaNames: creator.vaIds ? creator.vaIds.map(id => data.vas.find(v => v.id === id)?.name).filter(Boolean).join(', ') : 'Non assign'
                            });
                        });
                    }
                });
            }
            
            // Collecter depuis l'ancienne structure
            data.vas.forEach(va => {
                if (va.creators && va.creators.length > 0) {
                    va.creators.forEach(creator => {
                        if (creator.accounts && creator.accounts.length > 0) {
                            creator.accounts.forEach(account => {
                                // viter les doublons
                                const exists = allAccounts.some(a => 
                                    a.username === account.username && a.creatorName === creator.name
                                );
                                
                                if (!exists) {
                                    allAccounts.push({
                                        username: account.username,
                                        password: account.password,
                                        creatorName: creator.name,
                                        gmail: account.gmailId ? data.gmailAccounts.find(g => g.id === account.gmailId)?.email : account.email || 'Aucun',
                                        vaNames: va.name
                                    });
                                }
                            });
                        }
                    });
                }
            });
            
            if (allAccounts.length === 0) {
                alert('Aucun compte Twitter enregistr');
                return;
            }
            
            // Trier par username
            allAccounts.sort((a, b) => a.username.localeCompare(b.username));
            
            let passwordList = 'LISTE DES MOTS DE PASSE TWITTER\n' + '='.repeat(40) + '\n\n';
            
            allAccounts.forEach(account => {
                // Toujours essayer de dcoder le mot de passe
                let decodedPassword;
                try {
                    decodedPassword = deobfuscatePassword(account.password);
                } catch (e) {
                    // Si le dcodage choue, utiliser le mot de passe tel quel
                    decodedPassword = account.password;
                }
                
                passwordList += `Twitter: ${account.username}\n`;
                passwordList += `Mot de passe: ${decodedPassword}\n`;
                passwordList += `Cratrice: ${account.creatorName}\n`;
                passwordList += `VA: ${account.vaNames}\n`;
                passwordList += `Gmail associ: ${account.gmail}\n`;
                passwordList += '-'.repeat(40) + '\n\n';
            });
            
            // Crer une modal pour afficher les mots de passe
            const isDarkMode = document.body.classList.contains('dark-mode');
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; ${isDarkMode ? 'background: #1f2937; color: #f3f4f6;' : ''}">
                    <div class="modal-header" style="${isDarkMode ? 'border-bottom-color: #374151;' : ''}">
                        <h2 style="${isDarkMode ? 'color: #f9fafb;' : ''}">Tous les mots de passe Twitter</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="${isDarkMode ? 'color: #9ca3af;' : ''}"></button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <pre style="background: ${isDarkMode ? '#111827' : '#f3f4f6'}; color: ${isDarkMode ? '#e5e7eb' : '#1f2937'}; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'};">${passwordList}</pre>
                    </div>
                    <div style="padding: 1rem; text-align: center; ${isDarkMode ? 'border-top: 1px solid #374151;' : ''}">
                        <button onclick="copyToClipboard(\`${passwordList.replace(/`/g, '\\`')}\`)" class="btn" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-copy"></i> Copier tout
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Platform switching function
        function switchPlatform(platform) {
            const buttons = document.querySelectorAll('.platform-btn');
            const twitterFields = document.getElementById('twitter-fields');
            const instagramFields = document.getElementById('instagram-fields');
            const accountsTitle = document.getElementById('accounts-list-title');
            const twitterList = document.getElementById('twitter-accounts-list');
            const instagramList = document.getElementById('instagram-accounts-list');
            const twitterPasswordBtn = document.getElementById('show-twitter-passwords-btn');
            const instagramPasswordBtn = document.getElementById('show-instagram-passwords-btn');
            const submitBtn = document.getElementById('add-account-btn');

            // Update button states
            buttons.forEach(btn => {
                if (btn.dataset.platform === platform) {
                    btn.classList.add('active');
                    if (platform === 'twitter') {
                        btn.style.background = '#1DA1F2';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045)';
                        btn.style.color = 'white';
                    }
                } else {
                    btn.classList.remove('active');
                    btn.style.background = '#E4E7EB';
                    btn.style.color = '#4B5563';
                }
            });

            // Switch form fields
            if (platform === 'twitter') {
                twitterFields.style.display = 'block';
                instagramFields.style.display = 'none';
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter Compte Twitter';

                // Update list display
                accountsTitle.innerHTML = '<i class="fab fa-twitter" style="color: #1da1f2;"></i> Comptes Twitter Existants';
                twitterList.style.display = 'flex';
                instagramList.style.display = 'none';
                twitterPasswordBtn.style.display = 'block';
                instagramPasswordBtn.style.display = 'none';

                // Clear Instagram fields
                document.getElementById('instagram-username').value = '';
                document.getElementById('instagram-password').value = '';
                document.getElementById('instagram-username').removeAttribute('required');
                document.getElementById('instagram-password').removeAttribute('required');
                document.getElementById('twitter-username').setAttribute('required', 'required');
                document.getElementById('twitter-password').setAttribute('required', 'required');
            } else {
                twitterFields.style.display = 'none';
                instagramFields.style.display = 'block';
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter Compte Instagram';

                // Update list display
                accountsTitle.innerHTML = '<i class="fab fa-instagram" style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i> Comptes Instagram Existants';
                twitterList.style.display = 'none';
                instagramList.style.display = 'flex';
                twitterPasswordBtn.style.display = 'none';
                instagramPasswordBtn.style.display = 'block';

                // Clear Twitter fields
                document.getElementById('twitter-username').value = '';
                document.getElementById('twitter-password').value = '';
                document.getElementById('twitter-username').removeAttribute('required');
                document.getElementById('twitter-password').removeAttribute('required');
                document.getElementById('instagram-username').setAttribute('required', 'required');
                document.getElementById('instagram-password').setAttribute('required', 'required');
            }

            // Store current platform
            window.currentPlatform = platform;

            // Update the accounts list
            if (platform === 'instagram') {
                updateInstagramAccountsList();
            }
        }

        // Update Instagram accounts list
        function updateInstagramAccountsList() {
            const container = document.getElementById('instagram-accounts-list');
            if (!container) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            // Collecter tous les comptes Instagram
            const allInstagramAccounts = [];

            // 1. Comptes de data.instagramAccounts
            if (data.instagramAccounts) {
                data.instagramAccounts.forEach(account => {
                    allInstagramAccounts.push({
                        ...account,
                        creatorName: account.creatorId ?
                            data.creators.find(c => c.id === account.creatorId)?.name || 'Non assign' :
                            'Non assign',
                        vaName: account.vaId ?
                            data.vas.find(v => v.id === account.vaId)?.name || 'Non assign' :
                            'Non assign',
                        gmailEmail: account.gmailId ?
                            data.gmailAccounts.find(g => g.id === account.gmailId)?.email || 'Aucun' :
                            'Aucun'
                    });
                });
            }

            // 2. Comptes depuis les cratrices (nouvelle structure)
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.instagramAccounts) {
                        creator.instagramAccounts.forEach(account => {
                            // Vrifier qu'il n'est pas dj dans la liste
                            if (!allInstagramAccounts.find(a => a.username === account.username)) {
                                allInstagramAccounts.push({
                                    ...account,
                                    creatorName: creator.name,
                                    vaName: account.assignedVaId ?
                                        data.vas.find(v => v.id === account.assignedVaId)?.name || 'Non assign' :
                                        creator.vaIds && creator.vaIds.length > 0 ?
                                            creator.vaIds.map(id => data.vas.find(v => v.id === id)?.name).filter(n => n).join(', ') :
                                            'Non assign',
                                    gmailEmail: account.gmailId ?
                                        data.gmailAccounts.find(g => g.id === account.gmailId)?.email || 'Aucun' :
                                        'Aucun'
                                });
                            }
                        });
                    }
                });
            }

            if (allInstagramAccounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                        <i class="fab fa-instagram" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Aucun compte Instagram</p>
                    </div>
                `;
                return;
            }

            // Afficher TOUS les comptes Instagram avec leurs associations (comme Twitter)
            container.innerHTML = allInstagramAccounts.map(account => {
                const creator = account.creatorName && account.creatorName !== 'Non assign' ?
                    data.creators.find(c => c.name === account.creatorName) : null;
                const gmail = account.gmailEmail && account.gmailEmail !== 'Aucun' ? account.gmailEmail : null;
                const va = account.vaName && account.vaName !== 'Non assign' ? account.vaName : null;

                return `
                <div style="
                    padding: 1rem;
                    background: ${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'};
                    border: 1px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.3)' : '#c13584'};
                    border-radius: 0.5rem;
                    margin-bottom: 0.75rem;
                    transition: all 0.2s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong style="font-size: 1.1rem; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">
                                ${account.username}
                                ${!gmail ? `
                                    <i class="fas fa-exclamation-triangle"
                                       style="color: #fbbf24; margin-left: 0.5rem; font-size: 0.9rem;"
                                       title="Pas de Gmail associ"></i>
                                ` : ''}
                            </strong>
                            <div style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'}; margin-top: 0.5rem;">
                                ${creator ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-user" style="width: 20px; color: #c13584;"></i> Cratrice: <strong>${account.creatorName}</strong></div>` : ''}
                                ${gmail ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-envelope" style="width: 20px; color: #ea4335;"></i> Gmail: <strong>${gmail}</strong></div>` :
                                  creator ? `<div style="margin-bottom: 0.25rem; color: #ef4444;"><i class="fas fa-envelope" style="width: 20px; opacity: 0.5;"></i> <em>Aucun Gmail associ</em></div>` : ''}
                                ${va ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-user-tie" style="width: 20px; color: #667eea;"></i> VA: <strong>${va}</strong></div>` : ''}
                                <div style="margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-key" style="width: 20px; color: #c13584;"></i>
                                    <span>Mot de passe: </span>
                                    <span id="pwd-insta-${account.username.replace(/[^a-zA-Z0-9]/g, '_')}" style="font-family: monospace; background: ${isDarkMode ? 'rgba(193, 53, 132, 0.2)' : 'rgba(193, 53, 132, 0.1)'}; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">
                                        
                                    </span>
                                    <button onclick="togglePasswordDisplay('pwd-insta-${account.username.replace(/[^a-zA-Z0-9]/g, '_')}', '${(account.password || '').replace(/'/g, "\\'")}', this)"
                                            style="background: none; border: none; cursor: pointer; color: #c13584; padding: 0.25rem;" title="Afficher/Masquer">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="copyToClipboard('${(account.password || '').replace(/'/g, "\\'")}', 'instagram')"
                                            style="background: none; border: none; cursor: pointer; color: #10b981; padding: 0.25rem;" title="Copier">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                ${!creator && !gmail && !va ? '<div style="color: #ef4444; font-style: italic;">Aucune association</div>' : ''}
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                                    Ajout le ${account.created ? new Date(account.created).toLocaleDateString('fr-FR') : 'Date inconnue'}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="action-btn" onclick="editInstagramUsername('${account.id}', '${account.username}')"
                                    style="background: #10b981;" title="Modifier le @">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="handleDeleteInstagramAccount('${account.id || account.username}')"
                                    style="background: #ef4444;" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Edit Instagram username
        async function editInstagramUsername(accountId, currentUsername) {
            const newUsername = prompt(`Modifier le @ Instagram\n\nAncien: ${currentUsername}\nNouveau:`, currentUsername);

            if (!newUsername || newUsername === currentUsername) {
                return; // Annul ou pas de changement
            }

            // Valider le format du username
            if (!newUsername.startsWith('@')) {
                showError('Le nom d\'utilisateur doit commencer par @');
                return;
            }

            try {
                // Mettre  jour dans Supabase
                await updateInstagramUsername(accountId, newUsername);

                // Mettre  jour dans data local
                const account = data.instagramAccounts.find(a => a.id === accountId);
                if (account) {
                    account.username = newUsername;
                }

                // Mettre  jour l'affichage
                updateInstagramAccountsList();
                updateDisplay();

                showSuccess(` Username Instagram modifi en ${newUsername}`);
            } catch (error) {
                console.error('Erreur lors de la modification:', error);
                showError('Erreur lors de la modification du username');
            }
        }

        // Show Instagram password
        function showInstagramPassword(username, password) {
            const decodedPassword = deobfuscatePassword(password);
            alert(`Instagram: ${username}\nMot de passe: ${decodedPassword}`);
        }

        // Show all Instagram passwords
        function showAllInstagramPasswords() {
            const allAccounts = [];

            // Collecter depuis data.instagramAccounts
            if (data.instagramAccounts && data.instagramAccounts.length > 0) {
                data.instagramAccounts.forEach(account => {
                    allAccounts.push({
                        username: account.username,
                        password: account.password,
                        creatorName: account.creatorId ?
                            data.creators.find(c => c.id === account.creatorId)?.name || 'Non assign' :
                            'Non assign',
                        vaNames: account.vaId ?
                            data.vas.find(v => v.id === account.vaId)?.name || 'Non assign' :
                            'Non assign',
                        gmail: account.gmailId ?
                            data.gmailAccounts.find(g => g.id === account.gmailId)?.email || 'Aucun' :
                            'Aucun'
                    });
                });
            }

            // Collecter depuis les cratrices
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.instagramAccounts) {
                        creator.instagramAccounts.forEach(account => {
                            if (!allAccounts.find(a => a.username === account.username)) {
                                allAccounts.push({
                                    username: account.username,
                                    password: account.password,
                                    creatorName: creator.name,
                                    vaNames: account.assignedVaId ?
                                        data.vas.find(v => v.id === account.assignedVaId)?.name :
                                        creator.vaIds?.map(id => data.vas.find(v => v.id === id)?.name).filter(n => n).join(', ') || 'Non assign',
                                    gmail: account.gmailId ?
                                        data.gmailAccounts.find(g => g.id === account.gmailId)?.email || 'Aucun' :
                                        'Aucun'
                                });
                            }
                        });
                    }
                });
            }

            if (allAccounts.length === 0) {
                alert('Aucun compte Instagram enregistr');
                return;
            }

            // Trier par username
            allAccounts.sort((a, b) => a.username.localeCompare(b.username));

            let passwordList = 'LISTE DES MOTS DE PASSE INSTAGRAM\n' + '='.repeat(40) + '\n\n';

            allAccounts.forEach(account => {
                let decodedPassword;
                try {
                    decodedPassword = deobfuscatePassword(account.password);
                } catch (e) {
                    decodedPassword = account.password;
                }

                passwordList += `Instagram: ${account.username}\n`;
                passwordList += `Mot de passe: ${decodedPassword}\n`;
                passwordList += `Cratrice: ${account.creatorName}\n`;
                passwordList += `VA: ${account.vaNames}\n`;
                passwordList += `Gmail associ: ${account.gmail}\n`;
                passwordList += '-'.repeat(40) + '\n\n';
            });

            // Crer une modal pour afficher les mots de passe
            const isDarkMode = document.body.classList.contains('dark-mode');
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; ${isDarkMode ? 'background: #1f2937; color: #f3f4f6;' : ''}">
                    <div class="modal-header" style="${isDarkMode ? 'border-bottom-color: #374151;' : ''}">
                        <h2 style="${isDarkMode ? 'color: #f9fafb;' : ''}">Tous les mots de passe Instagram</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="${isDarkMode ? 'color: #9ca3af;' : ''}"></button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <pre style="background: ${isDarkMode ? '#111827' : '#f3f4f6'}; color: ${isDarkMode ? '#e5e7eb' : '#1f2937'}; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'};">${passwordList}</pre>
                    </div>
                    <div style="padding: 1rem; text-align: center; ${isDarkMode ? 'border-top: 1px solid #374151;' : ''}">
                        <button onclick="copyToClipboard(\`${passwordList.replace(/`/g, '\\`')}\`)" class="btn" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-copy"></i> Copier tout
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Delete Instagram account - UI Handler
        async function handleDeleteInstagramAccount(accountId) {
            console.log(' DELETE Instagram - accountId:', accountId);
            console.log('  - data.instagramAccounts AVANT:', data.instagramAccounts);

            if (!confirm('Voulez-vous vraiment supprimer ce compte Instagram?')) {
                console.log('   Suppression annule par l\'utilisateur');
                return;
            }

            try {
                console.log('   Appel de window.deleteInstagramAccount()...');

                // Vrifier que la fonction Supabase existe
                if (typeof window.deleteInstagramAccount !== 'function') {
                    throw new Error('La fonction Supabase deleteInstagramAccount n\'existe pas');
                }

                // Supprimer de Supabase
                await window.deleteInstagramAccount(accountId);
                console.log('   Supprim de Supabase');

                // Supprimer de data.instagramAccounts
                const beforeLength = data.instagramAccounts ? data.instagramAccounts.length : 0;
                if (data.instagramAccounts) {
                    data.instagramAccounts = data.instagramAccounts.filter(a => a.id !== accountId && a.username !== accountId);
                }
                const afterLength = data.instagramAccounts ? data.instagramAccounts.length : 0;
                console.log('   Supprim du tableau local (', beforeLength, '', afterLength, ')');

                // Supprimer des cratrices
                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.instagramAccounts) {
                            const before = creator.instagramAccounts.length;
                            creator.instagramAccounts = creator.instagramAccounts.filter(a =>
                                a.id !== accountId && a.username !== accountId
                            );
                            const after = creator.instagramAccounts.length;
                            if (before !== after) {
                                console.log('   Supprim de la cratrice', creator.name, '(', before, '', after, ')');
                            }
                        }
                    });
                }

                console.log('  - data.instagramAccounts APRS:', data.instagramAccounts);
                console.log('   Mise  jour de l\'affichage...');
                updateInstagramAccountsList();
                updateDisplay(); // Mettre  jour le dashboard
                saveData(); // Sync to VA Dashboard
                showSuccess('Compte Instagram supprim');
                console.log('   Suppression termine');
            } catch (error) {
                console.error(' Error deleting Instagram account:', error);
                showError('Erreur lors de la suppression du compte Instagram');
            }
        }

        // Delete Instagram from creator (for VA cards)
        function deleteInstagramFromCreator(creatorId, username) {
            if (!confirm(`Voulez-vous vraiment supprimer le compte Instagram ${username}?`)) return;

            const creator = data.creators.find(c => c.id === creatorId);
            if (creator && creator.instagramAccounts) {
                creator.instagramAccounts = creator.instagramAccounts.filter(a =>
                    a.username !== username
                );
            }

            // Supprimer aussi de data.instagramAccounts
            if (data.instagramAccounts) {
                data.instagramAccounts = data.instagramAccounts.filter(a =>
                    a.username !== username
                );
            }

            saveData();
            updateDisplay();
            updateInstagramAccountsList();
            showSuccess('Compte Instagram supprim');
        }

        // Delete Gmail account
        // ANCIENNE FONCTION - NE PLUS UTILISER
        function OLD_deleteGmailAccount_localStorage(accountId) {
            if (confirm('tes-vous sr de vouloir supprimer ce compte Gmail ?')) {
                // Nettoyer les rfrences dans les comptes Twitter (bidirectionnel)
                const gmail = data.gmailAccounts.find(a => a.id === accountId);
                if (gmail && gmail.assignedTwitterUsername) {
                    // Chercher dans l'ancienne structure
                    data.vas.forEach(va => {
                        va.creators.forEach(creator => {
                            creator.accounts.forEach(account => {
                                if (account.gmailId === accountId) {
                                    delete account.gmailId;
                                    delete account.gmailAccount;
                                    delete account.email;
                                }
                            });
                        });
                    });

                    // Chercher dans la nouvelle structure
                    data.creators.forEach(creator => {
                        if (creator.accounts) {
                            creator.accounts.forEach(account => {
                                if (account.gmailId === accountId) {
                                    delete account.gmailId;
                                    delete account.gmailAccount;
                                    delete account.email;
                                }
                            });
                        }
                    });
                }

                data.gmailAccounts = data.gmailAccounts.filter(a => a.id !== accountId);
                saveData();
                showSuccess('Compte Gmail supprim');
                updateGmailAccountsDisplay();
            }
        }
        
        
        // Update Twitter unassigned display
        function updateTwitterUnassignedDisplay() {
            const container = document.getElementById('twitter-unassigned-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Dtecter le mode sombre
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Collecter tous les comptes Twitter sans Gmail
            const twitterAccountsWithoutGmail = [];
            
            // Utiliser la nouvelle structure data.creators
            if (data.creators && data.creators.length > 0) {
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(account => {
                            // Vrifier si le compte a un Gmail de plusieurs faons
                            let hasGmail = false;
                            
                            // 1. Vrifier gmailId
                            if (account.gmailId && account.gmailId !== '') {
                                hasGmail = true;
                            }
                            
                            // 2. Vrifier via assignedTwitterUsername
                            if (!hasGmail) {
                                const gmailByUsername = data.gmailAccounts?.find(g => 
                                    g.assignedTwitterUsername && 
                                    g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                                );
                                if (gmailByUsername) {
                                    hasGmail = true;
                                }
                            }
                            
                            // Si pas de Gmail trouv
                            if (!hasGmail) {
                                // Trouver le VA associ  cette cratrice
                                let vaInfo = null;
                                if (creator.vaIds && creator.vaIds.length > 0) {
                                    const va = data.vas.find(v => creator.vaIds.includes(v.id));
                                    if (va) {
                                        vaInfo = va;
                                    }
                                }
                                
                                twitterAccountsWithoutGmail.push({
                                    account: account,
                                    creator: creator,
                                    va: vaInfo || { name: 'Non assign', color: '#6b7280' }
                                });
                            }
                        });
                    }
                });
            }
            
            // Aussi chercher dans l'ancienne structure au cas o
            data.vas.forEach(va => {
                if (va.creators && va.creators.length > 0) {
                    va.creators.forEach(creator => {
                        if (creator.accounts && creator.accounts.length > 0) {
                            creator.accounts.forEach(account => {
                                // Vrifier si le compte a un Gmail de plusieurs faons
                                let hasGmail = false;
                                
                                // 1. Vrifier gmailId
                                if (account.gmailId && account.gmailId !== '') {
                                    hasGmail = true;
                                }
                                
                                // 2. Vrifier via assignedTwitterUsername
                                if (!hasGmail) {
                                    const gmailByUsername = data.gmailAccounts?.find(g => 
                                        g.assignedTwitterUsername && 
                                        g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                                    );
                                    if (gmailByUsername) {
                                        hasGmail = true;
                                    }
                                }
                                
                                if (!hasGmail) {
                                    // viter les doublons
                                    const exists = twitterAccountsWithoutGmail.some(t => 
                                        t.account.username === account.username && 
                                        t.creator.name === creator.name
                                    );
                                    
                                    if (!exists) {
                                        twitterAccountsWithoutGmail.push({
                                            account: account,
                                            creator: creator,
                                            va: va
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            if (twitterAccountsWithoutGmail.length === 0) {
                // Vrifier s'il y a des comptes Twitter au total
                let totalTwitterAccounts = 0;
                data.creators?.forEach(creator => {
                    totalTwitterAccounts += (creator.accounts ? creator.accounts.length : 0);
                });
                
                if (totalTwitterAccounts === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: ${isDarkMode ? '#64748b' : '#94a3b8'};">
                            <i class="fab fa-twitter" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            <p>Aucun compte Twitter dans le systme</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">Ajoutez des comptes Twitter depuis la page "Ajouter Compte"</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: ${isDarkMode ? '#64748b' : '#94a3b8'};">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem; display: block;"></i>
                            <p>Tous les comptes Twitter ont un Gmail assign !</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Grouper par VA
            const groupedByVA = {};
            twitterAccountsWithoutGmail.forEach(({account, creator, va}) => {
                if (!groupedByVA[va.id]) {
                    groupedByVA[va.id] = {
                        va: va,
                        accounts: []
                    };
                }
                groupedByVA[va.id].accounts.push({account, creator});
            });
            
            // Afficher par VA
            Object.values(groupedByVA).forEach(({va, accounts}) => {
                const vaSection = document.createElement('div');
                vaSection.style.marginBottom = '2rem';
                
                vaSection.innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 1rem;">
                        <i class="fas fa-user"></i> ${va.name} (${accounts.length} comptes sans Gmail)
                    </h3>
                    <div style="display: grid; gap: 1rem;">
                        ${accounts.map(({account, creator}) => `
                            <div style="background: ${isDarkMode ? 'rgba(249, 158, 11, 0.1)' : '#fef3c7'}; 
                                        padding: 1rem; border-radius: 0.5rem; 
                                        border-left: 4px solid #f59e0b;
                                        display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <strong style="color: ${isDarkMode ? '#f3f4f6' : '#1e293b'};">
                                            <i class="fab fa-twitter" style="color: #1DA1F2;"></i> ${account.username}
                                        </strong>
                                        <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; 
                                                     background: ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : '#fee2e2'}; 
                                                     color: ${isDarkMode ? '#f87171' : '#991b1b'};">
                                            <i class="fas fa-exclamation-triangle"></i> Sans Gmail
                                        </span>
                                    </div>
                                    <p style="margin: 0; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">
                                        <i class="fas fa-star"></i> Cratrice: ${creator.name}
                                    </p>
                                    ${account.email ? `
                                        <p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#64748b' : '#94a3b8'}; font-size: 0.75rem;">
                                            <i class="fas fa-envelope"></i> Email manuel: ${account.email}
                                        </p>
                                    ` : ''}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="action-btn" onclick="showAssignGmailToTwitterModal('${va.id}', '${creator.id}', '${account.username}')" 
                                            style="background: #10b981;" title="Assigner un Gmail">
                                        <i class="fas fa-envelope-plus"></i> Assigner Gmail
                                    </button>
                                    <button class="action-btn" onclick="editAccount('${va.id}', '${creator.id}', ${creator.accounts.indexOf(account)})" 
                                            style="background: #3b82f6;" title="Modifier le compte">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(vaSection);
            });
            
            // Ajouter des stats en haut
            const statsDiv = document.createElement('div');
            statsDiv.style.cssText = `
                background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : '#fee2e2'}; 
                padding: 1rem; 
                border-radius: 0.5rem; 
                margin-bottom: 2rem;
                text-align: center;
            `;
            statsDiv.innerHTML = `
                <h3 style="color: ${isDarkMode ? '#f87171' : '#dc2626'}; margin: 0;">
                    <i class="fas fa-exclamation-circle"></i> ${twitterAccountsWithoutGmail.length} comptes Twitter sans Gmail
                </h3>
            `;
            container.insertBefore(statsDiv, container.firstChild);
        }
        
        // Show assign Gmail to Twitter modal
        function showAssignGmailToTwitterModal(vaId, creatorId, twitterUsername) {
            const modal = document.getElementById('assign-gmail-twitter-modal');
            document.getElementById('assign-twitter-va-id').value = vaId;
            document.getElementById('assign-twitter-creator-id').value = creatorId;
            document.getElementById('assign-twitter-username').value = twitterUsername;
            document.getElementById('assign-twitter-display').textContent = twitterUsername;
            
            // Rcuprer tous les comptes Gmail disponibles (non utiliss)
            const usedGmailIds = [];
            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        if (account.gmailId) {
                            usedGmailIds.push(account.gmailId);
                        }
                    });
                });
            });
            
            const availableGmails = data.gmailAccounts.filter(gmail => !usedGmailIds.includes(gmail.id));
            
            const gmailSelect = document.getElementById('assign-twitter-gmail-select');
            if (availableGmails.length === 0) {
                gmailSelect.innerHTML = '<option value="">-- Aucun Gmail disponible --</option>';
                gmailSelect.disabled = true;
            } else {
                gmailSelect.innerHTML = '<option value="">-- Choisir un Gmail --</option>' +
                    availableGmails.map(gmail => {
                        const label = gmail.vaId ? 
                            `${gmail.email} (VA: ${data.vas.find(v => v.id === gmail.vaId)?.name || 'Inconnu'})` : 
                            `${gmail.email}  (Non assign)`;
                        return `<option value="${gmail.id}">${label}</option>`;
                    }).join('');
                gmailSelect.disabled = false;
            }
            
            modal.classList.add('show');
        }
        
        // Assign Gmail to Twitter
        function assignGmailToTwitter(e) {
            e.preventDefault();
            
            const vaId = document.getElementById('assign-twitter-va-id').value;
            const creatorId = document.getElementById('assign-twitter-creator-id').value;
            const twitterUsername = document.getElementById('assign-twitter-username').value;
            const gmailId = document.getElementById('assign-twitter-gmail-select').value;
            
            if (!gmailId) {
                showError('Veuillez slectionner un compte Gmail');
                return;
            }
            
            // Trouver le compte Twitter
            const va = data.vas.find(v => v.id === vaId);
            const creator = va?.creators.find(c => c.id === creatorId);
            const account = creator?.accounts.find(a => a.username === twitterUsername);
            
            if (account) {
                // Retirer l'ancien Gmail si ncessaire
                if (account.gmailId) {
                    const oldGmail = data.gmailAccounts.find(g => g.id === account.gmailId);
                    if (oldGmail) {
                        delete oldGmail.assignedTwitter;
                        delete oldGmail.assignedTwitterUsername;
                        delete oldGmail.assignedCreatorId;
                    }
                }
                
                // Assigner le Gmail au Twitter
                account.gmailId = gmailId;
                
                // Rcuprer l'email du Gmail
                const gmail = data.gmailAccounts.find(g => g.id === gmailId);
                if (gmail) {
                    account.email = gmail.email;
                    
                    // Si le Gmail n'avait pas de VA, lui assigner le VA du Twitter
                    if (!gmail.vaId) {
                        gmail.vaId = vaId;
                    }
                    
                    // Assigner le Twitter au Gmail (bidirectionnel)
                    gmail.assignedTwitter = account.id || twitterUsername;
                    gmail.assignedTwitterUsername = twitterUsername;
                    gmail.assignedCreatorId = creatorId;
                }
                
                saveData();
                closeAssignGmailTwitterModal();
                showSuccess(`Gmail ${gmail.email} assign  ${twitterUsername} !`);
                updateDisplay();
            }
        }
        
        // Close assign Gmail to Twitter modal
        function closeAssignGmailTwitterModal() {
            document.getElementById('assign-gmail-twitter-modal').classList.remove('show');
        }
        
        // Edit Twitter account
        function editAccount(vaId, creatorId, accountIndex) {
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            const creator = va.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const account = creator.accounts[accountIndex];
            if (!account) return;
            
            // Store the IDs for update
            document.getElementById('edit-account-va-id').value = vaId;
            document.getElementById('edit-account-creator-id').value = creatorId;
            document.getElementById('edit-account-index').value = accountIndex;
            
            // Fill the form
            document.getElementById('edit-username').value = account.username;
            document.getElementById('edit-password').value = '';
            
            // Show manual email field if no Gmail is associated
            const editManualEmailGroup = document.getElementById('edit-manual-email-group');
            const editEmailInput = document.getElementById('edit-email');
            
            if (!account.gmailId && account.email) {
                editManualEmailGroup.style.display = 'block';
                editEmailInput.value = account.email;
            } else {
                editManualEmailGroup.style.display = 'none';
                editEmailInput.value = '';
            }
            
            // Load Gmail accounts for this VA
            const vaGmailAccounts = data.gmailAccounts?.filter(acc => acc.vaId === vaId) || [];
            const usedGmailIds = [];
            
            // Get all used Gmail IDs except the current one
            data.vas.forEach(v => {
                v.creators.forEach(c => {
                    c.accounts.forEach((a, idx) => {
                        if (a.gmailId && !(v.id === vaId && c.id === creatorId && idx === accountIndex)) {
                            usedGmailIds.push(a.gmailId);
                        }
                    });
                });
            });
            
            // Available Gmail accounts = VA's Gmail accounts - used (except current)
            const availableGmailAccounts = vaGmailAccounts.filter(acc => 
                !usedGmailIds.includes(acc.id) || acc.id === account.gmailId
            );
            
            const gmailSelect = document.getElementById('edit-gmail-select');
            gmailSelect.innerHTML = '<option value="">-- Aucun compte Gmail --</option>';
            
            availableGmailAccounts.forEach(gmail => {
                const option = document.createElement('option');
                option.value = gmail.id;
                option.textContent = gmail.email;
                if (gmail.id === account.gmailId) {
                    option.selected = true;
                }
                gmailSelect.appendChild(option);
            });
            
            // Add event listener for Gmail select in edit modal
            gmailSelect.addEventListener('change', function() {
                const editManualEmailGroup = document.getElementById('edit-manual-email-group');
                if (this.value === '') {
                    editManualEmailGroup.style.display = 'block';
                } else {
                    editManualEmailGroup.style.display = 'none';
                    document.getElementById('edit-email').value = '';
                }
            });
            
            // Close the view modal and open edit modal
            closeModal();
            document.getElementById('edit-account-modal').classList.add('show');
        }
        
        // Update Twitter account
        function updateAccount(e) {
            e.preventDefault();
            
            const vaId = document.getElementById('edit-account-va-id').value;
            const creatorId = document.getElementById('edit-account-creator-id').value;
            const accountIndex = parseInt(document.getElementById('edit-account-index').value);
            const gmailId = document.getElementById('edit-gmail-select').value;
            const username = document.getElementById('edit-username').value.trim();
            const password = document.getElementById('edit-password').value.trim();
            const manualEmail = document.getElementById('edit-email').value.trim();
            
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            const creator = va.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const account = creator.accounts[accountIndex];
            if (!account) return;
            
            // Update account
            account.username = username.startsWith('@') ? username : '@' + username;
            account.gmailId = gmailId || null;
            
            // Update email based on Gmail selection or manual input
            if (gmailId) {
                const gmailAccount = data.gmailAccounts?.find(g => g.id === gmailId);
                if (gmailAccount) {
                    account.email = gmailAccount.email;
                }
            } else {
                account.email = manualEmail;
            }
            
            // Only update password if provided
            if (password) {
                account.password = password;
            }
            
            saveData();
            closeEditModal();
            showSuccess('Compte Twitter mis  jour');
            updateVAGrid();
            updateGmailAccountsDisplay();
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-account-modal').classList.remove('show');
        }
        
        // Delete Twitter account - SUPABASE VERSION
        async function deleteAccount(vaId, creatorId, accountIndex) {
            if (confirm('tes-vous sr de vouloir supprimer ce compte Twitter ?')) {
                const va = data.vas.find(v => v.id === vaId);
                if (!va) return;

                const creator = va.creators.find(c => c.id === creatorId);
                if (!creator) return;

                try {
                    // Obtenir l'account avant de le supprimer pour nettoyer les rfrences
                    const account = creator.accounts[accountIndex];

                    // Find the account ID from twitterAccounts
                    const twitterAccount = data.twitterAccounts.find(ta =>
                        ta.username === account.username && ta.creatorId === creatorId
                    );

                    if (twitterAccount) {
                        // Delete from Supabase
                        await window.deleteTwitterAccount(twitterAccount.id);

                        // Remove from twitterAccounts array
                        data.twitterAccounts = data.twitterAccounts.filter(ta => ta.id !== twitterAccount.id);
                    }

                    if (account && account.gmailId) {
                        // Nettoyer la rfrence bidirectionnelle dans le Gmail
                        const gmail = data.gmailAccounts.find(g => g.id === account.gmailId);
                        if (gmail) {
                            delete gmail.assignedTwitter;
                            delete gmail.assignedTwitterUsername;
                            delete gmail.assignedCreatorId;
                        }
                    }

                    creator.accounts.splice(accountIndex, 1);
                    closeModal();
                    showSuccess('Compte Twitter supprim');
                    updateVAGrid();
                    updateGmailAccountsDisplay();
                } catch (error) {
                    console.error('Error deleting Twitter account:', error);
                    showError('Erreur lors de la suppression du compte');
                }
            }
        }

        // View creator details
        function viewCreator(vaId, creatorId) {
            // Utiliser la nouvelle structure
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            // Trouver le VA si spcifi
            let vaName = 'Non assign';
            if (vaId) {
                const va = data.vas.find(v => v.id === vaId);
                if (va) vaName = va.name;
            }

            // Filtrer les comptes pour ce VA spcifique
            const filteredAccounts = creator.accounts ? creator.accounts.filter(account => {
                // Si la cratrice n'a qu'un seul VA, afficher tous ses comptes
                if (creator.vaIds && creator.vaIds.length === 1) {
                    return true;
                }
                // Si la cratrice a plusieurs VAs, n'afficher que les comptes assigns  CE VA
                return account.assignedVaId === vaId;
            }) : [];
            
            let content = `
                <h4> VA: ${vaName}</h4>
                <h4> Cratrice: ${creator.name}</h4>
                <h4 style="margin-top: 1rem;">Comptes Twitter (${filteredAccounts.length}):</h4>
            `;

            if (filteredAccounts.length > 0) {
                filteredAccounts.forEach((account) => {
                    // Trouver l'index rel dans la liste complte pour les actions
                    const realIndex = creator.accounts.findIndex(acc => acc === account);
                    const gmailAccount = data.gmailAccounts?.find(g => g.id === account.gmailId);
                    content += `
                        <div style="background: #f8fafc; padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem;">
                            <p><strong>Username:</strong> ${account.username}</p>
                            <p><strong>Mot de passe:</strong> </p>
                            <p><strong>Gmail associ:</strong> ${gmailAccount ? gmailAccount.email : 'Non dfini'}</p>
                            <p><strong>Cr le:</strong> ${account.created || '-'}</p>
                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${vaId && creator.vaIds && creator.vaIds.length > 1 ? `
                                    <button class="action-btn" onclick="closeModal(); removeAccountFromVA('${vaId}', '${creatorId}', '${account.username}')" 
                                            style="background: #f59e0b;" title="Retirer de ce VA">
                                        <i class="fas fa-unlink"></i> Retirer
                                    </button>
                                ` : ''}
                                ${vaId ? `
                                    <button class="action-btn" onclick="closeModal(); showTransferAccountModal('${vaId}', '${creatorId}', '${account.username}')" 
                                            style="background: #8b5cf6;" title="Transfrer vers un autre VA">
                                        <i class="fas fa-exchange-alt"></i> Transfrer
                                    </button>
                                ` : ''}
                                <button class="action-btn" onclick="editAccount('${creatorId}', ${realIndex})" style="background: #3b82f6;">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteAccount('${creatorId}', ${realIndex})">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        </div>
                    `;
                });
            } else {
                content += `<p style="color: #6b7280; padding: 1rem; text-align: center;">
                    ${creator.accounts && creator.accounts.length > 0 ? 
                        'Aucun compte assign spcifiquement  ce VA. Les comptes de cette cratrice sont sur d\'autres VAs.' : 
                        'Aucun compte Twitter'
                    }
                </p>`;
            }

            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('password-modal').classList.add('show');
        }

        // Close modal
        function closeModal() {
            document.getElementById('password-modal').classList.remove('show');
        }
        
        // Close Assign Gmail Modal
        function closeAssignGmailModal() {
            document.getElementById('assign-gmail-modal').classList.remove('show');
        }
        
        // Show Assign Gmail Modal
        function showAssignGmailModal(gmailId) {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;
            
            document.getElementById('assign-gmail-id').value = gmailId;
            document.getElementById('assign-gmail-email').textContent = gmail.email;
            
            // Update VA select
            const select = document.getElementById('assign-gmail-va-select');
            select.innerHTML = '<option value="">-- Choisir un VA --</option>' +
                data.vas.map(va => `<option value="${va.id}">${va.name}</option>`).join('');
            
            document.getElementById('assign-gmail-modal').classList.add('show');
        }
        
        // Assign Gmail to VA
        function assignGmailToVA(e) {
            e.preventDefault();
            
            const gmailId = document.getElementById('assign-gmail-id').value;
            const vaId = document.getElementById('assign-gmail-va-select').value;
            
            if (!vaId) {
                showError('Veuillez slectionner un VA');
                return;
            }
            
            // Find the Gmail account
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (gmail) {
                gmail.vaId = vaId;
                markDataModified();
                saveData();
                
                showSuccess('Gmail assign au VA avec succs');
                closeAssignGmailModal();
                updateGmailAccountsList();
            }
        }
        
        // Remove account from VA
        function removeAccountFromVA(vaId, creatorId, accountUsername) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator || !creator.vaIds || creator.vaIds.length <= 1) return;
            
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            // Si la cratrice a plusieurs comptes, demander lequel retirer
            if (creator.accounts && creator.accounts.length > 1) {
                showRemoveAccountModal(vaId, creatorId);
            } else {
                // Si un seul compte, retirer toute la cratrice
                if (confirm(`Retirer ${creator.name} (${accountUsername}) du VA "${va.name}" ?`)) {
                    const vaIndex = creator.vaIds.indexOf(vaId);
                    if (vaIndex > -1) {
                        creator.vaIds.splice(vaIndex, 1);
                        saveData();
                        updateDisplay();
                        showSuccess(`${creator.name} retire de ${va.name}`);
                    }
                }
            }
        }
        
        // Show modal to select which account to remove
        function showRemoveAccountModal(vaId, creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            const va = data.vas.find(v => v.id === vaId);
            if (!creator || !va) return;
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            let modalContent = `
                <h3 style="margin-bottom: 1rem; color: ${isDarkMode ? '#f9fafb' : '#1f2937'};">
                    Retirer un compte de ${va.name}
                </h3>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                    Quel compte de ${creator.name} voulez-vous retirer ?
                </p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${creator.accounts.map((account, index) => `
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; 
                                     background: ${isDarkMode ? '#374151' : '#f3f4f6'}; 
                                     border-radius: 0.5rem; cursor: pointer;
                                     border: 2px solid transparent;"
                               onmouseover="this.style.borderColor='#f59e0b'"
                               onmouseout="this.style.borderColor='transparent'">
                            <input type="radio" name="accountToRemove" value="${index}" style="cursor: pointer;">
                            <span>
                                <i class="fab fa-twitter" style="color: #1da1f2;"></i> ${account.username}
                            </span>
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                    <button onclick="confirmRemoveSpecificAccount('${vaId}', '${creatorId}')" class="submit-btn" style="background: #f59e0b;">
                        <i class="fas fa-unlink"></i> Retirer
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Confirm remove specific account
        function confirmRemoveSpecificAccount(vaId, creatorId) {
            const selectedAccount = document.querySelector('input[name="accountToRemove"]:checked');
            if (!selectedAccount) {
                showError('Veuillez slectionner un compte  retirer');
                return;
            }
            
            const accountIndex = parseInt(selectedAccount.value);
            const creator = data.creators.find(c => c.id === creatorId);
            const va = data.vas.find(v => v.id === vaId);
            
            if (!creator || !va || !creator.accounts[accountIndex]) return;
            
            const accountToRemove = creator.accounts[accountIndex];
            
            // IMPORTANT: Ne pas supprimer le compte, juste le dsassigner du VA
            // Retirer le VA de la liste des VAs de la cratrice
            const vaIndex = creator.vaIds.indexOf(vaId);
            if (vaIndex > -1) {
                creator.vaIds.splice(vaIndex, 1);
            }
            
            // Si la cratrice n'a qu'un seul compte
            if (creator.accounts.length === 1) {
                showSuccess(`${creator.name} (@${accountToRemove.username}) retir de ${va.name} - Compte maintenant non assign`);
            } else {
                // Si la cratrice a plusieurs comptes, on doit crer une copie spare
                // pour les autres comptes qui restent avec le VA
                const accountsToKeepWithVA = creator.accounts.filter((_, idx) => idx !== accountIndex);
                const accountToMakeUnassigned = creator.accounts[accountIndex];
                
                // Crer une nouvelle cratrice pour le compte  dsassigner
                const newCreatorForUnassigned = {
                    id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: creator.name,
                    vaIds: [], // Pas de VA assign
                    accounts: [accountToMakeUnassigned]
                };
                
                // Mettre  jour la cratrice existante avec les comptes restants
                creator.accounts = accountsToKeepWithVA;
                
                // Si plus aucun compte Twitter ne reste avec ce VA aprs, vrifier si on doit retirer le VA
                const hasTwitterLeft = creator.accounts.length > 0;
                const hasInstagram = creator.instagramAccounts && creator.instagramAccounts.length > 0;

                if (!hasTwitterLeft && !hasInstagram) {
                    const idx = creator.vaIds.indexOf(vaId);
                    if (idx > -1) {
                        creator.vaIds.splice(idx, 1);
                    }
                }
                
                // Ajouter la nouvelle cratrice non assigne
                data.creators.push(newCreatorForUnassigned);
                
                showSuccess(`@${accountToMakeUnassigned.username} retir de ${va.name} - Compte maintenant disponible dans "Comptes Twitter Existants"`);
            }
            
            saveData();
            closeModal();
            updateDisplay();
        }
        
        // Unassign Twitter account from creator
        function unassignTwitterAccount(creatorId, accountIndex) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator || !creator.accounts || !creator.accounts[accountIndex]) {
                console.error('Compte non trouv');
                return;
            }
            
            const account = creator.accounts[accountIndex];
            
            // Confirmer l'action
            if (!confirm(`Voulez-vous retirer le compte ${account.username} ?\n\nIl sera retir de ${creator.name} et du VA.\nLe compte restera disponible pour tre rassign.`)) {
                return;
            }
            
            // Retirer de la cratrice
            creator.accounts.splice(accountIndex, 1);

            // Retirer la cratrice du VA seulement si elle n'a plus AUCUN compte (Twitter ET Instagram)
            const hasTwitter = creator.accounts && creator.accounts.length > 0;
            const hasInstagram = creator.instagramAccounts && creator.instagramAccounts.length > 0;

            if (!hasTwitter && !hasInstagram && creator.vaIds) {
                creator.vaIds = [];
            }
            
            // Ajouter aux comptes Twitter non assigns s'il n'y est pas dj
            const existsInTwitterAccounts = data.twitterAccounts.some(ta => 
                ta.username.toLowerCase() === account.username.toLowerCase()
            );
            
            if (!existsInTwitterAccounts) {
                data.twitterAccounts.push({
                    id: 'tw_' + Date.now(),
                    username: account.username,
                    password: account.password,
                    creatorId: null,
                    gmailId: null,
                    vaId: null,
                    created: new Date().toISOString()
                });
            } else {
                // Si le compte existe dj, mettre  jour ses associations
                const twitterAccount = data.twitterAccounts.find(ta => 
                    ta.username.toLowerCase() === account.username.toLowerCase()
                );
                if (twitterAccount) {
                    twitterAccount.creatorId = null;
                    twitterAccount.gmailId = null;
                    twitterAccount.vaId = null;
                }
            }
            
            // Dsassigner aussi le Gmail si ncessaire
            const gmailWithThisTwitter = data.gmailAccounts.find(g => 
                g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
            );
            if (gmailWithThisTwitter) {
                gmailWithThisTwitter.assignedTwitterUsername = null;
                gmailWithThisTwitter.vaId = null;
            }
            
            // Si la cratrice n'a plus de comptes (Twitter ET Instagram) et n'est associe  aucun VA, proposer de la supprimer
            const hasTwitterAccounts = creator.accounts && creator.accounts.length > 0;
            const hasInstagramAccounts = creator.instagramAccounts && creator.instagramAccounts.length > 0;
            const hasAnyAccounts = hasTwitterAccounts || hasInstagramAccounts;

            if (!hasAnyAccounts && (!creator.vaIds || creator.vaIds.length === 0)) {
                if (confirm(`${creator.name} n'a plus aucun compte (Twitter ou Instagram). Voulez-vous supprimer la cratrice ?`)) {
                    data.creators = data.creators.filter(c => c.id !== creatorId);
                }
            }
            
            // Sauvegarder et mettre  jour
            saveData();
            updateDisplay();
            updateTwitterAccountsList();
            showSuccess(`Compte ${account.username} retir de ${creator.name} - Maintenant disponible dans "Ajouter Compte"`);
        }
        
        // Show reassign modal
        function showReassignModal(accountId) {
            const account = data.twitterAccounts.find(a => a.id === accountId);
            if (!account) return;
            
            // Remplir le formulaire
            document.getElementById('reassign-account-id').value = accountId;
            document.getElementById('reassign-username').value = account.username;
            
            // Remplir les selects
            const creatorSelect = document.getElementById('reassign-creator');
            const gmailSelect = document.getElementById('reassign-gmail');
            const vaSelect = document.getElementById('reassign-va');
            
            // Cratrices
            creatorSelect.innerHTML = '<option value="">Slectionner une cratrice</option>';
            data.creators.forEach(creator => {
                const option = document.createElement('option');
                option.value = creator.id;
                option.textContent = creator.name;
                creatorSelect.appendChild(option);
            });
            
            // Afficher TOUS les Gmail
            gmailSelect.innerHTML = '<option value="">Slectionner un compte Gmail</option>';
            data.gmailAccounts.forEach(gmail => {
                const option = document.createElement('option');
                option.value = gmail.id;
                option.textContent = gmail.email;
                // Ajouter une indication si dj assign
                if (gmail.assignedTwitterUsername) {
                    option.textContent += ` (assign  ${gmail.assignedTwitterUsername})`;
                }
                gmailSelect.appendChild(option);
            });
            
            // VAs
            vaSelect.innerHTML = '<option value="">Slectionner un VA</option>';
            data.vas.forEach(va => {
                const option = document.createElement('option');
                option.value = va.id;
                option.textContent = va.name;
                vaSelect.appendChild(option);
            });
            
            // Afficher la modal
            document.getElementById('reassign-modal').classList.add('show');
        }
        
        // Reassign Twitter account
        function reassignTwitterAccount(e) {
            e.preventDefault();
            
            const accountId = document.getElementById('reassign-account-id').value;
            const creatorId = document.getElementById('reassign-creator').value;
            const gmailId = document.getElementById('reassign-gmail').value;
            const vaId = document.getElementById('reassign-va').value;
            
            const account = data.twitterAccounts.find(a => a.id === accountId);
            const creator = data.creators.find(c => c.id === creatorId);
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            const va = data.vas.find(v => v.id === vaId);
            
            if (!account || !creator || !gmail || !va) {
                showError('Veuillez slectionner tous les lments');
                return;
            }
            
            // Ajouter le compte  la cratrice
            if (!creator.accounts) creator.accounts = [];
            creator.accounts.push({
                username: account.username,
                password: account.password
            });
            
            // Lier la cratrice au VA
            if (!creator.vaIds) creator.vaIds = [];
            if (!creator.vaIds.includes(vaId)) {
                creator.vaIds.push(vaId);
            }
            
            // Assigner le Gmail au compte Twitter et au VA
            gmail.assignedTwitterUsername = account.username;
            gmail.vaId = vaId;
            
            // Mettre  jour le compte Twitter
            account.creatorId = creatorId;
            account.gmailId = gmailId;
            account.vaId = vaId;
            
            // Sauvegarder et fermer
            saveData();
            closeModal();
            updateDisplay();
            updateTwitterAccountsList();
            
            showSuccess(`${account.username} rassign  ${creator.name} avec ${gmail.email} sur le VA ${va.name}`);
        }
        
        // Delete Twitter account permanently - UI Handler
        async function handleDeleteTwitterAccount(accountId) {
            console.log(' DELETE Twitter - accountId:', accountId);
            console.log('  - data.twitterAccounts AVANT:', data.twitterAccounts);

            const account = data.twitterAccounts.find(a => a.id === accountId);
            if (!account) {
                console.error(' Compte introuvable avec ID:', accountId);
                showError('Compte introuvable');
                return;
            }

            if (confirm(`Voulez-vous vraiment supprimer dfinitivement le compte ${account.username} ?\n\nCette action est irrversible.`)) {
                try {
                    console.log('   Appel de window.deleteTwitterAccount()...');

                    // Vrifier que la fonction Supabase existe
                    if (typeof window.deleteTwitterAccount !== 'function') {
                        throw new Error('La fonction Supabase deleteTwitterAccount n\'existe pas');
                    }

                    // Supprimer de Supabase
                    await window.deleteTwitterAccount(accountId);
                    console.log('   Supprim de Supabase');

                    // Supprimer du tableau local
                    const beforeLength = data.twitterAccounts.length;
                    data.twitterAccounts = data.twitterAccounts.filter(a => a.id !== accountId);
                    const afterLength = data.twitterAccounts.length;
                    console.log('   Supprim du tableau local (', beforeLength, '', afterLength, ')');

                    // Supprimer des cratrices (comptes Twitter seulement)
                    if (data.creators) {
                        data.creators.forEach(creator => {
                            if (creator.accounts) {
                                const before = creator.accounts.length;
                                creator.accounts = creator.accounts.filter(a =>
                                    a.id !== accountId && a.username !== account.username
                                );
                                const after = creator.accounts.length;
                                if (before !== after) {
                                    console.log('   Supprim de la cratrice', creator.name, '(', before, '', after, ')');

                                    // NE PAS toucher aux comptes Instagram !
                                    const instagramCount = creator.instagramAccounts?.length || 0;
                                    console.log('   La cratrice a encore', instagramCount, 'comptes Instagram');
                                }
                            }
                        });
                    }

                    console.log('  - data.twitterAccounts APRS:', data.twitterAccounts);
                    console.log('   Mise  jour de l\'affichage...');
                    updateTwitterAccountsList();
                    updateDisplay(); // Mettre  jour le dashboard
                    saveData(); // Sync to VA Dashboard
                    showSuccess(`Compte ${account.username} supprim dfinitivement`);
                    console.log('   Suppression termine');
                } catch (error) {
                    console.error(' Error deleting Twitter account:', error);
                    showError('Erreur lors de la suppression du compte Twitter');
                }
            }
        }
        
        // Analyze Twitter accounts before migration
        function analyzeTwitterAccounts() {
            console.log(' ANALYSE DES COMPTES TWITTER');
            console.log('================================');
            
            const accountsInCreators = [];
            const accountsInSimple = [];
            
            // 1. Collecter les comptes des cratrices
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        creator.accounts.forEach(account => {
                            accountsInCreators.push({
                                username: account.username,
                                password: account.password,
                                creator: creator.name,
                                creatorId: creator.id,
                                vaIds: creator.vaIds || []
                            });
                        });
                    }
                });
            }
            
            // 2. Collecter les comptes simples
            if (data.twitterAccounts) {
                data.twitterAccounts.forEach(account => {
                    accountsInSimple.push({
                        username: account.username,
                        id: account.id,
                        creatorId: account.creatorId,
                        gmailId: account.gmailId,
                        vaId: account.vaId
                    });
                });
            }
            
            console.log(`\n Comptes dans les CRATRICES: ${accountsInCreators.length}`);
            accountsInCreators.forEach(acc => {
                const gmail = data.gmailAccounts.find(g => 
                    g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === acc.username.toLowerCase()
                );
                console.log(`  - ${acc.username} (Cratrice: ${acc.creator}, Gmail: ${gmail ? gmail.email : 'Aucun'})`);
            });
            
            console.log(`\n Comptes SIMPLES: ${accountsInSimple.length}`);
            accountsInSimple.forEach(acc => {
                const creator = acc.creatorId ? data.creators.find(c => c.id === acc.creatorId) : null;
                const gmail = acc.gmailId ? data.gmailAccounts.find(g => g.id === acc.gmailId) : null;
                console.log(`  - ${acc.username} (ID: ${acc.id}, Cratrice: ${creator ? creator.name : 'Aucune'}, Gmail: ${gmail ? gmail.email : 'Aucun'})`);
            });
            
            // 3. Trouver les doublons
            const duplicates = [];
            accountsInCreators.forEach(creatorAcc => {
                const simpleAcc = accountsInSimple.find(sa => 
                    sa.username.toLowerCase() === creatorAcc.username.toLowerCase()
                );
                if (simpleAcc) {
                    duplicates.push(creatorAcc.username);
                }
            });
            
            if (duplicates.length > 0) {
                console.log(`\n DOUBLONS trouvs: ${duplicates.length}`);
                duplicates.forEach(dup => console.log(`  - ${dup}`));
            }
            
            // 4. Comptes uniques dans les cratrices ( migrer)
            const uniqueInCreators = accountsInCreators.filter(acc => 
                !accountsInSimple.some(sa => sa.username.toLowerCase() === acc.username.toLowerCase())
            );
            
            console.log(`\n Comptes UNIQUES dans les cratrices ( migrer): ${uniqueInCreators.length}`);
            uniqueInCreators.forEach(acc => console.log(`  - ${acc.username}`));
            
            console.log('\n RSUM:');
            console.log(`  - Total unique: ${accountsInSimple.length + uniqueInCreators.length}`);
            console.log(`  -  migrer: ${uniqueInCreators.length}`);
            console.log(`  - Doublons: ${duplicates.length}`);
            
            return {
                inCreators: accountsInCreators,
                inSimple: accountsInSimple,
                duplicates: duplicates,
                toMigrate: uniqueInCreators
            };
        }
        
        // Migrate all Twitter accounts to simple system
        function migrateTwitterAccountsToSimple() {
            const analysis = analyzeTwitterAccounts();
            
            if (analysis.toMigrate.length === 0) {
                console.log(' Aucun compte  migrer !');
                return;
            }
            
            console.log('\n DBUT DE LA MIGRATION...');
            let migrated = 0;
            
            analysis.toMigrate.forEach(account => {
                // Trouver le Gmail associ
                const gmail = data.gmailAccounts.find(g => 
                    g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                );
                
                // Crer le compte simple
                const newAccount = {
                    id: 'tw_migrated_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    username: account.username,
                    password: account.password,
                    creatorId: account.creatorId,
                    gmailId: gmail ? gmail.id : null,
                    vaId: account.vaIds && account.vaIds.length > 0 ? account.vaIds[0] : null,
                    created: new Date().toISOString(),
                    migratedFrom: 'creator'
                };
                
                data.twitterAccounts.push(newAccount);
                migrated++;
                console.log(`   Migr: ${account.username}`);
            });
            
            console.log(`\n MIGRATION TERMINE: ${migrated} comptes migrs`);
            console.log('\n Nettoyage des comptes dans les cratrices...');
            
            // Supprimer les comptes des cratrices
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        creator.accounts = [];
                        console.log(`   Comptes supprims de: ${creator.name}`);
                    }
                });
            }
            
            // Sauvegarder
            saveData();
            updateDisplay();
            updateTwitterAccountsList();
            
            console.log('\n TERMIN ! Tous les comptes sont maintenant dans le systme simple.');
            
            // Nouvelle analyse pour vrifier
            console.log('\n VRIFICATION APRS MIGRATION:');
            const afterAnalysis = analyzeTwitterAccounts();
            
            return {
                migrated: migrated,
                beforeTotal: analysis.inCreators.length + analysis.inSimple.length,
                afterTotal: afterAnalysis.inSimple.length
            };
        }
        
        // Analyze specific Gmail account
        function analyzeGmailAccount(email) {
            console.log(`\n ANALYSE DU COMPTE GMAIL: ${email}`);
            console.log('================================');
            
            const gmail = data.gmailAccounts.find(g => g.email.toLowerCase() === email.toLowerCase());
            
            if (!gmail) {
                console.log(' Compte Gmail non trouv !');
                return;
            }
            
            console.log('\n Informations du compte Gmail:');
            console.log(`  - ID: ${gmail.id}`);
            console.log(`  - Email: ${gmail.email}`);
            console.log(`  - Mot de passe: ${gmail.password ? '[masqu]' : 'Aucun'}`);
            console.log(`  - Twitter assign: ${gmail.assignedTwitterUsername || 'Aucun'}`);
            console.log(`  - VA ID: ${gmail.vaId || 'Aucun'}`);
            
            if (gmail.vaId) {
                const va = data.vas.find(v => v.id === gmail.vaId);
                console.log(`  - VA Nom: ${va ? va.name : 'VA non trouv!'}`);
            }
            
            // Vrifier si le compte Twitter existe
            if (gmail.assignedTwitterUsername) {
                console.log(`\n Recherche du compte Twitter "${gmail.assignedTwitterUsername}"...`);
                
                // Dans les comptes simples
                const simpleTwitter = data.twitterAccounts.find(t => 
                    t.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase()
                );
                
                if (simpleTwitter) {
                    console.log('   Trouv dans les comptes simples');
                    console.log(`     - ID: ${simpleTwitter.id}`);
                    console.log(`     - Cratrice ID: ${simpleTwitter.creatorId || 'Aucune'}`);
                } else {
                    console.log('   PAS trouv dans les comptes simples !');
                }
                
                // Dans les cratrices (ancien systme)
                let foundInCreator = false;
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.accounts.length > 0) {
                        const account = creator.accounts.find(a => 
                            a.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase()
                        );
                        if (account) {
                            foundInCreator = true;
                            console.log(`   Trouv dans la cratrice "${creator.name}" (ancien systme)`);
                        }
                    }
                });
                
                if (!simpleTwitter && !foundInCreator) {
                    console.log('\n PROBLME: Ce compte Twitter est assign au Gmail mais n\'existe nulle part !');
                    console.log('   C\'est une rfrence fantme qui doit tre nettoye');
                }
            }
            
            console.log('\n Rsum:');
            if (gmail.assignedTwitterUsername && !data.twitterAccounts.find(t => t.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase())) {
                console.log('   RFRENCE FANTME dtecte !');
                console.log('   Le Gmail rfrence un compte Twitter qui n\'existe pas');
                console.log('   Solution: Dsassigner ce compte fantme');
            } else {
                console.log('   Associations correctes');
            }
            
            return gmail;
        }
        
        // Clean ghost reference for Gmail account
        function cleanGhostReference(email) {
            console.log(`\n NETTOYAGE DE LA RFRENCE FANTME POUR: ${email}`);
            console.log('==========================================');
            
            const gmail = data.gmailAccounts.find(g => g.email.toLowerCase() === email.toLowerCase());
            
            if (!gmail) {
                console.log(' Compte Gmail non trouv !');
                return false;
            }
            
            if (!gmail.assignedTwitterUsername) {
                console.log(' Ce compte Gmail n\'a pas de Twitter assign');
                return false;
            }
            
            console.log(`\n Compte trouv:`);
            console.log(`  - Email: ${gmail.email}`);
            console.log(`  - Twitter assign (fantme): ${gmail.assignedTwitterUsername}`);
            console.log(`  - VA: ${gmail.vaId || 'Aucun'}`);
            
            // Vrifier si le compte Twitter existe vraiment
            const twitterExists = data.twitterAccounts.find(t => 
                t.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase()
            );
            
            if (twitterExists) {
                console.log('\n Le compte Twitter existe ! Pas une rfrence fantme.');
                return false;
            }
            
            // Nettoyer la rfrence fantme
            console.log('\n Suppression de la rfrence fantme...');
            gmail.assignedTwitterUsername = null;
            
            // Si le Gmail n'a plus de Twitter assign et pas de VA, on peut le considrer comme non assign
            if (!gmail.vaId) {
                console.log('   Gmail maintenant compltement non assign');
            }
            
            saveData();
            updateDisplay();
            updateGmailAccountsList();
            
            console.log('\n Rfrence fantme nettoye !');
            console.log('   Le compte Gmail n\'est plus li au Twitter inexistant');
            
            return true;
        }
        
        // Clean all ghost references
        function cleanAllGhostReferences() {
            console.log('\n NETTOYAGE DE TOUTES LES RFRENCES FANTMES');
            console.log('==============================================');
            
            let cleaned = 0;
            
            data.gmailAccounts.forEach(gmail => {
                if (gmail.assignedTwitterUsername) {
                    // Vrifier si le compte Twitter existe
                    const twitterExists = data.twitterAccounts.find(t => 
                        t.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase()
                    );
                    
                    if (!twitterExists) {
                        console.log(`\n Rfrence fantme trouve:`);
                        console.log(`  - Gmail: ${gmail.email}`);
                        console.log(`  - Twitter fantme: ${gmail.assignedTwitterUsername}`);
                        
                        // Nettoyer
                        gmail.assignedTwitterUsername = null;
                        cleaned++;
                        
                        console.log(`   Nettoy !`);
                    }
                }
            });
            
            if (cleaned > 0) {
                saveData();
                updateDisplay();
                updateGmailAccountsList();
                console.log(`\n TERMIN ! ${cleaned} rfrence(s) fantme(s) nettoye(s)`);
            } else {
                console.log('\n Aucune rfrence fantme trouve');
            }
            
            return cleaned;
        }
        
        // Check for shared references between creators
        function checkSharedReferences() {
            console.log('\n Vrification des rfrences partages entre cratrices');
            console.log('================================================');
            
            const accountRefs = new Map();
            
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        if (!accountRefs.has(account)) {
                            accountRefs.set(account, []);
                        }
                        accountRefs.get(account).push(creator);
                    });
                }
            });
            
            let sharedFound = false;
            accountRefs.forEach((creators, account) => {
                if (creators.length > 1) {
                    sharedFound = true;
                    console.log(`\n RFRENCE PARTAGE DTECTE!`);
                    console.log(`  Compte: ${account.username} (ID: ${account.id})`);
                    console.log(`  Partag entre:`);
                    creators.forEach(creator => {
                        console.log(`    - ${creator.name} (ID: ${creator.id})`);
                    });
                }
            });
            
            if (!sharedFound) {
                console.log(' Aucune rfrence partage trouve');
            }
            
            return sharedFound;
        }
        
        // Fix shared references by creating copies
        function fixSharedReferences() {
            console.log('\n Correction des rfrences partages...');
            
            const accountRefs = new Map();
            
            // Identifier les rfrences partages
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach((account, index) => {
                        if (!accountRefs.has(account)) {
                            accountRefs.set(account, []);
                        }
                        accountRefs.get(account).push({creator, index});
                    });
                }
            });
            
            let fixed = 0;
            accountRefs.forEach((refs, account) => {
                if (refs.length > 1) {
                    console.log(`\n Correction pour ${account.username}...`);
                    
                    // Garder la premire rfrence, copier pour les autres
                    refs.slice(1).forEach(ref => {
                        const copy = {
                            ...account,
                            id: 'tw_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_copy'
                        };
                        ref.creator.accounts[ref.index] = copy;
                        console.log(`   Copie cre pour ${ref.creator.name}`);
                        fixed++;
                    });
                }
            });
            
            if (fixed > 0) {
                saveData();
                console.log(`\n ${fixed} rfrence(s) corrige(s)`);
            }
            
            return fixed;
        }
        
        // Expose to console
        window.analyzeTwitterAccounts = analyzeTwitterAccounts;
        window.migrateTwitterAccounts = migrateTwitterAccountsToSimple;
        window.analyzeGmailAccount = analyzeGmailAccount;
        window.cleanGhostReference = cleanGhostReference;
        window.cleanAllGhostReferences = cleanAllGhostReferences;
        window.checkSharedReferences = checkSharedReferences;
        window.fixSharedReferences = fixSharedReferences;
        
        // Synchroniser les gmailId entre data.twitterAccounts et creator.accounts
        function syncGmailIds() {
            console.log('\n SYNCHRONISATION DES GMAIL IDs');
            console.log('=====================================');
            
            let synced = 0;
            
            // Parcourir data.twitterAccounts
            if (data.twitterAccounts) {
                data.twitterAccounts.forEach(twitterAccount => {
                    // Si ce compte n'a pas de gmailId
                    if (!twitterAccount.gmailId || twitterAccount.gmailId === null) {
                        // Chercher le mme compte dans creator.accounts
                        let foundGmailId = null;
                        
                        data.creators.forEach(creator => {
                            if (creator.accounts) {
                                const creatorAccount = creator.accounts.find(a => 
                                    a.username.toLowerCase() === twitterAccount.username.toLowerCase()
                                );
                                if (creatorAccount && creatorAccount.gmailId) {
                                    foundGmailId = creatorAccount.gmailId;
                                }
                            }
                        });
                        
                        if (foundGmailId) {
                            console.log(`\n Synchronisation de ${twitterAccount.username}:`);
                            console.log(`  - Ancien gmailId: ${twitterAccount.gmailId || 'null'}`);
                            console.log(`  - Nouveau gmailId: ${foundGmailId}`);
                            
                            // Vrifier que le Gmail existe
                            const gmail = data.gmailAccounts.find(g => g.id === foundGmailId);
                            if (gmail) {
                                console.log(`  - Gmail trouv: ${gmail.email}`);
                                twitterAccount.gmailId = foundGmailId;
                                synced++;
                            }
                        }
                    }
                });
            }
            
            // Dans l'autre sens : synchroniser de twitterAccounts vers creator.accounts
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        if (!account.gmailId) {
                            const twitterAccount = data.twitterAccounts?.find(ta => 
                                ta.username.toLowerCase() === account.username.toLowerCase()
                            );
                            if (twitterAccount && twitterAccount.gmailId) {
                                console.log(`\n Synchronisation inverse de ${account.username}:`);
                                console.log(`  - Ajout du gmailId: ${twitterAccount.gmailId}`);
                                account.gmailId = twitterAccount.gmailId;
                                synced++;
                            }
                        }
                    });
                }
            });
            
            if (synced > 0) {
                saveData();
                updateDisplay();
                updateTwitterAccountsList();
                console.log(`\n ${synced} gmailId(s) synchronis(s) avec succs!`);
            } else {
                console.log('\n Tous les gmailId sont dj synchroniss');
            }
            
            return synced;
        }
        
        window.syncGmailIds = syncGmailIds;
        
        // Auto-expose on load
        document.addEventListener('DOMContentLoaded', function() {
            window.analyzeTwitterAccounts = analyzeTwitterAccounts;
            window.migrateTwitterAccounts = migrateTwitterAccountsToSimple;
            window.analyzeGmailAccount = analyzeGmailAccount;
            window.cleanGhostReference = cleanGhostReference;
            window.cleanAllGhostReferences = cleanAllGhostReferences;
            window.checkSharedReferences = checkSharedReferences;
            window.fixSharedReferences = fixSharedReferences;
            window.syncGmailIds = syncGmailIds;
            console.log(' Fonctions d\'analyse disponibles dans la console:');
            console.log('  - analyzeTwitterAccounts() : analyser tous les comptes Twitter');
            console.log('  - migrateTwitterAccounts() : migrer vers le nouveau systme');
            console.log('  - analyzeGmailAccount("email@gmail.com") : analyser un compte Gmail');
            console.log('  - cleanGhostReference("email@gmail.com") : nettoyer une rfrence fantme');
            console.log('  - cleanAllGhostReferences() : nettoyer toutes les rfrences fantmes');
            console.log('  - checkSharedReferences() : vrifier les rfrences partages');
            console.log('  - fixSharedReferences() : corriger les rfrences partages');
            console.log('  - syncGmailIds() : synchroniser les gmailId entre les structures');
        });
        
        // Show transfer modal for Twitter account
        function showTransferModal(creatorId, accountIndex, currentVaId) {
            const creator = data.creators.find(c => c.id === creatorId);
            const account = creator?.accounts[accountIndex];
            if (!account) return;
            
            const currentVa = data.vas.find(v => v.id === currentVaId);
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            let modalContent = `
                <h3 style="margin-bottom: 1rem; color: ${isDarkMode ? '#f9fafb' : '#1f2937'};">
                    <i class="fas fa-exchange-alt"></i> Transfrer ${account.username}
                </h3>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                    Actuellement sur: <strong>${currentVa?.name || 'Non assign'}</strong>
                </p>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                    Vers quel VA voulez-vous transfrer ce compte ?
                </p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            `;
            
            // Lister tous les VAs sauf le current
            data.vas.forEach(va => {
                if (va.id !== currentVaId) {
                    modalContent += `
                        <button class="submit-btn" style="background: #3b82f6;"
                                onclick="executeTransfer('${creatorId}', ${accountIndex}, '${va.id}')">
                            <i class="fas fa-user"></i> ${va.name}
                        </button>
                    `;
                }
            });
            
            modalContent += `
                </div>
                <div style="margin-top: 1.5rem;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Execute transfer
        function executeTransfer(creatorId, accountIndex, newVaId) {
            const creator = data.creators.find(c => c.id === creatorId);
            const account = creator?.accounts[accountIndex];
            if (!account) return;
            
            const newVa = data.vas.find(v => v.id === newVaId);
            
            // Mettre  jour l'assignation
            account.assignedVaId = newVaId;
            
            // Mettre  jour aussi dans twitterAccounts si existe
            const twitterAccount = data.twitterAccounts.find(t => 
                t.username === account.username || t.id === account.id
            );
            if (twitterAccount) {
                twitterAccount.vaId = newVaId;
            }
            
            // S'assurer que la cratrice est associe au nouveau VA
            if (!creator.vaIds) creator.vaIds = [];
            if (!creator.vaIds.includes(newVaId)) {
                creator.vaIds.push(newVaId);
            }
            
            saveData();
            closeModal();
            showSuccess(`${account.username} transfr vers ${newVa?.name} !`);
        }
        
        // Show Twitter password
        function showTwitterPassword(username, obfuscatedPassword) {
            const password = deobfuscatePassword(obfuscatedPassword);
            const modalContent = `
                <h2 style="margin-bottom: 1.5rem;">Mot de passe Twitter</h2>
                <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <p style="margin-bottom: 0.5rem;"><strong>Compte:</strong> ${username}</p>
                    <p style="margin-bottom: 0;"><strong>Mot de passe:</strong> ${password}</p>
                </div>
                <button onclick="closeModal()" class="cancel-btn">Fermer</button>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Show assign to VA modal
        function showAssignToVAModal(creatorId, username) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const modalContent = `
                <h2 style="margin-bottom: 1.5rem;">Assigner ${username}  un VA</h2>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    ${data.vas.map(va => `
                        <button onclick="assignAccountToVA('${creatorId}', '${va.id}')" 
                                class="submit-btn" style="background: ${va.color || '#667eea'};">
                            <i class="fas fa-user-tie"></i> ${va.name}
                        </button>
                    `).join('')}
                </div>
                <button onclick="closeModal()" class="cancel-btn" style="margin-top: 1rem;">Annuler</button>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Assign account to VA
        function assignAccountToVA(creatorId, vaId) {
            const creator = data.creators.find(c => c.id === creatorId);
            const va = data.vas.find(v => v.id === vaId);
            
            if (!creator || !va) return;
            
            // Ajouter le VA  la cratrice
            if (!creator.vaIds) creator.vaIds = [];
            if (!creator.vaIds.includes(vaId)) {
                creator.vaIds.push(vaId);
            }
            
            saveData();
            closeModal();
            updateDisplay();
            showSuccess(`Compte assign  ${va.name} avec succs!`);
        }
        
        // Show assign Gmail modal
        function showAssignGmailModal(creatorId, username) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            // Trouver les Gmail disponibles
            const usedGmailIds = new Set();
            data.creators.forEach(c => {
                (c.accounts || []).forEach(acc => {
                    if (acc.gmailId) usedGmailIds.add(acc.gmailId);
                });
            });
            
            const availableGmails = (data.gmailAccounts || []).filter(g => !usedGmailIds.has(g.id));
            
            if (availableGmails.length === 0) {
                showError('Aucun compte Gmail disponible!');
                return;
            }
            
            const modalContent = `
                <h2 style="margin-bottom: 1.5rem;">Assigner un Gmail  ${username}</h2>
                <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 400px; overflow-y: auto;">
                    ${availableGmails.map(gmail => `
                        <button onclick="assignGmailToAccount('${creatorId}', '${username}', '${gmail.id}')" 
                                class="submit-btn" style="background: #ea4335;">
                            <i class="fas fa-envelope"></i> ${gmail.email}
                        </button>
                    `).join('')}
                </div>
                <button onclick="closeModal()" class="cancel-btn" style="margin-top: 1rem;">Annuler</button>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Assign Gmail to account
        function assignGmailToAccount(creatorId, username, gmailId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const account = creator.accounts.find(a => a.username === username);
            if (!account) return;
            
            account.gmailId = gmailId;
            
            saveData();
            closeModal();
            updateDisplay();
            showSuccess(`Gmail assign avec succs!`);
        }
        
        // Show transfer account modal
        function showTransferAccountModal(currentVaId, creatorId, accountUsername) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const currentVa = data.vas.find(v => v.id === currentVaId);
            if (!currentVa) return;
            
            // Crer la liste des VAs disponibles (sauf le VA actuel)
            const otherVAs = data.vas.filter(v => v.id !== currentVaId);
            
            if (otherVAs.length === 0) {
                showError('Aucun autre VA disponible pour le transfert');
                return;
            }
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            const modalContent = `
                <h3 style="margin-bottom: 1rem; color: ${isDarkMode ? '#f9fafb' : '#1f2937'};">Transfrer ${accountUsername}</h3>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                    Transfrer de <strong>${currentVa.name}</strong> vers :
                </p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem;">
                    ${otherVAs.map(va => `
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; 
                                     background: ${isDarkMode ? '#374151' : '#f3f4f6'}; 
                                     border-radius: 0.5rem; cursor: pointer;
                                     border: 2px solid transparent;
                                     transition: all 0.2s;"
                               onmouseover="this.style.borderColor='#3b82f6'"
                               onmouseout="this.style.borderColor='transparent'">
                            <input type="radio" name="targetVA" value="${va.id}" style="cursor: pointer;">
                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 12px; height: 12px; background: ${va.color || '#667eea'}; border-radius: 50%;"></span>
                                ${va.name}
                            </span>
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                    <button onclick="confirmTransferAccount('${currentVaId}', '${creatorId}', '${accountUsername}')" class="submit-btn">
                        <i class="fas fa-exchange-alt"></i> Transfrer
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Confirm transfer account
        function confirmTransferAccount(fromVaId, creatorId, accountUsername) {
            const selectedRadio = document.querySelector('input[name="targetVA"]:checked');
            if (!selectedRadio) {
                showError('Veuillez slectionner un VA de destination');
                return;
            }
            
            const toVaId = selectedRadio.value;
            const sourceCreator = data.creators.find(c => c.id === creatorId);
            
            if (!sourceCreator || !sourceCreator.accounts) return;
            
            // Trouver le compte spcifique  transfrer
            const accountIndex = sourceCreator.accounts.findIndex(a => a.username === accountUsername);
            if (accountIndex === -1) {
                showError('Compte non trouv');
                return;
            }
            
            const accountToTransfer = sourceCreator.accounts[accountIndex];
            
            // Si la cratrice a plusieurs comptes, on doit grer le transfert diffremment
            if (sourceCreator.accounts.length > 1) {
                // Retirer le compte de la cratrice source
                sourceCreator.accounts.splice(accountIndex, 1);
                
                // Chercher si une cratrice du mme nom existe dj
                let targetCreator = data.creators.find(c => 
                    c.name === sourceCreator.name && c.id !== sourceCreator.id
                );
                
                if (!targetCreator) {
                    // Crer une nouvelle instance de la cratrice pour le VA de destination
                    targetCreator = {
                        id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: sourceCreator.name,
                        vaIds: [toVaId],
                        accounts: []
                    };
                    data.creators.push(targetCreator);
                } else {
                    // Ajouter le nouveau VA  la cratrice existante
                    if (!targetCreator.vaIds) targetCreator.vaIds = [];
                    if (!targetCreator.vaIds.includes(toVaId)) {
                        targetCreator.vaIds.push(toVaId);
                    }
                }
                
                // Ajouter le compte  la cratrice cible
                targetCreator.accounts.push(accountToTransfer);
                
            } else {
                // Si c'est le seul compte, on transfre simplement la cratrice entire
                const fromIndex = sourceCreator.vaIds.indexOf(fromVaId);
                if (fromIndex > -1) {
                    sourceCreator.vaIds.splice(fromIndex, 1);
                }
                
                if (!sourceCreator.vaIds.includes(toVaId)) {
                    sourceCreator.vaIds.push(toVaId);
                }
            }
            
            const fromVa = data.vas.find(v => v.id === fromVaId);
            const toVa = data.vas.find(v => v.id === toVaId);
            
            saveData();
            closeModal();
            updateDisplay();
            
            showSuccess(`${accountUsername} transfr de ${fromVa.name} vers ${toVa.name}`);
        }
        
        // Show split creator modal
        function showSplitCreatorModal(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator || !creator.vaIds || creator.vaIds.length <= 1) return;
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Prparer les groupes pour chaque VA
            const vaGroups = {};
            creator.vaIds.forEach(vaId => {
                const va = data.vas.find(v => v.id === vaId);
                if (va) {
                    vaGroups[vaId] = {
                        va: va,
                        accounts: []
                    };
                }
            });
            
            let modalContent = `
                <h3 style="margin-bottom: 1rem; color: ${isDarkMode ? '#f9fafb' : '#1f2937'};">
                    Sparer "${creator.name}" par VA
                </h3>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'}; font-size: 0.875rem;">
                    Assignez chaque compte Twitter  un VA spcifique. Les comptes non assigns resteront avec le premier VA.
                </p>
            `;
            
            if (creator.accounts && creator.accounts.length > 0) {
                modalContent += '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                
                creator.accounts.forEach((account, index) => {
                    modalContent += `
                        <div style="border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'}; border-radius: 0.5rem; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: ${isDarkMode ? '#f3f4f6' : '#1f2937'};">
                                <i class="fab fa-twitter" style="color: #1da1f2;"></i> ${account.username}
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${creator.vaIds.map((vaId, i) => {
                                    const va = data.vas.find(v => v.id === vaId);
                                    return `
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; 
                                                     background: ${isDarkMode ? '#374151' : '#f3f4f6'}; 
                                                     border-radius: 0.25rem; cursor: pointer;">
                                            <input type="radio" name="account_${index}" value="${vaId}" 
                                                   ${i === 0 ? 'checked' : ''} style="cursor: pointer;">
                                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                <span style="width: 10px; height: 10px; background: ${va.color || '#667eea'}; 
                                                           border-radius: 50%;"></span>
                                                ${va.name}
                                            </span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                modalContent += '</div>';
            }
            
            modalContent += `
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                    <button onclick="confirmSplitCreator('${creatorId}')" class="submit-btn" style="background: #dc2626;">
                        <i class="fas fa-cut"></i> Sparer
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Confirm split creator
        function confirmSplitCreator(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            // Collecter les assignations
            const assignments = {};
            creator.vaIds.forEach(vaId => {
                assignments[vaId] = [];
            });
            
            // Parcourir chaque compte et voir o il est assign
            if (creator.accounts) {
                creator.accounts.forEach((account, index) => {
                    const selectedVa = document.querySelector(`input[name="account_${index}"]:checked`);
                    if (selectedVa) {
                        assignments[selectedVa.value].push(account);
                    }
                });
            }
            
            // Crer les nouvelles cratrices
            const newCreators = [];
            let firstCreator = true;
            
            Object.keys(assignments).forEach(vaId => {
                if (assignments[vaId].length > 0 || firstCreator) {
                    const newCreator = {
                        id: firstCreator ? creator.id : 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: creator.name,
                        vaIds: [vaId],
                        accounts: assignments[vaId]
                    };
                    newCreators.push(newCreator);
                    firstCreator = false;
                }
            });
            
            // Remplacer l'ancienne cratrice
            const originalIndex = data.creators.findIndex(c => c.id === creatorId);
            if (originalIndex > -1) {
                data.creators.splice(originalIndex, 1);
                
                // Ajouter les nouvelles cratrices
                newCreators.forEach(nc => {
                    data.creators.push(nc);
                });
                
                saveData();
                closeModal();
                updateDisplay();
                updateAllCreatorsTable();
                
                showSuccess(`"${creator.name}" spare en ${newCreators.length} cratrices distinctes`);
            }
        }
        
        // Assign VA to Creator
        function assignVAToCreator(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            // Crer une liste de checkboxes pour chaque VA
            let checkboxesHtml = '';
            data.vas.forEach(va => {
                const isChecked = creator.vaIds && creator.vaIds.includes(va.id);
                checkboxesHtml += `
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" 
                                   id="va-checkbox-${va.id}" 
                                   value="${va.id}" 
                                   ${isChecked ? 'checked' : ''}
                                   style="cursor: pointer;">
                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 12px; height: 12px; background: ${va.color || '#667eea'}; border-radius: 50%;"></span>
                                ${va.name}
                            </span>
                        </label>
                    </div>
                `;
            });
            
            const modalContent = `
                <h3 style="margin-bottom: 1rem;">Assigner des VAs  "${creator.name}"</h3>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    Slectionnez les VAs auxquels cette cratrice appartient :
                </p>
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    ${checkboxesHtml}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                    <button onclick="saveVAAssignment('${creatorId}')" class="submit-btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Save VA assignment
        function saveVAAssignment(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const selectedVAs = [];
            data.vas.forEach(va => {
                const checkbox = document.getElementById(`va-checkbox-${va.id}`);
                if (checkbox && checkbox.checked) {
                    selectedVAs.push(va.id);
                }
            });
            
            // Mettre  jour les vaIds de la cratrice
            creator.vaIds = selectedVAs;
            
            // Mettre  jour les creatorIds des VAs
            data.vas.forEach(va => {
                if (!va.creatorIds) va.creatorIds = [];
                
                if (selectedVAs.includes(va.id)) {
                    // Ajouter si pas dj prsent
                    if (!va.creatorIds.includes(creatorId)) {
                        va.creatorIds.push(creatorId);
                    }
                } else {
                    // Retirer si prsent
                    va.creatorIds = va.creatorIds.filter(id => id !== creatorId);
                }
            });
            
            saveData();
            closeModal();
            updateAllCreatorsTable();
            updateDisplay();
            showSuccess(`VAs assigns  "${creator.name}"`);
        }

        // Search
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (!searchTerm) {
                resultsDiv.innerHTML = '';
                return;
            }

            let results = [];

            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        if (va.name.toLowerCase().includes(searchTerm) ||
                            creator.name.toLowerCase().includes(searchTerm) ||
                            account.username.toLowerCase().includes(searchTerm) ||
                            account.email.toLowerCase().includes(searchTerm)) {
                            
                            results.push({
                                va: va.name,
                                creator: creator.name,
                                account: account
                            });
                        }
                    });
                });
            });

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="no-creator">Aucun rsultat trouv</div>';
                return;
            }

            resultsDiv.innerHTML = results.map(r => `
                <div class="creatrice-item">
                    <p><strong>VA:</strong> ${r.va} | <strong>Cratrice:</strong> ${r.creator}</p>
                    <p><strong>Compte:</strong> ${r.account.username} - ${r.account.email}</p>
                </div>
            `).join('');
        }

        // ==========================================
        // LOADING BUTTON UTILITIES
        // ==========================================

        // Set button to loading state
        function setButtonLoading(button, isLoading, originalText = null) {
            if (!button) return;

            if (isLoading) {
                // Save original content
                button.dataset.originalText = button.innerHTML;
                button.disabled = true;
                button.style.opacity = '0.7';
                button.style.cursor = 'wait';
                button.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Chargement...';
            } else {
                // Restore original content
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
                button.innerHTML = originalText || button.dataset.originalText || 'Termin';
            }
        }

        // Wrapper for async button actions with loading state
        async function withLoading(button, asyncAction) {
            const originalText = button ? button.innerHTML : null;
            try {
                setButtonLoading(button, true);
                await asyncAction();
            } catch (error) {
                console.error('Action failed:', error);
                showError(error.message || 'Une erreur est survenue');
            } finally {
                setButtonLoading(button, false, originalText);
            }
        }

        // ==========================================
        // CONFIRMATION MODAL UTILITY
        // ==========================================

        // Show a confirmation modal and return a promise
        function showConfirmModal(options) {
            return new Promise((resolve) => {
                const {
                    title = 'Confirmer la suppression',
                    message = 'tes-vous sr de vouloir supprimer cet lment ?',
                    details = [],
                    confirmText = 'Supprimer',
                    cancelText = 'Annuler',
                    isDanger = true
                } = options;

                const isDarkMode = document.body.classList.contains('dark-mode');

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'confirm-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 10001; animation: fadeIn 0.2s ease;';

                const detailsHtml = details.length > 0 ? `
                    <div style="background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)'}; border: 1px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.3)' : 'rgba(239, 68, 68, 0.2)'}; border-radius: 0.75rem; padding: 1rem; margin: 1rem 0; text-align: left;">
                        ${details.map(d => `<div style="display: flex; align-items: center; gap: 0.5rem; color: ${isDarkMode ? '#fca5a5' : '#dc2626'}; font-size: 0.875rem; margin-bottom: 0.25rem;"><i class="fas fa-exclamation-circle"></i> ${d}</div>`).join('')}
                    </div>
                ` : '';

                modal.innerHTML = `
                    <div style="background: ${isDarkMode ? '#1f2937' : 'white'}; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 25px 50px rgba(0,0,0,0.25); max-width: 450px; width: 90%; text-align: center; animation: slideUp 0.3s ease;">
                        <div style="width: 64px; height: 64px; background: ${isDanger ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 'linear-gradient(135deg, #f59e0b, #d97706)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 8px 20px ${isDanger ? 'rgba(239, 68, 68, 0.3)' : 'rgba(245, 158, 11, 0.3)'};">
                            <i class="fas fa-${isDanger ? 'trash-alt' : 'exclamation-triangle'}" style="color: white; font-size: 1.5rem;"></i>
                        </div>
                        <h2 style="margin: 0 0 0.75rem; font-size: 1.375rem; color: ${isDarkMode ? '#f3f4f6' : '#1f2937'}; font-weight: 700;">${title}</h2>
                        <p style="margin: 0; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; font-size: 0.9375rem; line-height: 1.5;">${message}</p>
                        ${detailsHtml}
                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center;">
                            <button id="confirm-modal-cancel" style="flex: 1; padding: 0.875rem 1.5rem; border-radius: 0.75rem; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'}; background: ${isDarkMode ? '#374151' : '#f3f4f6'}; color: ${isDarkMode ? '#f3f4f6' : '#1f2937'}; font-weight: 600; font-size: 0.9375rem; cursor: pointer; transition: all 0.2s;">
                                ${cancelText}
                            </button>
                            <button id="confirm-modal-confirm" style="flex: 1; padding: 0.875rem 1.5rem; border-radius: 0.75rem; border: none; background: ${isDanger ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 'linear-gradient(135deg, #f59e0b, #d97706)'}; color: white; font-weight: 600; font-size: 0.9375rem; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px ${isDanger ? 'rgba(239, 68, 68, 0.3)' : 'rgba(245, 158, 11, 0.3)'};">
                                <i class="fas fa-${isDanger ? 'trash-alt' : 'check'}" style="margin-right: 0.5rem;"></i>${confirmText}
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Handle buttons
                document.getElementById('confirm-modal-cancel').onclick = () => {
                    modal.remove();
                    resolve(false);
                };

                document.getElementById('confirm-modal-confirm').onclick = () => {
                    modal.remove();
                    resolve(true);
                };

                // Close on backdrop click
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                };

                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        resolve(false);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            document.getElementById('success-text').textContent = message;
            successDiv.classList.add('show');

            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 3000);
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                document.getElementById('error-text').textContent = message;
                errorDiv.classList.add('show');

                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 4000);
            } else {
                // Fallback si le div n'existe pas
                alert(' ' + message);
            }
        }

        function showInfo(message) {
            const successDiv = document.getElementById('success-message');
            if (successDiv) {
                document.getElementById('success-text').textContent = message;
                successDiv.classList.add('show');

                setTimeout(() => {
                    successDiv.classList.remove('show');
                }, 4000);
            } else {
                // Fallback si le div n'existe pas
                alert(' ' + message);
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + '-toggle');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Toggle password display in account lists
        function togglePasswordDisplay(elementId, password, button) {
            const element = document.getElementById(elementId);
            const icon = button.querySelector('i');

            console.log('togglePasswordDisplay called:', { elementId, password, element });

            if (!element) {
                console.error('Element not found:', elementId);
                return;
            }

            if (element.textContent.trim() === '') {
                // Le mot de passe est dj dchiffr par Supabase, l'afficher directement
                // Si vide, afficher un message
                const displayPassword = password || '(aucun mot de passe)';
                element.textContent = displayPassword;
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                element.textContent = '';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Copy password to clipboard
        function copyToClipboard(password, type) {
            // Le mot de passe est dj dchiffr par Supabase
            const decodedPassword = password || '';
            navigator.clipboard.writeText(decodedPassword).then(() => {
                showSuccess(`Mot de passe ${type === 'twitter' ? 'Twitter' : 'Instagram'} copi !`);
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = decodedPassword;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess(`Mot de passe ${type === 'twitter' ? 'Twitter' : 'Instagram'} copi !`);
            });
        }

        // CSV Import
        function setupDragAndDrop() {
            const area = document.getElementById('import-area');
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/csv') {
                    handleFile(file);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const dataMap = {};

            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',').map(p => p.trim());
                if (parts.length >= 5) {
                    const vaName = parts[0];
                    const creatorName = parts[1];
                    const username = parts[2];
                    const email = parts[3];
                    const password = parts[4];

                    // Create VA structure
                    if (!dataMap[vaName]) {
                        dataMap[vaName] = {
                            id: 'va_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                            name: vaName,
                            creators: {}
                        };
                    }

                    // Create creator structure
                    if (!dataMap[vaName].creators[creatorName]) {
                        dataMap[vaName].creators[creatorName] = {
                            id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                            name: creatorName,
                            accounts: []
                        };
                    }

                    // Add account
                    dataMap[vaName].creators[creatorName].accounts.push({
                        username: username.startsWith('@') ? username : '@' + username,
                        email: email,
                        password: password,
                        created: new Date().toISOString().split('T')[0]
                    });
                }
            }

            // Convert map to array structure
            let imported = 0;
            Object.values(dataMap).forEach(vaData => {
                let va = data.vas.find(v => v.name === vaData.name);
                
                if (!va) {
                    va = {
                        id: vaData.id,
                        name: vaData.name,
                        creators: []
                    };
                    data.vas.push(va);
                }

                Object.values(vaData.creators).forEach(creatorData => {
                    let creator = va.creators.find(c => c.name === creatorData.name);
                    
                    if (!creator) {
                        creator = {
                            id: creatorData.id,
                            name: creatorData.name,
                            accounts: []
                        };
                        va.creators.push(creator);
                    }

                    creator.accounts.push(...creatorData.accounts);
                    imported += creatorData.accounts.length;
                });
            });

            saveData();
            showSuccess(`Import russi! ${imported} comptes imports.`);
            navigateToPage('dashboard');
        }

        // Export data
        function exportData() {
            let csv = 'Prnom VA,Cratrice,@Twitter,Email,Mot de passe\n';
            
            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        csv += `${va.name},${creator.name},${account.username},${account.email},${account.password}\n`;
                    });
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'va_manager_export.csv';
            a.click();
        }

        // ========== SUBS COMPETITION FUNCTIONS ==========

        let currentPeriod = 'week';

        function setupSubsTracking() {
            // Period tabs
            document.querySelectorAll('.period-tab').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-tab').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.dataset.period;
                    updateCompetitionDisplay();
                });
            });
            
            // Add subs form submit event
            const addSubsForm = document.getElementById('add-subs-form');
            if (addSubsForm) {
                addSubsForm.addEventListener('submit', addSubsEntry);
            }
        }

        function updateCompetitionDisplay() {
            updateLeaderboard();
            updateCompetitionStats();
            updatePerformanceCharts();
            updateActivityFeed();
            updateSubsStats();
            updateSubsTable();
        }
        
        function updateSubsStats() {
            const allSubs = data.subs || [];
            const today = new Date().toISOString().split('T')[0];
            const todaySubs = allSubs.filter(s => s.date === today);
            
            const totalAmount = allSubs.reduce((sum, sub) => sum + sub.amount, 0);
            const totalToday = todaySubs.reduce((sum, sub) => sum + sub.count, 0);
            
            // Calculate paid amounts
            const totalPaidSubs = (data.vaPayments || [])
                .filter(p => p.type === 'subs' || p.type === 'both')
                .reduce((sum, p) => sum + (p.subsAmount || 0), 0);
            
            const totalRemaining = totalAmount - totalPaidSubs;
            
            // Find best VA
            const vaStats = {};
            allSubs.forEach(sub => {
                if (!vaStats[sub.vaId]) vaStats[sub.vaId] = 0;
                vaStats[sub.vaId] += sub.count;
            });
            
            let bestVaId = null;
            let maxSubs = 0;
            Object.entries(vaStats).forEach(([vaId, count]) => {
                if (count > maxSubs) {
                    maxSubs = count;
                    bestVaId = vaId;
                }
            });
            
            const bestVa = bestVaId ? data.vas.find(va => va.id === bestVaId) : null;
            
            // Update display
            document.getElementById('total-subs-week').textContent = allSubs.length;
            document.getElementById('total-subs-today').textContent = totalToday;
            document.getElementById('total-payment').textContent = totalAmount.toFixed(2) + '';
            document.getElementById('total-paid').textContent = totalPaidSubs.toFixed(2) + '';
            document.getElementById('total-remaining').textContent = totalRemaining.toFixed(2) + '';
            document.getElementById('best-va-name').textContent = bestVa ? bestVa.name : '-';
        }
        
        function updateSubsTable() {
            const container = document.getElementById('subs-history');
            if (!container) return;
            
            const allSubs = (data.subs || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allSubs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8;">Aucune entre de subs</p>';
                return;
            }
            
            let html = `
                <table class="subs-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>VA</th>
                            <th>Nombre</th>
                            <th>Montant</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allSubs.forEach(sub => {
                const va = data.vas.find(v => v.id === sub.vaId);
                const paidAmount = calculatePaidAmountForSub(sub);
                const isPaid = paidAmount >= sub.amount;
                const status = isPaid ? 
                    '<span style="color: #22c55e;"><i class="fas fa-check-circle"></i> Pay</span>' : 
                    '<span style="color: #ef4444;"><i class="fas fa-clock"></i> En attente</span>';
                
                html += `
                    <tr>
                        <td>${new Date(sub.date).toLocaleDateString('fr-FR')}</td>
                        <td>${va ? va.name : 'VA supprim'}</td>
                        <td>${sub.count}</td>
                        <td>${sub.amount.toFixed(2)}</td>
                        <td>${status}</td>
                        <td>
                            <button onclick="deleteSub('${sub.id}')" class="btn-icon" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function calculatePaidAmountForSub(sub) {
            // This is a simplified calculation - in reality you might want to track payments per sub
            const vaPayments = (data.vaPayments || [])
                .filter(p => p.vaId === sub.vaId && (p.type === 'subs' || p.type === 'both'));
            
            let totalPaid = 0;
            vaPayments.forEach(payment => {
                if (new Date(payment.date) >= new Date(sub.date)) {
                    totalPaid += payment.subsAmount || 0;
                }
            });
            
            return totalPaid;
        }

        function updateLeaderboard() {
            const container = document.getElementById('leaderboard-content');
            if (!container) return;
            
            // Calculate VA scores
            const vaScores = calculateVAScores();
            
            // Sort by score
            const sortedVAs = Object.entries(vaScores)
                .sort((a, b) => b[1].totalSubs - a[1].totalSubs)
                .slice(0, 10); // Top 10
            
            container.innerHTML = '';
            
            if (sortedVAs.length === 0) {
                container.innerHTML = `
                    <div style="padding: 3rem; text-align: center; color: #94a3b8;">
                        <i class="fas fa-trophy" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Aucune donne de comptition</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Commencez  ajouter des subs pour voir le classement!</p>
                    </div>
                `;
                return;
            }
            
            sortedVAs.forEach(([vaId, stats], index) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va) return;
                
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                const trend = stats.trend > 0 ? '' : stats.trend < 0 ? '' : '';
                const trendColor = stats.trend > 0 ? '#10b981' : stats.trend < 0 ? '#ef4444' : '#64748b';
                
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="rank-badge ${rankClass}">${index + 1}</div>
                    <div class="va-info">
                        <div class="va-name">${va.name}</div>
                        <div class="va-stats-mini">
                            <span>${stats.totalSubs} subs</span>
                            <span style="color: ${trendColor};">${trend} ${Math.abs(stats.trend)}%</span>
                        </div>
                    </div>
                    <div class="va-score">
                        <div class="score-value">${stats.amount.toFixed(2)}</div>
                        <div class="score-label"> payer</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function calculateVAScores() {
            const scores = {};
            const filteredSubs = getFilteredSubs();
            
            // Initialize scores for all VAs
            data.vas.forEach(va => {
                scores[va.id] = { totalSubs: 0, amount: 0, trend: 0 };
            });
            
            // Calculate scores
            filteredSubs.forEach(sub => {
                if (scores[sub.vaId]) {
                    scores[sub.vaId].totalSubs += sub.count;
                    scores[sub.vaId].amount += sub.amount;
                }
            });
            
            // Calculate trends (comparison with previous period)
            Object.keys(scores).forEach(vaId => {
                const previousScore = calculatePreviousPeriodScore(vaId);
                if (previousScore > 0) {
                    scores[vaId].trend = Math.round(((scores[vaId].totalSubs - previousScore) / previousScore) * 100);
                }
            });
            
            return scores;
        }

        function calculatePreviousPeriodScore(vaId) {
            // Simplified trend calculation
            if (!data.subs || data.subs.length === 0) return 0;
            
            const lastWeekSubs = data.subs
                .filter(s => s.vaId === vaId && new Date(s.date) < new Date(Date.now() - 7 * 24 * 60 * 60 * 1000))
                .reduce((sum, s) => sum + s.count, 0);
            return lastWeekSubs;
        }

        function updateCompetitionStats() {
            const today = new Date().toISOString().split('T')[0];
            const todaySubs = data.subs.filter(s => s.date === today);
            const totalSubsToday = todaySubs.reduce((sum, s) => sum + s.count, 0);
            
            const filteredSubs = getFilteredSubs();
            const totalAmount = filteredSubs.reduce((sum, s) => sum + s.amount, 0);
            
            // Find best VA
            const vaScores = calculateVAScores();
            const bestVA = Object.entries(vaScores).sort((a, b) => b[1].totalSubs - a[1].totalSubs)[0];
            const bestVAName = bestVA ? data.vas.find(v => v.id === bestVA[0])?.name || '-' : '-';
            
            document.getElementById('total-subs-today').textContent = totalSubsToday;
            document.getElementById('total-payment').textContent = totalAmount.toFixed(2) + '';
            document.getElementById('best-va-name').textContent = bestVAName;
            
            // Update period display
            const periodDisplay = {
                'today': "Aujourd'hui",
                'week': "Cette semaine",
                'month': "Ce mois",
                'all': "Tout"
            };
            document.getElementById('period-display').textContent = periodDisplay[currentPeriod];
        }

        function updatePerformanceCharts() {
            // VA Performance Chart
            const performanceChart = document.getElementById('va-performance-chart');
            const vaScores = calculateVAScores();
            const topVAs = Object.entries(vaScores)
                .sort((a, b) => b[1].totalSubs - a[1].totalSubs)
                .slice(0, 5);
            
            if (topVAs.length === 0) {
                performanceChart.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-chart-bar" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">Aucune donne  afficher</p>
                    </div>
                `;
            } else {
                performanceChart.innerHTML = '';
                const maxSubs = Math.max(...topVAs.map(([_, stats]) => stats.totalSubs));
                
                topVAs.forEach(([vaId, stats]) => {
                    const va = data.vas.find(v => v.id === vaId);
                    if (!va) return;
                    
                    const percentage = (stats.totalSubs / maxSubs) * 100;
                    
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'progress-container';
                    progressContainer.innerHTML = `
                        <div class="progress-header">
                            <span>${va.name}</span>
                            <span>${stats.totalSubs} subs (${stats.amount.toFixed(2)})</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    performanceChart.appendChild(progressContainer);
                });
            }
            
            // Evolution Chart (simplified)
            const evolutionChart = document.getElementById('subs-evolution-chart');
            const last7Days = getLast7DaysData();
            
            evolutionChart.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; height: 150px; align-items: flex-end;">
                    ${last7Days.map(day => `
                        <div style="position: relative;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); height: ${day.height}%; border-radius: 0.25rem 0.25rem 0 0; transition: height 0.5s;"></div>
                            <div style="text-align: center; font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">${day.label}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getLast7DaysData() {
            const days = [];
            const maxCount = Math.max(...[...Array(7)].map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const count = data.subs
                    .filter(s => s.date === dateStr)
                    .reduce((sum, s) => sum + s.count, 0);
                return count;
            })) || 1;
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const count = data.subs
                    .filter(s => s.date === dateStr)
                    .reduce((sum, s) => sum + s.count, 0);
                
                days.push({
                    label: date.toLocaleDateString('fr', { weekday: 'short' }),
                    height: (count / maxCount) * 100
                });
            }
            
            return days;
        }

        function updateActivityFeed() {
            const container = document.getElementById('activity-list');
            const recentSubs = [...data.subs]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (recentSubs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-history" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">Aucune activit rcente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            recentSubs.forEach(sub => {
                const va = data.vas.find(v => v.id === sub.vaId);
                const item = document.createElement('div');
                item.className = 'activity-item';
                
                const timeAgo = getTimeAgo(new Date(sub.date));
                
                item.innerHTML = `
                    <div class="activity-icon" style="background: #dbeafe; color: #3b82f6;">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${va ? va.name : 'VA supprim'} - ${sub.count} subs</div>
                        <div class="activity-time">${timeAgo}  ${sub.amount.toFixed(2)}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return "Aujourd'hui";
            if (days === 1) return "Hier";
            if (days < 7) return `Il y a ${days} jours`;
            return date.toLocaleDateString('fr-FR');
        }


        function getFilteredSubs() {
            if (!data.subs) return [];
            
            let filtered = [...data.subs];
            const today = new Date().toISOString().split('T')[0];
            
            // Filter by period
            if (currentPeriod === 'today') {
                filtered = filtered.filter(sub => sub.date === today);
            } else if (currentPeriod === 'week') {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                filtered = filtered.filter(sub => new Date(sub.date) >= oneWeekAgo);
            } else if (currentPeriod === 'month') {
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                filtered = filtered.filter(sub => new Date(sub.date) >= oneMonthAgo);
            }
            // 'all' returns everything
            
            // Sort by date (most recent first)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return filtered;
        }

        function openAddSubsModal() {
            // Update VA select
            const vaSelect = document.getElementById('subs-va-select');
            if (!vaSelect) {
                console.error('VA select not found');
                return;
            }
            
            const vaOptions = data.vas.map(va => 
                `<option value="${va.id}">${va.name}</option>`
            ).join('');
            vaSelect.innerHTML = '<option value="">-- Choisir un VA --</option>' + vaOptions;
            
            const modal = document.getElementById('add-subs-modal');
            if (!modal) {
                console.error('Add subs modal not found');
                return;
            }
            
            modal.classList.add('show');
        }

        function closeAddSubsModal() {
            document.getElementById('add-subs-modal').classList.remove('show');
        }

        // Add Subscription Entry - SUPABASE VERSION
        async function addSubsEntry(event) {
            event.preventDefault();
            console.log('Adding subs entry...');

            const vaId = document.getElementById('subs-va-select').value;
            const date = document.getElementById('subs-date').value;
            const count = parseInt(document.getElementById('subs-count').value);

            if (!vaId || !date || !count) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            try {
                // Create subscription in Supabase
                const newSubscription = await window.createSubscription({
                    va_id: vaId,
                    date: date,
                    count: count,
                    amount: count * 0.50
                });

                // Add to local data
                if (!data.subs) {
                    data.subs = [];
                }

                data.subs.push({
                    id: newSubscription.id,
                    vaId: newSubscription.va_id,
                    date: newSubscription.date,
                    count: newSubscription.count,
                    amount: newSubscription.amount
                });

                event.target.reset();
                document.getElementById('subs-date').value = new Date().toISOString().split('T')[0];
                closeAddSubsModal();
                showSuccess(`${count} subs ajouts avec succs!`);

                updateCompetitionDisplay();
            } catch (error) {
                console.error('Error adding subscription:', error);
                showError('Erreur lors de l\'ajout des subs');
            }
        }

        // Delete Subscription - SUPABASE VERSION
        async function deleteSub(subId) {
            if (confirm('tes-vous sr de vouloir supprimer cette entre?')) {
                try {
                    // Delete from Supabase
                    await window.deleteSubscription(subId);

                    // Remove from local data
                    data.subs = data.subs.filter(sub => sub.id !== subId);
                    updateCompetitionDisplay();
                    showSuccess('Entre supprime');
                } catch (error) {
                    console.error('Error deleting subscription:', error);
                    showError('Erreur lors de la suppression');
                }
            }
        }

        function showDetailedView() {
            alert('Vue dtaille en dveloppement - bientt disponible!');
            // TODO: Implement detailed view with full table and analytics
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function exportSubsData() {
            let csv = 'Date,VA,Nombre de subs,Montant ()\n';
            
            const filteredSubs = getFilteredSubs();
            
            filteredSubs.forEach(sub => {
                const va = data.vas.find(v => v.id === sub.vaId);
                csv += `${sub.date},${va ? va.name : 'VA supprim'},${sub.count},${sub.amount.toFixed(2)}\n`;
            });
            
            // Add summary
            const totalSubs = filteredSubs.reduce((sum, sub) => sum + sub.count, 0);
            const totalAmount = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0);
            
            csv += `\n\nRSUM\n`;
            csv += `Total subs,${totalSubs}\n`;
            csv += `Total  payer,${totalAmount.toFixed(2)}\n`;
            
            // Add per VA summary
            csv += `\nPAR VA\n`;
            const vaPayments = {};
            filteredSubs.forEach(sub => {
                if (!vaPayments[sub.vaId]) {
                    vaPayments[sub.vaId] = { name: '', count: 0, amount: 0 };
                }
                const va = data.vas.find(v => v.id === sub.vaId);
                vaPayments[sub.vaId].name = va ? va.name : 'VA supprim';
                vaPayments[sub.vaId].count += sub.count;
                vaPayments[sub.vaId].amount += sub.amount;
            });
            
            Object.values(vaPayments).forEach(payment => {
                csv += `${payment.name},${payment.count} subs,${payment.amount.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `subs_export_${currentPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ========== REVENUE TRACKING FUNCTIONS ==========

        let currentRevenuePeriod = 'current-week';
        let currentExchangeRate = 0.92; // Default rate

        // Fetch exchange rate on page load
        function fetchExchangeRate() {
            // Using exchangerate-api.com (free tier, no API key needed)
            fetch('https://api.exchangerate-api.com/v4/latest/USD')
                .then(response => response.json())
                .then(data => {
                    currentExchangeRate = data.rates.EUR;
                    document.getElementById('exchange-rate').value = currentExchangeRate;
                    document.getElementById('exchange-rate-display').textContent = `1$ = ${currentExchangeRate.toFixed(4)}`;
                    document.getElementById('rate-update-time').textContent = `Mis  jour: ${new Date().toLocaleTimeString('fr-FR')}`;
                    
                    // Update conversion if form is open
                    if (typeof updateConversion !== 'undefined') {
                        updateConversion();
                    }
                })
                .catch(error => {
                    console.error('Error fetching exchange rate:', error);
                    document.getElementById('rate-update-time').textContent = 'Erreur - Utilisation du taux par dfaut';
                });
        }

        function updateExchangeRate() {
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            icon.classList.add('fa-spin');
            
            fetchExchangeRate();
            
            setTimeout(() => {
                icon.classList.remove('fa-spin');
            }, 1000);
        }

        function setupRevenueTracking() {
            // Fetch exchange rate on setup
            fetchExchangeRate();
            // Period tabs for revenue
            document.querySelectorAll('[data-revenue-period]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-revenue-period]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentRevenuePeriod = this.dataset.revenuePeriod;
                    updateRevenueDisplay();
                });
            });
            
            // Form events
            const addRevenueForm = document.getElementById('add-revenue-form');
            if (addRevenueForm) {
                addRevenueForm.addEventListener('submit', addRevenueEntry);
            }
            
            const payCommissionForm = document.getElementById('pay-commission-form');
            if (payCommissionForm) {
                payCommissionForm.addEventListener('submit', payCommissionEntry);
            }
            
            // Calculate commission on amount change
            const revenueAmountInput = document.getElementById('revenue-amount');
            const exchangeRateInput = document.getElementById('exchange-rate');
            
            function updateConversion() {
                const amountUSD = parseFloat(document.getElementById('revenue-amount').value) || 0;
                const exchangeRate = parseFloat(document.getElementById('exchange-rate').value) || currentExchangeRate;
                const amountEUR = amountUSD * exchangeRate;
                const commission = amountEUR * 0.05; // 5%
                
                document.getElementById('amount-in-eur').textContent = amountEUR.toFixed(2) + '';
                document.getElementById('calculated-commission').textContent = commission.toFixed(2) + '';
            }
            
            if (revenueAmountInput) {
                revenueAmountInput.addEventListener('input', updateConversion);
            }
            
            // Update outstanding info when VA selected
            const paymentVASelect = document.getElementById('payment-va-select');
            if (paymentVASelect) {
                paymentVASelect.addEventListener('change', updateOutstandingInfo);
            }
        }

        function updateRevenueDisplay() {
            updateRevenueStats();
            updateRevenueLeaderboard();
            updateCommissionSummary();
            updateRevenueCharts();
        }

        function updateRevenueStats() {
            const filteredRevenues = getFilteredRevenues();
            const totalRevenue = filteredRevenues.reduce((sum, r) => sum + r.amount, 0);
            const totalCommissionsDue = filteredRevenues.reduce((sum, r) => sum + r.commission, 0);
            
            const filteredPayments = getFilteredPayments();
            const totalPaid = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
            const remainingToPay = totalCommissionsDue - totalPaid;
            
            document.getElementById('total-revenue-generated').textContent = totalRevenue.toFixed(2) + '';
            document.getElementById('total-commissions-due').textContent = totalCommissionsDue.toFixed(2) + '';
            document.getElementById('total-commissions-paid').textContent = totalPaid.toFixed(2) + '';
            document.getElementById('commissions-to-pay').textContent = Math.max(0, remainingToPay).toFixed(2) + '';
        }

        function updateRevenueLeaderboard() {
            const container = document.getElementById('revenue-leaderboard-content');
            if (!container) return;
            
            const vaRevenues = calculateVARevenues();
            const sortedVAs = Object.entries(vaRevenues)
                .sort((a, b) => b[1].totalRevenue - a[1].totalRevenue)
                .slice(0, 10);
            
            container.innerHTML = '';
            
            if (sortedVAs.length === 0) {
                container.innerHTML = `
                    <div style="padding: 3rem; text-align: center; color: #94a3b8;">
                        <i class="fas fa-money-bill-wave" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Aucune donne de revenus</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Commencez  ajouter des revenus!</p>
                    </div>
                `;
                return;
            }
            
            sortedVAs.forEach(([vaId, stats], index) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va) return;
                
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                const efficiency = stats.totalRevenue > 0 ? (stats.totalCommission / stats.totalRevenue * 100).toFixed(1) : 0;
                
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="rank-badge ${rankClass}">${index + 1}</div>
                    <div class="va-info">
                        <div class="va-name">${va.name}</div>
                        <div class="va-stats-mini">
                            <span style="color: #10b981;"> ${stats.totalRevenue.toFixed(2)} gnrs</span>
                            <span style="color: #3b82f6;"> ${stats.totalCommission.toFixed(2)} commission</span>
                            <span style="color: #64748b;"> ${stats.balance.toFixed(2)}  payer</span>
                            <span>
                                <button onclick="viewVARevenues('${vaId}')" class="action-btn view-btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                    <i class="fas fa-edit"></i> Grer
                                </button>
                            </span>
                        </div>
                    </div>
                    <div class="va-score">
                        <div class="score-value" style="color: #10b981;">${stats.totalRevenue.toFixed(0)}</div>
                        <div class="score-label">Revenus gnrs</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function calculateVARevenues() {
            const revenues = {};
            
            // Initialize all VAs
            data.vas.forEach(va => {
                revenues[va.id] = { 
                    totalRevenue: 0, 
                    totalCommission: 0, 
                    totalPaid: 0,
                    balance: 0 
                };
            });
            
            // Add revenues
            const filteredRevenues = getFilteredRevenues();
            filteredRevenues.forEach(rev => {
                if (revenues[rev.vaId]) {
                    revenues[rev.vaId].totalRevenue += rev.amount;
                    revenues[rev.vaId].totalCommission += rev.commission;
                }
            });
            
            // Subtract payments (old system)
            const filteredPayments = getFilteredPayments();
            filteredPayments.forEach(pay => {
                if (revenues[pay.vaId]) {
                    revenues[pay.vaId].totalPaid += pay.amount;
                }
            });
            
            // Add new VA payments for commissions
            (data.vaPayments || []).forEach(payment => {
                if (revenues[payment.vaId] && (payment.type === 'commissions' || payment.type === 'both')) {
                    revenues[payment.vaId].totalPaid += (payment.commissionsAmount || 0);
                }
            });
            
            // Calculate balance
            Object.keys(revenues).forEach(vaId => {
                revenues[vaId].balance = revenues[vaId].totalCommission - revenues[vaId].totalPaid;
            });
            
            return revenues;
        }

        function updateCommissionSummary() {
            const container = document.getElementById('commission-summary');
            const vaRevenues = calculateVARevenues();
            
            container.innerHTML = '';
            
            const vasWithBalance = Object.entries(vaRevenues)
                .filter(([_, stats]) => stats.balance > 0)
                .sort((a, b) => b[1].balance - a[1].balance);
            
            if (vasWithBalance.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8;">Toutes les commissions sont  jour! </p>';
                return;
            }
            
            vasWithBalance.forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va) return;
                
                const card = document.createElement('div');
                card.style.cssText = 'background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid #f59e0b;';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${va.name}</strong>
                            <div style="font-size: 0.875rem; color: #64748b;">
                                Commission: ${stats.totalCommission.toFixed(2)} | Pay: ${stats.totalPaid.toFixed(2)}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: 600; color: #f59e0b;">
                                ${stats.balance.toFixed(2)}
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b;"> payer</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateRevenueCharts() {
            // Revenue evolution
            const evolutionChart = document.getElementById('revenue-evolution-chart');
            const last7Days = getRevenueLast7Days();
            
            evolutionChart.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; height: 150px; align-items: flex-end;">
                    ${last7Days.map(day => `
                        <div style="position: relative;">
                            <div style="background: linear-gradient(135deg, #10b981, #059669); height: ${day.height}%; border-radius: 0.25rem 0.25rem 0 0; transition: height 0.5s;"></div>
                            <div style="text-align: center; font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">${day.label}</div>
                            <div style="text-align: center; font-size: 0.625rem; color: #94a3b8;">${day.amount}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Commission distribution
            const distributionChart = document.getElementById('commission-distribution-chart');
            const vaRevenues = calculateVARevenues();
            const topVAs = Object.entries(vaRevenues)
                .filter(([_, stats]) => stats.totalCommission > 0)
                .sort((a, b) => b[1].totalCommission - a[1].totalCommission)
                .slice(0, 5);
            
            if (topVAs.length === 0) {
                distributionChart.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-chart-pie" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">Aucune commission  afficher</p>
                    </div>
                `;
            } else {
                const maxCommission = Math.max(...topVAs.map(([_, stats]) => stats.totalCommission));
                
                distributionChart.innerHTML = '';
                topVAs.forEach(([vaId, stats]) => {
                    const va = data.vas.find(v => v.id === vaId);
                    if (!va) return;
                    
                    const percentage = (stats.totalCommission / maxCommission) * 100;
                    const paidPercentage = stats.totalCommission > 0 ? (stats.totalPaid / stats.totalCommission) * 100 : 0;
                    
                    const container = document.createElement('div');
                    container.className = 'progress-container';
                    container.innerHTML = `
                        <div class="progress-header">
                            <span>${va.name}</span>
                            <span>${stats.totalCommission.toFixed(2)} (${stats.balance.toFixed(2)} dus)</span>
                        </div>
                        <div class="progress-bar" style="position: relative;">
                            <div class="progress-fill" style="width: ${percentage}%; background: #e5e7eb;"></div>
                            <div class="progress-fill" style="width: ${paidPercentage}%; background: linear-gradient(90deg, #10b981, #059669); position: absolute; top: 0; left: 0;"></div>
                        </div>
                    `;
                    distributionChart.appendChild(container);
                });
            }
        }

        function getRevenueLast7Days() {
            const days = [];
            const maxAmount = Math.max(...[...Array(7)].map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const amount = data.revenues
                    .filter(r => r.date === dateStr)
                    .reduce((sum, r) => sum + r.amount, 0);
                return amount;
            })) || 1;
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const amount = data.revenues
                    .filter(r => r.date === dateStr)
                    .reduce((sum, r) => sum + r.amount, 0);
                
                days.push({
                    label: date.toLocaleDateString('fr', { weekday: 'short' }),
                    height: (amount / maxAmount) * 100,
                    amount: amount.toFixed(0)
                });
            }
            
            return days;
        }

        function getFilteredRevenues() {
            if (!data.revenues) return [];
            
            let filtered = [...data.revenues];
            const now = new Date();
            
            switch (currentRevenuePeriod) {
                case 'current-week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(r => new Date(r.date) >= startOfWeek);
                    break;
                case 'last-week':
                    const startOfLastWeek = new Date(now);
                    startOfLastWeek.setDate(now.getDate() - now.getDay() - 7);
                    const endOfLastWeek = new Date(now);
                    endOfLastWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(r => {
                        const date = new Date(r.date);
                        return date >= startOfLastWeek && date < endOfLastWeek;
                    });
                    break;
                case 'current-month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filtered = filtered.filter(r => new Date(r.date) >= startOfMonth);
                    break;
            }
            
            return filtered;
        }

        function getFilteredPayments() {
            if (!data.payments) return [];
            
            let filtered = [...data.payments];
            const now = new Date();
            
            switch (currentRevenuePeriod) {
                case 'current-week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(p => new Date(p.date) >= startOfWeek);
                    break;
                case 'last-week':
                    const startOfLastWeek = new Date(now);
                    startOfLastWeek.setDate(now.getDate() - now.getDay() - 7);
                    const endOfLastWeek = new Date(now);
                    endOfLastWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(p => {
                        const date = new Date(p.date);
                        return date >= startOfLastWeek && date < endOfLastWeek;
                    });
                    break;
                case 'current-month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filtered = filtered.filter(p => new Date(p.date) >= startOfMonth);
                    break;
            }
            
            return filtered;
        }

        function openAddRevenueModal() {
            const vaSelect = document.getElementById('revenue-va-select');
            const vaOptions = data.vas.map(va => 
                `<option value="${va.id}">${va.name}</option>`
            ).join('');
            vaSelect.innerHTML = '<option value="">-- Choisir un VA --</option>' + vaOptions;
            
            // Fetch latest exchange rate when opening modal
            fetchExchangeRate();
            
            document.getElementById('add-revenue-modal').classList.add('show');
        }

        function closeAddRevenueModal() {
            document.getElementById('add-revenue-modal').classList.remove('show');
            // Clear any editing state
            delete window.editingRevenueId;
        }

        // Add Revenue Entry - SUPABASE VERSION
        async function addRevenueEntry(event) {
            event.preventDefault();

            const vaId = document.getElementById('revenue-va-select').value;
            const date = document.getElementById('revenue-date').value;
            const amountUSD = parseFloat(document.getElementById('revenue-amount').value);
            const exchangeRate = parseFloat(document.getElementById('exchange-rate').value) || currentExchangeRate;
            const trackingLink = document.getElementById('tracking-link').value;
            const description = document.getElementById('revenue-description').value;

            // Convert USD to EUR
            const amountEUR = amountUSD * exchangeRate;
            const commission = amountEUR * 0.05; // 5%

            // Check if we're editing
            const isEditing = window.editingRevenueId !== undefined;
            let message;

            try {
                if (isEditing) {
                    // Update existing revenue in Supabase
                    const revenueId = window.editingRevenueId;
                    await window.updateRevenue(revenueId, {
                        va_id: vaId,
                        date: date,
                        amount_usd: amountUSD,
                        amount_eur: amountEUR,
                        exchange_rate: exchangeRate,
                        tracking_link: trackingLink || '',
                        description: description || 'Ventes mdias',
                        commission: commission
                    });

                    // Remove old entry from local data
                    data.revenues = data.revenues.filter(r => r.id !== revenueId);
                    delete window.editingRevenueId;
                    message = `Revenus modifis: ${amountUSD.toFixed(2)}$ (${amountEUR.toFixed(2)})`;
                } else {
                    // Create new revenue in Supabase
                    const newRevenue = await window.createRevenue({
                        va_id: vaId,
                        date: date,
                        amount_usd: amountUSD,
                        amount_eur: amountEUR,
                        exchange_rate: exchangeRate,
                        tracking_link: trackingLink || '',
                        description: description || 'Ventes mdias',
                        commission: commission
                    });

                    // Add to local data
                    if (!data.revenues) data.revenues = [];
                    data.revenues.push({
                        id: newRevenue.id,
                        vaId: newRevenue.va_id,
                        date: newRevenue.date,
                        amountUSD: newRevenue.amount_usd,
                        exchangeRate: newRevenue.exchange_rate,
                        amount: newRevenue.amount_eur,
                        commission: newRevenue.commission,
                        trackingLink: newRevenue.tracking_link || '',
                        description: newRevenue.description || 'Ventes mdias'
                    });

                    message = `Revenus de ${amountUSD.toFixed(2)}$ (${amountEUR.toFixed(2)}) ajouts avec succs!`;
                }

                event.target.reset();
                document.getElementById('revenue-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('exchange-rate').value = currentExchangeRate;
                document.getElementById('amount-in-eur').textContent = '0.00';
                document.getElementById('calculated-commission').textContent = '0.00';
                closeAddRevenueModal();
                showSuccess(message);

                updateRevenueDisplay();
            } catch (error) {
                console.error('Error adding/updating revenue:', error);
                showError('Erreur lors de l\'ajout/modification des revenus');
            }
        }

        function openPayCommissionModal() {
            const vaSelect = document.getElementById('payment-va-select');
            const vaOptions = data.vas.map(va => 
                `<option value="${va.id}">${va.name}</option>`
            ).join('');
            vaSelect.innerHTML = '<option value="">-- Choisir un VA --</option>' + vaOptions;
            
            document.getElementById('pay-commission-modal').classList.add('show');
        }

        function closePayCommissionModal() {
            document.getElementById('pay-commission-modal').classList.remove('show');
        }

        function updateOutstandingInfo() {
            const vaId = document.getElementById('payment-va-select').value;
            const infoDiv = document.getElementById('va-outstanding-info');
            const amountSpan = document.getElementById('outstanding-amount');
            
            if (!vaId) {
                infoDiv.style.display = 'none';
                return;
            }
            
            const vaRevenues = calculateVARevenues();
            const balance = vaRevenues[vaId]?.balance || 0;
            
            amountSpan.textContent = balance.toFixed(2) + '';
            infoDiv.style.display = 'block';
        }

        // Add Payment Entry - SUPABASE VERSION
        async function payCommissionEntry(event) {
            event.preventDefault();

            const vaId = document.getElementById('payment-va-select').value;
            const date = document.getElementById('payment-date').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const period = document.getElementById('payment-period').value;

            try {
                // Create payment in Supabase
                const newPayment = await window.createPayment({
                    va_id: vaId,
                    date: date,
                    amount: amount,
                    description: `Commission ${period}`
                });

                // Add to local data
                if (!data.payments) data.payments = [];
                data.payments.push({
                    id: newPayment.id,
                    vaId: newPayment.va_id,
                    date: newPayment.date,
                    amount: newPayment.amount,
                    type: 'commission',
                    period: period,
                    description: newPayment.description
                });

                event.target.reset();
                document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('va-outstanding-info').style.display = 'none';
                closePayCommissionModal();
                showSuccess(`Paiement de ${amount.toFixed(2)} enregistr!`);

                updateRevenueDisplay();
            } catch (error) {
                console.error('Error adding payment:', error);
                showError('Erreur lors de l\'ajout du paiement');
            }
        }

        function viewPaymentHistory() {
            const section = document.getElementById('payment-history-section');
            section.style.display = 'block';
            
            const container = document.getElementById('payment-history-list');
            const allPayments = [...(data.payments || [])]
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allPayments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-receipt" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">Aucun paiement enregistr</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            allPayments.forEach(payment => {
                const va = data.vas.find(v => v.id === payment.vaId);
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-icon" style="background: #dbeafe; color: #3b82f6;">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${va ? va.name : 'VA supprim'} - ${payment.amount.toFixed(2)}</div>
                        <div class="activity-time">${formatDate(payment.date)}  ${payment.period}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function hidePaymentHistory() {
            document.getElementById('payment-history-section').style.display = 'none';
        }

        function viewVARevenues(vaId) {
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            document.getElementById('revenue-management-title').textContent = `Gestion des Revenus - ${va.name}`;
            const tbody = document.getElementById('revenue-management-tbody');
            
            const vaRevenues = data.revenues.filter(r => r.vaId === vaId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            
            if (vaRevenues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8;">Aucun revenu enregistr</td></tr>';
            } else {
                vaRevenues.forEach(revenue => {
                    const row = document.createElement('tr');
                    const usdAmount = revenue.amountUSD || (revenue.amount / 0.92);
                    const rate = revenue.exchangeRate || 0.92;
                    
                    row.innerHTML = `
                        <td>${formatDate(revenue.date)}</td>
                        <td>${revenue.description}</td>
                        <td>${usdAmount.toFixed(2)}$</td>
                        <td>${rate.toFixed(4)}</td>
                        <td>${revenue.amount.toFixed(2)}</td>
                        <td>${revenue.commission.toFixed(2)}</td>
                        <td>
                            <button class="action-btn view-btn" onclick="editRevenue('${revenue.id}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteRevenue('${revenue.id}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('revenue-management-section').style.display = 'block';
            document.getElementById('payment-history-section').style.display = 'none';
        }

        function hideRevenueManagement() {
            document.getElementById('revenue-management-section').style.display = 'none';
        }

        function editRevenue(revenueId) {
            const revenue = data.revenues.find(r => r.id === revenueId);
            if (!revenue) return;
            
            console.log('Editing revenue:', revenue);
            
            // Store the revenue ID being edited
            window.editingRevenueId = revenueId;
            
            // Open the modal first
            openAddRevenueModal();
            
            // Wait a bit for the modal to be ready
            setTimeout(() => {
                // Pre-fill the form with existing data
                const vaSelect = document.getElementById('revenue-va-select');
                const dateInput = document.getElementById('revenue-date');
                const amountInput = document.getElementById('revenue-amount');
                const rateInput = document.getElementById('exchange-rate');
                const linkInput = document.getElementById('tracking-link');
                const descInput = document.getElementById('revenue-description');
                
                if (vaSelect) vaSelect.value = revenue.vaId;
                if (dateInput) dateInput.value = revenue.date;
                if (amountInput) amountInput.value = revenue.amountUSD || (revenue.amount / (revenue.exchangeRate || 0.92));
                if (rateInput) {
                    rateInput.value = revenue.exchangeRate || 0.92;
                    document.getElementById('exchange-rate-display').textContent = `1$ = ${(revenue.exchangeRate || 0.92).toFixed(4)}`;
                }
                if (linkInput) linkInput.value = revenue.trackingLink || '';
                if (descInput) descInput.value = revenue.description || '';
                
                // Update conversion display
                updateConversion();
            }, 100);
            
            // Hide management section
            hideRevenueManagement();
        }

        // Delete Revenue - SUPABASE VERSION
        async function deleteRevenue(revenueId) {
            if (confirm('tes-vous sr de vouloir supprimer cette entre de revenus?')) {
                try {
                    // Delete from Supabase
                    await window.deleteRevenue(revenueId);

                    // Remove from local data
                    data.revenues = data.revenues.filter(r => r.id !== revenueId);
                    showSuccess('Revenu supprim');
                    updateRevenueDisplay();

                    // Refresh the management view
                    const tbody = document.getElementById('revenue-management-tbody');
                    if (tbody.parentElement.parentElement.parentElement.style.display !== 'none') {
                        const titleText = document.getElementById('revenue-management-title').textContent;
                        if (titleText.includes('Tous les revenus')) {
                            viewAllRevenues();
                        } else {
                            // Find VA from remaining revenues
                            const remainingRevenue = data.revenues[0];
                            if (remainingRevenue) {
                                viewVARevenues(remainingRevenue.vaId);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error deleting revenue:', error);
                    showError('Erreur lors de la suppression du revenu');
                }
            }
        }

        function viewAllRevenues() {
            document.getElementById('revenue-management-title').textContent = 'Tous les revenus';
            const tbody = document.getElementById('revenue-management-tbody');
            
            const allRevenues = [...data.revenues]
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            
            if (allRevenues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8;">Aucun revenu enregistr</td></tr>';
            } else {
                allRevenues.forEach(revenue => {
                    const va = data.vas.find(v => v.id === revenue.vaId);
                    const row = document.createElement('tr');
                    const usdAmount = revenue.amountUSD || (revenue.amount / 0.92);
                    const rate = revenue.exchangeRate || 0.92;
                    
                    row.innerHTML = `
                        <td>${formatDate(revenue.date)}</td>
                        <td><strong>${va ? va.name : 'VA supprim'}:</strong> ${revenue.description}</td>
                        <td>${usdAmount.toFixed(2)}$</td>
                        <td>${rate.toFixed(4)}</td>
                        <td>${revenue.amount.toFixed(2)}</td>
                        <td>${revenue.commission.toFixed(2)}</td>
                        <td>
                            <button class="action-btn view-btn" onclick="editRevenue('${revenue.id}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteRevenue('${revenue.id}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('revenue-management-section').style.display = 'block';
            document.getElementById('payment-history-section').style.display = 'none';
        }

        function exportFinancialData() {
            let csv = 'Type,Date,VA,Description,Montant USD,Taux Change,Montant EUR,Commission EUR,Lien Tracking\n';
            
            // Add revenues
            data.revenues.forEach(rev => {
                const va = data.vas.find(v => v.id === rev.vaId);
                const usdAmount = rev.amountUSD || (rev.amount / 0.92); // Fallback for old data
                const rate = rev.exchangeRate || 0.92;
                csv += `Revenu,${rev.date},${va ? va.name : 'VA supprim'},"${rev.description}",${usdAmount.toFixed(2)},${rate},${rev.amount.toFixed(2)},${rev.commission.toFixed(2)},"${rev.trackingLink}"\n`;
            });
            
            // Add payments
            csv += '\n\nPaiements de Commissions\n';
            csv += 'Date,VA,Montant EUR,Priode\n';
            data.payments.forEach(pay => {
                const va = data.vas.find(v => v.id === pay.vaId);
                csv += `${pay.date},${va ? va.name : 'VA supprim'},${pay.amount.toFixed(2)},"${pay.period}"\n`;
            });
            
            // Add summary
            const vaRevenues = calculateVARevenues();
            csv += '\n\nRSUM PAR VA\n';
            csv += 'VA,Revenus Gnrs EUR,Commission Due EUR,Dj Pay EUR,Reste  Payer EUR\n';
            
            Object.entries(vaRevenues).forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (stats.totalRevenue > 0) {
                    csv += `${va ? va.name : 'VA supprim'},${stats.totalRevenue.toFixed(2)},${stats.totalCommission.toFixed(2)},${stats.totalPaid.toFixed(2)},${stats.balance.toFixed(2)}\n`;
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        // ========== FINANCIAL OVERVIEW FUNCTIONS ==========

        let currentFinancialPeriod = 'current-week';

        function setupFinancialOverview() {
            // Period tabs
            document.querySelectorAll('[data-financial-period]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-financial-period]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFinancialPeriod = this.dataset.financialPeriod;
                    updateFinancialOverview();
                });
            });
        }

        function updateFinancialOverview() {
            updateFinancialSnapshot();
            updateVAFinancialGrid();
            updateRevenueBreakdownChart();
            updateGlobalEvolutionChart();
            updateFinancialSummaryTable();
            updatePaymentHistoryTable();
        }
        
        function updateFinancialSnapshot() {
            const container = document.getElementById('financial-snapshot');
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            
            // Calculate all financial data
            const filteredSubs = getFilteredSubsForFinancial();
            const filteredRevenues = getFilteredRevenuesForFinancial();
            const totalSubsRevenue = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0);
            const totalMediaRevenue = filteredRevenues.reduce((sum, rev) => sum + rev.amount, 0);
            const totalCommissions = filteredRevenues.reduce((sum, rev) => sum + rev.commission, 0);
            const totalPaidAmount = (data.vaPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
            const totalAllRevenue = totalSubsRevenue + totalMediaRevenue;
            const totalDue = totalSubsRevenue + totalCommissions;
            const totalToPay = totalDue - totalPaidAmount;
            
            // Calculate profit/loss
            const netProfit = totalMediaRevenue - totalCommissions;
            const profitMargin = totalMediaRevenue > 0 ? (netProfit / totalMediaRevenue * 100).toFixed(1) : 0;
            
            // Update period description
            const periodDescriptions = {
                'current-week': 'Aperu de vos finances cette semaine',
                'current-month': 'Aperu de vos finances ce mois-ci',
                'last-month': 'Aperu de vos finances le mois dernier',
                'all': 'Aperu de toutes vos finances'
            };
            document.getElementById('financial-period-description').textContent = periodDescriptions[currentFinancialPeriod];
            
            let html = `
                <!-- Main Financial Flow Visualization -->
                <div style="background: ${isDarkMode ? '#0f172a' : '#ffffff'}; border-radius: 2rem; padding: 3rem; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1); margin-bottom: 3rem;">
                    <!-- Revenue Flow -->
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 2rem; margin-bottom: 4rem;">
                        <!-- Revenus -->
                        <div style="text-align: center;">
                            <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1e3a8a, #2563eb)' : 'linear-gradient(135deg, #eff6ff, #dbeafe)'}; border-radius: 1.5rem; padding: 2rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                                <i class="fas fa-coins" style="font-size: 3rem; color: ${isDarkMode ? '#60a5fa' : '#3b82f6'}; margin-bottom: 1rem; display: block;"></i>
                                <h3 style="font-size: 2.5rem; font-weight: 800; margin: 0; color: ${isDarkMode ? '#ffffff' : '#1e40af'};">${totalAllRevenue.toFixed(2)}</h3>
                                <p style="margin-top: 0.5rem; font-size: 1rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Revenus Totaux</p>
                                <div style="margin-top: 1.5rem; display: grid; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'}; border-radius: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                            <i class="fas fa-users" style="margin-right: 0.5rem; color: #3b82f6;"></i>Subs
                                        </span>
                                        <span style="font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${totalSubsRevenue.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'}; border-radius: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                            <i class="fas fa-photo-video" style="margin-right: 0.5rem; color: #10b981;"></i>Mdias
                                        </span>
                                        <span style="font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${totalMediaRevenue.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Arrow -->
                        <div style="font-size: 3rem; color: ${isDarkMode ? '#475569' : '#cbd5e1'};">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        
                        <!-- Obligations -->
                        <div style="text-align: center;">
                            <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #7c2d12, #dc2626)' : 'linear-gradient(135deg, #fef2f2, #fee2e2)'}; border-radius: 1.5rem; padding: 2rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; left: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                                <i class="fas fa-hand-holding-usd" style="font-size: 3rem; color: ${isDarkMode ? '#f87171' : '#dc2626'}; margin-bottom: 1rem; display: block;"></i>
                                <h3 style="font-size: 2.5rem; font-weight: 800; margin: 0; color: ${isDarkMode ? '#ffffff' : '#991b1b'};">${totalDue.toFixed(2)}</h3>
                                <p style="margin-top: 0.5rem; font-size: 1rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">D aux VAs</p>
                                <div style="margin-top: 1.5rem; display: grid; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'}; border-radius: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                            <i class="fas fa-check-circle" style="margin-right: 0.5rem; color: #22c55e;"></i>Pay
                                        </span>
                                        <span style="font-weight: 600; color: #22c55e;">${totalPaidAmount.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'}; border-radius: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                            <i class="fas fa-clock" style="margin-right: 0.5rem; color: #ef4444;"></i>Reste
                                        </span>
                                        <span style="font-weight: 600; color: #ef4444;">${totalToPay.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profit Section -->
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #14532d, #16a34a)' : 'linear-gradient(135deg, #f0fdf4, #dcfce7)'}; border-radius: 1.5rem; padding: 2rem; text-align: center;">
                        <h3 style="font-size: 1.25rem; margin: 0; color: ${isDarkMode ? '#86efac' : '#16a34a'};">
                            <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>Votre Profit Net
                        </h3>
                        <div style="font-size: 3rem; font-weight: 800; margin: 1rem 0; color: ${isDarkMode ? '#ffffff' : '#14532d'};">
                            ${netProfit.toFixed(2)}
                        </div>
                        <div style="font-size: 1rem; color: ${isDarkMode ? '#86efac' : '#16a34a'};">
                            Marge de ${profitMargin}% sur les mdias
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#64748b'};">
                            Revenus mdias (${totalMediaRevenue.toFixed(2)}) - Commissions (${totalCommissions.toFixed(2)})
                        </p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 3rem;">
                    <button onclick="showPaymentModal()" class="submit-btn" style="background: linear-gradient(135deg, #16a34a, #22c55e); padding: 1rem 2rem; font-size: 1.1rem;">
                        <i class="fas fa-money-check-alt" style="margin-right: 0.5rem;"></i> Enregistrer un Paiement
                    </button>
                    <button onclick="exportCompleteFinancialReport()" class="submit-btn" style="background: linear-gradient(135deg, #7c3aed, #9333ea); padding: 1rem 2rem; font-size: 1.1rem;">
                        <i class="fas fa-file-excel" style="margin-right: 0.5rem;"></i> Export Excel
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }


        function updateVAFinancialGrid() {
            const container = document.getElementById('va-financial-grid');
            const vaFinancials = calculateCompleteVAFinancials();
            
            container.innerHTML = '';
            
            // Sort by total revenue
            const sortedVAs = Object.entries(vaFinancials)
                .sort((a, b) => b[1].totalRevenue - a[1].totalRevenue);
            
            sortedVAs.forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va || stats.totalRevenue === 0) return;
                
                const card = document.createElement('div');
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                card.style.cssText = `background: ${isDarkMode ? '#1e293b' : '#f8fafc'}; border-radius: 1rem; padding: 1.5rem; border-left: 4px solid #f59e0b;`;
                
                const efficiency = stats.mediaRevenue > 0 ? (stats.totalRevenue / stats.mediaRevenue * 100).toFixed(1) : 0;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${va.name}</h3>
                        <span style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${stats.totalRevenue.toFixed(2)}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">Subs (${stats.subsCount})</div>
                            <div style="font-weight: 600; color: #3b82f6;">${stats.subsRevenue.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">Mdias vendus</div>
                            <div style="font-weight: 600; color: #10b981;">${stats.mediaRevenue.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">Commissions dues</div>
                            <div style="font-weight: 600; color: #ef4444;">${stats.commissionsDue.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">Total  payer au VA</div>
                            <div style="font-weight: 600; color: #ef4444;">${((stats.subsRevenue + stats.commissionsDue) - (stats.paidAmount || 0)).toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid ${isDarkMode ? '#334155' : '#e2e8f0'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Performance</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <div style="width: 100px; height: 8px; background: ${isDarkMode ? '#334155' : '#e2e8f0'}; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${Math.min(efficiency, 100)}%; height: 100%; background: linear-gradient(90deg, #f59e0b, #d97706);"></div>
                                </div>
                                <span style="font-size: 0.75rem; font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${efficiency}%</span>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            if (Object.keys(vaFinancials).length === 0 || sortedVAs.every(([_, stats]) => stats.totalRevenue === 0)) {
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                container.innerHTML = `<div style="text-align: center; padding: 3rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Aucune donne financire pour cette priode</div>`;
            }
        }

        function calculateCompleteVAFinancials() {
            const financials = {};
            
            // Initialize all VAs
            data.vas.forEach(va => {
                financials[va.id] = {
                    subsRevenue: 0,
                    subsCount: 0,
                    mediaRevenue: 0,
                    commissionsDue: 0,
                    totalRevenue: 0,
                    netRevenue: 0,
                    paidAmount: 0
                };
            });
            
            // Add subs revenue
            const filteredSubs = getFilteredSubsForFinancial();
            filteredSubs.forEach(sub => {
                if (financials[sub.vaId]) {
                    financials[sub.vaId].subsRevenue += sub.amount;
                    financials[sub.vaId].subsCount += sub.count;
                }
            });
            
            // Add media revenue
            const filteredRevenues = getFilteredRevenuesForFinancial();
            filteredRevenues.forEach(rev => {
                if (financials[rev.vaId]) {
                    financials[rev.vaId].mediaRevenue += rev.amount;
                    financials[rev.vaId].commissionsDue += rev.commission;
                }
            });
            
            // Add payments
            (data.vaPayments || []).forEach(payment => {
                if (financials[payment.vaId]) {
                    financials[payment.vaId].paidAmount += payment.amount;
                }
            });
            
            // Calculate totals
            Object.keys(financials).forEach(vaId => {
                financials[vaId].totalRevenue = financials[vaId].subsRevenue + financials[vaId].mediaRevenue;
                financials[vaId].netRevenue = financials[vaId].mediaRevenue - financials[vaId].commissionsDue;
            });
            
            return financials;
        }

        function updateRevenueBreakdownChart() {
            const container = document.getElementById('revenue-breakdown-chart');
            const filteredSubs = getFilteredSubsForFinancial();
            const filteredRevenues = getFilteredRevenuesForFinancial();
            
            const totalSubsRevenue = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0);
            const totalMediaRevenue = filteredRevenues.reduce((sum, rev) => sum + rev.amount, 0);
            const totalRevenue = totalSubsRevenue + totalMediaRevenue;
            
            if (totalRevenue === 0) {
                container.innerHTML = `
                    <div style="color: #94a3b8;">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Aucune donne pour cette priode</p>
                    </div>
                `;
                return;
            }
            
            const subsPercentage = (totalSubsRevenue / totalRevenue * 100).toFixed(1);
            const mediaPercentage = (totalMediaRevenue / totalRevenue * 100).toFixed(1);
            
            container.innerHTML = `
                <div style="position: relative; width: 200px; height: 200px; margin: 0 auto;">
                    <svg viewBox="0 0 42 42" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                        <circle cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#e2e8f0" stroke-width="3"></circle>
                        <circle cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#3b82f6" stroke-width="3"
                            stroke-dasharray="${subsPercentage} ${100 - subsPercentage}"
                            stroke-dashoffset="0"></circle>
                        <circle cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#10b981" stroke-width="3"
                            stroke-dasharray="${mediaPercentage} ${100 - mediaPercentage}"
                            stroke-dashoffset="${-subsPercentage}"></circle>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${totalRevenue.toFixed(0)}</div>
                        <div style="font-size: 0.875rem; color: #64748b;">Total</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                        <span style="font-size: 0.875rem;">Subs (${subsPercentage}%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                        <span style="font-size: 0.875rem;">Mdias (${mediaPercentage}%)</span>
                    </div>
                </div>
            `;
        }

        function updateGlobalEvolutionChart() {
            const container = document.getElementById('global-evolution-chart');
            const last7Days = getGlobalLast7Days();
            
            const maxAmount = Math.max(...last7Days.map(d => d.total)) || 1;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; height: 200px; align-items: flex-end;">
                    ${last7Days.map(day => `
                        <div style="position: relative; height: 100%;">
                            <div style="position: absolute; bottom: 0; width: 100%; display: flex; flex-direction: column;">
                                <div style="background: #10b981; height: ${(day.media / maxAmount) * 150}px; border-radius: 0.25rem 0.25rem 0 0;"></div>
                                <div style="background: #3b82f6; height: ${(day.subs / maxAmount) * 150}px;"></div>
                            </div>
                            <div style="position: absolute; bottom: -25px; width: 100%; text-align: center;">
                                <div style="font-size: 0.75rem; color: #64748b;">${day.label}</div>
                                <div style="font-size: 0.625rem; color: #94a3b8;">${day.total.toFixed(0)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 3rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                        <span style="font-size: 0.875rem;">Subs</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                        <span style="font-size: 0.875rem;">Mdias</span>
                    </div>
                </div>
            `;
        }

        function getGlobalLast7Days() {
            const days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const subsAmount = (data.subs || [])
                    .filter(s => s.date === dateStr)
                    .reduce((sum, s) => sum + s.amount, 0);
                
                const mediaAmount = (data.revenues || [])
                    .filter(r => r.date === dateStr)
                    .reduce((sum, r) => sum + r.amount, 0);
                
                days.push({
                    label: date.toLocaleDateString('fr', { weekday: 'short' }),
                    subs: subsAmount,
                    media: mediaAmount,
                    total: subsAmount + mediaAmount
                });
            }
            
            return days;
        }

        function updateFinancialSummaryTable() {
            const container = document.getElementById('financial-summary-table');
            const vaFinancials = calculateCompleteVAFinancials();
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            
            let totals = {
                subs: 0,
                media: 0,
                total: 0,
                commissions: 0,
                toPay: 0,
                vaCount: 0
            };
            
            // Calculate totals first
            let totalAlreadyPaid = 0;
            Object.entries(vaFinancials).forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va || stats.totalRevenue === 0) return;
                
                totals.subs += stats.subsRevenue;
                totals.media += stats.mediaRevenue;
                totals.total += stats.totalRevenue;
                totals.commissions += stats.commissionsDue;
                totals.toPay += ((stats.subsRevenue + stats.commissionsDue) - (stats.paidAmount || 0));
                totalAlreadyPaid += (stats.paidAmount || 0);
                totals.vaCount++;
            });
            
            // Create the new design
            let html = `
                <!-- Global Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1e3a8a, #2563eb)' : 'linear-gradient(135deg, #dbeafe, #bfdbfe)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#1e40af'};">${totals.total.toFixed(2)}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#bfdbfe' : '#3730a3'}; margin-top: 0.5rem;">Total Revenus Gnrs</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #047857, #10b981)' : 'linear-gradient(135deg, #d1fae5, #a7f3d0)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#047857'};">${totals.media.toFixed(2)}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#a7f3d0' : '#064e3b'}; margin-top: 0.5rem;">Revenus Mdias</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #7c2d12, #f59e0b)' : 'linear-gradient(135deg, #fed7aa, #fbbf24)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#92400e'};">${totals.subs.toFixed(2)}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#fed7aa' : '#78350f'}; margin-top: 0.5rem;">Total Subs</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #047857, #10b981)' : 'linear-gradient(135deg, #86efac, #22c55e)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#14532d'};">${totalAlreadyPaid.toFixed(2)}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#86efac' : '#14532d'}; margin-top: 0.5rem;">Total Pay aux VAs</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #991b1b, #ef4444)' : 'linear-gradient(135deg, #fecaca, #fca5a5)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#991b1b'};">${totals.toPay.toFixed(2)}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#fecaca' : '#7f1d1d'}; margin-top: 0.5rem;">Reste  Payer</div>
                    </div>
                </div>
                
                <!-- VA Details Title -->
                <h4 style="margin-bottom: 2rem; font-size: 1.25rem; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'};">
                    <i class="fas fa-users"></i> Dtail par VA (${totals.vaCount} actifs)
                </h4>
                
                <!-- VA Cards Grid -->
                <div style="display: grid; gap: 1.5rem;">
            `;
            
            // Add VA cards
            Object.entries(vaFinancials)
                .sort((a, b) => b[1].totalRevenue - a[1].totalRevenue)
                .forEach(([vaId, stats]) => {
                    const va = data.vas.find(v => v.id === vaId);
                    if (!va || stats.totalRevenue === 0) return;
                    
                    const performancePercent = totals.total > 0 ? (stats.totalRevenue / totals.total * 100).toFixed(1) : 0;
                    
                    html += `
                        <div style="background: ${isDarkMode ? '#1e293b' : '#f8fafc'}; border-radius: 1rem; padding: 2rem; border-left: 4px solid #f59e0b; position: relative; overflow: hidden;">
                            <!-- Performance bar background -->
                            <div style="position: absolute; top: 0; left: 0; width: ${performancePercent}%; height: 100%; background: ${isDarkMode ? 'rgba(245, 158, 11, 0.1)' : 'rgba(245, 158, 11, 0.05)'}; z-index: 0;"></div>
                            
                            <div style="position: relative; z-index: 1;">
                                <!-- Header -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                    <div>
                                        <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${va.name}</h3>
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">${performancePercent}% du total</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">${stats.totalRevenue.toFixed(2)}</div>
                                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Revenu total gnr</div>
                                    </div>
                                </div>
                                
                                <!-- Stats Grid -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1.5rem;">
                                    <!-- Subs -->
                                    <div style="background: ${isDarkMode ? 'rgba(59, 130, 246, 0.1)' : 'rgba(59, 130, 246, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(59, 130, 246, 0.2)' : 'rgba(59, 130, 246, 0.1)'};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-users" style="color: #3b82f6; font-size: 1rem;"></i>
                                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Subs</span>
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #3b82f6;">${stats.subsCount}</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">${stats.subsRevenue.toFixed(2)}</div>
                                    </div>
                                    
                                    <!-- Mdias -->
                                    <div style="background: ${isDarkMode ? 'rgba(16, 185, 129, 0.1)' : 'rgba(16, 185, 129, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(16, 185, 129, 0.2)' : 'rgba(16, 185, 129, 0.1)'};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-photo-video" style="color: #10b981; font-size: 1rem;"></i>
                                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Mdias</span>
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #10b981;">${stats.mediaRevenue.toFixed(2)}</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">vendus</div>
                                    </div>
                                    
                                    <!-- Commissions -->
                                    <div style="background: ${isDarkMode ? 'rgba(245, 158, 11, 0.1)' : 'rgba(245, 158, 11, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(245, 158, 11, 0.2)' : 'rgba(245, 158, 11, 0.1)'};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-percentage" style="color: #f59e0b; font-size: 1rem;"></i>
                                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Commissions</span>
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #f59e0b;">${stats.commissionsDue.toFixed(2)}</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">5% des mdias</div>
                                    </div>
                                    
                                    <!-- Total  payer -->
                                    <div style="background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : 'rgba(239, 68, 68, 0.1)'};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-hand-holding-usd" style="color: #ef4444; font-size: 1rem;"></i>
                                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};"> payer</span>
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #ef4444;">${((stats.subsRevenue + stats.commissionsDue) - (stats.paidAmount || 0)).toFixed(2)}</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">au VA</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            
            html += `</div>`;
            
            container.innerHTML = html;
        }

        function getFilteredSubsForFinancial() {
            if (!data.subs) return [];
            
            let filtered = [...data.subs];
            const now = new Date();
            
            switch (currentFinancialPeriod) {
                case 'current-week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(s => new Date(s.date) >= startOfWeek);
                    break;
                case 'current-month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filtered = filtered.filter(s => new Date(s.date) >= startOfMonth);
                    break;
                case 'last-month':
                    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                    filtered = filtered.filter(s => {
                        const date = new Date(s.date);
                        return date >= startOfLastMonth && date <= endOfLastMonth;
                    });
                    break;
            }
            
            return filtered;
        }

        function getFilteredRevenuesForFinancial() {
            if (!data.revenues) return [];
            
            let filtered = [...data.revenues];
            const now = new Date();
            
            switch (currentFinancialPeriod) {
                case 'current-week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(r => new Date(r.date) >= startOfWeek);
                    break;
                case 'current-month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filtered = filtered.filter(r => new Date(r.date) >= startOfMonth);
                    break;
                case 'last-month':
                    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                    filtered = filtered.filter(r => {
                        const date = new Date(r.date);
                        return date >= startOfLastMonth && date <= endOfLastMonth;
                    });
                    break;
            }
            
            return filtered;
        }

        function exportCompleteFinancialReport() {
            let csv = 'RAPPORT FINANCIER COMPLET\n';
            csv += `Priode: ${currentFinancialPeriod}\n`;
            csv += `Date d'export: ${new Date().toLocaleString('fr-FR')}\n\n`;
            
            // Summary
            const filteredSubs = getFilteredSubsForFinancial();
            const filteredRevenues = getFilteredRevenuesForFinancial();
            const totalSubsRevenue = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0);
            const totalMediaRevenue = filteredRevenues.reduce((sum, rev) => sum + rev.amount, 0);
            const totalCommissions = filteredRevenues.reduce((sum, rev) => sum + rev.commission, 0);
            
            csv += 'RSUM GLOBAL\n';
            csv += `Revenus Subs,${totalSubsRevenue.toFixed(2)}\n`;
            csv += `Revenus Mdias,${totalMediaRevenue.toFixed(2)}\n`;
            csv += `Total Brut,${(totalSubsRevenue + totalMediaRevenue).toFixed(2)}\n`;
            csv += `Commissions,${totalCommissions.toFixed(2)}\n`;
            csv += `Net,${(totalMediaRevenue - totalCommissions).toFixed(2)}\n\n`;
            
            // VA Details
            csv += 'DTAIL PAR VA\n';
            csv += 'VA,Subs Count,Subs Revenue,Media Revenue,Total Revenue,Commissions,Net Revenue\n';
            
            const vaFinancials = calculateCompleteVAFinancials();
            Object.entries(vaFinancials).forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (stats.totalRevenue > 0) {
                    csv += `${va ? va.name : 'VA supprim'},${stats.subsCount},${stats.subsRevenue.toFixed(2)},${stats.mediaRevenue.toFixed(2)},${stats.totalRevenue.toFixed(2)},${stats.commissionsDue.toFixed(2)},${stats.netRevenue.toFixed(2)}\n`;
                }
            });
            
            // Detailed transactions
            csv += '\n\nDTAIL DES SUBS\n';
            csv += 'Date,VA,Nombre,Montant\n';
            filteredSubs.forEach(sub => {
                const va = data.vas.find(v => v.id === sub.vaId);
                csv += `${sub.date},${va ? va.name : 'VA supprim'},${sub.count},${sub.amount.toFixed(2)}\n`;
            });
            
            csv += '\n\nDTAIL DES VENTES MDIAS\n';
            csv += 'Date,VA,Description,Montant USD,Taux,Montant EUR,Commission\n';
            filteredRevenues.forEach(rev => {
                const va = data.vas.find(v => v.id === rev.vaId);
                const usd = rev.amountUSD || (rev.amount / 0.92);
                csv += `${rev.date},${va ? va.name : 'VA supprim'},"${rev.description}",${usd.toFixed(2)},${rev.exchangeRate || 0.92},${rev.amount.toFixed(2)},${rev.commission.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rapport_financier_complet_${currentFinancialPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function updatePaymentHistoryTable() {
            const container = document.getElementById('payment-history-table');
            const payments = (data.vaPayments || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            
            if (payments.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; padding: 2rem;">Aucun paiement enregistr</p>`;
                return;
            }
            
            // Calculate total paid
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Group payments by VA
            const paymentsByVA = {};
            payments.forEach(payment => {
                if (!paymentsByVA[payment.vaId]) {
                    paymentsByVA[payment.vaId] = {
                        payments: [],
                        total: 0
                    };
                }
                paymentsByVA[payment.vaId].payments.push(payment);
                paymentsByVA[payment.vaId].total += payment.amount;
            });
            
            let html = `
                <!-- Payment Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #047857, #10b981)' : 'linear-gradient(135deg, #d1fae5, #a7f3d0)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#047857'};">${totalPaid.toFixed(2)}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#a7f3d0' : '#064e3b'}; margin-top: 0.5rem;">Total Pay</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1e3a8a, #2563eb)' : 'linear-gradient(135deg, #dbeafe, #bfdbfe)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#1e40af'};">${payments.length}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#bfdbfe' : '#3730a3'}; margin-top: 0.5rem;">Nombre de Paiements</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #5b21b6, #8b5cf6)' : 'linear-gradient(135deg, #e9d5ff, #c084fc)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#6b21a8'};">${Object.keys(paymentsByVA).length}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#e9d5ff' : '#581c87'}; margin-top: 0.5rem;">VAs Pays</div>
                    </div>
                </div>
                
                <!-- Payment Timeline Title -->
                <h4 style="margin-bottom: 2rem; font-size: 1.25rem; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'};">
                    <i class="fas fa-history"></i> Chronologie des Paiements
                </h4>
                
                <!-- Payment Cards Timeline -->
                <div style="display: grid; gap: 1.5rem;">
            `;
            
            // Add payment cards
            payments.forEach((payment, index) => {
                const va = data.vas.find(v => v.id === payment.vaId);
                const typeLabel = {
                    'subs': 'Subs',
                    'commissions': 'Commissions',
                    'both': 'Subs + Commissions',
                    'custom': 'Personnalis'
                }[payment.type] || payment.type;
                
                const typeColor = {
                    'subs': '#3b82f6',
                    'commissions': '#f59e0b',
                    'both': '#8b5cf6',
                    'custom': '#6b7280'
                }[payment.type] || '#6b7280';
                
                // Calculate time ago
                const paymentDate = new Date(payment.date);
                const today = new Date();
                const diffTime = today - paymentDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                let timeAgo = '';
                if (diffDays === 0) timeAgo = "Aujourd'hui";
                else if (diffDays === 1) timeAgo = "Hier";
                else if (diffDays < 7) timeAgo = `Il y a ${diffDays} jours`;
                else if (diffDays < 30) timeAgo = `Il y a ${Math.floor(diffDays / 7)} semaines`;
                else timeAgo = `Il y a ${Math.floor(diffDays / 30)} mois`;
                
                html += `
                    <div style="background: ${isDarkMode ? '#1e293b' : '#f8fafc'}; border-radius: 1rem; padding: 2rem; border-left: 4px solid ${typeColor}; position: relative;">
                        <!-- Delete button -->
                        <button onclick="deletePayment('${payment.id}')" style="position: absolute; top: 1rem; right: 1rem; background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)'}; border: 1px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : 'rgba(239, 68, 68, 0.1)'}; color: #ef4444; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)'}'">
                            <i class="fas fa-trash"></i>
                        </button>
                        
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'}; display: flex; align-items: center; gap: 1rem;">
                                    ${va ? va.name : 'VA supprim'}
                                    <span style="background: ${typeColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">${typeLabel}</span>
                                </h3>
                                <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">
                                    <span><i class="fas fa-calendar"></i> ${paymentDate.toLocaleDateString('fr-FR')}</span>
                                    <span><i class="fas fa-clock"></i> ${timeAgo}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem; font-weight: 700; color: #22c55e;">${payment.amount.toFixed(2)}</div>
                                <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};"><i class="fas fa-calendar-alt"></i> ${payment.period}</div>
                            </div>
                        </div>
                        
                        <!-- Payment Details Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: ${payment.note ? '1rem' : '0'};">
                            ${payment.subsAmount > 0 ? `
                                <div style="background: ${isDarkMode ? 'rgba(59, 130, 246, 0.1)' : 'rgba(59, 130, 246, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(59, 130, 246, 0.2)' : 'rgba(59, 130, 246, 0.1)'};">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-users" style="color: #3b82f6;"></i>
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Subs</span>
                                    </div>
                                    <div style="font-size: 1.25rem; font-weight: 600; color: #3b82f6;">${payment.subsAmount.toFixed(2)}</div>
                                </div>
                            ` : ''}
                            
                            ${payment.commissionsAmount > 0 ? `
                                <div style="background: ${isDarkMode ? 'rgba(245, 158, 11, 0.1)' : 'rgba(245, 158, 11, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(245, 158, 11, 0.2)' : 'rgba(245, 158, 11, 0.1)'};">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-percentage" style="color: #f59e0b;"></i>
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Commissions</span>
                                    </div>
                                    <div style="font-size: 1.25rem; font-weight: 600; color: #f59e0b;">${payment.commissionsAmount.toFixed(2)}</div>
                                </div>
                            ` : ''}
                            
                            <div style="background: ${isDarkMode ? 'rgba(147, 51, 234, 0.1)' : 'rgba(147, 51, 234, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(147, 51, 234, 0.2)' : 'rgba(147, 51, 234, 0.1)'};">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-check-circle" style="color: #9333ea;"></i>
                                    <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Statut</span>
                                </div>
                                <div style="font-size: 1rem; font-weight: 600; color: #9333ea;">Pay</div>
                            </div>
                        </div>
                        
                        ${payment.note ? `
                            <div style="background: ${isDarkMode ? 'rgba(107, 114, 128, 0.1)' : 'rgba(107, 114, 128, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #6b7280;">
                                <div style="display: flex; gap: 0.5rem; align-items: start;">
                                    <i class="fas fa-sticky-note" style="color: #6b7280; margin-top: 0.125rem;"></i>
                                    <div>
                                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; margin-bottom: 0.25rem;">Note</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#e2e8f0' : '#374151'};">${payment.note}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
            
            container.innerHTML = html;
        }
        
        // Delete Payment - SUPABASE VERSION
        async function deletePayment(paymentId) {
            if (!confirm('tes-vous sr de vouloir supprimer ce paiement?')) return;

            try {
                // Delete from Supabase
                await window.deletePayment(paymentId);

                // Remove from local data
                data.vaPayments = (data.vaPayments || []).filter(p => p.id !== paymentId);
                data.payments = (data.payments || []).filter(p => p.id !== paymentId);

                showSuccess('Paiement supprim!');

                // Update all displays
                updateFinancialOverview();
                if (document.getElementById('subs-page').style.display === 'block') {
                    updateSubsTable();
                    updateSubsStats();
                }
                if (document.getElementById('revenue-page').style.display === 'block') {
                    updateRevenueDisplay();
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                showError('Erreur lors de la suppression du paiement');
            }
        }

        // Initialize financial overview
        document.addEventListener('DOMContentLoaded', function() {
            setupFinancialOverview();
        });
        
        // ========== BACKUP SYSTEM FUNCTIONS ==========
        
        function showBackupModal() {
            updateBackupStats();
            updateBackupHistory();
            document.getElementById('backup-modal').style.display = 'flex';
        }
        
        // Afficher l'historique des sauvegardes
        function updateBackupHistory() {
            const container = document.getElementById('backup-history');
            if (!container) return;
            
            try {
                const history = JSON.parse(localStorage.getItem('vaManagerProBackupHistory') || '[]');
                
                if (history.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
                            <p style="margin-top: 0.5rem;">Aucune sauvegarde dans l'historique</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = history.map((backup, index) => {
                        const date = new Date(backup.timestamp);
                        const dateStr = date.toLocaleDateString();
                        const timeStr = date.toLocaleTimeString();
                        
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; 
                                        padding: 0.75rem; margin-bottom: 0.5rem; 
                                        background: rgba(0, 0, 0, 0.03); border-radius: 0.5rem;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">
                                        ${dateStr}  ${timeStr}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #64748b;">
                                        ${backup.data.vas?.length || 0} VAs  
                                        ${backup.data.gmailAccounts?.length || 0} Gmails
                                    </div>
                                </div>
                                <button onclick="restoreFromBackup(${index})" 
                                        class="action-btn" 
                                        style="background: #6366f1; color: white; padding: 0.5rem 1rem;">
                                    <i class="fas fa-undo"></i> Restaurer
                                </button>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Erreur affichage historique:', error);
                container.innerHTML = '<p style="color: #ef4444;">Erreur lors du chargement de l\'historique</p>';
            }
        }
        
        function closeBackupModal() {
            document.getElementById('backup-modal').style.display = 'none';
        }
        
        function exportAllData() {
            const exportData = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                data: {
                    vas: data.vas || [],
                    creators: data.creators || [],
                    associations: data.associations || [],
                    subs: data.subs || [],
                    revenues: data.revenues || [],
                    payments: data.payments || [],
                    vaPayments: data.vaPayments || []
                },
                settings: {
                    darkMode: localStorage.getItem('darkMode') === 'true',
                    autoSave: localStorage.getItem('autoSaveEnabled') === 'true'
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `va_manager_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            alert(' Sauvegarde tlcharge avec succs!');
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm(' Cela remplacera TOUTES vos donnes actuelles. Continuer?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importData.data || !importData.version) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Import data
                    data.vas = importData.data.vas || [];
                    data.creators = importData.data.creators || [];
                    data.associations = importData.data.associations || [];
                    data.subs = importData.data.subs || [];
                    data.revenues = importData.data.revenues || [];
                    data.payments = importData.data.payments || [];
                    data.vaPayments = importData.data.vaPayments || [];
                    
                    // Save to localStorage
                    saveData();
                    
                    // Apply settings if present
                    if (importData.settings) {
                        if (importData.settings.darkMode) {
                            localStorage.setItem('darkMode', 'true');
                        }
                        if (importData.settings.autoSave) {
                            localStorage.setItem('autoSaveEnabled', 'true');
                        }
                    }
                    
                    alert(' Donnes importes avec succs!');
                    
                    // Refresh page to apply all changes
                    location.reload();
                    
                } catch (error) {
                    alert(' Erreur lors de l\'import: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }
        
        
        function checkAutoSave() {
            const autoSaveEnabled = localStorage.getItem('autoSaveEnabled') === 'true';
            const nextAutoSave = localStorage.getItem('nextAutoSave');
            
            if (autoSaveEnabled && nextAutoSave) {
                const nextSaveDate = new Date(nextAutoSave);
                const now = new Date();
                
                if (now >= nextSaveDate) {
                    // Perform auto-save
                    exportAllData();
                    
                    // Set next auto-save
                    const nextSave = new Date();
                    nextSave.setDate(nextSave.getDate() + 7);
                    localStorage.setItem('nextAutoSave', nextSave.toISOString());
                    localStorage.setItem('lastAutoSave', now.toISOString());
                }
            }
        }
        
        function checkAutoSaveStatus() {
            const autoSaveEnabled = localStorage.getItem('autoSaveEnabled') === 'true';
            const lastAutoSave = localStorage.getItem('lastAutoSave');
            const nextAutoSave = localStorage.getItem('nextAutoSave');
            
            document.getElementById('auto-save-toggle').checked = autoSaveEnabled;
            
            const statusDiv = document.getElementById('last-auto-save');
            if (lastAutoSave) {
                const lastDate = new Date(lastAutoSave);
                statusDiv.innerHTML = `Dernire sauvegarde auto: ${lastDate.toLocaleDateString('fr-FR')}`;
            }
            if (nextAutoSave && autoSaveEnabled) {
                const nextDate = new Date(nextAutoSave);
                statusDiv.innerHTML += `<br>Prochaine sauvegarde: ${nextDate.toLocaleDateString('fr-FR')}`;
            }
        }
        
        function updateBackupStats() {
            const statsDiv = document.getElementById('backup-stats');
            if (!statsDiv) return;
            
            // Compter le nombre total de cratrices
            let totalCreators = 0;
            let totalAccounts = 0;
            data.vas.forEach(va => {
                totalCreators += (va.creators ? va.creators.length : 0);
                va.creators?.forEach(creator => {
                    totalAccounts += (creator.accounts ? creator.accounts.length : 0);
                });
            });
            
            const stats = {
                '<i class="fas fa-users"></i> VAs': (data.vas || []).length,
                '<i class="fas fa-star"></i> Cratrices': totalCreators,
                '<i class="fab fa-twitter"></i> Twitter': totalAccounts,
                '<i class="fas fa-envelope"></i> Gmail': (data.gmailAccounts || []).length,
                '<i class="fas fa-chart-line"></i> Revenus': (data.revenues || []).length,
                '<i class="fas fa-database"></i> Taille': formatBytes(JSON.stringify(data).length)
            };
            
            statsDiv.innerHTML = Object.entries(stats).map(([label, value]) => `
                <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.03); 
                           border-radius: 0.5rem;">
                    <div style="color: #64748b; margin-bottom: 0.5rem;">${label}</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">${value}</div>
                </div>
            `).join('');
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Check for auto-save on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAutoSave();
        });
        
        // ========== PAYMENT MANAGEMENT FUNCTIONS ==========
        
        function showPaymentModal() {
            const modal = document.getElementById('payment-modal');
            const vaSelect = document.getElementById('payment-va');
            const dateInput = document.getElementById('payment-date-modal');

            // Clear form
            document.getElementById('payment-form').reset();

            // Populate VAs with amount due
            vaSelect.innerHTML = '<option value="">Slectionnez une VA</option>';
            data.vas.forEach(va => {
                const unpaidSubs = calculateUnpaidSubsForVA(va.id);
                const unpaidCommissions = calculateUnpaidCommissionsForVA(va.id);
                const totalDue = unpaidSubs + unpaidCommissions;

                if (totalDue > 0) {
                    const option = document.createElement('option');
                    option.value = va.id;
                    option.textContent = `${va.name} (${totalDue.toFixed(2)}  payer)`;
                    vaSelect.appendChild(option);
                }
            });

            // Set today's date
            dateInput.value = new Date().toISOString().split('T')[0];

            // Reset amount field
            const amountInput = document.getElementById('payment-amount-modal');
            amountInput.readOnly = false;
            amountInput.value = '';

            // Show modal
            modal.style.display = 'flex';
        }
        
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
        }
        
        function fillTotalAmount() {
            const vaId = document.getElementById('payment-va').value;

            if (!vaId) {
                alert('Veuillez d\'abord slectionner une VA');
                return;
            }

            const unpaidSubs = calculateUnpaidSubsForVA(vaId);
            const unpaidCommissions = calculateUnpaidCommissionsForVA(vaId);
            const totalDue = unpaidSubs + unpaidCommissions;

            // Mettre le type sur "custom" pour que le champ reste ditable
            document.getElementById('payment-type').value = 'custom';

            // Remplir le montant
            document.getElementById('payment-amount-modal').value = totalDue.toFixed(2);

            // Appeler updatePaymentAmount pour mettre  jour l'affichage
            updatePaymentAmount();
        }
        
        function updatePaymentAmount() {
            const vaId = document.getElementById('payment-va').value;
            const type = document.getElementById('payment-type').value;
            const amountInput = document.getElementById('payment-amount-modal');
            const amountInfo = document.getElementById('payment-amount-info');
            
            if (!vaId) {
                amountInput.value = '';
                amountInput.readOnly = false;
                amountInfo.innerHTML = '';
                return;
            }
            
            // Calculate unpaid amounts for this VA
            const unpaidSubs = calculateUnpaidSubsForVA(vaId);
            const unpaidCommissions = calculateUnpaidCommissionsForVA(vaId);
            const totalDue = unpaidSubs + unpaidCommissions;
            
            // Always show what's due
            let infoHtml = `
                <div style="background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <strong>Reste  payer pour cette VA:</strong><br>
                     Subs: <span style="color: #dc2626;">${unpaidSubs.toFixed(2)}</span><br>
                     Commissions: <span style="color: #dc2626;">${unpaidCommissions.toFixed(2)}</span><br>
                    <strong>Total: <span style="color: #dc2626;">${totalDue.toFixed(2)}</span></strong>
                </div>
            `;
            
            if (!type) {
                amountInput.value = '';
                amountInput.readOnly = false;
                amountInfo.innerHTML = infoHtml;
                return;
            }
            
            switch(type) {
                case 'subs':
                    amountInput.value = unpaidSubs.toFixed(2);
                    amountInput.readOnly = true;
                    amountInfo.innerHTML = infoHtml + `<div style="color: #059669;">Paiement des subs uniquement</div>`;
                    break;
                case 'commissions':
                    amountInput.value = unpaidCommissions.toFixed(2);
                    amountInput.readOnly = true;
                    amountInfo.innerHTML = infoHtml + `<div style="color: #059669;">Paiement des commissions uniquement</div>`;
                    break;
                case 'both':
                    amountInput.value = totalDue.toFixed(2);
                    amountInput.readOnly = true;
                    amountInfo.innerHTML = infoHtml + `<div style="color: #059669;">Paiement total (subs + commissions)</div>`;
                    break;
                case 'custom':
                    amountInput.readOnly = false;
                    amountInfo.innerHTML = infoHtml + `<div style="color: #0891b2;">Entrez le montant que vous souhaitez payer</div>`;
                    break;
            }
        }
        
        function calculateUnpaidSubsForVA(vaId) {
            const allSubs = (data.subs || [])
                .filter(sub => sub.vaId === vaId)
                .reduce((sum, sub) => sum + sub.amount, 0);
                
            const paidSubs = (data.vaPayments || [])
                .filter(p => p.vaId === vaId && (p.type === 'subs' || p.type === 'both'))
                .reduce((sum, p) => sum + (p.subsAmount || 0), 0);
                
            return Math.max(0, allSubs - paidSubs);
        }
        
        function calculateUnpaidCommissionsForVA(vaId) {
            const allCommissions = (data.revenues || [])
                .filter(rev => rev.vaId === vaId)
                .reduce((sum, rev) => sum + rev.commission, 0);
                
            const paidCommissions = (data.vaPayments || [])
                .filter(p => p.vaId === vaId && (p.type === 'commissions' || p.type === 'both'))
                .reduce((sum, p) => sum + (p.commissionsAmount || 0), 0);
                
            return Math.max(0, allCommissions - paidCommissions);
        }
        
        function handlePaymentSubmit(event) {
            event.preventDefault();

            const vaId = document.getElementById('payment-va').value;
            const type = document.getElementById('payment-type').value;
            const period = document.getElementById('payment-period-modal').value;
            const amount = parseFloat(document.getElementById('payment-amount-modal').value);
            const date = document.getElementById('payment-date-modal').value;
            const note = document.getElementById('payment-note').value;
            
            // Initialize vaPayments if not exists
            if (!data.vaPayments) {
                data.vaPayments = [];
            }
            
            // Calculate component amounts based on type
            let subsAmount = 0;
            let commissionsAmount = 0;
            
            if (type === 'subs') {
                subsAmount = amount;
            } else if (type === 'commissions') {
                commissionsAmount = amount;
            } else if (type === 'both') {
                // Split proportionally based on unpaid amounts
                const unpaidSubs = calculateUnpaidSubsForVA(vaId);
                const unpaidCommissions = calculateUnpaidCommissionsForVA(vaId);
                const totalUnpaid = unpaidSubs + unpaidCommissions;
                if (totalUnpaid > 0) {
                    subsAmount = amount * (unpaidSubs / totalUnpaid);
                    commissionsAmount = amount * (unpaidCommissions / totalUnpaid);
                }
            } else if (type === 'custom') {
                // For custom, we'll apply to oldest unpaid first
                const unpaidSubs = calculateUnpaidSubsForVA(vaId);
                const unpaidCommissions = calculateUnpaidCommissionsForVA(vaId);
                
                if (amount <= unpaidSubs) {
                    subsAmount = amount;
                } else {
                    subsAmount = unpaidSubs;
                    commissionsAmount = Math.min(amount - unpaidSubs, unpaidCommissions);
                }
            }
            
            const payment = {
                id: generateId(),
                vaId: vaId,
                type: type,
                amount: amount,
                subsAmount: subsAmount,
                commissionsAmount: commissionsAmount,
                period: period,
                date: date,
                note: note,
                createdAt: new Date().toISOString()
            };
            
            data.vaPayments.push(payment);
            saveData();
            
            alert('Paiement enregistr avec succs!');
            closePaymentModal();
            
            // Update all relevant displays
            if (document.getElementById('subs-page').style.display === 'block') {
                updateSubsTable();
                updateSubsStats();
            }
            if (document.getElementById('revenue-page').style.display === 'block') {
                updateRevenueDisplay();
            }
            if (document.getElementById('financial-overview-page').style.display === 'block') {
                updateFinancialOverview();
            }
            if (document.getElementById('instagram-warmup-page').style.display === 'block') {
                updateWarmupDisplay();
            }
        }

        // ============================================================================
        // WARM-UP FUNCTIONS
        // ============================================================================

        // Initialize warmup data structure
        // Lazy load warmup data from Supabase when needed
        async function loadWarmupDataIfNeeded() {
            // Check if warmup data is already loaded
            if (data.warmupProgress && Object.keys(data.warmupProgress).length > 0) {
                console.log(' Warmup data already loaded, skipping');
                return;
            }

            console.log(' Loading warmup data from Supabase...');
            try {
                const warmupArray = await getWarmupProgress();

                // Convert array to object format: { username: { currentDay, completed, ... } }
                data.warmupProgress = {};
                (warmupArray || []).forEach(w => {
                    data.warmupProgress[w.username] = {
                        currentDay: w.current_day,
                        completed: w.completed,
                        startDate: w.start_date,
                        completedDate: w.completed_date,
                        lastUpdate: w.last_update
                    };
                });

                console.log(` Loaded ${Object.keys(data.warmupProgress).length} warmup entries from Supabase`);
            } catch (error) {
                console.error(' Error loading warmup data:', error);
                data.warmupProgress = {};
            }
        }

        function initializeWarmupData() {
            if (!data.warmupProgress) {
                // Initialize empty if not loaded from Supabase yet
                data.warmupProgress = {};
                console.log(' Warmup data not loaded from Supabase, initializing empty object');
            }
        }

        // Sauvegarder les donnes de warmup dans Supabase
        async function saveWarmupData() {
            // This function is deprecated - warmup is now saved directly via upsertWarmupProgress
            // Keeping for compatibility but it does nothing
            console.log(' saveWarmupData() called but warmup is now saved directly to Supabase');
        }

        // Update warmup display
        function updateWarmupDisplay() {
            const container = document.getElementById('warmup-accounts-list');
            if (!container) return;

            // Toujours initialiser les donnes de warmup au dbut
            initializeWarmupData();

            const isDarkMode = document.body.classList.contains('dark-mode');

            // Collecter tous les comptes Instagram avec leurs VAs
            let allInstagramAccounts = [];
            let vaList = new Set();

            // D'abord, vrifier s'il y a des VAs dans les donnes
            if (data.vas && data.vas.length > 0) {
                console.log('VAs disponibles dans data.vas:', data.vas.map(v => v.name));
                // Ajouter toutes les VAs existantes pour s'assurer qu'elles apparaissent dans le filtre
                data.vas.forEach(va => {
                    if (va.name) {
                        vaList.add(va.name);
                    }
                });
            }

            // Alternative : chercher les VAs depuis les cratrices si data.vas est vide
            if ((!data.vas || data.vas.length === 0) && data.creators) {
                console.log('Pas de VAs dans data.vas, recherche dans les cratrices...');
                const vaNames = new Set();
                data.creators.forEach(creator => {
                    if (creator.va && typeof creator.va === 'string') {
                        vaNames.add(creator.va);
                    }
                });
                if (vaNames.size > 0) {
                    console.log('VAs trouves depuis les cratrices:', Array.from(vaNames));
                    vaNames.forEach(name => vaList.add(name));
                }
            }

            // 1. Depuis data.instagramAccounts
            if (data.instagramAccounts && data.instagramAccounts.length > 0) {
                console.log('=== COMPTES INSTAGRAM DIRECTS ===');
                console.log('data.instagramAccounts:', data.instagramAccounts);

                data.instagramAccounts.forEach(account => {
                    const accountWithVA = {...account};
                    const username = (account.username || account.handle || '').replace('@', '');
                    console.log(`Traitement compte Instagram: @${username}, vaId: ${account.vaId}, status: ${account.status}`);

                    // Utiliser directement le vaId du compte pour trouver la VA
                    if (account.vaId && data.vas) {
                        const va = data.vas.find(v => v.id === account.vaId);
                        if (va) {
                            accountWithVA.vaName = va.name;
                            accountWithVA.vaId = account.vaId;
                            console.log(`VA trouve via vaId: ${va.name}`);
                        }
                    }

                    // Si pas de VA trouve via vaId, essayer d'autres mthodes
                    if (!accountWithVA.vaName) {
                        // Vrifier si le compte a directement une VA
                        if (account.va) {
                            if (typeof account.va === 'string') {
                                accountWithVA.vaName = account.va;
                                console.log(`VA directe trouve: ${account.va}`);
                            } else if (account.va.name) {
                                accountWithVA.vaName = account.va.name;
                                console.log(`VA directe trouve (objet): ${account.va.name}`);
                            }
                        }

                        // Sinon, trouver via le creator
                        if (!accountWithVA.vaName && account.creatorId && data.creators) {
                            const creator = data.creators.find(c => c.id === account.creatorId);
                            if (creator && creator.vaId && data.vas) {
                                const va = data.vas.find(v => v.id === creator.vaId);
                                if (va) {
                                    accountWithVA.vaName = va.name;
                                    accountWithVA.vaId = creator.vaId;
                                    console.log(`VA trouve via creator vaId: ${va.name}`);
                                }
                            }
                        }
                    }

                    allInstagramAccounts.push(accountWithVA);
                });
            }

            // 2. Depuis les cratrices
            if (data.creators) {
                console.log('Parcours des cratrices pour trouver les comptes Instagram...');
                data.creators.forEach(creator => {
                    console.log('Creator:', creator);
                    console.log('Creator name:', creator.name, 'va field:', creator.va, 'vaId:', creator.vaId);

                    // Trouver la VA de la cratrice - vrifier tous les champs possibles
                    let creatorVaName = null;

                    // Vrifier le champ 'va' direct (peut tre un string ou un objet)
                    if (creator.va) {
                        if (typeof creator.va === 'string') {
                            creatorVaName = creator.va;
                            console.log(`VA trouve depuis creator.va (string): ${creatorVaName}`);
                        } else if (typeof creator.va === 'object' && creator.va.name) {
                            creatorVaName = creator.va.name;
                            console.log(`VA trouve depuis creator.va.name: ${creatorVaName}`);
                        }
                    }

                    // Si pas trouv, essayer avec vaId
                    if (!creatorVaName && creator.vaId && data.vas) {
                        const va = data.vas.find(v => v.id === creator.vaId);
                        if (va) {
                            creatorVaName = va.name;
                            console.log(`VA trouve depuis vaId lookup: ${creatorVaName}`);
                        }
                    }

                    // Si pas trouv, essayer avec le champ vaName
                    if (!creatorVaName && creator.vaName) {
                        creatorVaName = creator.vaName;
                        console.log(`VA trouve depuis creator.vaName: ${creatorVaName}`);
                    }

                    // Gestion des comptes Instagram dans les cratrices
                    if (creator.instagram) {
                        // Si le compte Instagram est directement dans le champ 'instagram'
                        const accountWithVA = {
                            username: creator.instagram.replace('@', ''),
                            creatorName: creator.name
                        };

                        // Ajouter l'info de la VA
                        if (creatorVaName) {
                            accountWithVA.vaName = creatorVaName;
                            accountWithVA.vaId = creator.vaId;
                            console.log(`Compte Instagram @${accountWithVA.username} associ  VA: ${creatorVaName}`);
                        }

                        if (!allInstagramAccounts.find(a => a.username === accountWithVA.username)) {
                            allInstagramAccounts.push(accountWithVA);
                        }
                    }

                    // Gestion des comptes Instagram dans instagramAccounts array
                    if (creator.instagramAccounts && Array.isArray(creator.instagramAccounts)) {
                        creator.instagramAccounts.forEach(account => {
                            if (!allInstagramAccounts.find(a => a.username === account.username)) {
                                const accountWithVA = {...account};
                                accountWithVA.creatorName = creator.name;

                                // Ajouter l'info de la VA
                                if (creatorVaName) {
                                    accountWithVA.vaName = creatorVaName;
                                    accountWithVA.vaId = creator.vaId;
                                    console.log(`Compte Instagram @${account.username} associ  VA: ${creatorVaName}`);
                                }

                                allInstagramAccounts.push(accountWithVA);
                            }
                        });
                    }
                });
            }

            // Analyser les comptes collects
            console.log('=== ANALYSE FINALE ===');
            console.log('Total comptes Instagram collects:', allInstagramAccounts.length);
            console.log('Comptes avec VA assigne:', allInstagramAccounts.filter(a => a.vaName).length);
            console.log('Comptes sans VA assigne:', allInstagramAccounts.filter(a => !a.vaName).length);

            // Afficher les comptes par VA
            const accountsByVA = {};
            allInstagramAccounts.forEach(account => {
                const va = account.vaName || 'Sans VA';
                if (!accountsByVA[va]) accountsByVA[va] = [];
                accountsByVA[va].push(account.username || account.handle || 'unknown');
            });
            console.log('Comptes par VA:', accountsByVA);

            // Mettre  jour le select des VAs
            const vaFilter = document.getElementById('warmup-va-filter');
            if (vaFilter) {
                console.log('VAs trouves pour le filtre:', Array.from(vaList));
                const currentValue = vaFilter.value;
                vaFilter.innerHTML = '<option value="all"> Tous les VAs</option>';
                Array.from(vaList).sort().forEach(vaName => {
                    const option = document.createElement('option');
                    option.value = vaName;
                    option.textContent = ` ${vaName}`;
                    vaFilter.appendChild(option);
                });
                // Restaurer la valeur slectionne
                if (currentValue && Array.from(vaFilter.options).some(opt => opt.value === currentValue)) {
                    vaFilter.value = currentValue;
                } else {
                    vaFilter.value = 'all';
                }
            }

            // Filtrer par VA si ncessaire
            const selectedVA = vaFilter ? vaFilter.value : 'all';
            let filteredAccounts = allInstagramAccounts;

            if (selectedVA !== 'all') {
                console.log(`Filtrage pour VA: ${selectedVA}`);
                filteredAccounts = allInstagramAccounts.filter(account => {
                    console.log(`Compte ${account.username}: vaName="${account.vaName}"`);
                    return account.vaName === selectedVA;
                });
                console.log(`Comptes filtrs pour ${selectedVA}:`, filteredAccounts);
            }

            console.log('Comptes Instagram  afficher:', filteredAccounts);

            if (filteredAccounts.length === 0) {
                const message = selectedVA !== 'all'
                    ? `Aucun compte Instagram trouv pour ${selectedVA}`
                    : 'Aucun compte Instagram trouv';
                const subMessage = selectedVA !== 'all'
                    ? 'Assignez des comptes Instagram  cette VA pour commencer le warm-up'
                    : 'Ajoutez des comptes Instagram pour commencer le warm-up';

                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                        <i class="fab fa-instagram" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">${message}</p>
                        <p style="font-size: 0.875rem;">${subMessage}</p>
                    </div>
                `;
                updateWarmupStats(filteredAccounts);
                return;
            }

            // Initialize warmup data
            initializeWarmupData();

            // Generate cards for each Instagram account (utiliser filteredAccounts)
            container.innerHTML = filteredAccounts.map(account => {
                // Nettoyer le username (enlever le @)
                const username = (account.username || '').replace('@', '');
                const warmupData = data.warmupProgress[username] || {
                    currentDay: 0,
                    startDate: null,
                    completed: false
                };

                const isCompleted = warmupData.currentDay >= 6;
                const isStarted = warmupData.currentDay > 0;

                // Debug: log account status
                console.log(` Card pour @${username}: status="${account.status}"`);

                const isBanned = account.status === 'banned';
                const borderStyle = isBanned
                    ? 'border: 3px solid #ef4444; box-shadow: 0 0 0 1px #ef4444;'
                    : 'border: 3px solid #10b981; box-shadow: 0 0 0 1px #10b981;';

                return `
                    <div class="warmup-card ${isCompleted ? 'completed' : ''}" data-va="${account.vaName || ''}" style="${borderStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600;">
                                    <i class="fab fa-instagram" style="color: #e4405f;"></i>
                                    <a href="https://instagram.com/${username}"
                                       target="_blank"
                                       style="color: inherit; text-decoration: none; transition: color 0.2s;"
                                       onmouseover="this.style.color='#e4405f'"
                                       onmouseout="this.style.color='inherit'">
                                        ${account.username.startsWith('@') ? account.username : '@' + username}
                                    </a>
                                </h3>
                                <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                    ${account.vaName ? `
                                        <div style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 1rem;">
                                            <i class="fas fa-user-tie" style="color: #6366f1; font-size: 0.75rem;"></i>
                                            <span style="color: #6366f1; font-weight: 600; font-size: 0.875rem;">${account.vaName}</span>
                                        </div>
                                    ` : ''}
                                    ${account.status === 'banned' ? `
                                        <div style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 1rem;">
                                            <i class="fas fa-ban" style="color: #ef4444; font-size: 0.75rem;"></i>
                                            <span style="color: #ef4444; font-weight: 600; font-size: 0.875rem;">BANNI</span>
                                        </div>
                                    ` : `
                                        <div style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 1rem;">
                                            <i class="fas fa-check-circle" style="color: #10b981; font-size: 0.75rem;"></i>
                                            <span style="color: #10b981; font-weight: 600; font-size: 0.875rem;">ACTIF</span>
                                        </div>
                                    `}
                                </div>
                                ${account.creatorName ? `
                                    <span style="margin-left: 0.5rem; font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                                        (${account.creatorName})
                                    </span>
                                ` : ''}
                                ${warmupData.startDate ? `
                                    <div style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; margin-top: 0.5rem;">
                                        <i class="fas fa-calendar"></i> Dmarr le ${new Date(warmupData.startDate).toLocaleDateString('fr-FR')}
                                    </div>
                                ` : ''}
                            </div>
                            ${isCompleted ? `
                                <span style="background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> Termin
                                </span>
                            ` : isStarted ? `
                                <span style="background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">
                                    Jour ${warmupData.currentDay}/6
                                </span>
                            ` : `
                                <span style="background: #6b7280; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 600;">
                                    Non dmarr
                                </span>
                            `}
                        </div>

                        <!-- Progress circles -->
                        <div class="warmup-progress">
                            ${[1, 2, 3, 4, 5, 6].map(day => {
                                const status = day < warmupData.currentDay ? 'done' :
                                             day === warmupData.currentDay ? 'current' : 'pending';
                                return `
                                    <div class="warmup-day ${status}"
                                         onclick="showWarmupTasks(${day}, '${username}')"
                                         title="Jour ${day}">
                                        ${day}
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Action buttons -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            ${!isCompleted ? `
                                ${warmupData.currentDay === 0 ? `
                                    <button onclick="startWarmup('${username}')"
                                            style="flex: 1; padding: 0.5rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-play"></i> Dmarrer
                                    </button>
                                ` : `
                                    <button onclick="completeDay('${username}')"
                                            style="flex: 1; padding: 0.5rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-check"></i> Jour ${warmupData.currentDay} termin
                                    </button>
                                    ${warmupData.currentDay > 1 ? `
                                        <button onclick="undoDay('${username}')"
                                                style="padding: 0.5rem 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                            <i class="fas fa-undo"></i> Annuler
                                        </button>
                                    ` : ''}
                                `}
                            ` : `
                                <button onclick="resetWarmup('${username}')"
                                        style="flex: 1; padding: 0.5rem; background: #6b7280; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-redo"></i> Recommencer
                                </button>
                            `}
                            <button onclick="showWarmupDetails('${account.username}')"
                                    style="padding: 0.5rem 1rem; background: rgba(107, 114, 128, 0.1); color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; border: 1px solid rgba(107, 114, 128, 0.2); border-radius: 0.5rem; cursor: pointer;">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            updateWarmupStats(filteredAccounts);
        }

        // Update warmup statistics
        function updateWarmupStats(accountsList) {
            // Utiliser la liste fournie ou collecter tous les comptes
            let allInstagramAccounts = accountsList || [];

            // Si pas de liste fournie, collecter tous les comptes
            if (!accountsList) {
                if (data.instagramAccounts && data.instagramAccounts.length > 0) {
                    allInstagramAccounts = [...data.instagramAccounts];
                }

                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.instagramAccounts) {
                            creator.instagramAccounts.forEach(account => {
                                if (!allInstagramAccounts.find(a => a.username === account.username)) {
                                    allInstagramAccounts.push(account);
                                }
                            });
                        }
                    });
                }
            }

            if (allInstagramAccounts.length === 0) {
                document.getElementById('warmup-completed').textContent = 0;
                document.getElementById('warmup-in-progress').textContent = 0;
                document.getElementById('warmup-not-started').textContent = 0;
                document.getElementById('warmup-total').textContent = 0;
                return;
            }

            let completed = 0;
            let inProgress = 0;
            let notStarted = 0;

            allInstagramAccounts.forEach(account => {
                // Nettoyer le username (enlever le @)
                const username = (account.username || '').replace('@', '');
                const warmupData = data.warmupProgress?.[username];
                if (!warmupData || warmupData.currentDay === 0) {
                    notStarted++;
                } else if (warmupData.currentDay >= 6) {
                    completed++;
                } else {
                    inProgress++;
                }
            });

            document.getElementById('warmup-completed').textContent = completed;
            document.getElementById('warmup-in-progress').textContent = inProgress;
            document.getElementById('warmup-not-started').textContent = notStarted;
            document.getElementById('warmup-total').textContent = allInstagramAccounts.length;
        }

        // Start warmup for an account
        async function startWarmup(username) {
            initializeWarmupData();

            const timestamp = new Date().toISOString();
            data.warmupProgress[username] = {
                currentDay: 1,
                startDate: timestamp,
                completed: false,
                lastUpdate: timestamp
            };

            // Save to Supabase
            try {
                await upsertWarmupProgress({
                    username: username,
                    current_day: 1,
                    completed: false,
                    start_date: timestamp
                });
                console.log(' Warmup dmarr dans Supabase pour', username);
            } catch (error) {
                console.error(' Erreur lors du dmarrage du warmup:', error);
                showError('Erreur lors du dmarrage du warmup');
                return;
            }

            updateWarmupDisplay();
            showSuccess(`Warm-up dmarr pour @${username} - Jour 1`);
            showWarmupTasks(1, username);
        }

        // Complete current day
        async function completeDay(username) {
            if (!data.warmupProgress[username]) return;

            const currentDay = data.warmupProgress[username].currentDay;
            const timestamp = new Date().toISOString();

            if (currentDay < 6) {
                // Advance to next day
                data.warmupProgress[username].currentDay++;
                data.warmupProgress[username].lastUpdate = timestamp;

                try {
                    await upsertWarmupProgress({
                        username: username,
                        current_day: data.warmupProgress[username].currentDay,
                        completed: false,
                        start_date: data.warmupProgress[username].startDate
                    });
                    console.log(' Warmup avanc au jour', data.warmupProgress[username].currentDay);
                } catch (error) {
                    console.error(' Erreur lors de l\'avancement du warmup:', error);
                    showError('Erreur lors de l\'avancement du warmup');
                    return;
                }

                showSuccess(`Jour ${currentDay} termin ! Passage au jour ${currentDay + 1}`);
            } else {
                // Complete warmup
                data.warmupProgress[username].completed = true;
                data.warmupProgress[username].completedDate = timestamp;
                data.warmupProgress[username].lastUpdate = timestamp;

                try {
                    await upsertWarmupProgress({
                        username: username,
                        current_day: 6,
                        completed: true,
                        start_date: data.warmupProgress[username].startDate,
                        completed_date: timestamp
                    });
                    console.log(' Warmup termin dans Supabase');
                } catch (error) {
                    console.error(' Erreur lors de la finalisation du warmup:', error);
                    showError('Erreur lors de la finalisation du warmup');
                    return;
                }

                showSuccess(` Warm-up termin pour @${username} !`);
            }

            updateWarmupDisplay();
        }

        async function undoDay(username) {
            if (!data.warmupProgress[username]) return;

            const currentDay = data.warmupProgress[username].currentDay;

            // Ne peut pas revenir en arrire si au jour 1
            if (currentDay <= 1) {
                showError('Impossible de revenir en arrire depuis le jour 1');
                return;
            }

            const timestamp = new Date().toISOString();

            // Revenir au jour prcdent
            data.warmupProgress[username].currentDay--;
            data.warmupProgress[username].completed = false;
            data.warmupProgress[username].completedDate = null;
            data.warmupProgress[username].lastUpdate = timestamp;

            try {
                await upsertWarmupProgress({
                    username: username,
                    current_day: data.warmupProgress[username].currentDay,
                    completed: false,
                    start_date: data.warmupProgress[username].startDate,
                    completed_date: null
                });
                console.log(' Warmup revenu au jour', data.warmupProgress[username].currentDay);
            } catch (error) {
                console.error(' Erreur lors du retour en arrire:', error);
                showError('Erreur lors du retour en arrire');
                return;
            }

            showSuccess(`Retour au jour ${data.warmupProgress[username].currentDay}`);
            updateWarmupDisplay();
        }

        // Reset warmup for an account
        async function resetWarmup(username) {
            if (confirm(`tes-vous sr de vouloir rinitialiser le warm-up pour @${username} ?`)) {
                if (data.warmupProgress[username]) {
                    try {
                        await deleteWarmupProgress(username);
                        delete data.warmupProgress[username];
                        console.log(' Warmup supprim de Supabase pour', username);
                    } catch (error) {
                        console.error(' Erreur lors de la suppression du warmup:', error);
                        showError('Erreur lors de la suppression du warmup');
                        return;
                    }
                    updateWarmupDisplay();
                    showSuccess(`Warm-up rinitialis pour @${username}`);
                }
            }
        }

        // Reset all warmups
        async function resetAllWarmups() {
            if (confirm('tes-vous sr de vouloir rinitialiser TOUS les warm-ups ?')) {
                // Delete all warmup entries from Supabase
                const usernames = Object.keys(data.warmupProgress);
                try {
                    for (const username of usernames) {
                        await deleteWarmupProgress(username);
                    }
                    data.warmupProgress = {};
                    console.log(' Tous les warmups supprims de Supabase');
                } catch (error) {
                    console.error(' Erreur lors de la suppression des warmups:', error);
                    showError('Erreur lors de la suppression des warmups');
                    return;
                }
                updateWarmupDisplay();
                showSuccess('Tous les warm-ups ont t rinitialiss');
            }
        }

        // Filter warmup by VA
        function filterWarmupByVA() {
            updateWarmupDisplay();
        }

        // Show warmup tasks for a specific day
        function showWarmupTasks(day, username) {
            const tasks = {
                1: [
                    " Crer le compte Instagram",
                    " Ajouter un nom de profil",
                    " PAS de photo de profil",
                    " Suivre les profils recommands",
                    " Ne rien faire d'autre"
                ],
                2: [
                    " Passer le compte en priv",
                    " Ajouter une photo de profil",
                    " Scroller 10-15 min max:",
                    "   Liker 1 reel / 6-8 swipes",
                    "   Commenter 1 reel / 9-11 swipes",
                    "   Liker 5 commentaires / 14-16 swipes"
                ],
                3: [
                    " Poster 1 carrousel (2 photos)",
                    " Ajouter musique virale + localisation US",
                    " S'abonner  5 modles OF (France)",
                    " Cliquer sur leurs liens OnlyFans"
                ],
                4: [
                    " Poster 1 carrousel (2 photos)",
                    " Musique virale + localisation US",
                    " Scroller lentement:",
                    "   Liker 1 reel / 6-8 swipes",
                    "   Commenter 1 reel / 9-11 swipes",
                    "   Liker 5 commentaires / 14-16 swipes"
                ],
                5: [
                    " Poster 1 carrousel (2 photos)",
                    " Musique virale + localisation US",
                    " Scroller (rythme augment):",
                    "   Liker 1 reel / 4-6 swipes",
                    "   Commenter 1 reel / 6-8 swipes",
                    "   Liker 5 commentaires / 9-11 swipes"
                ],
                6: [
                    " Passer le compte en PUBLIC",
                    " Ajouter le lien en bio",
                    " Warm-up termin !",
                    " Compte prt  l'utilisation"
                ]
            };

            const taskList = tasks[day] || [];

            alert(` Jour ${day} - @${username}\n\n${taskList.join('\n')}`);
        }

        // Show warmup details
        function showWarmupDetails(username) {
            const warmupData = data.warmupProgress?.[username];

            if (!warmupData) {
                alert(`@${username}\n\nStatut: Non dmarr\n\nCliquez sur "Dmarrer" pour commencer le warm-up.`);
                return;
            }

            const daysSinceStart = warmupData.startDate ?
                Math.floor((new Date() - new Date(warmupData.startDate)) / (1000 * 60 * 60 * 24)) : 0;

            alert(` Dtails du warm-up - @${username}\n\n` +
                  `Statut: ${warmupData.completed ? 'Termin ' : `En cours (Jour ${warmupData.currentDay}/6)`}\n` +
                  `Date de dbut: ${warmupData.startDate ? new Date(warmupData.startDate).toLocaleDateString('fr-FR') : 'N/A'}\n` +
                  `Jours couls: ${daysSinceStart}\n` +
                  `Progression: ${Math.round((warmupData.currentDay / 6) * 100)}%`);
        }
    </script>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2> Enregistrer un Paiement</h2>
            <form id="payment-form" onsubmit="handlePaymentSubmit(event)">
                <div class="form-group">
                    <label for="payment-va">Cratrice VA *</label>
                    <select id="payment-va" class="form-control" required onchange="updatePaymentAmount()">
                        <option value="">Slectionnez une VA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-type">Type de paiement *</label>
                    <select id="payment-type" class="form-control" required onchange="updatePaymentAmount()">
                        <option value="">Slectionnez le type</option>
                        <option value="subs">Paiement Subs uniquement</option>
                        <option value="commissions">Paiement Commissions uniquement</option>
                        <option value="both">Paiement Subs + Commissions</option>
                        <option value="custom">Montant personnalis</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-period-modal">Priode concerne *</label>
                    <input type="text" id="payment-period-modal" class="form-control" placeholder="ex: Semaine du 01/01 au 07/01" required>
                </div>
                <div class="form-group">
                    <label for="payment-amount-modal">Montant () *</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" id="payment-amount-modal" class="form-control" step="0.01" required style="flex: 1;">
                        <button type="button" onclick="fillTotalAmount()" class="btn-icon" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; background: #667eea; color: white; border-radius: 0.375rem;">
                            <i class="fas fa-calculator"></i> Total
                        </button>
                    </div>
                    <small id="payment-amount-info" style="color: #64748b; display: block; margin-top: 0.5rem;"></small>
                </div>
                <div class="form-group">
                    <label for="payment-date-modal">Date du paiement *</label>
                    <input type="date" id="payment-date-modal" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="payment-note">Note (optionnel)</label>
                    <textarea id="payment-note" class="form-control" rows="2" placeholder="Ex: Virement bancaire, PayPal..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closePaymentModal()">Annuler</button>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-check"></i> Enregistrer le Paiement
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Backup Modal -->
    <div id="backup-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2> Centre de Scurit des Donnes</h2>
            
            <div style="display: grid; gap: 1.5rem;">
                <!-- Status Section -->
                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.05)); 
                            padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-shield-alt" style="font-size: 2rem; color: #22c55e;"></i>
                        <div>
                            <h3 style="color: #22c55e; margin: 0;">Protection Active</h3>
                            <p style="margin: 0.25rem 0; font-size: 0.875rem; color: #64748b;">
                                Sauvegarde automatique toutes les 5 minutes  10 sauvegardes conserves
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <!-- Export -->
                    <div style="background: rgba(34, 197, 94, 0.05); padding: 1.5rem; border-radius: 0.75rem; 
                                border: 1px solid rgba(34, 197, 94, 0.2);">
                        <h3 style="color: #22c55e; margin-bottom: 1rem; font-size: 1.1rem;">
                            <i class="fas fa-download"></i> Exporter
                        </h3>
                        <button onclick="exportAllData()" class="submit-btn" style="background: #22c55e; width: 100%;">
                            Tlcharger maintenant
                        </button>
                        <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                            Sauvegarde complte au format JSON
                        </small>
                    </div>
                    
                    <!-- Import -->
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 1.5rem; border-radius: 0.75rem; 
                                border: 1px solid rgba(59, 130, 246, 0.2);">
                        <h3 style="color: #3b82f6; margin-bottom: 1rem; font-size: 1.1rem;">
                            <i class="fas fa-upload"></i> Importer
                        </h3>
                        <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImport(event)">
                        <button onclick="document.getElementById('import-file').click()" 
                                class="submit-btn" style="background: #3b82f6; width: 100%;">
                            Charger un fichier
                        </button>
                        <small style="display: block; margin-top: 0.5rem; color: #ef4444;">
                             Remplace toutes les donnes
                        </small>
                    </div>
                </div>
                
                <!-- Backup History -->
                <div style="background: rgba(99, 102, 241, 0.05); padding: 1.5rem; border-radius: 0.75rem; 
                            border: 1px solid rgba(99, 102, 241, 0.2);">
                    <h3 style="color: #6366f1; margin-bottom: 1rem;">
                        <i class="fas fa-history"></i> Historique des Sauvegardes
                    </h3>
                    <div id="backup-history" style="max-height: 300px; overflow-y: auto;">
                        <!-- L'historique sera affich ici -->
                    </div>
                </div>
                
                <!-- Stats -->
                <div style="background: rgba(147, 51, 234, 0.05); padding: 1.5rem; border-radius: 0.75rem; 
                            border: 1px solid rgba(147, 51, 234, 0.2);">
                    <h3 style="color: #9333ea; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-chart-bar"></i> Statistiques
                    </h3>
                    <div id="backup-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <!-- Stats will be inserted here -->
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="closeBackupModal()">Fermer</button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars" id="mobile-menu-icon"></i>
    </button>
    
    <!-- Mobile Nav Overlay -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay" onclick="closeMobileMenu()"></div>
    
    <script>
        // Mobile navigation
        function toggleMobileMenu() {
            const nav = document.querySelector('.nav');
            const overlay = document.getElementById('mobile-nav-overlay');
            const icon = document.getElementById('mobile-menu-icon');
            const button = document.getElementById('mobile-menu-toggle');
            
            if (nav.classList.contains('mobile-active')) {
                closeMobileMenu();
            } else {
                nav.classList.add('mobile-active');
                overlay.classList.add('active');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
                button.style.background = '#ef4444';
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeMobileMenu() {
            const nav = document.querySelector('.nav');
            const overlay = document.getElementById('mobile-nav-overlay');
            const icon = document.getElementById('mobile-menu-icon');
            const button = document.getElementById('mobile-menu-toggle');
            
            nav.classList.remove('mobile-active');
            overlay.classList.remove('active');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
            button.style.background = '#667eea';
            document.body.style.overflow = '';
        }
        
        // Fermer le menu mobile lors de la navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Dtecter si on est sur mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                document.body.classList.add('is-mobile');
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        closeMobileMenu();
                    }
                });
            });

            // Close dropdown when clicking outside (for organization switcher)
            document.addEventListener('click', function(e) {
                const switcher = document.getElementById('organization-switcher');
                if (switcher && !switcher.contains(e.target)) {
                    const dropdown = document.getElementById('org-dropdown');
                    const icon = document.getElementById('org-dropdown-icon');
                    if (dropdown) {
                        dropdown.style.display = 'none';
                        if (icon) icon.style.transform = 'rotate(0deg)';
                    }
                }
            });

            // Grer le redimensionnement avec debounce
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (window.innerWidth > 768) {
                        closeMobileMenu();
                        document.querySelector('.nav').style.display = '';
                    }
                }, 250);
            });
            
            // Amliorer le scroll sur mobile
            if (isMobile) {
                document.addEventListener('touchmove', function(e) {
                    if (document.body.style.overflow === 'hidden' && !e.target.closest('.nav')) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            
            // Pull to refresh sur mobile
            let startY = 0;
            let isPulling = false;
            
            document.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    startY = e.touches[0].pageY;
                }
            });
            
            document.addEventListener('touchmove', function(e) {
                if (window.scrollY === 0 && !isPulling) {
                    const currentY = e.touches[0].pageY;
                    const pullDistance = currentY - startY;
                    
                    if (pullDistance > 100) {
                        isPulling = true;
                        window.location.reload();
                    }
                }
            });
            
            document.addEventListener('touchend', function() {
                startY = 0;
                isPulling = false;
            });
        });
    </script>

    <!-- POPUP RAPPEL FOLLOWERS 23H -->
    <div id="followers-urgent-popup" class="followers-urgent-modal" style="display: none;">
        <div class="followers-urgent-overlay"></div>
        <div class="followers-urgent-content">
            <div class="followers-urgent-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2 class="followers-urgent-title"> Mise  jour requise !</h2>
            <p class="followers-urgent-text">
                Les followers n'ont <strong>pas encore t mis  jour</strong> aujourd'hui.<br>
                Il est bientt minuit, pensez  mettre  jour les comptes !
            </p>
            <div class="followers-urgent-accounts" id="followers-missing-accounts">
                <!-- Liste des comptes non mis  jour -->
            </div>
            <div class="followers-urgent-actions">
                <button onclick="goToFollowersTracking()" class="followers-urgent-btn-primary">
                    <i class="fas fa-edit"></i> Mettre  jour maintenant
                </button>
                <button onclick="dismissUrgentFollowersPopup()" class="followers-urgent-btn-secondary">
                    <i class="fas fa-clock"></i> Me rappeler demain
                </button>
            </div>
            <div class="followers-urgent-timer">
                <i class="fas fa-hourglass-half"></i> <span id="time-until-midnight"></span> avant minuit
            </div>
        </div>
    </div>

    <style>
        /* POPUP URGENT FOLLOWERS */
        .followers-urgent-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: popupFadeIn 0.3s ease-out;
        }

        @keyframes popupFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes popupSlideIn {
            from { opacity: 0; transform: scale(0.8) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 30px rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 60px rgba(245, 158, 11, 0.7); }
        }

        @keyframes iconBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .followers-urgent-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .followers-urgent-content {
            position: relative;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #f59e0b;
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: popupSlideIn 0.4s ease-out, pulseGlow 2s ease-in-out infinite;
        }

        .followers-urgent-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            animation: iconBounce 1s ease-in-out infinite;
        }

        .followers-urgent-icon i {
            font-size: 2.5rem;
            color: white;
        }

        .followers-urgent-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #f59e0b;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);
        }

        .followers-urgent-text {
            font-size: 1.1rem;
            color: #e2e8f0;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .followers-urgent-text strong {
            color: #fbbf24;
        }

        .followers-urgent-accounts {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .followers-urgent-account-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            color: #fbbf24;
            font-size: 0.95rem;
        }

        .followers-urgent-account-item i {
            color: #f59e0b;
        }

        .followers-urgent-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .followers-urgent-btn-primary {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .followers-urgent-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 158, 11, 0.5);
        }

        .followers-urgent-btn-secondary {
            padding: 0.875rem 1.5rem;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: #94a3b8;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .followers-urgent-btn-secondary:hover {
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
        }

        .followers-urgent-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 50px;
            color: #fca5a5;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .followers-urgent-timer i {
            animation: iconBounce 1s ease-in-out infinite;
        }

        /* Responsive */
        @media (max-width: 500px) {
            .followers-urgent-content {
                padding: 1.5rem;
                margin: 1rem;
            }

            .followers-urgent-icon {
                width: 60px;
                height: 60px;
            }

            .followers-urgent-icon i {
                font-size: 1.75rem;
            }

            .followers-urgent-title {
                font-size: 1.4rem;
            }

            .followers-urgent-text {
                font-size: 1rem;
            }

            .followers-urgent-btn-primary {
                font-size: 1rem;
                padding: 0.875rem 1.5rem;
            }
        }
    </style>
</body>
</html>