<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VA Manager Pro - Gestion Cr√©atrices</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #1a1a1a;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Dark mode - Modern design */
        body.dark-mode {
            background: #0a0b0d;
            color: #e1e8ef;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%) !important;
            box-shadow: 0 4px 30px rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .nav {
            background: #13151a;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.4);
        }
        
        body.dark-mode .nav-btn {
            color: #9ca3af;
            border: 1px solid transparent;
        }
        
        body.dark-mode .nav-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            color: #e1e8ef;
            border-color: rgba(99, 102, 241, 0.2);
        }
        
        body.dark-mode .nav-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode .card {
            background: #16181d;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .modal-content {
            background: #1a1d23;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        
        body.dark-mode .form-control {
            background: #0d0f13;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e1e8ef;
        }
        
        body.dark-mode .form-control:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .subs-table {
            background: #16181d;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .subs-table th {
            background: #1e2028;
            color: #9ca3af;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode .subs-table td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #e1e8ef;
        }
        
        body.dark-mode .subs-table tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        
        body.dark-mode .leaderboard-item {
            background: linear-gradient(135deg, #1a1d23 0%, #1e2128 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode .period-tab {
            background: #1a1d23;
            color: #9ca3af;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .period-tab:hover {
            background: rgba(99, 102, 241, 0.1);
            color: #e1e8ef;
            border-color: rgba(99, 102, 241, 0.2);
        }
        
        body.dark-mode .period-tab.active {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        body.dark-mode .modal {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
        }
        
        body.dark-mode .competition-header {
            background: linear-gradient(135deg, #92400e 0%, #b45309 100%) !important;
        }
        
        body.dark-mode .submit-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode .submit-btn:hover {
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }
        
        body.dark-mode .cancel-btn {
            background: #374151;
            color: #e1e8ef;
        }
        
        body.dark-mode .cancel-btn:hover {
            background: #4b5563;
        }
        
        body.dark-mode .btn-icon {
            background: rgba(99, 102, 241, 0.1);
            color: #9ca3af;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        body.dark-mode .btn-icon:hover {
            background: rgba(99, 102, 241, 0.2);
            color: #e1e8ef;
            border-color: rgba(99, 102, 241, 0.4);
        }
        
        body.dark-mode .stat-box {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .stat-value {
            color: #e1e8ef;
        }
        
        body.dark-mode .stat-label {
            color: #9ca3af;
        }
        
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 {
            color: #f3f4f6;
        }
        
        body.dark-mode .rank-badge {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-mode .rank-1 { 
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
            color: #1a1d23;
        }
        
        body.dark-mode .rank-2 { 
            background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); 
            color: #1a1d23;
        }
        
        body.dark-mode .rank-3 { 
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); 
            color: white;
        }
        
        body.dark-mode .activity-item {
            background: rgba(99, 102, 241, 0.05);
            border-left: 3px solid #6366f1;
        }
        
        body.dark-mode select option {
            background: #1a1d23;
            color: #e1e8ef;
        }
        
        body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator,
        body.dark-mode input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        
        body.dark-mode .badge {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        body.dark-mode ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        body.dark-mode ::-webkit-scrollbar-track {
            background: #0d0f13;
        }
        
        body.dark-mode ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 6px;
        }
        
        body.dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
        
        /* Dark mode - Specific color adjustments */
        body.dark-mode .text-green-500,
        body.dark-mode [style*="color: #22c55e"] {
            color: #4ade80 !important;
        }
        
        body.dark-mode .text-red-500,
        body.dark-mode [style*="color: #ef4444"] {
            color: #f87171 !important;
        }
        
        body.dark-mode .text-blue-500,
        body.dark-mode [style*="color: #3b82f6"] {
            color: #60a5fa !important;
        }
        
        body.dark-mode .text-orange-500,
        body.dark-mode [style*="color: #f59e0b"] {
            color: #fbbf24 !important;
        }
        
        body.dark-mode [style*="background: #f8fafc"] {
            background: #1a1d23 !important;
        }
        
        body.dark-mode [style*="background: white"] {
            background: #16181d !important;
        }
        
        body.dark-mode [style*="background: #fff"],
        body.dark-mode [style*="background:white"],
        body.dark-mode [style*="background:#fff"],
        body.dark-mode [style*="background:#ffffff"] {
            background: #16181d !important;
        }
        
        body.dark-mode [style*="border-left: 4px solid #f59e0b"] {
            border-left-color: #fbbf24 !important;
        }
        
        body.dark-mode [style*="background: #fef3c7"] {
            background: rgba(251, 191, 36, 0.1) !important;
            color: #fbbf24 !important;
        }
        
        body.dark-mode [style*="color: #64748b"] {
            color: #94a3b8 !important;
        }
        
        body.dark-mode [style*="color: #94a3b8"] {
            color: #cbd5e1 !important;
        }
        
        body.dark-mode [style*="background: #e2e8f0"] {
            background: rgba(255, 255, 255, 0.05) !important;
        }
        
        body.dark-mode .va-card,
        body.dark-mode .creator-card {
            background: linear-gradient(135deg, #16181d 0%, #1a1d23 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .creators-stats-overview {
            background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 100%) !important;
        }
        
        body.dark-mode .creatrice-item {
            background: rgba(30, 41, 59, 0.5) !important;
            color: #e2e8f0 !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }
        
        body.dark-mode .creatrice-item:hover {
            background: rgba(30, 41, 59, 0.8) !important;
            border-color: rgba(99, 102, 241, 0.2) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }
        
        body.dark-mode .twitter-accounts {
            background: rgba(29, 161, 242, 0.03) !important;
            border-color: rgba(29, 161, 242, 0.1) !important;
        }
        
        body.dark-mode .twitter-badge {
            background: linear-gradient(135deg, #1DA1F2 0%, #0C85D0 100%) !important;
            box-shadow: 0 2px 4px rgba(29, 161, 242, 0.2) !important;
            border-color: rgba(29, 161, 242, 0.3) !important;
        }
        
        body.dark-mode .twitter-badge:hover {
            box-shadow: 0 3px 8px rgba(29, 161, 242, 0.4) !important;
            border-color: rgba(29, 161, 242, 0.5) !important;
        }

        body.dark-mode .instagram-accounts {
            background: linear-gradient(45deg, rgba(131, 58, 180, 0.03), rgba(253, 29, 29, 0.03), rgba(252, 176, 69, 0.03)) !important;
            border-color: rgba(193, 53, 132, 0.1) !important;
        }

        body.dark-mode .instagram-badge {
            background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #FCB045 100%) !important;
            box-shadow: 0 2px 4px rgba(193, 53, 132, 0.2) !important;
            border: 2px solid transparent !important;
        }

        body.dark-mode .instagram-badge:hover {
            box-shadow: 0 3px 8px rgba(193, 53, 132, 0.4) !important;
            border-color: rgba(193, 53, 132, 0.5) !important;
        }
        
        body.dark-mode .creatrice-name {
            color: #f1f5f9 !important;
        }
        
        body.dark-mode .progress-bar {
            background: rgba(99, 102, 241, 0.1);
        }
        
        body.dark-mode .progress-fill {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
        }
        
        body.dark-mode .performance-card {
            background: #1a1d23;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Dark mode - SVG and chart adjustments */
        body.dark-mode svg circle[stroke="#e2e8f0"] {
            stroke: rgba(255, 255, 255, 0.1) !important;
        }
        
        body.dark-mode .fa-check-circle {
            color: #4ade80 !important;
        }
        
        body.dark-mode .fa-clock {
            color: #fbbf24 !important;
        }
        
        body.dark-mode .fa-trash {
            color: #f87171 !important;
        }
        
        /* Ensure no black on black or white on white */
        body.dark-mode p,
        body.dark-mode span,
        body.dark-mode div {
            color: inherit;
        }
        
        /* Dark mode - Form labels and text */
        body.dark-mode label,
        body.dark-mode .form-group label {
            color: #94a3b8 !important;
            font-weight: 500;
        }
        
        body.dark-mode h2 {
            color: #e1e8ef !important;
        }
        
        body.dark-mode small {
            color: #64748b !important;
        }
        
        body.dark-mode .modal h2 {
            color: #f3f4f6 !important;
        }
        
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: #4b5563 !important;
        }
        
        body.dark-mode .form-label {
            color: #94a3b8 !important;
        }
        
        /* Dark mode - Specific form sections */
        body.dark-mode .form-section {
            background: rgba(99, 102, 241, 0.03);
            border: 1px solid rgba(99, 102, 241, 0.1);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        body.dark-mode .form-section h3 {
            color: #a5b4fc !important;
            margin-bottom: 1rem;
        }
        
        /* Special adjustments for specific inline styles */
        body.dark-mode [style*="color: #dc2626"] {
            color: #ef4444 !important;
        }
        
        body.dark-mode [style*="color: #059669"] {
            color: #10b981 !important;
        }
        
        body.dark-mode [style*="color: #0891b2"] {
            color: #06b6d4 !important;
        }
        
        /* Period selector specific */
        body.dark-mode .period-selector {
            background: #13151a;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Dark mode - Additional adjustments for better readability */
        body.dark-mode .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        
        body.dark-mode .modal-actions {
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding-top: 1.5rem;
            margin-top: 2rem;
        }
        
        body.dark-mode select {
            background-color: #0d0f13;
            color: #e1e8ef;
        }
        
        body.dark-mode textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        body.dark-mode .help-text {
            color: #64748b !important;
            font-size: 0.875rem;
        }
        
        /* Focus states in dark mode */
        body.dark-mode input:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        /* Dark mode info boxes */
        body.dark-mode .info-box {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        
        /* Force all white backgrounds to be dark */
        body.dark-mode .page > div[style*="background"],
        body.dark-mode .leaderboard,
        body.dark-mode .performance-charts,
        body.dark-mode .activity-feed,
        body.dark-mode .commission-summary,
        body.dark-mode .payment-history {
            background: #16181d !important;
            color: #e1e8ef !important;
        }
        
        /* Specific page sections */
        body.dark-mode div[style*="border-radius: 1rem"][style*="padding: 2rem"] {
            background: #16181d !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
        }
        
        body.dark-mode .leaderboard-content,
        body.dark-mode .chart-grid,
        body.dark-mode .activity-content {
            background: transparent !important;
        }
        
        /* Remove any remaining white from stats pages */
        body.dark-mode .revenue-stats,
        body.dark-mode .subs-stats,
        body.dark-mode .financial-stats {
            background: #16181d !important;
        }
        
        /* Dark scrollbar for all elements */
        body.dark-mode * {
            scrollbar-color: #374151 #0d0f13;
        }
        
        /* ULTIMATE FORCE - Convert ALL white backgrounds */
        body.dark-mode div[style*="background: white"],
        body.dark-mode div[style*="background:#fff"],
        body.dark-mode div[style*="background: #fff"],
        body.dark-mode div[style*="background:white"] {
            background: #16181d !important;
        }
        
        /* Ensure text remains visible on dark backgrounds */
        body.dark-mode div[style*="background: white"] *,
        body.dark-mode div[style*="background:#fff"] *,
        body.dark-mode div[style*="background: #fff"] * {
            color: #e1e8ef !important;
        }
        
        /* Competition pages specific dark styling */
        body.dark-mode .leaderboard[style*="background: white"] {
            background: linear-gradient(135deg, #16181d 0%, #1a1d23 100%) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }
        
        /* Charts and graphs containers */
        body.dark-mode .chart-container[style*="background"],
        body.dark-mode .graph-container[style*="background"] {
            background: rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Activity items in dark mode */
        body.dark-mode .activity-item[style*="background"] {
            background: rgba(99, 102, 241, 0.05) !important;
            border-left: 3px solid #6366f1 !important;
        }
        
        /* Specific sections with classes */
        body.dark-mode .stats-section,
        body.dark-mode .charts-section {
            background: #16181d !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
        }
        
        /* Clean approach - Target specific white backgrounds */
        body.dark-mode .page > div[style*="background: white"],
        body.dark-mode .page > div[style*="background:#fff"] {
            background: #16181d !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
        }
        
        /* All main content divs */
        body.dark-mode .leaderboard[style*="background"],
        body.dark-mode div[style*="border-radius: 1rem"][style*="background: white"] {
            background: #16181d !important;
        }
        
        /* Ensure readability */
        body.dark-mode .page div[style*="background"] h2,
        body.dark-mode .page div[style*="background"] h3,
        body.dark-mode .page div[style*="background"] p,
        body.dark-mode .page div[style*="background"] span {
            color: #e1e8ef !important;
        }
        
        /* FINAL SOLUTION - Override with specificity */
        body.dark-mode .dark-background,
        body.dark-mode [style*="background: white"],
        body.dark-mode [style*="background:#ffffff"],
        body.dark-mode [style*="background: #ffffff"],
        body.dark-mode [style*="background:white"],
        body.dark-mode [style*="background :white"],
        body.dark-mode [style*="background : white"],
        body.dark-mode [style*="background: #f8fafc"] {
            background: #1e293b !important;
            background-color: #1e293b !important;
        }
        
        /* Last resort - target by structure */
        body.dark-mode .page > div > div {
            background-color: inherit !important;
        }
        
        /* Specific styles for unassigned Gmail accounts */
        body.dark-mode .unassigned-section {
            background: rgba(239, 68, 68, 0.05) !important;
            border-color: #ef4444 !important;
        }
        
        body.dark-mode .existing-creators-list div {
            background: rgba(0,0,0,0.2) !important;
            border-color: rgba(255,255,255,0.1) !important;
            color: #e2e8f0 !important;
        }
        
        body.dark-mode .existing-creators-list small {
            color: #94a3b8 !important;
        }
        
        body.dark-mode .unassigned-account-item {
            background: rgba(239, 68, 68, 0.1) !important;
            color: #e1e8ef !important;
        }
        
        body.dark-mode .unassigned-account-item strong {
            color: #f3f4f6 !important;
        }
        
        body.dark-mode .unassigned-account-item p {
            color: #94a3b8 !important;
        }
        
        body.dark-mode #assign-gmail-modal .modal-content {
            background: #1a1d23 !important;
            color: #e1e8ef !important;
        }
        
        body.dark-mode #assign-gmail-modal div[style*="background: #f8fafc"] {
            background: rgba(99, 102, 241, 0.1) !important;
            color: #e1e8ef !important;
        }
        
        /* Twitter unassigned page dark mode */
        body.dark-mode #twitter-unassigned-page div[style*="background: #fef3c7"] {
            background: rgba(249, 158, 11, 0.1) !important;
            color: #fbbf24 !important;
        }
        
        body.dark-mode #twitter-unassigned-page p[style*="color: #92400e"] {
            color: #fbbf24 !important;
        }
        
        body.dark-mode #assign-gmail-twitter-modal .modal-content {
            background: #1a1d23 !important;
            color: #e1e8ef !important;
        }
        
        body.dark-mode #assign-gmail-twitter-modal div[style*="background: #e0f2fe"] {
            background: rgba(14, 165, 233, 0.1) !important;
            color: #38bdf8 !important;
        }
        
        body.dark-mode .page > div {
            background: #16181d !important;
        }
        
        /* Commission summary card */
        .commission-summary-card {
            background: #f8fafc;
        }
        
        body.dark-mode .commission-summary-card {
            background: #16181d !important;
            color: #e1e8ef !important;
        }
        
        /* Stats and charts sections */
        .stats-section, .charts-section, .leaderboard {
            background: white;
        }
        
        body.dark-mode .stats-section,
        body.dark-mode .charts-section {
            background: #16181d !important;
        }
        
        .theme-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            font-size: 0.875rem;
            backdrop-filter: blur(10px);
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        body.dark-mode .theme-toggle {
            background: rgba(147, 51, 234, 0.2);
            border-color: rgba(147, 51, 234, 0.3);
        }
        
        body.dark-mode .theme-toggle:hover {
            background: rgba(147, 51, 234, 0.3);
            border-color: rgba(147, 51, 234, 0.4);
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.3);
        }
        
        /* Backup button specific dark mode */
        body.dark-mode .theme-toggle[onclick*="showBackupModal"] {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        body.dark-mode .theme-toggle[onclick*="showBackupModal"]:hover {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.4);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .stats-header {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Navigation */
        .nav {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            padding: 1rem 2rem;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: #f1f5f9;
            color: #1a1a1a;
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
        }

        /* Main Layout */
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Cards */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* VA Cards Grid */
        .va-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .va-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: all 0.3s;
        }

        .va-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .va-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-radius: 1rem 1rem 0 0;
        }
        
        .va-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .delete-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #fecaca;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.4);
            color: white;
            border-color: rgba(239, 68, 68, 0.5);
            transform: scale(1.05);
        }

        .va-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .va-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
        }

        .creatrice-section {
            padding: 1.25rem;
        }
        
        .va-stats {
            font-size: 0.875rem;
            opacity: 0.9;
            display: flex;
            gap: 1rem;
            margin-top: 0.25rem;
        }
        
        .va-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .creatrice-item {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        .creatrice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .creatrice-name {
            font-weight: 600;
            color: #1a1a1a;
        }

        .twitter-accounts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .twitter-badge {
            background: linear-gradient(135deg, #1DA1F2 0%, #0C85D0 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            box-shadow: 0 2px 4px rgba(29, 161, 242, 0.15);
            transition: all 0.2s ease;
            text-decoration: none;
            cursor: pointer;
            max-width: calc(100% - 1rem);
            margin: 0.25rem;
            border: 1px solid rgba(29, 161, 242, 0.2);
        }
        
        a.twitter-badge {
            color: white;
            text-decoration: none;
        }
        
        a.twitter-badge:visited {
            color: white;
        }
        
        .twitter-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(29, 161, 242, 0.25);
            border-color: rgba(29, 161, 242, 0.4);
        }
        
        .twitter-badge button {
            width: 28px !important;
            height: 28px !important;
            font-size: 0.75rem !important;
        }
        
        .twitter-badge button:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: scale(1.1);
        }
        
        /* Twitter accounts container - ULTRATHINK design */
        .twitter-accounts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
            padding: 0.5rem;
            background: rgba(29, 161, 242, 0.02);
            border-radius: 0.75rem;
            border: 1px solid rgba(29, 161, 242, 0.08);
            margin-top: 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(29, 161, 242, 0.2) transparent;
        }
        
        .twitter-accounts::-webkit-scrollbar {
            width: 6px;
        }
        
        .twitter-accounts::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .twitter-accounts::-webkit-scrollbar-thumb {
            background: rgba(29, 161, 242, 0.2);
            border-radius: 3px;
        }
        
        .twitter-accounts::-webkit-scrollbar-thumb:hover {
            background: rgba(29, 161, 242, 0.3);
        }

        /* Instagram accounts container */
        .instagram-accounts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
            padding: 0.5rem;
            background: linear-gradient(45deg, rgba(131, 58, 180, 0.05), rgba(253, 29, 29, 0.05), rgba(252, 176, 69, 0.05));
            border-radius: 0.75rem;
            border: 1px solid rgba(193, 53, 132, 0.15);
            margin-top: 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(193, 53, 132, 0.2) transparent;
        }

        .instagram-accounts::-webkit-scrollbar {
            width: 6px;
        }

        .instagram-accounts::-webkit-scrollbar-track {
            background: transparent;
        }

        .instagram-accounts::-webkit-scrollbar-thumb {
            background: rgba(193, 53, 132, 0.2);
            border-radius: 3px;
        }

        .instagram-accounts::-webkit-scrollbar-thumb:hover {
            background: rgba(193, 53, 132, 0.3);
        }

        .instagram-badge {
            background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #FCB045 100%);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8125rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(193, 53, 132, 0.15);
            position: relative;
            overflow: hidden;
            text-decoration: none;
        }

        a.instagram-badge {
            color: white;
            text-decoration: none;
        }

        a.instagram-badge:visited {
            color: white;
        }

        .instagram-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(193, 53, 132, 0.25);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .instagram-badge button {
            width: 28px !important;
            height: 28px !important;
            min-width: 28px !important;
        }

        .instagram-badge button:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: scale(1.1);
        }
        
        /* Adjust creatrice-item spacing */
        .creatrice-item {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(229, 231, 235, 0.5);
            transition: all 0.2s ease;
        }
        
        .creatrice-item:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(229, 231, 235, 0.8);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        

        /* Forms */
        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            max-width: 600px;
            margin: 0 auto;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            text-align: center;
            color: #1a1a1a;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #475569;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cancel-btn {
            padding: 1rem;
            background: #e5e7eb;
            color: #374151;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cancel-btn:hover {
            background: #d1d5db;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Import Section */
        .import-area {
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
        }

        .import-area:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .import-area.dragover {
            border-color: #667eea;
            background: #ede9fe;
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: #10b981;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            display: none;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            font-weight: 500;
            max-width: 500px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .success-message.show {
            display: flex;
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Error Message */
        .error-message {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background-color: #dc2626;
            color: white;
            border-radius: 0.5rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            animation: slideInDown 0.3s ease-out;
        }
        
        .error-message.show {
            display: flex;
        }
        
        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .action-btn {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn {
            background: #dbeafe;
            color: #3b82f6;
        }

        .delete-btn {
            background: #fee2e2;
            color: #ef4444;
        }

        /* Search */
        .search-container {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .search-results {
            margin-top: 2rem;
        }

        .no-creator {
            color: #94a3b8;
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }

        /* Subs Competition Styles */
        .competition-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .competition-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .competition-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .competition-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            position: relative;
            z-index: 1;
        }

        .stat-box {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Leaderboard */
        .leaderboard-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .leaderboard {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .leaderboard-header {
            background: #1a1a1a;
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .leaderboard-item {
            padding: 1.5rem;
            border-bottom: 1px solid #f0f2f5;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
            position: relative;
        }

        .leaderboard-item:hover {
            background: #f8fafc;
            transform: translateX(5px);
        }

        .rank-badge {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.25rem;
            border-radius: 50%;
        }

        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #808080); color: white; }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; }
        .rank-other { background: #e2e8f0; color: #64748b; }

        .va-info {
            flex: 1;
        }

        .va-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .va-stats-mini {
            font-size: 0.875rem;
            color: #64748b;
            display: flex;
            gap: 1rem;
        }

        .va-score {
            text-align: right;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
            color: #10b981;
        }

        .score-label {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .action-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .quick-action-btn {
            padding: 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .add-subs-quick {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .add-subs-quick:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .view-details-btn {
            background: #f1f5f9;
            color: #1a1a1a;
        }

        .view-details-btn:hover {
            background: #e2e8f0;
        }

        /* Performance Charts */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Period Tabs */
        .period-tabs {
            display: flex;
            gap: 0.5rem;
            background: #f1f5f9;
            padding: 0.25rem;
            border-radius: 0.5rem;
        }

        .period-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s;
        }

        .period-tab.active {
            background: white;
            color: #1a1a1a;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Progress Bars */
        .progress-container {
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Recent Activity */
        .activity-feed {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f2f5;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: #f1f5f9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.875rem;
            color: #64748b;
        }
        
        /* ========== MOBILE RESPONSIVE DESIGN ========== */
        
        /* Menu burger pour mobile */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }
        
        body.dark-mode .mobile-menu-toggle {
            background: #8b5cf6;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        }
        
        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .mobile-nav-overlay.active {
            display: block;
            opacity: 1;
        }
        
        /* Tablettes et petits √©crans */
        @media (max-width: 1024px) {
            .container {
                padding: 1rem;
            }
            
            .header-content {
                padding: 1rem;
            }
            
            .stats-header {
                gap: 1rem;
            }
            
            .va-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            /* Header mobile */
            .header {
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 0.75rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.875rem;
            }
            
            .stats-header {
                width: 100%;
                justify-content: space-around;
            }
            
            .stat-item {
                flex: 1;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            /* Navigation mobile */
            .nav {
                display: none;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                background: white;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
                z-index: 998;
                transform: translateY(100%);
                transition: transform 0.3s ease;
            }
            
            .nav.mobile-active {
                display: block;
                transform: translateY(0);
            }
            
            .nav-content {
                flex-direction: column;
                padding: 1rem;
                max-height: 70vh;
                overflow-y: auto;
            }
            
            .nav-btn {
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
                justify-content: flex-start;
                border-radius: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            body.dark-mode .nav {
                background: #1e1e1e;
            }
            
            /* Bouton menu mobile */
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Boutons du header mobile */
            .header-content > div:last-child {
                width: 100%;
                justify-content: space-between;
            }
            
            .header-content .theme-toggle {
                padding: 0.5rem;
                font-size: 0.875rem;
            }
            
            .header-content .theme-toggle span {
                display: none;
            }
            
            #save-status {
                font-size: 0.625rem !important;
                padding: 0.125rem 0.5rem !important;
            }
            
            #save-status-text {
                display: none;
            }
            
            /* Container principal */
            .container {
                padding: 0.75rem;
                margin-bottom: 80px; /* Pour le menu flottant */
            }
            
            /* Statistiques cr√©atrices mobile */
            .creators-stats-overview {
                padding: 1rem !important;
            }
            
            .creators-stats-overview h3 {
                font-size: 1.1rem !important;
            }
            
            #creators-comparison > div {
                font-size: 0.875rem;
            }
            
            #creators-comparison > div > div:first-child {
                flex: 0 0 100px !important;
                font-size: 0.75rem;
            }
            
            /* Grilles mobile */
            .va-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .va-card {
                padding: 1rem;
            }
            
            /* Formulaires mobile */
            .form-container {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .form-title {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }
            
            .form-group label {
                font-size: 0.875rem;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* √âviter le zoom sur iOS */
            }
            
            /* Pages avec deux colonnes */
            #add-account-page > div,
            #gmail-accounts-page > div,
            #add-creator-page > div {
                flex-direction: column;
                gap: 1rem;
            }
            
            #add-account-page .form-container,
            #gmail-accounts-page .form-container,
            #add-creator-page .form-container {
                max-height: none !important;
                flex: none;
                width: 100%;
            }
            
            /* Modals mobile */
            .modal-content {
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
                margin: 0;
                border-radius: 0;
                overflow-y: auto;
                padding: 1rem;
            }
            
            .modal-content h2 {
                font-size: 1.5rem;
                position: sticky;
                top: -1rem;
                background: white;
                padding: 1rem 0;
                z-index: 10;
            }
            
            body.dark-mode .modal-content h2 {
                background: #2a2a2a;
            }
            
            /* Tables mobile */
            .subs-table,
            .associations-table {
                font-size: 0.875rem;
            }
            
            .subs-table th,
            .subs-table td,
            .associations-table th,
            .associations-table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            
            /* Cartes et listes mobile */
            .twitter-account-card,
            .gmail-account-card {
                padding: 0.75rem;
            }
            
            /* Swipe to delete/edit sur mobile */
            .va-card,
            .creator-item,
            .account-item {
                position: relative;
                overflow: hidden;
            }
            
            /* Am√©lioration des s√©lecteurs sur mobile */
            select {
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
                background-repeat: no-repeat;
                background-position: right 0.7rem center;
                background-size: 1.2em;
                padding-right: 2.5rem;
            }
            
            .activity-feed {
                padding: 1rem;
            }
            
            .activity-item {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            /* Boutons action mobile */
            .action-btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }
            
            .submit-btn,
            .cancel-btn {
                width: 100%;
                padding: 0.875rem;
                font-size: 1rem;
            }
            
            /* Stats cards mobile */
            .stats-section {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .stat-card {
                padding: 0.75rem;
            }
            
            /* Tables responsives - scroll horizontal */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            /* Am√©lioration des inputs sur mobile */
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="number"],
            input[type="date"],
            select,
            textarea {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }
            
            /* Emp√™cher le zoom sur focus iOS */
            @supports (-webkit-touch-callout: none) {
                input,
                select,
                textarea {
                    font-size: 16px !important;
                }
            }
            
            /* Messages mobile */
            .success-message,
            .error-message {
                left: 1rem;
                right: 1rem;
                bottom: 90px; /* Au-dessus du menu flottant */
                transform: translateX(0);
                font-size: 0.875rem;
                padding: 0.75rem 1rem;
            }
        }
        
        /* Tr√®s petits √©crans */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.25rem;
            }
            
            .stat-number {
                font-size: 1.25rem;
            }
            
            .stat-label {
                font-size: 0.625rem;
            }
            
            .form-container {
                padding: 0.75rem;
            }
            
            /* Masquer certains √©l√©ments non essentiels */
            .activity-time {
                display: none;
            }
            
            .creator-count,
            .account-count {
                font-size: 0.75rem;
            }
        }
        
        /* Am√©lioration pour le tactile */
        @media (hover: none) and (pointer: coarse) {
            .action-btn,
            .nav-btn,
            .submit-btn,
            button {
                min-height: 44px; /* Taille minimale recommand√©e pour le tactile */
            }
            
            .va-card:active {
                transform: scale(0.98);
            }
            
            /* D√©sactiver le hover sur mobile */
            .va-card:hover,
            .action-btn:hover,
            .nav-btn:hover {
                transform: none;
                box-shadow: none;
            }
        }
        
        /* Ultra Table Styles */
        .ultra-table tr {
            transition: all 0.15s ease;
        }
        
        .ultra-table tbody tr {
            border-bottom: 1px solid #f8fafc;
        }
        
        .dark-mode .ultra-table tbody tr {
            border-bottom: 1px solid #1e293b;
        }
        
        .ultra-table tbody tr:hover {
            background: #f8fafc;
        }
        
        .dark-mode .ultra-table tbody tr:hover {
            background: #1e293b;
        }
        
        .ultra-table td {
            padding: 1rem;
            font-size: 0.875rem;
            color: #334155;
        }
        
        .dark-mode .ultra-table td {
            color: #e2e8f0;
        }
        
        .twitter-handle {
            font-weight: 600;
            color: #1DA1F2;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .model-name {
            font-weight: 500;
            color: #6366f1;
        }
        
        .dark-mode .model-name {
            color: #a78bfa;
        }
        
        .va-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            background: #e0e7ff;
            color: #4338ca;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .dark-mode .va-badge {
            background: #4338ca;
            color: #e0e7ff;
        }
        
        .gmail-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        .gmail-status.active {
            background: #d1fae5;
            color: #059669;
        }
        
        .dark-mode .gmail-status.active {
            background: #059669;
            color: #d1fae5;
        }
        
        .gmail-status.inactive {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .dark-mode .gmail-status.inactive {
            background: #dc2626;
            color: #fee2e2;
        }
        
        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .score-badge.high {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }
        
        .dark-mode .score-badge.high {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .score-badge.medium {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
        }
        
        .dark-mode .score-badge.medium {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .score-badge.low {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            color: white;
        }
        
        .dark-mode .score-badge.low {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }
        
        .rank-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.875rem;
        }
        
        .rank-number.gold {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }
        
        .rank-number.silver {
            background: linear-gradient(135deg, #cbd5e1, #94a3b8);
            color: white;
        }
        
        .rank-number.bronze {
            background: linear-gradient(135deg, #f87171, #dc2626);
            color: white;
        }
        
        .rank-number.default {
            background: #f1f5f9;
            color: #64748b;
        }
        
        @media (max-width: 768px) {
            .ultra-table {
                font-size: 0.75rem;
            }
            
            .ultra-table td, .ultra-table th {
                padding: 0.5rem;
            }
        }
        
        /* Ultra Table Container Styles */
        .ultra-table-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .dark-mode .ultra-table-container {
            background: #0f172a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .ultra-table-title {
            margin: 0 0 1.5rem 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .dark-mode .ultra-table-title {
            color: #f1f5f9;
        }
        
        .ultra-table thead tr {
            border-bottom: 1px solid #f1f5f9;
        }
        
        .dark-mode .ultra-table thead tr {
            border-bottom: 1px solid #334155;
        }
        
        .ultra-table th {
            color: #64748b;
        }
        
        .dark-mode .ultra-table th {
            color: #94a3b8;
        }
        
        /* VA Warning Styles */
        .va-warning {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 0.5rem;
            color: #92400e;
            font-size: 0.875rem;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .dark-mode .va-warning {
            background: #451a03;
            border-color: #f59e0b;
            color: #fbbf24;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div>
                <h1>üìä VA Manager Pro</h1>
                <p>Gestion des Virtual Assistants et Cr√©atrices</p>
            </div>
            <div class="stats-header">
                <div class="stat-item">
                    <div class="stat-number" id="total-vas">0</div>
                    <div class="stat-label">VAs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-creators">0</div>
                    <div class="stat-label">Cr√©atrices</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-accounts">0</div>
                    <div class="stat-label">Comptes</div>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <div id="save-status" style="font-size: 0.75rem; padding: 0.25rem 0.75rem; 
                                                 background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); 
                                                 border-radius: 9999px; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-shield-alt" style="color: #22c55e;"></i>
                        <span id="save-status-text" style="color: #22c55e;">Prot√©g√©</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleDarkMode()">
                        <i class="fas fa-moon" id="theme-icon"></i>
                        <span id="theme-text">Mode Nuit</span>
                    </button>
                    <button class="theme-toggle" onclick="showBackupModal()" 
                            style="background: linear-gradient(135deg, #22c55e, #16a34a); 
                                   color: white; font-weight: 600; position: relative; overflow: hidden;">
                        <i class="fas fa-save"></i>
                        <span>Sauvegarder</span>
                        <div id="save-pulse" style="position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; 
                                                   background: rgba(255,255,255,0.3); border-radius: 50%; 
                                                   transform: translate(-50%, -50%) scale(0); opacity: 0;"></div>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <button class="nav-btn active" data-page="dashboard">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button class="nav-btn" data-page="add-va">
                <i class="fas fa-user-plus"></i> Ajouter VA
            </button>
            <button class="nav-btn" data-page="gmail-accounts">
                <i class="fas fa-envelope"></i> Comptes Gmail
            </button>
            <button class="nav-btn" data-page="add-account">
                <i class="fab fa-twitter"></i> Ajouter Compte
            </button>
            <button class="nav-btn" data-page="add-creator">
                <i class="fas fa-users"></i> Cr√©atrices
            </button>
            <button class="nav-btn" data-page="import">
                <i class="fas fa-file-import"></i> Import CSV
            </button>
            <button class="nav-btn" data-page="search">
                <i class="fas fa-search"></i> Rechercher
            </button>
            <button class="nav-btn" data-page="subs-tracking">
                <i class="fas fa-euro-sign"></i> Suivi Subs
            </button>
            <button class="nav-btn" data-page="revenue-tracking">
                <i class="fas fa-chart-line"></i> Revenus & Commissions
            </button>
            <button class="nav-btn" data-page="financial-overview">
                <i class="fas fa-coins"></i> Vue Financi√®re Globale
            </button>
            <button class="nav-btn" data-page="twitter-analytics">
                <i class="fas fa-chart-line"></i> Analyse Twitter
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Security Warning -->
        <div id="security-warning" style="background: #fef3c7; border: 2px solid #f59e0b; padding: 1rem; margin: 1rem; border-radius: 0.5rem; display: none;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 1.5rem;"></i>
                <div>
                    <strong style="color: #92400e;">Avertissement de s√©curit√©</strong>
                    <p style="margin: 0.5rem 0 0 0; color: #92400e; font-size: 0.875rem;">
                        Les mots de passe sont stock√©s localement avec une protection basique. 
                        Pour une s√©curit√© optimale, utilisez des mots de passe uniques et consid√©rez l'utilisation d'un gestionnaire de mots de passe professionnel.
                    </p>
                    <button onclick="document.getElementById('security-warning').style.display='none'; localStorage.setItem('securityWarningDismissed', 'true')" 
                            style="margin-top: 0.5rem; padding: 0.25rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                        J'ai compris
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page active">
            <!-- Statistiques principales -->
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Revenus du mois</p>
                            <p style="margin: 0; font-size: 2rem; font-weight: 700;" id="month-revenue">0‚Ç¨</p>
                        </div>
                        <i class="fas fa-euro-sign" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
            
            <!-- R√©capitulatif Cr√©atrices - Design √âpur√© -->
            <div style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0; font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-users" style="color: #8b5cf6;"></i>
                        R√©capitulatif des Cr√©atrices
                    </h3>
                    <span id="creators-count-badge" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 600; font-size: 0.875rem;">
                        0 cr√©atrice
                    </span>
                </div>
                <div id="creators-cards-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem;">
                    <!-- Les cartes seront g√©n√©r√©es dynamiquement -->
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                <button onclick="exportData()" class="btn" style="background: #10b981; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer;">
                    <i class="fas fa-download"></i> Exporter donn√©es
                </button>
                <button onclick="createAutoBackup()" class="btn" style="background: #3b82f6; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer;">
                    <i class="fas fa-save"></i> Cr√©er sauvegarde
                </button>
            </div>
            
            <div class="va-grid" id="va-grid">
                <!-- VA cards will be dynamically inserted here -->
            </div>
        </div>

        <!-- Add VA Page -->
        <div id="add-va-page" class="page">
            <div class="form-container">
                <h2 class="form-title">Ajouter un Virtual Assistant</h2>
                <form id="add-va-form">
                    <div class="form-group">
                        <label for="va-name">Pr√©nom du VA</label>
                        <input type="text" id="va-name" required placeholder="Ex: Hugo">
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-plus"></i> Ajouter VA
                    </button>
                </form>
            </div>

            <!-- Liste des VAs existants -->
            <div style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
                <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.5rem; font-weight: 600; color: var(--text-color);">
                        <i class="fas fa-users" style="color: #667eea; margin-right: 0.5rem;"></i>
                        Virtual Assistants
                    </h2>
                    <span id="va-list-count" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-weight: 600; font-size: 0.875rem;">
                        0 VA
                    </span>
                </div>
                <div id="va-list-display" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                    <!-- VAs will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Gmail Accounts Page -->
        <div id="gmail-accounts-page" class="page">
            <div style="display: flex; gap: 2rem; max-width: 1200px; margin: 0 auto;">
                <!-- Formulaire simplifi√© √† gauche -->
                <div class="form-container" style="flex: 0.8;">
                    <h2 class="form-title">Ajouter un Compte Gmail</h2>
                    <div style="margin-bottom: 1rem;">
                        <button type="button" onclick="showAllGmailPasswords()" class="btn" style="background: #f59e0b; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-key"></i> Voir tous les mots de passe
                        </button>
                    </div>
                    <form id="add-gmail-form">
                        <div class="form-group">
                            <label for="gmail-email">Email Gmail</label>
                            <input type="email" id="gmail-email" required placeholder="exemple@gmail.com" autofocus>
                        </div>
                        <div class="form-group">
                            <label for="gmail-password">Mot de passe</label>
                            <div style="position: relative;">
                                <input type="password" id="gmail-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right: 40px;">
                                <button type="button" onclick="togglePasswordVisibility('gmail-password')" 
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                               background: none; border: none; cursor: pointer; color: #667eea;"
                                        title="Afficher/Masquer le mot de passe">
                                    <i class="fas fa-eye" id="gmail-password-toggle"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Ajouter Gmail
                        </button>
                    </form>
                </div>
                
                <!-- Liste des comptes Gmail √† droite -->
                <div class="form-container" style="flex: 1.5; max-height: 600px; overflow-y: auto;">
                    <h2 class="form-title">
                        <i class="fas fa-envelope" style="color: #ea4335;"></i> Comptes Gmail
                    </h2>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.875rem;">
                        <div id="gmail-stats" style="display: flex; gap: 1rem;">
                            <!-- Stats will be displayed here -->
                        </div>
                        <button type="button" onclick="showAllGmailPasswords()" style="background: #f59e0b; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-key"></i> Voir tous les mots de passe
                        </button>
                    </div>
                    <div id="gmail-accounts-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Gmail accounts will be displayed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Twitter Unassigned Page -->
        <div id="twitter-unassigned-page" class="page">
            <div class="form-container" style="margin-bottom: 2rem;">
                <h2 class="form-title">Comptes Twitter sans Gmail</h2>
                <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; color: #92400e;">
                        <i class="fas fa-info-circle"></i> Ces comptes Twitter n'ont pas de Gmail assign√©. 
                        Assignez un Gmail pour faciliter la gestion.
                    </p>
                </div>
            </div>
            
            <div id="twitter-unassigned-list" style="display: grid; gap: 1rem;">
                <!-- Twitter accounts without Gmail will be displayed here -->
            </div>
        </div>
        
        <!-- Add Creator Page -->
        <div id="add-creator-page" class="page">
            <div style="display: flex; gap: 2rem; max-width: 1200px; margin: 0 auto;">
                <!-- Formulaire √† gauche -->
                <div class="form-container" style="flex: 1;">
                    <h2 class="form-title">Ajouter une Cr√©atrice</h2>
                    <form id="add-creator-form">
                        <div class="form-group">
                            <label for="creator-name">Nom de la cr√©atrice</label>
                            <input type="text" id="creator-name" required placeholder="Ex: Justine" autofocus>
                        </div>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i> Ajouter Cr√©atrice
                        </button>
                    </form>
                </div>
                
                <!-- Tableau des cr√©atrices √† droite -->
                <div class="form-container" style="flex: 2; max-height: 600px; overflow-y: auto;">
                    <h2 class="form-title">
                        <i class="fas fa-users"></i> Toutes les Cr√©atrices
                    </h2>
                    <div style="margin-bottom: 1rem; font-size: 0.875rem; display: flex; align-items: center; justify-content: space-between;">
                        <span id="total-creators-count" style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px;">
                            <!-- Total sera affich√© ici -->
                        </span>
                    </div>
                    <div id="all-creators-table">
                        <!-- Le tableau sera g√©n√©r√© ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Account Page -->
        <div id="add-account-page" class="page">
            <div style="display: flex; gap: 2rem; max-width: 1200px; margin: 0 auto;">
                <!-- Formulaire √† gauche -->
                <div class="form-container" style="flex: 1;">
                    <h2 class="form-title">Ajouter un Compte Social</h2>

                    <!-- S√©lecteur de type de compte -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                        <button type="button" class="platform-btn active" data-platform="twitter" onclick="switchPlatform('twitter')" style="flex: 1; padding: 0.75rem; background: #1DA1F2; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            <i class="fab fa-twitter"></i> Twitter
                        </button>
                        <button type="button" class="platform-btn" data-platform="instagram" onclick="switchPlatform('instagram')" style="flex: 1; padding: 0.75rem; background: #E4E7EB; color: #4B5563; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            <i class="fab fa-instagram"></i> Instagram
                        </button>
                    </div>

                    <form id="add-account-form">
                        <!-- Twitter Fields -->
                        <div id="twitter-fields" class="platform-fields">
                            <div class="form-group">
                                <label for="twitter-username">Username Twitter</label>
                                <input type="text" id="twitter-username" placeholder="@username" autofocus>
                            </div>
                            <div class="form-group">
                                <label for="twitter-password">Mot de passe Twitter</label>
                                <div style="position: relative;">
                                    <input type="password" id="twitter-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right: 40px;">
                                    <button type="button" onclick="togglePasswordVisibility('twitter-password')"
                                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                                                   background: none; border: none; cursor: pointer; color: #667eea;"
                                            title="Afficher/Masquer le mot de passe">
                                        <i class="fas fa-eye" id="twitter-password-toggle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Instagram Fields -->
                        <div id="instagram-fields" class="platform-fields" style="display: none;">
                            <div class="form-group">
                                <label for="instagram-username">Username Instagram</label>
                                <input type="text" id="instagram-username" placeholder="@username">
                            </div>
                            <div class="form-group">
                                <label for="instagram-password">Mot de passe Instagram</label>
                                <div style="position: relative;">
                                    <input type="password" id="instagram-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right: 40px;">
                                    <button type="button" onclick="togglePasswordVisibility('instagram-password')"
                                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                                                   background: none; border: none; cursor: pointer; color: #667eea;"
                                            title="Afficher/Masquer le mot de passe">
                                        <i class="fas fa-eye" id="instagram-password-toggle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Common Fields -->
                        <div class="form-group">
                            <label for="account-creator">Cr√©atrice</label>
                            <select id="account-creator" class="form-control" required onchange="onCreatorChange()">
                                <option value="">S√©lectionner une cr√©atrice</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-gmail">Compte Gmail</label>
                            <select id="account-gmail" class="form-control" required>
                                <option value="">S√©lectionner un compte Gmail</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="account-va">Virtual Assistant</label>
                            <select id="account-va" class="form-control" required>
                                <option value="">S√©lectionner un VA</option>
                            </select>
                            <div id="va-warning" class="va-warning" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>ATTENTION:</strong> Cette cr√©atrice est sur plusieurs VAs. Vous DEVEZ choisir le VA pour ce compte.
                            </div>
                        </div>
                        <button type="submit" class="submit-btn" id="add-account-btn">
                            <i class="fas fa-plus"></i> Ajouter Compte Twitter
                        </button>
                    </form>
                </div>
                
                <!-- Liste des comptes sociaux √† droite -->
                <div class="form-container" style="flex: 1.5; max-height: 600px; overflow-y: auto;">
                    <h2 class="form-title" id="accounts-list-title">
                        <i class="fab fa-twitter" style="color: #1da1f2;"></i> Comptes Twitter Existants
                    </h2>
                    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" id="show-twitter-passwords-btn" onclick="showAllTwitterPasswords()" style="background: #1da1f2; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-key"></i> Voir tous les mots de passe Twitter
                        </button>
                        <button type="button" id="show-instagram-passwords-btn" onclick="showAllInstagramPasswords()" style="display: none; background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <i class="fas fa-key"></i> Voir tous les mots de passe Instagram
                        </button>
                    </div>
                    <div id="twitter-accounts-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- La liste Twitter sera g√©n√©r√©e dynamiquement ici -->
                    </div>
                    <div id="instagram-accounts-list" style="display: none; flex-direction: column; gap: 0.75rem;">
                        <!-- La liste Instagram sera g√©n√©r√©e dynamiquement ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Page -->
        <div id="import-page" class="page">
            <div class="form-container">
                <h2 class="form-title">Import CSV</h2>
                <div class="import-area" id="import-area">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 1rem;"></i>
                    <p>Glissez votre fichier CSV ici ou</p>
                    <input type="file" id="csv-file" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('csv-file').click()" class="submit-btn" style="width: auto; padding: 0.75rem 2rem;">
                        <i class="fas fa-folder-open"></i> Choisir un fichier
                    </button>
                </div>
                <div style="margin-top: 2rem;">
                    <h3>Format requis :</h3>
                    <code style="background: #f1f5f9; padding: 1rem; display: block; border-radius: 0.5rem; margin-top: 0.5rem;">
                        Pr√©nom VA, Cr√©atrice, @Twitter, Email, Mot de passe
                    </code>
                    <p style="margin-top: 1rem; color: #64748b;">Exemple :</p>
                    <code style="background: #f1f5f9; padding: 1rem; display: block; border-radius: 0.5rem; margin-top: 0.5rem;">
                        Hugo, Justine, @justine_pro, justine@email.com, pass123<br>
                        Hugo, Justine, @justine_backup, justine2@email.com, pass456<br>
                        Hugo, Laura, @laura_main, laura@email.com, pass789
                    </code>
                </div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="search-page" class="page">
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Rechercher par nom, cr√©atrice, @username...">
            </div>
            <div id="search-results" class="search-results"></div>
        </div>

        <!-- Subs Tracking Page -->
        <div id="subs-tracking-page" class="page">
            <!-- Competition Header -->
            <div class="competition-header">
                <h1 class="competition-title">üèÜ Comp√©tition des VAs</h1>
                <div class="competition-stats">
                    <div class="stat-box">
                        <span class="stat-value" id="total-subs-today">0</span>
                        <span class="stat-label">Subs Aujourd'hui</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-payment">0‚Ç¨</span>
                        <span class="stat-label">Total G√©n√©r√©</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-paid" style="color: #22c55e;">0‚Ç¨</span>
                        <span class="stat-label">D√©j√† Pay√©</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-remaining" style="color: #ef4444;">0‚Ç¨</span>
                        <span class="stat-label">Reste √† Payer</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="best-va-name">-</span>
                        <span class="stat-label">Meilleur VA</span>
                    </div>
                </div>
            </div>

            <!-- Period Tabs -->
            <div class="period-tabs" style="margin-bottom: 2rem;">
                <button class="period-tab active" data-period="today">Aujourd'hui</button>
                <button class="period-tab" data-period="week">Cette semaine</button>
                <button class="period-tab" data-period="month">Ce mois</button>
                <button class="period-tab" data-period="all">Tout</button>
            </div>

            <!-- Leaderboard and Quick Actions -->
            <div class="leaderboard-container">
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        <div class="leaderboard-title">
                            <i class="fas fa-trophy"></i>
                            Classement des VAs
                        </div>
                        <div class="period-display" id="period-display">Cette semaine</div>
                    </div>
                    <div id="leaderboard-content">
                        <!-- Leaderboard items will be inserted here -->
                    </div>
                </div>

                <div class="quick-actions">
                    <h3 style="margin-bottom: 1rem;">Actions rapides</h3>
                    <div class="action-grid">
                        <button onclick="openAddSubsModal()" class="quick-action-btn add-subs-quick">
                            <i class="fas fa-plus-circle"></i>
                            Ajouter des subs
                        </button>
                        <button onclick="showDetailedView()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-chart-line"></i>
                            Vue d√©taill√©e
                        </button>
                        <button onclick="exportSubsData()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-download"></i>
                            Exporter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Performance par VA</h3>
                    </div>
                    <div id="va-performance-chart">
                        <!-- Chart will be inserted here -->
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">√âvolution des subs</h3>
                    </div>
                    <div id="subs-evolution-chart">
                        <!-- Chart will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-feed">
                <h3 style="margin-bottom: 1.5rem;">Activit√© r√©cente</h3>
                <div id="activity-list">
                    <!-- Activity items will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Revenue Tracking Page -->
        <div id="revenue-tracking-page" class="page">
            <!-- Revenue Competition Header -->
            <div class="competition-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <h1 class="competition-title">üí∞ Battle des Revenus</h1>
                <div class="competition-stats">
                    <div class="stat-box">
                        <span class="stat-value" id="total-revenue-generated">0‚Ç¨</span>
                        <span class="stat-label">Revenus G√©n√©r√©s</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-commissions-due">0‚Ç¨</span>
                        <span class="stat-label">Commissions Dues</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="total-commissions-paid">0‚Ç¨</span>
                        <span class="stat-label">D√©j√† Pay√©</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value" id="commissions-to-pay">0‚Ç¨</span>
                        <span class="stat-label">Reste √† Payer</span>
                    </div>
                </div>
            </div>

            <!-- Revenue Tabs -->
            <div class="period-tabs" style="margin-bottom: 2rem;">
                <button class="period-tab active" data-revenue-period="current-week">Cette semaine</button>
                <button class="period-tab" data-revenue-period="last-week">Semaine derni√®re</button>
                <button class="period-tab" data-revenue-period="current-month">Ce mois</button>
                <button class="period-tab" data-revenue-period="all-time">Tout</button>
            </div>

            <!-- Revenue Leaderboard -->
            <div class="leaderboard-container">
                <div class="leaderboard">
                    <div class="leaderboard-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <div class="leaderboard-title">
                            <i class="fas fa-money-bill-wave"></i>
                            TOP G√©n√©rateurs de Revenus
                        </div>
                        <div id="revenue-period-display">Cette semaine</div>
                    </div>
                    <div id="revenue-leaderboard-content">
                        <!-- Revenue leaderboard items will be inserted here -->
                    </div>
                </div>

                <div class="quick-actions">
                    <h3 style="margin-bottom: 1rem;">Gestion des Commissions</h3>
                    <div class="action-grid">
                        <button onclick="openAddRevenueModal()" class="quick-action-btn" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                            <i class="fas fa-plus-circle"></i>
                            Ajouter Revenus
                        </button>
                        <button onclick="openPayCommissionModal()" class="quick-action-btn" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                            <i class="fas fa-hand-holding-usd"></i>
                            Payer Commission
                        </button>
                        <button onclick="viewAllRevenues()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-list"></i>
                            Tous les revenus
                        </button>
                        <button onclick="viewPaymentHistory()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-history"></i>
                            Historique paiements
                        </button>
                        <button onclick="exportFinancialData()" class="quick-action-btn view-details-btn">
                            <i class="fas fa-file-excel"></i>
                            Export Excel
                        </button>
                    </div>

                    <!-- Commission Summary -->
                    <div class="commission-summary-card" style="margin-top: 2rem; padding: 1.5rem; border-radius: 0.5rem;">
                        <h4 style="margin-bottom: 1rem;">R√©sum√© par VA</h4>
                        <div id="commission-summary">
                            <!-- Commission summary will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">√âvolution des Revenus</h3>
                    </div>
                    <div id="revenue-evolution-chart">
                        <!-- Revenue chart will be inserted here -->
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Commissions par VA</h3>
                    </div>
                    <div id="commission-distribution-chart">
                        <!-- Commission chart will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div class="activity-feed" id="payment-history-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3>Historique des Paiements</h3>
                    <button onclick="hidePaymentHistory()" class="action-btn view-btn">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
                <div id="payment-history-list">
                    <!-- Payment history will be inserted here -->
                </div>
            </div>

            <!-- Revenue Management Section -->
            <div class="activity-feed" id="revenue-management-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 id="revenue-management-title">Gestion des Revenus</h3>
                    <button onclick="hideRevenueManagement()" class="action-btn view-btn">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
                <div class="table-wrapper" style="overflow-x: auto;">
                    <table class="subs-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Montant USD</th>
                                <th>Taux</th>
                                <th>Montant EUR</th>
                                <th>Commission</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="revenue-management-tbody">
                            <!-- Revenue entries will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Financial Overview Page -->
        <div id="financial-overview-page" class="page">
            <!-- Nouveau header minimaliste -->
            <div style="text-align: center; padding: 3rem 0 2rem;">
                <h1 style="font-size: 2.5rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Vue Financi√®re Globale
                </h1>
                <p style="margin-top: 0.5rem; color: #64748b; font-size: 1.1rem;" id="financial-period-description">Aper√ßu de vos finances cette semaine</p>
            </div>
            
            <!-- Quick Financial Snapshot - Plus visuel -->
            <div id="financial-snapshot" style="margin-bottom: 3rem;">
                <!-- Will be dynamically generated -->
            </div>

            <!-- Financial Period Selector -->
            <div class="period-tabs" style="margin-bottom: 2rem;">
                <button class="period-tab active" data-financial-period="current-week">Cette semaine</button>
                <button class="period-tab" data-financial-period="current-month">Ce mois</button>
                <button class="period-tab" data-financial-period="last-month">Mois dernier</button>
                <button class="period-tab" data-financial-period="all">Tout</button>
            </div>

            <!-- VA Performance Overview -->
            <div class="stats-section" style="border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 2rem;">
                <h2 style="margin-bottom: 2rem; font-size: 1.5rem; font-weight: 700;">üíé Performance Financi√®re par VA</h2>
                <div id="va-financial-grid" style="display: grid; gap: 1.5rem;">
                    <!-- VA financial cards will be inserted here -->
                </div>
            </div>

            <!-- Revenue Breakdown Charts -->
            <div class="charts-container">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">R√©partition des Revenus</h3>
                    </div>
                    <div id="revenue-breakdown-chart" style="text-align: center; padding: 2rem;">
                        <!-- Pie chart representation will be here -->
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">√âvolution Globale</h3>
                    </div>
                    <div id="global-evolution-chart">
                        <!-- Evolution chart will be here -->
                    </div>
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="charts-section" style="border-radius: 1rem; padding: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
                <h3 style="margin-bottom: 1.5rem;">üìä R√©sum√© D√©taill√©</h3>
                <div id="financial-summary-table">
                    <!-- Summary table will be inserted here -->
                </div>
                
                <h3 style="margin: 2rem 0 1.5rem;">üí≥ Historique des Paiements</h3>
                <div id="payment-history-table">
                    <!-- Payment history will be inserted here -->
                </div>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                    <button onclick="showPaymentModal()" class="submit-btn" style="width: auto; background: #22c55e;">
                        <i class="fas fa-money-check-alt"></i> Enregistrer un Paiement
                    </button>
                    <button onclick="exportCompleteFinancialReport()" class="submit-btn" style="width: auto;">
                        <i class="fas fa-file-excel"></i> Exporter Rapport Financier
                    </button>
                    <button onclick="migrateToFileSystem()" class="submit-btn" style="width: auto; background: #7c3aed;">
                        <i class="fas fa-database"></i> Migrer vers Fichiers
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Twitter Analytics Page -->
        <div id="twitter-analytics-page" class="page">
            <div style="text-align: center; padding: 3rem 0 2rem;">
                <h1 style="font-size: 2.5rem; font-weight: 800; margin: 0; background: linear-gradient(135deg, #1DA1F2, #0C85D0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Analyse des Followers Twitter
                </h1>
                <p style="margin-top: 0.5rem; color: #64748b; font-size: 1.1rem;">Suivi hebdomadaire de vos comptes Twitter</p>
            </div>
            
            <!-- Stats globales -->
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div class="stat-card" style="background: linear-gradient(135deg, #1DA1F2, #0C85D0); color: white;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Total Followers</p>
                            <p style="margin: 0; font-size: 2rem; font-weight: 700;" id="total-followers">0</p>
                        </div>
                        <i class="fas fa-users" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Croissance Hebdo</p>
                            <p style="margin: 0; font-size: 2rem; font-weight: 700;" id="weekly-growth">+0</p>
                        </div>
                        <i class="fas fa-chart-line" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Meilleur Compte</p>
                            <p style="margin: 0; font-size: 1.25rem; font-weight: 700;" id="best-account">-</p>
                        </div>
                        <i class="fas fa-trophy" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Derni√®re MAJ</p>
                            <p style="margin: 0; font-size: 1.25rem; font-weight: 700;" id="last-update">-</p>
                        </div>
                        <i class="fas fa-calendar" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
            
            <!-- Analyse par VA -->
            <div id="twitter-analytics-by-va" style="display: grid; gap: 2rem;">
                <!-- Le contenu sera g√©n√©r√© dynamiquement -->
            </div>
            
            <!-- Message si aucune donn√©e -->
            <div id="no-twitter-data" style="display: none; text-align: center; padding: 4rem;">
                <i class="fas fa-chart-line" style="font-size: 4rem; color: #e2e8f0; margin-bottom: 1rem;"></i>
                <h3 style="color: #64748b; margin-bottom: 0.5rem;">Aucune donn√©e de followers</h3>
                <p style="color: #94a3b8;">Commencez √† suivre vos comptes Twitter en cliquant sur le bouton <i class="fas fa-users"></i> √† c√¥t√© de chaque compte.</p>
            </div>
        </div>
    </main>
    
    <!-- Edit Twitter Account Modal -->
    <div id="edit-account-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le compte Twitter</h2>
                <button class="close-btn" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="edit-account-form" onsubmit="updateAccount(event)">
                <input type="hidden" id="edit-account-va-id">
                <input type="hidden" id="edit-account-creator-id">
                <input type="hidden" id="edit-account-index">
                
                <div class="form-group">
                    <label for="edit-gmail-select">Compte Gmail associ√© (optionnel)</label>
                    <select id="edit-gmail-select">
                        <option value="">-- Aucun compte Gmail --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-username">Username Twitter</label>
                    <input type="text" id="edit-username" class="form-control" required placeholder="@username">
                </div>
                
                <div class="form-group" id="edit-manual-email-group" style="display: none;">
                    <label for="edit-email">Email (si pas de Gmail s√©lectionn√©)</label>
                    <input type="email" id="edit-email" class="form-control" placeholder="email@example.com">
                </div>
                
                <div class="form-group">
                    <label for="edit-password">Mot de passe</label>
                    <div style="position: relative;">
                        <input type="password" id="edit-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding-right: 40px;">
                        <button type="button" onclick="togglePasswordVisibility('edit-password')" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; cursor: pointer; color: #667eea;"
                                title="Afficher/Masquer le mot de passe">
                            <i class="fas fa-eye" id="edit-password-toggle"></i>
                        </button>
                    </div>
                    <small style="color: #718096;">Laissez vide pour conserver le mot de passe actuel</small>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="success-message">
        <i class="fas fa-check-circle"></i>
        <span id="success-text"></span>
    </div>
    
    <!-- Error Message -->
    <div id="error-message" class="error-message">
        <i class="fas fa-exclamation-circle"></i>
        <span id="error-text"></span>
    </div>
    
    <!-- Assign Gmail Modal -->
    <div id="assign-gmail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assigner le compte Gmail</h2>
                <button class="close-btn" onclick="closeAssignGmailModal()">√ó</button>
            </div>
            <form id="assign-gmail-form" onsubmit="assignGmailToVA(event)">
                <input type="hidden" id="assign-gmail-id">
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                    <p style="margin: 0;">Compte Gmail : <strong id="assign-gmail-email"></strong></p>
                </div>
                <div class="form-group">
                    <label for="assign-gmail-va-select">Choisir le VA</label>
                    <select id="assign-gmail-va-select" class="form-control" required>
                        <option value="">-- Choisir un VA --</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-check"></i> Assigner
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeAssignGmailModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Assign Gmail to Twitter Modal -->
    <div id="assign-gmail-twitter-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assigner un Gmail au compte Twitter</h2>
                <button class="close-btn" onclick="closeAssignGmailTwitterModal()">√ó</button>
            </div>
            <form id="assign-gmail-twitter-form" onsubmit="assignGmailToTwitter(event)">
                <input type="hidden" id="assign-twitter-va-id">
                <input type="hidden" id="assign-twitter-creator-id">
                <input type="hidden" id="assign-twitter-username">
                <div style="margin-bottom: 1rem; padding: 1rem; background: #e0f2fe; border-radius: 0.5rem;">
                    <p style="margin: 0;">Compte Twitter : <strong id="assign-twitter-display"></strong></p>
                </div>
                <div class="form-group">
                    <label for="assign-twitter-gmail-select">Choisir un compte Gmail disponible</label>
                    <select id="assign-twitter-gmail-select" class="form-control" required>
                        <option value="">-- Choisir un Gmail --</option>
                    </select>
                    <small style="color: #718096; display: block; margin-top: 0.5rem;">
                        <i class="fas fa-info-circle"></i> Le Gmail sera automatiquement assign√© au m√™me VA que le compte Twitter.
                    </small>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-check"></i> Assigner
                    </button>
                    <button type="button" class="cancel-btn" onclick="closeAssignGmailTwitterModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Update Followers Modal -->
    <div id="update-followers-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mettre √† jour les Followers</h2>
                <button class="close-btn" onclick="closeUpdateFollowersModal()">√ó</button>
            </div>
            <form id="update-followers-form" onsubmit="saveFollowersUpdate(event)">
                <input type="hidden" id="followers-username">
                
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <h3 id="followers-account-display" style="color: #1DA1F2; margin: 0;">
                        <i class="fab fa-twitter"></i> @username
                    </h3>
                    <div id="followers-history" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                        <!-- L'historique sera affich√© ici -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="followers-count">Nombre de Followers</label>
                    <input type="number" id="followers-count" class="form-control" required 
                           placeholder="Ex: 25000" min="0" step="1">
                </div>
                
                <div class="form-group">
                    <label for="followers-date">Date de la mise √† jour</label>
                    <input type="date" id="followers-date" class="form-control" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn cancel-btn" onclick="closeUpdateFollowersModal()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn submit-btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
            
            <!-- Graphique d'√©volution -->
            <div id="followers-chart-container" style="margin-top: 2rem; display: none;">
                <h4 style="margin-bottom: 1rem;">√âvolution des Followers</h4>
                <canvas id="followers-chart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Edit Gmail Account Modal -->
    <div id="edit-gmail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le compte Gmail</h2>
                <button class="close-btn" onclick="closeEditGmailModal()">√ó</button>
            </div>
            <form id="edit-gmail-form" onsubmit="saveEditedGmail(event)">
                <input type="hidden" id="edit-gmail-id">
                
                <div class="form-group">
                    <label for="edit-gmail-email">Email Gmail</label>
                    <input type="email" id="edit-gmail-email" class="form-control" required placeholder="example@gmail.com">
                </div>
                
                <div class="form-group">
                    <label for="edit-gmail-password">Mot de passe</label>
                    <div style="position: relative;">
                        <input type="password" id="edit-gmail-password" class="form-control" required style="padding-right: 2.5rem;">
                        <button type="button" onclick="toggleEditPasswordVisibility()" 
                                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); 
                                       background: none; border: none; cursor: pointer; color: #6b7280; 
                                       padding: 0.5rem; font-size: 1rem; transition: color 0.2s ease;"
                                onmouseover="this.style.color='#3b82f6'"
                                onmouseout="this.style.color='#6b7280'">
                            <i id="edit-password-toggle-icon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn cancel-btn" onclick="closeEditGmailModal()">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="submit" class="btn submit-btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reassign Twitter Account Modal -->
    <div id="reassign-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>R√©assigner le compte Twitter</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <form id="reassign-form" onsubmit="reassignTwitterAccount(event)">
                <input type="hidden" id="reassign-account-id">
                
                <div class="form-group">
                    <label>Compte Twitter</label>
                    <input type="text" id="reassign-username" class="form-control" readonly style="background: #f3f4f6;">
                </div>
                
                <div class="form-group">
                    <label for="reassign-creator">Cr√©atrice</label>
                    <select id="reassign-creator" class="form-control" required>
                        <option value="">S√©lectionner une cr√©atrice</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reassign-gmail">Compte Gmail</label>
                    <select id="reassign-gmail" class="form-control" required>
                        <option value="">S√©lectionner un compte Gmail</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reassign-va">Virtual Assistant</label>
                    <select id="reassign-va" class="form-control" required>
                        <option value="">S√©lectionner un VA</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-btn">
                    <i class="fas fa-check"></i> R√©assigner
                </button>
            </form>
        </div>
    </div>
    
    <!-- Password Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h3>D√©tails du compte</h3>
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- Add Subs Modal -->
    <div id="add-subs-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddSubsModal()">&times;</span>
            <h3>Ajouter des subs</h3>
            <form id="add-subs-form">
                <div class="form-group">
                    <label for="subs-va-select">S√©lectionner le VA</label>
                    <select id="subs-va-select" required>
                        <option value="">-- Choisir un VA --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subs-date">Date</label>
                    <input type="date" id="subs-date" required value="">
                </div>
                <div class="form-group">
                    <label for="subs-count">Nombre de subs</label>
                    <input type="number" id="subs-count" min="1" required placeholder="Ex: 10">
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </form>
        </div>
    </div>

    <!-- Add Revenue Modal -->
    <div id="add-revenue-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAddRevenueModal()">&times;</span>
            <h3>Ajouter des Revenus</h3>
            <form id="add-revenue-form">
                <div class="form-group">
                    <label for="revenue-va-select">S√©lectionner le VA</label>
                    <select id="revenue-va-select" required>
                        <option value="">-- Choisir un VA --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="revenue-date">Date</label>
                    <input type="date" id="revenue-date" required>
                </div>
                <div class="form-group">
                    <label for="revenue-amount">Montant des ventes ($)</label>
                    <input type="number" id="revenue-amount" min="0" step="0.01" required placeholder="Ex: 150.00">
                </div>
                <div class="form-group">
                    <label>Taux de change en temps r√©el</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="exchange-rate-display" style="font-size: 1.25rem; font-weight: 600; color: #667eea;">1$ = 0.92‚Ç¨</span>
                        <button type="button" onclick="updateExchangeRate()" class="action-btn view-btn" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-sync"></i> Actualiser
                        </button>
                    </div>
                    <small id="rate-update-time" style="color: #64748b;">Chargement...</small>
                    <input type="hidden" id="exchange-rate" value="0.92">
                </div>
                <div class="form-group">
                    <label for="tracking-link">Lien de tracking (optionnel)</label>
                    <input type="text" id="tracking-link" placeholder="Ex: track123">
                </div>
                <div class="form-group">
                    <label for="revenue-description">Description</label>
                    <input type="text" id="revenue-description" placeholder="Ex: Ventes OnlyFans semaine 1">
                </div>
                <div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                    <p><strong>Montant en EUR:</strong> <span id="amount-in-eur">0.00‚Ç¨</span></p>
                    <p><strong>Commission calcul√©e:</strong> <span id="calculated-commission">0.00‚Ç¨</span> (5%)</p>
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </form>
        </div>
    </div>

    <!-- Pay Commission Modal -->
    <div id="pay-commission-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closePayCommissionModal()">&times;</span>
            <h3>Payer une Commission</h3>
            <form id="pay-commission-form">
                <div class="form-group">
                    <label for="payment-va-select">S√©lectionner le VA</label>
                    <select id="payment-va-select" required>
                        <option value="">-- Choisir un VA --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-date">Date du paiement</label>
                    <input type="date" id="payment-date" required>
                </div>
                <div class="form-group">
                    <label for="payment-amount">Montant pay√© (‚Ç¨)</label>
                    <input type="number" id="payment-amount" min="0" step="0.01" required placeholder="Ex: 50.00">
                </div>
                <div class="form-group">
                    <label for="payment-period">P√©riode couverte</label>
                    <input type="text" id="payment-period" required placeholder="Ex: Semaine 1-7 Janvier">
                </div>
                <div id="va-outstanding-info" style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; display: none;">
                    <p><strong>Commissions dues pour ce VA:</strong> <span id="outstanding-amount">0.00‚Ç¨</span></p>
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-check-circle"></i> Confirmer le paiement
                </button>
            </form>
        </div>
    </div>

    <script>
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('‚ùå JavaScript Error:', e.error);
            console.error('At:', e.filename, 'Line:', e.lineno, 'Column:', e.colno);
        });
        
        // Dark mode management (defined early to be available for onclick)
        function toggleDarkMode() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            
            // Update data-theme attribute
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            
            if (icon && text) {
                if (isDarkMode) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    text.textContent = 'Mode Jour';
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    text.textContent = 'Mode Nuit';
                }
            }
            
            // Save preference
            localStorage.setItem('darkMode', isDarkMode);
            
            // Update the financial overview if it's the current page
            const currentPage = document.querySelector('.page.active')?.id;
            if (currentPage === 'financial-page') {
                updateFinancialOverview();
            }
            
            // Force update all dark mode-sensitive elements
            setTimeout(() => {
                updateDisplay();
                forceAllDarkBackgrounds();
            }, 50);
        }
        
        // Test navigation function
        window.testNav = function(page) {
            console.log(`üß™ Testing navigation to: ${page}`);
            try {
                if (typeof navigateToPage === 'function') {
                    navigateToPage(page);
                    console.log('‚úÖ Navigation successful');
                } else {
                    console.error('‚ùå navigateToPage function not found');
                }
            } catch (error) {
                console.error('‚ùå Navigation error:', error);
            }
        };
        
        // Fix navigation function
        window.fixNav = function() {
            console.log('üîß Fixing navigation...');
            
            // Remove all existing click handlers
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
            });
            
            // Re-attach event listeners
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    console.log(`Navigating to: ${page}`);
                    if (page) {
                        navigateToPage(page);
                    }
                });
            });
            
            console.log('‚úÖ Navigation fixed!');
        };
        
        // Data structure
        let data = {
            vas: [],
            subs: [],
            revenues: [],
            payments: [],
            gmailAccounts: [], // Nouvelle structure pour les comptes Gmail
            creators: [], // Structure pour les cr√©atrices ind√©pendantes
            twitterAccounts: [], // Structure pour les comptes Twitter simples
            instagramAccounts: [], // Structure pour les comptes Instagram
            twitterStats: [] // Nouveau : statistiques hebdomadaires des followers
        };
        
        // Utility function to generate unique IDs
        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Simple obfuscation for passwords (NOT secure encryption, just basic protection)
        function obfuscatePassword(password) {
            // Avertissement: Ceci n'est PAS une vraie s√©curit√©!
            // Pour une vraie s√©curit√©, utilisez un serveur backend
            return btoa(password).split('').reverse().join('');
        }
        
        function deobfuscatePassword(obfuscated) {
            // Pour la compatibilit√© avec les anciennes donn√©es
            try {
                return atob(obfuscated.split('').reverse().join(''));
            } catch {
                // Si √ßa √©choue, c'est probablement un ancien mot de passe non obfusqu√©
                return obfuscated;
            }
        }
        
        // Force all white backgrounds to be dark
        function forceAllDarkBackgrounds() {
            setTimeout(() => {
                // Find all elements with white backgrounds
                const elements = document.querySelectorAll('[style*="background"]');
                elements.forEach(el => {
                    const style = el.getAttribute('style');
                    if (style && (style.includes('white') || style.includes('fff') || style.includes('ffffff'))) {
                        el.style.backgroundColor = '#16181d';
                        el.style.color = '#e1e8ef';
                    }
                });
            }, 100);
        }
        
        // Load dark mode preference on page load
        function loadDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                const icon = document.getElementById('theme-icon');
                const text = document.getElementById('theme-text');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                text.textContent = 'Mode Jour';
                // Force dark backgrounds after page loads
                forceAllDarkBackgrounds();
            }
        }

        // Example structure:
        // {
        //     vas: [
        //         {
        //             id: "va_123",
        //             name: "Hugo",
        //             creators: [
        //                 {
        //                     id: "creator_456",
        //                     name: "Justine",
        //                     accounts: [
        //                         {
        //                             username: "@justine_pro",
        //                             email: "justine@email.com",
        //                             password: "pass123"
        //                         }
        //                     ]
        //                 }
        //             ]
        //         }
        //     ],
        //     subs: [
        //         {
        //             id: "sub_123",
        //             vaId: "va_123",
        //             date: "2025-01-09",
        //             count: 10,
        //             amount: 5.00
        //         }
        //     ],
        //     revenues: [
        //         {
        //             id: "rev_123",
        //             vaId: "va_123",
        //             date: "2025-01-09",
        //             amount: 150.00,
        //             commission: 7.50,
        //             description: "Ventes m√©dias",
        //             trackingLink: "track123"
        //         }
        //     ],
        //     payments: [
        //         {
        //             id: "pay_123",
        //             vaId: "va_123",
        //             date: "2025-01-09",
        //             amount: 50.00,
        //             type: "commission",
        //             period: "Semaine 1-7 Jan"
        //         }
        //     ]
        // }

        // Syst√®me de sauvegarde automatique
        let autoSaveInterval = null;
        let lastSaveTime = Date.now();
        
        // Marquer que les donn√©es ont √©t√© modifi√©es
        function markDataModified() {
            lastSaveTime = Date.now();
        }
        
        function startAutoSave() {
            // Sauvegarder toutes les 5 minutes
            autoSaveInterval = setInterval(async () => {
                const timeSinceLastSave = Date.now() - lastSaveTime;
                
                // Ne sauvegarder que si des changements ont √©t√© faits
                if (timeSinceLastSave < 60000) { // Moins d'1 minute depuis la derni√®re sauvegarde
                    return;
                }
                
                console.log('‚è∞ Sauvegarde automatique...');
                await saveData();
                lastSaveTime = Date.now();
            }, 5 * 60 * 1000); // 5 minutes
            
            // Tracker les modifications pour la sauvegarde automatique
            window.addEventListener('beforeunload', (e) => {
                // Si des donn√©es n'ont pas √©t√© sauvegard√©es
                if (Date.now() - lastSaveTime > 30000) { // Plus de 30 secondes
                    e.preventDefault();
                    e.returnValue = 'Des modifications non sauvegard√©es seront perdues. √ätes-vous s√ªr de vouloir quitter ?';
                }
            });
        }
        
        // V√©rification et r√©cup√©ration des donn√©es
        async function checkAndRecoverData() {
            try {
                // V√©rifier s'il y a des donn√©es corrompues
                const mainData = localStorage.getItem('vaManagerProData');
                const backupData = localStorage.getItem('vaManagerProData_backup');
                const history = localStorage.getItem('vaManagerProBackupHistory');
                
                if (!mainData && backupData) {
                    console.log('üîß R√©cup√©ration depuis la sauvegarde...');
                    const backup = JSON.parse(backupData);
                    localStorage.setItem('vaManagerProData', JSON.stringify(backup.data));
                    showSuccess('Donn√©es r√©cup√©r√©es depuis la sauvegarde automatique');
                } else if (!mainData && !backupData && history) {
                    console.log('üîß R√©cup√©ration depuis l\'historique...');
                    const historyData = JSON.parse(history);
                    if (historyData.length > 0) {
                        localStorage.setItem('vaManagerProData', JSON.stringify(historyData[0].data));
                        showSuccess('Donn√©es r√©cup√©r√©es depuis l\'historique des sauvegardes');
                    }
                }
                
                // V√©rifier l'int√©grit√© des donn√©es
                try {
                    if (mainData) {
                        JSON.parse(mainData);
                    }
                } catch (e) {
                    console.error('‚ùå Donn√©es corrompues d√©tect√©es');
                    if (backupData) {
                        const backup = JSON.parse(backupData);
                        localStorage.setItem('vaManagerProData', JSON.stringify(backup.data));
                        showError('Donn√©es corrompues d√©tect√©es - Restauration depuis la sauvegarde');
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification des donn√©es:', error);
            }
        }
        
        // Fonction pour r√©cup√©rer une sauvegarde sp√©cifique
        function restoreFromBackup(index) {
            try {
                const history = JSON.parse(localStorage.getItem('vaManagerProBackupHistory') || '[]');
                if (history[index]) {
                    data = history[index].data;
                    saveData();
                    showSuccess(`Donn√©es restaur√©es depuis la sauvegarde du ${new Date(history[index].timestamp).toLocaleString()}`);
                    closeBackupModal();
                    window.location.reload();
                }
            } catch (error) {
                console.error('Erreur lors de la restauration:', error);
                showError('Erreur lors de la restauration des donn√©es');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Initializing VA Manager...');
            
            loadDarkModePreference();
            
            // V√©rifier et r√©cup√©rer les donn√©es si n√©cessaire
            await checkAndRecoverData();
            
            await loadData();  // Wait for data to load before updating display
            updateDisplay();
            
            console.log('üìã Setting up event listeners...');
            setupEventListeners();
            
            // V√©rifier que les boutons de navigation sont bien configur√©s
            const navButtons = document.querySelectorAll('.nav-btn');
            console.log(`‚úÖ Found ${navButtons.length} navigation buttons`);
            navButtons.forEach(btn => {
                const page = btn.dataset.page;
                if (page) {
                    console.log(`  ‚û°Ô∏è Button "${btn.textContent.trim()}" -> page: ${page}`);
                } else {
                    console.log(`  ‚ö†Ô∏è Button "${btn.textContent.trim()}" has no data-page attribute`);
                }
            });
            
            setupDragAndDrop();
            setupSubsTracking();
            setupRevenueTracking();
            
            // Initialiser la sauvegarde automatique toutes les 5 minutes
            startAutoSave();
            
            // Set today's date as default for forms
            const subsDate = document.getElementById('subs-date');
            const revenueDate = document.getElementById('revenue-date');
            const paymentDate = document.getElementById('payment-date');
            
            if (subsDate) subsDate.value = new Date().toISOString().split('T')[0];
            if (revenueDate) revenueDate.value = new Date().toISOString().split('T')[0];
            if (paymentDate) paymentDate.value = new Date().toISOString().split('T')[0];
            
            console.log('‚úÖ Initialization complete');
            
            // Fonction pour corriger les comptes sans assignedVaId
            window.fixMissingAssignedVaId = function() {
                console.log('üîß Correction des comptes sans assignedVaId...');
                let fixed = 0;
                
                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.accounts && creator.vaIds && creator.vaIds.length === 1) {
                            // Si la cr√©atrice n'a qu'un seul VA, on peut assigner automatiquement
                            const vaId = creator.vaIds[0];
                            creator.accounts.forEach(account => {
                                if (!account.assignedVaId) {
                                    account.assignedVaId = vaId;
                                    fixed++;
                                    console.log(`‚úÖ Assign√© ${account.username} au VA ${vaId}`);
                                }
                            });
                        }
                    });
                }
                
                if (fixed > 0) {
                    saveData();
                    updateDisplay();
                    console.log(`‚úÖ ${fixed} compte(s) corrig√©(s) !`);
                } else {
                    console.log('‚úÖ Tous les comptes ont d√©j√† un assignedVaId');
                }
            };
            
            // Ex√©cuter automatiquement la correction au d√©marrage
            window.fixMissingAssignedVaId();
            
            // Fonction de diagnostic pour comprendre le probl√®me des comptes multi-VA
            window.diagnoseLauraBptss = function() {
                console.log('\nüîç DIAGNOSTIC COMPLET POUR LAURABPTSS');
                console.log('=====================================\n');
                
                // 1. Chercher toutes les cr√©atrices avec "laura" dans le nom
                console.log('1Ô∏è‚É£ TOUTES LES CR√âATRICES "LAURA":');
                data.creators.forEach(creator => {
                    if (creator.name.toLowerCase().includes('laura')) {
                        console.log(`\nüë§ Cr√©atrice: ${creator.name} (ID: ${creator.id})`);
                        console.log(`   - vaIds: ${JSON.stringify(creator.vaIds)}`);
                        
                        // Afficher les noms des VAs
                        if (creator.vaIds && creator.vaIds.length > 0) {
                            const vaNames = creator.vaIds.map(vaId => {
                                const va = data.vas.find(v => v.id === vaId);
                                return va ? va.name : 'VA supprim√©';
                            });
                            console.log(`   - VAs: ${vaNames.join(', ')}`);
                        }
                        
                        // Afficher tous les comptes
                        if (creator.accounts && creator.accounts.length > 0) {
                            console.log(`   - Comptes (${creator.accounts.length}):`);
                            creator.accounts.forEach(account => {
                                console.log(`     ‚Ä¢ ${account.username}`);
                                console.log(`       - assignedVaId: ${account.assignedVaId || 'NON D√âFINI'}`);
                                if (account.assignedVaId) {
                                    const va = data.vas.find(v => v.id === account.assignedVaId);
                                    console.log(`       - VA assign√©: ${va ? va.name : 'VA supprim√©'}`);
                                }
                            });
                        }
                    }
                });
                
                // 2. Chercher sp√©cifiquement laurabptss
                console.log('\n2Ô∏è‚É£ RECHERCHE SP√âCIFIQUE DE @laurabptss:');
                let foundLaurabptss = false;
                
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        creator.accounts.forEach(account => {
                            if (account.username.toLowerCase().includes('laurabptss')) {
                                foundLaurabptss = true;
                                console.log(`\n‚úÖ TROUV√â dans cr√©atrice: ${creator.name}`);
                                console.log(`   - Username exact: "${account.username}"`);
                                console.log(`   - assignedVaId: ${account.assignedVaId || 'NON D√âFINI'}`);
                                console.log(`   - Cr√©atrice vaIds: ${JSON.stringify(creator.vaIds)}`);
                                
                                if (creator.vaIds && creator.vaIds.length > 1) {
                                    console.log(`   ‚ö†Ô∏è PROBL√àME: Cette cr√©atrice est sur ${creator.vaIds.length} VAs !`);
                                }
                            }
                        });
                    }
                });
                
                if (!foundLaurabptss) {
                    console.log('‚ùå @laurabptss non trouv√© dans les comptes');
                }
                
                // 3. V√©rifier aussi dans data.twitterAccounts
                console.log('\n3Ô∏è‚É£ V√âRIFICATION DANS data.twitterAccounts:');
                if (data.twitterAccounts) {
                    const twitterAccount = data.twitterAccounts.find(ta => 
                        ta.username && ta.username.toLowerCase().includes('laurabptss')
                    );
                    if (twitterAccount) {
                        console.log('‚úÖ Trouv√© dans twitterAccounts:');
                        console.log(`   - Username: ${twitterAccount.username}`);
                        console.log(`   - vaId: ${twitterAccount.vaId || 'NON D√âFINI'}`);
                        console.log(`   - creatorId: ${twitterAccount.creatorId || 'NON D√âFINI'}`);
                    }
                }
                
                // 4. Afficher tous les VAs
                console.log('\n4Ô∏è‚É£ LISTE DES VAs:');
                data.vas.forEach(va => {
                    console.log(`   - ${va.name} (ID: ${va.id})`);
                });
                
                console.log('\n=====================================');
                console.log('FIN DU DIAGNOSTIC');
            };
            
            // Fonction de nettoyage pour supprimer les doublons avec "s"
            window.removeDuplicatesWithS = function() {
                console.log('üßπ Recherche de comptes dupliqu√©s avec "s"...');
                let removed = 0;
                
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.accounts.length > 0) {
                        const toRemove = [];
                        
                        creator.accounts.forEach((account, index) => {
                            // V√©rifier si c'est un compte avec "s" ajout√©
                            const baseUsername = account.username.replace(/s$/, '');
                            
                            // Chercher s'il existe un compte sans le "s"
                            const baseExists = creator.accounts.some((acc, i) => 
                                i !== index && acc.username === baseUsername
                            );
                            
                            if (baseExists && account.username.endsWith('s') && account.username !== baseUsername) {
                                console.log(`üóëÔ∏è Suppression du doublon: ${account.username} (base: ${baseUsername})`);
                                toRemove.push(index);
                                removed++;
                            }
                        });
                        
                        // Supprimer en ordre inverse pour ne pas d√©caler les indices
                        toRemove.reverse().forEach(index => {
                            creator.accounts.splice(index, 1);
                        });
                    }
                });
                
                if (removed > 0) {
                    saveData();
                    updateDisplay();
                    showSuccess(`${removed} doublon(s) supprim√©(s)!`);
                } else {
                    console.log('‚úÖ Aucun doublon trouv√©');
                }
            };
            
            // Fonction pour s√©parer une cr√©atrice multi-VA en cr√©atrices distinctes
            window.splitCreatorByVA = function(creatorName) {
                const creator = data.creators.find(c => c.name === creatorName);
                if (!creator || !creator.vaIds || creator.vaIds.length <= 1) {
                    console.error('Cr√©atrice non trouv√©e ou n\'a qu\'un seul VA');
                    return;
                }
                
                console.log(`üîÑ S√©paration de ${creatorName} en ${creator.vaIds.length} cr√©atrices distinctes...`);
                
                // Pour chaque VA, cr√©er une nouvelle cr√©atrice avec ses comptes
                const newCreators = [];
                creator.vaIds.forEach((vaId, index) => {
                    const va = data.vas.find(v => v.id === vaId);
                    if (va) {
                        const newCreator = {
                            id: index === 0 ? creator.id : 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            name: creator.name,
                            vaIds: [vaId],
                            accounts: []
                        };
                        
                        // Demander quels comptes assigner √† ce VA
                        console.log(`\nüè¢ Pour ${va.name}, quels comptes assigner ?`);
                        if (creator.accounts) {
                            creator.accounts.forEach((acc, i) => {
                                console.log(`   ${i}: ${acc.username}`);
                            });
                        }
                        
                        newCreators.push({ creator: newCreator, va: va });
                    }
                });
                
                // Stocker pour utilisation ult√©rieure
                window.tempSplit = {
                    original: creator,
                    newCreators: newCreators
                };
                
                console.log('\nüìå Utilisez assignAccountsToSplit() pour assigner les comptes:');
                console.log('Exemple: assignAccountsToSplit("hugo", [0]) pour assigner le compte 0 √† Hugo');
                console.log('         assignAccountsToSplit("fifi", [1]) pour assigner le compte 1 √† Fifi');
                
                return newCreators;
            };
            
            // Fonction pour assigner les comptes apr√®s split
            window.assignAccountsToSplit = function(vaName, accountIndices) {
                if (!window.tempSplit) {
                    console.error('Aucune s√©paration en cours. Utilisez d\'abord splitCreatorByVA()');
                    return;
                }
                
                const targetCreator = window.tempSplit.newCreators.find(nc => 
                    nc.va.name.toLowerCase() === vaName.toLowerCase()
                );
                
                if (!targetCreator) {
                    console.error(`VA ${vaName} non trouv√© dans la s√©paration`);
                    return;
                }
                
                // Assigner les comptes s√©lectionn√©s
                accountIndices.forEach(index => {
                    if (window.tempSplit.original.accounts[index]) {
                        targetCreator.creator.accounts.push(window.tempSplit.original.accounts[index]);
                        console.log(`‚úÖ ${window.tempSplit.original.accounts[index].username} assign√© √† ${vaName}`);
                    }
                });
            };
            
            // Fonction pour finaliser la s√©paration
            window.finalizeSplit = function() {
                if (!window.tempSplit) {
                    console.error('Aucune s√©paration en cours');
                    return;
                }
                
                // Remplacer l'ancienne cr√©atrice par les nouvelles
                const originalIndex = data.creators.findIndex(c => c.id === window.tempSplit.original.id);
                if (originalIndex > -1) {
                    // Supprimer l'originale
                    data.creators.splice(originalIndex, 1);
                    
                    // Ajouter les nouvelles
                    window.tempSplit.newCreators.forEach(nc => {
                        data.creators.push(nc.creator);
                    });
                    
                    console.log('‚úÖ S√©paration termin√©e !');
                    saveData();
                    updateDisplay();
                    updateAllCreatorsTable();
                    
                    delete window.tempSplit;
                } else {
                    console.error('Cr√©atrice originale non trouv√©e');
                }
            };
            
            // Fonction de diagnostic pour analyser les cr√©atrices et leurs comptes
            window.analyzeCreators = function() {
                console.log('üìä Analyse des cr√©atrices et leurs comptes:');
                console.log('='.repeat(50));
                
                data.creators.forEach(creator => {
                    console.log(`\nüë§ Cr√©atrice: ${creator.name}`);
                    console.log(`   ID: ${creator.id}`);
                    console.log(`   VAs associ√©s: ${creator.vaIds ? creator.vaIds.map(id => data.vas.find(v => v.id === id)?.name).join(', ') : 'Aucun'}`);
                    console.log(`   Nombre de comptes: ${creator.accounts ? creator.accounts.length : 0}`);
                    
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(account => {
                            console.log(`     - ${account.username}`);
                        });
                    }
                });
                
                console.log('\nüìç Vue par VA:');
                console.log('='.repeat(50));
                
                data.vas.forEach(va => {
                    console.log(`\nüè¢ VA: ${va.name}`);
                    const vaCreators = data.creators.filter(c => c.vaIds && c.vaIds.includes(va.id));
                    
                    vaCreators.forEach(creator => {
                        console.log(`   üë§ ${creator.name}: ${creator.accounts ? creator.accounts.length : 0} comptes`);
                        if (creator.accounts) {
                            creator.accounts.forEach(acc => {
                                console.log(`      - ${acc.username}`);
                            });
                        }
                    });
                });
            };
            
            // Exposer la fonction de r√©cup√©ration dans la console
            window.recoverTwitterAccounts = function() {
                console.log('üîß R√©cup√©ration manuelle des comptes Twitter...');
                const result = recoverLostTwitterAccounts();
                if (result) {
                    updateDisplay();
                    updateTwitterAccountsList();
                    updateTwitterUnassignedDisplay();
                    saveData(); // Sauvegarder apr√®s r√©cup√©ration
                }
                return result;
            };
            
            // Fonction pour transf√©rer un compte Twitter d'un VA √† un autre
            window.transferTwitterAccount = function(username, fromVAName, toVAName) {
                console.log(`üîÑ Transfert de ${username} de ${fromVAName} vers ${toVAName}...`);
                
                // Trouver les VAs
                const fromVA = data.vas.find(v => v.name.toLowerCase() === fromVAName.toLowerCase());
                const toVA = data.vas.find(v => v.name.toLowerCase() === toVAName.toLowerCase());
                
                if (!fromVA || !toVA) {
                    console.error('‚ùå VA source ou destination non trouv√©');
                    return false;
                }
                
                // Chercher la cr√©atrice qui poss√®de ce compte
                let targetCreator = null;
                let targetAccount = null;
                
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        const account = creator.accounts.find(a => 
                            a.username.toLowerCase() === username.toLowerCase() ||
                            a.username.toLowerCase() === '@' + username.toLowerCase().replace('@', '')
                        );
                        if (account && creator.vaIds && creator.vaIds.includes(fromVA.id)) {
                            targetCreator = creator;
                            targetAccount = account;
                        }
                    }
                });
                
                if (!targetCreator || !targetAccount) {
                    console.error(`‚ùå Compte ${username} non trouv√© pour ${fromVAName}`);
                    return false;
                }
                
                // Transf√©rer le VA
                console.log(`‚úÖ Compte trouv√©: ${targetAccount.username} (cr√©atrice: ${targetCreator.name})`);
                
                // Retirer l'ancien VA
                const fromIndex = targetCreator.vaIds.indexOf(fromVA.id);
                if (fromIndex > -1) {
                    targetCreator.vaIds.splice(fromIndex, 1);
                }
                
                // Ajouter le nouveau VA
                if (!targetCreator.vaIds.includes(toVA.id)) {
                    targetCreator.vaIds.push(toVA.id);
                }
                
                console.log(`‚úÖ Transfert effectu√© !`);
                console.log(`   Cr√©atrice ${targetCreator.name} est maintenant associ√©e √†: ${targetCreator.vaIds.map(id => data.vas.find(v => v.id === id)?.name).join(', ')}`);
                
                // Sauvegarder et mettre √† jour
                saveData();
                updateDisplay();
                updateTwitterAccountsList();
                
                return true;
            };
            
            // Fonction pour fusionner les cr√©atrices dupliqu√©es
            window.mergeDuplicateCreators = function() {
                console.log('üîÑ Recherche de cr√©atrices dupliqu√©es...');
                
                const creatorsByName = {};
                const toRemove = [];
                
                // Grouper les cr√©atrices par nom
                data.creators.forEach((creator, index) => {
                    if (!creatorsByName[creator.name]) {
                        creatorsByName[creator.name] = [];
                    }
                    creatorsByName[creator.name].push({ creator, index });
                });
                
                // Fusionner les doublons
                Object.keys(creatorsByName).forEach(name => {
                    if (creatorsByName[name].length > 1) {
                        console.log(`üìå Trouv√© ${creatorsByName[name].length} instances de "${name}"`);
                        
                        // Garder la premi√®re et fusionner les autres
                        const main = creatorsByName[name][0].creator;
                        
                        for (let i = 1; i < creatorsByName[name].length; i++) {
                            const duplicate = creatorsByName[name][i].creator;
                            
                            // Fusionner les vaIds
                            if (duplicate.vaIds) {
                                duplicate.vaIds.forEach(vaId => {
                                    if (!main.vaIds) main.vaIds = [];
                                    if (!main.vaIds.includes(vaId)) {
                                        main.vaIds.push(vaId);
                                    }
                                });
                            }
                            
                            // Fusionner les comptes
                            if (duplicate.accounts) {
                                duplicate.accounts.forEach(account => {
                                    if (!main.accounts) main.accounts = [];
                                    // V√©rifier si le compte n'existe pas d√©j√†
                                    const exists = main.accounts.some(a => a.username === account.username);
                                    if (!exists) {
                                        main.accounts.push(account);
                                    }
                                });
                            }
                            
                            // Marquer pour suppression
                            toRemove.push(creatorsByName[name][i].index);
                        }
                        
                        console.log(`‚úÖ Fusionn√© dans une seule instance avec VAs: [${main.vaIds.join(', ')}]`);
                    }
                });
                
                // Supprimer les doublons (en partant de la fin pour ne pas d√©caler les indices)
                toRemove.sort((a, b) => b - a).forEach(index => {
                    data.creators.splice(index, 1);
                });
                
                if (toRemove.length > 0) {
                    console.log(`üéâ ${toRemove.length} doublons supprim√©s`);
                    saveData();
                    updateDisplay();
                    updateAllCreatorsTable();
                } else {
                    console.log('‚úÖ Aucun doublon trouv√©');
                }
                
                return toRemove.length;
            };
            
            // Fonction de diagnostic pour voir ce qu'il y a dans localStorage
            window.debugStorage = function() {
                console.log('üîç Contenu de localStorage:');
                const keys = Object.keys(localStorage);
                console.log(`Total: ${keys.length} cl√©s`);
                
                keys.forEach(key => {
                    if (key.includes('vaManager')) {
                        const value = localStorage.getItem(key);
                        console.log(`\nüì¶ ${key}:`);
                        try {
                            const data = JSON.parse(value);
                            let twitterCount = 0;
                            if (data.vas) {
                                data.vas.forEach(va => {
                                    if (va.creators) {
                                        va.creators.forEach(creator => {
                                            twitterCount += (creator.accounts ? creator.accounts.length : 0);
                                        });
                                    }
                                });
                            }
                            console.log(`  - VAs: ${data.vas?.length || 0}`);
                            console.log(`  - Cr√©atrices (nouvelle): ${data.creators?.length || 0}`);
                            console.log(`  - Comptes Twitter (ancienne structure): ${twitterCount}`);
                        } catch (e) {
                            console.log(`  - Taille: ${value.length} caract√®res`);
                        }
                    }
                });
                
                return keys.filter(k => k.includes('vaManager'));
            };
            
            // Auto-fix navigation apr√®s le chargement
            setTimeout(() => {
                console.log('üîß Auto-fixing navigation...');
                window.fixNav();
            }, 500);
            
            // Afficher l'avertissement de s√©curit√© si pas encore vu
            if (!localStorage.getItem('securityWarningDismissed')) {
                document.getElementById('security-warning').style.display = 'block';
            }
        });

        // ========== DATABASE SYSTEM ==========
        
        class FileSystemDB {
            constructor() {
                this.basePath = 'D:\\claude\\va_manager\\database';
                this.supportsFileSystem = false; // D√âSACTIV√â pour √©viter les t√©l√©chargements
                this.directoryHandle = null;
                this.isInitialized = false;
            }
            
            async init() {
                if (this.isInitialized) return;
                
                try {
                    // File System API d√©sactiv√© - utiliser uniquement localStorage
                    console.log('üìå Syst√®me de fichiers d√©sactiv√© - utilisation de localStorage uniquement');
                    this.fallbackToLocalStorage();
                    this.isInitialized = true;
                } catch (error) {
                    console.warn('Erreur initialisation:', error);
                    this.fallbackToLocalStorage();
                }
            }
            
            async migrateFromLocalStorage() {
                const savedData = localStorage.getItem('vaManagerProData');
                
                // Only migrate if user hasn't already migrated (check for migration flag)
                const migrationDone = localStorage.getItem('migrationToFileSystemDone');
                if (savedData && !migrationDone) {
                    console.log('üîÑ Migration disponible mais pas automatique - utilisez le bouton "Migrer vers Fichiers"');
                } else if (migrationDone) {
                    console.log('‚úÖ Migration d√©j√† effectu√©e');
                } else {
                    console.log('‚ÑπÔ∏è Aucune donn√©e √† migrer');
                }
            }
            
            fallbackToLocalStorage() {
                this.supportsFileSystem = false;
                console.log('Using localStorage fallback');
            }
            
            async saveVAs(vasData) {
                // For normal saves, always use localStorage only
                const currentData = this.loadFromLocalStorage();
                currentData.vas = vasData;
                localStorage.setItem('vaManagerProData', JSON.stringify(currentData));
            }
            
            async saveSubs(subsData) {
                // For normal saves, always use localStorage only
                const currentData = this.loadFromLocalStorage();
                currentData.subs = subsData;
                localStorage.setItem('vaManagerProData', JSON.stringify(currentData));
            }
            
            async saveRevenues(revenuesData) {
                // For normal saves, always use localStorage only
                const currentData = this.loadFromLocalStorage();
                currentData.revenues = revenuesData;
                localStorage.setItem('vaManagerProData', JSON.stringify(currentData));
            }
            
            async savePayments(paymentsData) {
                // For normal saves, always use localStorage only
                const currentData = this.loadFromLocalStorage();
                currentData.vaPayments = paymentsData;
                localStorage.setItem('vaManagerProData', JSON.stringify(currentData));
            }
            
            async saveAllData() {
                // Always use localStorage for normal saves
                localStorage.setItem('vaManagerProData', JSON.stringify(data));
                
                // File system downloads only on manual migration
                return Promise.resolve();
            }
            
            downloadJSON(filename, jsonData) {
                // D√âSACTIV√â - Ne pas t√©l√©charger automatiquement
                console.log(`üìå T√©l√©chargement d√©sactiv√© pour: ${filename}`);
                return Promise.resolve();
            }
            
            // M√©thode pour t√©l√©chargement manuel uniquement
            manualDownloadJSON(filename, jsonData) {
                const dataStr = JSON.stringify(jsonData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                
                URL.revokeObjectURL(url);
                return Promise.resolve();
            }
            
            showFileInstructions(filename) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8); display: flex; align-items: center;
                    justify-content: center; z-index: 10000;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; text-align: center;">
                        <h3 style="color: #16a34a; margin-bottom: 1rem;">
                            <i class="fas fa-download"></i> Fichier t√©l√©charg√©
                        </h3>
                        <p style="margin-bottom: 1.5rem;">
                            Le fichier <strong>${filename}</strong> a √©t√© t√©l√©charg√©.<br>
                            Veuillez le d√©placer vers :<br>
                            <code style="background: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; display: block; margin: 1rem 0;">
                                D:\\claude\\va_manager\\database\\
                            </code>
                        </p>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: #16a34a; color: white; border: none; padding: 0.75rem 1.5rem;
                            border-radius: 0.5rem; cursor: pointer; font-weight: 600;
                        ">
                            Compris !
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (document.body.contains(modal)) {
                        modal.remove();
                    }
                }, 10000);
            }
            
            loadFromLocalStorage() {
                const savedData = localStorage.getItem('vaManagerProData');
                return savedData ? JSON.parse(savedData) : {
                    vas: [],
                    subs: [],
                    revenues: [],
                    payments: [],
                    vaPayments: [],
                    gmailAccounts: [],
                    creators: [],
                    twitterAccounts: [],
                    instagramAccounts: [],
                    twitterStats: []
                };
            }
        }
        
        // Initialize database system
        const fileDB = new FileSystemDB();
        
        // Rebuild VA creators for compatibility with old code
        function rebuildVACreators() {
            console.log('    üèóÔ∏è RebuildVACreators - D√©but...');
            data.vas.forEach(va => {
                console.log(`      - VA "${va.name}" (ID: ${va.id})`);
                va.creators = [];
                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.vaIds && creator.vaIds.includes(va.id)) {
                            va.creators.push(creator);
                            console.log(`        ‚úì Ajout cr√©atrice "${creator.name}" avec ${creator.accounts?.length || 0} comptes`);
                        }
                    });
                }
                console.log(`        Total cr√©atrices pour ${va.name}: ${va.creators.length}`);
            });
            console.log('    üèóÔ∏è RebuildVACreators - Termin√©');
        }
        
        // Fonction de r√©cup√©ration d'urgence pour les comptes Twitter perdus
        function recoverLostTwitterAccounts() {
            console.log('üö® Tentative de r√©cup√©ration des comptes Twitter perdus...');
            
            try {
                // Essayer d'abord avec les donn√©es actuelles
                let rawData = localStorage.getItem('vaManagerData');
                
                // Si pas de donn√©es, essayer les backups
                if (!rawData) {
                    console.log('üíæ Recherche dans les sauvegardes...');
                    const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('vaManager_backup_'));
                    
                    if (backupKeys.length > 0) {
                        // Trier par date (le plus r√©cent en premier)
                        backupKeys.sort().reverse();
                        console.log(`üì¶ ${backupKeys.length} sauvegardes trouv√©es`);
                        
                        // Essayer avec la sauvegarde la plus r√©cente
                        rawData = localStorage.getItem(backupKeys[0]);
                        console.log(`üìÇ Utilisation de la sauvegarde: ${backupKeys[0]}`);
                    }
                }
                
                if (!rawData) {
                    console.log('‚ùå Aucune donn√©e trouv√©e dans localStorage ni dans les sauvegardes');
                    showError('Aucune donn√©e de sauvegarde trouv√©e. Les comptes Twitter semblent d√©finitivement perdus.');
                    return false;
                }
                
                const storedData = JSON.parse(rawData);
                let recoveredAccounts = 0;
                
                // Parcourir les VAs dans localStorage
                storedData.vas?.forEach(storedVa => {
                    if (storedVa.creators && storedVa.creators.length > 0) {
                        storedVa.creators.forEach(storedCreator => {
                            if (storedCreator.accounts && storedCreator.accounts.length > 0) {
                                // Trouver ou cr√©er la cr√©atrice dans la nouvelle structure
                                let creator = data.creators.find(c => c.name === storedCreator.name);
                                
                                if (!creator) {
                                    // Cr√©er la cr√©atrice si elle n'existe pas
                                    creator = {
                                        id: storedCreator.id || 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                        name: storedCreator.name,
                                        vaIds: [storedVa.id],
                                        accounts: []
                                    };
                                    data.creators.push(creator);
                                    console.log(`‚úÖ Cr√©atrice "${creator.name}" recr√©√©e`);
                                }
                                
                                // R√©cup√©rer les comptes
                                if (!creator.accounts) creator.accounts = [];
                                
                                storedCreator.accounts.forEach(account => {
                                    // V√©rifier si le compte n'existe pas d√©j√†
                                    const exists = creator.accounts.some(a => a.username === account.username);
                                    if (!exists) {
                                        creator.accounts.push(account);
                                        recoveredAccounts++;
                                        console.log(`  ‚úÖ Compte r√©cup√©r√©: ${account.username}`);
                                    }
                                });
                                
                                // S'assurer que le VA est dans la liste
                                if (!creator.vaIds) creator.vaIds = [];
                                if (!creator.vaIds.includes(storedVa.id)) {
                                    creator.vaIds.push(storedVa.id);
                                }
                            }
                        });
                    }
                });
                
                if (recoveredAccounts > 0) {
                    console.log(`üéâ ${recoveredAccounts} comptes Twitter r√©cup√©r√©s !`);
                    return true;
                } else {
                    console.log('‚ùå Aucun compte Twitter trouv√© √† r√©cup√©rer');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la r√©cup√©ration:', error);
                return false;
            }
        }

        // Load data
        async function loadData() {
            await fileDB.init();
            
            // Load from localStorage (which may have been migrated)
            const loadedData = fileDB.loadFromLocalStorage();
            
            data.vas = loadedData.vas || [];
            data.subs = loadedData.subs || [];
            data.revenues = loadedData.revenues || [];
            data.payments = loadedData.payments || [];
            data.vaPayments = loadedData.vaPayments || [];
            data.gmailAccounts = loadedData.gmailAccounts || [];
            data.creators = loadedData.creators || [];
            data.twitterAccounts = loadedData.twitterAccounts || [];
            data.instagramAccounts = loadedData.instagramAccounts || [];
            data.twitterStats = loadedData.twitterStats || [];
            
            // Migration compl√®te des cr√©atrices vers la nouvelle structure
            if (!loadedData.creators || loadedData.creators.length === 0) {
                console.log('üîÑ Migration des cr√©atrices vers la nouvelle structure...');
                data.creators = [];
                const creatorMapping = {}; // Pour garder la correspondance des IDs
                
                data.vas.forEach(va => {
                    if (va.creators && va.creators.length > 0) {
                        const newCreatorIds = [];
                        
                        va.creators.forEach(oldCreator => {
                            // Ne pas migrer les "Twitter Accounts"
                            if (oldCreator.name !== 'Twitter Accounts') {
                                // V√©rifier si la cr√©atrice existe d√©j√† dans la nouvelle structure
                                let existingCreator = data.creators.find(c => c.name === oldCreator.name);
                                
                                if (!existingCreator) {
                                    // Cr√©er la nouvelle cr√©atrice
                                    existingCreator = {
                                        id: oldCreator.id || 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                        name: oldCreator.name,
                                        vaIds: [va.id], // Array pour supporter plusieurs VAs
                                        accounts: oldCreator.accounts || []
                                    };
                                    data.creators.push(existingCreator);
                                } else {
                                    // Ajouter ce VA √† la liste des VAs de cette cr√©atrice
                                    if (!existingCreator.vaIds) existingCreator.vaIds = [];
                                    if (!existingCreator.vaIds.includes(va.id)) {
                                        existingCreator.vaIds.push(va.id);
                                    }
                                    // Fusionner les comptes
                                    if (oldCreator.accounts && oldCreator.accounts.length > 0) {
                                        if (!existingCreator.accounts) existingCreator.accounts = [];
                                        existingCreator.accounts = existingCreator.accounts.concat(oldCreator.accounts);
                                    }
                                }
                                
                                creatorMapping[oldCreator.id] = existingCreator.id;
                                newCreatorIds.push(existingCreator.id);
                            }
                        });
                        
                        // Remplacer l'ancienne structure par des r√©f√©rences
                        va.creatorIds = newCreatorIds;
                        delete va.creators; // Supprimer l'ancienne structure
                    }
                });
                
                console.log(`‚úÖ Migration termin√©e: ${data.creators.length} cr√©atrices migr√©es`);
                saveData(); // Sauvegarder imm√©diatement apr√®s migration
            }
            
            // Reconstruire la propri√©t√© creators sur chaque VA pour la compatibilit√©
            rebuildVACreators();
            
            // Compter le nombre total de cr√©atrices
            let totalCreators = data.creators ? data.creators.length : 0;
            
            // Diagnostic temporaire pour d√©boguer
            console.log('üìä Diagnostic des donn√©es:');
            console.log('Total cr√©atrices:', totalCreators);
            let totalAccounts = 0;
            let accountsWithoutGmail = 0;
            
            // V√©rifier la nouvelle structure
            console.log('üìÇ Nouvelle structure (data.creators):');
            data.creators?.forEach(creator => {
                const accounts = creator.accounts ? creator.accounts.length : 0;
                totalAccounts += accounts;
                creator.accounts?.forEach(acc => {
                    if (!acc.gmailId) accountsWithoutGmail++;
                });
                console.log(`  - ${creator.name}: ${accounts} comptes, VAs: [${creator.vaIds?.join(', ') || 'aucun'}]`);
                if (accounts > 0) {
                    creator.accounts.forEach(acc => {
                        console.log(`    ‚Üí ${acc.username}`);
                    });
                }
            });
            
            // V√©rifier l'ancienne structure
            console.log('üìÇ Ancienne structure (va.creators):');
            let oldStructureAccounts = 0;
            data.vas?.forEach(va => {
                if (va.creators && va.creators.length > 0) {
                    console.log(`  VA: ${va.name}`);
                    va.creators.forEach(creator => {
                        const accounts = creator.accounts ? creator.accounts.length : 0;
                        oldStructureAccounts += accounts;
                        console.log(`    - ${creator.name}: ${accounts} comptes`);
                        if (accounts > 0) {
                            creator.accounts.forEach(acc => {
                                console.log(`      ‚Üí ${acc.username}`);
                            });
                        }
                    });
                }
            });
            
            console.log(`‚ö†Ô∏è Total comptes dans nouvelle structure: ${totalAccounts}`);
            console.log(`‚ö†Ô∏è Total comptes dans ancienne structure: ${oldStructureAccounts}`);
            
            // V√©rifier directement dans localStorage
            console.log('üíæ V√©rification localStorage brut:');
            try {
                const rawData = localStorage.getItem('vaManagerData');
                if (rawData) {
                    const storedData = JSON.parse(rawData);
                    let localStorageAccounts = 0;
                    storedData.vas?.forEach(va => {
                        if (va.creators) {
                            va.creators.forEach(creator => {
                                localStorageAccounts += (creator.accounts ? creator.accounts.length : 0);
                            });
                        }
                    });
                    console.log(`  - Comptes dans localStorage (ancienne structure): ${localStorageAccounts}`);
                }
            } catch (e) {
                console.error('Erreur lors de la lecture de localStorage:', e);
            }
            
            console.log('‚úÖ Donn√©es charg√©es:', {
                vas: data.vas.length,
                creators: totalCreators,
                subs: data.subs.length,
                revenues: data.revenues.length,
                vaPayments: data.vaPayments.length,
                gmailAccounts: data.gmailAccounts.length
            });
            
            // Tenter de r√©cup√©rer les comptes Twitter perdus
            if (totalAccounts === 0 && oldStructureAccounts === 0) {
                console.log('‚ö†Ô∏è Aucun compte Twitter d√©tect√© - lancement de la r√©cup√©ration...');
                if (recoverLostTwitterAccounts()) {
                    console.log('üîÑ Rechargement de l\'interface...');
                    updateDisplay();
                }
            }
        }

        // Save data with new system
        async function saveData() {
            console.log('üíæ SAVE DATA - D√©but de la sauvegarde...');
            try {
                // Reconstruire les creators des VAs avant de sauvegarder
                console.log('  üîß Reconstruction des creators des VAs...');
                rebuildVACreators();
                
                // Marquer que les donn√©es ont √©t√© modifi√©es
                console.log('  üìù Marquage des donn√©es comme modifi√©es...');
                markDataModified();
                
                // Animation de sauvegarde
                animateSaveButton();
                updateSaveStatus('saving');
                
                // Sauvegarde principale
                await fileDB.saveAllData();
                
                // Sauvegarde de s√©curit√© dans localStorage
                const backupData = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                localStorage.setItem('vaManagerProData', JSON.stringify(data));
                localStorage.setItem('vaManagerProData_backup', JSON.stringify(backupData));
                
                // Historique des sauvegardes (garder les 10 derni√®res)
                updateBackupHistory(backupData);
                
                console.log('  ‚úÖ Sauvegarde compl√©t√©e');
                console.log('  üîÑ Mise √† jour de l\'affichage...');
                updateDisplay();
                updateSaveStatus('saved');
                console.log('üíæ SAVE DATA - Termin√©');
                
                // Auto backup toutes les heures
                const lastBackup = localStorage.getItem('lastAutoBackup');
                const now = Date.now();
                const oneHourMs = 60 * 60 * 1000;
                
                if (!lastBackup || (now - parseInt(lastBackup)) > oneHourMs) {
                    await createAutoBackup();
                    localStorage.setItem('lastAutoBackup', now.toString());
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                updateSaveStatus('error');
                // Fallback to localStorage only
                localStorage.setItem('vaManagerProData', JSON.stringify(data));
                updateDisplay();
            }
        }
        
        // Animation du bouton de sauvegarde
        function animateSaveButton() {
            const pulse = document.getElementById('save-pulse');
            if (pulse) {
                pulse.style.transition = 'transform 0.6s ease-out, opacity 0.6s ease-out';
                pulse.style.transform = 'translate(-50%, -50%) scale(0)';
                pulse.style.opacity = '0';
                
                setTimeout(() => {
                    pulse.style.transform = 'translate(-50%, -50%) scale(2)';
                    pulse.style.opacity = '1';
                }, 10);
                
                setTimeout(() => {
                    pulse.style.opacity = '0';
                }, 300);
            }
        }
        
        // Mise √† jour du statut de sauvegarde
        function updateSaveStatus(status) {
            const statusDiv = document.getElementById('save-status');
            const statusText = document.getElementById('save-status-text');
            const statusIcon = statusDiv.querySelector('i');
            
            switch(status) {
                case 'saving':
                    statusIcon.className = 'fas fa-spinner fa-spin';
                    statusIcon.style.color = '#f59e0b';
                    statusText.textContent = 'Sauvegarde...';
                    statusText.style.color = '#f59e0b';
                    statusDiv.style.background = 'rgba(245, 158, 11, 0.1)';
                    statusDiv.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                    break;
                case 'saved':
                    statusIcon.className = 'fas fa-shield-alt';
                    statusIcon.style.color = '#22c55e';
                    statusText.textContent = 'Prot√©g√©';
                    statusText.style.color = '#22c55e';
                    statusDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                    statusDiv.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                    
                    // Afficher l'heure de la derni√®re sauvegarde apr√®s 2 secondes
                    setTimeout(() => {
                        const now = new Date();
                        statusText.textContent = `Sauv√© √† ${now.toLocaleTimeString()}`;
                    }, 2000);
                    break;
                case 'error':
                    statusIcon.className = 'fas fa-exclamation-triangle';
                    statusIcon.style.color = '#ef4444';
                    statusText.textContent = 'Erreur';
                    statusText.style.color = '#ef4444';
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                    statusDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                    break;
            }
        }
        
        // Historique des sauvegardes
        function updateBackupHistory(backupData) {
            let history = [];
            try {
                const stored = localStorage.getItem('vaManagerProBackupHistory');
                if (stored) {
                    history = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Erreur lecture historique:', e);
            }
            
            // Ajouter la nouvelle sauvegarde
            history.unshift(backupData);
            
            // Garder seulement les 10 derni√®res
            history = history.slice(0, 10);
            
            // Sauvegarder l'historique
            localStorage.setItem('vaManagerProBackupHistory', JSON.stringify(history));
        }
        
        async function createAutoBackup() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const backupData = {
                ...data,
                backup_info: {
                    created: new Date().toISOString(),
                    type: 'auto',
                    version: '2.0.0'
                }
            };
            
            try {
                // Sauvegarder dans localStorage au lieu de t√©l√©charger
                localStorage.setItem(`vaManagerProBackup_${timestamp}`, JSON.stringify(backupData));
                console.log('‚úÖ Sauvegarde automatique cr√©√©e dans localStorage');
                
                // Nettoyer les vieilles sauvegardes (garder seulement les 5 derni√®res)
                const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('vaManagerProBackup_')).sort();
                if (backupKeys.length > 5) {
                    const toRemove = backupKeys.slice(0, backupKeys.length - 5);
                    toRemove.forEach(key => localStorage.removeItem(key));
                }
            } catch (error) {
                console.warn('‚ùå √âchec sauvegarde auto:', error);
            }
        }
        
        async function migrateToFileSystem() {
            if (!confirm('Voulez-vous migrer vos donn√©es vers le syst√®me de fichiers structur√© ?\n\nCela va t√©l√©charger plusieurs fichiers JSON organis√©s par type de donn√©es.')) {
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            
            try {
                // Create organized files
                if (data.vas && data.vas.length > 0) {
                    await fileDB.downloadJSON('vas.json', {
                        vas: data.vas,
                        last_updated: new Date().toISOString(),
                        version: '2.0.0'
                    });
                }
                
                if (data.subs && data.subs.length > 0) {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    await fileDB.downloadJSON(`subs_${currentMonth}.json`, {
                        subs: data.subs,
                        month: currentMonth,
                        total_subs: data.subs.reduce((sum, s) => sum + s.count, 0),
                        total_amount: data.subs.reduce((sum, s) => sum + s.amount, 0),
                        last_updated: new Date().toISOString()
                    });
                }
                
                if (data.revenues && data.revenues.length > 0) {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    await fileDB.downloadJSON(`revenues_${currentMonth}.json`, {
                        revenues: data.revenues,
                        month: currentMonth,
                        total_amount: data.revenues.reduce((sum, r) => sum + r.amount, 0),
                        total_commissions: data.revenues.reduce((sum, r) => sum + r.commission, 0),
                        last_updated: new Date().toISOString()
                    });
                }
                
                if (data.vaPayments && data.vaPayments.length > 0) {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    await fileDB.downloadJSON(`payments_${currentMonth}.json`, {
                        vaPayments: data.vaPayments,
                        month: currentMonth,
                        total_paid: data.vaPayments.reduce((sum, p) => sum + p.amount, 0),
                        last_updated: new Date().toISOString()
                    });
                }
                
                // Create complete backup
                await fileDB.downloadJSON(`complete_backup_${timestamp}.json`, {
                    ...data,
                    migration_info: {
                        created: new Date().toISOString(),
                        type: 'migration',
                        version: '2.0.0',
                        source: 'localStorage'
                    }
                });
                
                // Mark migration as done
                localStorage.setItem('migrationToFileSystemDone', 'true');
                
                // Show success message
                alert('‚úÖ Migration termin√©e !\n\nTous vos fichiers ont √©t√© t√©l√©charg√©s.\nD√©placez-les dans : D:\\claude\\va_manager\\database\\');
                
            } catch (error) {
                alert('‚ùå Erreur lors de la migration : ' + error.message);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = this.dataset.page;
                    navigateToPage(page);
                });
            });

            // Forms
            document.getElementById('add-va-form').addEventListener('submit', addVA);
            document.getElementById('add-creator-form').addEventListener('submit', addCreator);
            document.getElementById('add-account-form').addEventListener('submit', addAccount);
            document.getElementById('add-gmail-form').addEventListener('submit', addGmailAccount);
            document.getElementById('search-input').addEventListener('input', performSearch);

            // VA selection change for account form
            // Supprim√© car plus besoin de s√©lectionner la cr√©atrice
            
            // Supprim√© car plus besoin de ces listeners
        }

        // Navigation
        function navigateToPage(pageName) {
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Update subs display when navigating to subs tracking page
            if (pageName === 'subs-tracking') {
                updateCompetitionDisplay();
            }
            
            // Update revenue display when navigating to revenue tracking page
            if (pageName === 'revenue-tracking') {
                updateRevenueDisplay();
            }
            
            // Update financial overview when navigating to that page
            if (pageName === 'financial-overview') {
                updateFinancialOverview();
            }
            
            // Update existing creators list when navigating to add-creator page
            if (pageName === 'add-creator') {
                updateAllCreatorsTable();
            }
            
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                closeMobileMenu();
            }
            
            // Update VA selects when navigating to add-account page
            if (pageName === 'add-account') {
                updateVASelects();
                updateTwitterAccountsList();
                // Reset the form
                document.getElementById('add-account-form').reset();
            }
            
            // Update Gmail accounts when navigating to gmail-accounts page
            if (pageName === 'gmail-accounts') {
                updateGmailAccountsList();
                // Reset the form
                document.getElementById('add-gmail-form').reset();
            }
            
            // Force dark backgrounds if dark mode is active
            if (document.body.classList.contains('dark-mode')) {
                forceAllDarkBackgrounds();
            }
        }

        // ========== ORPHAN DATA CLEANUP SYSTEM ==========
        // Find and clean orphan data
        function findOrphanData() {
            const orphans = {
                creators: {
                    withoutVA: [],
                    withDeletedVA: []
                },
                accounts: {
                    withInvalidGmail: [],
                    withDeletedCreator: []
                },
                gmail: {
                    withDeletedVA: [],
                    withInvalidTwitterRef: []
                },
                financial: {
                    subsWithDeletedVA: [],
                    revenuesWithDeletedVA: [],
                    paymentsWithDeletedVA: []
                }
            };
            
            // Find orphan creators
            if (data.creators) {
                data.creators.forEach(creator => {
                    // Creators without VA
                    if (!creator.vaIds || creator.vaIds.length === 0) {
                        orphans.creators.withoutVA.push(creator);
                    } else {
                        // Creators with deleted VAs
                        const hasValidVA = creator.vaIds.some(vaId => 
                            data.vas.find(v => v.id === vaId)
                        );
                        if (!hasValidVA) {
                            orphans.creators.withDeletedVA.push(creator);
                        }
                    }
                });
            }
            
            // Find orphan Twitter accounts
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        // Accounts with invalid Gmail reference
                        if (account.gmailId) {
                            const gmailExists = data.gmailAccounts.find(g => g.id === account.gmailId);
                            if (!gmailExists) {
                                orphans.accounts.withInvalidGmail.push({
                                    account,
                                    creator: creator.name
                                });
                            }
                        }
                    });
                }
            });
            
            // Find orphan Gmail accounts
            data.gmailAccounts.forEach(gmail => {
                // Gmail with deleted VA
                if (gmail.vaId) {
                    const vaExists = data.vas.find(v => v.id === gmail.vaId);
                    if (!vaExists) {
                        orphans.gmail.withDeletedVA.push(gmail);
                    }
                }
                
                // Gmail with invalid Twitter reference
                if (gmail.assignedTwitterUsername) {
                    let twitterExists = false;
                    data.creators.forEach(creator => {
                        if (creator.accounts) {
                            if (creator.accounts.find(a => a.username === gmail.assignedTwitterUsername)) {
                                twitterExists = true;
                            }
                        }
                    });
                    if (!twitterExists) {
                        orphans.gmail.withInvalidTwitterRef.push(gmail);
                    }
                }
            });
            
            // Find orphan financial data
            if (data.subs) {
                data.subs.forEach(sub => {
                    if (sub.vaId && !data.vas.find(v => v.id === sub.vaId)) {
                        orphans.financial.subsWithDeletedVA.push(sub);
                    }
                });
            }
            
            if (data.revenues) {
                data.revenues.forEach(revenue => {
                    if (revenue.vaId && !data.vas.find(v => v.id === revenue.vaId)) {
                        orphans.financial.revenuesWithDeletedVA.push(revenue);
                    }
                });
            }
            
            if (data.vaPayments) {
                data.vaPayments.forEach(payment => {
                    if (payment.vaId && !data.vas.find(v => v.id === payment.vaId)) {
                        orphans.financial.paymentsWithDeletedVA.push(payment);
                    }
                });
            }
            
            return orphans;
        }
        
        // Clean specific orphan data
        function cleanOrphanData(type, subtype) {
            const orphans = findOrphanData();
            let cleaned = 0;
            
            switch(type) {
                case 'creators':
                    if (subtype === 'withoutVA') {
                        orphans.creators.withoutVA.forEach(creator => {
                            const index = data.creators.findIndex(c => c.id === creator.id);
                            if (index !== -1) {
                                data.creators.splice(index, 1);
                                cleaned++;
                            }
                        });
                    } else if (subtype === 'withDeletedVA') {
                        orphans.creators.withDeletedVA.forEach(creator => {
                            creator.vaIds = [];
                            cleaned++;
                        });
                    }
                    break;
                    
                case 'accounts':
                    if (subtype === 'withInvalidGmail') {
                        orphans.accounts.withInvalidGmail.forEach(orphan => {
                            delete orphan.account.gmailId;
                            delete orphan.account.email;
                            cleaned++;
                        });
                    }
                    break;
                    
                case 'gmail':
                    if (subtype === 'withDeletedVA') {
                        orphans.gmail.withDeletedVA.forEach(gmail => {
                            delete gmail.vaId;
                            cleaned++;
                        });
                    } else if (subtype === 'withInvalidTwitterRef') {
                        orphans.gmail.withInvalidTwitterRef.forEach(gmail => {
                            delete gmail.assignedTwitter;
                            delete gmail.assignedTwitterUsername;
                            delete gmail.assignedCreatorId;
                            cleaned++;
                        });
                    }
                    break;
                    
                case 'financial':
                    if (subtype === 'subsWithDeletedVA') {
                        data.subs = data.subs.filter(sub => 
                            !orphans.financial.subsWithDeletedVA.includes(sub)
                        );
                        cleaned = orphans.financial.subsWithDeletedVA.length;
                    } else if (subtype === 'revenuesWithDeletedVA') {
                        data.revenues = data.revenues.filter(revenue => 
                            !orphans.financial.revenuesWithDeletedVA.includes(revenue)
                        );
                        cleaned = orphans.financial.revenuesWithDeletedVA.length;
                    } else if (subtype === 'paymentsWithDeletedVA') {
                        data.vaPayments = data.vaPayments.filter(payment => 
                            !orphans.financial.paymentsWithDeletedVA.includes(payment)
                        );
                        cleaned = orphans.financial.paymentsWithDeletedVA.length;
                    }
                    break;
            }
            
            if (cleaned > 0) {
                saveData();
                showSuccess(`${cleaned} donn√©es orphelines nettoy√©es`);
                updateDisplay();
            }
            
            return cleaned;
        }
        
        // Show orphan data report
        function showOrphanDataReport() {
            const orphans = findOrphanData();
            let totalOrphans = 0;
            let reportHtml = '<h3>Rapport des donn√©es orphelines</h3>';
            
            // Count creators
            if (orphans.creators.withoutVA.length > 0) {
                totalOrphans += orphans.creators.withoutVA.length;
                reportHtml += `<p><strong>Cr√©atrices sans VA:</strong> ${orphans.creators.withoutVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('creators', 'withoutVA')" class="btn-danger btn-small">Supprimer</button></p>`;
            }
            
            if (orphans.creators.withDeletedVA.length > 0) {
                totalOrphans += orphans.creators.withDeletedVA.length;
                reportHtml += `<p><strong>Cr√©atrices avec VAs supprim√©s:</strong> ${orphans.creators.withDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('creators', 'withDeletedVA')" class="btn-warning btn-small">Nettoyer r√©f√©rences</button></p>`;
            }
            
            // Count accounts
            if (orphans.accounts.withInvalidGmail.length > 0) {
                totalOrphans += orphans.accounts.withInvalidGmail.length;
                reportHtml += `<p><strong>Comptes Twitter avec Gmail invalide:</strong> ${orphans.accounts.withInvalidGmail.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('accounts', 'withInvalidGmail')" class="btn-warning btn-small">Nettoyer r√©f√©rences</button></p>`;
            }
            
            // Count Gmail
            if (orphans.gmail.withDeletedVA.length > 0) {
                totalOrphans += orphans.gmail.withDeletedVA.length;
                reportHtml += `<p><strong>Gmail avec VA supprim√©:</strong> ${orphans.gmail.withDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('gmail', 'withDeletedVA')" class="btn-warning btn-small">Nettoyer r√©f√©rences</button></p>`;
            }
            
            if (orphans.gmail.withInvalidTwitterRef.length > 0) {
                totalOrphans += orphans.gmail.withInvalidTwitterRef.length;
                reportHtml += `<p><strong>Gmail avec Twitter invalide:</strong> ${orphans.gmail.withInvalidTwitterRef.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('gmail', 'withInvalidTwitterRef')" class="btn-warning btn-small">Nettoyer r√©f√©rences</button></p>`;
            }
            
            // Count financial
            if (orphans.financial.subsWithDeletedVA.length > 0) {
                totalOrphans += orphans.financial.subsWithDeletedVA.length;
                reportHtml += `<p><strong>Subs avec VA supprim√©:</strong> ${orphans.financial.subsWithDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('financial', 'subsWithDeletedVA')" class="btn-danger btn-small">Supprimer</button></p>`;
            }
            
            if (orphans.financial.revenuesWithDeletedVA.length > 0) {
                totalOrphans += orphans.financial.revenuesWithDeletedVA.length;
                reportHtml += `<p><strong>Revenus avec VA supprim√©:</strong> ${orphans.financial.revenuesWithDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('financial', 'revenuesWithDeletedVA')" class="btn-danger btn-small">Supprimer</button></p>`;
            }
            
            if (orphans.financial.paymentsWithDeletedVA.length > 0) {
                totalOrphans += orphans.financial.paymentsWithDeletedVA.length;
                reportHtml += `<p><strong>Paiements avec VA supprim√©:</strong> ${orphans.financial.paymentsWithDeletedVA.length}`;
                reportHtml += ` <button onclick="cleanOrphanData('financial', 'paymentsWithDeletedVA')" class="btn-danger btn-small">Supprimer</button></p>`;
            }
            
            if (totalOrphans === 0) {
                reportHtml += '<p style="color: #10b981;">‚úÖ Aucune donn√©e orpheline d√©tect√©e!</p>';
            } else {
                reportHtml += `<hr><p><strong>Total:</strong> ${totalOrphans} donn√©es orphelines`;
                reportHtml += ` <button onclick="cleanAllOrphanData()" class="btn-danger">Tout nettoyer</button></p>`;
            }
            
            // Show in modal
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Nettoyage des donn√©es</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        ${reportHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Clean all orphan data
        function cleanAllOrphanData() {
            if (confirm('√ätes-vous s√ªr de vouloir nettoyer toutes les donn√©es orphelines?')) {
                let totalCleaned = 0;
                totalCleaned += cleanOrphanData('creators', 'withoutVA');
                totalCleaned += cleanOrphanData('creators', 'withDeletedVA');
                totalCleaned += cleanOrphanData('accounts', 'withInvalidGmail');
                totalCleaned += cleanOrphanData('gmail', 'withDeletedVA');
                totalCleaned += cleanOrphanData('gmail', 'withInvalidTwitterRef');
                totalCleaned += cleanOrphanData('financial', 'subsWithDeletedVA');
                totalCleaned += cleanOrphanData('financial', 'revenuesWithDeletedVA');
                totalCleaned += cleanOrphanData('financial', 'paymentsWithDeletedVA');
                
                showSuccess(`Total nettoy√©: ${totalCleaned} donn√©es orphelines`);
                document.querySelector('.modal.show').remove();
            }
        }
        
        // ========== UNIFIED VIEW SYSTEM ==========
        // Central entity renderer
        function renderEntity(type, data, viewMode = 'card', options = {}) {
            const renderers = {
                'va': renderVAEntity,
                'creator': renderCreatorEntity
            };
            
            return renderers[type] ? renderers[type](data, viewMode, options) : '';
        }
        
        // Render VA entity
        function renderVAEntity(va, viewMode, options) {
            const creators = data.creators.filter(c => c.vaIds && c.vaIds.includes(va.id));
            const totalAccounts = creators.reduce((sum, c) => sum + (c.accounts ? c.accounts.length : 0), 0);
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            switch(viewMode) {
                case 'card':
                    return `
                        <div class="va-card" data-va-id="${va.id}">
                            <div class="va-header">
                                <h3><i class="fas fa-user-tie"></i> ${va.name}</h3>
                                <div class="va-stats">
                                    <span>${creators.length} cr√©atrices</span>
                                    <span>${totalAccounts} comptes</span>
                                </div>
                            </div>
                            <div class="va-content">
                                ${creators.length === 0 ? 
                                    '<p class="no-data">Aucune cr√©atrice assign√©e</p>' :
                                    creators.map(c => renderEntity('creator', c, 'compact', {vaId: va.id})).join('')
                                }
                            </div>
                            ${options.showActions ? `
                                <div class="va-actions">
                                    <button onclick="deleteVA('${va.id}')" class="btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                case 'option':
                    return `<option value="${va.id}">${va.name} (${creators.length} cr√©atrices)</option>`;
                default:
                    return '';
            }
        }
        
        // Render Creator entity
        function renderCreatorEntity(creator, viewMode, options) {
            const accountCount = creator.accounts ? creator.accounts.length : 0;
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            switch(viewMode) {
                case 'compact':
                    return `
                        <div class="creator-compact" onclick="viewCreator('${options.vaId || ''}', '${creator.id}')">
                            <span class="creator-name">${creator.name}</span>
                            <span class="creator-count">${accountCount}</span>
                        </div>
                    `;
                default:
                    return '';
            }
        }
        
        // Calculate all statistics in one pass
        function calculateGlobalStatistics() {
            console.log('    üìà CalculateGlobalStatistics - D√©but...');
            const stats = {
                vas: data.vas.length,
                creators: data.creators ? data.creators.length : 0,
                twitterTotal: 0,
                gmailTotal: data.gmailAccounts.length,
                monthlyRevenue: 0
            };
            
            // Count Twitter accounts
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        stats.twitterTotal += creator.accounts.length;
                    }
                });
            }
            
            // Calculate monthly revenue
            const savedPeriod = currentFinancialPeriod;
            currentFinancialPeriod = 'current-month';
            const filteredSubs = getFilteredSubsForFinancial();
            const filteredRevenues = getFilteredRevenuesForFinancial();
            stats.monthlyRevenue = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0) + 
                                  filteredRevenues.reduce((sum, rev) => sum + rev.amount, 0);
            currentFinancialPeriod = savedPeriod;
            
            return stats;
        }
        
        // Update display with unified system
        function updateDisplay() {
            console.log('üé® UPDATE DISPLAY - D√©but...');
            const stats = calculateGlobalStatistics();

            // Update global stats
            document.getElementById('total-vas').textContent = stats.vas;
            document.getElementById('total-creators').textContent = stats.creators;
            document.getElementById('total-accounts').textContent = stats.twitterTotal;

            // Debug pour v√©rifier les VAs
            console.log('  üìä Statistiques globales:', {
                totalVAs: stats.vas,
                totalCreators: stats.creators,
                totalTwitter: stats.twitterTotal,
                totalGmail: stats.gmailTotal,
                monthlyRevenue: stats.monthlyRevenue
            });

            document.getElementById('month-revenue').textContent = stats.monthlyRevenue.toFixed(2) + '‚Ç¨';
            
            // Update other displays
            console.log('  üîÑ Mise √† jour des composants...');
            console.log('    - Mise √† jour stats cr√©atrices...');
            updateCreatorsStats();
            console.log('    - Mise √† jour grille VAs...');
            updateVAGrid();
            console.log('    - Mise √† jour liste VAs (page Add VA)...');
            updateVAListDisplay();
            console.log('    - Mise √† jour selects VAs...');
            updateVASelects();
            console.log('    - Mise √† jour liste Gmail...');
            updateGmailAccountsList();
            console.log('    - Mise √† jour Twitter non assign√©s...');
            updateTwitterUnassignedDisplay();
            console.log('    - Mise √† jour formulaires Twitter...');
            updateTwitterFormSelects();
            console.log('    - Mise √† jour tableau classement Twitter...');
            updateTwitterRankingTable();
            console.log('    - Mise √† jour analyse Twitter...');
            updateTwitterAnalytics();
            console.log('üé® UPDATE DISPLAY - Termin√©');
        }

        // Update monthly revenue on dashboard

        // Update stats (now uses unified statistics)
        function updateStats() {
            // This is now handled by updateDisplay()
            // Kept for backward compatibility
        }

        // Update VA list display in Add VA page
        function updateVAListDisplay() {
            const container = document.getElementById('va-list-display');
            const countEl = document.getElementById('va-list-count');

            if (!container || !countEl) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            // Update count
            countEl.textContent = `${data.vas.length} VA${data.vas.length > 1 ? 's' : ''}`;

            if (data.vas.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                        <i class="fas fa-user-slash" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.125rem;">Aucun VA ajout√© pour le moment</p>
                        <p style="font-size: 0.875rem; opacity: 0.7;">Utilisez le formulaire ci-dessus pour ajouter votre premier VA</p>
                    </div>
                `;
                return;
            }

            // Generate VA cards
            container.innerHTML = data.vas.map(va => {
                // Count creators and accounts for this VA
                let creatorsCount = 0;
                let twitterCount = 0;
                let instagramCount = 0;

                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.vaIds && creator.vaIds.includes(va.id)) {
                            creatorsCount++;
                            // Count Twitter accounts
                            if (creator.accounts) {
                                const filteredTwitter = creator.accounts.filter(account => {
                                    if (creator.vaIds.length === 1) return true;
                                    return account.assignedVaId === va.id;
                                });
                                twitterCount += filteredTwitter.length;
                            }
                            // Count Instagram accounts
                            if (creator.instagramAccounts) {
                                const filteredInstagram = creator.instagramAccounts.filter(account => {
                                    if (creator.vaIds.length === 1) return true;
                                    return account.assignedVaId === va.id;
                                });
                                instagramCount += filteredInstagram.length;
                            }
                        }
                    });
                }

                const totalAccounts = twitterCount + instagramCount;

                return `
                    <div style="
                        background: ${isDarkMode ? 'linear-gradient(135deg, #16181d 0%, #1a1d23 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)'};
                        border: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};
                        border-radius: 1rem;
                        padding: 1.5rem;
                        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                        transition: all 0.3s ease;
                        cursor: pointer;
                    "
                    onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(102, 126, 234, 0.2)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0, 0, 0, 0.1)'"
                    onclick="navigateToPage('dashboard')">

                        <!-- VA Header -->
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="
                                    width: 48px;
                                    height: 48px;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 1.25rem;
                                    font-weight: 600;
                                    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
                                ">
                                    ${va.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">
                                        ${va.name}
                                    </h3>
                                    <p style="margin: 0; font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                                        Virtual Assistant
                                    </p>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); deleteVA('${va.id}')"
                                    style="background: ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : 'rgba(239, 68, 68, 0.1)'};
                                           border: none;
                                           border-radius: 50%;
                                           width: 32px;
                                           height: 32px;
                                           display: flex;
                                           align-items: center;
                                           justify-content: center;
                                           cursor: pointer;
                                           transition: all 0.2s ease;
                                           color: #ef4444;"
                                    onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                                    onmouseout="this.style.background='${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : 'rgba(239, 68, 68, 0.1)'}'"
                                    title="Supprimer ce VA">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <!-- Stats -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 1rem;">
                            <div style="
                                background: ${isDarkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.5rem;
                                border: 1px solid ${isDarkMode ? 'rgba(139, 92, 246, 0.2)' : 'rgba(139, 92, 246, 0.1)'};
                                text-align: center;
                            ">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.25rem;">
                                    ${creatorsCount}
                                </div>
                                <div style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                                    Cr√©atrice${creatorsCount > 1 ? 's' : ''}
                                </div>
                            </div>
                            <div style="
                                background: ${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.5rem;
                                border: 1px solid ${isDarkMode ? 'rgba(29, 161, 242, 0.2)' : 'rgba(29, 161, 242, 0.1)'};
                                text-align: center;
                            ">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1da1f2; margin-bottom: 0.25rem;">
                                    ${twitterCount}
                                </div>
                                <div style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                                    Twitter
                                </div>
                            </div>
                            <div style="
                                background: ${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.5rem;
                                border: 1px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.2)' : 'rgba(193, 53, 132, 0.1)'};
                                text-align: center;
                            ">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #c13584; margin-bottom: 0.25rem;">
                                    ${instagramCount}
                                </div>
                                <div style="font-size: 0.75rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                                    Instagram
                                </div>
                            </div>
                        </div>

                        <!-- Total badge -->
                        <div style="margin-top: 1rem; text-align: center; padding-top: 1rem; border-top: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};">
                            <span style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 0.5rem 1rem;
                                border-radius: 1rem;
                                font-size: 0.875rem;
                                font-weight: 600;
                                box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
                            ">
                                <i class="fas fa-hashtag"></i> ${totalAccounts} compte${totalAccounts > 1 ? 's' : ''} total
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update Twitter Ranking Table - R√©capitulatif des cr√©atrices
        function updateTwitterRankingTable() {
            const cardsGrid = document.getElementById('creators-cards-grid');
            const countBadge = document.getElementById('creators-count-badge');
            if (!cardsGrid) return;

            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Collecter les donn√©es par cr√©atrice
            const creatorsData = [];
            
            if (data.creators) {
                data.creators.forEach(creator => {
                    const creatorInfo = {
                        name: creator.name,
                        twitterCount: creator.accounts ? creator.accounts.length : 0,
                        instagramCount: creator.instagramAccounts ? creator.instagramAccounts.length : 0,
                        twitterAccounts: [],
                        instagramAccounts: [],
                        vas: new Set(),
                        gmailOkCount: 0
                    };
                    
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(account => {
                            creatorInfo.twitterAccounts.push(account.username);
                            
                            // Trouver le VA
                            if (account.assignedVaId) {
                                const va = data.vas.find(v => v.id === account.assignedVaId);
                                if (va) creatorInfo.vas.add(va.name);
                            } else if (creator.vaIds && creator.vaIds.length > 0) {
                                creator.vaIds.forEach(vaId => {
                                    const va = data.vas.find(v => v.id === vaId);
                                    if (va) creatorInfo.vas.add(va.name);
                                });
                            }
                            
                            // V√©rifier Gmail
                            let hasGmail = false;
                            
                            // Check dans l'ancien syst√®me
                            if (data.twitterAccounts) {
                                const oldAccount = data.twitterAccounts.find(ta => 
                                    ta.username && ta.username.toLowerCase() === account.username.toLowerCase()
                                );
                                if (oldAccount && oldAccount.gmailId) hasGmail = true;
                            }
                            
                            // Check si le compte a un gmailId directement
                            if (account.gmailId) hasGmail = true;
                            
                            // Check dans les comptes Gmail
                            if (data.gmailAccounts) {
                                const gmail = data.gmailAccounts.find(g => 
                                    g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                                );
                                if (gmail) hasGmail = true;
                            }
                            
                            if (hasGmail) creatorInfo.gmailOkCount++;
                        });
                    }

                    // Ajouter les comptes Instagram
                    if (creator.instagramAccounts && creator.instagramAccounts.length > 0) {
                        creator.instagramAccounts.forEach(account => {
                            creatorInfo.instagramAccounts.push(account.username);

                            // Trouver le VA
                            if (account.assignedVaId) {
                                const va = data.vas.find(v => v.id === account.assignedVaId);
                                if (va) creatorInfo.vas.add(va.name);
                            } else if (creator.vaIds && creator.vaIds.length > 0) {
                                creator.vaIds.forEach(vaId => {
                                    const va = data.vas.find(v => v.id === vaId);
                                    if (va) creatorInfo.vas.add(va.name);
                                });
                            }
                        });
                    }

                    creatorsData.push(creatorInfo);
                });
            }
            
            // Trier par nombre de comptes Twitter d√©croissant
            creatorsData.sort((a, b) => b.twitterCount - a.twitterCount);

            // Update count badge
            if (countBadge) {
                countBadge.textContent = `${creatorsData.length} cr√©atrice${creatorsData.length > 1 ? 's' : ''}`;
            }

            // Si aucune cr√©atrice
            if (creatorsData.length === 0) {
                cardsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                        <i class="fas fa-user-slash" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.125rem;">Aucune cr√©atrice ajout√©e</p>
                    </div>
                `;
                return;
            }

            // G√©n√©rer les cartes modernes
            cardsGrid.innerHTML = creatorsData.map((creator, index) => {
                const rank = index + 1;
                let rankBadge = '';

                if (rank === 1) {
                    rankBadge = `<div style="position: absolute; top: -8px; right: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); z-index: 10;">
                        <i class="fas fa-crown" style="color: white; font-size: 1rem;"></i>
                    </div>`;
                } else if (rank === 2) {
                    rankBadge = `<div style="position: absolute; top: -8px; right: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(156, 163, 175, 0.4); z-index: 10;">
                        <i class="fas fa-medal" style="color: white; font-size: 1rem;"></i>
                    </div>`;
                } else if (rank === 3) {
                    rankBadge = `<div style="position: absolute; top: -8px; right: -8px; width: 36px; height: 36px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4); z-index: 10;">
                        <i class="fas fa-award" style="color: white; font-size: 1rem;"></i>
                    </div>`;
                }

                const vasArray = Array.from(creator.vas);
                const vasDisplay = vasArray.length > 0 ?
                    vasArray.map(va => `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.625rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: 500;">${va}</span>`).join(' ') :
                    `<span style="color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; font-size: 0.75rem;">Aucun VA</span>`;

                const gmailPercentage = creator.twitterCount > 0 ? Math.round((creator.gmailOkCount / creator.twitterCount) * 100) : 0;
                const gmailColor = gmailPercentage === 100 ? '#10b981' : gmailPercentage >= 50 ? '#f59e0b' : '#ef4444';

                const cardId = `creator-card-${index}`;

                return `
                    <div style="
                        position: relative;
                        background: ${isDarkMode ? 'linear-gradient(135deg, #16181d 0%, #1a1d23 100%)' : 'white'};
                        border: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};
                        border-radius: 1rem;
                        padding: 1.5rem;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                        transition: all 0.3s ease;
                    "
                    onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(139, 92, 246, 0.15)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)'">

                        ${rankBadge}

                        <!-- Header avec avatar -->
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.25rem; padding-bottom: 1rem; border-bottom: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};">
                            <div style="
                                width: 56px;
                                height: 56px;
                                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 1.5rem;
                                font-weight: 700;
                                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
                                flex-shrink: 0;
                            ">
                                ${creator.name.charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <h4 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${creator.name}
                                </h4>
                                <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                    ${vasDisplay}
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                            <!-- Twitter -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.75rem;
                                border: 1px solid ${isDarkMode ? 'rgba(29, 161, 242, 0.2)' : 'rgba(29, 161, 242, 0.15)'};
                                text-align: center;
                            ">
                                <i class="fab fa-twitter" style="color: #1da1f2; font-size: 1.25rem; margin-bottom: 0.375rem;"></i>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1da1f2; margin-bottom: 0.125rem;">
                                    ${creator.twitterCount}
                                </div>
                                <div style="font-size: 0.7rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Twitter
                                </div>
                            </div>

                            <!-- Instagram -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.75rem;
                                border: 1px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.2)' : 'rgba(193, 53, 132, 0.15)'};
                                text-align: center;
                            ">
                                <i class="fab fa-instagram" style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.25rem; margin-bottom: 0.375rem;"></i>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #c13584; margin-bottom: 0.125rem;">
                                    ${creator.instagramCount}
                                </div>
                                <div style="font-size: 0.7rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Instagram
                                </div>
                            </div>

                            <!-- Gmail -->
                            <div style="
                                background: ${isDarkMode ? 'rgba(234, 67, 53, 0.1)' : 'rgba(234, 67, 53, 0.05)'};
                                padding: 0.75rem;
                                border-radius: 0.75rem;
                                border: 1px solid ${isDarkMode ? `rgba(234, 67, 53, 0.2)` : `rgba(234, 67, 53, 0.15)`};
                                text-align: center;
                            ">
                                <i class="fas fa-envelope" style="color: ${gmailColor}; font-size: 1.25rem; margin-bottom: 0.375rem;"></i>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${gmailColor}; margin-bottom: 0.125rem;">
                                    ${gmailPercentage}%
                                </div>
                                <div style="font-size: 0.7rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em;">
                                    Gmail OK
                                </div>
                            </div>
                        </div>

                        <!-- Details Button -->
                        <button onclick="toggleCreatorDetails('${cardId}')" style="
                            width: 100%;
                            padding: 0.625rem;
                            background: ${isDarkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.05)'};
                            border: 1px solid ${isDarkMode ? 'rgba(139, 92, 246, 0.2)' : 'rgba(139, 92, 246, 0.15)'};
                            border-radius: 0.5rem;
                            color: #8b5cf6;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                        "
                        onmouseover="this.style.background='${isDarkMode ? 'rgba(139, 92, 246, 0.15)' : 'rgba(139, 92, 246, 0.1)'}'"
                        onmouseout="this.style.background='${isDarkMode ? 'rgba(139, 92, 246, 0.1)' : 'rgba(139, 92, 246, 0.05)'}'">
                            <span id="${cardId}-toggle-text">Voir les comptes</span>
                            <i id="${cardId}-toggle-icon" class="fas fa-chevron-down" style="font-size: 0.75rem; transition: transform 0.3s ease;"></i>
                        </button>

                        <!-- Expandable Details -->
                        <div id="${cardId}-details" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e5e7eb'};">
                            ${creator.twitterAccounts.length > 0 ? `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.75rem; font-weight: 600; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                                        <i class="fab fa-twitter" style="color: #1da1f2;"></i> Comptes Twitter
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                        ${creator.twitterAccounts.map(username => {
                                            const twitterUrl = `https://twitter.com/${username.replace('@', '')}`;
                                            return `<a href="${twitterUrl}" target="_blank" style="
                                                background: ${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'};
                                                color: #1da1f2;
                                                padding: 0.375rem 0.625rem;
                                                border-radius: 0.5rem;
                                                font-size: 0.75rem;
                                                text-decoration: none;
                                                border: 1px solid ${isDarkMode ? 'rgba(29, 161, 242, 0.2)' : 'rgba(29, 161, 242, 0.15)'};
                                                transition: all 0.2s ease;
                                                display: inline-flex;
                                                align-items: center;
                                                gap: 0.25rem;
                                            "
                                            onmouseover="this.style.background='rgba(29, 161, 242, 0.15)'"
                                            onmouseout="this.style.background='${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'}'">
                                                <i class="fab fa-twitter"></i> ${username}
                                            </a>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${creator.instagramAccounts.length > 0 ? `
                                <div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: ${isDarkMode ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                                        <i class="fab fa-instagram" style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i> Comptes Instagram
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                        ${creator.instagramAccounts.map(username => {
                                            const instagramUrl = `https://instagram.com/${username.replace('@', '')}`;
                                            return `<a href="${instagramUrl}" target="_blank" style="
                                                background: ${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'};
                                                color: #c13584;
                                                padding: 0.375rem 0.625rem;
                                                border-radius: 0.5rem;
                                                font-size: 0.75rem;
                                                text-decoration: none;
                                                border: 1px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.2)' : 'rgba(193, 53, 132, 0.15)'};
                                                transition: all 0.2s ease;
                                                display: inline-flex;
                                                align-items: center;
                                                gap: 0.25rem;
                                            "
                                            onmouseover="this.style.background='rgba(193, 53, 132, 0.15)'"
                                            onmouseout="this.style.background='${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'}'">
                                                <i class="fab fa-instagram"></i> ${username}
                                            </a>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle creator details expand/collapse
        function toggleCreatorDetails(cardId) {
            const detailsDiv = document.getElementById(`${cardId}-details`);
            const toggleIcon = document.getElementById(`${cardId}-toggle-icon`);
            const toggleText = document.getElementById(`${cardId}-toggle-text`);

            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                toggleIcon.style.transform = 'rotate(180deg)';
                toggleText.textContent = 'Masquer les comptes';
            } else {
                detailsDiv.style.display = 'none';
                toggleIcon.style.transform = 'rotate(0deg)';
                toggleText.textContent = 'Voir les comptes';
            }
        }

        // Update Twitter Analytics
        function updateTwitterAnalytics() {
            if (!data.twitterStats || data.twitterStats.length === 0) {
                // Si pas de donn√©es, afficher un message vide
                document.getElementById('total-followers').textContent = '0';
                document.getElementById('weekly-growth').textContent = '+0';
                document.getElementById('best-account').textContent = '-';
                document.getElementById('last-update').textContent = '-';
                document.getElementById('twitter-analytics-by-va').innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: rgba(148, 163, 184, 0.1); border-radius: 0.75rem;">
                        <i class="fas fa-chart-line" style="font-size: 3rem; color: #94a3b8; margin-bottom: 1rem;"></i>
                        <p style="color: #64748b; font-size: 1.1rem;">Aucune donn√©e disponible</p>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-top: 0.5rem;">Commencez √† suivre vos comptes Twitter pour voir les statistiques</p>
                    </div>
                `;
                return;
            }
            
            // Calculer les stats globales
            let totalFollowers = 0;
            let totalGrowth = 0;
            let bestAccount = { username: '-', followers: 0 };
            let lastUpdateDate = null;
            
            // Obtenir les derni√®res stats pour chaque compte
            const latestStats = new Map();
            const previousWeekStats = new Map();
            
            data.twitterStats.forEach(stat => {
                const username = stat.username.toLowerCase();
                const statDate = new Date(stat.date);
                
                if (!latestStats.has(username) || statDate > new Date(latestStats.get(username).date)) {
                    latestStats.set(username, stat);
                }
                
                // Chercher les stats de la semaine pr√©c√©dente
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                
                if (statDate >= twoWeeksAgo && statDate <= weekAgo) {
                    if (!previousWeekStats.has(username) || statDate > new Date(previousWeekStats.get(username).date)) {
                        previousWeekStats.set(username, stat);
                    }
                }
                
                if (!lastUpdateDate || statDate > lastUpdateDate) {
                    lastUpdateDate = statDate;
                }
            });
            
            // Calculer le total et trouver le meilleur compte
            latestStats.forEach((stat, username) => {
                totalFollowers += stat.followers;
                
                if (stat.followers > bestAccount.followers) {
                    bestAccount = { username: stat.username, followers: stat.followers };
                }
                
                // Calculer la croissance
                if (previousWeekStats.has(username)) {
                    const prevStat = previousWeekStats.get(username);
                    totalGrowth += (stat.followers - prevStat.followers);
                }
            });
            
            // Mettre √† jour les stats globales
            document.getElementById('total-followers').textContent = formatNumber(totalFollowers);
            document.getElementById('weekly-growth').textContent = totalGrowth >= 0 ? `+${formatNumber(totalGrowth)}` : formatNumber(totalGrowth);
            document.getElementById('best-account').textContent = bestAccount.username !== '-' ? `${bestAccount.username} (${formatNumber(bestAccount.followers)})` : '-';
            document.getElementById('last-update').textContent = lastUpdateDate ? lastUpdateDate.toLocaleDateString('fr-FR') : '-';
            
            // Analyser par VA
            const vaAnalytics = new Map();
            
            // Pour chaque compte Twitter avec des stats
            latestStats.forEach((stat, username) => {
                // Trouver √† quel VA appartient ce compte
                let foundVa = null;
                
                // Chercher dans data.creators
                if (data.creators) {
                    for (const creator of data.creators) {
                        if (creator.accounts) {
                            const account = creator.accounts.find(acc => 
                                acc.username.toLowerCase() === username
                            );
                            
                            if (account) {
                                // Trouver le VA assign√©
                                if (account.assignedVaId) {
                                    foundVa = data.vas.find(v => v.id === account.assignedVaId);
                                } else if (creator.vaIds && creator.vaIds.length > 0) {
                                    // Si pas d'assignation sp√©cifique, prendre le premier VA
                                    foundVa = data.vas.find(v => v.id === creator.vaIds[0]);
                                }
                                break;
                            }
                        }
                    }
                }
                
                // Si pas trouv√© dans la nouvelle structure, chercher dans l'ancienne
                if (!foundVa && data.twitterAccounts) {
                    const oldAccount = data.twitterAccounts.find(ta => 
                        ta.username && ta.username.toLowerCase() === username
                    );
                    if (oldAccount && oldAccount.vaId) {
                        foundVa = data.vas.find(v => v.id === oldAccount.vaId);
                    }
                }
                
                const vaName = foundVa ? foundVa.name : 'Non assign√©';
                
                if (!vaAnalytics.has(vaName)) {
                    vaAnalytics.set(vaName, {
                        accounts: [],
                        totalFollowers: 0,
                        totalGrowth: 0
                    });
                }
                
                const vaData = vaAnalytics.get(vaName);
                vaData.totalFollowers += stat.followers;
                
                // Calculer la croissance
                let growth = 0;
                if (previousWeekStats.has(username)) {
                    const prevStat = previousWeekStats.get(username);
                    growth = stat.followers - prevStat.followers;
                    vaData.totalGrowth += growth;
                }
                
                vaData.accounts.push({
                    username: stat.username,
                    followers: stat.followers,
                    growth: growth,
                    lastUpdate: stat.date
                });
            });
            
            // G√©n√©rer le HTML par VA
            const vaAnalyticsHtml = Array.from(vaAnalytics.entries()).map(([vaName, vaData]) => {
                // Trier les comptes par followers d√©croissant
                vaData.accounts.sort((a, b) => b.followers - a.followers);
                
                const growthColor = vaData.totalGrowth >= 0 ? '#10b981' : '#ef4444';
                const growthSign = vaData.totalGrowth >= 0 ? '+' : '';
                
                return `
                    <div class="stat-card" style="padding: 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">${vaName}</h3>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1DA1F2;">
                                    ${formatNumber(vaData.totalFollowers)}
                                </div>
                                <div style="font-size: 0.875rem; color: ${growthColor}; font-weight: 600;">
                                    ${growthSign}${formatNumber(vaData.totalGrowth)} cette semaine
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            ${vaData.accounts.map(account => {
                                const accountGrowthColor = account.growth >= 0 ? '#10b981' : '#ef4444';
                                const accountGrowthSign = account.growth >= 0 ? '+' : '';
                                
                                return `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: rgba(29, 161, 242, 0.05); border-radius: 0.5rem; border: 1px solid rgba(29, 161, 242, 0.1);">
                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                            <a href="https://twitter.com/${account.username.replace('@', '')}" 
                                               target="_blank" 
                                               class="twitter-badge" 
                                               style="padding: 0.25rem 0.75rem; font-size: 0.875rem; text-decoration: none;">
                                                <i class="fab fa-twitter"></i> ${account.username}
                                            </a>
                                            <button class="btn-icon" onclick="showUpdateFollowersModal('${account.username}')" 
                                                    style="background: #3b82f6; padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 600; color: #1f2937;">
                                                ${formatNumber(account.followers)}
                                            </div>
                                            <div style="font-size: 0.75rem; color: ${accountGrowthColor};">
                                                ${accountGrowthSign}${formatNumber(account.growth)}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('twitter-analytics-by-va').innerHTML = vaAnalyticsHtml || `
                <div style="text-align: center; padding: 3rem; background: rgba(148, 163, 184, 0.1); border-radius: 0.75rem;">
                    <i class="fas fa-chart-line" style="font-size: 3rem; color: #94a3b8; margin-bottom: 1rem;"></i>
                    <p style="color: #64748b; font-size: 1.1rem;">Aucune donn√©e disponible</p>
                    <p style="color: #94a3b8; font-size: 0.875rem; margin-top: 0.5rem;">Commencez √† suivre vos comptes Twitter pour voir les statistiques</p>
                </div>
            `;
        }
        
        // Update creators statistics
        function updateCreatorsStats() {
            const container = document.getElementById('creators-comparison');
            if (!container) return;
            
            // Utiliser directement la nouvelle structure data.creators
            const creatorsMap = new Map();
            
            if (data.creators) {
                data.creators.forEach(creator => {
                    // Trouver les VAs associ√©s √† cette cr√©atrice
                    const associatedVAs = [];
                    if (creator.vaIds) {
                        creator.vaIds.forEach(vaId => {
                            const va = data.vas.find(v => v.id === vaId);
                            if (va) {
                                associatedVAs.push(va.name);
                            }
                        });
                    }
                    
                    creatorsMap.set(creator.name, {
                        name: creator.name,
                        accountsCount: creator.accounts ? creator.accounts.length : 0,
                        vas: associatedVAs
                    });
                });
            }
            
            // Convertir en tableau et trier par nombre de comptes (d√©croissant)
            const allCreators = Array.from(creatorsMap.values());
            allCreators.sort((a, b) => b.accountsCount - a.accountsCount);
            
            if (allCreators.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.8;">Aucune cr√©atrice ajout√©e</p>';
                return;
            }
            
            // Cr√©er les barres de progression
            const maxAccounts = Math.max(...allCreators.map(c => c.accountsCount));
            
            container.innerHTML = allCreators.map(creator => {
                const percentage = maxAccounts > 0 ? (creator.accountsCount / maxAccounts) * 100 : 0;
                
                let barColor = '#22c55e';
                if (creator.accountsCount === 0) barColor = '#ef4444';
                else if (creator.accountsCount >= 10) barColor = '#dc2626';
                else if (creator.accountsCount >= 5) barColor = '#f59e0b';
                
                // Position du nombre (centr√© si la barre est assez large, sinon √† droite)
                const numberPosition = percentage > 30 ? 'left: 8px;' : 'left: calc(' + percentage + '% + 8px);';
                const textColor = percentage > 30 ? 'white' : 'black';
                
                return `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.25rem;">
                        <div style="flex: 0 0 120px; text-align: right;">
                            <strong style="font-size: 0.9rem;">${creator.name}</strong>
                        </div>
                        <div style="flex: 1; background: rgba(255,255,255,0.2); border-radius: 8px; height: 28px; position: relative; overflow: visible;">
                            <div style="background: ${barColor}; height: 100%; width: ${percentage}%; transition: width 0.5s ease; border-radius: 8px;">
                            </div>
                            <span style="position: absolute; ${numberPosition} top: 50%; transform: translateY(-50%); font-size: 0.8rem; font-weight: 700; color: ${textColor}; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                ${creator.accountsCount} compte${creator.accountsCount > 1 ? 's' : ''}
                            </span>
                        </div>
                        <div style="flex: 0 0 auto; font-size: 0.7rem; opacity: 0.8; text-align: right; min-width: 80px;">
                            ${creator.vas.length > 1 ? `${creator.vas.length} VAs` : creator.vas[0]}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update VA grid
        function updateVAGrid() {
            const grid = document.getElementById('va-grid');
            grid.innerHTML = '';

            data.vas.forEach(va => {
                const card = createVACard(va);
                grid.appendChild(card);
            });

            if (data.vas.length === 0) {
                grid.innerHTML = '<div class="no-creator">Aucun VA ajout√©. Commencez par ajouter un VA!</div>';
            }
        }

        // Create VA card
        function createVACard(va) {
            const card = document.createElement('div');
            card.className = 'va-card';

            // Trouver les cr√©atrices associ√©es √† ce VA
            const vaCreators = [];
            let totalAccounts = 0;
            let totalInstagramAccounts = 0;

            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.vaIds && creator.vaIds.includes(va.id)) {
                        vaCreators.push(creator);
                        // Compter seulement les comptes Twitter assign√©s √† CE VA
                        if (creator.accounts) {
                            const filteredForThisVA = creator.accounts.filter(account => {
                                // Si la cr√©atrice n'a qu'un seul VA, on compte tous ses comptes
                                if (creator.vaIds && creator.vaIds.length === 1) {
                                    return true;
                                }
                                // Si la cr√©atrice a plusieurs VAs, on ne compte que les comptes
                                // explicitement assign√©s √† CE VA
                                return account.assignedVaId === va.id;
                            });
                            totalAccounts += filteredForThisVA.length;
                        }
                        // Compter seulement les comptes Instagram assign√©s √† CE VA
                        if (creator.instagramAccounts) {
                            const filteredInstagramForThisVA = creator.instagramAccounts.filter(account => {
                                // Si la cr√©atrice n'a qu'un seul VA, on compte tous ses comptes
                                if (creator.vaIds && creator.vaIds.length === 1) {
                                    return true;
                                }
                                // Si la cr√©atrice a plusieurs VAs, on ne compte que les comptes
                                // explicitement assign√©s √† CE VA
                                return account.assignedVaId === va.id;
                            });
                            totalInstagramAccounts += filteredInstagramForThisVA.length;
                        }
                    }
                });
            }

            let creatorsHtml = '';
            vaCreators.forEach(creator => {
                // FILTRER les comptes pour ce VA sp√©cifique
                // IMPORTANT: Si la cr√©atrice a plusieurs VAs, on n'affiche QUE les comptes
                // qui ont un assignedVaId correspondant √† ce VA
                const filteredAccounts = creator.accounts ? creator.accounts.filter(account => {
                    // Si la cr√©atrice n'a qu'un seul VA, on affiche tous ses comptes
                    if (creator.vaIds && creator.vaIds.length === 1) {
                        return true;
                    }
                    // Si la cr√©atrice a plusieurs VAs, on n'affiche que les comptes
                    // explicitement assign√©s √† CE VA
                    return account.assignedVaId === va.id;
                }) : [];

                // Filtrer les comptes Instagram pour ce VA
                const filteredInstagramAccounts = creator.instagramAccounts ? creator.instagramAccounts.filter(account => {
                    // Si la cr√©atrice n'a qu'un seul VA, on affiche tous ses comptes
                    if (creator.vaIds && creator.vaIds.length === 1) {
                        return true;
                    }
                    // Si la cr√©atrice a plusieurs VAs, on n'affiche que les comptes
                    // explicitement assign√©s √† CE VA
                    return account.assignedVaId === va.id;
                }) : [];

                const accountsCount = filteredAccounts.length;
                const instagramCount = filteredInstagramAccounts.length;
                const totalCount = accountsCount + instagramCount;
                let badgeColor = '#22c55e'; // Vert par d√©faut
                if (totalCount === 0) badgeColor = '#ef4444'; // Rouge si 0
                else if (totalCount >= 10) badgeColor = '#dc2626'; // Rouge fonc√© si 10+
                else if (totalCount >= 5) badgeColor = '#f59e0b'; // Orange si 5+
                
                const accountsHtml = filteredAccounts.length > 0 ? filteredAccounts.map((account, index) => {
                    // Trouver l'index r√©el dans la liste compl√®te des comptes
                    const realIndex = creator.accounts.findIndex(acc => acc.id === account.id);
                    
                    // Chercher le Gmail associ√©
                    let gmail = null;
                    if (account.gmailId) {
                        gmail = data.gmailAccounts?.find(g => g.id === account.gmailId);
                    }
                    if (!gmail) {
                        // Chercher par assignedTwitterUsername
                        gmail = data.gmailAccounts?.find(g => 
                            g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                        );
                    }
                    
                    const hasGmail = gmail !== null && gmail !== undefined;
                    
                    // Obtenir les derni√®res stats de followers
                    const latestStats = getLatestTwitterStats(account.username);
                    const followersDisplay = latestStats ? 
                        `<span style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6; padding: 0.125rem 0.375rem; 
                                     border-radius: 0.75rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.25rem;
                                     border: 1px solid rgba(139, 92, 246, 0.2);">
                            <i class="fas fa-users" style="font-size: 0.625rem;"></i> ${formatNumber(latestStats.followers)}
                        </span>` : '';
                    
                    const paddingRight = hasGmail ? '7.5rem' : '10rem';
                    
                    // Cr√©er l'URL Twitter - enlever le @ du username
                    const twitterUrl = `https://twitter.com/${account.username.replace('@', '')}`;
                    
                    return `<a href="${twitterUrl}" target="_blank" class="twitter-badge" style="position: relative; padding-right: ${paddingRight}; text-decoration: none;">
                        <i class="fab fa-twitter"></i> ${account.username}${followersDisplay}
                        ${!hasGmail ? `
                            <i class="fas fa-exclamation-triangle" 
                               style="color: #f59e0b; margin-left: 0.25rem; font-size: 0.75rem;" 
                               title="Pas de Gmail associ√©"></i>
                        ` : ''}
                        ${!hasGmail ? `
                            <button onclick="event.preventDefault(); event.stopPropagation(); showAssignGmailModal('${creator.id}', '${account.username}')" 
                                    style="position: absolute; right: 5.5rem; top: 50%; transform: translateY(-50%); 
                                           background: rgba(234, 67, 53, 0.2); border: none; border-radius: 50%; 
                                           width: 28px; height: 28px; display: flex; align-items: center; 
                                           justify-content: center; cursor: pointer; font-size: 0.75rem;
                                           transition: all 0.2s ease;"
                                    onmouseover="this.style.background='rgba(234, 67, 53, 0.4)'"
                                    onmouseout="this.style.background='rgba(234, 67, 53, 0.2)'"
                                    title="Assigner un Gmail">
                                <i class="fas fa-envelope"></i>
                            </button>
                        ` : ''}
                        <button onclick="event.preventDefault(); event.stopPropagation(); showUpdateFollowersModal('${account.username}')" 
                                style="position: absolute; right: ${hasGmail ? '5.5rem' : '8rem'}; top: 50%; transform: translateY(-50%); 
                                       background: rgba(139, 92, 246, 0.2); border: none; border-radius: 50%; 
                                       width: 28px; height: 28px; display: flex; align-items: center; 
                                       justify-content: center; cursor: pointer; font-size: 0.75rem;
                                       transition: all 0.2s ease;"
                                onmouseover="this.style.background='rgba(139, 92, 246, 0.4)'"
                                onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'"
                                title="Mettre √† jour les followers">
                            <i class="fas fa-users"></i>
                        </button>
                        <button onclick="event.preventDefault(); event.stopPropagation(); showTransferModal('${creator.id}', ${realIndex}, '${va.id}')" 
                                style="position: absolute; right: 3rem; top: 50%; transform: translateY(-50%); 
                                       background: rgba(59, 130, 246, 0.2); border: none; border-radius: 50%; 
                                       width: 28px; height: 28px; display: flex; align-items: center; 
                                       justify-content: center; cursor: pointer; font-size: 0.75rem;
                                       transition: all 0.2s ease;"
                                onmouseover="this.style.background='rgba(59, 130, 246, 0.4)'"
                                onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'"
                                title="Transf√©rer vers un autre VA">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button onclick="event.preventDefault(); event.stopPropagation(); unassignTwitterAccount('${creator.id}', ${realIndex})" 
                                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); 
                                       background: rgba(239, 68, 68, 0.2); border: none; border-radius: 50%; 
                                       width: 28px; height: 28px; display: flex; align-items: center; 
                                       justify-content: center; cursor: pointer; font-size: 0.75rem;
                                       transition: all 0.2s ease;"
                                onmouseover="this.style.background='rgba(239, 68, 68, 0.4)'"
                                onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                                title="Retirer ce compte">
                            <i class="fas fa-times"></i>
                        </button>
                    </a>`;
                }).join('') : '';

                // G√©n√©rer le HTML pour les comptes Instagram
                const instagramHtml = filteredInstagramAccounts.length > 0 ? filteredInstagramAccounts.map((account, index) => {
                    // Cr√©er l'URL Instagram - enlever le @ du username
                    const instagramUrl = `https://instagram.com/${account.username.replace('@', '')}`;

                    return `<a href="${instagramUrl}" target="_blank" class="instagram-badge" style="position: relative; padding-right: 3.5rem; text-decoration: none;">
                        <i class="fab fa-instagram"></i> ${account.username}
                        <button onclick="event.preventDefault(); event.stopPropagation(); deleteInstagramFromCreator('${creator.id}', '${account.username}')"
                                style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
                                       background: rgba(239, 68, 68, 0.2); border: none; border-radius: 50%;
                                       width: 28px; height: 28px; display: flex; align-items: center;
                                       justify-content: center; cursor: pointer; font-size: 0.75rem;
                                       transition: all 0.2s ease;"
                                onmouseover="this.style.background='rgba(239, 68, 68, 0.4)'"
                                onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                                title="Retirer ce compte">
                            <i class="fas fa-times"></i>
                        </button>
                    </a>`;
                }).join('') : '';

                creatorsHtml += `
                    <div class="creatrice-item">
                        <div class="creatrice-header">
                            <span class="creatrice-name">
                                ‚≠ê ${creator.name} 
                                <span style="background: ${badgeColor}; 
                                            color: white; 
                                            padding: 2px 8px; 
                                            border-radius: 12px; 
                                            font-size: 0.75rem; 
                                            font-weight: 600;
                                            margin-left: 8px;
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    ${totalCount} compte${totalCount > 1 ? 's' : ''}
                                    ${accountsCount > 0 ? `(${accountsCount} <i class="fab fa-twitter"></i>)` : ''}
                                    ${instagramCount > 0 ? `(${instagramCount} <i class="fab fa-instagram"></i>)` : ''}
                                </span>
                            </span>
                            <div class="actions">
                                <button class="action-btn view-btn" onclick="viewCreator('${va.id}', '${creator.id}')">
                                    <i class="fas fa-eye"></i> Voir
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteCreator('${va.id}', '${creator.id}')" title="Supprimer cette cr√©atrice">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="twitter-accounts">
                            ${accountsHtml || ''}
                            ${instagramHtml || ''}
                            ${(!accountsHtml && !instagramHtml) ? '<span style="color: #94a3b8;">Aucun compte</span>' : ''}
                        </div>
                    </div>
                `;
            });

            card.innerHTML = `
                <div class="va-header">
                    <div>
                        <h3 class="va-name">üë§ ${va.name}</h3>
                        <div class="va-stats">
                            <span>${vaCreators.length} cr√©atrice(s)</span>
                            <span>${totalAccounts + totalInstagramAccounts} compte(s)</span>
                            ${totalAccounts > 0 ? `<span style="color: #1DA1F2;"><i class="fab fa-twitter"></i> ${totalAccounts}</span>` : ''}
                            ${totalInstagramAccounts > 0 ? `<span style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"><i class="fab fa-instagram"></i> ${totalInstagramAccounts}</span>` : ''}
                        </div>
                    </div>
                    <div class="va-actions">
                        <button class="action-btn delete-btn" onclick="deleteVA('${va.id}')" title="Supprimer ce VA">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="creatrice-section">
                    ${creatorsHtml || '<div class="no-creator">Aucune cr√©atrice assign√©e</div>'}
                </div>
            `;

            return card;
        }

        // Update Gmail accounts list
        function updateGmailAccountsList() {
            const container = document.getElementById('gmail-accounts-list');
            const statsContainer = document.getElementById('gmail-stats');
            if (!container) return;
            
            if (!data.gmailAccounts) data.gmailAccounts = [];
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Afficher les statistiques simples
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <span style="color: #ea4335;"><i class="fas fa-envelope"></i> ${data.gmailAccounts.length} comptes Gmail</span>
                `;
            }
            
            // Afficher les comptes Gmail simplement
            if (data.gmailAccounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                        <i class="fas fa-envelope" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Aucun compte Gmail ajout√©</p>
                    </div>
                `;
                return;
            }
            
            console.log('üîç Mise √† jour de la liste des comptes Gmail...');

            // Afficher les comptes Gmail avec leurs associations
            container.innerHTML = data.gmailAccounts.map(gmail => {
                // V√©rifier les assignations Twitter et Instagram s√©par√©ment
                let twitterAssigned = null;
                let instagramAssigned = null;

                // 1. V√©rifier les assignations directes
                if (gmail.assignedTwitterUsername) {
                    twitterAssigned = gmail.assignedTwitterUsername;
                }
                if (gmail.assignedInstagramUsername) {
                    instagramAssigned = gmail.assignedInstagramUsername;
                }

                // 2. V√©rifier dans les comptes des cr√©atrices pour Twitter
                if (!twitterAssigned && data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.accounts) {
                            creator.accounts.forEach(account => {
                                if (account.gmailId === gmail.id) {
                                    twitterAssigned = account.username;
                                }
                            });
                        }
                    });
                }

                // 3. V√©rifier dans les comptes des cr√©atrices pour Instagram
                if (!instagramAssigned && data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.instagramAccounts) {
                            creator.instagramAccounts.forEach(account => {
                                if (account.gmailId === gmail.id) {
                                    instagramAssigned = account.username;
                                }
                            });
                        }
                    });
                }

                // 4. V√©rifier dans data.twitterAccounts
                if (!twitterAssigned && data.twitterAccounts) {
                    const twitterAccount = data.twitterAccounts.find(ta => ta.gmailId === gmail.id);
                    if (twitterAccount) {
                        twitterAssigned = twitterAccount.username;
                    }
                }

                // 5. V√©rifier dans data.instagramAccounts
                if (!instagramAssigned && data.instagramAccounts) {
                    const instagramAccount = data.instagramAccounts.find(ia => ia.gmailId === gmail.id);
                    if (instagramAccount) {
                        instagramAssigned = instagramAccount.username;
                    }
                }

                // D√©terminer le statut global
                const hasTwitter = twitterAssigned !== null;
                const hasInstagram = instagramAssigned !== null;
                const isFullyAssigned = hasTwitter && hasInstagram;
                const isPartiallyAssigned = hasTwitter || hasInstagram;
                const isCompletelyFree = !hasTwitter && !hasInstagram;

                const va = gmail.vaId ? data.vas.find(v => v.id === gmail.vaId) : null;

                // D√©terminer la couleur de bordure
                let borderColor = '#ef4444'; // Rouge par d√©faut (compl√®tement libre)
                if (isFullyAssigned) borderColor = '#10b981'; // Vert si tout est assign√©
                else if (isPartiallyAssigned) borderColor = '#f59e0b'; // Orange si partiellement assign√©

                return `
                <div style="
                    padding: 1rem;
                    background: ${isFullyAssigned ?
                        (isDarkMode ? 'rgba(16, 185, 129, 0.1)' : 'rgba(16, 185, 129, 0.05)') :
                        isPartiallyAssigned ?
                        (isDarkMode ? 'rgba(245, 158, 11, 0.1)' : 'rgba(245, 158, 11, 0.05)') :
                        (isDarkMode ? 'rgba(234, 67, 53, 0.1)' : 'rgba(234, 67, 53, 0.05)')};
                    border: 2px solid ${borderColor};
                    border-radius: 0.5rem;
                    margin-bottom: 0.75rem;
                    transition: all 0.2s ease;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <i class="fas fa-envelope" style="color: ${borderColor};"></i>
                                ${gmail.email}
                                ${isFullyAssigned ? `
                                    <span style="
                                        background: #10b981;
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 0.75rem;
                                        font-weight: 500;
                                    ">
                                        <i class="fas fa-check-circle"></i> Complet
                                    </span>
                                ` : isPartiallyAssigned ? `
                                    <span style="
                                        background: #f59e0b;
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 0.75rem;
                                        font-weight: 500;
                                    ">
                                        <i class="fas fa-exclamation-circle"></i> Partiel
                                    </span>
                                ` : `
                                    <span style="
                                        background: #ef4444;
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 0.75rem;
                                        font-weight: 500;
                                    ">
                                        <i class="fas fa-times-circle"></i> Disponible
                                    </span>
                                `}
                            </div>

                            <div style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'}; margin-top: 0.75rem; display: grid; gap: 0.5rem;">
                                <!-- Twitter Assignment -->
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${hasTwitter ? 'rgba(29, 161, 242, 0.1)' : 'rgba(148, 163, 184, 0.1)'}; border-radius: 0.375rem; border: 1px solid ${hasTwitter ? 'rgba(29, 161, 242, 0.2)' : 'rgba(148, 163, 184, 0.2)'};">
                                    <i class="fab fa-twitter" style="width: 20px; color: ${hasTwitter ? '#1da1f2' : '#94a3b8'};"></i>
                                    ${hasTwitter ? `
                                        <span><strong>Twitter:</strong> ${twitterAssigned}</span>
                                        <span style="margin-left: auto; background: #1da1f2; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem;">Assign√©</span>
                                    ` : `
                                        <span style="color: #94a3b8;">Twitter: Non assign√©</span>
                                        <span style="margin-left: auto; background: #10b981; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem;">Disponible</span>
                                    `}
                                </div>

                                <!-- Instagram Assignment -->
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${hasInstagram ? 'rgba(193, 53, 132, 0.1)' : 'rgba(148, 163, 184, 0.1)'}; border-radius: 0.375rem; border: 1px solid ${hasInstagram ? 'rgba(193, 53, 132, 0.2)' : 'rgba(148, 163, 184, 0.2)'};">
                                    <i class="fab fa-instagram" style="width: 20px; background: ${hasInstagram ? 'linear-gradient(45deg, #833AB4, #FD1D1D, #FCB045)' : '#94a3b8'}; -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                                    ${hasInstagram ? `
                                        <span><strong>Instagram:</strong> ${instagramAssigned}</span>
                                        <span style="margin-left: auto; background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem;">Assign√©</span>
                                    ` : `
                                        <span style="color: #94a3b8;">Instagram: Non assign√©</span>
                                        <span style="margin-left: auto; background: #10b981; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem;">Disponible</span>
                                    `}
                                </div>

                                ${va ? `
                                    <div style="margin-top: 0.25rem;">
                                        <i class="fas fa-user-tie" style="width: 20px; color: #667eea;"></i>
                                        VA: <strong>${va.name}</strong>
                                    </div>
                                ` : ''}

                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                                    Ajout√© le ${new Date(gmail.created).toLocaleDateString('fr-FR')}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-direction: column;">
                            <button class="action-btn" onclick="showGmailPassword('${gmail.id}')"
                                    style="background: #ea4335;" title="Voir le mot de passe">
                                <i class="fas fa-key"></i>
                            </button>
                            ${hasTwitter ? `
                                <button class="action-btn" onclick="unassignGmail('${gmail.id}', 'twitter')"
                                        style="background: #1da1f2;" title="D√©sassigner Twitter">
                                    <i class="fab fa-twitter"></i> <i class="fas fa-unlink" style="font-size: 0.7rem;"></i>
                                </button>
                            ` : ''}
                            ${hasInstagram ? `
                                <button class="action-btn" onclick="unassignGmail('${gmail.id}', 'instagram')"
                                        style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045);" title="D√©sassigner Instagram">
                                    <i class="fab fa-instagram"></i> <i class="fas fa-unlink" style="font-size: 0.7rem;"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn" onclick="editGmailAccount('${gmail.id}')" 
                                    style="background: #3b82f6;" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="deleteGmailAccount('${gmail.id}')"
                                    style="background: #ef4444;" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Update Twitter form selects
        function updateTwitterFormSelects() {
            const creatorSelect = document.getElementById('account-creator');
            const gmailSelect = document.getElementById('account-gmail');
            const vaSelect = document.getElementById('account-va');
            
            if (creatorSelect) {
                const currentValue = creatorSelect.value;
                creatorSelect.innerHTML = '<option value="">S√©lectionner une cr√©atrice</option>';
                data.creators.forEach(creator => {
                    const option = document.createElement('option');
                    option.value = creator.id;
                    option.textContent = creator.name;
                    creatorSelect.appendChild(option);
                });
                creatorSelect.value = currentValue;
            }
            
            if (gmailSelect) {
                const currentValue = gmailSelect.value;
                gmailSelect.innerHTML = '<option value="">S√©lectionner un compte Gmail</option>';

                // D√©terminer la plateforme actuelle
                const platform = window.currentPlatform || 'twitter';

                // Afficher TOUS les comptes Gmail avec leurs statuts
                data.gmailAccounts.forEach(gmail => {
                    const option = document.createElement('option');
                    option.value = gmail.id;

                    let statusText = '';
                    const hasTwitter = gmail.assignedTwitterUsername ? true : false;
                    const hasInstagram = gmail.assignedInstagramUsername ? true : false;

                    if (hasTwitter && hasInstagram) {
                        // Gmail complet - ne peut plus √™tre utilis√©
                        statusText = ' ‚ùå COMPLET (Twitter + Instagram)';
                        if (platform === 'twitter') {
                            option.disabled = gmail.assignedTwitterUsername !== null;
                        } else {
                            option.disabled = gmail.assignedInstagramUsername !== null;
                        }
                    } else if (hasTwitter && !hasInstagram) {
                        // Gmail a Twitter mais Instagram disponible
                        if (platform === 'twitter') {
                            statusText = ` ‚ö†Ô∏è (D√©j√† Twitter: ${gmail.assignedTwitterUsername})`;
                            option.disabled = true;
                        } else {
                            statusText = ' ‚úÖ Instagram disponible';
                        }
                    } else if (!hasTwitter && hasInstagram) {
                        // Gmail a Instagram mais Twitter disponible
                        if (platform === 'instagram') {
                            statusText = ` ‚ö†Ô∏è (D√©j√† Instagram: ${gmail.assignedInstagramUsername})`;
                            option.disabled = true;
                        } else {
                            statusText = ' ‚úÖ Twitter disponible';
                        }
                    } else {
                        // Gmail compl√®tement libre
                        statusText = ' ‚úÖ Disponible';
                    }

                    option.textContent = gmail.email + statusText;
                    gmailSelect.appendChild(option);
                });
                gmailSelect.value = currentValue;
            }
            
            if (vaSelect) {
                const currentValue = vaSelect.value;
                vaSelect.innerHTML = '<option value="">S√©lectionner un VA</option>';
                data.vas.forEach(va => {
                    const option = document.createElement('option');
                    option.value = va.id;
                    option.textContent = va.name;
                    vaSelect.appendChild(option);
                });
                vaSelect.value = currentValue;
            }
        }

        // Update Twitter accounts list - VERSION SIMPLE
        function updateTwitterAccountsList() {
            const container = document.getElementById('twitter-accounts-list');
            if (!container) return;
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            console.log('üìã updateTwitterAccountsList appel√©');
            
            // Collecter TOUS les comptes Twitter de toutes les sources
            const allTwitterAccounts = [];
            
            // 1. Comptes de data.twitterAccounts
            if (data.twitterAccounts) {
                data.twitterAccounts.forEach(account => {
                    allTwitterAccounts.push({
                        ...account,
                        source: 'simple'
                    });
                });
            }
            
            // 2. Comptes des cr√©atrices
            if (data.creators) {
                console.log('üìå Parcours des cr√©atrices pour les comptes Twitter:');
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        console.log(`  Cr√©atrice ${creator.name}: ${creator.accounts.length} comptes`);
                        creator.accounts.forEach(account => {
                            console.log(`    - ${account.username} (gmailId: ${account.gmailId})`);
                            // V√©rifier si ce compte n'est pas d√©j√† dans la liste
                            const exists = allTwitterAccounts.some(ta => 
                                ta.username.toLowerCase() === account.username.toLowerCase()
                            );
                            if (!exists) {
                                allTwitterAccounts.push({
                                    username: account.username,
                                    password: account.password,
                                    creatorId: creator.id,
                                    creatorName: creator.name,
                                    vaIds: creator.vaIds,
                                    gmailId: account.gmailId, // Ajouter le gmailId
                                    assignedVaId: account.assignedVaId, // Ajouter l'ID du VA assign√©
                                    source: 'creator',
                                    created: account.created || new Date().toISOString()
                                });
                            }
                        });
                    }
                });
            }
            
            console.log(`üìä Total comptes Twitter trouv√©s: ${allTwitterAccounts.length}`);
            
            if (allTwitterAccounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                        <i class="fab fa-twitter" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Aucun compte Twitter ajout√©</p>
                    </div>
                `;
                return;
            }
            
            // Afficher TOUS les comptes Twitter avec leurs associations
            container.innerHTML = allTwitterAccounts.map(account => {
                // Pour les comptes venant des cr√©atrices
                let creator = null;
                let gmail = null;
                let va = null;
                
                // Debug pour Laurabptss
                if (account.username.toLowerCase().includes('laurabptss')) {
                    console.log('üîç Debug Laurabptss dans updateTwitterAccountsList:');
                    console.log('Account:', account);
                    console.log('Source:', account.source);
                    console.log('GmailId dans account:', account.gmailId);
                }
                
                if (account.source === 'creator') {
                    creator = data.creators.find(c => c.id === account.creatorId);
                    
                    // Pour r√©cup√©rer le compte r√©el depuis creator.accounts
                    let realAccount = null;
                    if (creator && creator.accounts) {
                        realAccount = creator.accounts.find(a => 
                            a.username.toLowerCase() === account.username.toLowerCase()
                        );
                        
                        if (account.username.toLowerCase().includes('laurabptss') && realAccount) {
                            console.log('Real account trouv√©:', realAccount);
                            console.log('GmailId dans realAccount:', realAccount.gmailId);
                        }
                    }
                    
                    // Trouver le Gmail associ√© via gmailId ou via assignedTwitterUsername
                    if (realAccount && realAccount.gmailId) {
                        gmail = data.gmailAccounts.find(g => g.id === realAccount.gmailId);
                    } else if (account.gmailId) {
                        gmail = data.gmailAccounts.find(g => g.id === account.gmailId);
                    } else {
                        gmail = data.gmailAccounts.find(g => 
                            g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                        );
                    }
                    
                    if (account.username.toLowerCase().includes('laurabptss')) {
                        console.log('Gmail trouv√©:', gmail);
                        console.log('Recherche du Gmail avec ID:', realAccount?.gmailId || account.gmailId);
                        console.log('Tous les gmailAccounts:', data.gmailAccounts);
                        if (data.gmailAccounts) {
                            const gmailById = data.gmailAccounts.find(g => g.id === (realAccount?.gmailId || account.gmailId));
                            console.log('Gmail trouv√© par ID direct:', gmailById);
                            const gmailByUsername = data.gmailAccounts.find(g => 
                                g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                            );
                            console.log('Gmail trouv√© par username:', gmailByUsername);
                        }
                    }
                    
                    // Trouver le VA via les vaIds de la cr√©atrice ou assignedVaId
                    if (realAccount && realAccount.assignedVaId) {
                        va = data.vas.find(v => v.id === realAccount.assignedVaId);
                    } else if (account.assignedVaId) {
                        va = data.vas.find(v => v.id === account.assignedVaId);
                    } else if (account.vaIds && account.vaIds.length > 0) {
                        va = data.vas.find(v => account.vaIds.includes(v.id));
                    }
                } else {
                    // Pour les comptes simples
                    creator = account.creatorId ? data.creators.find(c => c.id === account.creatorId) : null;
                    
                    // Chercher le Gmail par gmailId ou assignedTwitterUsername
                    if (account.gmailId) {
                        gmail = data.gmailAccounts.find(g => g.id === account.gmailId);
                    }
                    if (!gmail) {
                        gmail = data.gmailAccounts.find(g => 
                            g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                        );
                    }
                    
                    va = account.vaId ? data.vas.find(v => v.id === account.vaId) : null;
                }
                
                // Debug final pour Laurabptss
                if (account.username.toLowerCase().includes('laurabptss')) {
                    console.log('üé® RENDU HTML pour Laurabptss:');
                    console.log('  - creator:', creator);
                    console.log('  - gmail:', gmail);
                    console.log('  - va:', va);
                    console.log('  - Condition !gmail:', !gmail);
                    console.log('  - Triangle sera affich√©:', !gmail);
                }
                
                return `
                <div style="
                    padding: 1rem;
                    background: ${isDarkMode ? 'rgba(29, 161, 242, 0.1)' : 'rgba(29, 161, 242, 0.05)'};
                    border: 1px solid #1da1f2;
                    border-radius: 0.5rem;
                    transition: all 0.2s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong style="font-size: 1.1rem; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">
                                ${account.username}
                                ${!gmail ? `
                                    <i class="fas fa-exclamation-triangle" 
                                       style="color: #fbbf24; margin-left: 0.5rem; font-size: 0.9rem;" 
                                       title="Pas de Gmail associ√©"></i>
                                ` : ''}
                            </strong>
                            <div style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'}; margin-top: 0.5rem;">
                                ${creator ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-user" style="width: 20px; color: #8b5cf6;"></i> Cr√©atrice: <strong>${creator.name}</strong></div>` : ''}
                                ${gmail ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-envelope" style="width: 20px; color: #ea4335;"></i> Gmail: <strong>${gmail.email}</strong></div>` : 
                                  creator ? `<div style="margin-bottom: 0.25rem; color: #ef4444;"><i class="fas fa-envelope" style="width: 20px; opacity: 0.5;"></i> <em>Aucun Gmail associ√©</em></div>` : ''}
                                ${va ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-user-tie" style="width: 20px; color: #667eea;"></i> VA: <strong>${va.name}</strong></div>` : ''}
                                ${!creator && !gmail && !va ? '<div style="color: #ef4444; font-style: italic;">Aucune association</div>' : ''}
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                                    ${account.source === 'creator' ? '<span style="color: #8b5cf6;">Depuis cr√©atrice</span> ‚Ä¢ ' : ''}
                                    Ajout√© le ${new Date(account.created).toLocaleDateString('fr-FR')}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${!gmail && creator ? `
                                <button class="action-btn" onclick="showAssignGmailModal('${account.creatorId}', '${account.username}')" 
                                        style="background: #ea4335;" title="Assigner un Gmail">
                                    <i class="fas fa-envelope"></i> Gmail
                                </button>
                            ` : ''}
                            ${!creator && !gmail && !va && account.id ? `
                                <button class="action-btn" onclick="showReassignModal('${account.id}')" 
                                        style="background: #10b981;" title="R√©assigner ce compte">
                                    <i class="fas fa-user-plus"></i> Assigner
                                </button>
                            ` : ''}
                            <button class="action-btn" onclick="showTwitterPassword('${account.username}', '${account.password}')" 
                                    style="background: #1da1f2;" title="Voir le mot de passe">
                                <i class="fas fa-key"></i>
                            </button>
                            ${!creator && !gmail && !va && account.id ? `
                                <button class="action-btn" onclick="deleteTwitterAccount('${account.id}')" 
                                        style="background: #ef4444;" title="Supprimer d√©finitivement">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Update all creators table
        function updateAllCreatorsTable() {
            const container = document.getElementById('all-creators-table');
            const countContainer = document.getElementById('total-creators-count');
            if (!container) return;
            
            // Utiliser la nouvelle structure creators
            const allCreators = data.creators || [];
            
            // Afficher le total
            if (countContainer) {
                countContainer.innerHTML = `<i class="fas fa-users"></i> ${allCreators.length} cr√©atrice${allCreators.length > 1 ? 's' : ''}`;
            }
            
            if (allCreators.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <i class="fas fa-user-slash" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Aucune cr√©atrice ajout√©e</p>
                    </div>
                `;
                return;
            }
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Cr√©er le tableau simple
            container.innerHTML = `
                <div style="border: 1px solid ${isDarkMode ? 'rgba(255,255,255,0.1)' : '#e5e7eb'}; border-radius: 0.75rem; overflow: hidden; padding: 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                        ${allCreators.map(creator => {
                            const creatorData = data.creators.find(c => c.name === creator.name);
                            const hasVA = creatorData && creatorData.vaIds && creatorData.vaIds.length > 0;
                            const vaNames = [];
                            if (hasVA && creatorData.vaIds) {
                                creatorData.vaIds.forEach(vaId => {
                                    const va = data.vas.find(v => v.id === vaId);
                                    if (va) vaNames.push(va.name);
                                });
                            }
                            
                            return `
                                <div style="background: ${isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.02)'}; 
                                            padding: 1rem; 
                                            border-radius: 0.5rem;
                                            border: 1px solid ${isDarkMode ? 'rgba(255,255,255,0.1)' : '#e5e7eb'};">
                                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <i class="fas fa-star" style="color: #f59e0b;"></i>
                                            <span style="color: ${isDarkMode ? '#e2e8f0' : '#1f2937'}; font-weight: 500;">
                                                ${creator.name}
                                            </span>
                                            ${vaNames.length > 0 ? `
                                                <span style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                                                    (${vaNames.join(', ')})
                                                </span>
                                            ` : ''}
                                        </div>
                                        <div style="display: flex; gap: 0.25rem;">
                                            ${creatorData && vaNames.length > 1 ? `
                                                <button onclick="showSplitCreatorModal('${creatorData.id}')" 
                                                        class="action-btn" 
                                                        style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background: #dc2626;"
                                                        title="S√©parer en cr√©atrices distinctes par VA">
                                                    <i class="fas fa-cut"></i> S√©parer
                                                </button>
                                            ` : ''}
                                            ${creatorData ? `
                                                <button onclick="assignVAToCreator('${creatorData.id}')" 
                                                        class="action-btn" 
                                                        style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background: #667eea;">
                                                    <i class="fas fa-link"></i> ${hasVA ? 'Modifier VA' : 'Assigner VA'}
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Update VA selects
        function updateVASelects() {
            const vaOptions = data.vas.map(va => 
                `<option value="${va.id}">${va.name}</option>`
            ).join('');

            const selectVaAccount = document.getElementById('select-va-account');
            if (selectVaAccount) {
                selectVaAccount.innerHTML = '<option value="">-- Sans VA pour le moment --</option>' + vaOptions;
            }
            
            // Mettre √† jour aussi les selects de cr√©atrices et Gmail
            updateCreatorSelect();
            updateGmailSelectForTwitter();
        }
        
        // Update creator select
        function updateCreatorSelect() {
            const creatorOptions = data.creators
                .filter(c => c.name !== 'Compte Orphelin') // Ne pas montrer les comptes orphelins
                .map(c => `<option value="${c.id}">${c.name}</option>`)
                .join('');
            
            const selectCreator = document.getElementById('select-creator-account');
            if (selectCreator) {
                selectCreator.innerHTML = '<option value="">-- Sans cr√©atrice pour le moment --</option>' + creatorOptions;
            }
        }
        
        // Update Gmail select for Twitter account
        function updateGmailSelectForTwitter() {
            const gmailSelect = document.getElementById('select-gmail-account');
            if (!gmailSelect) return;
            
            // Obtenir tous les comptes Gmail non utilis√©s
            const gmailAccounts = data.gmailAccounts || [];
            
            // Trouver les Gmail d√©j√† utilis√©s
            const usedGmailIds = new Set();
            data.creators.forEach(creator => {
                (creator.accounts || []).forEach(account => {
                    if (account.gmailId) {
                        usedGmailIds.add(account.gmailId);
                    }
                });
            });
            
            // Filtrer pour n'afficher que les Gmail disponibles
            const availableGmails = gmailAccounts.filter(gmail => !usedGmailIds.has(gmail.id));
            
            const options = availableGmails.map(gmail => 
                `<option value="${gmail.id}">${gmail.email}</option>`
            ).join('');
            
            gmailSelect.innerHTML = '<option value="">-- Sans Gmail pour le moment --</option>' + options;
        }

        // Update creator select based on VA
        
        // Update Gmail select based on VA selection
        function updateGmailSelect() {
            const vaId = document.getElementById('select-va-account').value;
            const gmailSelect = document.getElementById('select-gmail-account');
            
            if (!vaId) {
                gmailSelect.innerHTML = '<option value="">-- D\'abord choisir un VA --</option>';
                gmailSelect.disabled = true;
                return;
            }
            
            // Get ALL Gmail accounts (assigned to this VA OR unassigned)
            const allGmailAccounts = data.gmailAccounts?.filter(acc => 
                acc.vaId === vaId || acc.vaId === null || acc.vaId === ''
            ) || [];
            
            // Get already used Gmail accounts (linked to Twitter accounts)
            const usedGmailIds = [];
            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        if (account.gmailId) {
                            usedGmailIds.push(account.gmailId);
                        }
                    });
                });
            });
            
            // Filter to get only unused Gmail accounts
            const availableGmailAccounts = allGmailAccounts.filter(acc => !usedGmailIds.includes(acc.id));
            
            if (availableGmailAccounts.length === 0) {
                gmailSelect.innerHTML = '<option value="">-- Aucun compte Gmail disponible --</option>';
                gmailSelect.disabled = true;
                return;
            }
            
            const options = availableGmailAccounts.map(acc => {
                const label = acc.vaId ? acc.email : `${acc.email} üî¥ (non assign√©)`;
                return `<option value="${acc.id}">${label}</option>`;
            }).join('');
            
            gmailSelect.innerHTML = '<option value="">-- Choisir un compte Gmail --</option>' + options;
            gmailSelect.disabled = false;
        }

        // Add VA - VERSION SIMPLE
        function addVA(e) {
            e.preventDefault();
            
            const name = document.getElementById('va-name').value.trim();
            
            const newVA = {
                id: 'va_' + Date.now(),
                name: name
            };

            data.vas.push(newVA);
            saveData();
            
            e.target.reset();
            showSuccess(`VA "${name}" ajout√© avec succ√®s!`);
            updateDisplay();  // Met √† jour tous les affichages y compris le dashboard
        }

        // Add Creator
        function addCreator(e) {
            e.preventDefault();
            
            const creatorName = document.getElementById('creator-name').value.trim();
            
            // V√©rifier si la cr√©atrice existe d√©j√†
            if (data.creators && data.creators.some(c => c.name.toLowerCase() === creatorName.toLowerCase())) {
                showError(`La cr√©atrice "${creatorName}" existe d√©j√†!`);
                return;
            }
            
            // Initialiser le tableau si n√©cessaire
            if (!data.creators) {
                data.creators = [];
            }

            const newCreator = {
                id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                name: creatorName,
                vaIds: [], // Array vide pour les VAs assign√©s
                accounts: [] // Array vide pour les comptes
            };

            data.creators.push(newCreator);
            saveData();
            
            e.target.reset();
            updateAllCreatorsTable(); // Mettre √† jour le tableau
            showSuccess(`Cr√©atrice "${creatorName}" ajout√©e!`);
        }
        
        // Delete VA
        function deleteVA(vaId) {
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            const totalCreators = va.creators.length;
            const totalAccounts = va.creators.reduce((sum, creator) => sum + creator.accounts.length, 0);
            
            // Count associated data
            const associatedSubs = data.subs ? data.subs.filter(s => s.vaId === vaId).length : 0;
            const associatedRevenues = data.revenues ? data.revenues.filter(r => r.vaId === vaId).length : 0;
            const associatedPayments = data.vaPayments ? data.vaPayments.filter(p => p.vaId === vaId).length : 0;
            
            let confirmMessage = `‚ö†Ô∏è ATTENTION : Supprimer le VA "${va.name}" ?\n\n`;
            confirmMessage += `Cela supprimera D√âFINITIVEMENT :\n`;
            confirmMessage += `‚Ä¢ ${totalCreators} cr√©atrice(s)\n`;
            confirmMessage += `‚Ä¢ ${totalAccounts} compte(s) Twitter\n`;
            
            if (associatedSubs > 0) {
                confirmMessage += `‚Ä¢ ${associatedSubs} entr√©e(s) de subs\n`;
            }
            if (associatedRevenues > 0) {
                confirmMessage += `‚Ä¢ ${associatedRevenues} revenus enregistr√©(s)\n`;
            }
            if (associatedPayments > 0) {
                confirmMessage += `‚Ä¢ ${associatedPayments} paiement(s)\n`;
            }
            
            confirmMessage += `\n‚ùå Cette action est IRR√âVERSIBLE !`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation for safety
            if (!confirm(`Derni√®re confirmation :\nSupprimer d√©finitivement "${va.name}" et toutes ses donn√©es ?`)) {
                return;
            }
            
            try {
                // Remove the VA
                data.vas = data.vas.filter(v => v.id !== vaId);
                
                // Remove associated subs
                if (data.subs) {
                    data.subs = data.subs.filter(s => s.vaId !== vaId);
                }
                
                // Remove associated revenues
                if (data.revenues) {
                    data.revenues = data.revenues.filter(r => r.vaId !== vaId);
                }
                
                // Remove associated payments
                if (data.vaPayments) {
                    data.vaPayments = data.vaPayments.filter(p => p.vaId !== vaId);
                }
                
                // Remove old payments if they exist
                if (data.payments) {
                    data.payments = data.payments.filter(p => p.vaId !== vaId);
                }
                
                saveData();
                
                showSuccess(`VA "${va.name}" et toutes ses donn√©es ont √©t√© supprim√©s.`);
                
                // Update all displays that might show VA data
                updateVAGrid();
                updateDisplay();
                
            } catch (error) {
                alert(`‚ùå Erreur lors de la suppression : ${error.message}`);
                console.error('Erreur suppression VA:', error);
            }
        }

        function deleteCreator(vaId, creatorId) {
            // Utiliser la nouvelle structure
            const creatorIndex = data.creators.findIndex(c => c.id === creatorId);
            if (creatorIndex === -1) return;
            
            const creator = data.creators[creatorIndex];
            const totalAccounts = creator.accounts ? creator.accounts.length : 0;
            
            // Count associated data
            const associatedSubs = data.subs ? data.subs.filter(s => s.creatorId === creatorId).length : 0;
            const associatedRevenues = data.revenues ? data.revenues.filter(r => r.creatorId === creatorId).length : 0;
            
            let confirmMessage = `‚ö†Ô∏è ATTENTION : Supprimer la cr√©atrice "${creator.name}" ?\n\n`;
            confirmMessage += `Cela supprimera D√âFINITIVEMENT :\n`;
            confirmMessage += `‚Ä¢ ${totalAccounts} compte(s) Twitter\n`;
            
            if (associatedSubs > 0) {
                confirmMessage += `‚Ä¢ ${associatedSubs} entr√©e(s) de subs\n`;
            }
            if (associatedRevenues > 0) {
                confirmMessage += `‚Ä¢ ${associatedRevenues} revenus enregistr√©(s)\n`;
            }
            
            confirmMessage += `\n‚ùå Cette action est IRR√âVERSIBLE !`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // Supprimer la cr√©atrice de la structure globale
                data.creators.splice(creatorIndex, 1);
                
                // Retirer la r√©f√©rence du VA si elle existe
                if (vaId) {
                    const va = data.vas.find(v => v.id === vaId);
                    if (va && va.creatorIds) {
                        va.creatorIds = va.creatorIds.filter(id => id !== creatorId);
                    }
                }
                
                // Remove associated subs
                if (data.subs) {
                    data.subs = data.subs.filter(s => !(s.vaId === vaId && s.creatorId === creatorId));
                }
                
                // Remove associated revenues
                if (data.revenues) {
                    data.revenues = data.revenues.filter(r => !(r.vaId === vaId && r.creatorId === creatorId));
                }
                
                saveData();
                
                showSuccess(`Cr√©atrice "${creator.name}" et ses donn√©es ont √©t√© supprim√©es.`);
                
                // Update displays
                updateVAGrid();
                updateDisplay();
                
            } catch (error) {
                alert(`‚ùå Erreur lors de la suppression : ${error.message}`);
                console.error('Erreur suppression cr√©atrice:', error);
            }
        }

        // On creator change - Check if multi-VA
        function onCreatorChange() {
            const creatorId = document.getElementById('account-creator').value;
            const vaSelect = document.getElementById('account-va');
            const vaWarning = document.getElementById('va-warning');

            if (!creatorId) {
                vaWarning.style.display = 'none';
                vaSelect.style.border = '';
                // R√©afficher tous les VAs
                vaSelect.innerHTML = '<option value="">S√©lectionner un VA</option>';
                data.vas.forEach(va => {
                    const option = document.createElement('option');
                    option.value = va.id;
                    option.textContent = va.name;
                    vaSelect.appendChild(option);
                });
                return;
            }

            const creator = data.creators.find(c => c.id === creatorId);

            // Toujours afficher TOUS les VAs disponibles
            vaSelect.innerHTML = '<option value="">S√©lectionner un VA</option>';
            data.vas.forEach(va => {
                const option = document.createElement('option');
                option.value = va.id;

                // Indiquer si c'est un VA d√©j√† associ√© √† cette cr√©atrice
                if (creator && creator.vaIds && creator.vaIds.includes(va.id)) {
                    option.textContent = `${va.name} ‚≠ê (D√©j√† associ√©)`;
                    option.style.fontWeight = 'bold';
                } else {
                    option.textContent = va.name;
                }

                vaSelect.appendChild(option);
            });

            if (creator && creator.vaIds && creator.vaIds.length > 1) {
                // Cr√©atrice multi-VA : afficher l'avertissement mais garder tous les VAs
                vaWarning.style.display = 'block';
                vaSelect.style.border = '2px solid #f59e0b';
            } else {
                // Cr√©atrice mono-VA : masquer l'avertissement
                vaWarning.style.display = 'none';
                vaSelect.style.border = '';

                // Si elle n'a qu'un VA, le pr√©s√©lectionner (mais laisser le choix)
                if (creator && creator.vaIds && creator.vaIds.length === 1) {
                    vaSelect.value = creator.vaIds[0];
                }
            }
        }
        
        // Add Account - VERSION SIMPLE
        function addAccount(e) {
            e.preventDefault();

            // D√©terminer la plateforme actuelle
            const platform = window.currentPlatform || 'twitter';

            let username, password;
            if (platform === 'twitter') {
                username = document.getElementById('twitter-username').value.trim();
                password = document.getElementById('twitter-password').value.trim();
            } else {
                username = document.getElementById('instagram-username').value.trim();
                password = document.getElementById('instagram-password').value.trim();
            }

            const creatorId = document.getElementById('account-creator').value;
            const gmailId = document.getElementById('account-gmail').value;
            const vaId = document.getElementById('account-va').value;
            
            // VALIDATION ULTRATHINK : V√©rifier qu'un VA est s√©lectionn√© pour les cr√©atrices multi-VA
            const creator = data.creators.find(c => c.id === creatorId);
            if (creator && creator.vaIds && creator.vaIds.length > 1 && !vaId) {
                showError('‚ö†Ô∏è ATTENTION : Cette cr√©atrice est sur plusieurs VAs. Vous DEVEZ choisir le VA pour ce compte !');
                document.getElementById('account-va').focus();
                document.getElementById('account-va').style.borderColor = '#ef4444';
                return;
            }

            // Normaliser le username
            const finalUsername = username.startsWith('@') ? username : '@' + username;

            if (platform === 'twitter') {
                // Initialiser le tableau des comptes Twitter s'il n'existe pas
                if (!data.twitterAccounts) {
                    data.twitterAccounts = [];
                }

                // V√©rifier si le compte existe d√©j√†
                const accountExists = data.twitterAccounts.some(acc =>
                    acc.username.toLowerCase() === finalUsername.toLowerCase()
                );

                if (accountExists) {
                    showError(`Le compte Twitter "${finalUsername}" existe d√©j√†`);
                    return;
                }

                // Si une cr√©atrice est s√©lectionn√©e, ajouter le compte √† la cr√©atrice
                if (creatorId) {
                    const creator = data.creators.find(c => c.id === creatorId);
                    if (creator) {
                        if (!creator.accounts) creator.accounts = [];

                        // Cr√©er le nouveau compte avec assignedVaId si un VA est s√©lectionn√©
                        const newAccount = {
                            username: finalUsername,
                            password: obfuscatePassword(password)
                        };

                        // IMPORTANT: Assigner le compte sp√©cifiquement √† CE VA
                        if (vaId) {
                            newAccount.assignedVaId = vaId;
                        }

                        creator.accounts.push(newAccount);

                        // Assigner le VA √† la cr√©atrice si s√©lectionn√©
                        if (vaId && !creator.vaIds) {
                            creator.vaIds = [vaId];
                        } else if (vaId && !creator.vaIds.includes(vaId)) {
                            creator.vaIds.push(vaId);
                        }
                    }
                }

                // Si un Gmail est s√©lectionn√©, l'assigner
                if (gmailId) {
                    const gmail = data.gmailAccounts.find(g => g.id === gmailId);
                    if (gmail) {
                        gmail.assignedTwitterUsername = finalUsername;
                        if (vaId) gmail.vaId = vaId;
                    }
                }

                // Cr√©er le nouveau compte Twitter (version simple pour la liste)
                const newAccount = {
                    id: 'tw_' + Date.now(),
                    username: finalUsername,
                    password: obfuscatePassword(password),
                    creatorId: creatorId || null,
                    gmailId: gmailId || null,
                    vaId: vaId || null,
                    created: new Date().toISOString()
                };

                // Ajouter le compte
                data.twitterAccounts.push(newAccount);

                // Sauvegarder et rafra√Æchir
                saveData();
                e.target.reset();
                updateTwitterAccountsList();
                showSuccess(`Compte Twitter ${finalUsername} ajout√©!`);

            } else { // Instagram
                // Initialiser le tableau des comptes Instagram s'il n'existe pas
                if (!data.instagramAccounts) {
                    data.instagramAccounts = [];
                }

                // V√©rifier si le compte existe d√©j√†
                const accountExists = data.instagramAccounts.some(acc =>
                    acc.username.toLowerCase() === finalUsername.toLowerCase()
                );

                if (accountExists) {
                    showError(`Le compte Instagram "${finalUsername}" existe d√©j√†`);
                    return;
                }

                // Si une cr√©atrice est s√©lectionn√©e, ajouter le compte √† la cr√©atrice
                if (creatorId) {
                    const creator = data.creators.find(c => c.id === creatorId);
                    if (creator) {
                        if (!creator.instagramAccounts) creator.instagramAccounts = [];

                        // Cr√©er le nouveau compte avec assignedVaId si un VA est s√©lectionn√©
                        const newAccount = {
                            username: finalUsername,
                            password: obfuscatePassword(password)
                        };

                        // IMPORTANT: Assigner le compte sp√©cifiquement √† CE VA
                        if (vaId) {
                            newAccount.assignedVaId = vaId;
                        }

                        if (gmailId) {
                            newAccount.gmailId = gmailId;
                        }

                        creator.instagramAccounts.push(newAccount);

                        // Assigner le VA √† la cr√©atrice si s√©lectionn√©
                        if (vaId && !creator.vaIds) {
                            creator.vaIds = [vaId];
                        } else if (vaId && !creator.vaIds.includes(vaId)) {
                            creator.vaIds.push(vaId);
                        }
                    }
                }

                // Si un Gmail est s√©lectionn√©, l'assigner
                if (gmailId) {
                    const gmail = data.gmailAccounts.find(g => g.id === gmailId);
                    if (gmail) {
                        gmail.assignedInstagramUsername = finalUsername;
                        if (vaId) gmail.vaId = vaId;
                    }
                }

                // Cr√©er le nouveau compte Instagram (version simple pour la liste)
                const newAccount = {
                    id: 'ig_' + Date.now(),
                    username: finalUsername,
                    password: obfuscatePassword(password),
                    creatorId: creatorId || null,
                    gmailId: gmailId || null,
                    vaId: vaId || null,
                    created: new Date().toISOString()
                };

                // Ajouter le compte
                data.instagramAccounts.push(newAccount);

                // Sauvegarder et rafra√Æchir
                saveData();
                e.target.reset();
                updateInstagramAccountsList();
                showSuccess(`Compte Instagram ${finalUsername} ajout√©!`);
            }
        }

        // Confirm add Twitter account
        function confirmAddTwitterAccount(vaId, username, password) {
            // IMPORTANT: Ne jamais modifier le username pass√© en param√®tre
            console.log(`üìå Ajout du compte Twitter: ${username}`);
            
            // DEBUG: Afficher l'√©tat avant ajout
            console.log('üîç √âtat AVANT ajout:');
            console.log('Toutes les cr√©atrices "Laura":');
            data.creators.forEach(creator => {
                if (creator.name.toLowerCase().includes('laura')) {
                    console.log(`  - Cr√©atrice "${creator.name}" (ID: ${creator.id})`);
                    console.log(`    VAs associ√©s: ${creator.vaIds?.map(id => data.vas.find(v => v.id === id)?.name).join(', ')}`);
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(acc => {
                            console.log(`    Compte: ${acc.username}`);
                        });
                    }
                }
            });
            
            const existingCreatorId = document.getElementById('select-existing-creator').value;
            const newCreatorName = document.getElementById('new-creator-name').value.trim();
            
            if (!existingCreatorId && !newCreatorName) {
                showError('Veuillez s√©lectionner une cr√©atrice existante ou en cr√©er une nouvelle');
                return;
            }
            
            let selectedCreator;
            
            if (existingCreatorId) {
                // Utiliser cr√©atrice existante
                selectedCreator = data.creators.find(c => c.id === existingCreatorId);
                console.log(`üìé S√©lection de la cr√©atrice existante: "${selectedCreator?.name}" (ID: ${existingCreatorId})`);
            } else {
                // Cr√©er nouvelle cr√©atrice
                selectedCreator = {
                    id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: newCreatorName,
                    vaIds: [vaId],
                    accounts: []
                };
                data.creators.push(selectedCreator);
                
                // Ajouter la r√©f√©rence au VA
                const va = data.vas.find(v => v.id === vaId);
                if (va) {
                    if (!va.creatorIds) va.creatorIds = [];
                    va.creatorIds.push(selectedCreator.id);
                }
            }
            
            // S'assurer que le VA est dans la liste de la cr√©atrice
            if (!selectedCreator.vaIds) selectedCreator.vaIds = [];
            if (!selectedCreator.vaIds.includes(vaId)) {
                selectedCreator.vaIds.push(vaId);
            }
            
            // Cr√©er le compte Twitter - S'ASSURER qu'on utilise le username exact sans modification
            const finalUsername = username.startsWith('@') ? username : '@' + username;
            
            // V√©rification finale pour √©viter les doublons
            const accountAlreadyExists = selectedCreator.accounts && 
                selectedCreator.accounts.some(acc => acc.username.toLowerCase() === finalUsername.toLowerCase());
            
            if (accountAlreadyExists) {
                showError(`Le compte ${finalUsername} existe d√©j√† pour cette cr√©atrice`);
                closeModal();
                return;
            }
            
            const newAccount = {
                id: 'tw_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                username: finalUsername, // Utiliser le username exact
                password: obfuscatePassword(password),
                gmailId: null,
                assignedVaId: vaId, // IMPORTANT: Assigner sp√©cifiquement √† CE VA
                created: new Date().toISOString().split('T')[0]
            };
            
            if (!selectedCreator.accounts) selectedCreator.accounts = [];
            selectedCreator.accounts.push(newAccount);
            
            saveData();
            closeModal();
            document.getElementById('add-account-form').reset();
            
            // DEBUG: Afficher l'√©tat apr√®s ajout
            console.log('üîç √âtat APR√àS ajout:');
            console.log('Toutes les cr√©atrices "Laura" apr√®s ajout:');
            data.creators.forEach(creator => {
                if (creator.name.toLowerCase().includes('laura')) {
                    console.log(`  - Cr√©atrice "${creator.name}" (ID: ${creator.id})`);
                    console.log(`    VAs associ√©s: ${creator.vaIds?.map(id => data.vas.find(v => v.id === id)?.name).join(', ')}`);
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(acc => {
                            console.log(`    Compte: ${acc.username} (ID: ${acc.id})`);
                        });
                    }
                }
            });
            
            updateTwitterAccountsList();
            updateDisplay();
            
            showSuccess(`Compte Twitter "${newAccount.username}" ajout√© √† "${selectedCreator.name}"!`);
            console.log(`‚úÖ Compte ajout√© avec succ√®s: ${newAccount.username} pour ${selectedCreator.name}`);
        }
        
        // Add Gmail account
        function addGmailAccount(e) {
            e.preventDefault();
            
            const email = document.getElementById('gmail-email').value.trim().toLowerCase(); // Normaliser en minuscules
            const password = document.getElementById('gmail-password').value.trim();
            
            // V√©rifier si l'email existe d√©j√†
            if (!data.gmailAccounts) data.gmailAccounts = [];
            
            const emailExists = data.gmailAccounts.some(account => 
                account.email.toLowerCase() === email
            );
            
            if (emailExists) {
                showError(`Cette adresse email "${email}" existe d√©j√† !`);
                return;
            }
            
            const newGmailAccount = {
                id: generateId(),
                vaId: null, // Toujours non assign√© au d√©but
                email: email,
                password: obfuscatePassword(password), // Obfusquer le mot de passe
                notes: '',
                created: new Date().toISOString()
            };
            
            data.gmailAccounts.push(newGmailAccount);
            
            saveData();
            e.target.reset();
            
            showSuccess(`Compte Gmail "${email}" ajout√©!`);
            updateGmailAccountsList(); // Mettre √† jour la liste
        }
        
        // Update Gmail accounts display
        function updateGmailAccountsDisplay() {
            const container = document.getElementById('gmail-accounts-container');
            const statsContainer = document.getElementById('gmail-stats');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!data.gmailAccounts || data.gmailAccounts.length === 0) {
                container.innerHTML = '<div class="no-creator">Aucun compte Gmail ajout√©</div>';
                if (statsContainer) statsContainer.innerHTML = '';
                return;
            }
            
            // Group Gmail accounts by VA (including unassigned)
            const accountsByVA = {
                'unassigned': {
                    name: 'Non assign√©s',
                    accounts: []
                }
            };
            
            data.vas.forEach(va => {
                accountsByVA[va.id] = {
                    name: va.name,
                    accounts: []
                };
            });
            
            data.gmailAccounts.forEach(account => {
                if (account.vaId && accountsByVA[account.vaId]) {
                    accountsByVA[account.vaId].accounts.push(account);
                } else {
                    accountsByVA['unassigned'].accounts.push(account);
                }
            });
            
            // Get used Gmail IDs from bidirectional assignment
            const usedGmailIds = [];
            const gmailToTwitter = {};
            
            // Check from Twitter accounts (old method)
            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        if (account.gmailId) {
                            usedGmailIds.push(account.gmailId);
                            gmailToTwitter[account.gmailId] = {
                                twitter: account.username,
                                creator: creator.name,
                                va: va.name
                            };
                        }
                    });
                });
            });
            
            // Check from new creator structure
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        if (account.gmailId) {
                            usedGmailIds.push(account.gmailId);
                            gmailToTwitter[account.gmailId] = {
                                twitter: account.username,
                                creator: creator.name,
                                va: creator.assignedVAs && creator.assignedVAs.length > 0 ? 
                                    data.vas.find(v => v.id === creator.assignedVAs[0])?.name : 'Non assign√©'
                            };
                        }
                    });
                }
            });
            
            // Update statistics
            const totalGmail = data.gmailAccounts.length;
            const usedGmail = usedGmailIds.length;
            const availableGmail = totalGmail - usedGmail;
            const unassignedGmail = accountsByVA['unassigned'].accounts.length;
            
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <span style="color: #059669;"><i class="fas fa-check-circle"></i> ${usedGmail} utilis√©s</span>
                    <span style="color: #dc2626;"><i class="fas fa-times-circle"></i> ${availableGmail} disponibles</span>
                    <span style="color: #f59e0b;"><i class="fas fa-exclamation-triangle"></i> ${unassignedGmail} non assign√©s</span>
                    <span style="color: #6366f1;"><i class="fas fa-envelope"></i> ${totalGmail} total</span>
                `;
            }
            
            // Display unassigned accounts first
            if (accountsByVA['unassigned'].accounts.length > 0) {
                const unassignedSection = document.createElement('div');
                unassignedSection.className = 'va-section unassigned-section';
                unassignedSection.style.marginBottom = '2rem';
                unassignedSection.style.border = '2px solid #ef4444';
                unassignedSection.style.borderRadius = '0.5rem';
                unassignedSection.style.padding = '1rem';
                
                // D√©tecter le mode sombre dynamiquement √† chaque affichage
                const isDarkMode = document.body.classList.contains('dark-mode');
                
                unassignedSection.innerHTML = `
                    <h4 style="color: #ef4444; margin-bottom: 1rem;">
                        <i class="fas fa-exclamation-triangle"></i> Comptes Non Assign√©s (${accountsByVA['unassigned'].accounts.length})
                    </h4>
                    <p style="margin: 0 0 1rem 0; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">
                        <i class="fas fa-info-circle"></i> Pour utiliser ces comptes, allez dans "Twitter sans Gmail" et assignez-les √† un compte Twitter.
                    </p>
                    <div class="gmail-list">
                        ${accountsByVA['unassigned'].accounts.map(account => {
                            const isUsed = usedGmailIds.includes(account.id);
                            return `
                            <div class="account-item unassigned-account-item" style="background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : '#fef2f2'}; color: ${isDarkMode ? '#e1e8ef' : 'inherit'}; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; border-left: 4px solid #ef4444;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <strong style="color: ${isDarkMode ? '#f3f4f6' : '#1e293b'};">${account.email}</strong>
                                        <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; background: ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : '#fee2e2'}; color: ${isDarkMode ? '#f87171' : '#991b1b'};">
                                            Non assign√© ${isUsed ? '(mais utilis√©!)' : ''}
                                        </span>
                                    </div>
                                    ${account.notes ? `<p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#94a3b8' : '#718096'}; font-size: 0.875rem;">${account.notes}</p>` : ''}
                                    <p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#64748b' : '#a0aec0'}; font-size: 0.75rem;">Ajout√© le ${new Date(account.created).toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button class="action-btn" onclick="showGmailPassword('${account.id}')" title="Voir le mot de passe">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="deleteGmailAccount('${account.id}')" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(unassignedSection);
            }
            
            // Display accounts grouped by VA
            Object.entries(accountsByVA).forEach(([vaId, vaData]) => {
                if (vaId !== 'unassigned' && vaData.accounts.length > 0) {
                    const vaSection = document.createElement('div');
                    vaSection.className = 'va-section';
                    vaSection.style.marginBottom = '2rem';
                    
                    // D√©tecter le mode sombre pour chaque section
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    
                    vaSection.innerHTML = `
                        <h4 style="color: #667eea; margin-bottom: 1rem;">
                            <i class="fas fa-user"></i> ${vaData.name} (${vaData.accounts.length} comptes Gmail)
                        </h4>
                        <div class="gmail-list">
                            ${vaData.accounts.map(account => {
                                const isUsed = usedGmailIds.includes(account.id);
                                const twitterInfo = gmailToTwitter[account.id];
                                return `
                                <div class="account-item" style="background: ${isDarkMode ? (isUsed ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)') : (isUsed ? '#e6fffa' : '#fef2f2')}; color: ${isDarkMode ? '#e1e8ef' : 'inherit'}; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; border-left: 4px solid ${isUsed ? '#10b981' : '#ef4444'};">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <strong style="color: ${isDarkMode ? '#f3f4f6' : '#1e293b'};">${account.email}</strong>
                                            <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; background: ${isDarkMode ? (isUsed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)') : (isUsed ? '#d1fae5' : '#fee2e2')}; color: ${isDarkMode ? (isUsed ? '#4ade80' : '#f87171') : (isUsed ? '#065f46' : '#991b1b')};">
                                                ${isUsed ? 'Utilis√©' : 'Disponible'}
                                            </span>
                                        </div>
                                        ${isUsed && twitterInfo ? `
                                            <p style="margin: 0.5rem 0 0 0; color: ${isDarkMode ? '#4ade80' : '#059669'}; font-size: 0.875rem;">
                                                <i class="fab fa-twitter"></i> ${twitterInfo.twitter} (Cr√©atrice: ${twitterInfo.creator})
                                            </p>
                                        ` : ''}
                                        ${account.notes ? `<p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#94a3b8' : '#718096'}; font-size: 0.875rem;">${account.notes}</p>` : ''}
                                        <p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#64748b' : '#a0aec0'}; font-size: 0.75rem;">Ajout√© le ${new Date(account.created).toLocaleDateString('fr-FR')}</p>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <button class="action-btn" onclick="showGmailPassword('${account.id}')" title="Voir le mot de passe">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        ${!isUsed ? `
                                            <button class="action-btn delete" onclick="deleteGmailAccount('${account.id}')" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;}).join('')}
                        </div>
                    `;
                    
                    container.appendChild(vaSection);
                }
            });
        }
        
        // Unassign Gmail from Twitter or Instagram account
        function unassignGmail(gmailId, platform = 'twitter') {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;

            const platformName = platform === 'twitter' ? 'Twitter' : 'Instagram';
            const assignedAccount = platform === 'twitter' ? gmail.assignedTwitterUsername : gmail.assignedInstagramUsername;

            if (confirm(`Voulez-vous d√©sassigner ${platformName} de ${gmail.email} ?\n\n${platformName}: ${assignedAccount}\n\nCe compte ${platformName} sera disponible pour √™tre r√©assign√©.`)) {
                if (platform === 'twitter') {
                    gmail.assignedTwitterUsername = null;
                } else {
                    gmail.assignedInstagramUsername = null;
                }

                // Ne supprimer vaId que si les deux sont d√©sassign√©s
                if (!gmail.assignedTwitterUsername && !gmail.assignedInstagramUsername) {
                    gmail.vaId = null;
                }
                
                saveData();
                updateGmailAccountsList();
                updateTwitterAccountsList();
                showSuccess(`Email ${gmail.email} d√©sassign√© et disponible`);
            }
        }
        
        // Delete Gmail account
        function deleteGmailAccount(gmailId) {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;
            
            // V√©rifier si le compte est assign√©
            let warningMessage = `‚ö†Ô∏è ATTENTION: Voulez-vous vraiment supprimer le compte Gmail ${gmail.email} ?`;
            
            if (gmail.assignedTwitterUsername) {
                warningMessage += `\n\nCe compte est actuellement assign√© √† ${gmail.assignedTwitterUsername}.`;
                warningMessage += `\nLa suppression cassera cette association !`;
            }
            
            // V√©rifier aussi dans les comptes des cr√©atrices
            let associatedAccounts = [];
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        creator.accounts.forEach(account => {
                            if (account.gmailId === gmailId) {
                                associatedAccounts.push({
                                    creator: creator.name,
                                    twitter: account.username
                                });
                            }
                        });
                    }
                });
            }
            
            if (associatedAccounts.length > 0) {
                warningMessage += `\n\n‚ö†Ô∏è Ce Gmail est utilis√© par :`;
                associatedAccounts.forEach(assoc => {
                    warningMessage += `\n- ${assoc.twitter} (${assoc.creator})`;
                });
                warningMessage += `\n\nCes associations seront perdues !`;
            }
            
            warningMessage += `\n\nCette action est irr√©versible !`;
            
            if (confirm(warningMessage)) {
                // Supprimer toutes les r√©f√©rences √† ce Gmail
                if (data.creators) {
                    data.creators.forEach(creator => {
                        if (creator.accounts) {
                            creator.accounts.forEach(account => {
                                if (account.gmailId === gmailId) {
                                    account.gmailId = null;
                                }
                            });
                        }
                    });
                }
                
                // Supprimer dans data.twitterAccounts
                if (data.twitterAccounts) {
                    data.twitterAccounts.forEach(ta => {
                        if (ta.gmailId === gmailId) {
                            ta.gmailId = null;
                        }
                    });
                }
                
                // Supprimer le compte Gmail
                const index = data.gmailAccounts.findIndex(g => g.id === gmailId);
                if (index > -1) {
                    data.gmailAccounts.splice(index, 1);
                }
                
                saveData();
                updateDisplay();
                showSuccess(`Compte Gmail ${gmail.email} supprim√© d√©finitivement`);
            }
        }
        
        // Edit Gmail account
        function editGmailAccount(gmailId) {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;
            
            // Pr√©-remplir le formulaire
            document.getElementById('edit-gmail-id').value = gmail.id;
            document.getElementById('edit-gmail-email').value = gmail.email;
            
            // D√©coder le mot de passe pour l'√©dition
            const decodedPassword = deobfuscatePassword(gmail.password);
            document.getElementById('edit-gmail-password').value = decodedPassword;
            
            // Afficher la modal
            document.getElementById('edit-gmail-modal').classList.add('show');
        }
        
        // Toggle password visibility in edit modal
        function toggleEditPasswordVisibility() {
            const passwordInput = document.getElementById('edit-gmail-password');
            const toggleIcon = document.getElementById('edit-password-toggle-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }
        
        // Close edit Gmail modal
        function closeEditGmailModal() {
            document.getElementById('edit-gmail-modal').classList.remove('show');
            document.getElementById('edit-gmail-form').reset();
            // Remettre le champ mot de passe en mode masqu√©
            const passwordInput = document.getElementById('edit-gmail-password');
            const toggleIcon = document.getElementById('edit-password-toggle-icon');
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
        
        // Save edited Gmail
        function saveEditedGmail(e) {
            e.preventDefault();
            
            const gmailId = document.getElementById('edit-gmail-id').value;
            const newEmail = document.getElementById('edit-gmail-email').value.trim().toLowerCase();
            const newPassword = document.getElementById('edit-gmail-password').value;
            
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;
            
            // V√©rifier si le nouvel email existe d√©j√† (sauf si c'est le m√™me compte)
            const emailExists = data.gmailAccounts.some(g => 
                g.id !== gmailId && g.email.toLowerCase() === newEmail
            );
            
            if (emailExists) {
                alert(`L'email ${newEmail} existe d√©j√† !`);
                return;
            }
            
            // Mettre √† jour les donn√©es
            const oldEmail = gmail.email;
            gmail.email = newEmail;
            gmail.password = obfuscatePassword(newPassword);
            
            // Log la modification
            console.log(`üìß Modification du compte Gmail:`);
            console.log(`  - Ancien email: ${oldEmail}`);
            console.log(`  - Nouvel email: ${newEmail}`);
            if (gmail.assignedTwitterUsername) {
                console.log(`  - Assign√© √†: ${gmail.assignedTwitterUsername}`);
            }
            
            // Sauvegarder et mettre √† jour l'affichage
            saveData();
            updateGmailAccountsList();
            closeEditGmailModal();
            showSuccess(`Compte Gmail ${oldEmail} modifi√© avec succ√®s`);
        }
        
        // Get latest Twitter stats
        function getLatestTwitterStats(username) {
            if (!data.twitterStats) return null;
            
            const accountStats = data.twitterStats.filter(stat => 
                stat.username.toLowerCase() === username.toLowerCase()
            );
            
            if (accountStats.length === 0) return null;
            
            // Retourner la stat la plus r√©cente
            return accountStats.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        }
        
        // Format number with K/M notation
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }
        
        // Show update followers modal
        function showUpdateFollowersModal(username) {
            document.getElementById('followers-username').value = username;
            document.getElementById('followers-account-display').innerHTML = `
                <i class="fab fa-twitter"></i> ${username}
            `;
            
            // D√©finir la date du jour par d√©faut
            document.getElementById('followers-date').value = new Date().toISOString().split('T')[0];
            
            // Afficher l'historique
            const history = data.twitterStats ? 
                data.twitterStats.filter(stat => stat.username.toLowerCase() === username.toLowerCase())
                    .sort((a, b) => new Date(b.date) - new Date(a.date)) : [];
                    
            let historyHtml = '';
            if (history.length > 0) {
                const latest = history[0];
                const previous = history[1];
                
                historyHtml = `
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; color: #1f2937;">
                            Actuellement: ${formatNumber(latest.followers)} followers
                        </div>
                        <div style="font-size: 0.75rem; color: #6b7280;">
                            Derni√®re MAJ: ${new Date(latest.date).toLocaleDateString('fr-FR')}
                        </div>
                    `;
                
                if (previous) {
                    const diff = latest.followers - previous.followers;
                    const growth = ((diff / previous.followers) * 100).toFixed(1);
                    const color = diff >= 0 ? '#10b981' : '#ef4444';
                    const sign = diff >= 0 ? '+' : '';
                    
                    historyHtml += `
                        <div style="margin-top: 0.5rem; color: ${color}; font-weight: 600;">
                            ${sign}${formatNumber(Math.abs(diff))} (${sign}${growth}%) cette semaine
                        </div>
                    `;
                }
                
                historyHtml += '</div>';
                
                // Pr√©-remplir avec la derni√®re valeur
                document.getElementById('followers-count').value = latest.followers;
            }
            
            document.getElementById('followers-history').innerHTML = historyHtml || 
                '<div style="color: #94a3b8;">Aucun historique disponible</div>';
            
            document.getElementById('update-followers-modal').classList.add('show');
        }
        
        // Close update followers modal
        function closeUpdateFollowersModal() {
            document.getElementById('update-followers-modal').classList.remove('show');
            document.getElementById('update-followers-form').reset();
        }
        
        // Save followers update
        function saveFollowersUpdate(e) {
            e.preventDefault();
            
            const username = document.getElementById('followers-username').value;
            const followers = parseInt(document.getElementById('followers-count').value);
            const date = document.getElementById('followers-date').value;
            
            if (!data.twitterStats) data.twitterStats = [];
            
            // Ajouter la nouvelle statistique
            data.twitterStats.push({
                id: generateId(),
                username: username,
                followers: followers,
                date: date,
                created: new Date().toISOString()
            });
            
            saveData();
            updateDisplay();
            closeUpdateFollowersModal();
            showSuccess(`Followers mis √† jour pour ${username}: ${formatNumber(followers)}`);
        }
        
        // Show Gmail password
        function showGmailPassword(emailOrId, password) {
            // Si password est fourni, c'est la version simple (email + password)
            if (password) {
                const decodedPassword = deobfuscatePassword(password);
                alert(`Email: ${emailOrId}\nMot de passe: ${decodedPassword}`);
            } else {
                // Sinon, emailOrId est un ID (version complexe)
                const account = data.gmailAccounts.find(a => a.id === emailOrId);
                if (account) {
                    const decodedPassword = deobfuscatePassword(account.password);
                    alert(`Email: ${account.email}\nMot de passe: ${decodedPassword}`);
                }
            }
        }
        
        // Show all Gmail passwords
        function showAllGmailPasswords() {
            if (data.gmailAccounts.length === 0) {
                alert('Aucun compte Gmail enregistr√©');
                return;
            }
            
            let passwordList = 'LISTE DES MOTS DE PASSE GMAIL\n' + '='.repeat(40) + '\n\n';
            
            data.gmailAccounts.forEach(account => {
                const decodedPassword = deobfuscatePassword(account.password);
                passwordList += `Email: ${account.email}\n`;
                passwordList += `Mot de passe: ${decodedPassword}\n`;
                passwordList += `VA: ${account.vaId ? data.vas.find(v => v.id === account.vaId)?.name || 'VA supprim√©' : 'Non assign√©'}\n`;
                passwordList += `Twitter associ√©: ${account.assignedTwitterUsername || 'Aucun'}\n`;
                passwordList += '-'.repeat(40) + '\n\n';
            });
            
            // Cr√©er une modal pour afficher les mots de passe
            const isDarkMode = document.body.classList.contains('dark-mode');
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; ${isDarkMode ? 'background: #1f2937; color: #f3f4f6;' : ''}">
                    <div class="modal-header" style="${isDarkMode ? 'border-bottom-color: #374151;' : ''}">
                        <h2 style="${isDarkMode ? 'color: #f9fafb;' : ''}">Tous les mots de passe Gmail</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="${isDarkMode ? 'color: #9ca3af;' : ''}">√ó</button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <pre style="background: ${isDarkMode ? '#111827' : '#f3f4f6'}; color: ${isDarkMode ? '#e5e7eb' : '#1f2937'}; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'};">${passwordList}</pre>
                    </div>
                    <div style="padding: 1rem; text-align: center; ${isDarkMode ? 'border-top: 1px solid #374151;' : ''}">
                        <button onclick="copyToClipboard(\`${passwordList.replace(/`/g, '\\`')}\`)" class="btn" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-copy"></i> Copier tout
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccess('Copi√© dans le presse-papiers!');
            }).catch(() => {
                alert('Impossible de copier dans le presse-papiers');
            });
        }
        
        // Show all Twitter passwords
        function showAllTwitterPasswords() {
            const allAccounts = [];
            
            // Collecter depuis la nouvelle structure
            if (data.creators && data.creators.length > 0) {
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(account => {
                            allAccounts.push({
                                username: account.username,
                                password: account.password,
                                creatorName: creator.name,
                                gmail: account.gmailId ? data.gmailAccounts.find(g => g.id === account.gmailId)?.email : account.email || 'Aucun',
                                vaNames: creator.vaIds ? creator.vaIds.map(id => data.vas.find(v => v.id === id)?.name).filter(Boolean).join(', ') : 'Non assign√©'
                            });
                        });
                    }
                });
            }
            
            // Collecter depuis l'ancienne structure
            data.vas.forEach(va => {
                if (va.creators && va.creators.length > 0) {
                    va.creators.forEach(creator => {
                        if (creator.accounts && creator.accounts.length > 0) {
                            creator.accounts.forEach(account => {
                                // √âviter les doublons
                                const exists = allAccounts.some(a => 
                                    a.username === account.username && a.creatorName === creator.name
                                );
                                
                                if (!exists) {
                                    allAccounts.push({
                                        username: account.username,
                                        password: account.password,
                                        creatorName: creator.name,
                                        gmail: account.gmailId ? data.gmailAccounts.find(g => g.id === account.gmailId)?.email : account.email || 'Aucun',
                                        vaNames: va.name
                                    });
                                }
                            });
                        }
                    });
                }
            });
            
            if (allAccounts.length === 0) {
                alert('Aucun compte Twitter enregistr√©');
                return;
            }
            
            // Trier par username
            allAccounts.sort((a, b) => a.username.localeCompare(b.username));
            
            let passwordList = 'LISTE DES MOTS DE PASSE TWITTER\n' + '='.repeat(40) + '\n\n';
            
            allAccounts.forEach(account => {
                // Toujours essayer de d√©coder le mot de passe
                let decodedPassword;
                try {
                    decodedPassword = deobfuscatePassword(account.password);
                } catch (e) {
                    // Si le d√©codage √©choue, utiliser le mot de passe tel quel
                    decodedPassword = account.password;
                }
                
                passwordList += `Twitter: ${account.username}\n`;
                passwordList += `Mot de passe: ${decodedPassword}\n`;
                passwordList += `Cr√©atrice: ${account.creatorName}\n`;
                passwordList += `VA: ${account.vaNames}\n`;
                passwordList += `Gmail associ√©: ${account.gmail}\n`;
                passwordList += '-'.repeat(40) + '\n\n';
            });
            
            // Cr√©er une modal pour afficher les mots de passe
            const isDarkMode = document.body.classList.contains('dark-mode');
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; ${isDarkMode ? 'background: #1f2937; color: #f3f4f6;' : ''}">
                    <div class="modal-header" style="${isDarkMode ? 'border-bottom-color: #374151;' : ''}">
                        <h2 style="${isDarkMode ? 'color: #f9fafb;' : ''}">Tous les mots de passe Twitter</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="${isDarkMode ? 'color: #9ca3af;' : ''}">√ó</button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <pre style="background: ${isDarkMode ? '#111827' : '#f3f4f6'}; color: ${isDarkMode ? '#e5e7eb' : '#1f2937'}; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'};">${passwordList}</pre>
                    </div>
                    <div style="padding: 1rem; text-align: center; ${isDarkMode ? 'border-top: 1px solid #374151;' : ''}">
                        <button onclick="copyToClipboard(\`${passwordList.replace(/`/g, '\\`')}\`)" class="btn" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-copy"></i> Copier tout
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Platform switching function
        function switchPlatform(platform) {
            const buttons = document.querySelectorAll('.platform-btn');
            const twitterFields = document.getElementById('twitter-fields');
            const instagramFields = document.getElementById('instagram-fields');
            const accountsTitle = document.getElementById('accounts-list-title');
            const twitterList = document.getElementById('twitter-accounts-list');
            const instagramList = document.getElementById('instagram-accounts-list');
            const twitterPasswordBtn = document.getElementById('show-twitter-passwords-btn');
            const instagramPasswordBtn = document.getElementById('show-instagram-passwords-btn');
            const submitBtn = document.getElementById('add-account-btn');

            // Update button states
            buttons.forEach(btn => {
                if (btn.dataset.platform === platform) {
                    btn.classList.add('active');
                    if (platform === 'twitter') {
                        btn.style.background = '#1DA1F2';
                        btn.style.color = 'white';
                    } else {
                        btn.style.background = 'linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045)';
                        btn.style.color = 'white';
                    }
                } else {
                    btn.classList.remove('active');
                    btn.style.background = '#E4E7EB';
                    btn.style.color = '#4B5563';
                }
            });

            // Switch form fields
            if (platform === 'twitter') {
                twitterFields.style.display = 'block';
                instagramFields.style.display = 'none';
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter Compte Twitter';

                // Update list display
                accountsTitle.innerHTML = '<i class="fab fa-twitter" style="color: #1da1f2;"></i> Comptes Twitter Existants';
                twitterList.style.display = 'flex';
                instagramList.style.display = 'none';
                twitterPasswordBtn.style.display = 'block';
                instagramPasswordBtn.style.display = 'none';

                // Clear Instagram fields
                document.getElementById('instagram-username').value = '';
                document.getElementById('instagram-password').value = '';
                document.getElementById('instagram-username').removeAttribute('required');
                document.getElementById('instagram-password').removeAttribute('required');
                document.getElementById('twitter-username').setAttribute('required', 'required');
                document.getElementById('twitter-password').setAttribute('required', 'required');
            } else {
                twitterFields.style.display = 'none';
                instagramFields.style.display = 'block';
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Ajouter Compte Instagram';

                // Update list display
                accountsTitle.innerHTML = '<i class="fab fa-instagram" style="background: linear-gradient(135deg, #833AB4, #FD1D1D, #FCB045); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i> Comptes Instagram Existants';
                twitterList.style.display = 'none';
                instagramList.style.display = 'flex';
                twitterPasswordBtn.style.display = 'none';
                instagramPasswordBtn.style.display = 'block';

                // Clear Twitter fields
                document.getElementById('twitter-username').value = '';
                document.getElementById('twitter-password').value = '';
                document.getElementById('twitter-username').removeAttribute('required');
                document.getElementById('twitter-password').removeAttribute('required');
                document.getElementById('instagram-username').setAttribute('required', 'required');
                document.getElementById('instagram-password').setAttribute('required', 'required');
            }

            // Store current platform
            window.currentPlatform = platform;

            // Update the accounts list
            if (platform === 'instagram') {
                updateInstagramAccountsList();
            }
        }

        // Update Instagram accounts list
        function updateInstagramAccountsList() {
            const container = document.getElementById('instagram-accounts-list');
            if (!container) return;

            const isDarkMode = document.body.classList.contains('dark-mode');

            // Collecter tous les comptes Instagram
            const allInstagramAccounts = [];

            // 1. Comptes de data.instagramAccounts
            if (data.instagramAccounts) {
                data.instagramAccounts.forEach(account => {
                    allInstagramAccounts.push({
                        ...account,
                        creatorName: account.creatorId ?
                            data.creators.find(c => c.id === account.creatorId)?.name || 'Non assign√©' :
                            'Non assign√©',
                        vaName: account.vaId ?
                            data.vas.find(v => v.id === account.vaId)?.name || 'Non assign√©' :
                            'Non assign√©',
                        gmailEmail: account.gmailId ?
                            data.gmailAccounts.find(g => g.id === account.gmailId)?.email || 'Aucun' :
                            'Aucun'
                    });
                });
            }

            // 2. Comptes depuis les cr√©atrices (nouvelle structure)
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.instagramAccounts) {
                        creator.instagramAccounts.forEach(account => {
                            // V√©rifier qu'il n'est pas d√©j√† dans la liste
                            if (!allInstagramAccounts.find(a => a.username === account.username)) {
                                allInstagramAccounts.push({
                                    ...account,
                                    creatorName: creator.name,
                                    vaName: account.assignedVaId ?
                                        data.vas.find(v => v.id === account.assignedVaId)?.name || 'Non assign√©' :
                                        creator.vaIds && creator.vaIds.length > 0 ?
                                            creator.vaIds.map(id => data.vas.find(v => v.id === id)?.name).filter(n => n).join(', ') :
                                            'Non assign√©',
                                    gmailEmail: account.gmailId ?
                                        data.gmailAccounts.find(g => g.id === account.gmailId)?.email || 'Aucun' :
                                        'Aucun'
                                });
                            }
                        });
                    }
                });
            }

            if (allInstagramAccounts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: ${isDarkMode ? '#9ca3af' : '#6b7280'};">
                        <i class="fab fa-instagram" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Aucun compte Instagram</p>
                    </div>
                `;
                return;
            }

            // Afficher TOUS les comptes Instagram avec leurs associations (comme Twitter)
            container.innerHTML = allInstagramAccounts.map(account => {
                const creator = account.creatorName && account.creatorName !== 'Non assign√©' ?
                    data.creators.find(c => c.name === account.creatorName) : null;
                const gmail = account.gmailEmail && account.gmailEmail !== 'Aucun' ? account.gmailEmail : null;
                const va = account.vaName && account.vaName !== 'Non assign√©' ? account.vaName : null;

                return `
                <div style="
                    padding: 1rem;
                    background: ${isDarkMode ? 'rgba(193, 53, 132, 0.1)' : 'rgba(193, 53, 132, 0.05)'};
                    border: 1px solid ${isDarkMode ? 'rgba(193, 53, 132, 0.3)' : '#c13584'};
                    border-radius: 0.5rem;
                    margin-bottom: 0.75rem;
                    transition: all 0.2s;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong style="font-size: 1.1rem; color: ${isDarkMode ? '#e2e8f0' : '#1f2937'};">
                                ${account.username}
                                ${!gmail ? `
                                    <i class="fas fa-exclamation-triangle"
                                       style="color: #fbbf24; margin-left: 0.5rem; font-size: 0.9rem;"
                                       title="Pas de Gmail associ√©"></i>
                                ` : ''}
                            </strong>
                            <div style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'}; margin-top: 0.5rem;">
                                ${creator ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-user" style="width: 20px; color: #c13584;"></i> Cr√©atrice: <strong>${account.creatorName}</strong></div>` : ''}
                                ${gmail ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-envelope" style="width: 20px; color: #ea4335;"></i> Gmail: <strong>${gmail}</strong></div>` :
                                  creator ? `<div style="margin-bottom: 0.25rem; color: #ef4444;"><i class="fas fa-envelope" style="width: 20px; opacity: 0.5;"></i> <em>Aucun Gmail associ√©</em></div>` : ''}
                                ${va ? `<div style="margin-bottom: 0.25rem;"><i class="fas fa-user-tie" style="width: 20px; color: #667eea;"></i> VA: <strong>${va}</strong></div>` : ''}
                                ${!creator && !gmail && !va ? '<div style="color: #ef4444; font-style: italic;">Aucune association</div>' : ''}
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                                    Ajout√© le ${account.created ? new Date(account.created).toLocaleDateString('fr-FR') : 'Date inconnue'}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="action-btn" onclick="showInstagramPassword('${account.username}', '${account.password || ''}')"
                                    style="background: #c13584;" title="Voir le mot de passe">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="action-btn" onclick="deleteInstagramAccount('${account.id || account.username}')"
                                    style="background: #ef4444;" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Show Instagram password
        function showInstagramPassword(username, password) {
            const decodedPassword = deobfuscatePassword(password);
            alert(`Instagram: ${username}\nMot de passe: ${decodedPassword}`);
        }

        // Show all Instagram passwords
        function showAllInstagramPasswords() {
            const allAccounts = [];

            // Collecter depuis data.instagramAccounts
            if (data.instagramAccounts && data.instagramAccounts.length > 0) {
                data.instagramAccounts.forEach(account => {
                    allAccounts.push({
                        username: account.username,
                        password: account.password,
                        creatorName: account.creatorId ?
                            data.creators.find(c => c.id === account.creatorId)?.name || 'Non assign√©' :
                            'Non assign√©',
                        vaNames: account.vaId ?
                            data.vas.find(v => v.id === account.vaId)?.name || 'Non assign√©' :
                            'Non assign√©',
                        gmail: account.gmailId ?
                            data.gmailAccounts.find(g => g.id === account.gmailId)?.email || 'Aucun' :
                            'Aucun'
                    });
                });
            }

            // Collecter depuis les cr√©atrices
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.instagramAccounts) {
                        creator.instagramAccounts.forEach(account => {
                            if (!allAccounts.find(a => a.username === account.username)) {
                                allAccounts.push({
                                    username: account.username,
                                    password: account.password,
                                    creatorName: creator.name,
                                    vaNames: account.assignedVaId ?
                                        data.vas.find(v => v.id === account.assignedVaId)?.name :
                                        creator.vaIds?.map(id => data.vas.find(v => v.id === id)?.name).filter(n => n).join(', ') || 'Non assign√©',
                                    gmail: account.gmailId ?
                                        data.gmailAccounts.find(g => g.id === account.gmailId)?.email || 'Aucun' :
                                        'Aucun'
                                });
                            }
                        });
                    }
                });
            }

            if (allAccounts.length === 0) {
                alert('Aucun compte Instagram enregistr√©');
                return;
            }

            // Trier par username
            allAccounts.sort((a, b) => a.username.localeCompare(b.username));

            let passwordList = 'LISTE DES MOTS DE PASSE INSTAGRAM\n' + '='.repeat(40) + '\n\n';

            allAccounts.forEach(account => {
                let decodedPassword;
                try {
                    decodedPassword = deobfuscatePassword(account.password);
                } catch (e) {
                    decodedPassword = account.password;
                }

                passwordList += `Instagram: ${account.username}\n`;
                passwordList += `Mot de passe: ${decodedPassword}\n`;
                passwordList += `Cr√©atrice: ${account.creatorName}\n`;
                passwordList += `VA: ${account.vaNames}\n`;
                passwordList += `Gmail associ√©: ${account.gmail}\n`;
                passwordList += '-'.repeat(40) + '\n\n';
            });

            // Cr√©er une modal pour afficher les mots de passe
            const isDarkMode = document.body.classList.contains('dark-mode');
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; ${isDarkMode ? 'background: #1f2937; color: #f3f4f6;' : ''}">
                    <div class="modal-header" style="${isDarkMode ? 'border-bottom-color: #374151;' : ''}">
                        <h2 style="${isDarkMode ? 'color: #f9fafb;' : ''}">Tous les mots de passe Instagram</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()" style="${isDarkMode ? 'color: #9ca3af;' : ''}">√ó</button>
                    </div>
                    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
                        <pre style="background: ${isDarkMode ? '#111827' : '#f3f4f6'}; color: ${isDarkMode ? '#e5e7eb' : '#1f2937'}; padding: 1rem; border-radius: 0.5rem; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'};">${passwordList}</pre>
                    </div>
                    <div style="padding: 1rem; text-align: center; ${isDarkMode ? 'border-top: 1px solid #374151;' : ''}">
                        <button onclick="copyToClipboard(\`${passwordList.replace(/`/g, '\\`')}\`)" class="btn" style="background: #10b981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer;">
                            <i class="fas fa-copy"></i> Copier tout
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Delete Instagram account
        function deleteInstagramAccount(accountId) {
            if (!confirm('Voulez-vous vraiment supprimer ce compte Instagram?')) return;

            // Supprimer de data.instagramAccounts
            if (data.instagramAccounts) {
                data.instagramAccounts = data.instagramAccounts.filter(a => a.id !== accountId && a.username !== accountId);
            }

            // Supprimer des cr√©atrices
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.instagramAccounts) {
                        creator.instagramAccounts = creator.instagramAccounts.filter(a =>
                            a.id !== accountId && a.username !== accountId
                        );
                    }
                });
            }

            saveData();
            updateInstagramAccountsList();
            showSuccess('Compte Instagram supprim√©');
        }

        // Delete Instagram from creator (for VA cards)
        function deleteInstagramFromCreator(creatorId, username) {
            if (!confirm(`Voulez-vous vraiment supprimer le compte Instagram ${username}?`)) return;

            const creator = data.creators.find(c => c.id === creatorId);
            if (creator && creator.instagramAccounts) {
                creator.instagramAccounts = creator.instagramAccounts.filter(a =>
                    a.username !== username
                );
            }

            // Supprimer aussi de data.instagramAccounts
            if (data.instagramAccounts) {
                data.instagramAccounts = data.instagramAccounts.filter(a =>
                    a.username !== username
                );
            }

            saveData();
            updateDisplay();
            updateInstagramAccountsList();
            showSuccess('Compte Instagram supprim√©');
        }

        // Delete Gmail account
        function deleteGmailAccount(accountId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce compte Gmail ?')) {
                // Nettoyer les r√©f√©rences dans les comptes Twitter (bidirectionnel)
                const gmail = data.gmailAccounts.find(a => a.id === accountId);
                if (gmail && gmail.assignedTwitterUsername) {
                    // Chercher dans l'ancienne structure
                    data.vas.forEach(va => {
                        va.creators.forEach(creator => {
                            creator.accounts.forEach(account => {
                                if (account.gmailId === accountId) {
                                    delete account.gmailId;
                                    delete account.gmailAccount;
                                    delete account.email;
                                }
                            });
                        });
                    });
                    
                    // Chercher dans la nouvelle structure
                    data.creators.forEach(creator => {
                        if (creator.accounts) {
                            creator.accounts.forEach(account => {
                                if (account.gmailId === accountId) {
                                    delete account.gmailId;
                                    delete account.gmailAccount;
                                    delete account.email;
                                }
                            });
                        }
                    });
                }
                
                data.gmailAccounts = data.gmailAccounts.filter(a => a.id !== accountId);
                saveData();
                showSuccess('Compte Gmail supprim√©');
                updateGmailAccountsDisplay();
            }
        }
        
        
        // Update Twitter unassigned display
        function updateTwitterUnassignedDisplay() {
            const container = document.getElementById('twitter-unassigned-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            // D√©tecter le mode sombre
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Collecter tous les comptes Twitter sans Gmail
            const twitterAccountsWithoutGmail = [];
            
            // Utiliser la nouvelle structure data.creators
            if (data.creators && data.creators.length > 0) {
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.accounts.length > 0) {
                        creator.accounts.forEach(account => {
                            // V√©rifier si le compte a un Gmail de plusieurs fa√ßons
                            let hasGmail = false;
                            
                            // 1. V√©rifier gmailId
                            if (account.gmailId && account.gmailId !== '') {
                                hasGmail = true;
                            }
                            
                            // 2. V√©rifier via assignedTwitterUsername
                            if (!hasGmail) {
                                const gmailByUsername = data.gmailAccounts?.find(g => 
                                    g.assignedTwitterUsername && 
                                    g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                                );
                                if (gmailByUsername) {
                                    hasGmail = true;
                                }
                            }
                            
                            // Si pas de Gmail trouv√©
                            if (!hasGmail) {
                                // Trouver le VA associ√© √† cette cr√©atrice
                                let vaInfo = null;
                                if (creator.vaIds && creator.vaIds.length > 0) {
                                    const va = data.vas.find(v => creator.vaIds.includes(v.id));
                                    if (va) {
                                        vaInfo = va;
                                    }
                                }
                                
                                twitterAccountsWithoutGmail.push({
                                    account: account,
                                    creator: creator,
                                    va: vaInfo || { name: 'Non assign√©', color: '#6b7280' }
                                });
                            }
                        });
                    }
                });
            }
            
            // Aussi chercher dans l'ancienne structure au cas o√π
            data.vas.forEach(va => {
                if (va.creators && va.creators.length > 0) {
                    va.creators.forEach(creator => {
                        if (creator.accounts && creator.accounts.length > 0) {
                            creator.accounts.forEach(account => {
                                // V√©rifier si le compte a un Gmail de plusieurs fa√ßons
                                let hasGmail = false;
                                
                                // 1. V√©rifier gmailId
                                if (account.gmailId && account.gmailId !== '') {
                                    hasGmail = true;
                                }
                                
                                // 2. V√©rifier via assignedTwitterUsername
                                if (!hasGmail) {
                                    const gmailByUsername = data.gmailAccounts?.find(g => 
                                        g.assignedTwitterUsername && 
                                        g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                                    );
                                    if (gmailByUsername) {
                                        hasGmail = true;
                                    }
                                }
                                
                                if (!hasGmail) {
                                    // √âviter les doublons
                                    const exists = twitterAccountsWithoutGmail.some(t => 
                                        t.account.username === account.username && 
                                        t.creator.name === creator.name
                                    );
                                    
                                    if (!exists) {
                                        twitterAccountsWithoutGmail.push({
                                            account: account,
                                            creator: creator,
                                            va: va
                                        });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            if (twitterAccountsWithoutGmail.length === 0) {
                // V√©rifier s'il y a des comptes Twitter au total
                let totalTwitterAccounts = 0;
                data.creators?.forEach(creator => {
                    totalTwitterAccounts += (creator.accounts ? creator.accounts.length : 0);
                });
                
                if (totalTwitterAccounts === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: ${isDarkMode ? '#64748b' : '#94a3b8'};">
                            <i class="fab fa-twitter" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                            <p>Aucun compte Twitter dans le syst√®me</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">Ajoutez des comptes Twitter depuis la page "Ajouter Compte"</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: ${isDarkMode ? '#64748b' : '#94a3b8'};">
                            <i class="fas fa-check-circle" style="font-size: 3rem; color: #10b981; margin-bottom: 1rem; display: block;"></i>
                            <p>Tous les comptes Twitter ont un Gmail assign√© !</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Grouper par VA
            const groupedByVA = {};
            twitterAccountsWithoutGmail.forEach(({account, creator, va}) => {
                if (!groupedByVA[va.id]) {
                    groupedByVA[va.id] = {
                        va: va,
                        accounts: []
                    };
                }
                groupedByVA[va.id].accounts.push({account, creator});
            });
            
            // Afficher par VA
            Object.values(groupedByVA).forEach(({va, accounts}) => {
                const vaSection = document.createElement('div');
                vaSection.style.marginBottom = '2rem';
                
                vaSection.innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 1rem;">
                        <i class="fas fa-user"></i> ${va.name} (${accounts.length} comptes sans Gmail)
                    </h3>
                    <div style="display: grid; gap: 1rem;">
                        ${accounts.map(({account, creator}) => `
                            <div style="background: ${isDarkMode ? 'rgba(249, 158, 11, 0.1)' : '#fef3c7'}; 
                                        padding: 1rem; border-radius: 0.5rem; 
                                        border-left: 4px solid #f59e0b;
                                        display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <strong style="color: ${isDarkMode ? '#f3f4f6' : '#1e293b'};">
                                            <i class="fab fa-twitter" style="color: #1DA1F2;"></i> ${account.username}
                                        </strong>
                                        <span style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; 
                                                     background: ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : '#fee2e2'}; 
                                                     color: ${isDarkMode ? '#f87171' : '#991b1b'};">
                                            <i class="fas fa-exclamation-triangle"></i> Sans Gmail
                                        </span>
                                    </div>
                                    <p style="margin: 0; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">
                                        <i class="fas fa-star"></i> Cr√©atrice: ${creator.name}
                                    </p>
                                    ${account.email ? `
                                        <p style="margin: 0.25rem 0 0 0; color: ${isDarkMode ? '#64748b' : '#94a3b8'}; font-size: 0.75rem;">
                                            <i class="fas fa-envelope"></i> Email manuel: ${account.email}
                                        </p>
                                    ` : ''}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="action-btn" onclick="showAssignGmailToTwitterModal('${va.id}', '${creator.id}', '${account.username}')" 
                                            style="background: #10b981;" title="Assigner un Gmail">
                                        <i class="fas fa-envelope-plus"></i> Assigner Gmail
                                    </button>
                                    <button class="action-btn" onclick="editAccount('${va.id}', '${creator.id}', ${creator.accounts.indexOf(account)})" 
                                            style="background: #3b82f6;" title="Modifier le compte">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(vaSection);
            });
            
            // Ajouter des stats en haut
            const statsDiv = document.createElement('div');
            statsDiv.style.cssText = `
                background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : '#fee2e2'}; 
                padding: 1rem; 
                border-radius: 0.5rem; 
                margin-bottom: 2rem;
                text-align: center;
            `;
            statsDiv.innerHTML = `
                <h3 style="color: ${isDarkMode ? '#f87171' : '#dc2626'}; margin: 0;">
                    <i class="fas fa-exclamation-circle"></i> ${twitterAccountsWithoutGmail.length} comptes Twitter sans Gmail
                </h3>
            `;
            container.insertBefore(statsDiv, container.firstChild);
        }
        
        // Show assign Gmail to Twitter modal
        function showAssignGmailToTwitterModal(vaId, creatorId, twitterUsername) {
            const modal = document.getElementById('assign-gmail-twitter-modal');
            document.getElementById('assign-twitter-va-id').value = vaId;
            document.getElementById('assign-twitter-creator-id').value = creatorId;
            document.getElementById('assign-twitter-username').value = twitterUsername;
            document.getElementById('assign-twitter-display').textContent = twitterUsername;
            
            // R√©cup√©rer tous les comptes Gmail disponibles (non utilis√©s)
            const usedGmailIds = [];
            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        if (account.gmailId) {
                            usedGmailIds.push(account.gmailId);
                        }
                    });
                });
            });
            
            const availableGmails = data.gmailAccounts.filter(gmail => !usedGmailIds.includes(gmail.id));
            
            const gmailSelect = document.getElementById('assign-twitter-gmail-select');
            if (availableGmails.length === 0) {
                gmailSelect.innerHTML = '<option value="">-- Aucun Gmail disponible --</option>';
                gmailSelect.disabled = true;
            } else {
                gmailSelect.innerHTML = '<option value="">-- Choisir un Gmail --</option>' +
                    availableGmails.map(gmail => {
                        const label = gmail.vaId ? 
                            `${gmail.email} (VA: ${data.vas.find(v => v.id === gmail.vaId)?.name || 'Inconnu'})` : 
                            `${gmail.email} üî¥ (Non assign√©)`;
                        return `<option value="${gmail.id}">${label}</option>`;
                    }).join('');
                gmailSelect.disabled = false;
            }
            
            modal.classList.add('show');
        }
        
        // Assign Gmail to Twitter
        function assignGmailToTwitter(e) {
            e.preventDefault();
            
            const vaId = document.getElementById('assign-twitter-va-id').value;
            const creatorId = document.getElementById('assign-twitter-creator-id').value;
            const twitterUsername = document.getElementById('assign-twitter-username').value;
            const gmailId = document.getElementById('assign-twitter-gmail-select').value;
            
            if (!gmailId) {
                showError('Veuillez s√©lectionner un compte Gmail');
                return;
            }
            
            // Trouver le compte Twitter
            const va = data.vas.find(v => v.id === vaId);
            const creator = va?.creators.find(c => c.id === creatorId);
            const account = creator?.accounts.find(a => a.username === twitterUsername);
            
            if (account) {
                // Retirer l'ancien Gmail si n√©cessaire
                if (account.gmailId) {
                    const oldGmail = data.gmailAccounts.find(g => g.id === account.gmailId);
                    if (oldGmail) {
                        delete oldGmail.assignedTwitter;
                        delete oldGmail.assignedTwitterUsername;
                        delete oldGmail.assignedCreatorId;
                    }
                }
                
                // Assigner le Gmail au Twitter
                account.gmailId = gmailId;
                
                // R√©cup√©rer l'email du Gmail
                const gmail = data.gmailAccounts.find(g => g.id === gmailId);
                if (gmail) {
                    account.email = gmail.email;
                    
                    // Si le Gmail n'avait pas de VA, lui assigner le VA du Twitter
                    if (!gmail.vaId) {
                        gmail.vaId = vaId;
                    }
                    
                    // Assigner le Twitter au Gmail (bidirectionnel)
                    gmail.assignedTwitter = account.id || twitterUsername;
                    gmail.assignedTwitterUsername = twitterUsername;
                    gmail.assignedCreatorId = creatorId;
                }
                
                saveData();
                closeAssignGmailTwitterModal();
                showSuccess(`Gmail ${gmail.email} assign√© √† ${twitterUsername} !`);
                updateDisplay();
            }
        }
        
        // Close assign Gmail to Twitter modal
        function closeAssignGmailTwitterModal() {
            document.getElementById('assign-gmail-twitter-modal').classList.remove('show');
        }
        
        // Edit Twitter account
        function editAccount(vaId, creatorId, accountIndex) {
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            const creator = va.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const account = creator.accounts[accountIndex];
            if (!account) return;
            
            // Store the IDs for update
            document.getElementById('edit-account-va-id').value = vaId;
            document.getElementById('edit-account-creator-id').value = creatorId;
            document.getElementById('edit-account-index').value = accountIndex;
            
            // Fill the form
            document.getElementById('edit-username').value = account.username;
            document.getElementById('edit-password').value = '';
            
            // Show manual email field if no Gmail is associated
            const editManualEmailGroup = document.getElementById('edit-manual-email-group');
            const editEmailInput = document.getElementById('edit-email');
            
            if (!account.gmailId && account.email) {
                editManualEmailGroup.style.display = 'block';
                editEmailInput.value = account.email;
            } else {
                editManualEmailGroup.style.display = 'none';
                editEmailInput.value = '';
            }
            
            // Load Gmail accounts for this VA
            const vaGmailAccounts = data.gmailAccounts?.filter(acc => acc.vaId === vaId) || [];
            const usedGmailIds = [];
            
            // Get all used Gmail IDs except the current one
            data.vas.forEach(v => {
                v.creators.forEach(c => {
                    c.accounts.forEach((a, idx) => {
                        if (a.gmailId && !(v.id === vaId && c.id === creatorId && idx === accountIndex)) {
                            usedGmailIds.push(a.gmailId);
                        }
                    });
                });
            });
            
            // Available Gmail accounts = VA's Gmail accounts - used (except current)
            const availableGmailAccounts = vaGmailAccounts.filter(acc => 
                !usedGmailIds.includes(acc.id) || acc.id === account.gmailId
            );
            
            const gmailSelect = document.getElementById('edit-gmail-select');
            gmailSelect.innerHTML = '<option value="">-- Aucun compte Gmail --</option>';
            
            availableGmailAccounts.forEach(gmail => {
                const option = document.createElement('option');
                option.value = gmail.id;
                option.textContent = gmail.email;
                if (gmail.id === account.gmailId) {
                    option.selected = true;
                }
                gmailSelect.appendChild(option);
            });
            
            // Add event listener for Gmail select in edit modal
            gmailSelect.addEventListener('change', function() {
                const editManualEmailGroup = document.getElementById('edit-manual-email-group');
                if (this.value === '') {
                    editManualEmailGroup.style.display = 'block';
                } else {
                    editManualEmailGroup.style.display = 'none';
                    document.getElementById('edit-email').value = '';
                }
            });
            
            // Close the view modal and open edit modal
            closeModal();
            document.getElementById('edit-account-modal').classList.add('show');
        }
        
        // Update Twitter account
        function updateAccount(e) {
            e.preventDefault();
            
            const vaId = document.getElementById('edit-account-va-id').value;
            const creatorId = document.getElementById('edit-account-creator-id').value;
            const accountIndex = parseInt(document.getElementById('edit-account-index').value);
            const gmailId = document.getElementById('edit-gmail-select').value;
            const username = document.getElementById('edit-username').value.trim();
            const password = document.getElementById('edit-password').value.trim();
            const manualEmail = document.getElementById('edit-email').value.trim();
            
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            const creator = va.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const account = creator.accounts[accountIndex];
            if (!account) return;
            
            // Update account
            account.username = username.startsWith('@') ? username : '@' + username;
            account.gmailId = gmailId || null;
            
            // Update email based on Gmail selection or manual input
            if (gmailId) {
                const gmailAccount = data.gmailAccounts?.find(g => g.id === gmailId);
                if (gmailAccount) {
                    account.email = gmailAccount.email;
                }
            } else {
                account.email = manualEmail;
            }
            
            // Only update password if provided
            if (password) {
                account.password = password;
            }
            
            saveData();
            closeEditModal();
            showSuccess('Compte Twitter mis √† jour');
            updateVAGrid();
            updateGmailAccountsDisplay();
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-account-modal').classList.remove('show');
        }
        
        // Delete Twitter account
        function deleteAccount(vaId, creatorId, accountIndex) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce compte Twitter ?')) {
                const va = data.vas.find(v => v.id === vaId);
                if (!va) return;
                
                const creator = va.creators.find(c => c.id === creatorId);
                if (!creator) return;
                
                // Obtenir l'account avant de le supprimer pour nettoyer les r√©f√©rences
                const account = creator.accounts[accountIndex];
                if (account && account.gmailId) {
                    // Nettoyer la r√©f√©rence bidirectionnelle dans le Gmail
                    const gmail = data.gmailAccounts.find(g => g.id === account.gmailId);
                    if (gmail) {
                        delete gmail.assignedTwitter;
                        delete gmail.assignedTwitterUsername;
                        delete gmail.assignedCreatorId;
                    }
                }
                
                creator.accounts.splice(accountIndex, 1);
                saveData();
                closeModal();
                showSuccess('Compte Twitter supprim√©');
                updateVAGrid();
                updateGmailAccountsDisplay();
            }
        }

        // View creator details
        function viewCreator(vaId, creatorId) {
            // Utiliser la nouvelle structure
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            // Trouver le VA si sp√©cifi√©
            let vaName = 'Non assign√©';
            if (vaId) {
                const va = data.vas.find(v => v.id === vaId);
                if (va) vaName = va.name;
            }

            // Filtrer les comptes pour ce VA sp√©cifique
            const filteredAccounts = creator.accounts ? creator.accounts.filter(account => {
                // Si la cr√©atrice n'a qu'un seul VA, afficher tous ses comptes
                if (creator.vaIds && creator.vaIds.length === 1) {
                    return true;
                }
                // Si la cr√©atrice a plusieurs VAs, n'afficher que les comptes assign√©s √† CE VA
                return account.assignedVaId === vaId;
            }) : [];
            
            let content = `
                <h4>üë§ VA: ${vaName}</h4>
                <h4>‚≠ê Cr√©atrice: ${creator.name}</h4>
                <h4 style="margin-top: 1rem;">Comptes Twitter (${filteredAccounts.length}):</h4>
            `;

            if (filteredAccounts.length > 0) {
                filteredAccounts.forEach((account) => {
                    // Trouver l'index r√©el dans la liste compl√®te pour les actions
                    const realIndex = creator.accounts.findIndex(acc => acc === account);
                    const gmailAccount = data.gmailAccounts?.find(g => g.id === account.gmailId);
                    content += `
                        <div style="background: #f8fafc; padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem;">
                            <p><strong>Username:</strong> ${account.username}</p>
                            <p><strong>Mot de passe:</strong> ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
                            <p><strong>Gmail associ√©:</strong> ${gmailAccount ? gmailAccount.email : 'Non d√©fini'}</p>
                            <p><strong>Cr√©√© le:</strong> ${account.created || '-'}</p>
                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${vaId && creator.vaIds && creator.vaIds.length > 1 ? `
                                    <button class="action-btn" onclick="closeModal(); removeAccountFromVA('${vaId}', '${creatorId}', '${account.username}')" 
                                            style="background: #f59e0b;" title="Retirer de ce VA">
                                        <i class="fas fa-unlink"></i> Retirer
                                    </button>
                                ` : ''}
                                ${vaId ? `
                                    <button class="action-btn" onclick="closeModal(); showTransferAccountModal('${vaId}', '${creatorId}', '${account.username}')" 
                                            style="background: #8b5cf6;" title="Transf√©rer vers un autre VA">
                                        <i class="fas fa-exchange-alt"></i> Transf√©rer
                                    </button>
                                ` : ''}
                                <button class="action-btn" onclick="editAccount('${creatorId}', ${realIndex})" style="background: #3b82f6;">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteAccount('${creatorId}', ${realIndex})">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        </div>
                    `;
                });
            } else {
                content += `<p style="color: #6b7280; padding: 1rem; text-align: center;">
                    ${creator.accounts && creator.accounts.length > 0 ? 
                        'Aucun compte assign√© sp√©cifiquement √† ce VA. Les comptes de cette cr√©atrice sont sur d\'autres VAs.' : 
                        'Aucun compte Twitter'
                    }
                </p>`;
            }

            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('password-modal').classList.add('show');
        }

        // Close modal
        function closeModal() {
            document.getElementById('password-modal').classList.remove('show');
        }
        
        // Close Assign Gmail Modal
        function closeAssignGmailModal() {
            document.getElementById('assign-gmail-modal').classList.remove('show');
        }
        
        // Show Assign Gmail Modal
        function showAssignGmailModal(gmailId) {
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (!gmail) return;
            
            document.getElementById('assign-gmail-id').value = gmailId;
            document.getElementById('assign-gmail-email').textContent = gmail.email;
            
            // Update VA select
            const select = document.getElementById('assign-gmail-va-select');
            select.innerHTML = '<option value="">-- Choisir un VA --</option>' +
                data.vas.map(va => `<option value="${va.id}">${va.name}</option>`).join('');
            
            document.getElementById('assign-gmail-modal').classList.add('show');
        }
        
        // Assign Gmail to VA
        function assignGmailToVA(e) {
            e.preventDefault();
            
            const gmailId = document.getElementById('assign-gmail-id').value;
            const vaId = document.getElementById('assign-gmail-va-select').value;
            
            if (!vaId) {
                showError('Veuillez s√©lectionner un VA');
                return;
            }
            
            // Find the Gmail account
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            if (gmail) {
                gmail.vaId = vaId;
                markDataModified();
                saveData();
                
                showSuccess('Gmail assign√© au VA avec succ√®s');
                closeAssignGmailModal();
                updateGmailAccountsList();
            }
        }
        
        // Remove account from VA
        function removeAccountFromVA(vaId, creatorId, accountUsername) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator || !creator.vaIds || creator.vaIds.length <= 1) return;
            
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            // Si la cr√©atrice a plusieurs comptes, demander lequel retirer
            if (creator.accounts && creator.accounts.length > 1) {
                showRemoveAccountModal(vaId, creatorId);
            } else {
                // Si un seul compte, retirer toute la cr√©atrice
                if (confirm(`Retirer ${creator.name} (${accountUsername}) du VA "${va.name}" ?`)) {
                    const vaIndex = creator.vaIds.indexOf(vaId);
                    if (vaIndex > -1) {
                        creator.vaIds.splice(vaIndex, 1);
                        saveData();
                        updateDisplay();
                        showSuccess(`${creator.name} retir√©e de ${va.name}`);
                    }
                }
            }
        }
        
        // Show modal to select which account to remove
        function showRemoveAccountModal(vaId, creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            const va = data.vas.find(v => v.id === vaId);
            if (!creator || !va) return;
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            let modalContent = `
                <h3 style="margin-bottom: 1rem; color: ${isDarkMode ? '#f9fafb' : '#1f2937'};">
                    Retirer un compte de ${va.name}
                </h3>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                    Quel compte de ${creator.name} voulez-vous retirer ?
                </p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${creator.accounts.map((account, index) => `
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; 
                                     background: ${isDarkMode ? '#374151' : '#f3f4f6'}; 
                                     border-radius: 0.5rem; cursor: pointer;
                                     border: 2px solid transparent;"
                               onmouseover="this.style.borderColor='#f59e0b'"
                               onmouseout="this.style.borderColor='transparent'">
                            <input type="radio" name="accountToRemove" value="${index}" style="cursor: pointer;">
                            <span>
                                <i class="fab fa-twitter" style="color: #1da1f2;"></i> ${account.username}
                            </span>
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                    <button onclick="confirmRemoveSpecificAccount('${vaId}', '${creatorId}')" class="submit-btn" style="background: #f59e0b;">
                        <i class="fas fa-unlink"></i> Retirer
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Confirm remove specific account
        function confirmRemoveSpecificAccount(vaId, creatorId) {
            const selectedAccount = document.querySelector('input[name="accountToRemove"]:checked');
            if (!selectedAccount) {
                showError('Veuillez s√©lectionner un compte √† retirer');
                return;
            }
            
            const accountIndex = parseInt(selectedAccount.value);
            const creator = data.creators.find(c => c.id === creatorId);
            const va = data.vas.find(v => v.id === vaId);
            
            if (!creator || !va || !creator.accounts[accountIndex]) return;
            
            const accountToRemove = creator.accounts[accountIndex];
            
            // IMPORTANT: Ne pas supprimer le compte, juste le d√©sassigner du VA
            // Retirer le VA de la liste des VAs de la cr√©atrice
            const vaIndex = creator.vaIds.indexOf(vaId);
            if (vaIndex > -1) {
                creator.vaIds.splice(vaIndex, 1);
            }
            
            // Si la cr√©atrice n'a qu'un seul compte
            if (creator.accounts.length === 1) {
                showSuccess(`${creator.name} (@${accountToRemove.username}) retir√© de ${va.name} - Compte maintenant non assign√©`);
            } else {
                // Si la cr√©atrice a plusieurs comptes, on doit cr√©er une copie s√©par√©e
                // pour les autres comptes qui restent avec le VA
                const accountsToKeepWithVA = creator.accounts.filter((_, idx) => idx !== accountIndex);
                const accountToMakeUnassigned = creator.accounts[accountIndex];
                
                // Cr√©er une nouvelle cr√©atrice pour le compte √† d√©sassigner
                const newCreatorForUnassigned = {
                    id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: creator.name,
                    vaIds: [], // Pas de VA assign√©
                    accounts: [accountToMakeUnassigned]
                };
                
                // Mettre √† jour la cr√©atrice existante avec les comptes restants
                creator.accounts = accountsToKeepWithVA;
                
                // Si plus aucun compte ne reste avec ce VA apr√®s, retirer le VA
                if (creator.accounts.length === 0) {
                    const idx = creator.vaIds.indexOf(vaId);
                    if (idx > -1) {
                        creator.vaIds.splice(idx, 1);
                    }
                }
                
                // Ajouter la nouvelle cr√©atrice non assign√©e
                data.creators.push(newCreatorForUnassigned);
                
                showSuccess(`@${accountToMakeUnassigned.username} retir√© de ${va.name} - Compte maintenant disponible dans "Comptes Twitter Existants"`);
            }
            
            saveData();
            closeModal();
            updateDisplay();
        }
        
        // Unassign Twitter account from creator
        function unassignTwitterAccount(creatorId, accountIndex) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator || !creator.accounts || !creator.accounts[accountIndex]) {
                console.error('Compte non trouv√©');
                return;
            }
            
            const account = creator.accounts[accountIndex];
            
            // Confirmer l'action
            if (!confirm(`Voulez-vous retirer le compte ${account.username} ?\n\nIl sera retir√© de ${creator.name} et du VA.\nLe compte restera disponible pour √™tre r√©assign√©.`)) {
                return;
            }
            
            // Retirer de la cr√©atrice
            creator.accounts.splice(accountIndex, 1);
            
            // Retirer la cr√©atrice du VA si elle n'a plus de comptes
            if (creator.accounts.length === 0 && creator.vaIds) {
                creator.vaIds = [];
            }
            
            // Ajouter aux comptes Twitter non assign√©s s'il n'y est pas d√©j√†
            const existsInTwitterAccounts = data.twitterAccounts.some(ta => 
                ta.username.toLowerCase() === account.username.toLowerCase()
            );
            
            if (!existsInTwitterAccounts) {
                data.twitterAccounts.push({
                    id: 'tw_' + Date.now(),
                    username: account.username,
                    password: account.password,
                    creatorId: null,
                    gmailId: null,
                    vaId: null,
                    created: new Date().toISOString()
                });
            } else {
                // Si le compte existe d√©j√†, mettre √† jour ses associations
                const twitterAccount = data.twitterAccounts.find(ta => 
                    ta.username.toLowerCase() === account.username.toLowerCase()
                );
                if (twitterAccount) {
                    twitterAccount.creatorId = null;
                    twitterAccount.gmailId = null;
                    twitterAccount.vaId = null;
                }
            }
            
            // D√©sassigner aussi le Gmail si n√©cessaire
            const gmailWithThisTwitter = data.gmailAccounts.find(g => 
                g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
            );
            if (gmailWithThisTwitter) {
                gmailWithThisTwitter.assignedTwitterUsername = null;
                gmailWithThisTwitter.vaId = null;
            }
            
            // Si la cr√©atrice n'a plus de comptes et n'est associ√©e √† aucun VA, proposer de la supprimer
            if (creator.accounts.length === 0 && (!creator.vaIds || creator.vaIds.length === 0)) {
                if (confirm(`${creator.name} n'a plus aucun compte. Voulez-vous supprimer la cr√©atrice ?`)) {
                    data.creators = data.creators.filter(c => c.id !== creatorId);
                }
            }
            
            // Sauvegarder et mettre √† jour
            saveData();
            updateDisplay();
            updateTwitterAccountsList();
            showSuccess(`Compte ${account.username} retir√© de ${creator.name} - Maintenant disponible dans "Ajouter Compte"`);
        }
        
        // Show reassign modal
        function showReassignModal(accountId) {
            const account = data.twitterAccounts.find(a => a.id === accountId);
            if (!account) return;
            
            // Remplir le formulaire
            document.getElementById('reassign-account-id').value = accountId;
            document.getElementById('reassign-username').value = account.username;
            
            // Remplir les selects
            const creatorSelect = document.getElementById('reassign-creator');
            const gmailSelect = document.getElementById('reassign-gmail');
            const vaSelect = document.getElementById('reassign-va');
            
            // Cr√©atrices
            creatorSelect.innerHTML = '<option value="">S√©lectionner une cr√©atrice</option>';
            data.creators.forEach(creator => {
                const option = document.createElement('option');
                option.value = creator.id;
                option.textContent = creator.name;
                creatorSelect.appendChild(option);
            });
            
            // Afficher TOUS les Gmail
            gmailSelect.innerHTML = '<option value="">S√©lectionner un compte Gmail</option>';
            data.gmailAccounts.forEach(gmail => {
                const option = document.createElement('option');
                option.value = gmail.id;
                option.textContent = gmail.email;
                // Ajouter une indication si d√©j√† assign√©
                if (gmail.assignedTwitterUsername) {
                    option.textContent += ` (assign√© √† ${gmail.assignedTwitterUsername})`;
                }
                gmailSelect.appendChild(option);
            });
            
            // VAs
            vaSelect.innerHTML = '<option value="">S√©lectionner un VA</option>';
            data.vas.forEach(va => {
                const option = document.createElement('option');
                option.value = va.id;
                option.textContent = va.name;
                vaSelect.appendChild(option);
            });
            
            // Afficher la modal
            document.getElementById('reassign-modal').classList.add('show');
        }
        
        // Reassign Twitter account
        function reassignTwitterAccount(e) {
            e.preventDefault();
            
            const accountId = document.getElementById('reassign-account-id').value;
            const creatorId = document.getElementById('reassign-creator').value;
            const gmailId = document.getElementById('reassign-gmail').value;
            const vaId = document.getElementById('reassign-va').value;
            
            const account = data.twitterAccounts.find(a => a.id === accountId);
            const creator = data.creators.find(c => c.id === creatorId);
            const gmail = data.gmailAccounts.find(g => g.id === gmailId);
            const va = data.vas.find(v => v.id === vaId);
            
            if (!account || !creator || !gmail || !va) {
                showError('Veuillez s√©lectionner tous les √©l√©ments');
                return;
            }
            
            // Ajouter le compte √† la cr√©atrice
            if (!creator.accounts) creator.accounts = [];
            creator.accounts.push({
                username: account.username,
                password: account.password
            });
            
            // Lier la cr√©atrice au VA
            if (!creator.vaIds) creator.vaIds = [];
            if (!creator.vaIds.includes(vaId)) {
                creator.vaIds.push(vaId);
            }
            
            // Assigner le Gmail au compte Twitter et au VA
            gmail.assignedTwitterUsername = account.username;
            gmail.vaId = vaId;
            
            // Mettre √† jour le compte Twitter
            account.creatorId = creatorId;
            account.gmailId = gmailId;
            account.vaId = vaId;
            
            // Sauvegarder et fermer
            saveData();
            closeModal();
            updateDisplay();
            updateTwitterAccountsList();
            
            showSuccess(`${account.username} r√©assign√© √† ${creator.name} avec ${gmail.email} sur le VA ${va.name}`);
        }
        
        // Delete Twitter account permanently
        function deleteTwitterAccount(accountId) {
            const account = data.twitterAccounts.find(a => a.id === accountId);
            if (!account) return;
            
            if (confirm(`Voulez-vous vraiment supprimer d√©finitivement le compte ${account.username} ?\n\nCette action est irr√©versible.`)) {
                data.twitterAccounts = data.twitterAccounts.filter(a => a.id !== accountId);
                saveData();
                updateTwitterAccountsList();
                showSuccess(`Compte ${account.username} supprim√© d√©finitivement`);
            }
        }
        
        // Analyze Twitter accounts before migration
        function analyzeTwitterAccounts() {
            console.log('üîç ANALYSE DES COMPTES TWITTER');
            console.log('================================');
            
            const accountsInCreators = [];
            const accountsInSimple = [];
            
            // 1. Collecter les comptes des cr√©atrices
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        creator.accounts.forEach(account => {
                            accountsInCreators.push({
                                username: account.username,
                                password: account.password,
                                creator: creator.name,
                                creatorId: creator.id,
                                vaIds: creator.vaIds || []
                            });
                        });
                    }
                });
            }
            
            // 2. Collecter les comptes simples
            if (data.twitterAccounts) {
                data.twitterAccounts.forEach(account => {
                    accountsInSimple.push({
                        username: account.username,
                        id: account.id,
                        creatorId: account.creatorId,
                        gmailId: account.gmailId,
                        vaId: account.vaId
                    });
                });
            }
            
            console.log(`\nüìÅ Comptes dans les CR√âATRICES: ${accountsInCreators.length}`);
            accountsInCreators.forEach(acc => {
                const gmail = data.gmailAccounts.find(g => 
                    g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === acc.username.toLowerCase()
                );
                console.log(`  - ${acc.username} (Cr√©atrice: ${acc.creator}, Gmail: ${gmail ? gmail.email : 'Aucun'})`);
            });
            
            console.log(`\nüì± Comptes SIMPLES: ${accountsInSimple.length}`);
            accountsInSimple.forEach(acc => {
                const creator = acc.creatorId ? data.creators.find(c => c.id === acc.creatorId) : null;
                const gmail = acc.gmailId ? data.gmailAccounts.find(g => g.id === acc.gmailId) : null;
                console.log(`  - ${acc.username} (ID: ${acc.id}, Cr√©atrice: ${creator ? creator.name : 'Aucune'}, Gmail: ${gmail ? gmail.email : 'Aucun'})`);
            });
            
            // 3. Trouver les doublons
            const duplicates = [];
            accountsInCreators.forEach(creatorAcc => {
                const simpleAcc = accountsInSimple.find(sa => 
                    sa.username.toLowerCase() === creatorAcc.username.toLowerCase()
                );
                if (simpleAcc) {
                    duplicates.push(creatorAcc.username);
                }
            });
            
            if (duplicates.length > 0) {
                console.log(`\n‚ö†Ô∏è DOUBLONS trouv√©s: ${duplicates.length}`);
                duplicates.forEach(dup => console.log(`  - ${dup}`));
            }
            
            // 4. Comptes uniques dans les cr√©atrices (√† migrer)
            const uniqueInCreators = accountsInCreators.filter(acc => 
                !accountsInSimple.some(sa => sa.username.toLowerCase() === acc.username.toLowerCase())
            );
            
            console.log(`\n‚ú® Comptes UNIQUES dans les cr√©atrices (√† migrer): ${uniqueInCreators.length}`);
            uniqueInCreators.forEach(acc => console.log(`  - ${acc.username}`));
            
            console.log('\nüìä R√âSUM√â:');
            console.log(`  - Total unique: ${accountsInSimple.length + uniqueInCreators.length}`);
            console.log(`  - √Ä migrer: ${uniqueInCreators.length}`);
            console.log(`  - Doublons: ${duplicates.length}`);
            
            return {
                inCreators: accountsInCreators,
                inSimple: accountsInSimple,
                duplicates: duplicates,
                toMigrate: uniqueInCreators
            };
        }
        
        // Migrate all Twitter accounts to simple system
        function migrateTwitterAccountsToSimple() {
            const analysis = analyzeTwitterAccounts();
            
            if (analysis.toMigrate.length === 0) {
                console.log('‚úÖ Aucun compte √† migrer !');
                return;
            }
            
            console.log('\nüöÄ D√âBUT DE LA MIGRATION...');
            let migrated = 0;
            
            analysis.toMigrate.forEach(account => {
                // Trouver le Gmail associ√©
                const gmail = data.gmailAccounts.find(g => 
                    g.assignedTwitterUsername && g.assignedTwitterUsername.toLowerCase() === account.username.toLowerCase()
                );
                
                // Cr√©er le compte simple
                const newAccount = {
                    id: 'tw_migrated_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    username: account.username,
                    password: account.password,
                    creatorId: account.creatorId,
                    gmailId: gmail ? gmail.id : null,
                    vaId: account.vaIds && account.vaIds.length > 0 ? account.vaIds[0] : null,
                    created: new Date().toISOString(),
                    migratedFrom: 'creator'
                };
                
                data.twitterAccounts.push(newAccount);
                migrated++;
                console.log(`  ‚úÖ Migr√©: ${account.username}`);
            });
            
            console.log(`\n‚úÖ MIGRATION TERMIN√âE: ${migrated} comptes migr√©s`);
            console.log('\nüßπ Nettoyage des comptes dans les cr√©atrices...');
            
            // Supprimer les comptes des cr√©atrices
            if (data.creators) {
                data.creators.forEach(creator => {
                    if (creator.accounts) {
                        creator.accounts = [];
                        console.log(`  üóëÔ∏è Comptes supprim√©s de: ${creator.name}`);
                    }
                });
            }
            
            // Sauvegarder
            saveData();
            updateDisplay();
            updateTwitterAccountsList();
            
            console.log('\nüéâ TERMIN√â ! Tous les comptes sont maintenant dans le syst√®me simple.');
            
            // Nouvelle analyse pour v√©rifier
            console.log('\nüìä V√âRIFICATION APR√àS MIGRATION:');
            const afterAnalysis = analyzeTwitterAccounts();
            
            return {
                migrated: migrated,
                beforeTotal: analysis.inCreators.length + analysis.inSimple.length,
                afterTotal: afterAnalysis.inSimple.length
            };
        }
        
        // Analyze specific Gmail account
        function analyzeGmailAccount(email) {
            console.log(`\nüîç ANALYSE DU COMPTE GMAIL: ${email}`);
            console.log('================================');
            
            const gmail = data.gmailAccounts.find(g => g.email.toLowerCase() === email.toLowerCase());
            
            if (!gmail) {
                console.log('‚ùå Compte Gmail non trouv√© !');
                return;
            }
            
            console.log('\nüìß Informations du compte Gmail:');
            console.log(`  - ID: ${gmail.id}`);
            console.log(`  - Email: ${gmail.email}`);
            console.log(`  - Mot de passe: ${gmail.password ? '[masqu√©]' : 'Aucun'}`);
            console.log(`  - Twitter assign√©: ${gmail.assignedTwitterUsername || 'Aucun'}`);
            console.log(`  - VA ID: ${gmail.vaId || 'Aucun'}`);
            
            if (gmail.vaId) {
                const va = data.vas.find(v => v.id === gmail.vaId);
                console.log(`  - VA Nom: ${va ? va.name : 'VA non trouv√©!'}`);
            }
            
            // V√©rifier si le compte Twitter existe
            if (gmail.assignedTwitterUsername) {
                console.log(`\nüê¶ Recherche du compte Twitter "${gmail.assignedTwitterUsername}"...`);
                
                // Dans les comptes simples
                const simpleTwitter = data.twitterAccounts.find(t => 
                    t.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase()
                );
                
                if (simpleTwitter) {
                    console.log('  ‚úÖ Trouv√© dans les comptes simples');
                    console.log(`     - ID: ${simpleTwitter.id}`);
                    console.log(`     - Cr√©atrice ID: ${simpleTwitter.creatorId || 'Aucune'}`);
                } else {
                    console.log('  ‚ùå PAS trouv√© dans les comptes simples !');
                }
                
                // Dans les cr√©atrices (ancien syst√®me)
                let foundInCreator = false;
                data.creators.forEach(creator => {
                    if (creator.accounts && creator.accounts.length > 0) {
                        const account = creator.accounts.find(a => 
                            a.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase()
                        );
                        if (account) {
                            foundInCreator = true;
                            console.log(`  ‚ö†Ô∏è Trouv√© dans la cr√©atrice "${creator.name}" (ancien syst√®me)`);
                        }
                    }
                });
                
                if (!simpleTwitter && !foundInCreator) {
                    console.log('\n‚ö° PROBL√àME: Ce compte Twitter est assign√© au Gmail mais n\'existe nulle part !');
                    console.log('  ‚Üí C\'est une r√©f√©rence fant√¥me qui doit √™tre nettoy√©e');
                }
            }
            
            console.log('\nüìä R√©sum√©:');
            if (gmail.assignedTwitterUsername && !data.twitterAccounts.find(t => t.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase())) {
                console.log('  ‚ö†Ô∏è R√âF√âRENCE FANT√îME d√©tect√©e !');
                console.log('  ‚Üí Le Gmail r√©f√©rence un compte Twitter qui n\'existe pas');
                console.log('  ‚Üí Solution: D√©sassigner ce compte fant√¥me');
            } else {
                console.log('  ‚úÖ Associations correctes');
            }
            
            return gmail;
        }
        
        // Clean ghost reference for Gmail account
        function cleanGhostReference(email) {
            console.log(`\nüßπ NETTOYAGE DE LA R√âF√âRENCE FANT√îME POUR: ${email}`);
            console.log('==========================================');
            
            const gmail = data.gmailAccounts.find(g => g.email.toLowerCase() === email.toLowerCase());
            
            if (!gmail) {
                console.log('‚ùå Compte Gmail non trouv√© !');
                return false;
            }
            
            if (!gmail.assignedTwitterUsername) {
                console.log('‚ÑπÔ∏è Ce compte Gmail n\'a pas de Twitter assign√©');
                return false;
            }
            
            console.log(`\nüìß Compte trouv√©:`);
            console.log(`  - Email: ${gmail.email}`);
            console.log(`  - Twitter assign√© (fant√¥me): ${gmail.assignedTwitterUsername}`);
            console.log(`  - VA: ${gmail.vaId || 'Aucun'}`);
            
            // V√©rifier si le compte Twitter existe vraiment
            const twitterExists = data.twitterAccounts.find(t => 
                t.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase()
            );
            
            if (twitterExists) {
                console.log('\n‚ö†Ô∏è Le compte Twitter existe ! Pas une r√©f√©rence fant√¥me.');
                return false;
            }
            
            // Nettoyer la r√©f√©rence fant√¥me
            console.log('\nüóëÔ∏è Suppression de la r√©f√©rence fant√¥me...');
            gmail.assignedTwitterUsername = null;
            
            // Si le Gmail n'a plus de Twitter assign√© et pas de VA, on peut le consid√©rer comme non assign√©
            if (!gmail.vaId) {
                console.log('  ‚Üí Gmail maintenant compl√®tement non assign√©');
            }
            
            saveData();
            updateDisplay();
            updateGmailAccountsList();
            
            console.log('\n‚úÖ R√©f√©rence fant√¥me nettoy√©e !');
            console.log('  ‚Üí Le compte Gmail n\'est plus li√© au Twitter inexistant');
            
            return true;
        }
        
        // Clean all ghost references
        function cleanAllGhostReferences() {
            console.log('\nüßπ NETTOYAGE DE TOUTES LES R√âF√âRENCES FANT√îMES');
            console.log('==============================================');
            
            let cleaned = 0;
            
            data.gmailAccounts.forEach(gmail => {
                if (gmail.assignedTwitterUsername) {
                    // V√©rifier si le compte Twitter existe
                    const twitterExists = data.twitterAccounts.find(t => 
                        t.username.toLowerCase() === gmail.assignedTwitterUsername.toLowerCase()
                    );
                    
                    if (!twitterExists) {
                        console.log(`\n‚ùå R√©f√©rence fant√¥me trouv√©e:`);
                        console.log(`  - Gmail: ${gmail.email}`);
                        console.log(`  - Twitter fant√¥me: ${gmail.assignedTwitterUsername}`);
                        
                        // Nettoyer
                        gmail.assignedTwitterUsername = null;
                        cleaned++;
                        
                        console.log(`  ‚úÖ Nettoy√© !`);
                    }
                }
            });
            
            if (cleaned > 0) {
                saveData();
                updateDisplay();
                updateGmailAccountsList();
                console.log(`\nüéâ TERMIN√â ! ${cleaned} r√©f√©rence(s) fant√¥me(s) nettoy√©e(s)`);
            } else {
                console.log('\n‚úÖ Aucune r√©f√©rence fant√¥me trouv√©e');
            }
            
            return cleaned;
        }
        
        // Check for shared references between creators
        function checkSharedReferences() {
            console.log('\nüîç V√©rification des r√©f√©rences partag√©es entre cr√©atrices');
            console.log('================================================');
            
            const accountRefs = new Map();
            
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        if (!accountRefs.has(account)) {
                            accountRefs.set(account, []);
                        }
                        accountRefs.get(account).push(creator);
                    });
                }
            });
            
            let sharedFound = false;
            accountRefs.forEach((creators, account) => {
                if (creators.length > 1) {
                    sharedFound = true;
                    console.log(`\n‚ö†Ô∏è R√âF√âRENCE PARTAG√âE D√âTECT√âE!`);
                    console.log(`  Compte: ${account.username} (ID: ${account.id})`);
                    console.log(`  Partag√© entre:`);
                    creators.forEach(creator => {
                        console.log(`    - ${creator.name} (ID: ${creator.id})`);
                    });
                }
            });
            
            if (!sharedFound) {
                console.log('‚úÖ Aucune r√©f√©rence partag√©e trouv√©e');
            }
            
            return sharedFound;
        }
        
        // Fix shared references by creating copies
        function fixSharedReferences() {
            console.log('\nüîß Correction des r√©f√©rences partag√©es...');
            
            const accountRefs = new Map();
            
            // Identifier les r√©f√©rences partag√©es
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach((account, index) => {
                        if (!accountRefs.has(account)) {
                            accountRefs.set(account, []);
                        }
                        accountRefs.get(account).push({creator, index});
                    });
                }
            });
            
            let fixed = 0;
            accountRefs.forEach((refs, account) => {
                if (refs.length > 1) {
                    console.log(`\nüìå Correction pour ${account.username}...`);
                    
                    // Garder la premi√®re r√©f√©rence, copier pour les autres
                    refs.slice(1).forEach(ref => {
                        const copy = {
                            ...account,
                            id: 'tw_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '_copy'
                        };
                        ref.creator.accounts[ref.index] = copy;
                        console.log(`  ‚úÖ Copie cr√©√©e pour ${ref.creator.name}`);
                        fixed++;
                    });
                }
            });
            
            if (fixed > 0) {
                saveData();
                console.log(`\n‚úÖ ${fixed} r√©f√©rence(s) corrig√©e(s)`);
            }
            
            return fixed;
        }
        
        // Expose to console
        window.analyzeTwitterAccounts = analyzeTwitterAccounts;
        window.migrateTwitterAccounts = migrateTwitterAccountsToSimple;
        window.analyzeGmailAccount = analyzeGmailAccount;
        window.cleanGhostReference = cleanGhostReference;
        window.cleanAllGhostReferences = cleanAllGhostReferences;
        window.checkSharedReferences = checkSharedReferences;
        window.fixSharedReferences = fixSharedReferences;
        
        // Synchroniser les gmailId entre data.twitterAccounts et creator.accounts
        function syncGmailIds() {
            console.log('\nüîÑ SYNCHRONISATION DES GMAIL IDs');
            console.log('=====================================');
            
            let synced = 0;
            
            // Parcourir data.twitterAccounts
            if (data.twitterAccounts) {
                data.twitterAccounts.forEach(twitterAccount => {
                    // Si ce compte n'a pas de gmailId
                    if (!twitterAccount.gmailId || twitterAccount.gmailId === null) {
                        // Chercher le m√™me compte dans creator.accounts
                        let foundGmailId = null;
                        
                        data.creators.forEach(creator => {
                            if (creator.accounts) {
                                const creatorAccount = creator.accounts.find(a => 
                                    a.username.toLowerCase() === twitterAccount.username.toLowerCase()
                                );
                                if (creatorAccount && creatorAccount.gmailId) {
                                    foundGmailId = creatorAccount.gmailId;
                                }
                            }
                        });
                        
                        if (foundGmailId) {
                            console.log(`\n‚úÖ Synchronisation de ${twitterAccount.username}:`);
                            console.log(`  - Ancien gmailId: ${twitterAccount.gmailId || 'null'}`);
                            console.log(`  - Nouveau gmailId: ${foundGmailId}`);
                            
                            // V√©rifier que le Gmail existe
                            const gmail = data.gmailAccounts.find(g => g.id === foundGmailId);
                            if (gmail) {
                                console.log(`  - Gmail trouv√©: ${gmail.email}`);
                                twitterAccount.gmailId = foundGmailId;
                                synced++;
                            }
                        }
                    }
                });
            }
            
            // Dans l'autre sens : synchroniser de twitterAccounts vers creator.accounts
            data.creators.forEach(creator => {
                if (creator.accounts) {
                    creator.accounts.forEach(account => {
                        if (!account.gmailId) {
                            const twitterAccount = data.twitterAccounts?.find(ta => 
                                ta.username.toLowerCase() === account.username.toLowerCase()
                            );
                            if (twitterAccount && twitterAccount.gmailId) {
                                console.log(`\n‚úÖ Synchronisation inverse de ${account.username}:`);
                                console.log(`  - Ajout du gmailId: ${twitterAccount.gmailId}`);
                                account.gmailId = twitterAccount.gmailId;
                                synced++;
                            }
                        }
                    });
                }
            });
            
            if (synced > 0) {
                saveData();
                updateDisplay();
                updateTwitterAccountsList();
                console.log(`\nüéâ ${synced} gmailId(s) synchronis√©(s) avec succ√®s!`);
            } else {
                console.log('\n‚úÖ Tous les gmailId sont d√©j√† synchronis√©s');
            }
            
            return synced;
        }
        
        window.syncGmailIds = syncGmailIds;
        
        // Auto-expose on load
        document.addEventListener('DOMContentLoaded', function() {
            window.analyzeTwitterAccounts = analyzeTwitterAccounts;
            window.migrateTwitterAccounts = migrateTwitterAccountsToSimple;
            window.analyzeGmailAccount = analyzeGmailAccount;
            window.cleanGhostReference = cleanGhostReference;
            window.cleanAllGhostReferences = cleanAllGhostReferences;
            window.checkSharedReferences = checkSharedReferences;
            window.fixSharedReferences = fixSharedReferences;
            window.syncGmailIds = syncGmailIds;
            console.log('‚úÖ Fonctions d\'analyse disponibles dans la console:');
            console.log('  - analyzeTwitterAccounts() : analyser tous les comptes Twitter');
            console.log('  - migrateTwitterAccounts() : migrer vers le nouveau syst√®me');
            console.log('  - analyzeGmailAccount("email@gmail.com") : analyser un compte Gmail');
            console.log('  - cleanGhostReference("email@gmail.com") : nettoyer une r√©f√©rence fant√¥me');
            console.log('  - cleanAllGhostReferences() : nettoyer toutes les r√©f√©rences fant√¥mes');
            console.log('  - checkSharedReferences() : v√©rifier les r√©f√©rences partag√©es');
            console.log('  - fixSharedReferences() : corriger les r√©f√©rences partag√©es');
            console.log('  - syncGmailIds() : synchroniser les gmailId entre les structures');
        });
        
        // Show transfer modal for Twitter account
        function showTransferModal(creatorId, accountIndex, currentVaId) {
            const creator = data.creators.find(c => c.id === creatorId);
            const account = creator?.accounts[accountIndex];
            if (!account) return;
            
            const currentVa = data.vas.find(v => v.id === currentVaId);
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            let modalContent = `
                <h3 style="margin-bottom: 1rem; color: ${isDarkMode ? '#f9fafb' : '#1f2937'};">
                    <i class="fas fa-exchange-alt"></i> Transf√©rer ${account.username}
                </h3>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                    Actuellement sur: <strong>${currentVa?.name || 'Non assign√©'}</strong>
                </p>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                    Vers quel VA voulez-vous transf√©rer ce compte ?
                </p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            `;
            
            // Lister tous les VAs sauf le current
            data.vas.forEach(va => {
                if (va.id !== currentVaId) {
                    modalContent += `
                        <button class="submit-btn" style="background: #3b82f6;"
                                onclick="executeTransfer('${creatorId}', ${accountIndex}, '${va.id}')">
                            <i class="fas fa-user"></i> ${va.name}
                        </button>
                    `;
                }
            });
            
            modalContent += `
                </div>
                <div style="margin-top: 1.5rem;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Execute transfer
        function executeTransfer(creatorId, accountIndex, newVaId) {
            const creator = data.creators.find(c => c.id === creatorId);
            const account = creator?.accounts[accountIndex];
            if (!account) return;
            
            const newVa = data.vas.find(v => v.id === newVaId);
            
            // Mettre √† jour l'assignation
            account.assignedVaId = newVaId;
            
            // Mettre √† jour aussi dans twitterAccounts si existe
            const twitterAccount = data.twitterAccounts.find(t => 
                t.username === account.username || t.id === account.id
            );
            if (twitterAccount) {
                twitterAccount.vaId = newVaId;
            }
            
            // S'assurer que la cr√©atrice est associ√©e au nouveau VA
            if (!creator.vaIds) creator.vaIds = [];
            if (!creator.vaIds.includes(newVaId)) {
                creator.vaIds.push(newVaId);
            }
            
            saveData();
            closeModal();
            showSuccess(`${account.username} transf√©r√© vers ${newVa?.name} !`);
        }
        
        // Show Twitter password
        function showTwitterPassword(username, obfuscatedPassword) {
            const password = deobfuscatePassword(obfuscatedPassword);
            const modalContent = `
                <h2 style="margin-bottom: 1.5rem;">Mot de passe Twitter</h2>
                <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <p style="margin-bottom: 0.5rem;"><strong>Compte:</strong> ${username}</p>
                    <p style="margin-bottom: 0;"><strong>Mot de passe:</strong> ${password}</p>
                </div>
                <button onclick="closeModal()" class="cancel-btn">Fermer</button>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Show assign to VA modal
        function showAssignToVAModal(creatorId, username) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const modalContent = `
                <h2 style="margin-bottom: 1.5rem;">Assigner ${username} √† un VA</h2>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    ${data.vas.map(va => `
                        <button onclick="assignAccountToVA('${creatorId}', '${va.id}')" 
                                class="submit-btn" style="background: ${va.color || '#667eea'};">
                            <i class="fas fa-user-tie"></i> ${va.name}
                        </button>
                    `).join('')}
                </div>
                <button onclick="closeModal()" class="cancel-btn" style="margin-top: 1rem;">Annuler</button>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Assign account to VA
        function assignAccountToVA(creatorId, vaId) {
            const creator = data.creators.find(c => c.id === creatorId);
            const va = data.vas.find(v => v.id === vaId);
            
            if (!creator || !va) return;
            
            // Ajouter le VA √† la cr√©atrice
            if (!creator.vaIds) creator.vaIds = [];
            if (!creator.vaIds.includes(vaId)) {
                creator.vaIds.push(vaId);
            }
            
            saveData();
            closeModal();
            updateDisplay();
            showSuccess(`Compte assign√© √† ${va.name} avec succ√®s!`);
        }
        
        // Show assign Gmail modal
        function showAssignGmailModal(creatorId, username) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            // Trouver les Gmail disponibles
            const usedGmailIds = new Set();
            data.creators.forEach(c => {
                (c.accounts || []).forEach(acc => {
                    if (acc.gmailId) usedGmailIds.add(acc.gmailId);
                });
            });
            
            const availableGmails = (data.gmailAccounts || []).filter(g => !usedGmailIds.has(g.id));
            
            if (availableGmails.length === 0) {
                showError('Aucun compte Gmail disponible!');
                return;
            }
            
            const modalContent = `
                <h2 style="margin-bottom: 1.5rem;">Assigner un Gmail √† ${username}</h2>
                <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 400px; overflow-y: auto;">
                    ${availableGmails.map(gmail => `
                        <button onclick="assignGmailToAccount('${creatorId}', '${username}', '${gmail.id}')" 
                                class="submit-btn" style="background: #ea4335;">
                            <i class="fas fa-envelope"></i> ${gmail.email}
                        </button>
                    `).join('')}
                </div>
                <button onclick="closeModal()" class="cancel-btn" style="margin-top: 1rem;">Annuler</button>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Assign Gmail to account
        function assignGmailToAccount(creatorId, username, gmailId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const account = creator.accounts.find(a => a.username === username);
            if (!account) return;
            
            account.gmailId = gmailId;
            
            saveData();
            closeModal();
            updateDisplay();
            showSuccess(`Gmail assign√© avec succ√®s!`);
        }
        
        // Show transfer account modal
        function showTransferAccountModal(currentVaId, creatorId, accountUsername) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const currentVa = data.vas.find(v => v.id === currentVaId);
            if (!currentVa) return;
            
            // Cr√©er la liste des VAs disponibles (sauf le VA actuel)
            const otherVAs = data.vas.filter(v => v.id !== currentVaId);
            
            if (otherVAs.length === 0) {
                showError('Aucun autre VA disponible pour le transfert');
                return;
            }
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            const modalContent = `
                <h3 style="margin-bottom: 1rem; color: ${isDarkMode ? '#f9fafb' : '#1f2937'};">Transf√©rer ${accountUsername}</h3>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'};">
                    Transf√©rer de <strong>${currentVa.name}</strong> vers :
                </p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.5rem;">
                    ${otherVAs.map(va => `
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; 
                                     background: ${isDarkMode ? '#374151' : '#f3f4f6'}; 
                                     border-radius: 0.5rem; cursor: pointer;
                                     border: 2px solid transparent;
                                     transition: all 0.2s;"
                               onmouseover="this.style.borderColor='#3b82f6'"
                               onmouseout="this.style.borderColor='transparent'">
                            <input type="radio" name="targetVA" value="${va.id}" style="cursor: pointer;">
                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 12px; height: 12px; background: ${va.color || '#667eea'}; border-radius: 50%;"></span>
                                ${va.name}
                            </span>
                        </label>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                    <button onclick="confirmTransferAccount('${currentVaId}', '${creatorId}', '${accountUsername}')" class="submit-btn">
                        <i class="fas fa-exchange-alt"></i> Transf√©rer
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Confirm transfer account
        function confirmTransferAccount(fromVaId, creatorId, accountUsername) {
            const selectedRadio = document.querySelector('input[name="targetVA"]:checked');
            if (!selectedRadio) {
                showError('Veuillez s√©lectionner un VA de destination');
                return;
            }
            
            const toVaId = selectedRadio.value;
            const sourceCreator = data.creators.find(c => c.id === creatorId);
            
            if (!sourceCreator || !sourceCreator.accounts) return;
            
            // Trouver le compte sp√©cifique √† transf√©rer
            const accountIndex = sourceCreator.accounts.findIndex(a => a.username === accountUsername);
            if (accountIndex === -1) {
                showError('Compte non trouv√©');
                return;
            }
            
            const accountToTransfer = sourceCreator.accounts[accountIndex];
            
            // Si la cr√©atrice a plusieurs comptes, on doit g√©rer le transfert diff√©remment
            if (sourceCreator.accounts.length > 1) {
                // Retirer le compte de la cr√©atrice source
                sourceCreator.accounts.splice(accountIndex, 1);
                
                // Chercher si une cr√©atrice du m√™me nom existe d√©j√†
                let targetCreator = data.creators.find(c => 
                    c.name === sourceCreator.name && c.id !== sourceCreator.id
                );
                
                if (!targetCreator) {
                    // Cr√©er une nouvelle instance de la cr√©atrice pour le VA de destination
                    targetCreator = {
                        id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: sourceCreator.name,
                        vaIds: [toVaId],
                        accounts: []
                    };
                    data.creators.push(targetCreator);
                } else {
                    // Ajouter le nouveau VA √† la cr√©atrice existante
                    if (!targetCreator.vaIds) targetCreator.vaIds = [];
                    if (!targetCreator.vaIds.includes(toVaId)) {
                        targetCreator.vaIds.push(toVaId);
                    }
                }
                
                // Ajouter le compte √† la cr√©atrice cible
                targetCreator.accounts.push(accountToTransfer);
                
            } else {
                // Si c'est le seul compte, on transf√®re simplement la cr√©atrice enti√®re
                const fromIndex = sourceCreator.vaIds.indexOf(fromVaId);
                if (fromIndex > -1) {
                    sourceCreator.vaIds.splice(fromIndex, 1);
                }
                
                if (!sourceCreator.vaIds.includes(toVaId)) {
                    sourceCreator.vaIds.push(toVaId);
                }
            }
            
            const fromVa = data.vas.find(v => v.id === fromVaId);
            const toVa = data.vas.find(v => v.id === toVaId);
            
            saveData();
            closeModal();
            updateDisplay();
            
            showSuccess(`${accountUsername} transf√©r√© de ${fromVa.name} vers ${toVa.name}`);
        }
        
        // Show split creator modal
        function showSplitCreatorModal(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator || !creator.vaIds || creator.vaIds.length <= 1) return;
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Pr√©parer les groupes pour chaque VA
            const vaGroups = {};
            creator.vaIds.forEach(vaId => {
                const va = data.vas.find(v => v.id === vaId);
                if (va) {
                    vaGroups[vaId] = {
                        va: va,
                        accounts: []
                    };
                }
            });
            
            let modalContent = `
                <h3 style="margin-bottom: 1rem; color: ${isDarkMode ? '#f9fafb' : '#1f2937'};">
                    S√©parer "${creator.name}" par VA
                </h3>
                <p style="margin-bottom: 1rem; color: ${isDarkMode ? '#94a3b8' : '#6b7280'}; font-size: 0.875rem;">
                    Assignez chaque compte Twitter √† un VA sp√©cifique. Les comptes non assign√©s resteront avec le premier VA.
                </p>
            `;
            
            if (creator.accounts && creator.accounts.length > 0) {
                modalContent += '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                
                creator.accounts.forEach((account, index) => {
                    modalContent += `
                        <div style="border: 1px solid ${isDarkMode ? '#374151' : '#e5e7eb'}; border-radius: 0.5rem; padding: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: ${isDarkMode ? '#f3f4f6' : '#1f2937'};">
                                <i class="fab fa-twitter" style="color: #1da1f2;"></i> ${account.username}
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${creator.vaIds.map((vaId, i) => {
                                    const va = data.vas.find(v => v.id === vaId);
                                    return `
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; 
                                                     background: ${isDarkMode ? '#374151' : '#f3f4f6'}; 
                                                     border-radius: 0.25rem; cursor: pointer;">
                                            <input type="radio" name="account_${index}" value="${vaId}" 
                                                   ${i === 0 ? 'checked' : ''} style="cursor: pointer;">
                                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                                <span style="width: 10px; height: 10px; background: ${va.color || '#667eea'}; 
                                                           border-radius: 50%;"></span>
                                                ${va.name}
                                            </span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                modalContent += '</div>';
            }
            
            modalContent += `
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                    <button onclick="confirmSplitCreator('${creatorId}')" class="submit-btn" style="background: #dc2626;">
                        <i class="fas fa-cut"></i> S√©parer
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Confirm split creator
        function confirmSplitCreator(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            // Collecter les assignations
            const assignments = {};
            creator.vaIds.forEach(vaId => {
                assignments[vaId] = [];
            });
            
            // Parcourir chaque compte et voir o√π il est assign√©
            if (creator.accounts) {
                creator.accounts.forEach((account, index) => {
                    const selectedVa = document.querySelector(`input[name="account_${index}"]:checked`);
                    if (selectedVa) {
                        assignments[selectedVa.value].push(account);
                    }
                });
            }
            
            // Cr√©er les nouvelles cr√©atrices
            const newCreators = [];
            let firstCreator = true;
            
            Object.keys(assignments).forEach(vaId => {
                if (assignments[vaId].length > 0 || firstCreator) {
                    const newCreator = {
                        id: firstCreator ? creator.id : 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: creator.name,
                        vaIds: [vaId],
                        accounts: assignments[vaId]
                    };
                    newCreators.push(newCreator);
                    firstCreator = false;
                }
            });
            
            // Remplacer l'ancienne cr√©atrice
            const originalIndex = data.creators.findIndex(c => c.id === creatorId);
            if (originalIndex > -1) {
                data.creators.splice(originalIndex, 1);
                
                // Ajouter les nouvelles cr√©atrices
                newCreators.forEach(nc => {
                    data.creators.push(nc);
                });
                
                saveData();
                closeModal();
                updateDisplay();
                updateAllCreatorsTable();
                
                showSuccess(`"${creator.name}" s√©par√©e en ${newCreators.length} cr√©atrices distinctes`);
            }
        }
        
        // Assign VA to Creator
        function assignVAToCreator(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            // Cr√©er une liste de checkboxes pour chaque VA
            let checkboxesHtml = '';
            data.vas.forEach(va => {
                const isChecked = creator.vaIds && creator.vaIds.includes(va.id);
                checkboxesHtml += `
                    <div style="margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" 
                                   id="va-checkbox-${va.id}" 
                                   value="${va.id}" 
                                   ${isChecked ? 'checked' : ''}
                                   style="cursor: pointer;">
                            <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 12px; height: 12px; background: ${va.color || '#667eea'}; border-radius: 50%;"></span>
                                ${va.name}
                            </span>
                        </label>
                    </div>
                `;
            });
            
            const modalContent = `
                <h3 style="margin-bottom: 1rem;">Assigner des VAs √† "${creator.name}"</h3>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    S√©lectionnez les VAs auxquels cette cr√©atrice appartient :
                </p>
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
                    ${checkboxesHtml}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" class="cancel-btn">Annuler</button>
                    <button onclick="saveVAAssignment('${creatorId}')" class="submit-btn">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>
            `;
            
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('password-modal').classList.add('show');
        }
        
        // Save VA assignment
        function saveVAAssignment(creatorId) {
            const creator = data.creators.find(c => c.id === creatorId);
            if (!creator) return;
            
            const selectedVAs = [];
            data.vas.forEach(va => {
                const checkbox = document.getElementById(`va-checkbox-${va.id}`);
                if (checkbox && checkbox.checked) {
                    selectedVAs.push(va.id);
                }
            });
            
            // Mettre √† jour les vaIds de la cr√©atrice
            creator.vaIds = selectedVAs;
            
            // Mettre √† jour les creatorIds des VAs
            data.vas.forEach(va => {
                if (!va.creatorIds) va.creatorIds = [];
                
                if (selectedVAs.includes(va.id)) {
                    // Ajouter si pas d√©j√† pr√©sent
                    if (!va.creatorIds.includes(creatorId)) {
                        va.creatorIds.push(creatorId);
                    }
                } else {
                    // Retirer si pr√©sent
                    va.creatorIds = va.creatorIds.filter(id => id !== creatorId);
                }
            });
            
            saveData();
            closeModal();
            updateAllCreatorsTable();
            updateDisplay();
            showSuccess(`VAs assign√©s √† "${creator.name}"`);
        }

        // Search
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (!searchTerm) {
                resultsDiv.innerHTML = '';
                return;
            }

            let results = [];

            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        if (va.name.toLowerCase().includes(searchTerm) ||
                            creator.name.toLowerCase().includes(searchTerm) ||
                            account.username.toLowerCase().includes(searchTerm) ||
                            account.email.toLowerCase().includes(searchTerm)) {
                            
                            results.push({
                                va: va.name,
                                creator: creator.name,
                                account: account
                            });
                        }
                    });
                });
            });

            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="no-creator">Aucun r√©sultat trouv√©</div>';
                return;
            }

            resultsDiv.innerHTML = results.map(r => `
                <div class="creatrice-item">
                    <p><strong>VA:</strong> ${r.va} | <strong>Cr√©atrice:</strong> ${r.creator}</p>
                    <p><strong>Compte:</strong> ${r.account.username} - ${r.account.email}</p>
                </div>
            `).join('');
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            document.getElementById('success-text').textContent = message;
            successDiv.classList.add('show');
            
            setTimeout(() => {
                successDiv.classList.remove('show');
            }, 3000);
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                document.getElementById('error-text').textContent = message;
                errorDiv.classList.add('show');
                
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 4000);
            } else {
                // Fallback si le div n'existe pas
                alert('‚ùå ' + message);
            }
        }
        
        // Toggle password visibility
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + '-toggle');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // CSV Import
        function setupDragAndDrop() {
            const area = document.getElementById('import-area');
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'text/csv') {
                    handleFile(file);
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const dataMap = {};

            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',').map(p => p.trim());
                if (parts.length >= 5) {
                    const vaName = parts[0];
                    const creatorName = parts[1];
                    const username = parts[2];
                    const email = parts[3];
                    const password = parts[4];

                    // Create VA structure
                    if (!dataMap[vaName]) {
                        dataMap[vaName] = {
                            id: 'va_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                            name: vaName,
                            creators: {}
                        };
                    }

                    // Create creator structure
                    if (!dataMap[vaName].creators[creatorName]) {
                        dataMap[vaName].creators[creatorName] = {
                            id: 'creator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                            name: creatorName,
                            accounts: []
                        };
                    }

                    // Add account
                    dataMap[vaName].creators[creatorName].accounts.push({
                        username: username.startsWith('@') ? username : '@' + username,
                        email: email,
                        password: password,
                        created: new Date().toISOString().split('T')[0]
                    });
                }
            }

            // Convert map to array structure
            let imported = 0;
            Object.values(dataMap).forEach(vaData => {
                let va = data.vas.find(v => v.name === vaData.name);
                
                if (!va) {
                    va = {
                        id: vaData.id,
                        name: vaData.name,
                        creators: []
                    };
                    data.vas.push(va);
                }

                Object.values(vaData.creators).forEach(creatorData => {
                    let creator = va.creators.find(c => c.name === creatorData.name);
                    
                    if (!creator) {
                        creator = {
                            id: creatorData.id,
                            name: creatorData.name,
                            accounts: []
                        };
                        va.creators.push(creator);
                    }

                    creator.accounts.push(...creatorData.accounts);
                    imported += creatorData.accounts.length;
                });
            });

            saveData();
            showSuccess(`Import r√©ussi! ${imported} comptes import√©s.`);
            navigateToPage('dashboard');
        }

        // Export data
        function exportData() {
            let csv = 'Pr√©nom VA,Cr√©atrice,@Twitter,Email,Mot de passe\n';
            
            data.vas.forEach(va => {
                va.creators.forEach(creator => {
                    creator.accounts.forEach(account => {
                        csv += `${va.name},${creator.name},${account.username},${account.email},${account.password}\n`;
                    });
                });
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'va_manager_export.csv';
            a.click();
        }

        // ========== SUBS COMPETITION FUNCTIONS ==========

        let currentPeriod = 'week';

        function setupSubsTracking() {
            // Period tabs
            document.querySelectorAll('.period-tab').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-tab').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.dataset.period;
                    updateCompetitionDisplay();
                });
            });
            
            // Add subs form submit event
            const addSubsForm = document.getElementById('add-subs-form');
            if (addSubsForm) {
                addSubsForm.addEventListener('submit', addSubsEntry);
            }
        }

        function updateCompetitionDisplay() {
            updateLeaderboard();
            updateCompetitionStats();
            updatePerformanceCharts();
            updateActivityFeed();
            updateSubsStats();
            updateSubsTable();
        }
        
        function updateSubsStats() {
            const allSubs = data.subs || [];
            const today = new Date().toISOString().split('T')[0];
            const todaySubs = allSubs.filter(s => s.date === today);
            
            const totalAmount = allSubs.reduce((sum, sub) => sum + sub.amount, 0);
            const totalToday = todaySubs.reduce((sum, sub) => sum + sub.count, 0);
            
            // Calculate paid amounts
            const totalPaidSubs = (data.vaPayments || [])
                .filter(p => p.type === 'subs' || p.type === 'both')
                .reduce((sum, p) => sum + (p.subsAmount || 0), 0);
            
            const totalRemaining = totalAmount - totalPaidSubs;
            
            // Find best VA
            const vaStats = {};
            allSubs.forEach(sub => {
                if (!vaStats[sub.vaId]) vaStats[sub.vaId] = 0;
                vaStats[sub.vaId] += sub.count;
            });
            
            let bestVaId = null;
            let maxSubs = 0;
            Object.entries(vaStats).forEach(([vaId, count]) => {
                if (count > maxSubs) {
                    maxSubs = count;
                    bestVaId = vaId;
                }
            });
            
            const bestVa = bestVaId ? data.vas.find(va => va.id === bestVaId) : null;
            
            // Update display
            document.getElementById('total-subs-week').textContent = allSubs.length;
            document.getElementById('total-subs-today').textContent = totalToday;
            document.getElementById('total-payment').textContent = totalAmount.toFixed(2) + '‚Ç¨';
            document.getElementById('total-paid').textContent = totalPaidSubs.toFixed(2) + '‚Ç¨';
            document.getElementById('total-remaining').textContent = totalRemaining.toFixed(2) + '‚Ç¨';
            document.getElementById('best-va-name').textContent = bestVa ? bestVa.name : '-';
        }
        
        function updateSubsTable() {
            const container = document.getElementById('subs-history');
            if (!container) return;
            
            const allSubs = (data.subs || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allSubs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8;">Aucune entr√©e de subs</p>';
                return;
            }
            
            let html = `
                <table class="subs-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>VA</th>
                            <th>Nombre</th>
                            <th>Montant</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allSubs.forEach(sub => {
                const va = data.vas.find(v => v.id === sub.vaId);
                const paidAmount = calculatePaidAmountForSub(sub);
                const isPaid = paidAmount >= sub.amount;
                const status = isPaid ? 
                    '<span style="color: #22c55e;"><i class="fas fa-check-circle"></i> Pay√©</span>' : 
                    '<span style="color: #ef4444;"><i class="fas fa-clock"></i> En attente</span>';
                
                html += `
                    <tr>
                        <td>${new Date(sub.date).toLocaleDateString('fr-FR')}</td>
                        <td>${va ? va.name : 'VA supprim√©'}</td>
                        <td>${sub.count}</td>
                        <td>${sub.amount.toFixed(2)}‚Ç¨</td>
                        <td>${status}</td>
                        <td>
                            <button onclick="deleteSub('${sub.id}')" class="btn-icon" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function calculatePaidAmountForSub(sub) {
            // This is a simplified calculation - in reality you might want to track payments per sub
            const vaPayments = (data.vaPayments || [])
                .filter(p => p.vaId === sub.vaId && (p.type === 'subs' || p.type === 'both'));
            
            let totalPaid = 0;
            vaPayments.forEach(payment => {
                if (new Date(payment.date) >= new Date(sub.date)) {
                    totalPaid += payment.subsAmount || 0;
                }
            });
            
            return totalPaid;
        }

        function updateLeaderboard() {
            const container = document.getElementById('leaderboard-content');
            if (!container) return;
            
            // Calculate VA scores
            const vaScores = calculateVAScores();
            
            // Sort by score
            const sortedVAs = Object.entries(vaScores)
                .sort((a, b) => b[1].totalSubs - a[1].totalSubs)
                .slice(0, 10); // Top 10
            
            container.innerHTML = '';
            
            if (sortedVAs.length === 0) {
                container.innerHTML = `
                    <div style="padding: 3rem; text-align: center; color: #94a3b8;">
                        <i class="fas fa-trophy" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Aucune donn√©e de comp√©tition</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Commencez √† ajouter des subs pour voir le classement!</p>
                    </div>
                `;
                return;
            }
            
            sortedVAs.forEach(([vaId, stats], index) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va) return;
                
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                const trend = stats.trend > 0 ? '‚Üë' : stats.trend < 0 ? '‚Üì' : '‚Üí';
                const trendColor = stats.trend > 0 ? '#10b981' : stats.trend < 0 ? '#ef4444' : '#64748b';
                
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="rank-badge ${rankClass}">${index + 1}</div>
                    <div class="va-info">
                        <div class="va-name">${va.name}</div>
                        <div class="va-stats-mini">
                            <span>${stats.totalSubs} subs</span>
                            <span style="color: ${trendColor};">${trend} ${Math.abs(stats.trend)}%</span>
                        </div>
                    </div>
                    <div class="va-score">
                        <div class="score-value">${stats.amount.toFixed(2)}‚Ç¨</div>
                        <div class="score-label">√† payer</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function calculateVAScores() {
            const scores = {};
            const filteredSubs = getFilteredSubs();
            
            // Initialize scores for all VAs
            data.vas.forEach(va => {
                scores[va.id] = { totalSubs: 0, amount: 0, trend: 0 };
            });
            
            // Calculate scores
            filteredSubs.forEach(sub => {
                if (scores[sub.vaId]) {
                    scores[sub.vaId].totalSubs += sub.count;
                    scores[sub.vaId].amount += sub.amount;
                }
            });
            
            // Calculate trends (comparison with previous period)
            Object.keys(scores).forEach(vaId => {
                const previousScore = calculatePreviousPeriodScore(vaId);
                if (previousScore > 0) {
                    scores[vaId].trend = Math.round(((scores[vaId].totalSubs - previousScore) / previousScore) * 100);
                }
            });
            
            return scores;
        }

        function calculatePreviousPeriodScore(vaId) {
            // Simplified trend calculation
            if (!data.subs || data.subs.length === 0) return 0;
            
            const lastWeekSubs = data.subs
                .filter(s => s.vaId === vaId && new Date(s.date) < new Date(Date.now() - 7 * 24 * 60 * 60 * 1000))
                .reduce((sum, s) => sum + s.count, 0);
            return lastWeekSubs;
        }

        function updateCompetitionStats() {
            const today = new Date().toISOString().split('T')[0];
            const todaySubs = data.subs.filter(s => s.date === today);
            const totalSubsToday = todaySubs.reduce((sum, s) => sum + s.count, 0);
            
            const filteredSubs = getFilteredSubs();
            const totalAmount = filteredSubs.reduce((sum, s) => sum + s.amount, 0);
            
            // Find best VA
            const vaScores = calculateVAScores();
            const bestVA = Object.entries(vaScores).sort((a, b) => b[1].totalSubs - a[1].totalSubs)[0];
            const bestVAName = bestVA ? data.vas.find(v => v.id === bestVA[0])?.name || '-' : '-';
            
            document.getElementById('total-subs-today').textContent = totalSubsToday;
            document.getElementById('total-payment').textContent = totalAmount.toFixed(2) + '‚Ç¨';
            document.getElementById('best-va-name').textContent = bestVAName;
            
            // Update period display
            const periodDisplay = {
                'today': "Aujourd'hui",
                'week': "Cette semaine",
                'month': "Ce mois",
                'all': "Tout"
            };
            document.getElementById('period-display').textContent = periodDisplay[currentPeriod];
        }

        function updatePerformanceCharts() {
            // VA Performance Chart
            const performanceChart = document.getElementById('va-performance-chart');
            const vaScores = calculateVAScores();
            const topVAs = Object.entries(vaScores)
                .sort((a, b) => b[1].totalSubs - a[1].totalSubs)
                .slice(0, 5);
            
            if (topVAs.length === 0) {
                performanceChart.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-chart-bar" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">Aucune donn√©e √† afficher</p>
                    </div>
                `;
            } else {
                performanceChart.innerHTML = '';
                const maxSubs = Math.max(...topVAs.map(([_, stats]) => stats.totalSubs));
                
                topVAs.forEach(([vaId, stats]) => {
                    const va = data.vas.find(v => v.id === vaId);
                    if (!va) return;
                    
                    const percentage = (stats.totalSubs / maxSubs) * 100;
                    
                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'progress-container';
                    progressContainer.innerHTML = `
                        <div class="progress-header">
                            <span>${va.name}</span>
                            <span>${stats.totalSubs} subs (${stats.amount.toFixed(2)}‚Ç¨)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    performanceChart.appendChild(progressContainer);
                });
            }
            
            // Evolution Chart (simplified)
            const evolutionChart = document.getElementById('subs-evolution-chart');
            const last7Days = getLast7DaysData();
            
            evolutionChart.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; height: 150px; align-items: flex-end;">
                    ${last7Days.map(day => `
                        <div style="position: relative;">
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); height: ${day.height}%; border-radius: 0.25rem 0.25rem 0 0; transition: height 0.5s;"></div>
                            <div style="text-align: center; font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">${day.label}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getLast7DaysData() {
            const days = [];
            const maxCount = Math.max(...[...Array(7)].map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const count = data.subs
                    .filter(s => s.date === dateStr)
                    .reduce((sum, s) => sum + s.count, 0);
                return count;
            })) || 1;
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const count = data.subs
                    .filter(s => s.date === dateStr)
                    .reduce((sum, s) => sum + s.count, 0);
                
                days.push({
                    label: date.toLocaleDateString('fr', { weekday: 'short' }),
                    height: (count / maxCount) * 100
                });
            }
            
            return days;
        }

        function updateActivityFeed() {
            const container = document.getElementById('activity-list');
            const recentSubs = [...data.subs]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            if (recentSubs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-history" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">Aucune activit√© r√©cente</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            recentSubs.forEach(sub => {
                const va = data.vas.find(v => v.id === sub.vaId);
                const item = document.createElement('div');
                item.className = 'activity-item';
                
                const timeAgo = getTimeAgo(new Date(sub.date));
                
                item.innerHTML = `
                    <div class="activity-icon" style="background: #dbeafe; color: #3b82f6;">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${va ? va.name : 'VA supprim√©'} - ${sub.count} subs</div>
                        <div class="activity-time">${timeAgo} ‚Ä¢ ${sub.amount.toFixed(2)}‚Ç¨</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return "Aujourd'hui";
            if (days === 1) return "Hier";
            if (days < 7) return `Il y a ${days} jours`;
            return date.toLocaleDateString('fr-FR');
        }


        function getFilteredSubs() {
            if (!data.subs) return [];
            
            let filtered = [...data.subs];
            const today = new Date().toISOString().split('T')[0];
            
            // Filter by period
            if (currentPeriod === 'today') {
                filtered = filtered.filter(sub => sub.date === today);
            } else if (currentPeriod === 'week') {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                filtered = filtered.filter(sub => new Date(sub.date) >= oneWeekAgo);
            } else if (currentPeriod === 'month') {
                const oneMonthAgo = new Date();
                oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                filtered = filtered.filter(sub => new Date(sub.date) >= oneMonthAgo);
            }
            // 'all' returns everything
            
            // Sort by date (most recent first)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return filtered;
        }

        function openAddSubsModal() {
            // Update VA select
            const vaSelect = document.getElementById('subs-va-select');
            if (!vaSelect) {
                console.error('VA select not found');
                return;
            }
            
            const vaOptions = data.vas.map(va => 
                `<option value="${va.id}">${va.name}</option>`
            ).join('');
            vaSelect.innerHTML = '<option value="">-- Choisir un VA --</option>' + vaOptions;
            
            const modal = document.getElementById('add-subs-modal');
            if (!modal) {
                console.error('Add subs modal not found');
                return;
            }
            
            modal.classList.add('show');
        }

        function closeAddSubsModal() {
            document.getElementById('add-subs-modal').classList.remove('show');
        }

        function addSubsEntry(event) {
            event.preventDefault();
            console.log('Adding subs entry...');
            
            const vaId = document.getElementById('subs-va-select').value;
            const date = document.getElementById('subs-date').value;
            const count = parseInt(document.getElementById('subs-count').value);
            
            if (!vaId || !date || !count) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            const newSub = {
                id: 'sub_' + Date.now(),
                vaId: vaId,
                date: date,
                count: count,
                amount: count * 0.50
            };
            
            if (!data.subs) {
                data.subs = [];
            }
            
            data.subs.push(newSub);
            saveData();
            
            event.target.reset();
            document.getElementById('subs-date').value = new Date().toISOString().split('T')[0];
            closeAddSubsModal();
            showSuccess(`${count} subs ajout√©s avec succ√®s!`);
            
            updateCompetitionDisplay();
        }

        function deleteSub(subId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette entr√©e?')) {
                data.subs = data.subs.filter(sub => sub.id !== subId);
                saveData();
                updateCompetitionDisplay();
                showSuccess('Entr√©e supprim√©e');
            }
        }

        function showDetailedView() {
            alert('Vue d√©taill√©e en d√©veloppement - bient√¥t disponible!');
            // TODO: Implement detailed view with full table and analytics
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        function exportSubsData() {
            let csv = 'Date,VA,Nombre de subs,Montant (‚Ç¨)\n';
            
            const filteredSubs = getFilteredSubs();
            
            filteredSubs.forEach(sub => {
                const va = data.vas.find(v => v.id === sub.vaId);
                csv += `${sub.date},${va ? va.name : 'VA supprim√©'},${sub.count},${sub.amount.toFixed(2)}\n`;
            });
            
            // Add summary
            const totalSubs = filteredSubs.reduce((sum, sub) => sum + sub.count, 0);
            const totalAmount = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0);
            
            csv += `\n\nR√âSUM√â\n`;
            csv += `Total subs,${totalSubs}\n`;
            csv += `Total √† payer,${totalAmount.toFixed(2)}‚Ç¨\n`;
            
            // Add per VA summary
            csv += `\nPAR VA\n`;
            const vaPayments = {};
            filteredSubs.forEach(sub => {
                if (!vaPayments[sub.vaId]) {
                    vaPayments[sub.vaId] = { name: '', count: 0, amount: 0 };
                }
                const va = data.vas.find(v => v.id === sub.vaId);
                vaPayments[sub.vaId].name = va ? va.name : 'VA supprim√©';
                vaPayments[sub.vaId].count += sub.count;
                vaPayments[sub.vaId].amount += sub.amount;
            });
            
            Object.values(vaPayments).forEach(payment => {
                csv += `${payment.name},${payment.count} subs,${payment.amount.toFixed(2)}‚Ç¨\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `subs_export_${currentPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ========== REVENUE TRACKING FUNCTIONS ==========

        let currentRevenuePeriod = 'current-week';
        let currentExchangeRate = 0.92; // Default rate

        // Fetch exchange rate on page load
        function fetchExchangeRate() {
            // Using exchangerate-api.com (free tier, no API key needed)
            fetch('https://api.exchangerate-api.com/v4/latest/USD')
                .then(response => response.json())
                .then(data => {
                    currentExchangeRate = data.rates.EUR;
                    document.getElementById('exchange-rate').value = currentExchangeRate;
                    document.getElementById('exchange-rate-display').textContent = `1$ = ${currentExchangeRate.toFixed(4)}‚Ç¨`;
                    document.getElementById('rate-update-time').textContent = `Mis √† jour: ${new Date().toLocaleTimeString('fr-FR')}`;
                    
                    // Update conversion if form is open
                    if (typeof updateConversion !== 'undefined') {
                        updateConversion();
                    }
                })
                .catch(error => {
                    console.error('Error fetching exchange rate:', error);
                    document.getElementById('rate-update-time').textContent = 'Erreur - Utilisation du taux par d√©faut';
                });
        }

        function updateExchangeRate() {
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            icon.classList.add('fa-spin');
            
            fetchExchangeRate();
            
            setTimeout(() => {
                icon.classList.remove('fa-spin');
            }, 1000);
        }

        function setupRevenueTracking() {
            // Fetch exchange rate on setup
            fetchExchangeRate();
            // Period tabs for revenue
            document.querySelectorAll('[data-revenue-period]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-revenue-period]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentRevenuePeriod = this.dataset.revenuePeriod;
                    updateRevenueDisplay();
                });
            });
            
            // Form events
            const addRevenueForm = document.getElementById('add-revenue-form');
            if (addRevenueForm) {
                addRevenueForm.addEventListener('submit', addRevenueEntry);
            }
            
            const payCommissionForm = document.getElementById('pay-commission-form');
            if (payCommissionForm) {
                payCommissionForm.addEventListener('submit', payCommissionEntry);
            }
            
            // Calculate commission on amount change
            const revenueAmountInput = document.getElementById('revenue-amount');
            const exchangeRateInput = document.getElementById('exchange-rate');
            
            function updateConversion() {
                const amountUSD = parseFloat(document.getElementById('revenue-amount').value) || 0;
                const exchangeRate = parseFloat(document.getElementById('exchange-rate').value) || currentExchangeRate;
                const amountEUR = amountUSD * exchangeRate;
                const commission = amountEUR * 0.05; // 5%
                
                document.getElementById('amount-in-eur').textContent = amountEUR.toFixed(2) + '‚Ç¨';
                document.getElementById('calculated-commission').textContent = commission.toFixed(2) + '‚Ç¨';
            }
            
            if (revenueAmountInput) {
                revenueAmountInput.addEventListener('input', updateConversion);
            }
            
            // Update outstanding info when VA selected
            const paymentVASelect = document.getElementById('payment-va-select');
            if (paymentVASelect) {
                paymentVASelect.addEventListener('change', updateOutstandingInfo);
            }
        }

        function updateRevenueDisplay() {
            updateRevenueStats();
            updateRevenueLeaderboard();
            updateCommissionSummary();
            updateRevenueCharts();
        }

        function updateRevenueStats() {
            const filteredRevenues = getFilteredRevenues();
            const totalRevenue = filteredRevenues.reduce((sum, r) => sum + r.amount, 0);
            const totalCommissionsDue = filteredRevenues.reduce((sum, r) => sum + r.commission, 0);
            
            const filteredPayments = getFilteredPayments();
            const totalPaid = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
            const remainingToPay = totalCommissionsDue - totalPaid;
            
            document.getElementById('total-revenue-generated').textContent = totalRevenue.toFixed(2) + '‚Ç¨';
            document.getElementById('total-commissions-due').textContent = totalCommissionsDue.toFixed(2) + '‚Ç¨';
            document.getElementById('total-commissions-paid').textContent = totalPaid.toFixed(2) + '‚Ç¨';
            document.getElementById('commissions-to-pay').textContent = Math.max(0, remainingToPay).toFixed(2) + '‚Ç¨';
        }

        function updateRevenueLeaderboard() {
            const container = document.getElementById('revenue-leaderboard-content');
            if (!container) return;
            
            const vaRevenues = calculateVARevenues();
            const sortedVAs = Object.entries(vaRevenues)
                .sort((a, b) => b[1].totalRevenue - a[1].totalRevenue)
                .slice(0, 10);
            
            container.innerHTML = '';
            
            if (sortedVAs.length === 0) {
                container.innerHTML = `
                    <div style="padding: 3rem; text-align: center; color: #94a3b8;">
                        <i class="fas fa-money-bill-wave" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Aucune donn√©e de revenus</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Commencez √† ajouter des revenus!</p>
                    </div>
                `;
                return;
            }
            
            sortedVAs.forEach(([vaId, stats], index) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va) return;
                
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
                const efficiency = stats.totalRevenue > 0 ? (stats.totalCommission / stats.totalRevenue * 100).toFixed(1) : 0;
                
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="rank-badge ${rankClass}">${index + 1}</div>
                    <div class="va-info">
                        <div class="va-name">${va.name}</div>
                        <div class="va-stats-mini">
                            <span style="color: #10b981;">üìà ${stats.totalRevenue.toFixed(2)}‚Ç¨ g√©n√©r√©s</span>
                            <span style="color: #3b82f6;">üí∞ ${stats.totalCommission.toFixed(2)}‚Ç¨ commission</span>
                            <span style="color: #64748b;">‚öñÔ∏è ${stats.balance.toFixed(2)}‚Ç¨ √† payer</span>
                            <span>
                                <button onclick="viewVARevenues('${vaId}')" class="action-btn view-btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                    <i class="fas fa-edit"></i> G√©rer
                                </button>
                            </span>
                        </div>
                    </div>
                    <div class="va-score">
                        <div class="score-value" style="color: #10b981;">${stats.totalRevenue.toFixed(0)}‚Ç¨</div>
                        <div class="score-label">Revenus g√©n√©r√©s</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function calculateVARevenues() {
            const revenues = {};
            
            // Initialize all VAs
            data.vas.forEach(va => {
                revenues[va.id] = { 
                    totalRevenue: 0, 
                    totalCommission: 0, 
                    totalPaid: 0,
                    balance: 0 
                };
            });
            
            // Add revenues
            const filteredRevenues = getFilteredRevenues();
            filteredRevenues.forEach(rev => {
                if (revenues[rev.vaId]) {
                    revenues[rev.vaId].totalRevenue += rev.amount;
                    revenues[rev.vaId].totalCommission += rev.commission;
                }
            });
            
            // Subtract payments (old system)
            const filteredPayments = getFilteredPayments();
            filteredPayments.forEach(pay => {
                if (revenues[pay.vaId]) {
                    revenues[pay.vaId].totalPaid += pay.amount;
                }
            });
            
            // Add new VA payments for commissions
            (data.vaPayments || []).forEach(payment => {
                if (revenues[payment.vaId] && (payment.type === 'commissions' || payment.type === 'both')) {
                    revenues[payment.vaId].totalPaid += (payment.commissionsAmount || 0);
                }
            });
            
            // Calculate balance
            Object.keys(revenues).forEach(vaId => {
                revenues[vaId].balance = revenues[vaId].totalCommission - revenues[vaId].totalPaid;
            });
            
            return revenues;
        }

        function updateCommissionSummary() {
            const container = document.getElementById('commission-summary');
            const vaRevenues = calculateVARevenues();
            
            container.innerHTML = '';
            
            const vasWithBalance = Object.entries(vaRevenues)
                .filter(([_, stats]) => stats.balance > 0)
                .sort((a, b) => b[1].balance - a[1].balance);
            
            if (vasWithBalance.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8;">Toutes les commissions sont √† jour! üéâ</p>';
                return;
            }
            
            vasWithBalance.forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va) return;
                
                const card = document.createElement('div');
                card.style.cssText = 'background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid #f59e0b;';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${va.name}</strong>
                            <div style="font-size: 0.875rem; color: #64748b;">
                                Commission: ${stats.totalCommission.toFixed(2)}‚Ç¨ | Pay√©: ${stats.totalPaid.toFixed(2)}‚Ç¨
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.25rem; font-weight: 600; color: #f59e0b;">
                                ${stats.balance.toFixed(2)}‚Ç¨
                            </div>
                            <div style="font-size: 0.75rem; color: #64748b;">√Ä payer</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateRevenueCharts() {
            // Revenue evolution
            const evolutionChart = document.getElementById('revenue-evolution-chart');
            const last7Days = getRevenueLast7Days();
            
            evolutionChart.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; height: 150px; align-items: flex-end;">
                    ${last7Days.map(day => `
                        <div style="position: relative;">
                            <div style="background: linear-gradient(135deg, #10b981, #059669); height: ${day.height}%; border-radius: 0.25rem 0.25rem 0 0; transition: height 0.5s;"></div>
                            <div style="text-align: center; font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">${day.label}</div>
                            <div style="text-align: center; font-size: 0.625rem; color: #94a3b8;">${day.amount}‚Ç¨</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Commission distribution
            const distributionChart = document.getElementById('commission-distribution-chart');
            const vaRevenues = calculateVARevenues();
            const topVAs = Object.entries(vaRevenues)
                .filter(([_, stats]) => stats.totalCommission > 0)
                .sort((a, b) => b[1].totalCommission - a[1].totalCommission)
                .slice(0, 5);
            
            if (topVAs.length === 0) {
                distributionChart.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-chart-pie" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">Aucune commission √† afficher</p>
                    </div>
                `;
            } else {
                const maxCommission = Math.max(...topVAs.map(([_, stats]) => stats.totalCommission));
                
                distributionChart.innerHTML = '';
                topVAs.forEach(([vaId, stats]) => {
                    const va = data.vas.find(v => v.id === vaId);
                    if (!va) return;
                    
                    const percentage = (stats.totalCommission / maxCommission) * 100;
                    const paidPercentage = stats.totalCommission > 0 ? (stats.totalPaid / stats.totalCommission) * 100 : 0;
                    
                    const container = document.createElement('div');
                    container.className = 'progress-container';
                    container.innerHTML = `
                        <div class="progress-header">
                            <span>${va.name}</span>
                            <span>${stats.totalCommission.toFixed(2)}‚Ç¨ (${stats.balance.toFixed(2)}‚Ç¨ dus)</span>
                        </div>
                        <div class="progress-bar" style="position: relative;">
                            <div class="progress-fill" style="width: ${percentage}%; background: #e5e7eb;"></div>
                            <div class="progress-fill" style="width: ${paidPercentage}%; background: linear-gradient(90deg, #10b981, #059669); position: absolute; top: 0; left: 0;"></div>
                        </div>
                    `;
                    distributionChart.appendChild(container);
                });
            }
        }

        function getRevenueLast7Days() {
            const days = [];
            const maxAmount = Math.max(...[...Array(7)].map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const amount = data.revenues
                    .filter(r => r.date === dateStr)
                    .reduce((sum, r) => sum + r.amount, 0);
                return amount;
            })) || 1;
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const amount = data.revenues
                    .filter(r => r.date === dateStr)
                    .reduce((sum, r) => sum + r.amount, 0);
                
                days.push({
                    label: date.toLocaleDateString('fr', { weekday: 'short' }),
                    height: (amount / maxAmount) * 100,
                    amount: amount.toFixed(0)
                });
            }
            
            return days;
        }

        function getFilteredRevenues() {
            if (!data.revenues) return [];
            
            let filtered = [...data.revenues];
            const now = new Date();
            
            switch (currentRevenuePeriod) {
                case 'current-week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(r => new Date(r.date) >= startOfWeek);
                    break;
                case 'last-week':
                    const startOfLastWeek = new Date(now);
                    startOfLastWeek.setDate(now.getDate() - now.getDay() - 7);
                    const endOfLastWeek = new Date(now);
                    endOfLastWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(r => {
                        const date = new Date(r.date);
                        return date >= startOfLastWeek && date < endOfLastWeek;
                    });
                    break;
                case 'current-month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filtered = filtered.filter(r => new Date(r.date) >= startOfMonth);
                    break;
            }
            
            return filtered;
        }

        function getFilteredPayments() {
            if (!data.payments) return [];
            
            let filtered = [...data.payments];
            const now = new Date();
            
            switch (currentRevenuePeriod) {
                case 'current-week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(p => new Date(p.date) >= startOfWeek);
                    break;
                case 'last-week':
                    const startOfLastWeek = new Date(now);
                    startOfLastWeek.setDate(now.getDate() - now.getDay() - 7);
                    const endOfLastWeek = new Date(now);
                    endOfLastWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(p => {
                        const date = new Date(p.date);
                        return date >= startOfLastWeek && date < endOfLastWeek;
                    });
                    break;
                case 'current-month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filtered = filtered.filter(p => new Date(p.date) >= startOfMonth);
                    break;
            }
            
            return filtered;
        }

        function openAddRevenueModal() {
            const vaSelect = document.getElementById('revenue-va-select');
            const vaOptions = data.vas.map(va => 
                `<option value="${va.id}">${va.name}</option>`
            ).join('');
            vaSelect.innerHTML = '<option value="">-- Choisir un VA --</option>' + vaOptions;
            
            // Fetch latest exchange rate when opening modal
            fetchExchangeRate();
            
            document.getElementById('add-revenue-modal').classList.add('show');
        }

        function closeAddRevenueModal() {
            document.getElementById('add-revenue-modal').classList.remove('show');
            // Clear any editing state
            delete window.editingRevenueId;
        }

        function addRevenueEntry(event) {
            event.preventDefault();
            
            const vaId = document.getElementById('revenue-va-select').value;
            const date = document.getElementById('revenue-date').value;
            const amountUSD = parseFloat(document.getElementById('revenue-amount').value);
            const exchangeRate = parseFloat(document.getElementById('exchange-rate').value) || currentExchangeRate;
            const trackingLink = document.getElementById('tracking-link').value;
            const description = document.getElementById('revenue-description').value;
            
            // Convert USD to EUR
            const amountEUR = amountUSD * exchangeRate;
            const commission = amountEUR * 0.05; // 5%
            
            // Check if we're editing
            const isEditing = window.editingRevenueId !== undefined;
            let revenueId;
            let message;
            
            if (isEditing) {
                // Remove the old entry
                revenueId = window.editingRevenueId;
                data.revenues = data.revenues.filter(r => r.id !== revenueId);
                delete window.editingRevenueId;
                message = `Revenus modifi√©s: ${amountUSD.toFixed(2)}$ (${amountEUR.toFixed(2)}‚Ç¨)`;
            } else {
                revenueId = 'rev_' + Date.now();
                message = `Revenus de ${amountUSD.toFixed(2)}$ (${amountEUR.toFixed(2)}‚Ç¨) ajout√©s avec succ√®s!`;
            }
            
            const newRevenue = {
                id: revenueId,
                vaId: vaId,
                date: date,
                amountUSD: amountUSD,
                exchangeRate: exchangeRate,
                amount: amountEUR, // Store in EUR
                commission: commission,
                trackingLink: trackingLink || '',
                description: description || 'Ventes m√©dias'
            };
            
            if (!data.revenues) data.revenues = [];
            data.revenues.push(newRevenue);
            saveData();
            
            event.target.reset();
            document.getElementById('revenue-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('exchange-rate').value = currentExchangeRate;
            document.getElementById('amount-in-eur').textContent = '0.00‚Ç¨';
            document.getElementById('calculated-commission').textContent = '0.00‚Ç¨';
            closeAddRevenueModal();
            showSuccess(message);
            
            updateRevenueDisplay();
        }

        function openPayCommissionModal() {
            const vaSelect = document.getElementById('payment-va-select');
            const vaOptions = data.vas.map(va => 
                `<option value="${va.id}">${va.name}</option>`
            ).join('');
            vaSelect.innerHTML = '<option value="">-- Choisir un VA --</option>' + vaOptions;
            
            document.getElementById('pay-commission-modal').classList.add('show');
        }

        function closePayCommissionModal() {
            document.getElementById('pay-commission-modal').classList.remove('show');
        }

        function updateOutstandingInfo() {
            const vaId = document.getElementById('payment-va-select').value;
            const infoDiv = document.getElementById('va-outstanding-info');
            const amountSpan = document.getElementById('outstanding-amount');
            
            if (!vaId) {
                infoDiv.style.display = 'none';
                return;
            }
            
            const vaRevenues = calculateVARevenues();
            const balance = vaRevenues[vaId]?.balance || 0;
            
            amountSpan.textContent = balance.toFixed(2) + '‚Ç¨';
            infoDiv.style.display = 'block';
        }

        function payCommissionEntry(event) {
            event.preventDefault();
            
            const vaId = document.getElementById('payment-va-select').value;
            const date = document.getElementById('payment-date').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const period = document.getElementById('payment-period').value;
            
            const newPayment = {
                id: 'pay_' + Date.now(),
                vaId: vaId,
                date: date,
                amount: amount,
                type: 'commission',
                period: period
            };
            
            if (!data.payments) data.payments = [];
            data.payments.push(newPayment);
            saveData();
            
            event.target.reset();
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('va-outstanding-info').style.display = 'none';
            closePayCommissionModal();
            showSuccess(`Paiement de ${amount.toFixed(2)}‚Ç¨ enregistr√©!`);
            
            updateRevenueDisplay();
        }

        function viewPaymentHistory() {
            const section = document.getElementById('payment-history-section');
            section.style.display = 'block';
            
            const container = document.getElementById('payment-history-list');
            const allPayments = [...(data.payments || [])]
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allPayments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        <i class="fas fa-receipt" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p style="margin-top: 0.5rem;">Aucun paiement enregistr√©</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            allPayments.forEach(payment => {
                const va = data.vas.find(v => v.id === payment.vaId);
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <div class="activity-icon" style="background: #dbeafe; color: #3b82f6;">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${va ? va.name : 'VA supprim√©'} - ${payment.amount.toFixed(2)}‚Ç¨</div>
                        <div class="activity-time">${formatDate(payment.date)} ‚Ä¢ ${payment.period}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function hidePaymentHistory() {
            document.getElementById('payment-history-section').style.display = 'none';
        }

        function viewVARevenues(vaId) {
            const va = data.vas.find(v => v.id === vaId);
            if (!va) return;
            
            document.getElementById('revenue-management-title').textContent = `Gestion des Revenus - ${va.name}`;
            const tbody = document.getElementById('revenue-management-tbody');
            
            const vaRevenues = data.revenues.filter(r => r.vaId === vaId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            
            if (vaRevenues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8;">Aucun revenu enregistr√©</td></tr>';
            } else {
                vaRevenues.forEach(revenue => {
                    const row = document.createElement('tr');
                    const usdAmount = revenue.amountUSD || (revenue.amount / 0.92);
                    const rate = revenue.exchangeRate || 0.92;
                    
                    row.innerHTML = `
                        <td>${formatDate(revenue.date)}</td>
                        <td>${revenue.description}</td>
                        <td>${usdAmount.toFixed(2)}$</td>
                        <td>${rate.toFixed(4)}</td>
                        <td>${revenue.amount.toFixed(2)}‚Ç¨</td>
                        <td>${revenue.commission.toFixed(2)}‚Ç¨</td>
                        <td>
                            <button class="action-btn view-btn" onclick="editRevenue('${revenue.id}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteRevenue('${revenue.id}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('revenue-management-section').style.display = 'block';
            document.getElementById('payment-history-section').style.display = 'none';
        }

        function hideRevenueManagement() {
            document.getElementById('revenue-management-section').style.display = 'none';
        }

        function editRevenue(revenueId) {
            const revenue = data.revenues.find(r => r.id === revenueId);
            if (!revenue) return;
            
            console.log('Editing revenue:', revenue);
            
            // Store the revenue ID being edited
            window.editingRevenueId = revenueId;
            
            // Open the modal first
            openAddRevenueModal();
            
            // Wait a bit for the modal to be ready
            setTimeout(() => {
                // Pre-fill the form with existing data
                const vaSelect = document.getElementById('revenue-va-select');
                const dateInput = document.getElementById('revenue-date');
                const amountInput = document.getElementById('revenue-amount');
                const rateInput = document.getElementById('exchange-rate');
                const linkInput = document.getElementById('tracking-link');
                const descInput = document.getElementById('revenue-description');
                
                if (vaSelect) vaSelect.value = revenue.vaId;
                if (dateInput) dateInput.value = revenue.date;
                if (amountInput) amountInput.value = revenue.amountUSD || (revenue.amount / (revenue.exchangeRate || 0.92));
                if (rateInput) {
                    rateInput.value = revenue.exchangeRate || 0.92;
                    document.getElementById('exchange-rate-display').textContent = `1$ = ${(revenue.exchangeRate || 0.92).toFixed(4)}‚Ç¨`;
                }
                if (linkInput) linkInput.value = revenue.trackingLink || '';
                if (descInput) descInput.value = revenue.description || '';
                
                // Update conversion display
                updateConversion();
            }, 100);
            
            // Hide management section
            hideRevenueManagement();
        }

        function deleteRevenue(revenueId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette entr√©e de revenus?')) {
                data.revenues = data.revenues.filter(r => r.id !== revenueId);
                saveData();
                showSuccess('Revenu supprim√©');
                updateRevenueDisplay();
                
                // Refresh the management view
                const tbody = document.getElementById('revenue-management-tbody');
                if (tbody.parentElement.parentElement.parentElement.style.display !== 'none') {
                    const titleText = document.getElementById('revenue-management-title').textContent;
                    if (titleText.includes('Tous les revenus')) {
                        viewAllRevenues();
                    } else {
                        // Find VA from remaining revenues
                        const remainingRevenue = data.revenues[0];
                        if (remainingRevenue) {
                            viewVARevenues(remainingRevenue.vaId);
                        }
                    }
                }
            }
        }

        function viewAllRevenues() {
            document.getElementById('revenue-management-title').textContent = 'Tous les revenus';
            const tbody = document.getElementById('revenue-management-tbody');
            
            const allRevenues = [...data.revenues]
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = '';
            
            if (allRevenues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8;">Aucun revenu enregistr√©</td></tr>';
            } else {
                allRevenues.forEach(revenue => {
                    const va = data.vas.find(v => v.id === revenue.vaId);
                    const row = document.createElement('tr');
                    const usdAmount = revenue.amountUSD || (revenue.amount / 0.92);
                    const rate = revenue.exchangeRate || 0.92;
                    
                    row.innerHTML = `
                        <td>${formatDate(revenue.date)}</td>
                        <td><strong>${va ? va.name : 'VA supprim√©'}:</strong> ${revenue.description}</td>
                        <td>${usdAmount.toFixed(2)}$</td>
                        <td>${rate.toFixed(4)}</td>
                        <td>${revenue.amount.toFixed(2)}‚Ç¨</td>
                        <td>${revenue.commission.toFixed(2)}‚Ç¨</td>
                        <td>
                            <button class="action-btn view-btn" onclick="editRevenue('${revenue.id}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteRevenue('${revenue.id}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('revenue-management-section').style.display = 'block';
            document.getElementById('payment-history-section').style.display = 'none';
        }

        function exportFinancialData() {
            let csv = 'Type,Date,VA,Description,Montant USD,Taux Change,Montant EUR,Commission EUR,Lien Tracking\n';
            
            // Add revenues
            data.revenues.forEach(rev => {
                const va = data.vas.find(v => v.id === rev.vaId);
                const usdAmount = rev.amountUSD || (rev.amount / 0.92); // Fallback for old data
                const rate = rev.exchangeRate || 0.92;
                csv += `Revenu,${rev.date},${va ? va.name : 'VA supprim√©'},"${rev.description}",${usdAmount.toFixed(2)},${rate},${rev.amount.toFixed(2)},${rev.commission.toFixed(2)},"${rev.trackingLink}"\n`;
            });
            
            // Add payments
            csv += '\n\nPaiements de Commissions\n';
            csv += 'Date,VA,Montant EUR,P√©riode\n';
            data.payments.forEach(pay => {
                const va = data.vas.find(v => v.id === pay.vaId);
                csv += `${pay.date},${va ? va.name : 'VA supprim√©'},${pay.amount.toFixed(2)},"${pay.period}"\n`;
            });
            
            // Add summary
            const vaRevenues = calculateVARevenues();
            csv += '\n\nR√âSUM√â PAR VA\n';
            csv += 'VA,Revenus G√©n√©r√©s EUR,Commission Due EUR,D√©j√† Pay√© EUR,Reste √† Payer EUR\n';
            
            Object.entries(vaRevenues).forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (stats.totalRevenue > 0) {
                    csv += `${va ? va.name : 'VA supprim√©'},${stats.totalRevenue.toFixed(2)},${stats.totalCommission.toFixed(2)},${stats.totalPaid.toFixed(2)},${stats.balance.toFixed(2)}\n`;
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        // ========== FINANCIAL OVERVIEW FUNCTIONS ==========

        let currentFinancialPeriod = 'current-week';

        function setupFinancialOverview() {
            // Period tabs
            document.querySelectorAll('[data-financial-period]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-financial-period]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFinancialPeriod = this.dataset.financialPeriod;
                    updateFinancialOverview();
                });
            });
        }

        function updateFinancialOverview() {
            updateFinancialSnapshot();
            updateVAFinancialGrid();
            updateRevenueBreakdownChart();
            updateGlobalEvolutionChart();
            updateFinancialSummaryTable();
            updatePaymentHistoryTable();
        }
        
        function updateFinancialSnapshot() {
            const container = document.getElementById('financial-snapshot');
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            
            // Calculate all financial data
            const filteredSubs = getFilteredSubsForFinancial();
            const filteredRevenues = getFilteredRevenuesForFinancial();
            const totalSubsRevenue = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0);
            const totalMediaRevenue = filteredRevenues.reduce((sum, rev) => sum + rev.amount, 0);
            const totalCommissions = filteredRevenues.reduce((sum, rev) => sum + rev.commission, 0);
            const totalPaidAmount = (data.vaPayments || []).reduce((sum, payment) => sum + payment.amount, 0);
            const totalAllRevenue = totalSubsRevenue + totalMediaRevenue;
            const totalDue = totalSubsRevenue + totalCommissions;
            const totalToPay = totalDue - totalPaidAmount;
            
            // Calculate profit/loss
            const netProfit = totalMediaRevenue - totalCommissions;
            const profitMargin = totalMediaRevenue > 0 ? (netProfit / totalMediaRevenue * 100).toFixed(1) : 0;
            
            // Update period description
            const periodDescriptions = {
                'current-week': 'Aper√ßu de vos finances cette semaine',
                'current-month': 'Aper√ßu de vos finances ce mois-ci',
                'last-month': 'Aper√ßu de vos finances le mois dernier',
                'all': 'Aper√ßu de toutes vos finances'
            };
            document.getElementById('financial-period-description').textContent = periodDescriptions[currentFinancialPeriod];
            
            let html = `
                <!-- Main Financial Flow Visualization -->
                <div style="background: ${isDarkMode ? '#0f172a' : '#ffffff'}; border-radius: 2rem; padding: 3rem; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1); margin-bottom: 3rem;">
                    <!-- Revenue Flow -->
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 2rem; margin-bottom: 4rem;">
                        <!-- Revenus -->
                        <div style="text-align: center;">
                            <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1e3a8a, #2563eb)' : 'linear-gradient(135deg, #eff6ff, #dbeafe)'}; border-radius: 1.5rem; padding: 2rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                                <i class="fas fa-coins" style="font-size: 3rem; color: ${isDarkMode ? '#60a5fa' : '#3b82f6'}; margin-bottom: 1rem; display: block;"></i>
                                <h3 style="font-size: 2.5rem; font-weight: 800; margin: 0; color: ${isDarkMode ? '#ffffff' : '#1e40af'};">${totalAllRevenue.toFixed(2)}‚Ç¨</h3>
                                <p style="margin-top: 0.5rem; font-size: 1rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Revenus Totaux</p>
                                <div style="margin-top: 1.5rem; display: grid; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'}; border-radius: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                            <i class="fas fa-users" style="margin-right: 0.5rem; color: #3b82f6;"></i>Subs
                                        </span>
                                        <span style="font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${totalSubsRevenue.toFixed(2)}‚Ç¨</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'}; border-radius: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                            <i class="fas fa-photo-video" style="margin-right: 0.5rem; color: #10b981;"></i>M√©dias
                                        </span>
                                        <span style="font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${totalMediaRevenue.toFixed(2)}‚Ç¨</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Arrow -->
                        <div style="font-size: 3rem; color: ${isDarkMode ? '#475569' : '#cbd5e1'};">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        
                        <!-- Obligations -->
                        <div style="text-align: center;">
                            <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #7c2d12, #dc2626)' : 'linear-gradient(135deg, #fef2f2, #fee2e2)'}; border-radius: 1.5rem; padding: 2rem; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; left: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                                <i class="fas fa-hand-holding-usd" style="font-size: 3rem; color: ${isDarkMode ? '#f87171' : '#dc2626'}; margin-bottom: 1rem; display: block;"></i>
                                <h3 style="font-size: 2.5rem; font-weight: 800; margin: 0; color: ${isDarkMode ? '#ffffff' : '#991b1b'};">${totalDue.toFixed(2)}‚Ç¨</h3>
                                <p style="margin-top: 0.5rem; font-size: 1rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">D√ª aux VAs</p>
                                <div style="margin-top: 1.5rem; display: grid; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'}; border-radius: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                            <i class="fas fa-check-circle" style="margin-right: 0.5rem; color: #22c55e;"></i>Pay√©
                                        </span>
                                        <span style="font-weight: 600; color: #22c55e;">${totalPaidAmount.toFixed(2)}‚Ç¨</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'}; border-radius: 0.5rem;">
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#475569'};">
                                            <i class="fas fa-clock" style="margin-right: 0.5rem; color: #ef4444;"></i>Reste
                                        </span>
                                        <span style="font-weight: 600; color: #ef4444;">${totalToPay.toFixed(2)}‚Ç¨</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profit Section -->
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #14532d, #16a34a)' : 'linear-gradient(135deg, #f0fdf4, #dcfce7)'}; border-radius: 1.5rem; padding: 2rem; text-align: center;">
                        <h3 style="font-size: 1.25rem; margin: 0; color: ${isDarkMode ? '#86efac' : '#16a34a'};">
                            <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>Votre Profit Net
                        </h3>
                        <div style="font-size: 3rem; font-weight: 800; margin: 1rem 0; color: ${isDarkMode ? '#ffffff' : '#14532d'};">
                            ${netProfit.toFixed(2)}‚Ç¨
                        </div>
                        <div style="font-size: 1rem; color: ${isDarkMode ? '#86efac' : '#16a34a'};">
                            Marge de ${profitMargin}% sur les m√©dias
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.875rem; color: ${isDarkMode ? '#cbd5e1' : '#64748b'};">
                            Revenus m√©dias (${totalMediaRevenue.toFixed(2)}‚Ç¨) - Commissions (${totalCommissions.toFixed(2)}‚Ç¨)
                        </p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 3rem;">
                    <button onclick="showPaymentModal()" class="submit-btn" style="background: linear-gradient(135deg, #16a34a, #22c55e); padding: 1rem 2rem; font-size: 1.1rem;">
                        <i class="fas fa-money-check-alt" style="margin-right: 0.5rem;"></i> Enregistrer un Paiement
                    </button>
                    <button onclick="exportCompleteFinancialReport()" class="submit-btn" style="background: linear-gradient(135deg, #7c3aed, #9333ea); padding: 1rem 2rem; font-size: 1.1rem;">
                        <i class="fas fa-file-excel" style="margin-right: 0.5rem;"></i> Export Excel
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }


        function updateVAFinancialGrid() {
            const container = document.getElementById('va-financial-grid');
            const vaFinancials = calculateCompleteVAFinancials();
            
            container.innerHTML = '';
            
            // Sort by total revenue
            const sortedVAs = Object.entries(vaFinancials)
                .sort((a, b) => b[1].totalRevenue - a[1].totalRevenue);
            
            sortedVAs.forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va || stats.totalRevenue === 0) return;
                
                const card = document.createElement('div');
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                card.style.cssText = `background: ${isDarkMode ? '#1e293b' : '#f8fafc'}; border-radius: 1rem; padding: 1.5rem; border-left: 4px solid #f59e0b;`;
                
                const efficiency = stats.mediaRevenue > 0 ? (stats.totalRevenue / stats.mediaRevenue * 100).toFixed(1) : 0;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${va.name}</h3>
                        <span style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${stats.totalRevenue.toFixed(2)}‚Ç¨</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">Subs (${stats.subsCount})</div>
                            <div style="font-weight: 600; color: #3b82f6;">${stats.subsRevenue.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div>
                            <div style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">M√©dias vendus</div>
                            <div style="font-weight: 600; color: #10b981;">${stats.mediaRevenue.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div>
                            <div style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">Commissions dues</div>
                            <div style="font-weight: 600; color: #ef4444;">${stats.commissionsDue.toFixed(2)}‚Ç¨</div>
                        </div>
                        <div>
                            <div style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 0.875rem;">Total √† payer au VA</div>
                            <div style="font-weight: 600; color: #ef4444;">${((stats.subsRevenue + stats.commissionsDue) - (stats.paidAmount || 0)).toFixed(2)}‚Ç¨</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid ${isDarkMode ? '#334155' : '#e2e8f0'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Performance</span>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <div style="width: 100px; height: 8px; background: ${isDarkMode ? '#334155' : '#e2e8f0'}; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${Math.min(efficiency, 100)}%; height: 100%; background: linear-gradient(90deg, #f59e0b, #d97706);"></div>
                                </div>
                                <span style="font-size: 0.75rem; font-weight: 600; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${efficiency}%</span>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            if (Object.keys(vaFinancials).length === 0 || sortedVAs.every(([_, stats]) => stats.totalRevenue === 0)) {
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                container.innerHTML = `<div style="text-align: center; padding: 3rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Aucune donn√©e financi√®re pour cette p√©riode</div>`;
            }
        }

        function calculateCompleteVAFinancials() {
            const financials = {};
            
            // Initialize all VAs
            data.vas.forEach(va => {
                financials[va.id] = {
                    subsRevenue: 0,
                    subsCount: 0,
                    mediaRevenue: 0,
                    commissionsDue: 0,
                    totalRevenue: 0,
                    netRevenue: 0,
                    paidAmount: 0
                };
            });
            
            // Add subs revenue
            const filteredSubs = getFilteredSubsForFinancial();
            filteredSubs.forEach(sub => {
                if (financials[sub.vaId]) {
                    financials[sub.vaId].subsRevenue += sub.amount;
                    financials[sub.vaId].subsCount += sub.count;
                }
            });
            
            // Add media revenue
            const filteredRevenues = getFilteredRevenuesForFinancial();
            filteredRevenues.forEach(rev => {
                if (financials[rev.vaId]) {
                    financials[rev.vaId].mediaRevenue += rev.amount;
                    financials[rev.vaId].commissionsDue += rev.commission;
                }
            });
            
            // Add payments
            (data.vaPayments || []).forEach(payment => {
                if (financials[payment.vaId]) {
                    financials[payment.vaId].paidAmount += payment.amount;
                }
            });
            
            // Calculate totals
            Object.keys(financials).forEach(vaId => {
                financials[vaId].totalRevenue = financials[vaId].subsRevenue + financials[vaId].mediaRevenue;
                financials[vaId].netRevenue = financials[vaId].mediaRevenue - financials[vaId].commissionsDue;
            });
            
            return financials;
        }

        function updateRevenueBreakdownChart() {
            const container = document.getElementById('revenue-breakdown-chart');
            const filteredSubs = getFilteredSubsForFinancial();
            const filteredRevenues = getFilteredRevenuesForFinancial();
            
            const totalSubsRevenue = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0);
            const totalMediaRevenue = filteredRevenues.reduce((sum, rev) => sum + rev.amount, 0);
            const totalRevenue = totalSubsRevenue + totalMediaRevenue;
            
            if (totalRevenue === 0) {
                container.innerHTML = `
                    <div style="color: #94a3b8;">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p style="margin-top: 1rem;">Aucune donn√©e pour cette p√©riode</p>
                    </div>
                `;
                return;
            }
            
            const subsPercentage = (totalSubsRevenue / totalRevenue * 100).toFixed(1);
            const mediaPercentage = (totalMediaRevenue / totalRevenue * 100).toFixed(1);
            
            container.innerHTML = `
                <div style="position: relative; width: 200px; height: 200px; margin: 0 auto;">
                    <svg viewBox="0 0 42 42" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                        <circle cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#e2e8f0" stroke-width="3"></circle>
                        <circle cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#3b82f6" stroke-width="3"
                            stroke-dasharray="${subsPercentage} ${100 - subsPercentage}"
                            stroke-dashoffset="0"></circle>
                        <circle cx="21" cy="21" r="15.91549430918954" fill="transparent" stroke="#10b981" stroke-width="3"
                            stroke-dasharray="${mediaPercentage} ${100 - mediaPercentage}"
                            stroke-dashoffset="${-subsPercentage}"></circle>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${totalRevenue.toFixed(0)}‚Ç¨</div>
                        <div style="font-size: 0.875rem; color: #64748b;">Total</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                        <span style="font-size: 0.875rem;">Subs (${subsPercentage}%)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                        <span style="font-size: 0.875rem;">M√©dias (${mediaPercentage}%)</span>
                    </div>
                </div>
            `;
        }

        function updateGlobalEvolutionChart() {
            const container = document.getElementById('global-evolution-chart');
            const last7Days = getGlobalLast7Days();
            
            const maxAmount = Math.max(...last7Days.map(d => d.total)) || 1;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; height: 200px; align-items: flex-end;">
                    ${last7Days.map(day => `
                        <div style="position: relative; height: 100%;">
                            <div style="position: absolute; bottom: 0; width: 100%; display: flex; flex-direction: column;">
                                <div style="background: #10b981; height: ${(day.media / maxAmount) * 150}px; border-radius: 0.25rem 0.25rem 0 0;"></div>
                                <div style="background: #3b82f6; height: ${(day.subs / maxAmount) * 150}px;"></div>
                            </div>
                            <div style="position: absolute; bottom: -25px; width: 100%; text-align: center;">
                                <div style="font-size: 0.75rem; color: #64748b;">${day.label}</div>
                                <div style="font-size: 0.625rem; color: #94a3b8;">${day.total.toFixed(0)}‚Ç¨</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 3rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                        <span style="font-size: 0.875rem;">Subs</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></div>
                        <span style="font-size: 0.875rem;">M√©dias</span>
                    </div>
                </div>
            `;
        }

        function getGlobalLast7Days() {
            const days = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const subsAmount = (data.subs || [])
                    .filter(s => s.date === dateStr)
                    .reduce((sum, s) => sum + s.amount, 0);
                
                const mediaAmount = (data.revenues || [])
                    .filter(r => r.date === dateStr)
                    .reduce((sum, r) => sum + r.amount, 0);
                
                days.push({
                    label: date.toLocaleDateString('fr', { weekday: 'short' }),
                    subs: subsAmount,
                    media: mediaAmount,
                    total: subsAmount + mediaAmount
                });
            }
            
            return days;
        }

        function updateFinancialSummaryTable() {
            const container = document.getElementById('financial-summary-table');
            const vaFinancials = calculateCompleteVAFinancials();
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            
            let totals = {
                subs: 0,
                media: 0,
                total: 0,
                commissions: 0,
                toPay: 0,
                vaCount: 0
            };
            
            // Calculate totals first
            let totalAlreadyPaid = 0;
            Object.entries(vaFinancials).forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (!va || stats.totalRevenue === 0) return;
                
                totals.subs += stats.subsRevenue;
                totals.media += stats.mediaRevenue;
                totals.total += stats.totalRevenue;
                totals.commissions += stats.commissionsDue;
                totals.toPay += ((stats.subsRevenue + stats.commissionsDue) - (stats.paidAmount || 0));
                totalAlreadyPaid += (stats.paidAmount || 0);
                totals.vaCount++;
            });
            
            // Create the new design
            let html = `
                <!-- Global Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1e3a8a, #2563eb)' : 'linear-gradient(135deg, #dbeafe, #bfdbfe)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#1e40af'};">${totals.total.toFixed(2)}‚Ç¨</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#bfdbfe' : '#3730a3'}; margin-top: 0.5rem;">Total Revenus G√©n√©r√©s</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #047857, #10b981)' : 'linear-gradient(135deg, #d1fae5, #a7f3d0)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#047857'};">${totals.media.toFixed(2)}‚Ç¨</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#a7f3d0' : '#064e3b'}; margin-top: 0.5rem;">Revenus M√©dias</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #7c2d12, #f59e0b)' : 'linear-gradient(135deg, #fed7aa, #fbbf24)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#92400e'};">${totals.subs.toFixed(2)}‚Ç¨</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#fed7aa' : '#78350f'}; margin-top: 0.5rem;">Total Subs</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #047857, #10b981)' : 'linear-gradient(135deg, #86efac, #22c55e)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#14532d'};">${totalAlreadyPaid.toFixed(2)}‚Ç¨</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#86efac' : '#14532d'}; margin-top: 0.5rem;">Total Pay√© aux VAs</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #991b1b, #ef4444)' : 'linear-gradient(135deg, #fecaca, #fca5a5)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#991b1b'};">${totals.toPay.toFixed(2)}‚Ç¨</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#fecaca' : '#7f1d1d'}; margin-top: 0.5rem;">Reste √† Payer</div>
                    </div>
                </div>
                
                <!-- VA Details Title -->
                <h4 style="margin-bottom: 2rem; font-size: 1.25rem; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'};">
                    <i class="fas fa-users"></i> D√©tail par VA (${totals.vaCount} actifs)
                </h4>
                
                <!-- VA Cards Grid -->
                <div style="display: grid; gap: 1.5rem;">
            `;
            
            // Add VA cards
            Object.entries(vaFinancials)
                .sort((a, b) => b[1].totalRevenue - a[1].totalRevenue)
                .forEach(([vaId, stats]) => {
                    const va = data.vas.find(v => v.id === vaId);
                    if (!va || stats.totalRevenue === 0) return;
                    
                    const performancePercent = totals.total > 0 ? (stats.totalRevenue / totals.total * 100).toFixed(1) : 0;
                    
                    html += `
                        <div style="background: ${isDarkMode ? '#1e293b' : '#f8fafc'}; border-radius: 1rem; padding: 2rem; border-left: 4px solid #f59e0b; position: relative; overflow: hidden;">
                            <!-- Performance bar background -->
                            <div style="position: absolute; top: 0; left: 0; width: ${performancePercent}%; height: 100%; background: ${isDarkMode ? 'rgba(245, 158, 11, 0.1)' : 'rgba(245, 158, 11, 0.05)'}; z-index: 0;"></div>
                            
                            <div style="position: relative; z-index: 1;">
                                <!-- Header -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                    <div>
                                        <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'};">${va.name}</h3>
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">${performancePercent}% du total</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">${stats.totalRevenue.toFixed(2)}‚Ç¨</div>
                                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Revenu total g√©n√©r√©</div>
                                    </div>
                                </div>
                                
                                <!-- Stats Grid -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1.5rem;">
                                    <!-- Subs -->
                                    <div style="background: ${isDarkMode ? 'rgba(59, 130, 246, 0.1)' : 'rgba(59, 130, 246, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(59, 130, 246, 0.2)' : 'rgba(59, 130, 246, 0.1)'};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-users" style="color: #3b82f6; font-size: 1rem;"></i>
                                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Subs</span>
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #3b82f6;">${stats.subsCount}</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">${stats.subsRevenue.toFixed(2)}‚Ç¨</div>
                                    </div>
                                    
                                    <!-- M√©dias -->
                                    <div style="background: ${isDarkMode ? 'rgba(16, 185, 129, 0.1)' : 'rgba(16, 185, 129, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(16, 185, 129, 0.2)' : 'rgba(16, 185, 129, 0.1)'};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-photo-video" style="color: #10b981; font-size: 1rem;"></i>
                                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">M√©dias</span>
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #10b981;">${stats.mediaRevenue.toFixed(2)}‚Ç¨</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">vendus</div>
                                    </div>
                                    
                                    <!-- Commissions -->
                                    <div style="background: ${isDarkMode ? 'rgba(245, 158, 11, 0.1)' : 'rgba(245, 158, 11, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(245, 158, 11, 0.2)' : 'rgba(245, 158, 11, 0.1)'};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-percentage" style="color: #f59e0b; font-size: 1rem;"></i>
                                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Commissions</span>
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: #f59e0b;">${stats.commissionsDue.toFixed(2)}‚Ç¨</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">5% des m√©dias</div>
                                    </div>
                                    
                                    <!-- Total √† payer -->
                                    <div style="background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : 'rgba(239, 68, 68, 0.1)'};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-hand-holding-usd" style="color: #ef4444; font-size: 1rem;"></i>
                                            <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">√Ä payer</span>
                                        </div>
                                        <div style="font-size: 1.25rem; font-weight: 700; color: #ef4444;">${((stats.subsRevenue + stats.commissionsDue) - (stats.paidAmount || 0)).toFixed(2)}‚Ç¨</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">au VA</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            
            html += `</div>`;
            
            container.innerHTML = html;
        }

        function getFilteredSubsForFinancial() {
            if (!data.subs) return [];
            
            let filtered = [...data.subs];
            const now = new Date();
            
            switch (currentFinancialPeriod) {
                case 'current-week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(s => new Date(s.date) >= startOfWeek);
                    break;
                case 'current-month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filtered = filtered.filter(s => new Date(s.date) >= startOfMonth);
                    break;
                case 'last-month':
                    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                    filtered = filtered.filter(s => {
                        const date = new Date(s.date);
                        return date >= startOfLastMonth && date <= endOfLastMonth;
                    });
                    break;
            }
            
            return filtered;
        }

        function getFilteredRevenuesForFinancial() {
            if (!data.revenues) return [];
            
            let filtered = [...data.revenues];
            const now = new Date();
            
            switch (currentFinancialPeriod) {
                case 'current-week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    filtered = filtered.filter(r => new Date(r.date) >= startOfWeek);
                    break;
                case 'current-month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    filtered = filtered.filter(r => new Date(r.date) >= startOfMonth);
                    break;
                case 'last-month':
                    const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                    filtered = filtered.filter(r => {
                        const date = new Date(r.date);
                        return date >= startOfLastMonth && date <= endOfLastMonth;
                    });
                    break;
            }
            
            return filtered;
        }

        function exportCompleteFinancialReport() {
            let csv = 'RAPPORT FINANCIER COMPLET\n';
            csv += `P√©riode: ${currentFinancialPeriod}\n`;
            csv += `Date d'export: ${new Date().toLocaleString('fr-FR')}\n\n`;
            
            // Summary
            const filteredSubs = getFilteredSubsForFinancial();
            const filteredRevenues = getFilteredRevenuesForFinancial();
            const totalSubsRevenue = filteredSubs.reduce((sum, sub) => sum + sub.amount, 0);
            const totalMediaRevenue = filteredRevenues.reduce((sum, rev) => sum + rev.amount, 0);
            const totalCommissions = filteredRevenues.reduce((sum, rev) => sum + rev.commission, 0);
            
            csv += 'R√âSUM√â GLOBAL\n';
            csv += `Revenus Subs,${totalSubsRevenue.toFixed(2)}‚Ç¨\n`;
            csv += `Revenus M√©dias,${totalMediaRevenue.toFixed(2)}‚Ç¨\n`;
            csv += `Total Brut,${(totalSubsRevenue + totalMediaRevenue).toFixed(2)}‚Ç¨\n`;
            csv += `Commissions,${totalCommissions.toFixed(2)}‚Ç¨\n`;
            csv += `Net,${(totalMediaRevenue - totalCommissions).toFixed(2)}‚Ç¨\n\n`;
            
            // VA Details
            csv += 'D√âTAIL PAR VA\n';
            csv += 'VA,Subs Count,Subs Revenue,Media Revenue,Total Revenue,Commissions,Net Revenue\n';
            
            const vaFinancials = calculateCompleteVAFinancials();
            Object.entries(vaFinancials).forEach(([vaId, stats]) => {
                const va = data.vas.find(v => v.id === vaId);
                if (stats.totalRevenue > 0) {
                    csv += `${va ? va.name : 'VA supprim√©'},${stats.subsCount},${stats.subsRevenue.toFixed(2)},${stats.mediaRevenue.toFixed(2)},${stats.totalRevenue.toFixed(2)},${stats.commissionsDue.toFixed(2)},${stats.netRevenue.toFixed(2)}\n`;
                }
            });
            
            // Detailed transactions
            csv += '\n\nD√âTAIL DES SUBS\n';
            csv += 'Date,VA,Nombre,Montant\n';
            filteredSubs.forEach(sub => {
                const va = data.vas.find(v => v.id === sub.vaId);
                csv += `${sub.date},${va ? va.name : 'VA supprim√©'},${sub.count},${sub.amount.toFixed(2)}\n`;
            });
            
            csv += '\n\nD√âTAIL DES VENTES M√âDIAS\n';
            csv += 'Date,VA,Description,Montant USD,Taux,Montant EUR,Commission\n';
            filteredRevenues.forEach(rev => {
                const va = data.vas.find(v => v.id === rev.vaId);
                const usd = rev.amountUSD || (rev.amount / 0.92);
                csv += `${rev.date},${va ? va.name : 'VA supprim√©'},"${rev.description}",${usd.toFixed(2)},${rev.exchangeRate || 0.92},${rev.amount.toFixed(2)},${rev.commission.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rapport_financier_complet_${currentFinancialPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function updatePaymentHistoryTable() {
            const container = document.getElementById('payment-history-table');
            const payments = (data.vaPayments || []).sort((a, b) => new Date(b.date) - new Date(a.date));
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            
            if (payments.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; padding: 2rem;">Aucun paiement enregistr√©</p>`;
                return;
            }
            
            // Calculate total paid
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // Group payments by VA
            const paymentsByVA = {};
            payments.forEach(payment => {
                if (!paymentsByVA[payment.vaId]) {
                    paymentsByVA[payment.vaId] = {
                        payments: [],
                        total: 0
                    };
                }
                paymentsByVA[payment.vaId].payments.push(payment);
                paymentsByVA[payment.vaId].total += payment.amount;
            });
            
            let html = `
                <!-- Payment Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #047857, #10b981)' : 'linear-gradient(135deg, #d1fae5, #a7f3d0)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#047857'};">${totalPaid.toFixed(2)}‚Ç¨</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#a7f3d0' : '#064e3b'}; margin-top: 0.5rem;">Total Pay√©</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #1e3a8a, #2563eb)' : 'linear-gradient(135deg, #dbeafe, #bfdbfe)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#1e40af'};">${payments.length}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#bfdbfe' : '#3730a3'}; margin-top: 0.5rem;">Nombre de Paiements</div>
                    </div>
                    <div style="background: ${isDarkMode ? 'linear-gradient(135deg, #5b21b6, #8b5cf6)' : 'linear-gradient(135deg, #e9d5ff, #c084fc)'}; padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: ${isDarkMode ? '#fff' : '#6b21a8'};">${Object.keys(paymentsByVA).length}</div>
                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#e9d5ff' : '#581c87'}; margin-top: 0.5rem;">VAs Pay√©s</div>
                    </div>
                </div>
                
                <!-- Payment Timeline Title -->
                <h4 style="margin-bottom: 2rem; font-size: 1.25rem; font-weight: 600; color: ${isDarkMode ? '#e2e8f0' : '#1e293b'};">
                    <i class="fas fa-history"></i> Chronologie des Paiements
                </h4>
                
                <!-- Payment Cards Timeline -->
                <div style="display: grid; gap: 1.5rem;">
            `;
            
            // Add payment cards
            payments.forEach((payment, index) => {
                const va = data.vas.find(v => v.id === payment.vaId);
                const typeLabel = {
                    'subs': 'Subs',
                    'commissions': 'Commissions',
                    'both': 'Subs + Commissions',
                    'custom': 'Personnalis√©'
                }[payment.type] || payment.type;
                
                const typeColor = {
                    'subs': '#3b82f6',
                    'commissions': '#f59e0b',
                    'both': '#8b5cf6',
                    'custom': '#6b7280'
                }[payment.type] || '#6b7280';
                
                // Calculate time ago
                const paymentDate = new Date(payment.date);
                const today = new Date();
                const diffTime = today - paymentDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                let timeAgo = '';
                if (diffDays === 0) timeAgo = "Aujourd'hui";
                else if (diffDays === 1) timeAgo = "Hier";
                else if (diffDays < 7) timeAgo = `Il y a ${diffDays} jours`;
                else if (diffDays < 30) timeAgo = `Il y a ${Math.floor(diffDays / 7)} semaines`;
                else timeAgo = `Il y a ${Math.floor(diffDays / 30)} mois`;
                
                html += `
                    <div style="background: ${isDarkMode ? '#1e293b' : '#f8fafc'}; border-radius: 1rem; padding: 2rem; border-left: 4px solid ${typeColor}; position: relative;">
                        <!-- Delete button -->
                        <button onclick="deletePayment('${payment.id}')" style="position: absolute; top: 1rem; right: 1rem; background: ${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)'}; border: 1px solid ${isDarkMode ? 'rgba(239, 68, 68, 0.2)' : 'rgba(239, 68, 68, 0.1)'}; color: #ef4444; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='${isDarkMode ? 'rgba(239, 68, 68, 0.1)' : 'rgba(239, 68, 68, 0.05)'}'">
                            <i class="fas fa-trash"></i>
                        </button>
                        
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0; color: ${isDarkMode ? '#f1f5f9' : '#1e293b'}; display: flex; align-items: center; gap: 1rem;">
                                    ${va ? va.name : 'VA supprim√©'}
                                    <span style="background: ${typeColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">${typeLabel}</span>
                                </h3>
                                <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">
                                    <span><i class="fas fa-calendar"></i> ${paymentDate.toLocaleDateString('fr-FR')}</span>
                                    <span><i class="fas fa-clock"></i> ${timeAgo}</span>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem; font-weight: 700; color: #22c55e;">${payment.amount.toFixed(2)}‚Ç¨</div>
                                <div style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};"><i class="fas fa-calendar-alt"></i> ${payment.period}</div>
                            </div>
                        </div>
                        
                        <!-- Payment Details Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: ${payment.note ? '1rem' : '0'};">
                            ${payment.subsAmount > 0 ? `
                                <div style="background: ${isDarkMode ? 'rgba(59, 130, 246, 0.1)' : 'rgba(59, 130, 246, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(59, 130, 246, 0.2)' : 'rgba(59, 130, 246, 0.1)'};">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-users" style="color: #3b82f6;"></i>
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Subs</span>
                                    </div>
                                    <div style="font-size: 1.25rem; font-weight: 600; color: #3b82f6;">${payment.subsAmount.toFixed(2)}‚Ç¨</div>
                                </div>
                            ` : ''}
                            
                            ${payment.commissionsAmount > 0 ? `
                                <div style="background: ${isDarkMode ? 'rgba(245, 158, 11, 0.1)' : 'rgba(245, 158, 11, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(245, 158, 11, 0.2)' : 'rgba(245, 158, 11, 0.1)'};">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-percentage" style="color: #f59e0b;"></i>
                                        <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Commissions</span>
                                    </div>
                                    <div style="font-size: 1.25rem; font-weight: 600; color: #f59e0b;">${payment.commissionsAmount.toFixed(2)}‚Ç¨</div>
                                </div>
                            ` : ''}
                            
                            <div style="background: ${isDarkMode ? 'rgba(147, 51, 234, 0.1)' : 'rgba(147, 51, 234, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border: 1px solid ${isDarkMode ? 'rgba(147, 51, 234, 0.2)' : 'rgba(147, 51, 234, 0.1)'};">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-check-circle" style="color: #9333ea;"></i>
                                    <span style="font-size: 0.875rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'};">Statut</span>
                                </div>
                                <div style="font-size: 1rem; font-weight: 600; color: #9333ea;">Pay√©</div>
                            </div>
                        </div>
                        
                        ${payment.note ? `
                            <div style="background: ${isDarkMode ? 'rgba(107, 114, 128, 0.1)' : 'rgba(107, 114, 128, 0.05)'}; padding: 1rem; border-radius: 0.5rem; border-left: 3px solid #6b7280;">
                                <div style="display: flex; gap: 0.5rem; align-items: start;">
                                    <i class="fas fa-sticky-note" style="color: #6b7280; margin-top: 0.125rem;"></i>
                                    <div>
                                        <div style="font-size: 0.75rem; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; margin-bottom: 0.25rem;">Note</div>
                                        <div style="font-size: 0.875rem; color: ${isDarkMode ? '#e2e8f0' : '#374151'};">${payment.note}</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
            
            container.innerHTML = html;
        }
        
        function deletePayment(paymentId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce paiement?')) return;
            
            data.vaPayments = (data.vaPayments || []).filter(p => p.id !== paymentId);
            saveData();
            
            alert('Paiement supprim√©!');
            
            // Update all displays
            updateFinancialOverview();
            if (document.getElementById('subs-page').style.display === 'block') {
                updateSubsTable();
                updateSubsStats();
            }
            if (document.getElementById('revenue-page').style.display === 'block') {
                updateRevenueDisplay();
            }
        }

        // Initialize financial overview
        document.addEventListener('DOMContentLoaded', function() {
            setupFinancialOverview();
        });
        
        // ========== BACKUP SYSTEM FUNCTIONS ==========
        
        function showBackupModal() {
            updateBackupStats();
            updateBackupHistory();
            document.getElementById('backup-modal').style.display = 'flex';
        }
        
        // Afficher l'historique des sauvegardes
        function updateBackupHistory() {
            const container = document.getElementById('backup-history');
            if (!container) return;
            
            try {
                const history = JSON.parse(localStorage.getItem('vaManagerProBackupHistory') || '[]');
                
                if (history.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #64748b;">
                            <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.5;"></i>
                            <p style="margin-top: 0.5rem;">Aucune sauvegarde dans l'historique</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = history.map((backup, index) => {
                        const date = new Date(backup.timestamp);
                        const dateStr = date.toLocaleDateString();
                        const timeStr = date.toLocaleTimeString();
                        
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; 
                                        padding: 0.75rem; margin-bottom: 0.5rem; 
                                        background: rgba(0, 0, 0, 0.03); border-radius: 0.5rem;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">
                                        ${dateStr} √† ${timeStr}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #64748b;">
                                        ${backup.data.vas?.length || 0} VAs ‚Ä¢ 
                                        ${backup.data.gmailAccounts?.length || 0} Gmails
                                    </div>
                                </div>
                                <button onclick="restoreFromBackup(${index})" 
                                        class="action-btn" 
                                        style="background: #6366f1; color: white; padding: 0.5rem 1rem;">
                                    <i class="fas fa-undo"></i> Restaurer
                                </button>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Erreur affichage historique:', error);
                container.innerHTML = '<p style="color: #ef4444;">Erreur lors du chargement de l\'historique</p>';
            }
        }
        
        function closeBackupModal() {
            document.getElementById('backup-modal').style.display = 'none';
        }
        
        function exportAllData() {
            const exportData = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                data: {
                    vas: data.vas || [],
                    creators: data.creators || [],
                    associations: data.associations || [],
                    subs: data.subs || [],
                    revenues: data.revenues || [],
                    payments: data.payments || [],
                    vaPayments: data.vaPayments || []
                },
                settings: {
                    darkMode: localStorage.getItem('darkMode') === 'true',
                    autoSave: localStorage.getItem('autoSaveEnabled') === 'true'
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `va_manager_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Sauvegarde t√©l√©charg√©e avec succ√®s!');
        }
        
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('‚ö†Ô∏è Cela remplacera TOUTES vos donn√©es actuelles. Continuer?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importData.data || !importData.version) {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Import data
                    data.vas = importData.data.vas || [];
                    data.creators = importData.data.creators || [];
                    data.associations = importData.data.associations || [];
                    data.subs = importData.data.subs || [];
                    data.revenues = importData.data.revenues || [];
                    data.payments = importData.data.payments || [];
                    data.vaPayments = importData.data.vaPayments || [];
                    
                    // Save to localStorage
                    saveData();
                    
                    // Apply settings if present
                    if (importData.settings) {
                        if (importData.settings.darkMode) {
                            localStorage.setItem('darkMode', 'true');
                        }
                        if (importData.settings.autoSave) {
                            localStorage.setItem('autoSaveEnabled', 'true');
                        }
                    }
                    
                    alert('‚úÖ Donn√©es import√©es avec succ√®s!');
                    
                    // Refresh page to apply all changes
                    location.reload();
                    
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }
        
        
        function checkAutoSave() {
            const autoSaveEnabled = localStorage.getItem('autoSaveEnabled') === 'true';
            const nextAutoSave = localStorage.getItem('nextAutoSave');
            
            if (autoSaveEnabled && nextAutoSave) {
                const nextSaveDate = new Date(nextAutoSave);
                const now = new Date();
                
                if (now >= nextSaveDate) {
                    // Perform auto-save
                    exportAllData();
                    
                    // Set next auto-save
                    const nextSave = new Date();
                    nextSave.setDate(nextSave.getDate() + 7);
                    localStorage.setItem('nextAutoSave', nextSave.toISOString());
                    localStorage.setItem('lastAutoSave', now.toISOString());
                }
            }
        }
        
        function checkAutoSaveStatus() {
            const autoSaveEnabled = localStorage.getItem('autoSaveEnabled') === 'true';
            const lastAutoSave = localStorage.getItem('lastAutoSave');
            const nextAutoSave = localStorage.getItem('nextAutoSave');
            
            document.getElementById('auto-save-toggle').checked = autoSaveEnabled;
            
            const statusDiv = document.getElementById('last-auto-save');
            if (lastAutoSave) {
                const lastDate = new Date(lastAutoSave);
                statusDiv.innerHTML = `Derni√®re sauvegarde auto: ${lastDate.toLocaleDateString('fr-FR')}`;
            }
            if (nextAutoSave && autoSaveEnabled) {
                const nextDate = new Date(nextAutoSave);
                statusDiv.innerHTML += `<br>Prochaine sauvegarde: ${nextDate.toLocaleDateString('fr-FR')}`;
            }
        }
        
        function updateBackupStats() {
            const statsDiv = document.getElementById('backup-stats');
            if (!statsDiv) return;
            
            // Compter le nombre total de cr√©atrices
            let totalCreators = 0;
            let totalAccounts = 0;
            data.vas.forEach(va => {
                totalCreators += (va.creators ? va.creators.length : 0);
                va.creators?.forEach(creator => {
                    totalAccounts += (creator.accounts ? creator.accounts.length : 0);
                });
            });
            
            const stats = {
                '<i class="fas fa-users"></i> VAs': (data.vas || []).length,
                '<i class="fas fa-star"></i> Cr√©atrices': totalCreators,
                '<i class="fab fa-twitter"></i> Twitter': totalAccounts,
                '<i class="fas fa-envelope"></i> Gmail': (data.gmailAccounts || []).length,
                '<i class="fas fa-chart-line"></i> Revenus': (data.revenues || []).length,
                '<i class="fas fa-database"></i> Taille': formatBytes(JSON.stringify(data).length)
            };
            
            statsDiv.innerHTML = Object.entries(stats).map(([label, value]) => `
                <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.03); 
                           border-radius: 0.5rem;">
                    <div style="color: #64748b; margin-bottom: 0.5rem;">${label}</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">${value}</div>
                </div>
            `).join('');
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Check for auto-save on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAutoSave();
        });
        
        // ========== PAYMENT MANAGEMENT FUNCTIONS ==========
        
        function showPaymentModal() {
            const modal = document.getElementById('payment-modal');
            const vaSelect = document.getElementById('payment-va');
            const dateInput = document.getElementById('payment-date');
            
            // Clear form
            document.getElementById('payment-form').reset();
            
            // Populate VAs with amount due
            vaSelect.innerHTML = '<option value="">S√©lectionnez une VA</option>';
            data.vas.forEach(va => {
                const unpaidSubs = calculateUnpaidSubsForVA(va.id);
                const unpaidCommissions = calculateUnpaidCommissionsForVA(va.id);
                const totalDue = unpaidSubs + unpaidCommissions;
                
                if (totalDue > 0) {
                    const option = document.createElement('option');
                    option.value = va.id;
                    option.textContent = `${va.name} (${totalDue.toFixed(2)}‚Ç¨ √† payer)`;
                    vaSelect.appendChild(option);
                }
            });
            
            // Set today's date
            dateInput.value = new Date().toISOString().split('T')[0];
            
            // Reset amount field
            const amountInput = document.getElementById('payment-amount');
            amountInput.readOnly = false;
            amountInput.value = '';
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
        }
        
        function fillTotalAmount() {
            const vaId = document.getElementById('payment-va').value;
            
            if (!vaId) {
                alert('Veuillez d\'abord s√©lectionner une VA');
                return;
            }
            
            const unpaidSubs = calculateUnpaidSubsForVA(vaId);
            const unpaidCommissions = calculateUnpaidCommissionsForVA(vaId);
            const totalDue = unpaidSubs + unpaidCommissions;
            
            // Mettre le type sur "custom" pour que le champ reste √©ditable
            document.getElementById('payment-type').value = 'custom';
            
            // Remplir le montant
            document.getElementById('payment-amount').value = totalDue.toFixed(2);
            
            // Appeler updatePaymentAmount pour mettre √† jour l'affichage
            updatePaymentAmount();
        }
        
        function updatePaymentAmount() {
            const vaId = document.getElementById('payment-va').value;
            const type = document.getElementById('payment-type').value;
            const amountInput = document.getElementById('payment-amount');
            const amountInfo = document.getElementById('payment-amount-info');
            
            if (!vaId) {
                amountInput.value = '';
                amountInput.readOnly = false;
                amountInfo.innerHTML = '';
                return;
            }
            
            // Calculate unpaid amounts for this VA
            const unpaidSubs = calculateUnpaidSubsForVA(vaId);
            const unpaidCommissions = calculateUnpaidCommissionsForVA(vaId);
            const totalDue = unpaidSubs + unpaidCommissions;
            
            // Always show what's due
            let infoHtml = `
                <div style="background: #fef3c7; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <strong>Reste √† payer pour cette VA:</strong><br>
                    ‚Ä¢ Subs: <span style="color: #dc2626;">${unpaidSubs.toFixed(2)}‚Ç¨</span><br>
                    ‚Ä¢ Commissions: <span style="color: #dc2626;">${unpaidCommissions.toFixed(2)}‚Ç¨</span><br>
                    <strong>Total: <span style="color: #dc2626;">${totalDue.toFixed(2)}‚Ç¨</span></strong>
                </div>
            `;
            
            if (!type) {
                amountInput.value = '';
                amountInput.readOnly = false;
                amountInfo.innerHTML = infoHtml;
                return;
            }
            
            switch(type) {
                case 'subs':
                    amountInput.value = unpaidSubs.toFixed(2);
                    amountInput.readOnly = true;
                    amountInfo.innerHTML = infoHtml + `<div style="color: #059669;">Paiement des subs uniquement</div>`;
                    break;
                case 'commissions':
                    amountInput.value = unpaidCommissions.toFixed(2);
                    amountInput.readOnly = true;
                    amountInfo.innerHTML = infoHtml + `<div style="color: #059669;">Paiement des commissions uniquement</div>`;
                    break;
                case 'both':
                    amountInput.value = totalDue.toFixed(2);
                    amountInput.readOnly = true;
                    amountInfo.innerHTML = infoHtml + `<div style="color: #059669;">Paiement total (subs + commissions)</div>`;
                    break;
                case 'custom':
                    amountInput.readOnly = false;
                    amountInfo.innerHTML = infoHtml + `<div style="color: #0891b2;">Entrez le montant que vous souhaitez payer</div>`;
                    break;
            }
        }
        
        function calculateUnpaidSubsForVA(vaId) {
            const allSubs = (data.subs || [])
                .filter(sub => sub.vaId === vaId)
                .reduce((sum, sub) => sum + sub.amount, 0);
                
            const paidSubs = (data.vaPayments || [])
                .filter(p => p.vaId === vaId && (p.type === 'subs' || p.type === 'both'))
                .reduce((sum, p) => sum + (p.subsAmount || 0), 0);
                
            return Math.max(0, allSubs - paidSubs);
        }
        
        function calculateUnpaidCommissionsForVA(vaId) {
            const allCommissions = (data.revenues || [])
                .filter(rev => rev.vaId === vaId)
                .reduce((sum, rev) => sum + rev.commission, 0);
                
            const paidCommissions = (data.vaPayments || [])
                .filter(p => p.vaId === vaId && (p.type === 'commissions' || p.type === 'both'))
                .reduce((sum, p) => sum + (p.commissionsAmount || 0), 0);
                
            return Math.max(0, allCommissions - paidCommissions);
        }
        
        function handlePaymentSubmit(event) {
            event.preventDefault();
            
            const vaId = document.getElementById('payment-va').value;
            const type = document.getElementById('payment-type').value;
            const period = document.getElementById('payment-period').value;
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const date = document.getElementById('payment-date').value;
            const note = document.getElementById('payment-note').value;
            
            // Initialize vaPayments if not exists
            if (!data.vaPayments) {
                data.vaPayments = [];
            }
            
            // Calculate component amounts based on type
            let subsAmount = 0;
            let commissionsAmount = 0;
            
            if (type === 'subs') {
                subsAmount = amount;
            } else if (type === 'commissions') {
                commissionsAmount = amount;
            } else if (type === 'both') {
                // Split proportionally based on unpaid amounts
                const unpaidSubs = calculateUnpaidSubsForVA(vaId);
                const unpaidCommissions = calculateUnpaidCommissionsForVA(vaId);
                const totalUnpaid = unpaidSubs + unpaidCommissions;
                if (totalUnpaid > 0) {
                    subsAmount = amount * (unpaidSubs / totalUnpaid);
                    commissionsAmount = amount * (unpaidCommissions / totalUnpaid);
                }
            } else if (type === 'custom') {
                // For custom, we'll apply to oldest unpaid first
                const unpaidSubs = calculateUnpaidSubsForVA(vaId);
                const unpaidCommissions = calculateUnpaidCommissionsForVA(vaId);
                
                if (amount <= unpaidSubs) {
                    subsAmount = amount;
                } else {
                    subsAmount = unpaidSubs;
                    commissionsAmount = Math.min(amount - unpaidSubs, unpaidCommissions);
                }
            }
            
            const payment = {
                id: generateId(),
                vaId: vaId,
                type: type,
                amount: amount,
                subsAmount: subsAmount,
                commissionsAmount: commissionsAmount,
                period: period,
                date: date,
                note: note,
                createdAt: new Date().toISOString()
            };
            
            data.vaPayments.push(payment);
            saveData();
            
            alert('Paiement enregistr√© avec succ√®s!');
            closePaymentModal();
            
            // Update all relevant displays
            if (document.getElementById('subs-page').style.display === 'block') {
                updateSubsTable();
                updateSubsStats();
            }
            if (document.getElementById('revenue-page').style.display === 'block') {
                updateRevenueDisplay();
            }
            if (document.getElementById('financial-overview-page').style.display === 'block') {
                updateFinancialOverview();
            }
        }
    </script>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>üí∏ Enregistrer un Paiement</h2>
            <form id="payment-form" onsubmit="handlePaymentSubmit(event)">
                <div class="form-group">
                    <label for="payment-va">Cr√©atrice VA *</label>
                    <select id="payment-va" class="form-control" required onchange="updatePaymentAmount()">
                        <option value="">S√©lectionnez une VA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-type">Type de paiement *</label>
                    <select id="payment-type" class="form-control" required onchange="updatePaymentAmount()">
                        <option value="">S√©lectionnez le type</option>
                        <option value="subs">Paiement Subs uniquement</option>
                        <option value="commissions">Paiement Commissions uniquement</option>
                        <option value="both">Paiement Subs + Commissions</option>
                        <option value="custom">Montant personnalis√©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-period">P√©riode concern√©e *</label>
                    <input type="text" id="payment-period" class="form-control" placeholder="ex: Semaine du 01/01 au 07/01" required>
                </div>
                <div class="form-group">
                    <label for="payment-amount">Montant (‚Ç¨) *</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" id="payment-amount" class="form-control" step="0.01" required style="flex: 1;">
                        <button type="button" onclick="fillTotalAmount()" class="btn-icon" style="padding: 0.5rem 0.75rem; font-size: 0.75rem; background: #667eea; color: white; border-radius: 0.375rem;">
                            <i class="fas fa-calculator"></i> Total
                        </button>
                    </div>
                    <small id="payment-amount-info" style="color: #64748b; display: block; margin-top: 0.5rem;"></small>
                </div>
                <div class="form-group">
                    <label for="payment-date">Date du paiement *</label>
                    <input type="date" id="payment-date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="payment-note">Note (optionnel)</label>
                    <textarea id="payment-note" class="form-control" rows="2" placeholder="Ex: Virement bancaire, PayPal..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closePaymentModal()">Annuler</button>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-check"></i> Enregistrer le Paiement
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Backup Modal -->
    <div id="backup-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2>üõ°Ô∏è Centre de S√©curit√© des Donn√©es</h2>
            
            <div style="display: grid; gap: 1.5rem;">
                <!-- Status Section -->
                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.05)); 
                            padding: 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <i class="fas fa-shield-alt" style="font-size: 2rem; color: #22c55e;"></i>
                        <div>
                            <h3 style="color: #22c55e; margin: 0;">Protection Active</h3>
                            <p style="margin: 0.25rem 0; font-size: 0.875rem; color: #64748b;">
                                Sauvegarde automatique toutes les 5 minutes ‚Ä¢ 10 sauvegardes conserv√©es
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <!-- Export -->
                    <div style="background: rgba(34, 197, 94, 0.05); padding: 1.5rem; border-radius: 0.75rem; 
                                border: 1px solid rgba(34, 197, 94, 0.2);">
                        <h3 style="color: #22c55e; margin-bottom: 1rem; font-size: 1.1rem;">
                            <i class="fas fa-download"></i> Exporter
                        </h3>
                        <button onclick="exportAllData()" class="submit-btn" style="background: #22c55e; width: 100%;">
                            T√©l√©charger maintenant
                        </button>
                        <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                            Sauvegarde compl√®te au format JSON
                        </small>
                    </div>
                    
                    <!-- Import -->
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 1.5rem; border-radius: 0.75rem; 
                                border: 1px solid rgba(59, 130, 246, 0.2);">
                        <h3 style="color: #3b82f6; margin-bottom: 1rem; font-size: 1.1rem;">
                            <i class="fas fa-upload"></i> Importer
                        </h3>
                        <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImport(event)">
                        <button onclick="document.getElementById('import-file').click()" 
                                class="submit-btn" style="background: #3b82f6; width: 100%;">
                            Charger un fichier
                        </button>
                        <small style="display: block; margin-top: 0.5rem; color: #ef4444;">
                            ‚ö†Ô∏è Remplace toutes les donn√©es
                        </small>
                    </div>
                </div>
                
                <!-- Backup History -->
                <div style="background: rgba(99, 102, 241, 0.05); padding: 1.5rem; border-radius: 0.75rem; 
                            border: 1px solid rgba(99, 102, 241, 0.2);">
                    <h3 style="color: #6366f1; margin-bottom: 1rem;">
                        <i class="fas fa-history"></i> Historique des Sauvegardes
                    </h3>
                    <div id="backup-history" style="max-height: 300px; overflow-y: auto;">
                        <!-- L'historique sera affich√© ici -->
                    </div>
                </div>
                
                <!-- Stats -->
                <div style="background: rgba(147, 51, 234, 0.05); padding: 1.5rem; border-radius: 0.75rem; 
                            border: 1px solid rgba(147, 51, 234, 0.2);">
                    <h3 style="color: #9333ea; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-chart-bar"></i> Statistiques
                    </h3>
                    <div id="backup-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <!-- Stats will be inserted here -->
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="closeBackupModal()">Fermer</button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars" id="mobile-menu-icon"></i>
    </button>
    
    <!-- Mobile Nav Overlay -->
    <div class="mobile-nav-overlay" id="mobile-nav-overlay" onclick="closeMobileMenu()"></div>
    
    <script>
        // Mobile navigation
        function toggleMobileMenu() {
            const nav = document.querySelector('.nav');
            const overlay = document.getElementById('mobile-nav-overlay');
            const icon = document.getElementById('mobile-menu-icon');
            const button = document.getElementById('mobile-menu-toggle');
            
            if (nav.classList.contains('mobile-active')) {
                closeMobileMenu();
            } else {
                nav.classList.add('mobile-active');
                overlay.classList.add('active');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
                button.style.background = '#ef4444';
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeMobileMenu() {
            const nav = document.querySelector('.nav');
            const overlay = document.getElementById('mobile-nav-overlay');
            const icon = document.getElementById('mobile-menu-icon');
            const button = document.getElementById('mobile-menu-toggle');
            
            nav.classList.remove('mobile-active');
            overlay.classList.remove('active');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
            button.style.background = '#667eea';
            document.body.style.overflow = '';
        }
        
        // Fermer le menu mobile lors de la navigation
        document.addEventListener('DOMContentLoaded', function() {
            // D√©tecter si on est sur mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                document.body.classList.add('is-mobile');
            }
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        closeMobileMenu();
                    }
                });
            });
            
            // G√©rer le redimensionnement avec debounce
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    if (window.innerWidth > 768) {
                        closeMobileMenu();
                        document.querySelector('.nav').style.display = '';
                    }
                }, 250);
            });
            
            // Am√©liorer le scroll sur mobile
            if (isMobile) {
                document.addEventListener('touchmove', function(e) {
                    if (document.body.style.overflow === 'hidden' && !e.target.closest('.nav')) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            
            // Pull to refresh sur mobile
            let startY = 0;
            let isPulling = false;
            
            document.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    startY = e.touches[0].pageY;
                }
            });
            
            document.addEventListener('touchmove', function(e) {
                if (window.scrollY === 0 && !isPulling) {
                    const currentY = e.touches[0].pageY;
                    const pullDistance = currentY - startY;
                    
                    if (pullDistance > 100) {
                        isPulling = true;
                        window.location.reload();
                    }
                }
            });
            
            document.addEventListener('touchend', function() {
                startY = 0;
                isPulling = false;
            });
        });
    </script>
</body>
</html>