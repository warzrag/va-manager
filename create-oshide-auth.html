<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrÃ©er/VÃ©rifier compte Oshide</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #0a0b0d;
            color: #00ff00;
        }
        .container {
            background: #1a1d23;
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #00ff00;
        }
        h1 {
            color: #00ff00;
            text-align: center;
            margin-bottom: 30px;
        }
        .btn {
            background: #00ff00;
            color: #0a0b0d;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
        }
        .btn:hover {
            background: #00cc00;
        }
        .log {
            background: #0a0b0d;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #00ff00;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” CrÃ©er/VÃ©rifier compte Auth pour Oshide</h1>

        <button class="btn" onclick="checkAndCreateOshide()">ğŸš€ VÃ©rifier et crÃ©er Oshide</button>

        <div class="log" id="log"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vjsovnhmjgehqawjmqxn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqc292bmhtamdlaHFhd2ptcXhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjQ4OTgsImV4cCI6MjA3NjAwMDg5OH0.uLqNP1Xb6uhrVBH_ESW7eemMdJ08cTrYZ9C0QHvAsDk';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${type}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function checkAndCreateOshide() {
            log('ğŸš€ DÃ©but de la vÃ©rification/crÃ©ation du compte Oshide...', 'info');
            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            log('', 'info');

            try {
                // Ã‰tape 1: VÃ©rifier si le VA Oshide existe
                log('ğŸ“¦ Recherche du VA "Oshide" dans la base...', 'info');

                const { data: vas, error: vasError } = await supabase
                    .from('vas')
                    .select('id, name, user_id, organization_id')
                    .ilike('name', 'oshide');

                if (vasError) {
                    log(`âŒ Erreur lors de la recherche: ${vasError.message}`, 'error');
                    return;
                }

                log(`RÃ©sultat: ${vas ? vas.length : 0} VA(s) trouvÃ©(s)`, 'info');

                if (!vas || vas.length === 0) {
                    log('âš ï¸  VA "Oshide" non trouvÃ© dans la base', 'warning');
                    log('ğŸ’¡ Il faut d\'abord crÃ©er le VA via le dashboard', 'warning');
                    return;
                }

                const oshide = vas[0];
                log(`âœ… VA trouvÃ©: ${oshide.name}`, 'success');
                log(`   ID: ${oshide.id}`, 'info');
                log(`   Organization: ${oshide.organization_id}`, 'info');
                log(`   User ID actuel: ${oshide.user_id || 'NULL'}`, oshide.user_id ? 'success' : 'warning');

                // Ã‰tape 2: Si dÃ©jÃ  un user_id, essayer de se connecter pour voir l'email
                if (oshide.user_id) {
                    log('', 'info');
                    log('ğŸ” Le VA a dÃ©jÃ  un user_id, recherche des infos...', 'info');
                    log('ğŸ’¡ Emails possibles:', 'info');
                    log('   - oshide@test.com', 'info');
                    log('   - oshide@agenceflo.com', 'info');
                    log('', 'info');
                    log('âš ï¸  Pour voir l\'email exact, il faudrait utiliser le Service Role Key', 'warning');
                    return;
                }

                // Ã‰tape 3: CrÃ©er le compte Auth
                log('', 'info');
                log('ğŸ‘¤ CrÃ©ation du compte Supabase Auth...', 'info');

                const email = 'oshide@test.com';
                const password = 'oshide123';

                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            name: 'Oshide',
                            role: 'va'
                        }
                    }
                });

                let userId = null;

                if (authError) {
                    if (authError.message.includes('already registered')) {
                        log(`âš ï¸  Le compte ${email} existe dÃ©jÃ `, 'warning');
                        log(`ğŸ’¡ Tentative de connexion avec le mot de passe ${password}...`, 'info');

                        const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: password
                        });

                        if (signInError) {
                            log(`âŒ Impossible de se connecter: ${signInError.message}`, 'error');
                            log(`ğŸ’¡ Le mot de passe pourrait Ãªtre diffÃ©rent`, 'warning');
                            return;
                        }

                        userId = signInData.user.id;
                        log(`âœ… Connexion rÃ©ussie! User ID: ${userId}`, 'success');
                    } else {
                        log(`âŒ Erreur auth: ${authError.message}`, 'error');
                        return;
                    }
                } else {
                    userId = authData.user.id;
                    log(`âœ… Compte Auth crÃ©Ã© avec succÃ¨s!`, 'success');
                    log(`   User ID: ${userId}`, 'info');
                }

                // Ã‰tape 4: Lier le compte Auth au VA
                log('', 'info');
                log(`ğŸ”— Liaison du compte Auth au VA Oshide...`, 'info');

                const { error: updateError } = await supabase
                    .from('vas')
                    .update({ user_id: userId })
                    .eq('id', oshide.id);

                if (updateError) {
                    log(`âŒ Erreur mise Ã  jour: ${updateError.message}`, 'error');
                    return;
                }

                log(`âœ… VA mis Ã  jour avec le user_id!`, 'success');

                // VÃ©rification finale
                const { data: updatedVA } = await supabase
                    .from('vas')
                    .select('id, name, user_id')
                    .eq('id', oshide.id)
                    .single();

                if (updatedVA && updatedVA.user_id === userId) {
                    log('', 'info');
                    log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
                    log('âœ… SUCCÃˆS TOTAL!', 'success');
                    log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
                    log('', 'info');
                    log(`ğŸ“§ Email: ${email}`, 'success');
                    log(`ğŸ”‘ Mot de passe: ${password}`, 'success');
                    log(`ğŸ†” User ID: ${userId}`, 'success');
                    log(`ğŸ“‹ VA ID: ${oshide.id}`, 'success');
                } else {
                    log(`âŒ VÃ©rification Ã©chouÃ©e`, 'error');
                }

            } catch (error) {
                log(`âŒ ERREUR: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
