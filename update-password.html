<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mise √† jour des mots de passe Gmail</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #f0f0f0;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #ea4335;
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            background: #2a2a2a;
            color: #f0f0f0;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #ea4335;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #c5271b;
        }
        .success {
            background: #10b981;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #ef4444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            background: #3b82f6;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        #accountsList {
            margin: 20px 0;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
            border: 1px solid #333;
        }
        .account-item {
            padding: 10px;
            margin: 5px 0;
            background: #333;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>üîê Mise √† jour des mots de passe Gmail</h1>

    <div class="info">
        ‚ö†Ô∏è Les mots de passe actuels ont √©t√© chiffr√©s c√¥t√© serveur et ne peuvent pas √™tre d√©crypt√©s localement.
        Utilisez cet outil pour mettre √† jour les mots de passe avec le bon syst√®me de chiffrement.
    </div>

    <div id="message"></div>

    <div class="form-group">
        <label>1. S√©lectionnez un compte Gmail:</label>
        <select id="accountSelect">
            <option value="">-- Chargement des comptes --</option>
        </select>
    </div>

    <div class="form-group">
        <label>2. Entrez le nouveau mot de passe (en clair):</label>
        <input type="text" id="newPassword" placeholder="Entrez le mot de passe r√©el">
    </div>

    <div class="form-group">
        <button onclick="updatePassword()">Mettre √† jour le mot de passe</button>
        <button onclick="loadAccounts()">Recharger les comptes</button>
    </div>

    <div id="accountsList"></div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://umkqpurmbozhuyldjwfz.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVta3FwdXJtYm96aHV5bGRqd2Z6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI0MTU5MTQsImV4cCI6MjA0Nzk5MTkxNH0.VyTD_EJ3gicCerK7BxjHTExdP6fZCVVPdXrSnDYkLkc';
        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        let currentUser = null;
        let organizationId = null;

        // Initialize
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                document.getElementById('message').innerHTML = '<div class="error">Vous devez vous connecter d\'abord dans l\'application principale!</div>';
                return;
            }

            currentUser = session.user;

            // Get organization
            const { data: org } = await supabase
                .from('organizations')
                .select('*')
                .eq('owner_id', currentUser.id)
                .single();

            if (org) {
                organizationId = org.id;
                loadAccounts();
            } else {
                document.getElementById('message').innerHTML = '<div class="error">Organisation non trouv√©e!</div>';
            }
        }

        // Load Gmail accounts
        async function loadAccounts() {
            if (!organizationId) return;

            const { data: accounts, error } = await supabase
                .from('gmail_accounts')
                .select('*')
                .eq('organization_id', organizationId)
                .order('email');

            if (error) {
                console.error('Error loading accounts:', error);
                return;
            }

            const select = document.getElementById('accountSelect');
            select.innerHTML = '<option value="">-- S√©lectionnez un compte --</option>';

            const list = document.getElementById('accountsList');
            list.innerHTML = '<h3>Comptes Gmail existants:</h3>';

            accounts.forEach(account => {
                // Add to select
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = account.email;
                select.appendChild(option);

                // Add to list
                const item = document.createElement('div');
                item.className = 'account-item';
                item.innerHTML = `
                    <span>${account.email}</span>
                    <span style="font-size: 12px; color: #888;">
                        Password: ${account.encrypted_password ?
                            `Chiffr√© (${account.encrypted_password.length} chars)` :
                            'Non d√©fini'}
                    </span>
                `;
                list.appendChild(item);
            });

            document.getElementById('message').innerHTML = `<div class="success">‚úÖ ${accounts.length} comptes charg√©s</div>`;
        }

        // Update password
        async function updatePassword() {
            const accountId = document.getElementById('accountSelect').value;
            const newPassword = document.getElementById('newPassword').value;

            if (!accountId) {
                alert('S√©lectionnez un compte!');
                return;
            }

            if (!newPassword) {
                alert('Entrez un mot de passe!');
                return;
            }

            // Encrypt the password locally with the same key as the app
            const encryptedPassword = obfuscatePassword(newPassword);

            // Update in database
            const { error } = await supabase
                .from('gmail_accounts')
                .update({
                    encrypted_password: encryptedPassword,
                    updated_at: new Date().toISOString()
                })
                .eq('id', accountId);

            if (error) {
                console.error('Error updating password:', error);
                document.getElementById('message').innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            } else {
                document.getElementById('message').innerHTML = '<div class="success">‚úÖ Mot de passe mis √† jour avec succ√®s!</div>';
                document.getElementById('newPassword').value = '';
                loadAccounts();
            }
        }

        // Simple obfuscation (same as in the main app)
        function obfuscatePassword(password) {
            return btoa(password).split('').reverse().join('');
        }

        // Start
        init();
    </script>
</body>
</html>